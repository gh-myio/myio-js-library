<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC-0098: Consumption Chart Components - Clean Demo</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- MyIO JS Library -->
    <script src="../dist/myio-js-library.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 40px 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 { font-size: 1.5rem; color: #1f2937; margin-bottom: 8px; }
        .header p { color: #6b7280; font-size: 14px; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 { font-size: 1.1rem; margin-bottom: 8px; color: #374151; }
        .section p { font-size: 13px; color: #6b7280; margin-bottom: 16px; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
        }
        .chart-container {
            /* Widget will be injected here */
        }
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-energy { background: #6c2fbf; color: white; }
        .btn-energy:hover { background: #5a2699; }
        .btn-water { background: #0288d1; color: white; }
        .btn-water:hover { background: #0277bd; }
        .btn-gas { background: #ea580c; color: white; }
        .btn-gas:hover { background: #c2410c; }
        .btn-temp { background: #e65100; color: white; }
        .btn-temp:hover { background: #bf360c; }
        .log {
            background: #1f2937;
            color: #86efac;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
        }
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
        @media (max-width: 600px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RFC-0098: Consumption Chart Components</h1>
        <p>createConsumptionChartWidget (inline) e createConsumptionModal (modal)</p>
    </div>

    <div class="container">
        <!-- Widget Demo Section -->
        <div class="section">
            <h2>createConsumptionChartWidget</h2>
            <p>Componente inline que injeta todo o HTML no container (sem modal)</p>

            <div class="charts-grid">
                <!-- Energy Widget Container -->
                <div id="energy-widget" class="chart-container"></div>

                <!-- Water Widget Container -->
                <div id="water-widget" class="chart-container"></div>
            </div>
        </div>

        <!-- Modal Demo Section -->
        <div class="section">
            <h2>createConsumptionModal</h2>
            <p>Abre o gr√°fico em um modal fullscreen</p>

            <div class="buttons">
                <button class="btn btn-energy" onclick="openModal('energy')">‚ö° Energia (Modal)</button>
                <button class="btn btn-water" onclick="openModal('water')">üíß √Ågua (Modal)</button>
                <button class="btn btn-gas" onclick="openModal('gas')">üî• G√°s (Modal)</button>
                <button class="btn btn-temp" onclick="openModal('temperature')">üå°Ô∏è Temperatura (Modal)</button>
            </div>
        </div>

        <!-- Code Example -->
        <div class="section">
            <h2>Exemplo de Uso</h2>
            <pre>// Widget inline (injeta HTML no container)
const widget = MyIOLibrary.createConsumptionChartWidget({
  domain: 'energy',
  containerId: 'energy-widget',
  title: 'Consumo de Energia',
  unit: 'kWh',
  chartHeight: 280,
  fetchData: async (period) => fetchEnergyData(period),
  onSettingsClick: () => openSettingsModal(),
  onMaximizeClick: () => openFullscreen(),
});
await widget.render();

// Modal fullscreen
const modal = MyIOLibrary.createConsumptionModal({
  domain: 'energy',
  unit: 'kWh',
  fetchData: async (period) => fetchEnergyData(period),
});
await modal.open();</pre>
        </div>

        <!-- Log -->
        <div class="section">
            <h2>Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // ============================================
        // LOGGING
        // ============================================
        function log(message) {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // ============================================
        // MOCK DATA
        // ============================================
        function generateMockData(domain, period) {
            const labels = [];
            const dailyTotals = [];
            const shoppingData = {};
            const shoppingNames = {};
            const now = new Date();

            const isTemperature = domain === 'temperature';
            const shops = [
                { id: 'shop1', name: 'Shopping Morumbi' },
                { id: 'shop2', name: 'Shopping Eldorado' },
                { id: 'shop3', name: 'Shopping Iguatemi' }
            ];

            const base = { energy: 800, water: 150, gas: 50, temperature: 22 }[domain] || 100;
            const variance = { energy: 400, water: 80, gas: 30, temperature: 3 }[domain] || 50;

            shops.forEach(s => {
                shoppingData[s.id] = [];
                shoppingNames[s.id] = s.name;
            });

            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                labels.push(`${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`);

                let dayTotal = 0;
                shops.forEach((shop, idx) => {
                    const val = isTemperature
                        ? base + (Math.random() - 0.5) * variance
                        : base * (0.8 + idx * 0.2) * (0.5 + Math.random()) / 3;
                    shoppingData[shop.id].push(Math.round(val * 10) / 10);
                    dayTotal += val;
                });

                dailyTotals.push(isTemperature
                    ? Math.round((dayTotal / shops.length) * 10) / 10
                    : Math.round(dayTotal * 10) / 10);
            }

            return { labels, dailyTotals, shoppingData, shoppingNames, fetchTimestamp: Date.now() };
        }

        // ============================================
        // WIDGETS
        // ============================================
        const widgets = {};

        async function initWidgets() {
            if (!MyIOLibrary?.createConsumptionChartWidget) {
                log('[ERROR] MyIOLibrary.createConsumptionChartWidget not available!');
                return;
            }

            log('[INIT] Creating inline widgets...');

            // Energy Widget
            widgets.energy = MyIOLibrary.createConsumptionChartWidget({
                domain: 'energy',
                containerId: 'energy-widget',
                title: 'Consumo de Energia - 7 dias',
                unit: 'kWh',
                unitLarge: 'MWh',
                thresholdForLargeUnit: 1000,
                chartHeight: 280,
                defaultChartType: 'line',
                defaultVizMode: 'total',
                fetchData: async (period) => {
                    log(`[ENERGY] Fetching ${period} days...`);
                    await new Promise(r => setTimeout(r, 200));
                    return generateMockData('energy', period);
                },
                onSettingsClick: () => log('[ENERGY] Settings clicked'),
                onMaximizeClick: () => openModal('energy'),
            });
            await widgets.energy.render();
            log('[ENERGY] Widget rendered');

            // Water Widget
            widgets.water = MyIOLibrary.createConsumptionChartWidget({
                domain: 'water',
                containerId: 'water-widget',
                title: 'Consumo de √Ågua - 7 dias',
                unit: 'm¬≥',
                chartHeight: 280,
                defaultChartType: 'line',
                defaultVizMode: 'total',
                fetchData: async (period) => {
                    log(`[WATER] Fetching ${period} days...`);
                    await new Promise(r => setTimeout(r, 200));
                    return generateMockData('water', period);
                },
                onSettingsClick: () => log('[WATER] Settings clicked'),
                onMaximizeClick: () => openModal('water'),
            });
            await widgets.water.render();
            log('[WATER] Widget rendered');

            log('[INIT] All widgets ready!');
        }

        // ============================================
        // MODAL
        // ============================================
        async function openModal(domain) {
            if (!MyIOLibrary?.createConsumptionModal) {
                log('[ERROR] MyIOLibrary.createConsumptionModal not available!');
                return;
            }

            const cfg = {
                energy: { title: 'Consumo de Energia', unit: 'kWh', unitLarge: 'MWh', threshold: 1000 },
                water: { title: 'Consumo de √Ågua', unit: 'm¬≥' },
                gas: { title: 'Consumo de G√°s', unit: 'm¬≥' },
                temperature: { title: 'Temperatura', unit: '¬∞C', idealRange: { min: 20, max: 24, label: 'Faixa Ideal' } }
            }[domain];

            log(`[MODAL] Opening ${domain}...`);

            const modal = MyIOLibrary.createConsumptionModal({
                domain: domain,
                title: cfg.title,
                unit: cfg.unit,
                unitLarge: cfg.unitLarge,
                thresholdForLargeUnit: cfg.threshold,
                idealRange: cfg.idealRange,
                fetchData: async (period) => {
                    log(`[MODAL] Fetching ${domain} ${period} days...`);
                    await new Promise(r => setTimeout(r, 300));
                    return generateMockData(domain, period);
                },
                onClose: () => log(`[MODAL] ${domain} closed`),
            });

            await modal.open();
            log(`[MODAL] ${domain} opened`);
        }

        // ============================================
        // INIT
        // ============================================
        log('[DEMO] Initializing...');

        if (typeof MyIOLibrary !== 'undefined') {
            log('[DEMO] MyIOLibrary loaded');
            initWidgets();
        } else {
            log('[ERROR] MyIOLibrary not loaded! Run: npm run build');
        }
    </script>
</body>
</html>
