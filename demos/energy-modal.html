<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Modal Demo - MyIO JS Library</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .demo-header h1 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .demo-header p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .demo-section h3 {
            margin-top: 0;
            color: #374151;
        }
        
        .demo-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .demo-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5856eb;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .code-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-top: 15px;
        }
        
        .warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>üîã Energy Modal Demo</h1>
            <p>Test the openDashboardPopupEnergy component with different configurations</p>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Demo Mode:</strong> This demo uses mock data and simulated API responses. 
            In production, you would provide real ThingsBoard JWT tokens and device IDs.
        </div>

        <div class="demo-section">
            <h3>üìã Configuration</h3>
            <div class="demo-form">
                <div class="form-group">
                    <label for="deviceId">Device ID</label>
                    <input type="text" id="deviceId" value="demo-device-12345" placeholder="Enter device UUID">
                </div>
                
                <div class="form-group">
                    <label for="deviceLabel">Device Label (Optional)</label>
                    <input type="text" id="deviceLabel" value="Energy Meter - Store 001" placeholder="Custom device label">
                </div>
                
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" value="2025-09-01">
                </div>
                
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" value="2025-09-30">
                </div>
                
                <div class="form-group">
                    <label for="granularity">Granularity</label>
                    <select id="granularity">
                        <option value="1d">Daily (1d)</option>
                        <option value="1h">Hourly (1h)</option>
                        <option value="15m">15 Minutes (15m)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="theme">Theme</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h3>üîê Authentication (Demo Mode)</h3>
            <div class="demo-form">
                <div class="form-group">
                    <label for="authMode">Authentication Mode</label>
                    <select id="authMode">
                        <option value="token">Ingestion Token</option>
                        <option value="credentials">Client Credentials</option>
                    </select>
                </div>
                
                <div class="form-group" id="tokenGroup">
                    <label for="ingestionToken">Ingestion Token</label>
                    <input type="text" id="ingestionToken" value="demo-ingestion-token-12345" placeholder="Data API token">
                </div>
                
                <div class="form-group" id="clientIdGroup" style="display: none;">
                    <label for="clientId">Client ID</label>
                    <input type="text" id="clientId" value="demo-client-id" placeholder="OAuth client ID">
                </div>
                
                <div class="form-group" id="clientSecretGroup" style="display: none;">
                    <label for="clientSecret">Client Secret</label>
                    <input type="password" id="clientSecret" value="demo-client-secret" placeholder="OAuth client secret">
                </div>
            </div>
        </div>

        <div class="demo-section">
            <h3>üöÄ Actions</h3>
            <div class="demo-buttons">
                <button class="btn btn-primary" onclick="openEnergyModal()">
                    Open Energy Modal
                </button>
                <button class="btn btn-secondary" onclick="openWithCustomStyles()">
                    Open with Custom Styles
                </button>
                <button class="btn btn-secondary" onclick="openWithErrorHandling()">
                    Test Error Handling
                </button>
                <button class="btn btn-secondary" onclick="showConfiguration()">
                    Show Current Config
                </button>
            </div>
            
            <div id="status"></div>
        </div>

        <div class="demo-section">
            <h3>üìñ Usage Examples</h3>
            
            <h4>Basic Usage (Async):</h4>
            <div class="code-block">
const modal = await openDashboardPopupEnergy({
  deviceId: 'DEVICE_UUID',
  startDate: '2025-09-01',
  endDate: '2025-09-30',
  tbJwtToken: 'YOUR_TB_JWT_TOKEN',
  ingestionToken: 'YOUR_INGESTION_TOKEN'
});

// Close programmatically
modal.close();
            </div>

            <h4>With Client Credentials (Async):</h4>
            <div class="code-block">
const modal = await openDashboardPopupEnergy({
  deviceId: 'DEVICE_UUID',
  startDate: '2025-09-01',
  endDate: '2025-09-30',
  tbJwtToken: 'YOUR_TB_JWT_TOKEN',
  clientId: 'YOUR_CLIENT_ID',
  clientSecret: 'YOUR_CLIENT_SECRET',
  theme: 'dark',
  onOpen: (context) => console.log('Modal opened:', context),
  onClose: () => console.log('Modal closed'),
  onError: (error) => console.error('Modal error:', error)
});
            </div>

            <h4>Widget Integration:</h4>
            <div class="code-block">
// In your ThingsBoard widget
try {
  const modal = await MyIO.openDashboardPopupEnergy({
    deviceId: it.entityId,
    startDate: self.ctx.scope.startDateISO,
    endDate: self.ctx.scope.endDateISO,
    tbJwtToken: localStorage.getItem("jwt_token"),
    ingestionToken: await MyIOAuth.getToken(),
    clientId: CLIENT_ID,
    clientSecret: CLIENT_SECRET
  });
} catch (error) {
  console.error('Energy modal error:', error);
}
            </div>
        </div>
    </div>

    <!-- Include the MyIO JS Library -->
    <script type="module">
        // Mock the MyIO library for demo purposes
        window.MyIOLibrary = {
            openDashboardPopupEnergy: function(options) {
                console.log('openDashboardPopupEnergy called with options:', options);
                
                // Simulate validation
                if (!options.deviceId) {
                    throw new Error('deviceId is required');
                }
                
                if (!options.tbJwtToken) {
                    throw new Error('tbJwtToken is required');
                }
                
                // Simulate modal opening
                const modalElement = document.createElement('div');
                modalElement.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const identifier = 'DEMO-001';
                const label = options.label || 'Demo Energy Device';
                
                modalElement.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 30px;
                        width: 95vw;
                        max-width: 1400px;
                        height: 90vh;
                        max-height: 900px;
                        overflow: hidden;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- Header following DeviceReportModal pattern -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #1f2937; font-size: 20px;">Relat√≥rio de Energia - ${identifier} - ${label}</h2>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #6b7280;
                            ">&times;</button>
                        </div>
                        
                        <!-- Controls Section -->
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; gap: 16px; align-items: end; margin-bottom: 16px;">
                                <div style="margin-bottom: 0;">
                                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #374151;">Per√≠odo</label>
                                    <span style="font-size: 14px; color: #6b7280;">
                                        ${new Date(options.startDate).toLocaleDateString('pt-BR')} - ${new Date(options.endDate).toLocaleDateString('pt-BR')}
                                    </span>
                                </div>
                                <button onclick="alert('CSV export would happen here')" style="
                                    background: #6366f1;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">Exportar CSV</button>
                                <button onclick="this.closest('[style*=fixed]').remove()" style="
                                    background: #f3f4f6;
                                    color: #374151;
                                    border: 1px solid #d1d5db;
                                    padding: 8px 16px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 14px;
                                ">Fechar</button>
                            </div>
                        </div>
                        
                        <!-- Main Chart Container - Full Width -->
                        <div style="
                            flex: 1;
                            background: #f8fafc;
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 16px;
                            min-height: 400px;
                        ">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                                <h3 style="margin: 0 0 8px 0; color: #374151;">Full-Width Energy Chart</h3>
                                <p style="margin: 0; color: #6b7280;">
                                    EnergyChartSDK would render here with device: ${options.deviceId}<br>
                                    Period: ${options.startDate} to ${options.endDate}<br>
                                    Granularity: ${options.granularity || '1d'}<br>
                                    Theme: ${options.theme || 'light'}
                                </p>
                            </div>
                        </div>
                        
                        <!-- KPIs Section -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #6366f1; margin-bottom: 8px;">1,234.56 kWh</div>
                                <div style="font-size: 14px; color: #666;">Total Consumption</div>
                            </div>
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #6366f1; margin-bottom: 8px;">41.15 kWh</div>
                                <div style="font-size: 14px; color: #666;">Average Daily</div>
                            </div>
                            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #6366f1; margin-bottom: 8px;">67.89 kWh</div>
                                <div style="font-size: 14px; color: #666;">Peak Day</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalElement);
                
                // Trigger callbacks
                if (options.onOpen) {
                    setTimeout(() => {
                        options.onOpen({
                            device: {
                                id: options.deviceId,
                                label: options.label || options.deviceId,
                                attributes: { demo: true }
                            },
                            resolved: {
                                ingestionId: 'demo-ingestion-id',
                                centralId: 'demo-central-id',
                                slaveId: '1'
                            }
                        });
                    }, 100);
                }
                
                return {
                    close: () => {
                        modalElement.remove();
                        if (options.onClose) {
                            options.onClose();
                        }
                    }
                };
            }
        };
    </script>

    <script>
        let currentModal = null;
        
        // Handle auth mode switching
        document.getElementById('authMode').addEventListener('change', function() {
            const mode = this.value;
            const tokenGroup = document.getElementById('tokenGroup');
            const clientIdGroup = document.getElementById('clientIdGroup');
            const clientSecretGroup = document.getElementById('clientSecretGroup');
            
            if (mode === 'token') {
                tokenGroup.style.display = 'flex';
                clientIdGroup.style.display = 'none';
                clientSecretGroup.style.display = 'none';
            } else {
                tokenGroup.style.display = 'none';
                clientIdGroup.style.display = 'flex';
                clientSecretGroup.style.display = 'flex';
            }
        });
        
        function getFormData() {
            const authMode = document.getElementById('authMode').value;
            
            const baseConfig = {
                deviceId: document.getElementById('deviceId').value,
                label: document.getElementById('deviceLabel').value || undefined,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                granularity: document.getElementById('granularity').value,
                theme: document.getElementById('theme').value,
                tbJwtToken: 'demo-tb-jwt-token-12345', // Demo token
                onOpen: (context) => {
                    showStatus('Modal opened successfully!', 'success');
                    console.log('Energy modal opened with context:', context);
                },
                onClose: () => {
                    showStatus('Modal closed', 'info');
                    currentModal = null;
                },
                onError: (error) => {
                    showStatus(`Error: ${error.message}`, 'error');
                    console.error('Energy modal error:', error);
                }
            };
            
            if (authMode === 'token') {
                baseConfig.ingestionToken = document.getElementById('ingestionToken').value;
            } else {
                baseConfig.clientId = document.getElementById('clientId').value;
                baseConfig.clientSecret = document.getElementById('clientSecret').value;
            }
            
            return baseConfig;
        }
        
        async function openEnergyModal() {
            try {
                const config = getFormData();
                showStatus('Opening energy modal...', 'info');
                currentModal = await window.MyIOLibrary.openDashboardPopupEnergy(config);
                showStatus('Energy modal opened successfully!', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function openWithCustomStyles() {
            try {
                const config = getFormData();
                config.styles = {
                    primaryColor: '#10b981',
                    backgroundColor: '#f0fdf4',
                    borderColor: '#bbf7d0',
                    modalWidth: '1000px',
                    modalHeight: '700px'
                };
                config.i18n = {
                    title: 'Custom Energy Dashboard',
                    loading: 'Loading energy data...',
                    exportCsv: 'Download CSV',
                    close: 'Close Window'
                };
                
                showStatus('Opening modal with custom styles...', 'info');
                currentModal = await window.MyIOLibrary.openDashboardPopupEnergy(config);
                showStatus('Custom modal opened successfully!', 'success');
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function openWithErrorHandling() {
            try {
                const config = getFormData();
                config.deviceId = ''; // Force validation error
                
                showStatus('Testing error handling...', 'info');
                currentModal = await window.MyIOLibrary.openDashboardPopupEnergy(config);
            } catch (error) {
                showStatus(`Validation Error: ${error.message}`, 'error');
            }
        }
        
        function showConfiguration() {
            const config = getFormData();
            const configJson = JSON.stringify(config, (key, value) => {
                if (key.includes('Token') || key.includes('Secret')) {
                    return '[REDACTED]';
                }
                if (typeof value === 'function') {
                    return '[Function]';
                }
                return value;
            }, 2);
            
            showStatus(`Current Configuration:\n${configJson}`, 'info');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize with current date
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
    </script>
</body>
</html>
