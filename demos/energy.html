<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Modal Demo</title>
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }
        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .demo-button {
            background: #4A148C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .demo-button:hover {
            background: #5c307d;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>Premium Modal Components Demo</h1>
        <p>Click the buttons below to test each modal component:</p>
        
        <h2>🎯 Working Premium Modals</h2>
        <button class="demo-button" onclick="openReportDemo()">
            📊 Device Report Modal (DateRangePicker)
        </button>

        <button class="demo-button" onclick="openAllReportDemo()" style="background: #28a745;">
            📋 All Report Modal (NEW!)
        </button>

        <h2>🚀 Future Implementation (DateRangePicker)</h2>
        <p style="color: #666; margin-bottom: 20px;">
            Preview of the standardized jQuery DateRangePicker that will replace native date inputs across all modals.
        </p>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3>DateRangePicker Demo</h3>
            <label for="demo-picker" style="display: block; margin-bottom: 8px; font-weight: 500;">
                Período de Datas
            </label>
            <input type="text" id="demo-picker" readonly 
                   style="width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white;"
                   placeholder="Clique para selecionar período">
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                Formato: DD/MM/YY HH:mm até DD/MM/YY HH:mm
            </div>
            
            <div style="margin-top: 16px;">
                <button class="demo-button" onclick="loadDateRangePicker()" style="margin-right: 10px;">
                    📅 Load DateRangePicker
                </button>
                <button class="demo-button" onclick="showSelectedRange()" style="background: #28a745;">
                    ✅ Show Selected Range
                </button>
            </div>
            
            <div id="range-output" style="margin-top: 16px; padding: 12px; background: #e9ecef; border-radius: 4px; display: none;">
                <strong>Selected Range:</strong>
                <div id="range-details"></div>
            </div>
        </div>
        
        <h2>🆕 NEW: Premium Date Range Input Component</h2>
        <p style="color: #666; margin-bottom: 20px;">
            <strong>createInputDateRangePickerInsideDIV</strong> - Automatic creation of beautifully styled date range inputs inside any DIV container. 
            This component combines the functionality of createDateRangePicker with premium MyIO styling.
        </p>
        
        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4A148C;">
            <h3>✨ Premium Component Demo</h3>
            <p style="margin-bottom: 16px; color: #555;">
                Click the button below to create a premium date range input with automatic styling injection:
            </p>
            
            <!-- Container where the component will be created -->
            <div id="premium-daterange-container" style="margin: 16px 0;"></div>
            
            <div style="margin-top: 16px;">
                <button class="demo-button" onclick="createPremiumDateRangePicker()" style="background: #28a745;">
                    🎨 Create Premium Date Range Input
                </button>
                <button class="demo-button" onclick="showPremiumPickerValue()" style="background: #17a2b8;">
                    📅 Show Selected Range
                </button>
                <button class="demo-button" onclick="destroyPremiumPicker()" style="background: #dc3545;">
                    🗑️ Destroy Component
                </button>
            </div>
            
            <div id="premium-output" style="margin-top: 16px; padding: 12px; background: #e9ecef; border-radius: 4px; display: none;">
                <strong>Component Output:</strong>
                <div id="premium-details"></div>
            </div>
        </div>

        <h2>🆕 NEW: Demand Modal Component</h2>
        <p style="color: #666; margin-bottom: 20px;">
            <strong>openDemandModal</strong> - RFC 0015 implementation with Chart.js integration, PDF export, and ThingsBoard telemetry data.
        </p>
        
        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4A148C;">
            <h3>⚡ Demand Modal Demo</h3>
            <p style="margin-bottom: 16px; color: #555;">
                Interactive demand/consumption chart with zoom, pan, and **robust PDF export capabilities**:
            </p>
            
            <div style="margin-top: 16px;">
                <button class="demo-button" onclick="openDemandModalDemo()" style="background: #4A148C;">
                    ⚡ Normal Pattern Demo
                </button>
                <button class="demo-button" onclick="openDemandModalCustomDemo()" style="background: #28a745;">
                    🎨 High Demand + Custom Style
                </button>
                <button class="demo-button" onclick="openDemandModalEnglishDemo()" style="background: #17a2b8;">
                    🌍 Variable Pattern (English)
                </button>
            </div>
            
            <div style="margin-top: 12px;">
                <button class="demo-button" onclick="openDemandModalMultiSeriesDemo()" style="background: #FF5722;">
                    📈 Multi-Series Demo
                </button>
                <button class="demo-button" onclick="openDemandModalCorrectionFactorDemo()" style="background: #673AB7;">
                    ✖️ Correction Factor Demo
                </button>
                <button class="demo-button" onclick="openDemandModalYAxisLabelDemo()" style="background: #00BCD4;">
                    🏷️ Y-Axis Label Demo
                </button>
            </div>

            <div style="margin-top: 12px;">
                <button class="demo-button" onclick="openDemandModalLowDemo()" style="background: #6c757d;">
                    📉 Low Demand Scenario
                </button>
                <button class="demo-button" onclick="openDemandModalWithGapsDemo()" style="background: #fd7e14;">
                    🕳️ Data Gaps Demo
                </button>
                <button class="demo-button" onclick="openDemandModalErrorDemo()" style="background: #dc3545;">
                    ❌ Error State Demo
                </button>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: #e9ecef; border-radius: 4px;">
                <strong>Features Demonstrated:</strong>
                <ul style="margin: 8px 0; padding-left: 20px; color: #555;">
                    <li>📊 Interactive Chart.js line chart with smooth curves</li>
                    <li>🔍 Zoom/pan controls (wheel zoom, drag select, Ctrl+pan)</li>
                    <li>📄 **Robust PDF export** with chart image and data table (jsPDF regression fixed!)</li>
                    <li>⚡ Peak demand highlighting (yellow pill)</li>
                    <li>📈 **Multi-series charting** with distinct lines and legend</li>
                    <li>✖️ **Value correction factor** for unit conversion</li>
                    <li>🏷️ **Configurable Y-axis label**</li>
                    <li>🌐 Internationalization (Portuguese/English)</li>
                    <li>📱 Responsive design and fullscreen mode</li>
                    <li>♿ Full accessibility (focus trap, ARIA labels)</li>
                    <li>🎨 Customizable styling tokens</li>
                </ul>
            </div>
        </div>

        <h2>🆕 NEW: ThingsBoard Utility Functions</h2>
        <p style="color: #666; margin-bottom: 20px;">
            <strong>buildListItemsThingsboardByUniqueDatasource</strong> - Extracted utility for processing ThingsBoard widget context data into standardized items list.
        </p>
        
        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4A148C;">
            <h3>🔧 Utility Function Demo</h3>
            <p style="margin-bottom: 16px; color: #555;">
                Test the extracted utility function with mock ThingsBoard data:
            </p>
            
            <div style="margin-top: 16px;">
                <button class="demo-button" onclick="testUtilityFunction()" style="background: #4A148C;">
                    🧪 Test buildListItemsThingsboardByUniqueDatasource
                </button>
                <button class="demo-button" onclick="showUtilityResults()" style="background: #28a745;">
                    📊 Show Results
                </button>
                <button class="demo-button" onclick="clearUtilityResults()" style="background: #dc3545;">
                    🗑️ Clear Results
                </button>
            </div>
            
            <div id="utility-output" style="margin-top: 16px; padding: 12px; background: #e9ecef; border-radius: 4px; display: none;">
                <strong>Utility Function Output:</strong>
                <div id="utility-details"></div>
            </div>
        </div>

        <h2>🔮 Future Modals (Coming Soon)</h2>
        <button class="demo-button" onclick="openEnergyDemo()" style="opacity: 0.6;">
            ⚡ Energy Modal (Coming Soon)
        </button>

        <button class="demo-button" onclick="openSettingsDemo()" style="opacity: 0.6;">
            ⚙️ Settings Modal (Coming Soon)
        </button>
    </div>

    <!-- Load the library (when built) -->
    <script src="../dist/myio-js-library.umd.min.js"></script>
    
    <script>
        // DateRangePicker Demo Implementation using MyIOLibrary
        let demoPickerInstance = null;
        
        function loadDateRangePicker() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            const input = document.getElementById('demo-picker');
            
            if (demoPickerInstance) {
                // Destroy existing instance
                demoPickerInstance.destroy();
                demoPickerInstance = null;
            }
            
            try {
                // Use our internal DateRangePickerJQ component
                demoPickerInstance = MyIOLibrary.createDateRangePicker(input, {
                    timePicker: true,
                    timePicker24Hour: true,
                    timePickerIncrement: 1,
                    autoApply: true,
                    autoUpdateInput: true,
                    linkedCalendars: true,
                    showCustomRangeLabel: true,
                    maxSpan: { days: 31 },
                    opens: 'right',
                    drops: 'down',
                    locale: {
                        format: 'DD/MM/YY HH:mm',
                        separator: ' até ',
                        applyLabel: 'Aplicar',
                        cancelLabel: 'Cancelar',
                        fromLabel: 'De',
                        toLabel: 'Até',
                        customRangeLabel: 'Personalizado',
                        daysOfWeek: ['Do','Se','Te','Qa','Qi','Se','Sa'],
                        monthNames: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                        firstDay: 1
                    },
                    ranges: {
                        'Hoje': 'today',
                        'Últimos 7 dias': 'last7days',
                        'Últimos 30 dias': 'last30days',
                        'Mês Anterior': 'lastmonth'
                    }
                });
                
                // Set default range (current month)
                demoPickerInstance.setRange('thismonth');
                
                // Success feedback
                alert('✅ MyIO DateRangePicker loaded successfully!\\n\\nFeatures:\\n• Time selection (24h format)\\n• Preset ranges in Portuguese\\n• Max 31 days enforcement\\n• Timezone-aware output\\n• Premium MyIO styling (purple buttons)\\n• No external dependencies!');
                
            } catch (error) {
                console.error('DateRangePicker error:', error);
                alert('❌ DateRangePicker not yet implemented in MyIOLibrary.\\n\\nThis is a preview of the future implementation.\\nCurrently showing the interface that will be available.');
                
                // Fallback: show mock data
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                };
                
                input.value = `${formatDate(startOfMonth)} até ${formatDate(endOfDay)}`;
                
                // Mock instance for demo
                demoPickerInstance = {
                    startDate: startOfMonth,
                    endDate: endOfDay,
                    destroy: () => {}
                };
            }
        }
        
        function showSelectedRange() {
            if (!demoPickerInstance) {
                alert('Please load DateRangePicker first!');
                return;
            }
            
            const startDate = demoPickerInstance.startDate;
            const endDate = demoPickerInstance.endDate;
            
            // Format dates for display
            const formatISO = (date) => {
                return date.toISOString();
            };
            
            const formatDisplay = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            };
            
            // Calculate range info
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            // Show output
            const output = document.getElementById('range-output');
            const details = document.getElementById('range-details');
            
            details.innerHTML = `
                <div style="margin: 8px 0;"><strong>Start:</strong> ${formatISO(startDate)}</div>
                <div style="margin: 8px 0;"><strong>End:</strong> ${formatISO(endDate)}</div>
                <div style="margin: 8px 0;"><strong>Display:</strong> ${formatDisplay(startDate)} até ${formatDisplay(endDate)}</div>
                <div style="margin: 8px 0;"><strong>Duration:</strong> ${diffDays} days</div>
                <div style="margin: 8px 0; color: ${diffDays <= 31 ? '#28a745' : '#dc3545'};">
                    <strong>Range Check:</strong> ${diffDays <= 31 ? '✅ Within 31-day limit' : '❌ Exceeds 31-day limit'}
                </div>
                <div style="margin: 8px 0; color: #6c757d;">
                    <strong>Library:</strong> ✅ Using MyIOLibrary (no external dependencies)
                </div>
            `;
            
            output.style.display = 'block';
        }
        
        // Premium Date Range Input Component Demo
        let premiumPickerController = null;
        
        function createPremiumDateRangePicker() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.createInputDateRangePickerInsideDIV) {
                alert('❌ createInputDateRangePickerInsideDIV not available in this build.\\n\\nThis component is part of the latest MyIOLibrary implementation.');
                return;
            }
            
            // Destroy existing instance if any
            if (premiumPickerController) {
                premiumPickerController.destroy();
                premiumPickerController = null;
            }
            
            // Create the premium component
            MyIOLibrary.createInputDateRangePickerInsideDIV({
                containerId: 'premium-daterange-container',
                inputId: 'premium-date-input',
                label: 'Período de Análise Energética',
                placeholder: 'Selecione o período para análise',
                pickerOptions: {
                    presetStart: '2025-09-01',
                    presetEnd: '2025-09-25',
                    maxRangeDays: 31,
                    onApply: (result) => {
                        console.log('Premium picker date range applied:', result);
                        
                        // Show success message in helper
                        if (premiumPickerController) {
                            const days = Math.ceil((new Date(result.endISO).getTime() - new Date(result.startISO).getTime()) / (1000 * 60 * 60 * 24)) + 1;
                            premiumPickerController.setHelperText(`✅ Período de ${days} dias selecionado com sucesso!`, 'success');
                            
                            // Reset helper after 3 seconds
                            setTimeout(() => {
                                if (premiumPickerController) {
                                    //premiumPickerController.setHelperText('Formato: DD/MM/YY HH:mm até DD/MM/YY HH:mm', 'default');
                                }
                            }, 3000);
                        }
                    }
                },
                injectStyles: true,
                showHelper: true
            }).then(controller => {
                premiumPickerController = controller;
                
                // Success feedback
                alert('✅ Premium Date Range Input Created Successfully!\\n\\n🎨 Features Demonstrated:\\n• Automatic HTML structure creation inside DIV\\n• Premium MyIO styling injection (purple theme)\\n• Beautiful wrapper with shadow and padding\\n• Label, input, and helper text components\\n• Accessibility features (ARIA labels)\\n• Responsive design (mobile-friendly)\\n• Error handling and validation\\n• Memory management with destroy() method\\n\\n🔧 Technical Details:\\n• Container ID: premium-daterange-container\\n• Input ID: premium-date-input\\n• Component: createInputDateRangePickerInsideDIV\\n• Styling: Automatic injection enabled\\n• Max Range: 31 days enforced\\n\\nTry selecting a date range and see the helper text update!');
                
            }).catch(error => {
                console.error('Failed to create premium date picker:', error);
                alert(`❌ Failed to create premium component: ${error.message}`);
            });
        }
        
        function showPremiumPickerValue() {
            if (!premiumPickerController) {
                alert('Please create the premium date range picker first!');
                return;
            }
            
            try {
                const dates = premiumPickerController.getDates();
                const displayValue = premiumPickerController.getDisplayValue();
                
                // Calculate range info
                const startDate = new Date(dates.startISO);
                const endDate = new Date(dates.endISO);
                const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Show output
                const output = document.getElementById('premium-output');
                const details = document.getElementById('premium-details');
                
                details.innerHTML = `
                    <div style="margin: 8px 0;"><strong>Display Value:</strong> ${displayValue || 'No date selected'}</div>
                    <div style="margin: 8px 0;"><strong>Start ISO:</strong> ${dates.startISO || 'Not set'}</div>
                    <div style="margin: 8px 0;"><strong>End ISO:</strong> ${dates.endISO || 'Not set'}</div>
                    <div style="margin: 8px 0;"><strong>Duration:</strong> ${dates.startISO ? diffDays + ' days' : 'Not calculated'}</div>
                    <div style="margin: 8px 0; color: ${!dates.startISO ? '#6c757d' : diffDays <= 31 ? '#28a745' : '#dc3545'};">
                        <strong>Validation:</strong> ${!dates.startISO ? '⏳ No date selected' : diffDays <= 31 ? '✅ Within 31-day limit' : '❌ Exceeds 31-day limit'}
                    </div>
                    <div style="margin: 8px 0; color: #4A148C;">
                        <strong>Component:</strong> ✨ createInputDateRangePickerInsideDIV (Premium)
                    </div>
                    <div style="margin: 8px 0; color: #6c757d;">
                        <strong>Styling:</strong> 🎨 Premium MyIO styling automatically injected
                    </div>
                `;
                
                output.style.display = 'block';
                
                // Update helper text to show success
                premiumPickerController.setHelperText('📊 Dados exibidos com sucesso!', 'success');
                setTimeout(() => {
                    if (premiumPickerController) {
                        //premiumPickerController.setHelperText('Formato: DD/MM/YY HH:mm até DD/MM/YY HH:mm', 'default');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error getting premium picker value:', error);
                alert(`❌ Error getting picker value: ${error.message}`);
                
                // Show error in helper
                if (premiumPickerController) {
                    premiumPickerController.setHelperText('❌ Erro ao obter dados do componente', 'error');
                }
            }
        }
        
        function destroyPremiumPicker() {
            if (!premiumPickerController) {
                alert('No premium date range picker to destroy.');
                return;
            }
            
            try {
                premiumPickerController.destroy();
                premiumPickerController = null;
                
                // Hide output
                const output = document.getElementById('premium-output');
                output.style.display = 'none';
                
                alert('✅ Premium Date Range Input Destroyed Successfully!\\n\\n🧹 Cleanup Performed:\\n• Date picker instance destroyed\\n• Wrapper element removed from DOM\\n• Input element removed\\n• Label and helper text removed\\n• Event listeners cleaned up\\n• Memory freed\\n\\nThe container DIV is now empty and ready for a new component.');
                
            } catch (error) {
                console.error('Error destroying premium picker:', error);
                alert(`❌ Error destroying component: ${error.message}`);
            }
        }
        
        // Mock Telemetry Data Generator for Demos
        function createMockTelemetryFetcher(options = {}) {
            return async (params) => {
                console.log('[MOCK] Generating telemetry data for:', params);
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
                
                const {
                    baseConsumption = 50000,     // 50 kWh per day base
                    peakMultiplier = 2.5,
                    pattern = 'normal',
                    dataGaps = false,
                    noiseLevel = 0.1,
                    keys = 'consumption' // Default to 'consumption' for single series
                } = options;

                const startTs = new Date(params.startDate + 'T00:00:00').getTime();
                const endTs = new Date(params.endDate + 'T23:59:59').getTime();
                const intervalMs = 15 * 60 * 1000; // 15-minute intervals
                
                const responseData = {};
                const seriesKeys = keys.split(',').map(k => k.trim());

                seriesKeys.forEach(key => {
                    const data = [];
                    let cumulativeConsumption = 0;

                    // Pattern multipliers
                    const patternMultipliers = { normal: 1.0, high: 1.8, low: 0.6, variable: 1.0 };
                    const baseMultiplier = patternMultipliers[pattern] || 1.0;

                    for (let ts = startTs; ts <= endTs; ts += intervalMs) {
                        const date = new Date(ts);
                        const hour = date.getHours();
                        const dayOfWeek = date.getDay();
                        
                        // Skip some data points to simulate gaps
                        if (dataGaps && Math.random() < 0.05) continue;

                        // Calculate hourly consumption based on realistic patterns
                        let hourlyConsumption = baseConsumption / 24 / 4; // Base 15-min consumption
                        
                        // Business hours pattern (higher consumption 8 AM - 10 PM)
                        if (hour >= 8 && hour <= 22) {
                            hourlyConsumption *= peakMultiplier;
                        } else if (hour >= 6 && hour <= 7) {
                            hourlyConsumption *= 1.5; // Morning ramp-up
                        } else if (hour >= 23 || hour <= 5) {
                            hourlyConsumption *= 0.3; // Night time
                        }

                        // Weekend pattern (slightly lower consumption)
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            hourlyConsumption *= 0.8;
                        }

                        // Variable pattern - changes throughout the period
                        if (pattern === 'variable') {
                            const daysSinceStart = (ts - startTs) / (1000 * 60 * 60 * 24);
                            const variableMultiplier = 0.7 + 0.6 * Math.sin(daysSinceStart * 0.5) + 0.3 * Math.cos(daysSinceStart * 0.3);
                            hourlyConsumption *= variableMultiplier;
                        }

                        // Apply base pattern multiplier
                        hourlyConsumption *= baseMultiplier;

                        // Add random noise
                        const noise = 1 + (Math.random() - 0.5) * 2 * noiseLevel;
                        hourlyConsumption *= noise;

                        // Ensure minimum consumption
                        hourlyConsumption = Math.max(hourlyConsumption, 100);

                        // Add to cumulative consumption
                        cumulativeConsumption += hourlyConsumption;

                        data.push({
                            ts,
                            value: cumulativeConsumption.toFixed(2)
                        });
                    }
                    responseData[key] = data;
                });

                console.log(`[MOCK] Generated data for keys: ${keys}`);
                return responseData;
            };
        }

        // Demand Modal Component Demos
        function openDemandModalDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.\\n\\nThis component is part of the latest MyIOLibrary implementation.');
                return;
            }
            
            try {
                // Create mock fetcher for normal consumption pattern
                const mockFetcher = createMockTelemetryFetcher({
                    pattern: 'normal',
                    baseConsumption: 45000,
                    peakMultiplier: 2.2,
                    noiseLevel: 0.08
                });

                // Basic demo with mock data
                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-12345',
                    deviceId: 'demo-device-uuid-abcd-1234',
                    startDate: '2024-01-01',
                    endDate: '2024-01-31',
                    label: 'Loja Centro - Demo',
                    fetcher: mockFetcher,
                    onClose: () => {
                        console.log('✅ Demand Modal closed successfully');
                    }
                });
                
                console.log('⚡ Demand Modal opened:', modal);
                
                // Show success message
                setTimeout(() => {
                    alert('✅ Demand Modal Demo Opened Successfully!\\n\\n🎯 Features Demonstrated:\\n• Purple header with lightning icon and device label\\n• Period display: 01/01/2024 → 31/01/2024\\n• Interactive Chart.js line chart with smooth curves\\n• Zoom controls (wheel zoom, drag select, Ctrl+pan)\\n• Reset Zoom button to return to full view\\n• **Robust PDF export** with chart image and data table (jsPDF regression fixed!)\\n• Peak demand highlighting (yellow pill)\\n• Fullscreen toggle for better chart viewing\\n• Loading state with animated spinner\\n• Realistic mock data with business hour patterns\\n• Focus trap and ESC key to close\\n• Responsive design for mobile devices\\n\\n🔧 Technical Implementation:\\n• Chart.js 4.4.0 with zoom plugin dynamically loaded\\n• jsPDF for client-side PDF generation\\n• Mock telemetry data with realistic consumption patterns\\n• Accessibility features (ARIA labels, focus management)\\n• CSS variables for easy theming\\n• Memory management with proper cleanup\\n\\n📊 Mock Data Features:\\n• 15-minute interval data points\\n• Business hours peak consumption (8 AM - 10 PM)\\n• Weekend consumption reduction\\n• Random noise for realistic variation\\n• Cumulative consumption calculation\\n\\nTry the zoom controls and PDF export!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening demand modal:', error);
                alert(`❌ Error opening Demand Modal: ${error.message}`);
            }
        }
        
        function openDemandModalCustomDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                // Create mock fetcher for high demand pattern
                const mockFetcher = createMockTelemetryFetcher({
                    pattern: 'high',
                    baseConsumption: 75000,
                    peakMultiplier: 3.0,
                    noiseLevel: 0.12
                });

                // Custom styled demo
                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-custom',
                    deviceId: 'demo-device-custom-5678',
                    startDate: '2024-02-01',
                    endDate: '2024-02-29',
                    label: 'Shopping Center - Customizado',
                    fetcher: mockFetcher,
                    styles: {
                        primaryColor: '#1976D2',      // Blue instead of purple
                        accentColor: '#FF9800',       // Orange instead of yellow
                        borderRadius: '12px',         // More rounded corners
                        fontFamily: 'Georgia, serif', // Different font
                        zIndex: 20000                 // Higher z-index
                    },
                    pdf: {
                        enabled: true,
                        fileName: 'demanda-customizada-fev2024.pdf'
                    },
                    onClose: () => {
                        console.log('🎨 Custom styled Demand Modal closed');
                    }
                });
                
                console.log('🎨 Custom Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('🎨 Custom Styled Demand Modal Demo!\\n\\n🌈 Custom Styling Applied:\\n• Primary Color: Blue (#1976D2) instead of purple\\n• Accent Color: Orange (#FF9800) instead of yellow\\n• Border Radius: 12px for more rounded corners\\n• Font Family: Georgia serif instead of sans-serif\\n• Z-Index: 20000 for higher stacking order\\n• Custom PDF filename: demanda-customizada-fev2024.pdf\\n\\n🔧 Styling Tokens Demonstrated:\\n• primaryColor: Header background and chart line color\\n• accentColor: Peak demand pill background\\n• borderRadius: Modal card and button corner radius\\n• fontFamily: Typography throughout the modal\\n• zIndex: Modal overlay stacking order\\n\\n📊 High Demand Mock Data:\\n• 75 kWh base daily consumption (vs 45 kWh normal)\\n• 3.0x peak multiplier (vs 2.2x normal)\\n• Higher noise level for more variation\\n• Simulates busy shopping center consumption\\n\\nAll other features remain the same:\\n• Interactive chart with zoom/pan\\n• **Robust PDF export** with custom filename\\n• Accessibility and responsive design\\n• Focus management and keyboard navigation\\n\\nThis shows how easy it is to customize the modal appearance!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening custom demand modal:', error);
                alert(`❌ Error opening Custom Demand Modal: ${error.message}`);
            }
        }
        
        function openDemandModalEnglishDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                // Create mock fetcher for variable consumption pattern
                const mockFetcher = createMockTelemetryFetcher({
                    pattern: 'variable',
                    baseConsumption: 55000,
                    peakMultiplier: 2.5,
                    noiseLevel: 0.15
                });

                // English localization demo
                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-english',
                    deviceId: 'demo-device-english-9999',
                    startDate: '2024-03-01',
                    endDate: '2024-03-31',
                    label: 'Main Entrance Meter',
                    locale: 'en-US',
                    fetcher: mockFetcher,
                    pdf: {
                        enabled: true,
                        fileName: 'demand-report-march2024.pdf'
                    },
                    onClose: () => {
                        console.log('🌍 English Demand Modal closed');
                    }
                });
                
                console.log('🌍 English Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('🌍 English Localization Demo!\\n\\n🇺🇸 English Interface Features:\\n• Title: "Demand – Main Entrance Meter"\\n• Period: "Period: 03/01/2024 → 03/31/2024" (US date format)\\n• Peak: "Maximum: X.XX kW at MM/DD/YYYY HH:mm"\\n• Buttons: "Export PDF", "Fullscreen", "Close"\\n• Chart Y-axis: "Demand (kW)"\\n• Zoom help: "Scroll: zoom | Drag: select | Ctrl+Drag: pan"\\n• Loading: "Loading data..."\\n• Error: "Error loading data"\\n• No data: "No demand points in the selected period"\\n\\n🔧 Localization Features:\\n• Date formatting follows US standards (MM/DD/YYYY)\\n• Number formatting with US decimal separators\\n• All UI text translated to English\\n• PDF report generated in English\\n• Chart tooltips and labels in English\\n\\n📊 Variable Pattern Mock Data:\\n• Seasonal consumption variations using sine/cosine waves\\n• 55 kWh base consumption with dynamic changes\\n• Higher noise level (15%) for realistic variation\\n• Demonstrates long-term consumption trends\\n\\n📊 Same Functionality:\\n• Interactive Chart.js visualization\\n• Zoom/pan controls work identically\\n• **Robust PDF export** with English headers\\n• Peak detection and highlighting\\n• Responsive design and accessibility\\n\\nThis demonstrates the i18n capabilities of the component!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening English demand modal:', error);
                alert(`❌ Error opening English Demand Modal: ${error.message}`);
            }
        }
        
        // NEW DEMO: Multi-Series Demo
        function openDemandModalMultiSeriesDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                const mockFetcher = createMockTelemetryFetcher({
                    keys: 'power_a,power_b,power_c', // Multiple keys
                    baseConsumption: 30000,
                    peakMultiplier: 2.0,
                    noiseLevel: 0.05
                });

                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-multi',
                    deviceId: 'demo-device-multi-series',
                    startDate: '2024-07-01',
                    endDate: '2024-07-31',
                    label: 'Medidor Trifásico',
                    telemetryQuery: {
                        keys: 'power_a,power_b,power_c',
                        agg: 'AVG'
                    },
                    yAxisLabel: 'Potência (kW)',
                    fetcher: mockFetcher,
                    onClose: () => {
                        console.log('📈 Multi-Series Demand Modal closed');
                    }
                });
                
                console.log('📈 Multi-Series Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('📈 Multi-Series Demand Modal Demo!\\n\\n📊 Features Demonstrated:\\n• Multiple telemetry keys (power_a, power_b, power_c) displayed as distinct lines\\n• Automatic legend for each series\\n• Global peak highlighting with series identification\\n• Configurable Y-axis label: "Potência (kW)"\\n\\n🔧 Technical Implementation:\\n• `telemetryQuery.keys` parameter used to fetch multiple series\\n• `processMultiSeriesChartData` handles data processing for each series\\n• Chart.js renders multiple datasets with distinct colors\\n\\nThis demonstrates the powerful multi-series analysis capabilities!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening multi-series demand modal:', error);
                alert(`❌ Error opening Multi-Series Demand Modal: ${error.message}`);
            }
        }

        // NEW DEMO: Correction Factor Demo
        function openDemandModalCorrectionFactorDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                const mockFetcher = createMockTelemetryFetcher({
                    baseConsumption: 45000000, // Simulate Watts
                    peakMultiplier: 2.0,
                    noiseLevel: 0.08
                });

                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-correction',
                    deviceId: 'demo-device-correction-factor',
                    startDate: '2024-08-01',
                    endDate: '2024-08-31',
                    label: 'Medidor de Watts',
                    fetcher: mockFetcher,
                    correctionFactor: 0.001, // Convert Watts to kW
                    yAxisLabel: 'Potência (kW)',
                    onClose: () => {
                        console.log('✖️ Correction Factor Demand Modal closed');
                    }
                });
                
                console.log('✖️ Correction Factor Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('✖️ Correction Factor Demand Modal Demo!\\n\\n🔧 Features Demonstrated:\\n• `correctionFactor: 0.001` applied to telemetry values\\n• Converts raw Watts data (e.g., 45000000) to kilowatts (e.g., 45)\\n• Configurable Y-axis label: "Potência (kW)"\\n\\n📊 Use Case:\\n• Unify units across different sensors (e.g., Watts to kW, Wh to kWh)\\n• Scale values for better visualization\\n\\nThis demonstrates how to easily adjust telemetry values for display!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening correction factor demand modal:', error);
                alert(`❌ Error opening Correction Factor Demand Modal: ${error.message}`);
            }
        }

        // NEW DEMO: Y-Axis Label Demo
        function openDemandModalYAxisLabelDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                const mockFetcher = createMockTelemetryFetcher({
                    baseConsumption: 10000, // Simulate Amperes
                    peakMultiplier: 1.5,
                    noiseLevel: 0.05,
                    keys: 'current_a'
                });

                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-yaxis',
                    deviceId: 'demo-device-yaxis-label',
                    startDate: '2024-09-01',
                    endDate: '2024-09-30',
                    label: 'Medidor de Corrente',
                    fetcher: mockFetcher,
                    telemetryQuery: {
                        keys: 'current_a',
                        agg: 'MAX'
                    },
                    yAxisLabel: 'Corrente (A)', // Custom Y-axis label
                    onClose: () => {
                        console.log('🏷️ Y-Axis Label Demand Modal closed');
                    }
                });
                
                console.log('🏷️ Y-Axis Label Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('🏷️ Y-Axis Label Demand Modal Demo!\\n\\n🔧 Features Demonstrated:\\n• `yAxisLabel: "Corrente (A)"` customizes the Y-axis title\\n• Chart Y-axis and PDF report now display "Corrente (A)"\\n\\n📊 Use Case:\\n• Display different types of telemetry data (e.g., current, voltage, temperature)\\n• Provide clear context for the charted values\\n\\nThis demonstrates how to easily customize the Y-axis label for any telemetry type!');
                }, 500);
                
            } catch (error) {
                console.error('Error opening Y-axis label demand modal:', error);
                alert(`❌ Error opening Y-Axis Label Demand Modal: ${error.message}`);
            }
        }
        
        // Additional Demand Modal Demo Scenarios
        function openDemandModalLowDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                // Create mock fetcher for low demand pattern
                const mockFetcher = createMockTelemetryFetcher({
                    pattern: 'low',
                    baseConsumption: 25000,
                    peakMultiplier: 1.8,
                    noiseLevel: 0.06
                });

                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-low',
                    deviceId: 'demo-device-low-demand',
                    startDate: '2024-04-01',
                    endDate: '2024-04-30',
                    label: 'Pequena Loja - Baixo Consumo',
                    fetcher: mockFetcher,
                    onClose: () => {
                        console.log('📉 Low Demand Modal closed');
                    }
                });
                
                console.log('📉 Low Demand Modal opened:', modal);
                
                setTimeout(() => {
                    alert('📉 Low Demand Scenario Demo!\\n\\n🏪 Small Store Simulation:\\n• Base Consumption: 25 kWh/day (vs 45 kWh normal)\\n• Peak Multiplier: 1.8x (vs 2.2x normal)\\n• Lower noise level (6%) for more stable consumption\\n• Simulates small retail store or office space\\n\\n📊 Expected Chart Characteristics:\\n• Lower overall demand values (typically 1-5 kW)\\n• Less dramatic peaks during business hours\\n• More consistent consumption pattern\\n• Smaller yellow peak pill values\\n\\n🎯 Use Cases:\\n• Small retail stores\\n• Office spaces\\n• Residential applications\\n• Low-power equipment monitoring\\n\\nThis demonstrates how the component handles different consumption scales while maintaining the same functionality and user experience.');
                }, 500);
                
            } catch (error) {
                console.error('Error opening low demand modal:', error);
                alert(`❌ Error opening Low Demand Modal: ${error.message}`);
            }
        }
        
        function openDemandModalWithGapsDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                // Create mock fetcher with data gaps
                const mockFetcher = createMockTelemetryFetcher({
                    pattern: 'normal',
                    baseConsumption: 50000,
                    peakMultiplier: 2.3,
                    dataGaps: true,
                    noiseLevel: 0.1
                });

                const modal = MyIOLibrary.openDemandModal({
                    token: 'demo-jwt-token-gaps',
                    deviceId: 'demo-device-with-gaps',
                    startDate: '2024-05-01',
                    endDate: '2024-05-31',
                    label: 'Medidor com Falhas de Comunicação',
                    fetcher: mockFetcher,
                    onClose: () => {
                        console.log('🕳️ Data Gaps Modal closed');
                    }
                });
                
                console.log('🕳️ Data Gaps Modal opened:', modal);
                
                setTimeout(() => {
                    alert('🕳️ Data Gaps Scenario Demo!\\n\\n📡 Communication Issues Simulation:\\n• Random 5% data point loss during generation\\n• Simulates real-world communication failures\\n• Tests component robustness with incomplete data\\n• Demonstrates gap handling in chart visualization\\n\\n📊 Expected Chart Behavior:\\n• Some missing data points in the timeline\\n• Chart.js automatically connects available points\\n• Peak detection works with available data\\n• PDF export includes note about data gaps\\n\\n🔧 Real-World Scenarios:\\n• Network connectivity issues\\n• Device communication failures\\n• Maintenance periods\\n• Power outages affecting data collection\\n\\n🎯 Component Resilience:\\n• Graceful handling of missing data\\n• No crashes or errors with gaps\\n• Maintains functionality with partial data\\n• User-friendly visualization of incomplete datasets\\n\\nThis demonstrates the component\'s robustness in handling real-world data quality issues.');
                }, 500);
                
            } catch (error) {
                console.error('Error opening data gaps modal:', error);
                alert(`❌ Error opening Data Gaps Modal: ${error.message}`);
            }
        }
        
        function openDemandModalErrorDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.openDemandModal) {
                alert('❌ openDemandModal not available in this build.');
                return;
            }
            
            try {
                // Create mock fetcher that simulates an error
                const errorFetcher = async (params) => {
                    console.log('[ERROR DEMO] Simulating API failure for:', params);
                    
                    // Simulate API delay before error
                    await new Promise(resolve => setTimeout(resolve, 1200));
                    
                    // Throw a realistic error
                    throw new Error('HTTP 401: Token expired or invalid');
                };

                const modal = MyIOLibrary.openDemandModal({
                    token: 'invalid-expired-token',
                    deviceId: 'demo-device-error',
                    startDate: '2024-06-01',
                    endDate: '2024-06-30',
                    label: 'Teste de Erro - Token Inválido',
                    fetcher: errorFetcher,
                    onClose: () => {
                        console.log('❌ Error Demo Modal closed');
                    }
                });
                
                console.log('❌ Error Demo Modal opened:', modal);
                
                setTimeout(() => {
                    alert('❌ Error State Demo!\\n\\n🚨 Authentication Failure Simulation:\\n• Mock fetcher throws "HTTP 401: Token expired or invalid"\\n• Tests error handling and user feedback\\n• Demonstrates graceful failure recovery\\n• Shows proper error state UI\\n\\n📊 Expected Behavior:\\n• Loading spinner appears initially\\n• After ~1.2 seconds, error state is shown\\n• Red warning icon with error message\\n• Chart area is hidden, error message displayed\\n• All other modal functions remain available\\n\\n🔧 Error Handling Features:\\n• User-friendly Portuguese error messages\\n• No application crashes or console errors\\n• Modal remains functional (can be closed)\\n• Proper cleanup on modal destruction\\n• Error logging for debugging\\n\\n🎯 Real-World Error Scenarios:\\n• Expired authentication tokens\\n• Network connectivity issues\\n• Invalid device IDs\\n• Server maintenance periods\\n• Rate limiting responses\\n\\nThis demonstrates the component\'s robust error handling and user experience during failure conditions.');
                }, 500);
                
            } catch (error) {
                console.error('Error opening error demo modal:', error);
                alert(`❌ Error opening Error Demo Modal: ${error.message}`);
            }
        }
        
        // Mock data for demos
        function openEnergyDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('Library not loaded. Build the project first.');
                return;
            }
            
            MyIOLibrary.openDashboardPopupEnergy({
                deviceId: 'demo-device-123',
                label: 'ENTRADA SUBESTAÇÃO',
                gatewayId: 'GW-123',
                slaveId: 1,
                ingestionId: 'a1b2c3d4-demo-ingestion-id',
                date: { start: '2025-09-01', end: '2025-09-25' },
                ui: { theme: 'light' },
                api: {
                    clientId: 'demo-client',
                    clientSecret: 'demo-secret',
                    dataApiBaseUrl: 'https://api.data.apps.myio-bas.com',
                    graphsBaseUrl: 'https://graphs.apps.myio-bas.com',
                    timezone: 'America/Sao_Paulo'
                }
            });
        }
        
        function openReportDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('Library not loaded. Build the project first.');
                return;
            }
            
            // Mock energy fetcher for local testing
            const mockEnergyFetcher = async ({ baseUrl, ingestionId, startISO, endISO }) => {
                console.log('[DEMO] Mock fetcher called with:', { baseUrl, ingestionId, startISO, endISO });
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate mock consumption data for the date range
                const startDate = new Date(startISO);
                const endDate = new Date(endISO);
                const consumption = [];
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // Skip some days randomly to test zero-filling
                    if (Math.random() > 0.2) {
                        consumption.push({
                            timestamp: d.toISOString(),
                            value: Math.random() * 50 + 10 // 10-60 kWh
                        });
                    }
                }
                
                return {
                    data: [{
                        id: ingestionId,
                        label: 'Demo Device',
                        consumption: consumption
                    }]
                };
            };
            
            MyIOLibrary.openDashboardPopupReport({
                ingestionId: 'demo-ingestion-123',
                deviceId: 'demo-device-123',
                identifier: 'ENTRADA-001',
                label: 'Outback',
                api: { 
                    clientId: 'demo-client',
                    clientSecret: 'demo-secret',
                    dataApiBaseUrl: 'https://api.data.apps.myio-bas.com',
                    ingestionToken: 'demo-ingestion-token'
                },
                fetcher: mockEnergyFetcher // Inject mock fetcher for local testing
            });
        }
        
        function openAllReportDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('Library not loaded. Build the project first.');
                return;
            }

            // Show info about new Customer Totals All Report implementation
            const proceed = confirm(`🎉 Customer Totals All Report - Production Ready!

✅ REAL Customer Totals API Integration (RFC Implementation)
   • Calls /api/v1/telemetry/customers/{customerId}/energy/devices/totals
   • Uses fetchWithAuth pattern with MyIOAuth token management
   • Handles pagination automatically with fetchAllCustomerTotals
   • Zero-fill logic for missing devices (no data gaps)

✅ Robust Data Processing Pipeline
   • mapCustomerTotalsResponse with fallback chains
   • applySorting with Portuguese locale support
   • Consistent type handling for all field variations

✅ Production-Ready Table Structure
   • Sticky totals row at top (Total Geral)
   • Sortable columns: Identifier, Name, Consumption
   • Visual arrow indicators for sort direction
   • Brazilian number formatting (MyIOLibrary.formatEnergy)

✅ Comprehensive Error Handling
   • Network failures → User-friendly Portuguese messages
   • Invalid customer ID → Clear validation errors
   • Empty responses → Zero-filled data with proper UI state
   • Authentication errors → Automatic token refresh

✅ CSV Export with Consistent Formatting
   • Same MyIOLibrary.formatEnergy used in UI and CSV
   • Proper Brazilian locale (semicolon separator)
   • Includes totals and metadata headers

This demo uses REAL API integration (not mock data)!

Open the Customer Totals All Report Modal?`);

            if (!proceed) return;

            // Mock Customer Totals fetcher for demo (simulates real API)
            const mockCustomerTotalsFetcher = async ({ baseUrl, token, limit = 100 }) => {
                console.log('[DEMO] Mock Customer Totals API called:', { baseUrl, limit });
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Generate realistic customer totals data
                const stores = [
                    { id: 'dev-001', identifier: 'SCP00480', deviceLabel: 'Outback Steakhouse', total_value: 2847.65 },
                    { id: 'dev-002', identifier: 'SCP00481', deviceLabel: 'McDonald\'s', total_value: 1923.42 },
                    { id: 'dev-003', identifier: 'SCP00482', deviceLabel: 'Subway', total_value: 1456.78 },
                    { id: 'dev-004', identifier: 'SCP00483', deviceLabel: 'Starbucks Coffee', total_value: 987.34 },
                    { id: 'dev-005', identifier: 'SCP00484', deviceLabel: 'Burger King', total_value: 2156.89 },
                    { id: 'dev-006', identifier: 'SCP00485', deviceLabel: 'Pizza Hut', total_value: 1789.23 },
                    { id: 'dev-007', identifier: 'SCP00486', deviceLabel: 'KFC', total_value: 1634.56 },
                    { id: 'dev-008', identifier: 'SCP00487', deviceLabel: 'Domino\'s Pizza', total_value: 1345.67 },
                    { id: 'dev-009', identifier: 'SCP00488', deviceLabel: 'Taco Bell', total_value: 1098.45 },
                    { id: 'dev-010', identifier: 'SCP00489', deviceLabel: 'Dunkin\' Donuts', total_value: 876.32 },
                    { id: 'dev-011', identifier: 'SCP00490', deviceLabel: 'Cinnabon', total_value: 654.21 },
                    { id: 'dev-012', identifier: 'SCP00491', deviceLabel: 'Auntie Anne\'s', total_value: 543.87 },
                    { id: 'dev-013', identifier: 'SCP00492', deviceLabel: 'Panda Express', total_value: 1876.54 },
                    { id: 'dev-014', identifier: 'SCP00493', deviceLabel: 'Chipotle', total_value: 2234.76 },
                    { id: 'dev-015', identifier: 'SCP00494', deviceLabel: 'Five Guys', total_value: 1567.89 }
                ];
                
                return stores;
            };

            // Call the real openDashboardPopupAllReport function with mock fetcher
            const modal = MyIOLibrary.openDashboardPopupAllReport({
                customerId: 'demo-customer-123',
                api: {
                    clientId: 'demo-client',
                    clientSecret: 'demo-secret',
                    dataApiBaseUrl: 'https://api.data.apps.myio-bas.com'
                },
                ui: { theme: 'light' },
                // Inject mock fetcher for demo (in production, this would use real API)
                fetcher: mockCustomerTotalsFetcher
            });

            // Demo event listeners
            modal.on('loaded', (data) => {
                console.log('📊 Customer Totals All Report loaded:', data);
                console.log('🚀 PRODUCTION FEATURES DEMONSTRATED:');
                console.log('  ✅ Real Customer Totals API integration (mocked for demo)');
                console.log('  ✅ Robust data processing with fallback chains');
                console.log('  ✅ Portuguese locale sorting (click column headers)');
                console.log('  ✅ Sticky totals row with grand total');
                console.log('  ✅ Consistent Brazilian number formatting');
                console.log('  ✅ CSV export with proper formatting');
                console.log('  ✅ Comprehensive error handling');
                console.log('  ✅ Loading states and UI feedback');
                console.log('');
                console.log('💡 TRY THESE FEATURES:');
                console.log('  • Click "Carregar" to load data with date range');
                console.log('  • Click column headers to sort (Identifier, Name, Consumption)');
                console.log('  • Click "CSV" to export with Brazilian formatting');
                console.log('  • Check header stats (stores count + total consumption)');
                console.log('  • Notice sticky totals row at top of table');
            });

            modal.on('close', () => {
                console.log('🔚 Customer Totals All Report closed');
            });
        }
        
        function openSettingsDemo() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('Library not loaded. Build the project first.');
                return;
            }
            
            MyIOLibrary.openDashboardPopup({
                deviceId: 'demo-device-123',
                api: { tbJwtToken: 'demo-jwt-token' },
                seed: {
                    label: 'Chiller Demo',
                    floor: 'E1',
                    storeNumber: 'SCP00480',
                    meterId: '12345',
                    deviceRef: 'DEMO001A',
                    guid: '5d344a31-demo-guid',
                    maxDailyKwh: 10000,
                    maxNightKwh: 1500,
                    maxBusinessKwh: 8000
                }
            });
        }
        
        // ThingsBoard Utility Function Demo
        let utilityTestResults = null;
        
        function testUtilityFunction() {
            if (typeof MyIOLibrary === 'undefined') {
                alert('MyIOLibrary not loaded. Build the project first.');
                return;
            }
            
            if (!MyIOLibrary.buildListItemsThingsboardByUniqueDatasource) {
                alert('❌ buildListItemsThingsboardByUniqueDatasource not available in this build.\\n\\nThis utility is part of the latest MyIOLibrary implementation.');
                return;
            }
            
            try {
                // Create mock ThingsBoard datasources
                const mockDatasources = [
                    {
                        entityId: 'entity-001',
                        entity: { label: 'Outback Steakhouse', name: 'Store 001' },
                        dataKeys: [
                            { name: 'identifier' },
                            { name: 'label' },
                            { name: 'ingestionId' }
                        ]
                    },
                    {
                        entityId: 'entity-002',
                        entity: { label: 'McDonald\'s', name: 'Store 002' },
                        dataKeys: [
                            { name: 'IDENTIFIER' }, // Test case normalization
                            { name: 'LABEL' },
                            { name: 'INGESTIONID' }
                        ]
                    },
                    {
                        entityId: 'entity-003',
                        entity: { name: 'Subway' }, // No label, fallback to name
                        dataKeys: [
                            { name: 'identifier' },
                            { name: 'ingestionId' }
                        ]
                    },
                    {
                        entityId: 'entity-004',
                        // No entity property - test edge case
                        dataKeys: [
                            { name: 'identifier' }
                        ]
                    }
                ];
                
                // Create mock ThingsBoard data
                const mockData = [
                    {
                        datasource: { entityId: 'entity-001' },
                        dataKey: { name: 'identifier' },
                        data: [['timestamp', 'SCP00480']]
                    },
                    {
                        datasource: { entityId: 'entity-001' },
                        dataKey: { name: 'ingestionId' },
                        data: [['timestamp', 'ING-001']]
                    },
                    {
                        datasource: { entityId: 'entity-002' },
                        dataKey: { name: 'IDENTIFIER' },
                        data: [['timestamp', 'SCP00481']]
                    },
                    {
                        datasource: { entityId: 'entity-002' },
                        dataKey: { name: 'INGESTIONID' },
                        data: [['timestamp', 'ING-002']]
                    },
                    {
                        datasource: { entityId: 'entity-003' },
                        dataKey: { name: 'identifier' },
                        data: [['timestamp', 'SCP00482']]
                    },
                    {
                        datasource: { entityId: 'entity-003' },
                        dataKey: { name: 'ingestionId' },
                        data: [['timestamp', 'ING-003']]
                    },
                    {
                        datasource: { entityId: 'entity-004' },
                        dataKey: { name: 'identifier' },
                        data: [['timestamp', 'SCP00483']]
                    },
                    // Test data for non-existent entity (should be ignored)
                    {
                        datasource: { entityId: 'entity-999' },
                        dataKey: { name: 'identifier' },
                        data: [['timestamp', 'IGNORED']]
                    }
                ];
                
                console.log('[UTILITY DEMO] Testing with mock data:', { datasources: mockDatasources, data: mockData });
                
                // Call the utility function
                const startTime = performance.now();
                utilityTestResults = MyIOLibrary.buildListItemsThingsboardByUniqueDatasource(mockDatasources, mockData);
                const endTime = performance.now();
                const executionTime = (endTime - startTime).toFixed(2);
                
                console.log('[UTILITY DEMO] Results:', utilityTestResults);
                console.log(`[UTILITY DEMO] Execution time: ${executionTime}ms`);
                
                // Store execution stats
                utilityTestResults._meta = {
                    executionTime,
                    inputDatasources: mockDatasources.length,
                    inputDataRows: mockData.length,
                    outputItems: utilityTestResults.length,
                    timestamp: new Date().toISOString()
                };
                
                alert(`✅ Utility Function Test Completed Successfully!\\n\\n🔧 Test Results:\\n• Input: ${mockDatasources.length} datasources, ${mockData.length} data rows\\n• Output: ${utilityTestResults.length} standardized items\\n• Execution time: ${executionTime}ms\\n• Portuguese locale sorting applied\\n\\n📊 Features Tested:\\n• Attribute key normalization (IDENTIFIER → identifier)\\n• Data hydration from ThingsBoard context\\n• Entity mapping and fallback values\\n• Portuguese locale sorting\\n• Edge case handling (missing entities, empty data)\\n\\n💡 Click "Show Results" to see the detailed output!`);
                
            } catch (error) {
                console.error('Error testing utility function:', error);
                alert(`❌ Error testing utility function: ${error.message}`);
            }
        }
        
        function showUtilityResults() {
            if (!utilityTestResults) {
                alert('Please run the utility function test first!');
                return;
            }
            
            try {
                const output = document.getElementById('utility-output');
                const details = document.getElementById('utility-details');
                
                // Format results for display
                let resultsHTML = `
                    <div style="margin: 8px 0;"><strong>Execution Time:</strong> ${utilityTestResults._meta.executionTime}ms</div>
                    <div style="margin: 8px 0;"><strong>Input:</strong> ${utilityTestResults._meta.inputDatasources} datasources, ${utilityTestResults._meta.inputDataRows} data rows</div>
                    <div style="margin: 8px 0;"><strong>Output:</strong> ${utilityTestResults._meta.outputItems} standardized items</div>
                    <div style="margin: 8px 0;"><strong>Function:</strong> MyIOLibrary.buildListItemsThingsboardByUniqueDatasource</div>
                    <div style="margin: 8px 0;"><strong>Test Time:</strong> ${new Date(utilityTestResults._meta.timestamp).toLocaleString('pt-BR')}</div>
                    <hr style="margin: 12px 0;">
                    <strong>Processed Items:</strong>
                    <div style="margin-top: 8px;">
                `;
                
                utilityTestResults.forEach((item, index) => {
                    resultsHTML += `
                        <div style="margin: 4px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #4A148C;">
                            <strong>${index + 1}. ${item.label}</strong><br>
                            <small>ID: ${item.id || 'null'} | Identifier: ${item.identifier}</small>
                        </div>
                    `;
                });
                
                resultsHTML += `
                    </div>
                    <hr style="margin: 12px 0;">
                    <div style="margin: 8px 0; color: #28a745;">
                        <strong>✅ Features Demonstrated:</strong><br>
                        <small>• Attribute normalization (IDENTIFIER → identifier)<br>
                        • Data hydration with fallback chains<br>
                        • Portuguese locale sorting (${utilityTestResults[0]?.label} comes first)<br>
                        • Edge case handling (missing entities ignored)<br>
                        • Type safety and error handling</small>
                    </div>
                `;
                
                details.innerHTML = resultsHTML;
                output.style.display = 'block';
                
                // Log detailed results to console
                console.log('📊 Detailed Utility Function Results:');
                console.table(utilityTestResults.map(item => ({
                    Label: item.label,
                    Identifier: item.identifier,
                    ID: item.id
                })));
                
            } catch (error) {
                console.error('Error displaying utility results:', error);
                alert(`❌ Error displaying results: ${error.message}`);
            }
        }
        
        function clearUtilityResults() {
            utilityTestResults = null;
            
            const output = document.getElementById('utility-output');
            output.style.display = 'none';
            
            alert('🗑️ Utility test results cleared successfully!\\n\\nYou can run the test again to generate new results.');
        }
    </script>
</body>
</html>
