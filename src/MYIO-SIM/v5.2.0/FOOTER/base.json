{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_footer_v_5_2_0",
    "name": "Widget Head Office - FOOTER - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://unpkg.com/myio-js-library@0.1.180/dist/myio-js-library.umd.min.js"
        },
        {
          "url": "https://graphs.staging.apps.myio-bas.com/sdk/energy-chart-sdk.umd.js"
        }
      ],
      "templateHtml": "<section class=\"myio-footer\">\r\n  <div class=\"myio-dock\" id=\"myioDock\" aria-live=\"polite\">\r\n    <span class=\"myio-empty\">Selecione dispositivos para comparar</span>\r\n  </div>\r\n  <div class=\"myio-right\">\r\n    <div class=\"myio-meta\">\r\n      <div class=\"myio-meta-title\">SELE√á√ÉO</div>\r\n      <div id=\"myioTotals\">0 itens</div>\r\n    </div>\r\n    <button id=\"myioClear\" class=\"myio-clear-btn\" title=\"Limpar sele√ß√£o\">\r\n      <svg\r\n        viewBox=\"0 0 24 24\"\r\n        fill=\"none\"\r\n        stroke=\"currentColor\"\r\n        stroke-linecap=\"round\"\r\n        stroke-linejoin=\"round\"\r\n      >\r\n        <polyline points=\"3 6 5 6 21 6\"></polyline>\r\n        <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"></path>\r\n      </svg>\r\n    </button>\r\n    <button id=\"myioCompare\" class=\"myio-compare\" disabled>Comparar</button>\r\n  </div>\r\n</section>\r\n",
      "templateCss": "/* ==========================================\r\n   MYIO Footer - Premium Design System\r\n   ========================================== */\r\n\r\n@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\r\n\r\n.myio-footer {\r\n  /* Design Tokens */\r\n  --color-primary: #00e09e;\r\n  --color-primary-hover: #00ffb5;\r\n  --color-primary-dark: #00c489;\r\n  --color-background: #0f1419;\r\n  --color-surface: #1a1f28;\r\n  --color-surface-elevated: #242b36;\r\n  --color-text-primary: #ffffff;\r\n  --color-text-secondary: rgba(255, 255, 255, 0.7);\r\n  --color-text-tertiary: rgba(255, 255, 255, 0.5);\r\n  --color-border: rgba(255, 255, 255, 0.08);\r\n  --color-error: #ff4444;\r\n\r\n  --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);\r\n  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);\r\n  --radius-sm: 6px;\r\n  --radius-md: 10px;\r\n  --radius-lg: 14px;\r\n  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  width: 100%;\r\n  height: 88px;\r\n  z-index: 10000;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 28px;\r\n  padding: 0 32px;\r\n  box-sizing: border-box;\r\n\r\n  /* Visual */\r\n  font-family: var(--font-family);\r\n  color: var(--color-text-primary);\r\n  background: linear-gradient(180deg, rgba(26, 31, 40, 0.98) 0%, rgba(15, 20, 25, 0.98) 100%);\r\n  border-top: 2px solid rgba(0, 224, 158, 0.3);\r\n  box-shadow: var(--shadow-lg), 0 -2px 24px rgba(0, 224, 158, 0.15);\r\n  backdrop-filter: blur(24px);\r\n  -webkit-backdrop-filter: blur(24px);\r\n}\r\n\r\n/* ==========================================\r\n   Dock Area (Chips Container)\r\n   ========================================== */\r\n\r\n.myio-dock {\r\n  flex: 1;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16px;\r\n  overflow-x: auto;\r\n  overflow-y: hidden;\r\n  padding: 10px 0;\r\n  margin: 0 -8px;\r\n  padding-left: 8px;\r\n  padding-right: 8px;\r\n\r\n  /* Custom Scrollbar */\r\n  scrollbar-width: thin;\r\n  scrollbar-color: rgba(0, 224, 158, 0.6) transparent;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar {\r\n  height: 6px;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar-track {\r\n  background: rgba(0, 224, 158, 0.08);\r\n  border-radius: 3px;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar-thumb {\r\n  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);\r\n  border-radius: 3px;\r\n  box-shadow: 0 0 8px rgba(0, 224, 158, 0.4);\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar-thumb:hover {\r\n  background: linear-gradient(90deg, var(--color-primary-hover) 0%, var(--color-primary) 100%);\r\n  box-shadow: 0 0 12px rgba(0, 224, 158, 0.6);\r\n}\r\n\r\n/* ==========================================\r\n   Chip (Device Card)\r\n   ========================================== */\r\n\r\n.myio-chip {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 14px;\r\n  padding: 14px 18px;\r\n  height: 64px;\r\n  flex-shrink: 0;\r\n\r\n  background: linear-gradient(135deg, rgba(0, 224, 158, 0.12) 0%, rgba(0, 224, 158, 0.06) 100%);\r\n  border: 1px solid rgba(0, 224, 158, 0.3);\r\n  border-radius: var(--radius-lg);\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);\r\n\r\n  white-space: nowrap;\r\n  cursor: default;\r\n  transition: var(--transition);\r\n  animation: chipSlideIn 0.3s ease-out;\r\n  position: relative;\r\n  overflow: hidden;\r\n}\r\n\r\n/* Chip glow effect */\r\n.myio-chip::before {\r\n  content: '';\r\n  position: absolute;\r\n  top: -50%;\r\n  left: -50%;\r\n  width: 200%;\r\n  height: 200%;\r\n  background: radial-gradient(circle, rgba(0, 224, 158, 0.15) 0%, transparent 70%);\r\n  opacity: 0;\r\n  transition: opacity 0.3s;\r\n}\r\n\r\n@keyframes chipSlideIn {\r\n  from {\r\n    opacity: 0;\r\n    transform: translateY(20px) scale(0.95);\r\n  }\r\n  to {\r\n    opacity: 1;\r\n    transform: translateY(0) scale(1);\r\n  }\r\n}\r\n\r\n.myio-chip:hover {\r\n  background: linear-gradient(135deg, rgba(0, 224, 158, 0.18) 0%, rgba(0, 224, 158, 0.1) 100%);\r\n  border-color: rgba(0, 224, 158, 0.5);\r\n  box-shadow: 0 6px 16px rgba(0, 224, 158, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15);\r\n  transform: translateY(-3px);\r\n}\r\n\r\n.myio-chip:hover::before {\r\n  opacity: 1;\r\n}\r\n\r\n/* Chip Content */\r\n.myio-chip-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n  min-width: 0;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.myio-chip-name {\r\n  font-size: 15px;\r\n  font-weight: 700;\r\n  color: var(--color-text-primary);\r\n  letter-spacing: -0.02em;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\r\n}\r\n\r\n.myio-chip-value {\r\n  font-size: 18px;\r\n  font-weight: 700;\r\n  color: var(--color-primary);\r\n  font-variant-numeric: tabular-nums;\r\n  letter-spacing: -0.02em;\r\n  text-shadow: 0 0 8px rgba(0, 224, 158, 0.4);\r\n}\r\n\r\n/* Remove Button - Premium Style */\r\n.myio-chip-remove {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 32px;\r\n  height: 32px;\r\n  padding: 0;\r\n  margin-left: 8px;\r\n  flex-shrink: 0;\r\n\r\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);\r\n  border: 1px solid rgba(255, 255, 255, 0.12);\r\n  border-radius: 8px;\r\n  color: rgba(255, 255, 255, 0.6);\r\n  cursor: pointer;\r\n  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\r\n  overflow: hidden;\r\n}\r\n\r\n/* Hover shine effect */\r\n.myio-chip-remove::before {\r\n  content: '';\r\n  position: absolute;\r\n  top: 0;\r\n  left: -100%;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);\r\n  transition: left 0.4s;\r\n}\r\n\r\n.myio-chip-remove:hover::before {\r\n  left: 100%;\r\n}\r\n\r\n.myio-chip-remove:hover {\r\n  background: linear-gradient(135deg, rgba(255, 68, 68, 0.25) 0%, rgba(255, 68, 68, 0.15) 100%);\r\n  border-color: rgba(255, 68, 68, 0.5);\r\n  color: #ff4444;\r\n  transform: scale(1.05);\r\n  box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);\r\n}\r\n\r\n.myio-chip-remove:active {\r\n  transform: scale(0.95);\r\n  box-shadow: 0 2px 6px rgba(255, 68, 68, 0.2);\r\n}\r\n\r\n.myio-chip-remove svg {\r\n  position: relative;\r\n  z-index: 1;\r\n  width: 16px;\r\n  height: 16px;\r\n  stroke-width: 2.5;\r\n  stroke-linecap: round;\r\n}\r\n\r\n/* ==========================================\r\n   Empty State\r\n   ========================================== */\r\n\r\n.myio-empty {\r\n  color: var(--color-primary);\r\n  font-size: 15px;\r\n  font-weight: 600;\r\n  font-style: normal;\r\n  padding: 12px 24px;\r\n  opacity: 0.7;\r\n  background: linear-gradient(135deg, rgba(0, 224, 158, 0.08) 0%, transparent 100%);\r\n  border: 1px dashed rgba(0, 224, 158, 0.3);\r\n  border-radius: var(--radius-md);\r\n  text-shadow: 0 0 8px rgba(0, 224, 158, 0.3);\r\n  animation: pulseGlow 2s ease-in-out infinite;\r\n}\r\n\r\n@keyframes pulseGlow {\r\n  0%,\r\n  100% {\r\n    opacity: 0.5;\r\n    box-shadow: 0 0 0 rgba(0, 224, 158, 0.3);\r\n  }\r\n  50% {\r\n    opacity: 0.8;\r\n    box-shadow: 0 0 16px rgba(0, 224, 158, 0.3);\r\n  }\r\n}\r\n\r\n/* ==========================================\r\n   Right Section (Stats + Compare Button)\r\n   ========================================== */\r\n\r\n.myio-right {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 20px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n/* Stats Display */\r\n.myio-meta {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: flex-end;\r\n  gap: 6px;\r\n  padding: 8px 16px;\r\n  min-width: 160px;\r\n  background: linear-gradient(135deg, rgba(0, 224, 158, 0.08) 0%, rgba(0, 224, 158, 0.04) 100%);\r\n  border: 1px solid rgba(0, 224, 158, 0.2);\r\n  border-radius: var(--radius-md);\r\n  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);\r\n}\r\n\r\n.myio-meta::before {\r\n  content: attr(data-label);\r\n  font-size: 10px;\r\n  font-weight: 700;\r\n  color: var(--color-primary);\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.1em;\r\n  text-shadow: 0 0 8px rgba(0, 224, 158, 0.4);\r\n}\r\n\r\n/* Stats value styling */\r\n#myioTotals {\r\n  font-size: 16px;\r\n  font-weight: 700;\r\n  color: var(--color-text-primary);\r\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\r\n}\r\n\r\n/* Compare Button - Premium Style */\r\n.myio-compare {\r\n  position: relative;\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 8px;\r\n  height: 48px;\r\n  min-width: 140px;\r\n  padding: 0 24px;\r\n\r\n  font-family: var(--font-family);\r\n  font-size: 15px;\r\n  font-weight: 700;\r\n  letter-spacing: -0.01em;\r\n  text-transform: uppercase;\r\n\r\n  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);\r\n  border: none;\r\n  border-radius: var(--radius-md);\r\n  color: var(--color-background);\r\n  cursor: pointer;\r\n  overflow: hidden;\r\n\r\n  box-shadow: 0 0 0 1px rgba(0, 224, 158, 0.2), 0 4px 16px rgba(0, 224, 158, 0.4),\r\n    inset 0 1px 0 rgba(255, 255, 255, 0.2);\r\n\r\n  transition: var(--transition);\r\n}\r\n\r\n/* Button Shine Effect */\r\n.myio-compare::before {\r\n  content: '';\r\n  position: absolute;\r\n  top: 0;\r\n  left: -100%;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);\r\n  transition: left 0.5s;\r\n}\r\n\r\n.myio-compare:hover::before {\r\n  left: 100%;\r\n}\r\n\r\n.myio-compare:hover {\r\n  background: linear-gradient(135deg, var(--color-primary-hover) 0%, var(--color-primary) 100%);\r\n  box-shadow: 0 0 0 1px rgba(0, 224, 158, 0.3), 0 6px 24px rgba(0, 224, 158, 0.5),\r\n    inset 0 1px 0 rgba(255, 255, 255, 0.3);\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.myio-compare:active {\r\n  transform: translateY(0) scale(0.98);\r\n  box-shadow: 0 0 0 1px rgba(0, 224, 158, 0.2), 0 2px 8px rgba(0, 224, 158, 0.3),\r\n    inset 0 1px 0 rgba(255, 255, 255, 0.2);\r\n}\r\n\r\n/* Disabled State */\r\n.myio-compare:disabled {\r\n  background: var(--color-surface);\r\n  color: var(--color-text-tertiary);\r\n  cursor: not-allowed;\r\n  opacity: 0.5;\r\n  box-shadow: none;\r\n  transform: none;\r\n}\r\n\r\n.myio-compare:disabled::before {\r\n  display: none;\r\n}\r\n\r\n.myio-compare:disabled:hover {\r\n  transform: none;\r\n}\r\n\r\n/* Button Icon (Optional) */\r\n.myio-compare::after {\r\n  content: '‚Üí';\r\n  font-size: 18px;\r\n  margin-left: 4px;\r\n  transition: transform 0.2s;\r\n}\r\n\r\n.myio-compare:hover::after {\r\n  transform: translateX(4px);\r\n}\r\n\r\n.myio-compare:disabled::after {\r\n  display: none;\r\n}\r\n\r\n/* ==========================================\r\n   Premium Alert Overlay\r\n   ========================================== */\r\n\r\n.myio-alert-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  z-index: 100000;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n\r\n  background: rgba(0, 0, 0, 0.5);\r\n  backdrop-filter: blur(4px);\r\n  -webkit-backdrop-filter: blur(4px);\r\n\r\n  animation: fadeIn 0.2s ease-out;\r\n}\r\n\r\n@keyframes fadeIn {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n.myio-alert-box {\r\n  position: relative;\r\n  max-width: 480px;\r\n  width: 90%;\r\n  padding: 32px;\r\n\r\n  background: #ffffff;\r\n  border: 1px solid rgba(0, 0, 0, 0.1);\r\n  border-radius: 20px;\r\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\r\n\r\n  animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n}\r\n\r\n@keyframes slideUp {\r\n  from {\r\n    opacity: 0;\r\n    transform: translateY(40px) scale(0.95);\r\n  }\r\n  to {\r\n    opacity: 1;\r\n    transform: translateY(0) scale(1);\r\n  }\r\n}\r\n\r\n.myio-alert-icon {\r\n  width: 64px;\r\n  height: 64px;\r\n  margin: 0 auto 20px;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n\r\n  background: linear-gradient(135deg, #3e1a7d 0%, #2d1359 100%);\r\n  border: 2px solid #3e1a7d;\r\n  border-radius: 50%;\r\n\r\n  color: #ffffff;\r\n  font-size: 32px;\r\n}\r\n\r\n.myio-alert-title {\r\n  margin: 0 0 12px;\r\n\r\n  font-size: 24px;\r\n  font-weight: 700;\r\n  color: #000000;\r\n  text-align: center;\r\n  letter-spacing: -0.02em;\r\n}\r\n\r\n.myio-alert-message {\r\n  margin: 0 0 28px;\r\n\r\n  font-size: 16px;\r\n  font-weight: 500;\r\n  color: #000000;\r\n  text-align: center;\r\n  line-height: 1.6;\r\n}\r\n\r\n.myio-alert-button {\r\n  width: 100%;\r\n  height: 48px;\r\n\r\n  font-family: var(--font-family);\r\n  font-size: 15px;\r\n  font-weight: 700;\r\n  text-transform: uppercase;\r\n\r\n  background: linear-gradient(135deg, #3e1a7d 0%, #2d1359 100%);\r\n  border: none;\r\n  border-radius: 12px;\r\n  color: #ffffff;\r\n  cursor: pointer;\r\n\r\n  box-shadow: 0 4px 16px rgba(62, 26, 125, 0.4);\r\n  transition: var(--transition);\r\n}\r\n\r\n.myio-alert-button:hover {\r\n  background: linear-gradient(135deg, #4e2a9d 0%, #3e1a7d 100%);\r\n  box-shadow: 0 6px 24px rgba(62, 26, 125, 0.5);\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.myio-alert-button:active {\r\n  transform: translateY(0) scale(0.98);\r\n}\r\n\r\n/* ==========================================\r\n   Responsive Design\r\n   ========================================== */\r\n\r\n@media (max-width: 1024px) {\r\n  .myio-footer {\r\n    height: 72px;\r\n    padding: 0 20px;\r\n    gap: 16px;\r\n  }\r\n\r\n  .myio-chip {\r\n    height: 52px;\r\n    padding: 10px 14px;\r\n  }\r\n\r\n  .myio-compare {\r\n    height: 44px;\r\n    min-width: 120px;\r\n    padding: 0 20px;\r\n    font-size: 14px;\r\n  }\r\n}\r\n\r\n@media (max-width: 768px) {\r\n  .myio-footer {\r\n    flex-direction: column;\r\n    height: auto;\r\n    min-height: 120px;\r\n    padding: 16px 20px;\r\n    gap: 12px;\r\n  }\r\n\r\n  .myio-dock {\r\n    width: 100%;\r\n    justify-content: flex-start;\r\n  }\r\n\r\n  .myio-right {\r\n    width: 100%;\r\n    justify-content: space-between;\r\n  }\r\n\r\n  .myio-meta {\r\n    align-items: flex-start;\r\n  }\r\n\r\n  .myio-compare {\r\n    flex: 1;\r\n    max-width: 200px;\r\n  }\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary */\r\n/**\r\n * NOTA: Este script depende das seguintes bibliotecas:\r\n *\r\n * IMPORTANTE: Adicione as bibliotecas como External Resources no widget do ThingsBoard:\r\n * Widget Settings > Resources > Add Resource > External Resource:\r\n *\r\n * 1. MyIO Library (obrigat√≥rio):\r\n *    https://unpkg.com/myio-js-library@latest/dist/myio-js-library.umd.min.js\r\n *\r\n * 2. Energy Chart SDK (obrigat√≥rio para compara√ß√£o):\r\n *    Use a mesma base URL definida em CHARTS_BASE_URL abaixo + /sdk/energy-chart-sdk.umd.js\r\n *\r\n * Para os √≠cones, idealmente, voc√™ carregaria uma biblioteca como Font Awesome ou Material Icons.\r\n * Por simplicidade no exemplo, os √≠cones '‚Ä¢' e '√ó' s√£o mantidos, mas estilizaremos para parecerem melhores.\r\n */\r\n\r\n// ============================================================================\r\n// CONFIGURA√á√ÉO DE AMBIENTE - Altere aqui para trocar entre staging e produ√ß√£o\r\n// ============================================================================\r\nconst CHARTS_BASE_URL = 'https://graphs.staging.apps.myio-bas.com'; // staging para testes\r\n// const CHARTS_BASE_URL = 'https://graphs.apps.myio-bas.com'; // produ√ß√£o\r\n\r\n// RFC-0086: Get DATA_API_HOST from MAIN via MyIOUtils\r\nfunction getDataApiHost() {\r\n  const host = window.MyIOUtils?.DATA_API_HOST;\r\n  if (!host) {\r\n    console.error('[FOOTER] DATA_API_HOST not available - MAIN widget not loaded');\r\n  }\r\n  return host || '';\r\n}\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log(...args),\r\n  warn: (...args) => console.warn(...args),\r\n  error: (...args) => console.error(...args),\r\n};\r\n\r\n// --- 2. Inje√ß√£o de CSS (executada uma vez) ---\r\nlet cssInjected = false;\r\n\r\nfunction injectCSS() {\r\n  if (cssInjected) return;\r\n\r\n  const styleId = 'myio-footer-premium-styles';\r\n  if (document.getElementById(styleId)) {\r\n    cssInjected = true;\r\n    return;\r\n  }\r\n\r\n  const style = document.createElement('style');\r\n  style.id = styleId;\r\n  style.textContent = `\r\n/* ==========================================\r\n   MYIO Footer - Premium Design System\r\n   ========================================== */\r\n\r\n@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');\r\n\r\n.myio-footer {\r\n  /* Design Tokens - Purple Theme */\r\n  --color-primary: #9E8CBE;\r\n  --color-primary-hover: #B8A5D6;\r\n  --color-primary-dark: #8472A8;\r\n  --color-background: #0f1419;\r\n  --color-surface: #1a1f28;\r\n  --color-surface-elevated: #242b36;\r\n  --color-text-primary: #ffffff;\r\n  --color-text-secondary: rgba(255, 255, 255, 0.7);\r\n  --color-text-tertiary: rgba(255, 255, 255, 0.5);\r\n  --color-border: rgba(255, 255, 255, 0.08);\r\n  --color-error: #ff4444;\r\n\r\n  --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\r\n  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);\r\n  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);\r\n  --radius-sm: 6px;\r\n  --radius-md: 10px;\r\n  --radius-lg: 14px;\r\n  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  width: 100%;\r\n  height: 46px;\r\n  z-index: 1000;\r\n\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 14px;\r\n  padding: 0 18px;\r\n  box-sizing: border-box;\r\n\r\n  /* Visual */\r\n  font-family: var(--font-family);\r\n  color: var(--color-text-primary);\r\n  background: linear-gradient(\r\n    180deg,\r\n    rgba(158, 140, 190, 0.95) 0%,\r\n    rgba(132, 114, 168, 0.98) 100%\r\n  );\r\n  border-top: 2px solid rgba(184, 165, 214, 0.5);\r\n  box-shadow:\r\n    var(--shadow-lg),\r\n    0 -2px 24px rgba(158, 140, 190, 0.3);\r\n  backdrop-filter: blur(24px);\r\n  -webkit-backdrop-filter: blur(24px);\r\n}\r\n\r\n.myio-dock {\r\n  flex: 1;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16px;\r\n  overflow-x: auto;\r\n  overflow-y: hidden;\r\n  padding: 10px 0;\r\n  margin: 0 -8px;\r\n  padding-left: 8px;\r\n  padding-right: 8px;\r\n  scrollbar-width: thin;\r\n  scrollbar-color: rgba(158, 140, 190, 0.6) transparent;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar {\r\n  height: 6px;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar-track {\r\n  background: rgba(158, 140, 190, 0.08);\r\n  border-radius: 3px;\r\n}\r\n\r\n.myio-dock::-webkit-scrollbar-thumb {\r\n  background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);\r\n  border-radius: 3px;\r\n  box-shadow: 0 0 8px rgba(158, 140, 190, 0.4);\r\n}\r\n\r\n.myio-chip {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 7px;\r\n  padding: 5px 10px;\r\n  height: 34px;\r\n  flex-shrink: 0;\r\n  background: linear-gradient(135deg, rgba(158, 140, 190, 0.25) 0%, rgba(158, 140, 190, 0.15) 100%);\r\n  border: 1px solid rgba(184, 165, 214, 0.4);\r\n  border-radius: var(--radius-md);\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);\r\n  white-space: nowrap;\r\n  cursor: default;\r\n  transition: var(--transition);\r\n  animation: chipSlideIn 0.3s ease-out;\r\n  position: relative;\r\n  overflow: hidden;\r\n}\r\n\r\n@keyframes chipSlideIn {\r\n  from { opacity: 0; transform: translateY(20px) scale(0.95); }\r\n  to { opacity: 1; transform: translateY(0) scale(1); }\r\n}\r\n\r\n.myio-chip:hover {\r\n  background: linear-gradient(135deg, rgba(158, 140, 190, 0.35) 0%, rgba(158, 140, 190, 0.25) 100%);\r\n  border-color: rgba(184, 165, 214, 0.6);\r\n  box-shadow: 0 6px 16px rgba(158, 140, 190, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);\r\n  transform: translateY(-3px);\r\n}\r\n\r\n.myio-chip-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n  min-width: 0;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.myio-chip-name {\r\n  font-size: 10px;\r\n  font-weight: 600;\r\n  color: #ffffff;\r\n  letter-spacing: -0.02em;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\r\n}\r\n\r\n.myio-chip-value {\r\n  font-size: 12px;\r\n  font-weight: 700;\r\n  color: #ffffff;\r\n  font-variant-numeric: tabular-nums;\r\n  letter-spacing: -0.02em;\r\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\r\n}\r\n\r\n.myio-chip-remove {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 22px;\r\n  height: 22px;\r\n  padding: 0;\r\n  margin-left: 5px;\r\n  flex-shrink: 0;\r\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);\r\n  border: 1px solid rgba(255, 255, 255, 0.12);\r\n  border-radius: 4px;\r\n  color: rgba(255, 255, 255, 0.6);\r\n  cursor: pointer;\r\n  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\r\n  overflow: hidden;\r\n}\r\n\r\n.myio-chip-remove:hover {\r\n  background: linear-gradient(135deg, rgba(255, 68, 68, 0.25) 0%, rgba(255, 68, 68, 0.15) 100%);\r\n  border-color: rgba(255, 68, 68, 0.5);\r\n  color: #ff4444;\r\n  transform: scale(1.05);\r\n  box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);\r\n}\r\n\r\n.myio-chip-remove svg {\r\n  position: relative;\r\n  z-index: 1;\r\n  width: 16px;\r\n  height: 16px;\r\n  stroke-width: 2.5;\r\n  stroke-linecap: round;\r\n}\r\n\r\n.myio-empty {\r\n  color: var(--color-text-primary);\r\n  font-size: 15px;\r\n  font-weight: 600;\r\n  padding: 12px 24px;\r\n  opacity: 0.9;\r\n  background: linear-gradient(135deg, rgba(158, 140, 190, 0.15) 0%, transparent 100%);\r\n  border: 1px dashed rgba(184, 165, 214, 0.4);\r\n  border-radius: var(--radius-md);\r\n  text-shadow: 0 0 8px rgba(158, 140, 190, 0.3);\r\n  animation: pulseGlow 2s ease-in-out infinite;\r\n}\r\n\r\n@keyframes pulseGlow {\r\n  0%, 100% { opacity: 0.7; box-shadow: 0 0 0 rgba(158, 140, 190, 0.3); }\r\n  50% { opacity: 1; box-shadow: 0 0 16px rgba(158, 140, 190, 0.3); }\r\n}\r\n\r\n.myio-right {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 20px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.myio-meta {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 0px;\r\n  padding: 4px 9px;\r\n  min-width: 100px;\r\n  background: linear-gradient(135deg, rgba(158, 140, 190, 0.15) 0%, rgba(158, 140, 190, 0.08) 100%);\r\n  border: 1px solid rgba(184, 165, 214, 0.3);\r\n  border-radius: var(--radius-md);\r\n  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);\r\n}\r\n\r\n.myio-meta-title {\r\n  font-size: 10px;\r\n  font-weight: 700;\r\n  color: var(--color-text-primary);\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.1em;\r\n  text-shadow: 0 0 8px rgba(158, 140, 190, 0.4);\r\n}\r\n\r\n#myioTotals {\r\n  font-size: 11px;\r\n  font-weight: 700;\r\n  color: var(--color-text-primary);\r\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\r\n}\r\n\r\n.myio-clear-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 32px;\r\n  height: 32px;\r\n  padding: 0;\r\n  background: linear-gradient(135deg, rgba(200, 200, 200, 0.2) 0%, rgba(200, 200, 200, 0.1) 100%);\r\n  border: 1px solid rgba(200, 200, 200, 0.3);\r\n  border-radius: var(--radius-md);\r\n  color: #cccccc;\r\n  cursor: pointer;\r\n  transition: var(--transition);\r\n}\r\n\r\n.myio-clear-btn:hover {\r\n  background: linear-gradient(135deg, rgba(200, 200, 200, 0.3) 0%, rgba(200, 200, 200, 0.2) 100%);\r\n  border-color: rgba(200, 200, 200, 0.5);\r\n  transform: translateY(-2px);\r\n  box-shadow: 0 4px 12px rgba(200, 200, 200, 0.3);\r\n}\r\n\r\n.myio-clear-btn:disabled {\r\n  background: var(--color-surface);\r\n  border-color: rgba(255, 255, 255, 0.1);\r\n  color: var(--color-text-tertiary);\r\n  cursor: not-allowed;\r\n  opacity: 0.5;\r\n  transform: none;\r\n}\r\n\r\n.myio-clear-btn:disabled:hover {\r\n  transform: none;\r\n  box-shadow: none;\r\n}\r\n\r\n.myio-clear-btn svg {\r\n  width: 16px;\r\n  height: 16px;\r\n  stroke-width: 2;\r\n}\r\n\r\n.myio-compare {\r\n  position: relative;\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 4px;\r\n  height: 32px;\r\n  min-width: 100px;\r\n  padding: 0 16px;\r\n  font-family: var(--font-family);\r\n  font-size: 12px;\r\n  font-weight: 700;\r\n  letter-spacing: -0.01em;\r\n  text-transform: uppercase;\r\n  background: #3E1A7D;\r\n  border: none;\r\n  border-radius: var(--radius-md);\r\n  color: var(--color-text-primary);\r\n  cursor: pointer;\r\n  overflow: hidden;\r\n  box-shadow: 0 0 0 1px rgba(62, 26, 125, 0.5), 0 4px 16px rgba(62, 26, 125, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);\r\n  transition: var(--transition);\r\n}\r\n\r\n.myio-compare:hover {\r\n  background: linear-gradient(135deg, #5A2CB8 0%, #3E1A7D 100%);\r\n  box-shadow: 0 0 0 1px rgba(62, 26, 125, 0.7), 0 6px 24px rgba(62, 26, 125, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.myio-compare:disabled {\r\n  background: var(--color-surface);\r\n  color: var(--color-text-tertiary);\r\n  cursor: not-allowed;\r\n  opacity: 0.5;\r\n  box-shadow: none;\r\n  transform: none;\r\n}\r\n\r\n.myio-compare::after {\r\n  content: '‚Üí';\r\n  font-size: 14px;\r\n  margin-left: 2px;\r\n  transition: transform 0.2s;\r\n}\r\n\r\n.myio-compare:hover::after {\r\n  transform: translateX(4px);\r\n}\r\n\r\n.myio-compare:disabled::after {\r\n  display: none;\r\n}\r\n\r\n.myio-alert-overlay {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  z-index: 100000;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: rgba(0, 0, 0, 0.85);\r\n  backdrop-filter: blur(8px);\r\n  animation: fadeIn 0.2s ease-out;\r\n}\r\n\r\n@keyframes fadeIn {\r\n  from { opacity: 0; }\r\n  to { opacity: 1; }\r\n}\r\n\r\n.myio-alert-box {\r\n  position: relative;\r\n  max-width: 480px;\r\n  width: 90%;\r\n  padding: 32px;\r\n  background: linear-gradient(135deg, var(--color-surface-elevated) 0%, var(--color-surface) 100%);\r\n  border: 1px solid rgba(255, 255, 255, 0.1);\r\n  border-radius: 20px;\r\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);\r\n  animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n}\r\n\r\n@keyframes slideUp {\r\n  from { opacity: 0; transform: translateY(40px) scale(0.95); }\r\n  to { opacity: 1; transform: translateY(0) scale(1); }\r\n}\r\n\r\n.myio-alert-icon {\r\n  width: 64px;\r\n  height: 64px;\r\n  margin: 0 auto 20px;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.2) 100%);\r\n  border: 2px solid rgba(255, 193, 7, 0.5);\r\n  border-radius: 50%;\r\n  color: #ffc107;\r\n  font-size: 32px;\r\n}\r\n\r\n.myio-alert-title {\r\n  margin: 0 0 12px;\r\n  font-size: 24px;\r\n  font-weight: 700;\r\n  color: var(--color-text-primary);\r\n  text-align: center;\r\n  letter-spacing: -0.02em;\r\n}\r\n\r\n.myio-alert-message {\r\n  margin: 0 0 28px;\r\n  font-size: 16px;\r\n  font-weight: 500;\r\n  color: var(--color-text-secondary);\r\n  text-align: center;\r\n  line-height: 1.6;\r\n}\r\n\r\n.myio-alert-button {\r\n  width: 100%;\r\n  height: 48px;\r\n  font-family: var(--font-family);\r\n  font-size: 15px;\r\n  font-weight: 700;\r\n  text-transform: uppercase;\r\n  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);\r\n  border: none;\r\n  border-radius: 12px;\r\n  color: var(--color-text-primary);\r\n  cursor: pointer;\r\n  box-shadow: 0 4px 16px rgba(158, 140, 190, 0.4);\r\n  transition: var(--transition);\r\n}\r\n\r\n.myio-alert-button:hover {\r\n  background: linear-gradient(135deg, var(--color-primary-hover) 0%, var(--color-primary) 100%);\r\n  box-shadow: 0 6px 24px rgba(158, 140, 190, 0.5);\r\n  transform: translateY(-2px);\r\n}\r\n    `;\r\n\r\n  document.head.appendChild(style);\r\n  cssInjected = true;\r\n  LogHelper.log('[MyIO Footer] ‚úÖ CSS injected successfully');\r\n}\r\n\r\n// --- 3. Controlador do Footer (Objeto encapsulado) ---\r\nconst footerController = {\r\n  $root: null,\r\n  $footerEl: null,\r\n  $dock: null,\r\n  $totals: null,\r\n  $compareBtn: null,\r\n  $clearBtn: null,\r\n  $alertOverlay: null,\r\n  initialized: false,\r\n  currentUnitType: null, // Tracks current unit type (energy, water, tank, etc)\r\n\r\n  // Armazena refer√™ncias √†s fun√ß√µes com 'this' vinculado para remo√ß√£o segura\r\n  boundRenderDock: null,\r\n  boundCompareClick: null,\r\n  boundClearClick: null,\r\n  boundDragOver: null,\r\n  boundDrop: null,\r\n  boundChipClick: null,\r\n  boundLimitReached: null,\r\n  boundDashboardStateChange: null,\r\n\r\n  /**\r\n   * Inicializa o controlador\r\n   */\r\n  init(ctx) {\r\n    LogHelper.log('[MyIO Footer] init() called');\r\n\r\n    if (this.initialized) {\r\n      LogHelper.log('[MyIO Footer] Already initialized, skipping');\r\n      return;\r\n    }\r\n\r\n    // Injeta o CSS primeiro\r\n    injectCSS();\r\n\r\n    this.$root = ctx?.$container?.[0];\r\n    this.ctx = ctx;\r\n    if (!this.$root) {\r\n      LogHelper.error('[MyIO Footer] Root container not found.');\r\n      return;\r\n    }\r\n    LogHelper.log('[MyIO Footer] Root container found');\r\n\r\n    // Verifica se a biblioteca MyIOLibrary est√° carregada via Resources\r\n    if (!window.MyIOLibrary) {\r\n      LogHelper.error(\r\n        '[MyIO Footer] MyIOLibrary not found. ' +\r\n          'Please add the library as a Resource in ThingsBoard widget settings:\\n' +\r\n          'https://unpkg.com/myio-js-library@latest/dist/myio-js-library.umd.min.js'\r\n      );\r\n      return;\r\n    }\r\n    LogHelper.log('[MyIO Footer] MyIOLibrary found');\r\n\r\n    // IMPORTANTE: N√ÉO chamamos mountTemplate() porque o ThingsBoard j√° renderizou template.html!\r\n    // this.mountTemplate(); // ‚Üê REMOVIDO\r\n    LogHelper.log('[MyIO Footer] Using ThingsBoard template.html (not mounting manually)');\r\n\r\n    this.queryDOMElements(); // Consultar elementos do template.html\r\n    LogHelper.log('[MyIO Footer] DOM elements queried:', {\r\n      dock: !!this.$dock,\r\n      totals: !!this.$totals,\r\n      compareBtn: !!this.$compareBtn,\r\n    });\r\n\r\n    this.bindEvents();\r\n    LogHelper.log('[MyIO Footer] Events bound');\r\n\r\n    this.renderDock(); // Renderiza√ß√£o inicial\r\n    LogHelper.log('[MyIO Footer] Initial render complete');\r\n\r\n    this.initialized = true;\r\n  },\r\n\r\n  /**\r\n   * Monta o template do footer no DOM\r\n   */\r\n  mountTemplate() {\r\n    // Cria o elemento principal do footer\r\n    const footerSection = document.createElement('section');\r\n    footerSection.className = 'myio-footer';\r\n\r\n    // Habilita modo fixo opcional via settings do widget (ctx.settings.fixedFooter)\r\n    try {\r\n      const fixed = !!(this.ctx && this.ctx.settings && this.ctx.settings.fixedFooter);\r\n      if (fixed) footerSection.classList.add('is-fixed');\r\n    } catch (_) {\r\n      /* noop */\r\n    }\r\n\r\n    // Insere o conte√∫do do template explicitamente\r\n    footerSection.innerHTML = `\r\n        <div class=\"myio-dock\" id=\"myioDock\" aria-live=\"polite\"></div>\r\n        <div class=\"myio-right\">\r\n          <div class=\"myio-meta\" id=\"myioTotals\">0 selecionados</div>\r\n          <button id=\"myioCompare\" class=\"myio-compare\" disabled>Compare</button>\r\n        </div>\r\n      `;\r\n\r\n    this.$root.appendChild(footerSection);\r\n    this.$footerEl = footerSection; // Armazena a refer√™ncia ao footer\r\n  },\r\n\r\n  /**\r\n   * Consulta os elementos do DOM *uma vez* e armazena as refer√™ncias\r\n   * IMPORTANTE: Como n√£o montamos o template manualmente, buscamos direto do $root\r\n   */\r\n  queryDOMElements() {\r\n    // Busca a section do footer (renderizada pelo template.html do ThingsBoard)\r\n    this.$footerEl = this.$root.querySelector('.myio-footer');\r\n\r\n    if (!this.$footerEl) {\r\n      LogHelper.error('[MyIO Footer] .myio-footer section not found in template!');\r\n      return;\r\n    }\r\n\r\n    // Busca os elementos dentro da section\r\n    this.$dock = this.$footerEl.querySelector('#myioDock');\r\n    this.$totals = this.$footerEl.querySelector('#myioTotals');\r\n    this.$clearBtn = this.$footerEl.querySelector('#myioClear');\r\n    this.$compareBtn = this.$footerEl.querySelector('#myioCompare');\r\n\r\n    LogHelper.log('[MyIO Footer] Found elements from ThingsBoard template:', {\r\n      $footerEl: this.$footerEl,\r\n      $dock: this.$dock,\r\n      $totals: this.$totals,\r\n      $clearBtn: this.$clearBtn,\r\n      $compareBtn: this.$compareBtn,\r\n    });\r\n  },\r\n\r\n  /**\r\n   * Detecta o tipo de unidade (icon) das entidades selecionadas\r\n   * Retorna: 'energy', 'water', 'tank', 'mixed', ou null\r\n   */\r\n  _detectUnitType(entities) {\r\n    if (!entities || entities.length === 0) return null;\r\n\r\n    const types = new Set();\r\n    entities.forEach((entity) => {\r\n      if (entity && entity.icon) {\r\n        types.add(entity.icon);\r\n      }\r\n    });\r\n\r\n    if (types.size === 0) return null;\r\n    if (types.size > 1) return 'mixed'; // Tipos misturados!\r\n    return Array.from(types)[0]; // Um √∫nico tipo\r\n  },\r\n\r\n  /**\r\n   * Renderiza o conte√∫do do \"dock\" (chips ou mensagem de vazio)\r\n   */\r\n  renderDock() {\r\n    LogHelper.log('[MyIO Footer] renderDock() called');\r\n\r\n    if (!this.$dock || !this.$totals || !this.$compareBtn) {\r\n      LogHelper.warn('[MyIO Footer] DOM elements not ready:', {\r\n        dock: !!this.$dock,\r\n        totals: !!this.$totals,\r\n        compareBtn: !!this.$compareBtn,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Try both window.MyIOLibrary.MyIOSelectionStore and window.MyIOSelectionStore\r\n    const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n\r\n    if (!MyIOSelectionStore) {\r\n      LogHelper.error('[MyIO Footer] MyIOSelectionStore not found.');\r\n      return;\r\n    }\r\n\r\n    const selected = MyIOSelectionStore.getSelectedEntities();\r\n    const count = selected.length;\r\n\r\n    // INTELIG√äNCIA: Detecta tipo de unidade e reseta se houver mudan√ßa\r\n    const detectedType = this._detectUnitType(selected);\r\n\r\n    // Se detectou tipos misturados, limpa a sele√ß√£o automaticamente\r\n    if (detectedType === 'mixed') {\r\n      LogHelper.warn(\r\n        '[MyIO Footer] ‚ö†Ô∏è Mixed unit types detected! Clearing selection to prevent invalid comparison.'\r\n      );\r\n      this.showMixedUnitsAlert();\r\n      MyIOSelectionStore.clear();\r\n      return; // renderDock ser√° chamado novamente ap√≥s o clear\r\n    }\r\n\r\n    // Se mudou o tipo de unidade (ex: de 'energy' para 'water'), limpa a sele√ß√£o\r\n    if (detectedType && this.currentUnitType && detectedType !== this.currentUnitType) {\r\n      LogHelper.warn(\r\n        `[MyIO Footer] ‚ö†Ô∏è Unit type changed from '${this.currentUnitType}' to '${detectedType}'! Clearing selection.`\r\n      );\r\n      this.currentUnitType = detectedType;\r\n      MyIOSelectionStore.clear();\r\n      return; // renderDock ser√° chamado novamente ap√≥s o clear\r\n    }\r\n\r\n    // Atualiza o tipo atual\r\n    this.currentUnitType = detectedType;\r\n\r\n    // Calcula os totais/m√©dia manualmente a partir dos lastValue das entidades\r\n    let totalValue = 0;\r\n    let validValuesCount = 0;\r\n\r\n    selected.forEach((entity) => {\r\n      if (entity && typeof entity.lastValue === 'number') {\r\n        totalValue += entity.lastValue;\r\n        validValuesCount++;\r\n      }\r\n    });\r\n\r\n    // Para temperatura, calcula m√©dia ao inv√©s de soma\r\n    let displayValue = totalValue;\r\n    if (detectedType === 'temperature' && validValuesCount > 0) {\r\n      displayValue = totalValue / validValuesCount;\r\n    }\r\n\r\n    // Formata o valor usando formata√ß√£o brasileira\r\n    const totals = this._formatValue(displayValue);\r\n\r\n    LogHelper.log('[MyIO Footer] Rendering dock:', {\r\n      count,\r\n      selected,\r\n      totalValue,\r\n      totalsFormatted: totals,\r\n    });\r\n\r\n    // DEBUG: Log each entity\r\n    LogHelper.log('[MyIO Footer] Selected entities details:');\r\n    selected.forEach((ent, idx) => {\r\n      LogHelper.log(`[MyIO Footer]   Entity ${idx}:`, ent);\r\n    });\r\n\r\n    if (count === 0) {\r\n      LogHelper.log('[MyIO Footer] Count is 0, rendering empty message');\r\n      const emptyEl = document.createElement('span');\r\n      emptyEl.className = 'myio-empty';\r\n      emptyEl.textContent = 'Arraste itens para c√° ou selecione no card';\r\n      this.$dock.replaceChildren(emptyEl); // Mais seguro e perform√°tico\r\n      LogHelper.log('[MyIO Footer] Empty message rendered');\r\n    } else {\r\n      LogHelper.log(`[MyIO Footer] Count is ${count}, creating chips...`);\r\n      // Cria chips de forma eficiente e segura\r\n      const chips = selected\r\n        .map((ent, idx) => {\r\n          LogHelper.log(`[MyIO Footer]   Creating chip ${idx} for entity:`, ent);\r\n\r\n          if (!ent || !ent.name) {\r\n            LogHelper.error(`[MyIO Footer]   Entity ${idx} is invalid:`, ent);\r\n            return null;\r\n          }\r\n\r\n          const chip = document.createElement('div');\r\n          chip.className = 'myio-chip';\r\n\r\n          // Conte√∫do do chip (nome + valor)\r\n          const content = document.createElement('div');\r\n          content.className = 'myio-chip-content';\r\n\r\n          const name = document.createElement('span');\r\n          name.className = 'myio-chip-name';\r\n          name.textContent = `${ent.name + ' ' + ent.customerName}`;\r\n\r\n          const value = document.createElement('span');\r\n          value.className = 'myio-chip-value';\r\n          // Formata o valor com unidade\r\n          const formattedValue = ent.lastValue\r\n            ? `${this._formatValue(ent.lastValue)} ${ent.unit || ''}`.trim()\r\n            : 'Sem dados';\r\n          value.textContent = formattedValue;\r\n\r\n          content.append(name, value);\r\n\r\n          // Bot√£o de remover\r\n          const removeBtn = document.createElement('button');\r\n          removeBtn.className = 'myio-chip-remove';\r\n          removeBtn.title = `Remover ${ent.name}`;\r\n          removeBtn.setAttribute('aria-label', `Remover ${ent.name}`);\r\n          removeBtn.dataset.entityId = ent.id;\r\n          removeBtn.innerHTML = `\r\n            <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n              <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n              <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n            </svg>\r\n          `;\r\n\r\n          chip.append(content, removeBtn);\r\n          LogHelper.log(`[MyIO Footer]   Chip ${idx} created successfully`);\r\n          return chip;\r\n        })\r\n        .filter((chip) => chip !== null); // Remove null chips\r\n\r\n      LogHelper.log(`[MyIO Footer] Total chips created: ${chips.length}`);\r\n      LogHelper.log('[MyIO Footer] About to call replaceChildren with chips:', chips);\r\n\r\n      this.$dock.replaceChildren(...chips); // Renderiza todos de uma vez\r\n\r\n      LogHelper.log('[MyIO Footer] replaceChildren completed');\r\n      LogHelper.log('[MyIO Footer] $dock.children.length:', this.$dock.children.length);\r\n      LogHelper.log('[MyIO Footer] $dock.innerHTML:', this.$dock.innerHTML);\r\n\r\n      // DEBUG: Check if CSS is being applied\r\n      if (this.$dock.children.length > 0) {\r\n        const dockStyles = window.getComputedStyle(this.$dock);\r\n        const firstChip = this.$dock.children[0];\r\n        const chipStyles = window.getComputedStyle(firstChip);\r\n\r\n        LogHelper.log('[MyIO Footer] üé® CSS DIAGNOSTICS:');\r\n        LogHelper.log('  $dock display:', dockStyles.display);\r\n        LogHelper.log('  $dock flexDirection:', dockStyles.flexDirection);\r\n        LogHelper.log('  $dock gap:', dockStyles.gap);\r\n        LogHelper.log('  firstChip display:', chipStyles.display);\r\n        LogHelper.log('  firstChip className:', firstChip.className);\r\n        LogHelper.log('  firstChip background:', chipStyles.background);\r\n        LogHelper.log('  firstChip border:', chipStyles.border);\r\n\r\n        const removeBtn = firstChip.querySelector('.myio-chip-remove');\r\n        if (removeBtn) {\r\n          const btnStyles = window.getComputedStyle(removeBtn);\r\n          LogHelper.log('  removeBtn background:', btnStyles.background);\r\n          LogHelper.log('  removeBtn border:', btnStyles.border);\r\n          LogHelper.log('  removeBtn width:', btnStyles.width);\r\n          LogHelper.log('  removeBtn height:', btnStyles.height);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Atualiza totais e bot√£o\r\n    const itemText = count === 1 ? 'item' : 'itens';\r\n\r\n    // Se n√£o houver sele√ß√£o, mostra mensagem padr√£o\r\n    let newTotalsText;\r\n    if (count === 0) {\r\n      newTotalsText = '0 itens';\r\n    } else {\r\n      // Para temperatura, indica que √© m√©dia\r\n      const prefix = detectedType === 'temperature' ? 'M√©dia: ' : '';\r\n      newTotalsText = `${count} ${itemText} (${prefix}${totals})`;\r\n    }\r\n\r\n    LogHelper.log(`[MyIO Footer] Updating totals text to: \"${newTotalsText}\"`);\r\n    this.$totals.textContent = newTotalsText;\r\n    LogHelper.log('[MyIO Footer] Totals updated. Current text:', this.$totals.textContent);\r\n\r\n    this.$compareBtn.disabled = count < 2;\r\n    this.$clearBtn.disabled = count === 0;\r\n    LogHelper.log('[MyIO Footer] renderDock() completed');\r\n  },\r\n\r\n  /**\r\n   * Formata valores num√©ricos para exibi√ß√£o\r\n   */\r\n  _formatValue(value) {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0';\r\n\r\n    // Para valores grandes (>= 1000), usa nota√ß√£o com separadores\r\n    if (Math.abs(value) >= 1000) {\r\n      return new Intl.NumberFormat('pt-BR', {\r\n        minimumFractionDigits: 0,\r\n        maximumFractionDigits: 2,\r\n      }).format(value);\r\n    }\r\n\r\n    // Para valores pequenos, mostra at√© 2 casas decimais\r\n    return value.toFixed(2).replace(/\\.?0+$/, '');\r\n  },\r\n\r\n  /**\r\n   * Mostra o alerta premium quando tipos de unidades s√£o misturados\r\n   */\r\n  showMixedUnitsAlert() {\r\n    LogHelper.log('[MyIO Footer] Showing mixed units alert');\r\n\r\n    // Remove qualquer alerta existente\r\n    if (this.$alertOverlay) {\r\n      this.hideAlert();\r\n    }\r\n\r\n    // Cria o overlay do alerta\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'myio-alert-overlay';\r\n\r\n    overlay.innerHTML = `\r\n        <div class=\"myio-alert-box\">\r\n          <div class=\"myio-alert-icon\">‚ö†</div>\r\n          <h2 class=\"myio-alert-title\">Tipos Incompat√≠veis</h2>\r\n          <p class=\"myio-alert-message\">\r\n            Voc√™ n√£o pode comparar dispositivos de <strong>tipos diferentes</strong>\r\n            (ex: energia vs √°gua). A sele√ß√£o foi limpa automaticamente.\r\n            <br><br>\r\n            Selecione apenas dispositivos do mesmo tipo para compara√ß√£o.\r\n          </p>\r\n          <button class=\"myio-alert-button\">Entendi</button>\r\n        </div>\r\n      `;\r\n\r\n    // Adiciona ao body para que fique acima de tudo\r\n    document.body.appendChild(overlay);\r\n    this.$alertOverlay = overlay;\r\n\r\n    // Adiciona listener no bot√£o e no overlay (clique fora)\r\n    const closeBtn = overlay.querySelector('.myio-alert-button');\r\n    const closeAlert = () => this.hideAlert();\r\n\r\n    closeBtn.addEventListener('click', closeAlert);\r\n    overlay.addEventListener('click', (e) => {\r\n      if (e.target === overlay) {\r\n        closeAlert();\r\n      }\r\n    });\r\n\r\n    LogHelper.log('[MyIO Footer] Mixed units alert displayed');\r\n  },\r\n\r\n  /**\r\n   * Mostra o alerta premium quando o limite de sele√ß√£o √© atingido\r\n   */\r\n  showLimitAlert() {\r\n    LogHelper.log('[MyIO Footer] Showing limit alert');\r\n\r\n    // Remove qualquer alerta existente\r\n    if (this.$alertOverlay) {\r\n      this.hideAlert();\r\n    }\r\n\r\n    // Cria o overlay do alerta\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'myio-alert-overlay';\r\n\r\n    overlay.innerHTML = `\r\n        <div class=\"myio-alert-box\">\r\n          <div class=\"myio-alert-icon\">‚ö†</div>\r\n          <h2 class=\"myio-alert-title\">Limite Atingido</h2>\r\n          <p class=\"myio-alert-message\">\r\n            Voc√™ pode selecionar no m√°ximo <strong>6 dispositivos</strong> para compara√ß√£o.\r\n            Remova um dispositivo antes de adicionar outro.\r\n          </p>\r\n          <button class=\"myio-alert-button\">FECHAR</button>\r\n        </div>\r\n      `;\r\n\r\n    // Adiciona ao body para que fique acima de tudo\r\n    document.body.appendChild(overlay);\r\n    this.$alertOverlay = overlay;\r\n\r\n    // Adiciona listener no bot√£o e no overlay (clique fora)\r\n    const closeBtn = overlay.querySelector('.myio-alert-button');\r\n    const closeAlert = () => this.hideAlert();\r\n\r\n    closeBtn.addEventListener('click', closeAlert);\r\n    overlay.addEventListener('click', (e) => {\r\n      if (e.target === overlay) {\r\n        closeAlert();\r\n      }\r\n    });\r\n\r\n    LogHelper.log('[MyIO Footer] Limit alert displayed');\r\n  },\r\n\r\n  /**\r\n   * Esconde o alerta premium (gen√©rico)\r\n   */\r\n  hideAlert() {\r\n    if (this.$alertOverlay && this.$alertOverlay.parentNode) {\r\n      this.$alertOverlay.remove();\r\n      this.$alertOverlay = null;\r\n      LogHelper.log('[MyIO Footer] Alert hidden');\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Alias para compatibilidade com c√≥digo antigo\r\n   */\r\n  hideLimitAlert() {\r\n    this.hideAlert();\r\n  },\r\n\r\n  /**\r\n   * Handler para evento de limite atingido\r\n   */\r\n  onLimitReached(data) {\r\n    LogHelper.log('[MyIO Footer] Limit reached event received:', data);\r\n    this.showLimitAlert();\r\n  },\r\n\r\n  /**\r\n   * Handler para evento de mudan√ßa de dashboard (troca de aba no MENU)\r\n   * Limpa a sele√ß√£o do FOOTER quando o usu√°rio troca entre energy/water/temperature\r\n   */\r\n  onDashboardStateChange(event) {\r\n    const newDomain = event.detail?.domain || event.detail?.tab;\r\n    const stateId = event.detail?.stateId;\r\n\r\n    LogHelper.log(`[MyIO Footer] Dashboard state changed to domain: ${newDomain}, stateId: ${stateId}`);\r\n\r\n    // Se mudou para um dom√≠nio v√°lido (energy, water, temperature)\r\n    // Limpa a sele√ß√£o para evitar compara√ß√µes inv√°lidas entre dom√≠nios diferentes\r\n    if (\r\n      newDomain &&\r\n      (newDomain === 'energy' || newDomain === 'water' || newDomain === 'temperature' || newDomain === 'tank')\r\n    ) {\r\n      const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n\r\n      if (MyIOSelectionStore) {\r\n        const count = MyIOSelectionStore.getSelectionCount();\r\n\r\n        // S√≥ limpa se houver algo selecionado\r\n        if (count > 0) {\r\n          LogHelper.log(\r\n            `[MyIO Footer] Clearing ${count} selected items due to domain change to: ${newDomain}`\r\n          );\r\n          MyIOSelectionStore.clear();\r\n\r\n          // Reseta o tipo atual\r\n          this.currentUnitType = null;\r\n\r\n          // For√ßa re-renderiza√ß√£o do dock para mostrar estado vazio\r\n          this.renderDock();\r\n        }\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Vincula todos os ouvintes de eventos\r\n   */\r\n  bindEvents() {\r\n    LogHelper.log('[MyIO Footer] bindEvents() called');\r\n\r\n    // DEBUG: Check which SelectionStore instance we're using\r\n    LogHelper.log('[MyIO Footer] window.MyIOLibrary:', !!window.MyIOLibrary);\r\n    LogHelper.log(\r\n      '[MyIO Footer] window.MyIOLibrary.MyIOSelectionStore:',\r\n      !!window.MyIOLibrary?.MyIOSelectionStore\r\n    );\r\n    LogHelper.log('[MyIO Footer] window.MyIOSelectionStore:', !!window.MyIOSelectionStore);\r\n\r\n    // Try both window.MyIOLibrary.MyIOSelectionStore and window.MyIOSelectionStore\r\n    const fromMyIOLibrary = window.MyIOLibrary?.MyIOSelectionStore;\r\n    const fromWindow = window.MyIOSelectionStore;\r\n    const MyIOSelectionStore = fromMyIOLibrary || fromWindow;\r\n\r\n    // DEBUG: Check which reference we're using\r\n    LogHelper.log(\r\n      '[MyIO Footer] Using reference from:',\r\n      fromMyIOLibrary ? 'window.MyIOLibrary.MyIOSelectionStore' : 'window.MyIOSelectionStore'\r\n    );\r\n    LogHelper.log('[MyIO Footer] Are they the same instance?', fromMyIOLibrary === fromWindow);\r\n\r\n    if (!MyIOSelectionStore) {\r\n      LogHelper.error('[MyIO Footer] MyIOSelectionStore not available for binding events.');\r\n      return;\r\n    }\r\n\r\n    // DEBUG: Verify we have the correct instance\r\n    LogHelper.log('[MyIO Footer] Using SelectionStore instance:', MyIOSelectionStore.constructor.name);\r\n    LogHelper.log('[MyIO Footer] SelectionStore has .on method:', typeof MyIOSelectionStore.on);\r\n\r\n    // DEBUG: Check hidden global instance\r\n    try {\r\n      const topWindowInstance = window.top.__MyIOSelectionStore_INSTANCE__;\r\n      LogHelper.log('[MyIO Footer] window.top.__MyIOSelectionStore_INSTANCE__ exists:', !!topWindowInstance);\r\n      LogHelper.log(\r\n        '[MyIO Footer] Using same instance as window.top?',\r\n        MyIOSelectionStore === topWindowInstance\r\n      );\r\n    } catch (e) {\r\n      LogHelper.warn('[MyIO Footer] Cannot access window.top:', e.message);\r\n    }\r\n\r\n    LogHelper.log('[MyIO Footer] Current listeners count before registration:', {\r\n      'selection:change': MyIOSelectionStore.eventListeners?.get('selection:change')?.length || 0,\r\n      'selection:totals': MyIOSelectionStore.eventListeners?.get('selection:totals')?.length || 0,\r\n    });\r\n\r\n    // 1. Armazena fun√ß√µes vinculadas (para remo√ß√£o correta)\r\n    this.boundRenderDock = this.renderDock.bind(this);\r\n    this.boundCompareClick = this.onCompareClick.bind(this);\r\n    this.boundClearClick = this.onClearClick.bind(this);\r\n    this.boundDragOver = (e) => e.preventDefault();\r\n    this.boundDrop = this.onDrop.bind(this);\r\n    this.boundChipClick = this.onChipClick.bind(this);\r\n    this.boundLimitReached = this.onLimitReached.bind(this);\r\n    this.boundDashboardStateChange = this.onDashboardStateChange.bind(this);\r\n\r\n    // 2. Ouve a store externa\r\n    LogHelper.log('[MyIO Footer] About to register selection:change listener...');\r\n    LogHelper.log('[MyIO Footer] MyIOSelectionStore.on function:', MyIOSelectionStore.on);\r\n    LogHelper.log(\"[MyIO Footer] Calling MyIOSelectionStore.on('selection:change', boundRenderDock)...\");\r\n    const result1 = MyIOSelectionStore.on('selection:change', this.boundRenderDock);\r\n    LogHelper.log('[MyIO Footer] Result from .on() call:', result1);\r\n\r\n    LogHelper.log('[MyIO Footer] About to register selection:totals listener...');\r\n    const result2 = MyIOSelectionStore.on('selection:totals', this.boundRenderDock);\r\n    LogHelper.log('[MyIO Footer] Result from .on() call:', result2);\r\n\r\n    LogHelper.log('[MyIO Footer] About to register selection:limit-reached listener...');\r\n    const result3 = MyIOSelectionStore.on('selection:limit-reached', this.boundLimitReached);\r\n    LogHelper.log('[MyIO Footer] Result from .on() call:', result3);\r\n\r\n    // DEBUG: Verify registration worked\r\n    LogHelper.log('[MyIO Footer] Current listeners count after registration:', {\r\n      'selection:change': MyIOSelectionStore.eventListeners?.get('selection:change')?.length || 0,\r\n      'selection:totals': MyIOSelectionStore.eventListeners?.get('selection:totals')?.length || 0,\r\n      'selection:limit-reached':\r\n        MyIOSelectionStore.eventListeners?.get('selection:limit-reached')?.length || 0,\r\n    });\r\n\r\n    LogHelper.log('[MyIO Footer] Registered listeners on SelectionStore');\r\n\r\n    // 3. Ouve elementos do DOM interno\r\n    if (this.$compareBtn) {\r\n      this.$compareBtn.addEventListener('click', this.boundCompareClick);\r\n    }\r\n\r\n    if (this.$clearBtn) {\r\n      this.$clearBtn.addEventListener('click', this.boundClearClick);\r\n    }\r\n\r\n    // 4. Delega√ß√£o de evento para cliques nos chips\r\n    if (this.$dock) {\r\n      this.$dock.addEventListener('click', this.boundChipClick);\r\n    }\r\n\r\n    // 5. Eventos de Drag and Drop no footer\r\n    if (this.$footerEl) {\r\n      this.$footerEl.addEventListener('dragover', this.boundDragOver);\r\n      this.$footerEl.addEventListener('drop', this.boundDrop);\r\n    }\r\n\r\n    // 6. Evento de mudan√ßa de aba no MENU (limpa sele√ß√£o ao trocar entre energy/water/tank)\r\n    window.addEventListener('myio:dashboard-state', this.boundDashboardStateChange);\r\n    LogHelper.log('[MyIO Footer] Registered listener for myio:dashboard-state (tab change from MENU)');\r\n  },\r\n\r\n  /**\r\n   * Manipulador de clique para o \"dock\" (delega√ß√£o)\r\n   */\r\n  onChipClick(e) {\r\n    // Verifica se o clique foi em um bot√£o de remover\r\n    const removeBtn = e.target.closest('button[data-entity-id]');\r\n    if (removeBtn) {\r\n      const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n      if (MyIOSelectionStore) {\r\n        const id = removeBtn.dataset.entityId;\r\n        MyIOSelectionStore.remove(id);\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Abre a modal de compara√ß√£o premium usando openDashboardPopupEnergy\r\n   * NOVO: Usa o modo 'comparison' do EnergyModalView\r\n   * Para temperatura: usa modal customizada com Chart.js (n√£o SDK)\r\n   */\r\n  async openComparisonModal() {\r\n    LogHelper.log('[MyIO Footer] Opening comparison modal...');\r\n\r\n    const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n    if (!MyIOSelectionStore) {\r\n      LogHelper.error('[MyIO Footer] SelectionStore not found');\r\n      return;\r\n    }\r\n\r\n    const selected = MyIOSelectionStore.getSelectedEntities();\r\n    const count = selected.length;\r\n\r\n    if (count < 2) {\r\n      LogHelper.warn('[MyIO Footer] Need at least 2 devices for comparison');\r\n      window.alert('Selecione pelo menos 2 dispositivos para comparar.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Detecta o tipo de unidade e o readingType\r\n      const unitType = this.currentUnitType || this._detectUnitType(selected);\r\n      const readingType = this._mapUnitTypeToReadingType(unitType);\r\n\r\n      LogHelper.log(`[MyIO Footer] Comparison readingType: ${readingType}`);\r\n\r\n      // Temperature uses custom comparison modal (not SDK-based)\r\n      if (readingType === 'temperature') {\r\n        LogHelper.log('[MyIO Footer] Using temperature comparison modal (not SDK)');\r\n        await this._openTemperatureComparisonModal(selected);\r\n        return;\r\n      }\r\n\r\n      // ‚≠ê NOVO: Prepara dataSources com ingestionId\r\n      // IMPORTANTE: Usa ingestionId, n√£o o ID do ThingsBoard\r\n\r\n      const dataSources = selected.map((entity) => ({\r\n        type: 'device',\r\n        id: entity.ingestionId || entity.id, // Prioriza ingestionId\r\n        label: `${entity.name + ' ' + entity.customerName}` || `${entity.name + ' ' + entity.id}`,\r\n      }));\r\n\r\n      // Obt√©m credenciais e per√≠odo\r\n      const ctx = self.ctx || {};\r\n      const startDate = ctx.scope?.startDateISO || new Date(new Date().setDate(1)).toISOString();\r\n      const endDate = ctx.scope?.endDateISO || new Date().toISOString();\r\n\r\n      // Calcula granularidade baseada no per√≠odo\r\n      const granularity = this._calculateGranularity(startDate, endDate);\r\n\r\n      // ‚≠ê Obt√©m credenciais de autentica√ß√£o com fallback\r\n      const clientId = window.__MYIO_CLIENT_ID__ || 'mestreal_mfh4e642_4flnuh';\r\n      const clientSecret =\r\n        window.__MYIO_CLIENT_SECRET__ || 'gv0zfmdekNxYA296OcqFrnBAVU4PhbUBhBwNlMCamk2oXDHeXJqu1K6YtpVOZ5da';\r\n\r\n      // Log se estiver usando fallback\r\n      if (!window.__MYIO_CLIENT_ID__) {\r\n        LogHelper.warn('[MyIO Footer] Using fallback clientId');\r\n      }\r\n      if (!window.__MYIO_CLIENT_SECRET__) {\r\n        LogHelper.warn('[MyIO Footer] Using fallback clientSecret');\r\n      }\r\n\r\n      LogHelper.log('[MyIO Footer] Opening modal with config:', {\r\n        dataSources: dataSources.length,\r\n        readingType,\r\n        startDate,\r\n        endDate,\r\n        granularity,\r\n        clientId,\r\n      });\r\n\r\n      // ‚≠ê NOVO: Usa openDashboardPopupEnergy em modo comparison\r\n      // Substitui a modal customizada (_createComparisonModalOverlay)\r\n      if (!window.MyIOLibrary?.openDashboardPopupEnergy) {\r\n        LogHelper.error('[MyIO Footer] openDashboardPopupEnergy not available');\r\n        window.alert('Biblioteca MyIO n√£o est√° carregada. Recarregue a p√°gina.');\r\n        return;\r\n      }\r\n\r\n      // ‚≠ê Usa as vari√°veis com fallback (j√° definidas acima)\r\n      const dataApiHost = getDataApiHost();\r\n      const MyIOAuthFooter = MyIOLibrary.buildMyioIngestionAuth({\r\n        dataApiHost: dataApiHost,\r\n        clientId: clientId, // ‚Üê Usa a vari√°vel com fallback\r\n        clientSecret: clientSecret, // ‚Üê Usa a vari√°vel com fallback\r\n      });\r\n\r\n      const myTbTokenDashBoardFooter = localStorage.getItem('jwt_token');\r\n      const tokenIngestionDashBoardComparison = await MyIOAuthFooter.getToken();\r\n\r\n      const modal = window.MyIOLibrary.openDashboardPopupEnergy({\r\n        mode: 'comparison', // ‚Üê MODO COMPARISON\r\n        tbJwtToken: myTbTokenDashBoardFooter,\r\n        ingestionToken: tokenIngestionDashBoardComparison,\r\n        dataSources: dataSources,\r\n        readingType: readingType,\r\n        startDate: startDate,\r\n        endDate: endDate,\r\n        granularity: granularity, // ‚Üê OBRIGAT√ìRIO para comparison\r\n        clientId: clientId,\r\n        clientSecret: clientSecret,\r\n        dataApiHost: dataApiHost,\r\n        chartsBaseUrl: CHARTS_BASE_URL, // ‚Üê URL base para iframes do SDK (staging)\r\n        theme: 'dark', // ‚Üê Tema inicial (toggle dispon√≠vel na modal)\r\n        deep: false,\r\n        onOpen: (context) => {\r\n          LogHelper.log('[FOOTER] Comparison modal opened:', context);\r\n        },\r\n        onClose: () => {\r\n          LogHelper.log('[FOOTER] Comparison modal closed');\r\n        },\r\n        onError: (error) => {\r\n          LogHelper.error('[FOOTER] Comparison modal error:', error);\r\n          window.alert(`Erro: ${error.message}`);\r\n        },\r\n      });\r\n\r\n      LogHelper.log('[MyIO Footer] Modal opened successfully:', modal);\r\n    } catch (error) {\r\n      LogHelper.error('[MyIO Footer] Error opening comparison modal:', error);\r\n      window.alert('Erro ao abrir modal de compara√ß√£o. Verifique o console.');\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Mapeia unitType (icon) para readingType do SDK\r\n   */\r\n  _mapUnitTypeToReadingType(unitType) {\r\n    const mapping = {\r\n      energy: 'energy',\r\n      water: 'water',\r\n      tank: 'tank',\r\n      temperature: 'temperature',\r\n    };\r\n    return mapping[unitType] || 'energy';\r\n  },\r\n\r\n  /**\r\n   * Calcula a granularidade ideal baseada no per√≠odo\r\n   */\r\n  _calculateGranularity(startISO, endISO) {\r\n    const start = new Date(startISO);\r\n    const end = new Date(endISO);\r\n    const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));\r\n\r\n    if (diffDays <= 1) return '1h'; // 1 dia: granularidade hor√°ria\r\n    if (diffDays <= 7) return '1d'; // 1 semana: di√°ria\r\n    if (diffDays <= 31) return '1d'; // 1 m√™s: di√°ria\r\n    if (diffDays <= 90) return '1w'; // 3 meses: semanal\r\n    return '1M'; // Mais de 3 meses: mensal\r\n  },\r\n\r\n  /**\r\n   * Opens temperature comparison modal using MyIOLibrary\r\n   * RFC-0085: Uses the library component instead of inline implementation\r\n   * @param {Array} selectedEntities - Array of selected entity objects\r\n   */\r\n  async _openTemperatureComparisonModal(selectedEntities) {\r\n    LogHelper.log(\r\n      '[MyIO Footer] Opening temperature comparison modal for',\r\n      selectedEntities.length,\r\n      'devices'\r\n    );\r\n\r\n    const jwtToken = localStorage.getItem('jwt_token');\r\n\r\n    if (!jwtToken) {\r\n      window.alert('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.');\r\n      return;\r\n    }\r\n\r\n    // Get date range from context\r\n    const ctx = self.ctx || {};\r\n    const startDateISO =\r\n      ctx.scope?.startDateISO || new Date(new Date().setDate(new Date().getDate() - 7)).toISOString();\r\n    const endDateISO = ctx.scope?.endDateISO || new Date().toISOString();\r\n\r\n    // Map entities to the expected device format with per-device temperature ranges\r\n    // Each device can have its own ideal range from its customer's SERVER_SCOPE attributes\r\n    const devices = selectedEntities.map((entity) => {\r\n      // Get temperature range for this specific device/customer\r\n      // Standard: temperatureMin/temperatureMax (fallback: minTemperature/maxTemperature for TB attributes)\r\n      const min = entity.temperatureMin ?? entity.minTemperature ?? entity.tempMin;\r\n      const max = entity.temperatureMax ?? entity.maxTemperature ?? entity.tempMax;\r\n\r\n      return {\r\n        id: entity.id || entity.entityId,\r\n        label: entity.name || entity.label || entity.id,\r\n        tbId: entity.tbId || entity.entityId,\r\n        customerName: entity.customerTitle || entity.customerName || entity.customer || null,\r\n        temperatureMin: min !== undefined && min !== null ? Number(min) : undefined,\r\n        temperatureMax: max !== undefined && max !== null ? Number(max) : undefined,\r\n      };\r\n    });\r\n\r\n    // Check if devices have different temperature ranges (different customers)\r\n    const uniqueRanges = new Set(\r\n      devices\r\n        .filter((d) => d.temperatureMin !== undefined && d.temperatureMax !== undefined)\r\n        .map((d) => `${d.temperatureMin}-${d.temperatureMax}`)\r\n    );\r\n\r\n    if (uniqueRanges.size > 1) {\r\n      LogHelper.log(\r\n        '[MyIO Footer] Devices have different temperature ranges (multiple customers):',\r\n        devices.map((d) => ({\r\n          label: d.label,\r\n          customer: d.customerName,\r\n          range: `${d.temperatureMin}-${d.temperatureMax}`,\r\n        }))\r\n      );\r\n    }\r\n\r\n    // Fallback global range from ctx.scope (if no per-device ranges)\r\n    // Standard: temperatureMin/temperatureMax (fallback: minTemperature/maxTemperature for TB scope)\r\n    let globalTemperatureMin = null;\r\n    let globalTemperatureMax = null;\r\n\r\n    if (ctx.scope?.temperatureMin !== undefined) {\r\n      globalTemperatureMin = Number(ctx.scope.temperatureMin);\r\n    } else if (ctx.scope?.minTemperature !== undefined) {\r\n      globalTemperatureMin = Number(ctx.scope.minTemperature);\r\n    }\r\n    if (ctx.scope?.temperatureMax !== undefined) {\r\n      globalTemperatureMax = Number(ctx.scope.temperatureMax);\r\n    } else if (ctx.scope?.maxTemperature !== undefined) {\r\n      globalTemperatureMax = Number(ctx.scope.maxTemperature);\r\n    }\r\n\r\n    LogHelper.log('[MyIO Footer] Temperature ranges:', {\r\n      perDevice: devices.map((d) => ({ label: d.label, min: d.temperatureMin, max: d.temperatureMax })),\r\n      global: { min: globalTemperatureMin, max: globalTemperatureMax },\r\n    });\r\n\r\n    // Use MyIOLibrary.openTemperatureComparisonModal\r\n    const MyIOLibrary = window.MyIOLibrary;\r\n    if (!MyIOLibrary?.openTemperatureComparisonModal) {\r\n      LogHelper.error('[MyIO Footer] MyIOLibrary.openTemperatureComparisonModal not available');\r\n      window.alert('Componente de compara√ß√£o de temperatura n√£o dispon√≠vel.');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      MyIOLibrary.openTemperatureComparisonModal({\r\n        token: jwtToken,\r\n        devices: devices,\r\n        startDate: startDateISO,\r\n        endDate: endDateISO,\r\n        theme: 'dark',\r\n        locale: 'pt-BR',\r\n        granularity: 'hour',\r\n        // Global fallback range (used only if devices don't have individual ranges)\r\n        temperatureMin: globalTemperatureMin,\r\n        temperatureMax: globalTemperatureMax,\r\n      });\r\n\r\n      LogHelper.log('[MyIO Footer] Temperature comparison modal opened via MyIOLibrary');\r\n    } catch (error) {\r\n      LogHelper.error('[MyIO Footer] Error opening temperature comparison modal:', error);\r\n      window.alert('Erro ao abrir modal de compara√ß√£o de temperatura: ' + error.message);\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Manipulador de clique para o bot√£o \"Compare\"\r\n   */\r\n  onCompareClick() {\r\n    this.openComparisonModal();\r\n  },\r\n\r\n  /**\r\n   * Manipulador de clique para o bot√£o \"Clear\" (limpar tudo)\r\n   */\r\n  onClearClick() {\r\n    const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n    if (MyIOSelectionStore) {\r\n      LogHelper.log('[MyIO Footer] Clearing all selections');\r\n      MyIOSelectionStore.clear();\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Manipulador de evento 'drop'\r\n   */\r\n  onDrop(e) {\r\n    e.preventDefault();\r\n    const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n    if (MyIOSelectionStore) {\r\n      const id = e.dataTransfer?.getData('text/myio-id') || e.dataTransfer?.getData('text/plain');\r\n      if (id) {\r\n        MyIOSelectionStore.add(id);\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Limpa o widget, removendo listeners e elementos do DOM\r\n   */\r\n  destroy() {\r\n    if (!this.initialized) return;\r\n\r\n    // 1. Remove listeners da store externa\r\n    try {\r\n      const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n      if (MyIOSelectionStore) {\r\n        MyIOSelectionStore.off('selection:change', this.boundRenderDock);\r\n        MyIOSelectionStore.off('selection:totals', this.boundRenderDock);\r\n        MyIOSelectionStore.off('selection:limit-reached', this.boundLimitReached);\r\n      }\r\n    } catch (e) {\r\n      LogHelper.warn('MyIO Footer: Error during listener cleanup.', e);\r\n    }\r\n\r\n    // Remove o alerta se estiver vis√≠vel\r\n    this.hideLimitAlert();\r\n\r\n    // 2. Remove listeners do DOM interno\r\n    if (this.$compareBtn) {\r\n      this.$compareBtn.removeEventListener('click', this.boundCompareClick);\r\n    }\r\n    if (this.$clearBtn) {\r\n      this.$clearBtn.removeEventListener('click', this.boundClearClick);\r\n    }\r\n    if (this.$dock) {\r\n      this.$dock.removeEventListener('click', this.boundChipClick);\r\n    }\r\n    if (this.$footerEl) {\r\n      this.$footerEl.removeEventListener('dragover', this.boundDragOver);\r\n      this.$footerEl.removeEventListener('drop', this.boundDrop);\r\n    }\r\n\r\n    // 3. Remove listener do evento de mudan√ßa de aba do MENU\r\n    if (this.boundDashboardStateChange) {\r\n      window.removeEventListener('myio:dashboard-state', this.boundDashboardStateChange);\r\n    }\r\n\r\n    // 3. Limpa conte√∫do (mas n√£o remove elementos, pois s√£o do template.html do ThingsBoard)\r\n    if (this.$dock) this.$dock.innerHTML = '';\r\n    if (this.$totals) this.$totals.textContent = '0 selecionados';\r\n\r\n    // 4. Reseta o estado interno\r\n    this.initialized = false;\r\n    this.$root = null;\r\n    this.$footerEl = null;\r\n    this.$dock = null;\r\n    this.$totals = null;\r\n    this.$clearBtn = null;\r\n    this.$compareBtn = null;\r\n  },\r\n};\r\n\r\n// CRITICAL DEBUG: Log immediately to confirm script is loaded\r\nLogHelper.log('[FOOTER] üîµ Script carregado em:', new Date().toISOString());\r\nLogHelper.log('[FOOTER] self object:', typeof self);\r\nLogHelper.log('[FOOTER] self.ctx:', !!self?.ctx);\r\n\r\n// --- 4. Hooks do Ciclo de Vida do Widget ---\r\n\r\nself.onInit = function () {\r\n  LogHelper.log('[FOOTER] üü¢ onInit chamado!');\r\n  LogHelper.log('[FOOTER] self.ctx:', self.ctx);\r\n  LogHelper.log('[FOOTER] self.ctx.$container:', self.ctx?.$container);\r\n  LogHelper.log('[FOOTER] self.ctx.$container[0]:', self.ctx?.$container?.[0]);\r\n  LogHelper.log('[FOOTER] MyIOLibrary dispon√≠vel:', !!window.MyIOLibrary);\r\n  LogHelper.log(\r\n    '[FOOTER] SelectionStore dispon√≠vel:',\r\n    !!(window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore)\r\n  );\r\n\r\n  // Passa o contexto do widget (self.ctx) para o controlador\r\n  try {\r\n    footerController.init(self.ctx);\r\n    LogHelper.log('[FOOTER] ‚úÖ Inicializa√ß√£o completa!');\r\n  } catch (error) {\r\n    console.error('[FOOTER] ‚ùå Erro durante inicializa√ß√£o:', error);\r\n    console.error('[FOOTER] Stack trace:', error.stack);\r\n  }\r\n};\r\n\r\nself.onDestroy = function () {\r\n  footerController.destroy();\r\n};\r\n",
      "settingsSchema": "{}",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - FOOTER - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "6eeec0f0-c976-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}