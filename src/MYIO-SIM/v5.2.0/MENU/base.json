{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_menu_v_5_2_0",
    "name": "Widget Head Office - MENU - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://unpkg.com/myio-js-library@0.1.181/dist/myio-js-library.umd.min.js"
        }
      ],
      "templateHtml": "<section class=\"myio-toolbar-root\">\r\n  <!-- ====== ABA / TABS + FILTRO ====== -->\r\n  <div class=\"myio-tabs-row\">\r\n    <nav class=\"myio-tabs\" role=\"tablist\" aria-label=\"Se√ß√µes\">\r\n      <!-- RFC-0079: Energia button with modal dropdown -->\r\n      <button id=\"energyButton\" class=\"tab is-active\">\r\n        <span class=\"ico\">‚ö°</span>\r\n        <span id=\"energyContextLabel\">Energia: Equipamentos</span>\r\n        <span class=\"dropdown-arrow\">‚ñº</span>\r\n      </button>\r\n      <!-- RFC-0087: Water button with modal dropdown -->\r\n      <button id=\"waterButton\" class=\"tab\">\r\n        <span class=\"ico\">üíß</span>\r\n        <span id=\"waterContextLabel\">√Ågua: Resumo</span>\r\n        <span class=\"dropdown-arrow\">‚ñº</span>\r\n      </button>\r\n      <!-- RFC-0092: Temperature button with modal dropdown -->\r\n      <button id=\"temperatureButton\" class=\"tab\">\r\n        <span class=\"ico\">üå°Ô∏è</span>\r\n        <span id=\"temperatureContextLabel\">Temperatura: Ambientes Climatiz√°veis</span>\r\n        <span class=\"dropdown-arrow\">‚ñº</span>\r\n      </button>\r\n    </nav>\r\n\r\n    <!-- Bot√£o Metas (Goals Panel) -->\r\n    <button id=\"myio-goals-btn\" class=\"tab\" title=\"Configurar metas de consumo de energia e √°gua\">\r\n      <i class=\"material-icons\">flag</i>\r\n      Metas\r\n    </button>\r\n\r\n    <button class=\"myio-filter-btn\" id=\"filterBtn\" type=\"button\" title=\"Filtro\">\r\n      <span class=\"ico\">‚éá</span> Filtro\r\n    </button>\r\n\r\n    <!-- range -->\r\n    <button style=\"min-width: 350px\" class=\"tab\">\r\n      <span class=\"ico\">üìÖ</span>\r\n      <input\r\n        style=\"width: 100%; height: 100%; border: none; cursor: pointer; text-align: center\"\r\n        type=\"text\"\r\n        name=\"startDatetimes\"\r\n        placeholder=\"Digite a data ou per√≠odo\"\r\n        readonly\r\n        title=\"Clique aqui para alterar o intervalo de datas\"\r\n      />\r\n    </button>\r\n\r\n    <button\r\n      id=\"load-button\"\r\n      class=\"tab\"\r\n    >\r\n      <i class=\"material-icons\">refresh</i>\r\n      Carregar\r\n    </button>\r\n\r\n    <!-- Bot√£o Limpar (Force Refresh) -->\r\n    <button\r\n      id=\"myio-clear-btn\"\r\n      class=\"tab\"\r\n      title=\"Limpar cache e recarregar (use se os dados ficarem travados)\"\r\n    >\r\n      <i class=\"material-icons\">delete_sweep</i>\r\n      Limpar\r\n    </button>\r\n  </div>\r\n\r\n  <!-- RFC-0079: Energy context modal dropdown -->\r\n  <div id=\"energyContextModal\" class=\"energy-modal\" style=\"display: none\">\r\n    <div class=\"energy-modal-content\">\r\n      <div class=\"energy-modal-header\">\r\n        <span class=\"ico\">‚ö°</span>\r\n        <span>Selecione o contexto de Energia</span>\r\n      </div>\r\n      <div class=\"energy-modal-options\">\r\n        <button\r\n          class=\"energy-modal-option is-active\"\r\n          data-context=\"equipments\"\r\n          data-target=\"content_equipments\"\r\n        >\r\n          <span class=\"option-ico\">‚öôÔ∏è</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Equipamentos</div>\r\n            <div class=\"option-desc\">Telemetria de equipamentos</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button class=\"energy-modal-option\" data-context=\"stores\" data-target=\"content_store\">\r\n          <span class=\"option-ico\">üè¨</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Lojas</div>\r\n            <div class=\"option-desc\">Telemetria de lojas</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button class=\"energy-modal-option\" data-context=\"general\" data-target=\"content_energy\">\r\n          <span class=\"option-ico\">‚ö°</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Geral (Energia)</div>\r\n            <div class=\"option-desc\">Vis√£o geral de energia</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- RFC-0087: Water context modal dropdown -->\r\n  <div id=\"waterContextModal\" class=\"water-modal\" style=\"display: none\">\r\n    <div class=\"water-modal-content\">\r\n      <div class=\"water-modal-header\">\r\n        <span class=\"ico\">üíß</span>\r\n        <span>Selecione o contexto de √Ågua</span>\r\n      </div>\r\n      <div class=\"water-modal-options\">\r\n        <button\r\n          class=\"water-modal-option\"\r\n          data-context=\"water_common_area\"\r\n          data-target=\"content_water_common_area\"\r\n        >\r\n          <span class=\"option-ico\">üè¢</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">√Årea Comum</div>\r\n            <div class=\"option-desc\">Hidr√¥metros de √°reas comuns</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button class=\"water-modal-option\" data-context=\"water_stores\" data-target=\"content_water_stores\">\r\n          <span class=\"option-ico\">üè¨</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Lojas</div>\r\n            <div class=\"option-desc\">Hidr√¥metros de lojas/lojistas</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button class=\"water-modal-option is-active\" data-context=\"water_summary\" data-target=\"content_water\">\r\n          <span class=\"option-ico\">üìä</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Resumo</div>\r\n            <div class=\"option-desc\">Vis√£o geral de consumo de √°gua</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- RFC-0092: Temperature context modal dropdown -->\r\n  <div id=\"temperatureContextModal\" class=\"temperature-modal\" style=\"display: none\">\r\n    <div class=\"temperature-modal-content\">\r\n      <div class=\"temperature-modal-header\">\r\n        <span class=\"ico\">üå°Ô∏è</span>\r\n        <span>Selecione o contexto de Temperatura</span>\r\n      </div>\r\n      <div class=\"temperature-modal-options\">\r\n        <button\r\n          class=\"temperature-modal-option is-active\"\r\n          data-context=\"temperature_sensors\"\r\n          data-target=\"content_temperature_sensors\"\r\n        >\r\n          <span class=\"option-ico\">‚ùÑÔ∏è</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Sensores em Ambientes Climatiz√°veis</div>\r\n            <div class=\"option-desc\">Sensores em √°reas com ar-condicionado</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button\r\n          class=\"temperature-modal-option\"\r\n          data-context=\"temperature_sensors_external\"\r\n          data-target=\"content_temperature_sensors_external\"\r\n        >\r\n          <span class=\"option-ico\">‚òÄÔ∏è</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Sensores em Ambientes N√£o Climatiz√°veis</div>\r\n            <div class=\"option-desc\">Sensores em √°reas externas ou sem climatiza√ß√£o</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n        <button\r\n          class=\"temperature-modal-option\"\r\n          data-context=\"temperature_comparison\"\r\n          data-target=\"content_temperature\"\r\n        >\r\n          <span class=\"option-ico\">üìä</span>\r\n          <div class=\"option-info\">\r\n            <div class=\"option-title\">Resumo Geral</div>\r\n            <div class=\"option-desc\">Vis√£o geral de temperatura entre shoppings</div>\r\n          </div>\r\n          <span class=\"option-check\">‚úì</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</section>\r\n",
      "templateCss": "/* RFC-0096: Force transparency on ThingsBoard widget containers */\r\n.tb-widget,\r\n.tb-widget-container,\r\n.mat-card,\r\n.mat-mdc-card,\r\n.tb-widget-content,\r\n.tb-absolute-container {\r\n  background: transparent !important;\r\n  background-color: transparent !important;\r\n  box-shadow: none !important;\r\n}\r\n\r\n.myio-toolbar-root {\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow-y: hidden;\r\n  overflow-x: auto;\r\n  padding: 18px;\r\n  box-sizing: border-box;\r\n  background: transparent !important;\r\n  background-color: transparent !important;\r\n}\r\n\r\n.myio-tabs-row {\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  gap: 9px;\r\n  flex-wrap: nowrap; /* mant√©m tudo na mesma linha */\r\n  width: 100%;\r\n  max-width: 1200px;\r\n  margin: 0 auto;\r\n}\r\n\r\n.myio-tabs {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 9px;\r\n  flex-wrap: nowrap;\r\n}\r\n\r\n.tab {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 7px;\r\n  background: #fff;\r\n  color: #1c2743;\r\n  border: 1px solid #e6eef5;\r\n  border-radius: 11px;\r\n  padding: 7px 13px;\r\n  font-size: 0.9rem;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);\r\n  white-space: nowrap;\r\n  flex-shrink: 0;\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.tab:hover {\r\n  background: #f0f4f8;\r\n  border-color: #cbd5e1;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.tab.is-active {\r\n  background: #1d4f91 !important;\r\n  color: #ffffff !important;\r\n  border-color: #1a4278;\r\n  box-shadow: 0 4px 12px rgba(29, 79, 145, 0.25);\r\n  font-weight: 700;\r\n}\r\n\r\n.tab.is-active:hover {\r\n  background: #1a4278 !important;\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.tab .ico {\r\n  opacity: 0.8;\r\n}\r\n\r\n.myio-filter-btn {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 7px;\r\n  border: 1px solid #101828;\r\n  background: #fff;\r\n  border-radius: 11px;\r\n  padding: 7px 13px;\r\n  font-size: 0.9rem;\r\n  font-weight: 700;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);\r\n  white-space: nowrap;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.range-tab {\r\n  min-width: 216px;\r\n  flex: 1 1 auto; /* cresce proporcionalmente */\r\n}\r\n\r\n.range-tab input {\r\n  width: 100%;\r\n  border: none;\r\n  background: transparent;\r\n  text-align: center;\r\n  cursor: pointer;\r\n  font-family: inherit;\r\n  font-size: 0.85rem;\r\n}\r\n\r\n.range-tab input:focus {\r\n  outline: none;\r\n}\r\n\r\n.load-btn {\r\n  color: #fff;\r\n  background-color: #6a1b9a;\r\n  border: none;\r\n  padding: 7px 13px;\r\n  font-size: 0.9rem;\r\n  white-space: nowrap;\r\n  flex-shrink: 0; /* nunca quebra */\r\n}\r\n\r\n.load-btn:hover {\r\n  background-color: #5e35b1;\r\n}\r\n\r\n/* ===== Responsividade ===== */\r\n@media (max-width: 1024px) {\r\n  .myio-tabs-row {\r\n    max-width: 95%;\r\n  }\r\n}\r\n\r\n@media (max-width: 768px) {\r\n  .myio-tabs-row {\r\n    gap: 5px;\r\n  }\r\n\r\n  .range-tab {\r\n    min-width: 162px;\r\n  }\r\n}\r\n\r\n@media (max-width: 500px) {\r\n  .myio-tabs-row {\r\n    overflow-x: auto; /* permite rolagem horizontal */\r\n  }\r\n\r\n  .tab,\r\n  .myio-filter-btn,\r\n  .load-btn {\r\n    flex: 0 0 auto; /* mant√©m tamanho m√≠nimo */\r\n  }\r\n\r\n  .range-tab {\r\n    min-width: 144px;\r\n  }\r\n}\r\n\r\n/* ====== RFC-0079: ENERGY MODAL DROPDOWN ====== */\r\n.dropdown-arrow {\r\n  font-size: 9px;\r\n  margin-left: 4px;\r\n  opacity: 0.7;\r\n  transition: transform 0.2s ease;\r\n}\r\n\r\n#energyButton.modal-open .dropdown-arrow {\r\n  transform: rotate(180deg);\r\n}\r\n\r\n.energy-modal {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  z-index: 999999 !important;\r\n  background: rgba(0, 0, 0, 0.4);\r\n  backdrop-filter: blur(2px);\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.energy-modal.show {\r\n  opacity: 1;\r\n  pointer-events: auto;\r\n}\r\n\r\n.energy-modal-content {\r\n  position: fixed;\r\n  z-index: 1000000 !important;\r\n  background: #ffffff;\r\n  border-radius: 14px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\r\n  min-width: 288px;\r\n  max-width: 360px;\r\n  transform: translateY(-10px);\r\n  transition: transform 0.2s ease;\r\n}\r\n\r\n.energy-modal.show .energy-modal-content {\r\n  transform: translateY(0);\r\n}\r\n\r\n.energy-modal-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 9px;\r\n  padding: 14px 18px;\r\n  border-bottom: 1px solid #e6eef5;\r\n  font-weight: 700;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);\r\n  border-radius: 14px 14px 0 0;\r\n}\r\n\r\n.energy-modal-header .ico {\r\n  font-size: 18px;\r\n}\r\n\r\n.energy-modal-options {\r\n  padding: 7px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n\r\n.energy-modal-option {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 11px;\r\n  padding: 11px 14px;\r\n  border: 2px solid transparent;\r\n  border-radius: 11px;\r\n  background: transparent;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  text-align: left;\r\n}\r\n\r\n.energy-modal-option:hover {\r\n  background: #f8fafc;\r\n  border-color: #cbd5e1;\r\n}\r\n\r\n.energy-modal-option.is-active {\r\n  background: #eff6ff;\r\n  border-color: #1d4f91;\r\n}\r\n\r\n.energy-modal-option .option-ico {\r\n  font-size: 22px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.energy-modal-option .option-info {\r\n  flex: 1;\r\n}\r\n\r\n.energy-modal-option .option-title {\r\n  font-weight: 600;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  margin-bottom: 2px;\r\n}\r\n\r\n.energy-modal-option .option-desc {\r\n  font-size: 11px;\r\n  color: #64748b;\r\n}\r\n\r\n.energy-modal-option .option-check {\r\n  font-size: 16px;\r\n  color: #1d4f91;\r\n  opacity: 0;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.energy-modal-option.is-active .option-check {\r\n  opacity: 1;\r\n}\r\n\r\n/* ====== RFC-0087: WATER MODAL DROPDOWN ====== */\r\n.water-modal {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  z-index: 999999 !important;\r\n  background: rgba(0, 0, 0, 0.4);\r\n  backdrop-filter: blur(2px);\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.water-modal.show {\r\n  opacity: 1;\r\n  pointer-events: auto;\r\n}\r\n\r\n.water-modal-content {\r\n  position: fixed;\r\n  z-index: 1000000 !important;\r\n  background: #ffffff;\r\n  border-radius: 14px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\r\n  min-width: 288px;\r\n  max-width: 360px;\r\n  transform: translateY(-10px);\r\n  transition: transform 0.2s ease;\r\n}\r\n\r\n.water-modal.show .water-modal-content {\r\n  transform: translateY(0);\r\n}\r\n\r\n.water-modal-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 9px;\r\n  padding: 14px 18px;\r\n  border-bottom: 1px solid #e6eef5;\r\n  font-weight: 700;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);\r\n  border-radius: 14px 14px 0 0;\r\n}\r\n\r\n.water-modal-header .ico {\r\n  font-size: 18px;\r\n}\r\n\r\n.water-modal-options {\r\n  padding: 7px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n\r\n.water-modal-option {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 11px;\r\n  padding: 11px 14px;\r\n  border: 2px solid transparent;\r\n  border-radius: 11px;\r\n  background: transparent;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  text-align: left;\r\n}\r\n\r\n.water-modal-option:hover {\r\n  background: #e3f2fd;\r\n  border-color: #90caf9;\r\n}\r\n\r\n.water-modal-option.is-active {\r\n  background: #e3f2fd;\r\n  border-color: #1976d2;\r\n}\r\n\r\n.water-modal-option .option-ico {\r\n  font-size: 22px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.water-modal-option .option-info {\r\n  flex: 1;\r\n}\r\n\r\n.water-modal-option .option-title {\r\n  font-weight: 600;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  margin-bottom: 2px;\r\n}\r\n\r\n.water-modal-option .option-desc {\r\n  font-size: 11px;\r\n  color: #64748b;\r\n}\r\n\r\n.water-modal-option .option-check {\r\n  font-size: 16px;\r\n  color: #1976d2;\r\n  opacity: 0;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.water-modal-option.is-active .option-check {\r\n  opacity: 1;\r\n}\r\n\r\n/* ====== RFC-0092: TEMPERATURE MODAL DROPDOWN ====== */\r\n.temperature-modal {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  z-index: 999999 !important;\r\n  background: rgba(0, 0, 0, 0.4);\r\n  backdrop-filter: blur(2px);\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.temperature-modal.show {\r\n  opacity: 1;\r\n  pointer-events: auto;\r\n}\r\n\r\n.temperature-modal-content {\r\n  position: fixed;\r\n  z-index: 1000000 !important;\r\n  background: #ffffff;\r\n  border-radius: 14px;\r\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);\r\n  min-width: 288px;\r\n  max-width: 360px;\r\n  transform: translateY(-10px);\r\n  transition: transform 0.2s ease;\r\n}\r\n\r\n.temperature-modal.show .temperature-modal-content {\r\n  transform: translateY(0);\r\n}\r\n\r\n.temperature-modal-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 9px;\r\n  padding: 14px 18px;\r\n  border-bottom: 1px solid #ffe0b2;\r\n  font-weight: 700;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);\r\n  border-radius: 14px 14px 0 0;\r\n}\r\n\r\n.temperature-modal-header .ico {\r\n  font-size: 18px;\r\n}\r\n\r\n.temperature-modal-options {\r\n  padding: 7px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n\r\n.temperature-modal-option {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 11px;\r\n  padding: 11px 14px;\r\n  border: 2px solid transparent;\r\n  border-radius: 11px;\r\n  background: transparent;\r\n  cursor: pointer;\r\n  transition: all 0.2s ease;\r\n  text-align: left;\r\n}\r\n\r\n.temperature-modal-option:hover {\r\n  background: #fff3e0;\r\n  border-color: #ffcc80;\r\n}\r\n\r\n.temperature-modal-option.is-active {\r\n  background: #fff3e0;\r\n  border-color: #e65100;\r\n}\r\n\r\n.temperature-modal-option .option-ico {\r\n  font-size: 22px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.temperature-modal-option .option-info {\r\n  flex: 1;\r\n}\r\n\r\n.temperature-modal-option .option-title {\r\n  font-weight: 600;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  margin-bottom: 2px;\r\n}\r\n\r\n.temperature-modal-option .option-desc {\r\n  font-size: 11px;\r\n  color: #64748b;\r\n}\r\n\r\n.temperature-modal-option .option-check {\r\n  font-size: 16px;\r\n  color: #e65100;\r\n  opacity: 0;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.temperature-modal-option.is-active .option-check {\r\n  opacity: 1;\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary */\r\n/***********************************\r\n *  MENU PREMIUM + FILTRO MODAL    *\r\n ***********************************/\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log(...args),\r\n  warn: (...args) => console.warn(...args),\r\n  error: (...args) => console.error(...args),\r\n};\r\n\r\nconst EVT_SWITCH = 'myio:switch-main-state';\r\n\r\nlet _dataRefreshCount = 0;\r\nconst MAX_DATA_REFRESHES = 1;\r\n\r\nfunction publishSwitch(targetStateId) {\r\n  const detail = { targetStateId, source: 'menu', ts: Date.now() };\r\n  window.dispatchEvent(new CustomEvent(EVT_SWITCH, { detail }));\r\n  // LogHelper.log(\"[menu] switch ->\", detail);\r\n}\r\n\r\nfunction setActiveTab(btn, root) {\r\n  root.querySelectorAll('.tab.is-active').forEach((b) => b.classList.remove('is-active'));\r\n  btn.classList.add('is-active');\r\n}\r\n\r\nfunction computeCustomersFromCtx() {\r\n  const map = new Map();\r\n  (self.ctx.data || []).forEach((d) => {\r\n    if (d?.datasource?.aliasName === 'Shopping') {\r\n      const name = (d.datasource.entityLabel || '').trim();\r\n      const value = d.data?.[0]?.[1]; // This is the ingestionId\r\n      const customerId = d.datasource.entityId;\r\n      // RFC-0096: Add ingestionId explicitly for clarity (same as value)\r\n      if (name && value && name !== value && !map.has(value)) {\r\n        map.set(value, { name, value, customerId, ingestionId: value });\r\n      }\r\n    }\r\n  });\r\n  const arr = Array.from(map.values());\r\n  self.ctx.$scope.custumer = arr;\r\n\r\n  // --- L√ìGICA NOVA: SELECIONAR TODOS AO INICIAR ---\r\n  // Verifica se 'window.custumersSelected' √© undefined (significa que √© a primeira carga do sistema)\r\n  if (typeof window.custumersSelected === 'undefined' && arr.length > 0) {\r\n    LogHelper.log('[MENU] üöÄ Inicializando sistema: Selecionando TODOS os shoppings por padr√£o.');\r\n\r\n    // 1. Define a sele√ß√£o global como o array completo (arr)\r\n    window.custumersSelected = arr.slice();\r\n\r\n    // 2. Atualiza o contexto do widget para consist√™ncia\r\n    self.ctx.filterCustom = window.custumersSelected;\r\n\r\n    // 3. Dispara o evento IMEDIATAMENTE para que outros widgets (Energy, Water, etc) saibam que devem carregar tudo\r\n    // Usamos um pequeno timeout para garantir que os ouvintes dos outros widgets j√° estejam registrados\r\n    setTimeout(() => {\r\n      const eventDetail = {\r\n        selection: window.custumersSelected,\r\n        ts: Date.now(),\r\n      };\r\n      window.dispatchEvent(\r\n        new CustomEvent('myio:filter-applied', {\r\n          detail: eventDetail,\r\n        })\r\n      );\r\n      LogHelper.log('[MENU] üì° Evento inicial de filtro (Todos) disparado.');\r\n    }, 500);\r\n  }\r\n  // -------------------------------------------------\r\n\r\n  // marca pronto e notifica interessados\r\n  window.__customersReady = arr.length > 0;\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:customers-ready', {\r\n      detail: {\r\n        count: arr.length,\r\n        customers: arr, // Include full customer data\r\n      },\r\n    })\r\n  );\r\n  // LogHelper.log(\"[MENU] ‚úÖ Dispatched myio:customers-ready with\", arr.length, \"customers\");\r\n  return arr;\r\n}\r\n\r\nfunction bindTabs(root) {\r\n  if (root._tabsBound) return;\r\n\r\n  root._tabsBound = true;\r\n\r\n  root.addEventListener('click', (ev) => {\r\n    const tab = ev.target.closest?.('.tab');\r\n\r\n    if (tab && root.contains(tab)) {\r\n      const target = tab.getAttribute('data-target');\r\n\r\n      if (target) {\r\n        setActiveTab(tab, root);\r\n        publishSwitch(target);\r\n      }\r\n    }\r\n  });\r\n\r\n  const initial = root.querySelector('.tab.is-active') || root.querySelector('.tab');\r\n\r\n  if (initial) {\r\n    publishSwitch(initial.getAttribute('data-target'));\r\n  }\r\n}\r\n\r\n/* Substitua a fun√ß√£o injectModalGlobal existente (aprox. linha 110) */\r\nfunction injectModalGlobal() {\r\n  // Fonte de dados simplificada: usa o escopo dos customers\r\n  function getCustomers() {\r\n    return self.ctx.$scope.custumer || [];\r\n  }\r\n\r\n  // As sele√ß√µes agora focam apenas nos customers (shoppings)\r\n  // Inicializa a sele√ß√£o se ainda n√£o existir\r\n  if (!window.custumersSelected) {\r\n    window.custumersSelected = getCustomers().slice();\r\n  }\r\n\r\n  // Fun√ß√µes de utilidade\r\n  function renderCount() {\r\n    const c = (window.custumersSelected || []).length;\r\n    // Atualiza o contexto (necess√°rio para o filtro ser aplicado)\r\n    self.ctx.filterCustom = window.custumersSelected;\r\n    elCount.textContent = `${c} selecionado${c === 1 ? '' : 's'}`;\r\n  }\r\n\r\n  function updateClearButtonState() {\r\n    const hasCustomers = (window.custumersSelected || []).length > 0;\r\n    if (elClear) {\r\n      elClear.disabled = !hasCustomers;\r\n    }\r\n  }\r\n\r\n  // ==== Constru√ß√£o do container (uma √∫nica vez) =============================\r\n  let container = document.getElementById('modalGlobal');\r\n  if (!container) {\r\n    container = document.createElement('div');\r\n    container.id = 'modalGlobal';\r\n    container.innerHTML = `\r\n        <style>\r\n          .myio-modal {\r\n            position: fixed; inset: 0; display: flex; justify-content: center; align-items: center;\r\n            background: rgba(0,0,0,0.5); z-index: 9999; opacity: 0; pointer-events: none; transition: opacity .2s;\r\n          }\r\n          .custumers {\r\n            display: flex; align-items: center; gap: 10px; border: 1px solid #d9d9d9;\r\n            border-radius: 8px; padding: 6px 10px; margin-bottom: 6px; background: transparent;\r\n            font-weight: 600; color: #344054; cursor: pointer; transition: background 0.2s; width: 100%;\r\n          }\r\n          .custumers:hover { background: #f2f2f2; }\r\n          .custumers .checkbox {\r\n            width: 16px; height: 16px; border: 1px solid #344054; border-radius: 3px;\r\n            flex-shrink: 0; background-color: transparent; display: flex; align-items: center;\r\n            justify-content: center;\r\n          }\r\n          .custumers.selected .checkbox { background-color: #1D4F91; }\r\n          .myio-modal[aria-hidden=\"false\"] { opacity: 1; pointer-events: auto; }\r\n          .myio-modal-card {\r\n            background: #fff; border-radius: 12px; max-width: 600px; width: 92%;\r\n            max-height: 86vh; display:flex; flex-direction:column; box-shadow: 0 4px 16px rgba(0,0,0,.28);\r\n          }\r\n          .myio-modal-hd, .myio-modal-ft { padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; }\r\n          .myio-modal-hd { border-bottom:1px solid #E6EEF5; }\r\n          .myio-modal-ft { border-top:1px solid #E6EEF5; gap: 8px; }\r\n          .myio-modal-body { padding: 14px 16px; display:flex; flex-direction:column; gap: 12px; overflow: hidden; }\r\n\r\n          .close-x { cursor:pointer; border:0; background:transparent; font-size:20px; line-height:1; }\r\n          .flt-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }\r\n          .flt-search{ position:relative; display:flex; align-items:center; gap:8px; flex:1; border:2px solid #BBD0E3; border-radius:12px; padding:6px 10px; }\r\n          .flt-search:focus-within{ border-color:#4F93CE; box-shadow: 0 0 0 3px rgba(79,147,206,.15); }\r\n          .flt-search input{ width:100%; border:0; outline:0; font-size:15px; padding-left:20px; }\r\n          .flt-search .search-ico{ position:absolute; left:10px; }\r\n\r\n          .link-btn{ border:0; background:transparent; font-weight:600; cursor:pointer; color:#344054; }\r\n          .apply-btn{ border:0; background:#1D4F91; color:#fff; font-weight:700; padding:10px 16px; border-radius:10px; cursor:pointer; }\r\n          \r\n          .chips { display:flex; flex-wrap:wrap; gap:8px; }\r\n          .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #CFDCE8; border-radius:999px; padding:4px 10px; font-size:12px; }\r\n          .chip .rm { cursor:pointer; border:0; background:transparent; opacity:.7; }\r\n\r\n          .flt-content { display:flex; gap:12px; overflow:hidden; }\r\n          .flt-list { flex: 1 1 auto; overflow-y:auto; max-height: 46vh; padding-right:4px; display:flex; flex-direction:column; gap:6px; }\r\n\r\n          .badge { border:1px solid #CFDCE8; border-radius:999px; padding:2px 8px; font-size:11px; color:#334155; }\r\n\r\n          /* ===== Bot√£o de recarregar CUSTOM ===== */\r\n          .myio-reload-btn {\r\n              background: #1D4F91;\r\n              color: #fff;\r\n              border: 0;\r\n              padding: 8px 16px;\r\n              border-radius: 8px;\r\n              cursor: pointer;\r\n              margin-top: 10px;\r\n              font-weight: 600;\r\n              display: inline-flex;\r\n              align-items: center;\r\n              gap: 8px;\r\n          }\r\n          .myio-reload-btn:hover { opacity: 0.9; }\r\n          /* ===== REMOVIDO: STYLES DE PRESETS E LIMPAR (myio-clear-btn) ===== */\r\n\r\n        </style>\r\n\r\n        <div class=\"myio-modal\" id=\"filterModal\" role=\"dialog\" aria-modal=\"true\" aria-hidden=\"true\" aria-labelledby=\"fltTitle\">\r\n          <div class=\"myio-modal-backdrop\" data-close=\"true\"></div>\r\n          <div class=\"myio-modal-card\">\r\n            <header class=\"myio-modal-hd\">\r\n              <h3 id=\"fltTitle\">Filtro de Shoppings</h3>\r\n              <button class=\"close-x\" data-close=\"true\" aria-label=\"Fechar\">√ó</button>\r\n            </header>\r\n\r\n            <div class=\"myio-modal-body\">\r\n              <div class=\"flt-row\">\r\n                <div class=\"flt-search\">\r\n                  <span class=\"search-ico\">üîé</span>\r\n                  <input id=\"fltSearch\" type=\"text\" placeholder=\"Buscar shopping‚Ä¶\" autocomplete=\"off\">\r\n                </div>\r\n                <button class=\"link-btn\" id=\"fltClear\" title=\"Limpar sele√ß√£o\">Limpar</button>\r\n                <span id=\"fltCount\" class=\"badge\" title=\"Total de sele√ß√µes\">0 selecionados</span>\r\n              </div>\r\n\r\n              <div id=\"fltChips\" class=\"chips\"></div>\r\n\r\n              <div class=\"flt-content\">\r\n                <div class=\"flt-list\" id=\"fltList\" role=\"listbox\" aria-label=\"Lista de shoppings\"></div>\r\n\r\n                </div>\r\n            </div>\r\n\r\n            <footer class=\"myio-modal-ft\">\r\n              <div style=\"flex:1; color:#6b7280; font-size:12px;\">\r\n                Selecione os shoppings para aplicar o filtro.\r\n              </div>\r\n              <button class=\"link-btn\" data-close=\"true\">Cancelar</button>\r\n              <button class=\"apply-btn\" id=\"fltApply\">Aplicar filtro</button>\r\n            </footer>\r\n          </div>\r\n        </div>\r\n      `;\r\n    document.body.appendChild(container);\r\n\r\n    // listeners globais de fechar\r\n    container.querySelectorAll('[data-close]').forEach((btn) => {\r\n      btn.addEventListener('click', () => {\r\n        container.querySelector('.myio-modal').setAttribute('aria-hidden', 'true');\r\n      });\r\n    });\r\n  }\r\n\r\n  // ==== Refer√™ncias do DOM ==================================================\r\n  const modal = container.querySelector('.myio-modal');\r\n  const elSearch = container.querySelector('#fltSearch');\r\n  const elList = container.querySelector('#fltList');\r\n  const elClear = container.querySelector('#fltClear');\r\n  const elApply = container.querySelector('#fltApply');\r\n  const elChips = container.querySelector('#fltChips');\r\n  const elCount = container.querySelector('#fltCount');\r\n\r\n  // O listener myio:customers-ready precisa ser global para reagir ao onDataUpdated\r\n  if (!window.__customersReadyListenerBound) {\r\n    window.__customersReadyListenerBound = true;\r\n    window.addEventListener('myio:customers-ready', () => {\r\n      const modal = document.getElementById('filterModal');\r\n      if (modal && modal.getAttribute('aria-hidden') === 'false') {\r\n        // Se o modal estiver aberto, atualiza a lista\r\n        renderAll();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Sincroniza a sele√ß√£o inicial com o filterCustom do contexto\r\n  if (Array.isArray(self.ctx.$scope.custumer) && self.ctx.$scope.custumer.length > 0) {\r\n    if (Array.isArray(self.ctx.filterCustom)) {\r\n      // Se j√° houver filtro aplicado, usa ele como sele√ß√£o inicial\r\n      window.custumersSelected = self.ctx.filterCustom.slice();\r\n    } else {\r\n      // Caso contr√°rio, seleciona todos\r\n      window.custumersSelected = self.ctx.$scope.custumer.slice();\r\n    }\r\n    renderAll();\r\n  } else {\r\n    renderAll();\r\n  }\r\n\r\n  // ==== Render helpers ======================================================\r\n  function renderChips() {\r\n    elChips.innerHTML = '';\r\n    const customers = window.custumersSelected || [];\r\n\r\n    for (const customer of customers) {\r\n      const chip = document.createElement('span');\r\n      chip.className = 'chip';\r\n      chip.innerHTML = `\r\n        <span>${customer.name}</span>\r\n        <button class=\"rm\" title=\"Remover\" aria-label=\"Remover sele√ß√£o\">√ó</button>\r\n      `;\r\n      chip.querySelector('.rm').addEventListener('click', () => {\r\n        // Remove este customer da sele√ß√£o\r\n        window.custumersSelected = window.custumersSelected.filter((c) => c.value !== customer.value);\r\n        self.ctx.filterCustom = window.custumersSelected;\r\n        renderAll();\r\n      });\r\n      elChips.appendChild(chip);\r\n    }\r\n  }\r\n\r\n  function renderTree() {\r\n    const q = (window.myioFilterQuery || '').toLowerCase();\r\n    elList.innerHTML = '';\r\n\r\n    // Pega somente customers v√°lidos e filtra pela busca\r\n    const customers = getCustomers()\r\n      .filter(({ name, value }) => name && value && name.trim() !== value.trim())\r\n      .filter((c) => !q || c.name.toLowerCase().includes(q) || c.value.toLowerCase().includes(q));\r\n\r\n    if (!customers.length) {\r\n      LogHelper.warn('[MENU] ‚ö†Ô∏è No customers to display!');\r\n\r\n      // Container para a mensagem e o bot√£o\r\n      const emptyContainer = document.createElement('div');\r\n      emptyContainer.style.textAlign = 'center';\r\n      emptyContainer.style.padding = '20px';\r\n      emptyContainer.innerHTML = `\r\n                <div style=\"color: #6b7280; font-size: 14px; margin-bottom: 15px;\">\r\n                    Nenhum shopping dispon√≠vel.\r\n                </div>\r\n                <button class=\"myio-reload-btn\">\r\n                    <span style=\"font-size: 1.2em; line-height: 1;\">üîÑ</span> Tentar Recarregar\r\n                </button>\r\n            `;\r\n      elList.appendChild(emptyContainer);\r\n\r\n      // Adiciona a l√≥gica de clique no bot√£o de recarregar\r\n      const reloadBtn = emptyContainer.querySelector('.myio-reload-btn');\r\n      reloadBtn.addEventListener('click', () => {\r\n        LogHelper.log('[MENU] üîÉ Tentando recarregar customers do context...');\r\n\r\n        // 1. Tenta buscar os customers do context novamente\r\n        const reloadedCustomers = computeCustomersFromCtx();\r\n\r\n        // 2. Tenta re-renderizar o modal com os novos dados\r\n        if (reloadedCustomers.length > 0) {\r\n          // Seta a sele√ß√£o inicial para todos os recarregados\r\n          window.custumersSelected = reloadedCustomers.slice();\r\n          renderAll();\r\n          LogHelper.log('[MENU] ‚úÖ Clientes recarregados e lista atualizada.');\r\n        } else {\r\n          window.alert('N√£o foi poss√≠vel carregar shoppings. Verifique a fonte de dados e tente novamente.');\r\n          LogHelper.warn('[MENU] ‚ùå Tentativa de recarga n√£o trouxe clientes.');\r\n        }\r\n      });\r\n\r\n      return;\r\n    }\r\n\r\n    // Se houver shoppings, continua a renderiza√ß√£o normal...\r\n    const selectedSet = new Set(window.custumersSelected.map((x) => x.value));\r\n\r\n    customers.forEach((c) => {\r\n      const item = document.createElement('button');\r\n      item.className = 'custumers';\r\n      item.custumerData = c;\r\n\r\n      const box = document.createElement('div');\r\n      box.className = 'checkbox';\r\n      box.innerHTML = selectedSet.has(c.value) ? '‚úì' : ''; // Exibe o checkmark\r\n      item.appendChild(box);\r\n\r\n      const text = document.createElement('span');\r\n      text.textContent = c.name;\r\n      item.appendChild(text);\r\n\r\n      if (selectedSet.has(c.value)) item.classList.add('selected');\r\n\r\n      item.addEventListener('click', () => {\r\n        if (item.classList.toggle('selected')) {\r\n          selectedSet.add(c.value);\r\n          box.innerHTML = '‚úì'; // Adiciona o checkmark\r\n        } else {\r\n          selectedSet.delete(c.value);\r\n          box.innerHTML = ''; // Remove o checkmark\r\n        }\r\n        window.custumersSelected = customers.filter((x) => selectedSet.has(x.value));\r\n        self.ctx.filterCustom = window.custumersSelected;\r\n        renderAll(); // Re-renderiza tudo para atualizar contagem e chips\r\n      });\r\n\r\n      elList.appendChild(item);\r\n    });\r\n  }\r\n\r\n  function renderAll() {\r\n    renderCount();\r\n    renderChips();\r\n    renderTree();\r\n    updateClearButtonState();\r\n  }\r\n\r\n  // ==== Bind de eventos de UI ==============================================\r\n  if (!elSearch._bound) {\r\n    elSearch._bound = true;\r\n    elSearch.addEventListener('input', (e) => {\r\n      window.myioFilterQuery = e.target.value || '';\r\n      renderTree();\r\n    });\r\n  }\r\n\r\n  if (!elClear._bound) {\r\n    elClear._bound = true;\r\n    elClear.addEventListener('click', () => {\r\n      // Limpa sele√ß√£o e a query de busca\r\n      window.custumersSelected = [];\r\n      window.myioFilterQuery = '';\r\n      elSearch.value = '';\r\n\r\n      // Limpa sele√ß√£o visual dos customers\r\n      document.querySelectorAll('.custumers.selected').forEach((item) => {\r\n        item.classList.remove('selected');\r\n        item.querySelector('.checkbox').innerHTML = '';\r\n      });\r\n\r\n      renderAll();\r\n      LogHelper.log('[MENU FILTER] Sele√ß√£o limpa completamente');\r\n    });\r\n  }\r\n\r\n  // Removido o bind para elSave (Salvar Preset)\r\n\r\n  if (!elApply._bound) {\r\n    elApply._bound = true;\r\n    elApply.addEventListener('click', async () => {\r\n      LogHelper.log('[MENU] üî• APPLY FILTER BUTTON CLICKED');\r\n      elApply.disabled = true;\r\n\r\n      // Prepara payload do evento\r\n      const eventDetail = {\r\n        selection: window.custumersSelected || [],\r\n        ts: Date.now(),\r\n      };\r\n\r\n      // Dispara evento com os custumers selecionados\r\n      window.dispatchEvent(\r\n        new CustomEvent('myio:filter-applied', {\r\n          detail: eventDetail,\r\n        })\r\n      );\r\n\r\n      LogHelper.log(\r\n        '[MENU] ‚úÖ Event dispatched successfully with',\r\n        eventDetail.selection.length,\r\n        'customers.'\r\n      );\r\n\r\n      // Reabilita bot√£o e Fecha modal\r\n      elApply.disabled = false;\r\n      modal.setAttribute('aria-hidden', 'true');\r\n    });\r\n  }\r\n\r\n  // ==== Abrir modal e sincronizar estado visual ============================\r\n  modal.setAttribute('aria-hidden', 'false');\r\n\r\n  // rep√µe valor de busca persistido em mem√≥ria\r\n  if (elSearch.value !== (window.myioFilterQuery || '')) {\r\n    elSearch.value = window.myioFilterQuery || '';\r\n  }\r\n\r\n  renderAll();\r\n  setTimeout(() => elSearch?.focus(), 0);\r\n}\r\n\r\nfunction bindFilter(root) {\r\n  if (root._filterBound) return;\r\n  root._filterBound = true;\r\n  const modal = document.getElementById('filterModal');\r\n  if (!modal) return;\r\n\r\n  modal.querySelectorAll('[data-close]').forEach((btn) => {\r\n    btn.addEventListener('click', () => modal.setAttribute('aria-hidden', 'true'));\r\n  });\r\n}\r\n\r\nfunction formatDiaMes(date) {\r\n  const dia = String(date.getDate()).padStart(2, '0'); // garante 2 d√≠gitos\r\n  const mes = String(date.getMonth() + 1).padStart(2, '0'); // meses come√ßam em 0\r\n  return `${dia}/${mes}`;\r\n}\r\n\r\n/* ====== Lifecycle ====== */\r\nself.onInit = async function ({ strt: presetStart, end: presetEnd } = {}) {\r\n  // ==============================================================\r\n  // INJETAR CSS GLOBAL PARA O MODAL (Restaura a beleza)\r\n  // Coloque isso no topo do self.onInit\r\n  // ==============================================================\r\n  if (!document.getElementById('myio-energy-modal-styles')) {\r\n    const style = document.createElement('style');\r\n    style.id = 'myio-energy-modal-styles';\r\n    style.innerHTML = `\r\n            /* Container Fundo Escuro */\r\n            #energyContextModal {\r\n                font-family: 'Roboto', 'Segoe UI', sans-serif;\r\n                backdrop-filter: blur(4px);\r\n            }\r\n\r\n            /* O Cart√£o Branco */\r\n            #energyContextModal .energy-modal-content {\r\n                background: #ffffff !important;\r\n                border-radius: 16px !important;\r\n                box-shadow: 0 20px 50px rgba(0,0,0,0.3) !important;\r\n                width: 320px !important;\r\n                max-width: 90vw !important;\r\n                overflow: hidden !important;\r\n                border: none !important;\r\n                padding: 0 !important;\r\n                display: flex !important;\r\n                flex-direction: column !important;\r\n            }\r\n\r\n            /* Cabe√ßalho */\r\n            .energy-modal-header {\r\n                padding: 16px 20px !important;\r\n                background: #f8fafc;\r\n                border-bottom: 1px solid #e2e8f0;\r\n                font-weight: 700;\r\n                color: #1e293b;\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 10px;\r\n                font-size: 16px;\r\n            }\r\n\r\n            /* Lista de Op√ß√µes (Isso corrige o layout horizontal quebrado) */\r\n            .energy-modal-options {\r\n                padding: 10px !important;\r\n                display: flex !important;\r\n                flex-direction: column !important; /* For√ßa lista vertical */\r\n                gap: 8px !important;\r\n            }\r\n\r\n            /* Cada Bot√£o de Op√ß√£o */\r\n            .energy-modal-option {\r\n                display: flex !important;\r\n                align-items: center !important;\r\n                gap: 12px !important;\r\n                padding: 12px 16px !important;\r\n                border: 1px solid transparent !important;\r\n                border-radius: 12px !important;\r\n                background: transparent !important;\r\n                cursor: pointer !important;\r\n                transition: all 0.2s ease !important;\r\n                text-align: left !important;\r\n                color: #334155 !important;\r\n                width: 100% !important;\r\n                box-sizing: border-box !important;\r\n            }\r\n\r\n            /* Hover (Passar o mouse) */\r\n            .energy-modal-option:hover {\r\n                background: #f1f5f9 !important;\r\n                border-color: #cbd5e1 !important;\r\n            }\r\n\r\n            /* Ativo (Selecionado) */\r\n            .energy-modal-option.is-active {\r\n                background: #eff6ff !important;\r\n                border-color: #3b82f6 !important;\r\n                color: #1d4ed8 !important;\r\n            }\r\n\r\n            /* √çcones e Textos Internos */\r\n            .option-ico { font-size: 20px; }\r\n            .option-info { flex: 1; display: flex; flex-direction: column; }\r\n            .option-title { font-weight: 600; font-size: 14px; line-height: 1.2; }\r\n            .option-desc { font-size: 12px; color: #64748b; margin-top: 2px; font-weight: 400; }\r\n            \r\n            /* Checkmark */\r\n            .option-check {\r\n                font-weight: bold;\r\n                opacity: 0;\r\n                transform: scale(0.5);\r\n                transition: all 0.2s;\r\n                color: #3b82f6;\r\n            }\r\n            .energy-modal-option.is-active .option-check {\r\n                opacity: 1;\r\n                transform: scale(1);\r\n            }\r\n\r\n            /* RFC-0087: Water Modal Styles */\r\n            #waterContextModal {\r\n                font-family: 'Roboto', 'Segoe UI', sans-serif;\r\n                backdrop-filter: blur(4px);\r\n            }\r\n\r\n            #waterContextModal .water-modal-content {\r\n                background: #ffffff !important;\r\n                border-radius: 16px !important;\r\n                box-shadow: 0 20px 50px rgba(0,0,0,0.3) !important;\r\n                width: 320px !important;\r\n                max-width: 90vw !important;\r\n                overflow: hidden !important;\r\n                border: none !important;\r\n                padding: 0 !important;\r\n                display: flex !important;\r\n                flex-direction: column !important;\r\n            }\r\n\r\n            .water-modal-header {\r\n                padding: 16px 20px !important;\r\n                background: #f0f9ff;\r\n                border-bottom: 1px solid #bae6fd;\r\n                font-weight: 700;\r\n                color: #0c4a6e;\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 10px;\r\n                font-size: 16px;\r\n            }\r\n\r\n            .water-modal-options {\r\n                padding: 10px !important;\r\n                display: flex !important;\r\n                flex-direction: column !important;\r\n                gap: 8px !important;\r\n            }\r\n\r\n            .water-modal-option {\r\n                display: flex !important;\r\n                align-items: center !important;\r\n                gap: 12px !important;\r\n                padding: 12px 16px !important;\r\n                border: 1px solid transparent !important;\r\n                border-radius: 12px !important;\r\n                background: transparent !important;\r\n                cursor: pointer !important;\r\n                transition: all 0.2s ease !important;\r\n                text-align: left !important;\r\n                color: #334155 !important;\r\n                width: 100% !important;\r\n                box-sizing: border-box !important;\r\n            }\r\n\r\n            .water-modal-option:hover {\r\n                background: #f0f9ff !important;\r\n                border-color: #7dd3fc !important;\r\n            }\r\n\r\n            .water-modal-option.is-active {\r\n                background: #e0f2fe !important;\r\n                border-color: #0288d1 !important;\r\n                color: #0369a1 !important;\r\n            }\r\n\r\n            .water-modal-option .option-check {\r\n                color: #0288d1;\r\n            }\r\n\r\n            /* RFC-0092: Temperature Modal Styles */\r\n            #temperatureContextModal {\r\n                font-family: 'Roboto', 'Segoe UI', sans-serif;\r\n                backdrop-filter: blur(4px);\r\n            }\r\n\r\n            #temperatureContextModal .temperature-modal-content {\r\n                background: #ffffff !important;\r\n                border-radius: 16px !important;\r\n                box-shadow: 0 20px 50px rgba(0,0,0,0.3) !important;\r\n                width: 320px !important;\r\n                max-width: 90vw !important;\r\n                overflow: hidden !important;\r\n                border: none !important;\r\n                padding: 0 !important;\r\n                display: flex !important;\r\n                flex-direction: column !important;\r\n            }\r\n\r\n            .temperature-modal-header {\r\n                padding: 16px 20px !important;\r\n                background: #fff7ed;\r\n                border-bottom: 1px solid #fed7aa;\r\n                font-weight: 700;\r\n                color: #9a3412;\r\n                display: flex;\r\n                align-items: center;\r\n                gap: 10px;\r\n                font-size: 16px;\r\n            }\r\n\r\n            .temperature-modal-options {\r\n                padding: 10px !important;\r\n                display: flex !important;\r\n                flex-direction: column !important;\r\n                gap: 8px !important;\r\n            }\r\n\r\n            .temperature-modal-option {\r\n                display: flex !important;\r\n                align-items: center !important;\r\n                gap: 12px !important;\r\n                padding: 12px 16px !important;\r\n                border: 1px solid transparent !important;\r\n                border-radius: 12px !important;\r\n                background: transparent !important;\r\n                cursor: pointer !important;\r\n                transition: all 0.2s ease !important;\r\n                text-align: left !important;\r\n                color: #334155 !important;\r\n                width: 100% !important;\r\n                box-sizing: border-box !important;\r\n            }\r\n\r\n            .temperature-modal-option:hover {\r\n                background: #fff7ed !important;\r\n                border-color: #fdba74 !important;\r\n            }\r\n\r\n            .temperature-modal-option.is-active {\r\n                background: #ffedd5 !important;\r\n                border-color: #ea580c !important;\r\n                color: #c2410c !important;\r\n            }\r\n\r\n            .temperature-modal-option .option-check {\r\n                color: #ea580c;\r\n            }\r\n        `;\r\n    document.head.appendChild(style);\r\n    LogHelper.log('[SETUP] CSS Global do Modal injetado com sucesso.');\r\n  }\r\n\r\n  // Mapeamento dos bot√µes ‚Üí estados\r\n  const dashboards = {\r\n    equipmentsButton: {\r\n      stateId: 'content_equipments',\r\n      state: 'W3siaWQiOiJjb250ZW50X2VxdWlwbWVudHMiLCJwYXJhbXMiOnt9fV0%253D',\r\n    },\r\n    // energyButton: {\r\n    //   stateId: \"content_energy\",\r\n    //   state: \"W3siaWQiOiJjb250ZW50X2VuZXJneSIsInBhcmFtcyI6e319XQ%253D%253D\",\r\n    // },\r\n    // RFC-0087: Water states (summary, common area, stores)\r\n    waterButton: {\r\n      stateId: 'content_water',\r\n      state: 'W3siaWQiOiJjb250ZW50X3dhdGVyIiwicGFyYW1zIjp7fX1d',\r\n    },\r\n    waterCommonAreaButton: {\r\n      stateId: 'content_water_common_area',\r\n      state: 'W3siaWQiOiJjb250ZW50X3dhdGVyX2NvbW1vbl9hcmVhIiwicGFyYW1zIjp7fX1d',\r\n    },\r\n    waterStoresButton: {\r\n      stateId: 'content_water_stores',\r\n      state: 'W3siaWQiOiJjb250ZW50X3dhdGVyX3N0b3JlcyIsInBhcmFtcyI6e319XQ==',\r\n    },\r\n    // RFC-0092: Temperature states (sensors, comparison)\r\n    temperatureButton: {\r\n      stateId: 'content_temperature_sensors',\r\n      state: 'W3siaWQiOiJjb250ZW50X3RlbXBlcmF0dXJlX3NlbnNvcnMiLCJwYXJhbXMiOnt9fV0=',\r\n    },\r\n    temperatureComparisonButton: {\r\n      stateId: 'content_temperature',\r\n      state: 'W3siaWQiOiJjb250ZW50X3RlbXBlcmF0dXJlIiwicGFyYW1zIjp7fX1d',\r\n    },\r\n  };\r\n\r\n  const mainView = document.querySelector('#mainView');\r\n\r\n  /**\r\n   * RFC-0057: Switch content states using show/hide (no innerHTML manipulation!)\r\n   * This prevents widgets from being destroyed/recreated on every navigation\r\n   * @param {string} stateId - ID do estado do dashboard\r\n   */\r\n  function switchContentState(stateId) {\r\n    try {\r\n      if (!mainView) {\r\n        LogHelper.error('[MENU] #mainView element not found in DOM');\r\n        return;\r\n      }\r\n\r\n      // Find all content containers with data-content-state attribute\r\n      const allContents = mainView.querySelectorAll('[data-content-state]');\r\n\r\n      if (allContents.length === 0) {\r\n        LogHelper.error('[MENU] No content containers found with data-content-state attribute');\r\n        return;\r\n      }\r\n\r\n      // Hide all content containers\r\n      allContents.forEach((content) => {\r\n        content.style.display = 'none';\r\n      });\r\n\r\n      // Show target container\r\n      const targetContent = mainView.querySelector(`[data-content-state=\"${stateId}\"]`);\r\n      if (targetContent) {\r\n        targetContent.style.display = 'block';\r\n        LogHelper.log(`[MENU] ‚úÖ RFC-0057: Showing content state: ${stateId} (no dynamic rendering!)`);\r\n\r\n        // RFC: Determine domain from stateId and dispatch myio:dashboard-state to notify FOOTER\r\n        let domain = 'unknown';\r\n        if (stateId.includes('energy') || stateId.includes('equipments') || stateId.includes('store')) {\r\n          domain = 'energy';\r\n        } else if (stateId.includes('water')) {\r\n          domain = 'water';\r\n        } else if (stateId.includes('temperature')) {\r\n          domain = 'temperature';\r\n        }\r\n\r\n        LogHelper.log(`[MENU] Dispatching myio:dashboard-state for domain: ${domain}`);\r\n        window.dispatchEvent(\r\n          new CustomEvent('myio:dashboard-state', {\r\n            detail: {\r\n              domain: domain,\r\n              stateId: stateId,\r\n              ts: Date.now(),\r\n            },\r\n          })\r\n        );\r\n      } else {\r\n        LogHelper.warn(`[MENU] Content state not found: ${stateId}`);\r\n        LogHelper.log(\r\n          `[MENU] Available states: ${Array.from(allContents)\r\n            .map((c) => c.getAttribute('data-content-state'))\r\n            .join(', ')}`\r\n        );\r\n      }\r\n    } catch (err) {\r\n      LogHelper.error('[MENU] RFC-0057: Failed to switch content state:', err);\r\n    }\r\n  }\r\n\r\n  // Automatiza a atribui√ß√£o de eventos aos bot√µes\r\n  // RFC-0057: Using switchContentState instead of renderDashboard\r\n  Object.entries(dashboards).forEach(([buttonId, { stateId }]) => {\r\n    const button = document.getElementById(buttonId);\r\n    if (button) {\r\n      button.addEventListener('click', () => switchContentState(stateId));\r\n    }\r\n  });\r\n\r\n  // ==============================================================\r\n  // FIX: LISTENER DE TROCA DE ESTADO (Vers√£o H√≠brida)\r\n  // ==============================================================\r\n  self._onSwitchState = (ev) => {\r\n    LogHelper.log(`[MAIN] [RFC-0079] üîî Received myio:switch-main-state event:`, ev.detail);\r\n\r\n    const targetStateId = ev.detail?.targetStateId;\r\n    if (!targetStateId) return;\r\n\r\n    // VOLTAMOS PARA O SELETOR GLOBAL (Pois o log provou que ele funciona)\r\n    const mainView = document.getElementById('mainView');\r\n\r\n    if (!mainView) {\r\n      LogHelper.error('[MAIN] ‚ùå mainView element not found (Global search failed)');\r\n      return;\r\n    }\r\n\r\n    // Oculta todos (FOR√áA BRUTA)\r\n    const allStates = mainView.querySelectorAll('[data-content-state]');\r\n    allStates.forEach((stateDiv) => {\r\n      // Remove qualquer style inline antigo\r\n      stateDiv.style.display = '';\r\n      // Aplica o none com prioridade m√°xima\r\n      stateDiv.style.setProperty('display', 'none', 'important');\r\n    });\r\n\r\n    // Mostra o alvo (FOR√áA BRUTA)\r\n    const targetState = mainView.querySelector(`[data-content-state=\"${targetStateId}\"]`);\r\n    if (targetState) {\r\n      // Aplica o block com prioridade m√°xima\r\n      targetState.style.setProperty('display', 'block', 'important');\r\n\r\n      LogHelper.log(`[MAIN] ‚úÖ Switched VISUALLY to: ${targetStateId}`);\r\n\r\n      // Atualiza escopo angular se necess√°rio\r\n      if (self.ctx?.$scope) {\r\n        self.ctx.$scope.mainContentStateId = targetStateId;\r\n        if (self.ctx.$scope.$applyAsync) self.ctx.$scope.$applyAsync();\r\n      }\r\n    } else {\r\n      LogHelper.error(`[MAIN] ‚ùå Target state ${targetStateId} not found`);\r\n    }\r\n  };\r\n\r\n  // Adiciona o listener na janela\r\n  window.addEventListener('myio:switch-main-state', self._onSwitchState);\r\n  // ==============================================================\r\n\r\n  // Inicializa o daterangepicker usando o componente MyIOLibrary\r\n  const TZ = 'America/Sao_Paulo';\r\n  const hoje = new Date();\r\n\r\n  // RFC: Define datas iniciais (in√≠cio do m√™s at√© hoje) no timezone local (America/Sao_Paulo)\r\n  // Usa hor√°rio local para garantir que dia 01/12 em SP seja 01/12 (n√£o 30/11 UTC)\r\n  const startDate = presetStart\r\n    ? new Date(presetStart)\r\n    : new Date(hoje.getFullYear(), hoje.getMonth(), 1, 0, 0, 0, 0);\r\n  const endDate = presetEnd\r\n    ? new Date(presetEnd)\r\n    : new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59, 999);\r\n\r\n  // Converte para ISO strings com offset de S√£o Paulo (-03:00)\r\n  const toISOWithOffset = (date) => {\r\n    const year = date.getFullYear();\r\n    const month = String(date.getMonth() + 1).padStart(2, '0');\r\n    const day = String(date.getDate()).padStart(2, '0');\r\n    const hours = String(date.getHours()).padStart(2, '0');\r\n    const minutes = String(date.getMinutes()).padStart(2, '0');\r\n    const seconds = String(date.getSeconds()).padStart(2, '0');\r\n    const ms = String(date.getMilliseconds()).padStart(3, '0');\r\n    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.${ms}-03:00`;\r\n  };\r\n\r\n  const startISO = toISOWithOffset(startDate);\r\n  const endISO = toISOWithOffset(endDate);\r\n\r\n  let timeStart = startISO;\r\n  let timeEnd = endISO;\r\n\r\n  // Encontra o input existente\r\n  const inputElement = document.querySelector('input[name=\"startDatetimes\"]');\r\n\r\n  // Inicializa o date range picker do MyIOLibrary (sem container, apenas no input)\r\n  // Usando a biblioteca diretamente no input existente\r\n  if (inputElement && typeof MyIOLibrary !== 'undefined' && MyIOLibrary.createDateRangePicker) {\r\n    MyIOLibrary.createDateRangePicker(inputElement, {\r\n      presetStart: startISO,\r\n      presetEnd: endISO,\r\n      maxRangeDays: 365,\r\n      onApply: (result) => {\r\n        // ‚úÖ FIX: ONLY store dates internally, don't dispatch event\r\n        timeStart = result.startISO;\r\n        timeEnd = result.endISO;\r\n\r\n        // Update scope for other components to read (if needed)\r\n        const startISOOffset = result.startISO.replace('Z', '-03:00');\r\n        const endISOOffset = result.endISO.replace('Z', '-03:00');\r\n\r\n        self.ctx.$scope.startDateISO = startISOOffset;\r\n        self.ctx.$scope.endDateISO = endISOOffset;\r\n\r\n        // Update UI display\r\n        const startDate = new Date(result.startISO);\r\n        const endDate = new Date(result.endISO);\r\n        const timeWindow = `Intervalo: ${formatDiaMes(startDate)} - ${formatDiaMes(endDate)}`;\r\n        const timeinterval = document.getElementById('energy-peak');\r\n        if (timeinterval) {\r\n          timeinterval.innerText = timeWindow;\r\n        }\r\n\r\n        LogHelper.log('[MENU] Date selection updated (no fetch):', {\r\n          start: result.startISO,\r\n          end: result.endISO,\r\n        });\r\n\r\n        // ‚úÖ NO EVENT DISPATCHING - data will only be fetched when user clicks \"Carregar\" button\r\n      },\r\n    })\r\n      .then((picker) => {\r\n        LogHelper.log('[MENU] Date range picker inicializado com MyIOLibrary');\r\n      })\r\n      .catch((err) => {\r\n        LogHelper.error('[MENU] Erro ao inicializar date picker:', err);\r\n      });\r\n  } else {\r\n    LogHelper.warn('[MENU] MyIOLibrary.createDateRangePicker n√£o dispon√≠vel');\r\n  }\r\n\r\n  // ===== CARREGAR BUTTON HANDLER =====\r\n  const btnCarregar = document.getElementById('load-button');\r\n\r\n  if (btnCarregar) {\r\n    btnCarregar.addEventListener('click', async () => {\r\n      LogHelper.log('[MENU] Carregar button clicked - fetching data...');\r\n\r\n      // Disable button during fetch\r\n      btnCarregar.disabled = true;\r\n      const originalHTML = btnCarregar.innerHTML;\r\n      btnCarregar.innerHTML = '<i class=\"material-icons\">hourglass_empty</i> Carregando...';\r\n\r\n      try {\r\n        // Prepare date range with timezone offset\r\n        const startISOOffset = timeStart.replace('Z', '-03:00');\r\n        const endISOOffset = timeEnd.replace('Z', '-03:00');\r\n\r\n        const startMs = new Date(timeStart).getTime();\r\n        const endMs = new Date(timeEnd).getTime();\r\n\r\n        // Update scope\r\n        self.ctx.$scope.startDateISO = startISOOffset;\r\n        self.ctx.$scope.endDateISO = endISOOffset;\r\n\r\n        // ‚úÖ Save dates globally for ENERGY widget to access\r\n        window.myioDateRange = {\r\n          startDate: startISOOffset,\r\n          endDate: endISOOffset,\r\n          startMs,\r\n          endMs,\r\n        };\r\n\r\n        // ‚úÖ Also save to localStorage as backup\r\n        localStorage.setItem(\r\n          'myio:date-range',\r\n          JSON.stringify({\r\n            startDate: startISOOffset,\r\n            endDate: endISOOffset,\r\n            startMs,\r\n            endMs,\r\n          })\r\n        );\r\n\r\n        LogHelper.log('[MENU] Dispatching myio:update-date event:', {\r\n          startDate: startISOOffset,\r\n          endDate: endISOOffset,\r\n        });\r\n\r\n        // ‚úÖ NOW dispatch event to trigger data fetch\r\n        window.dispatchEvent(\r\n          new CustomEvent('myio:update-date', {\r\n            detail: {\r\n              startDate: startISOOffset,\r\n              endDate: endISOOffset,\r\n              startUtc: timeStart,\r\n              endUtc: timeEnd,\r\n              startMs,\r\n              endMs,\r\n              tz: TZ,\r\n            },\r\n          })\r\n        );\r\n\r\n        // RFC: Request MAIN to update total consumption via CustomEvent\r\n        if (window.custumersSelected && window.custumersSelected.length > 0) {\r\n          window.dispatchEvent(\r\n            new CustomEvent('myio:request-total-consumption', {\r\n              detail: {\r\n                customersArray: window.custumersSelected,\r\n                startDateISO: startISOOffset,\r\n                endDateISO: endISOOffset,\r\n              },\r\n            })\r\n          );\r\n          LogHelper.log('[MENU] Dispatched myio:request-total-consumption to MAIN');\r\n        }\r\n      } catch (error) {\r\n        LogHelper.error('[MENU] Error loading data:', error);\r\n        window.alert('Erro ao carregar dados. Tente novamente.');\r\n      } finally {\r\n        // Re-enable button\r\n        btnCarregar.disabled = false;\r\n        btnCarregar.innerHTML = originalHTML;\r\n      }\r\n    });\r\n\r\n    LogHelper.log('[MENU] Carregar button handler registered');\r\n  } else {\r\n    LogHelper.warn('[MENU] Carregar button (load-button) not found');\r\n  }\r\n\r\n  // ===== LIMPAR BUTTON HANDLER (Force Refresh) =====\r\n  const btnLimpar = document.getElementById('myio-clear-btn');\r\n\r\n  if (btnLimpar) {\r\n    btnLimpar.addEventListener('click', (event) => {\r\n      LogHelper.log('[MENU] üîÑ Limpar (Force Refresh) clicked');\r\n\r\n      // Confirma√ß√£o do usu√°rio\r\n      const confirmed = window.confirm('Isso vai limpar todo o cache e recarregar os dados. Continuar?');\r\n      if (!confirmed) {\r\n        LogHelper.log('[MENU] Force Refresh cancelado pelo usu√°rio');\r\n        return;\r\n      }\r\n\r\n      try {\r\n        // RFC-0057: No longer using localStorage, only memory cache\r\n\r\n        // Invalida cache do orquestrador se dispon√≠vel\r\n        if (window.MyIOOrchestrator && window.MyIOOrchestrator.invalidateCache) {\r\n          window.MyIOOrchestrator.invalidateCache('energy');\r\n          window.MyIOOrchestrator.invalidateCache('water');\r\n          LogHelper.log('[MENU] ‚úÖ Cache do orquestrador invalidado');\r\n        }\r\n\r\n        // Limpa conte√∫do visual dos widgets TELEMETRY\r\n        const clearEvent = new CustomEvent('myio:telemetry:clear', {\r\n          detail: { domain: 'energy' }, // ou pegar do estado atual\r\n        });\r\n\r\n        window.dispatchEvent(clearEvent);\r\n        LogHelper.log(`[MENU] ‚úÖ Evento de limpeza emitido`);\r\n\r\n        // RFC-0057: Removed iframe event dispatch - no longer using iframes\r\n\r\n        LogHelper.log('[MENU] üîÑ Force Refresh conclu√≠do com sucesso');\r\n\r\n        // Recarrega a p√°gina para limpar todos os widgets visuais\r\n        window.alert('Cache limpo com sucesso! A p√°gina ser√° recarregada para aplicar as mudan√ßas.');\r\n        setTimeout(() => {\r\n          window.location.reload();\r\n        }, 500);\r\n      } catch (err) {\r\n        LogHelper.error('[MENU] ‚ùå Erro durante Force Refresh:', err);\r\n        window.alert('Erro ao limpar cache. Consulte o console para detalhes.');\r\n      }\r\n    });\r\n\r\n    LogHelper.log('[MENU] Limpar button handler registered');\r\n  } else {\r\n    LogHelper.warn('[MENU] Limpar button (myio-clear-btn) not found');\r\n  }\r\n\r\n  // ===== METAS BUTTON HANDLER (Goals Panel) =====\r\n  const btnMetas = document.getElementById('myio-goals-btn');\r\n\r\n  if (btnMetas) {\r\n    btnMetas.addEventListener('click', () => {\r\n      LogHelper.log('[MENU] üéØ Metas (Goals Panel) clicked');\r\n\r\n      // Verifica se MyIOLibrary est√° dispon√≠vel\r\n      if (typeof MyIOLibrary === 'undefined' || !MyIOLibrary.openGoalsPanel) {\r\n        LogHelper.error('[MENU] ‚ùå MyIOLibrary.openGoalsPanel n√£o est√° dispon√≠vel');\r\n        window.alert('Componente de Metas n√£o est√° dispon√≠vel. Verifique a biblioteca MyIO.');\r\n        return;\r\n      }\r\n\r\n      try {\r\n        // ‚úÖ Obt√©m o customerId pai (Holding) do MAIN (exposto via window)\r\n        // Este √© o Customer raiz no ThingsBoard que cont√©m os shoppings filhos\r\n        const customerId = window.myioHoldingCustomerId;\r\n\r\n        if (!customerId) {\r\n          LogHelper.error('[MENU] ‚ùå customerId n√£o encontrado (MAIN ainda n√£o inicializou?)');\r\n          window.alert('Customer ID n√£o dispon√≠vel. Aguarde o carregamento completo do dashboard.');\r\n          return;\r\n        }\r\n\r\n        LogHelper.log('[MENU] üìã Using Holding customerId from MAIN:', customerId);\r\n\r\n        // ‚úÖ Obt√©m o token do localStorage (padr√£o do ThingsBoard)\r\n        const token = localStorage.getItem('jwt_token');\r\n\r\n        if (!token) {\r\n          LogHelper.error('[MENU] ‚ùå Token JWT n√£o encontrado no localStorage');\r\n          window.alert('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.');\r\n          return;\r\n        }\r\n\r\n        LogHelper.log('[MENU] üîë Token JWT obtido do localStorage');\r\n\r\n        // ‚úÖ Prepara a lista de shoppings filhos (j√° computada pelo MENU)\r\n        // Esta lista vem do modal de filtro e representa os Customers filhos\r\n        const shoppingList = (self.ctx.$scope.custumer || [])\r\n          .filter((c) => c.value && c.name && c.name.trim() !== c.value.trim())\r\n          .map((c) => ({\r\n            value: c.value, // UUID do Customer filho (Shopping)\r\n            name: c.name, // Nome do Shopping\r\n          }));\r\n\r\n        LogHelper.log('[MENU] üè¨ Shopping list prepared:', {\r\n          count: shoppingList.length,\r\n          shoppings: shoppingList.map((s) => s.name),\r\n        });\r\n\r\n        // ‚úÖ Determina qual shopping est√° selecionado no filtro (se algum)\r\n        let selectedShoppingId = null;\r\n        if (window.custumersSelected && window.custumersSelected.length > 0) {\r\n          selectedShoppingId = window.custumersSelected[0].value;\r\n          LogHelper.log('[MENU] üéØ Current filter selection:', window.custumersSelected[0].name);\r\n        }\r\n\r\n        LogHelper.log('[MENU] üöÄ Opening Goals Panel with:', {\r\n          holdingCustomerId: customerId,\r\n          shoppingCount: shoppingList.length,\r\n          selectedShopping: selectedShoppingId,\r\n        });\r\n\r\n        // ‚úÖ Abre o painel de metas usando MyIOLibrary\r\n        MyIOLibrary.openGoalsPanel({\r\n          customerId: customerId, // Customer pai (Holding)\r\n          token: token, // Token do localStorage\r\n          api: {\r\n            baseUrl: window.location.origin,\r\n          },\r\n          shoppingList: shoppingList, // Lista de shoppings filhos\r\n          locale: 'pt-BR',\r\n          onSave: async (goalsData) => {\r\n            LogHelper.log('[MENU] ‚úÖ Goals saved successfully:', {\r\n              version: goalsData.version,\r\n              yearsCount: Object.keys(goalsData.years || {}).length,\r\n            });\r\n\r\n            // Dispara evento global para outros widgets reagirem\r\n            window.dispatchEvent(\r\n              new CustomEvent('myio:goals-updated', {\r\n                detail: {\r\n                  goalsData,\r\n                  customerId,\r\n                  timestamp: Date.now(),\r\n                },\r\n              })\r\n            );\r\n\r\n            LogHelper.log(\"[MENU] üìä Event 'myio:goals-updated' dispatched\");\r\n\r\n            // Feedback visual opcional\r\n            // alert(\"‚úÖ Metas salvas com sucesso!\");\r\n          },\r\n          onClose: () => {\r\n            LogHelper.log('[MENU] üö™ Goals Panel closed');\r\n          },\r\n          styles: {\r\n            primaryColor: '#6a1b9a', // Mesma cor do bot√£o Metas (roxo MYIO)\r\n            accentColor: '#FFC107', // Amarelo de destaque\r\n            successColor: '#28a745', // Verde de sucesso\r\n            errorColor: '#dc3545', // Vermelho de erro\r\n            borderRadius: '8px',\r\n            zIndex: 10000,\r\n          },\r\n        });\r\n\r\n        LogHelper.log('[MENU] ‚úÖ Goals Panel opened successfully');\r\n      } catch (error) {\r\n        LogHelper.error('[MENU] ‚ùå Error opening Goals Panel:', error);\r\n        window.alert(\r\n          `Erro ao abrir o painel de metas:\\n${error.message}\\n\\nConsulte o console para mais detalhes.`\r\n        );\r\n      }\r\n    });\r\n\r\n    LogHelper.log('[MENU] Metas button handler registered');\r\n  } else {\r\n    LogHelper.warn('[MENU] Metas button (myio-goals-btn) not found');\r\n  }\r\n\r\n  // ===== APPLY STYLES FROM SETTINGS.SCHEMA =====\r\n  const settings = self.ctx?.settings || {};\r\n  LogHelper.log('[MENU] Applying styles from settings:', settings);\r\n\r\n  // Bot√£o Carregar\r\n  if (btnCarregar) {\r\n    const carregarBg = settings.botaoCarregarBackgroundColor || '#2F5848';\r\n    const carregarFont = settings.botaoCarregarFontColor || '#F2F2F2';\r\n    btnCarregar.style.backgroundColor = carregarBg;\r\n    btnCarregar.style.color = carregarFont;\r\n    const carregarIcon = btnCarregar.querySelector('i.material-icons');\r\n    if (carregarIcon) carregarIcon.style.color = carregarFont;\r\n    LogHelper.log(`[MENU] Carregar button styled: bg=${carregarBg}, font=${carregarFont}`);\r\n  }\r\n\r\n  // Bot√£o Limpar\r\n  if (btnLimpar) {\r\n    const limparBg = settings.botaoLimparBackgroundColor || '#FFFFFF';\r\n    const limparFont = settings.botaoLimparFontColor || '#1C2743';\r\n    btnLimpar.style.backgroundColor = limparBg;\r\n    btnLimpar.style.color = limparFont;\r\n    const limparIcon = btnLimpar.querySelector('i.material-icons');\r\n    if (limparIcon) limparIcon.style.color = limparFont;\r\n    LogHelper.log(`[MENU] Limpar button styled: bg=${limparBg}, font=${limparFont}`);\r\n  }\r\n\r\n  // Bot√£o Metas\r\n  if (btnMetas) {\r\n    const metasBg = settings.botaoMetasBackgroundColor || '#6a1b9a';\r\n    const metasFont = settings.botaoMetasFontColor || '#F2F2F2';\r\n    btnMetas.style.backgroundColor = metasBg;\r\n    btnMetas.style.color = metasFont;\r\n    const metasIcon = btnMetas.querySelector('i.material-icons');\r\n    if (metasIcon) metasIcon.style.color = metasFont;\r\n    LogHelper.log(`[MENU] Metas button styled: bg=${metasBg}, font=${metasFont}`);\r\n  }\r\n\r\n  // Tabs styling (Energy, Water, Temperature)\r\n  const tabSelecionadoBg = settings.tabSelecionadoBackgroundColor || '#2F5848';\r\n  const tabSelecionadoFont = settings.tabSelecionadoFontColor || '#F2F2F2';\r\n  const tabNaoSelecionadoBg = settings.tabNaoSelecionadoBackgroundColor || '#FFFFFF';\r\n  const tabNaoSelecionadoFont = settings.tabNaoSelecionadoFontColor || '#1C2743';\r\n\r\n  // Inject dynamic tab styles\r\n  if (!document.getElementById('myio-menu-dynamic-styles')) {\r\n    const dynamicStyle = document.createElement('style');\r\n    dynamicStyle.id = 'myio-menu-dynamic-styles';\r\n    dynamicStyle.innerHTML = `\r\n      .myio-tabs .tab.is-active {\r\n        background-color: ${tabSelecionadoBg} !important;\r\n        color: ${tabSelecionadoFont} !important;\r\n      }\r\n      .myio-tabs .tab:not(.is-active) {\r\n        background-color: ${tabNaoSelecionadoBg} !important;\r\n        color: ${tabNaoSelecionadoFont} !important;\r\n      }\r\n    `;\r\n    document.head.appendChild(dynamicStyle);\r\n    LogHelper.log('[MENU] Dynamic tab styles injected');\r\n  }\r\n\r\n  const root = (self?.ctx?.$container && self.ctx.$container[0]) || document;\r\n\r\n  computeCustomersFromCtx();\r\n\r\n  bindTabs(root);\r\n  bindFilter(root);\r\n\r\n  // mocks (remova se alimentar via API/telemetria)\r\n\r\n  const filterBtn = document.getElementById('filterBtn');\r\n\r\n  if (filterBtn) {\r\n    filterBtn.addEventListener('click', () => {\r\n      LogHelper.log('[MENU] üîò Filter button clicked');\r\n      LogHelper.log('[MENU] üìã Current customers in scope:', self.ctx.$scope.custumer?.length || 0);\r\n\r\n      if (!Array.isArray(self.ctx.$scope.custumer) || self.ctx.$scope.custumer.length === 0) {\r\n        LogHelper.log('[MENU] ‚ö†Ô∏è No customers in scope, computing from ctx...');\r\n        computeCustomersFromCtx();\r\n        LogHelper.log('[MENU] üìã Customers after compute:', self.ctx.$scope.custumer?.length || 0);\r\n      }\r\n\r\n      LogHelper.log('[MENU] üöÄ Opening filter modal...');\r\n      injectModalGlobal();\r\n      bindFilter(document.body);\r\n      LogHelper.log('[MENU] ‚úÖ Filter modal opened');\r\n    });\r\n  } else {\r\n    LogHelper.error('[MENU] ‚ùå Filter button (filterBtn) not found in DOM!');\r\n  }\r\n\r\n  // Atualiza escopo com datas iniciais\r\n  self.ctx.$scope.startDateISO = timeStart;\r\n  self.ctx.$scope.endDateISO = timeEnd;\r\n\r\n  // Dispara evento inicial com as datas preset\r\n  const startDateFormatted = timeStart.replace('Z', '-03:00');\r\n  const endDateFormatted = timeEnd.replace('Z', '-03:00');\r\n\r\n  // ‚úÖ Save initial dates globally for other widgets\r\n  window.myioDateRange = {\r\n    startDate: startDateFormatted,\r\n    endDate: endDateFormatted,\r\n    startMs: new Date(timeStart).getTime(),\r\n    endMs: new Date(timeEnd).getTime(),\r\n  };\r\n\r\n  // ‚úÖ Also save to localStorage\r\n  localStorage.setItem('myio:date-range', JSON.stringify(window.myioDateRange));\r\n\r\n  LogHelper.log('[MENU] Initial dates saved globally:', window.myioDateRange);\r\n\r\n  window.addEventListener('myio:equipment-count-updated', (ev) => {\r\n    computeCustomersFromCtx();\r\n  });\r\n\r\n  LogHelper.log('[MENU] üì° Dispatching initial myio:update-date event:', {\r\n    startDate: startDateFormatted,\r\n    endDate: endDateFormatted,\r\n  });\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:update-date', {\r\n      detail: {\r\n        startDate: startDateFormatted,\r\n        endDate: endDateFormatted,\r\n      },\r\n    })\r\n  );\r\n\r\n  // n√£o apagar!!\r\n  const custumerMap = new Map();\r\n  self.ctx.data.forEach((data) => {\r\n    if (data.datasource.aliasName === 'Shopping') {\r\n      const name = data.datasource.entityLabel;\r\n      const value = data.data?.[0]?.[1];\r\n      if (value != null && !custumerMap.has(value)) {\r\n        custumerMap.set(value, { name, value });\r\n      }\r\n    }\r\n  });\r\n  computeCustomersFromCtx();\r\n\r\n  // LogHelper.log(\"custumer\",custumer)\r\n\r\n  // ==============================================================\r\n  // MODAL + LIMPEZA DE ABAS + SINCRONIZA√á√ÉO DE CHECK\r\n  // ==============================================================\r\n  setTimeout(() => {\r\n    LogHelper.log('[SETUP] Iniciando fix do Modal V3...');\r\n\r\n    const btn = document.getElementById('energyButton');\r\n    let modal = document.getElementById('energyContextModal');\r\n    const mainView = document.querySelector('#mainView') || document.getElementById('mainView');\r\n\r\n    if (!btn || !modal) return;\r\n\r\n    // 1. CLONAR BOT√ÉO (Limpar listeners antigos)\r\n    const newBtn = btn.cloneNode(true);\r\n    btn.parentNode.replaceChild(newBtn, btn);\r\n\r\n    // 2. MOVER O MODAL PARA A RAIZ (evita cortes visuais)\r\n    if (modal.parentNode !== document.body) {\r\n      modal.parentNode.removeChild(modal);\r\n      document.body.appendChild(modal);\r\n    }\r\n\r\n    // 3. A√á√ÉO DE CLIQUE DO BOT√ÉO ENERGIA\r\n    newBtn.onclick = function (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n\r\n      LogHelper.log('[CLICK] Bot√£o Energia Clicado');\r\n\r\n      // --- LIMPEZA DE ABAS ---\r\n      const allTabs = document.querySelectorAll('.myio-tabs .tab');\r\n      allTabs.forEach((t) => t.classList.remove('is-active'));\r\n      newBtn.classList.add('is-active');\r\n\r\n      // Verifica se vai abrir ou fechar\r\n      const isVisible = modal.style.display === 'flex';\r\n\r\n      if (!isVisible) {\r\n        // [NOVO] --- SINCRONIZA√á√ÉO VISUAL DO MODAL ---\r\n        // Verifica qual tela est√° ativa no momento (salva no escopo ou padr√£o)\r\n        const currentState = self.ctx?.$scope?.mainContentStateId || 'content_equipments';\r\n\r\n        const modalOptions = modal.querySelectorAll('.energy-modal-option');\r\n        modalOptions.forEach((opt) => {\r\n          // Se o data-target da op√ß√£o for igual √† tela atual, marca como ativo\r\n          if (opt.getAttribute('data-target') === currentState) {\r\n            opt.classList.add('is-active');\r\n          } else {\r\n            opt.classList.remove('is-active');\r\n          }\r\n        });\r\n        // --------------------------------------------\r\n\r\n        LogHelper.log('[ACTION] Abrindo modal sincronizado...');\r\n\r\n        // Abre o modal com CSS for√ßado\r\n        modal.style.cssText = `\r\n                    display: flex !important;\r\n                    position: fixed !important;\r\n                    top: 0 !important;\r\n                    left: 0 !important;\r\n                    width: 100vw !important;\r\n                    height: 100vh !important;\r\n                    background-color: rgba(0,0,0,0.6) !important;\r\n                    z-index: 2147483647 !important;\r\n                    align-items: center !important;\r\n                    justify-content: center !important;\r\n                    opacity: 1 !important;\r\n                    visibility: visible !important;\r\n                `;\r\n\r\n        // Estiliza conte√∫do interno se necess√°rio\r\n        const content = modal.querySelector('.energy-modal-content');\r\n        if (content) {\r\n          content.style.cssText = `\r\n                        display: flex !important;\r\n                        flex-direction: column !important;\r\n                        background: white !important;\r\n                        padding: 0 !important;\r\n                        border-radius: 16px !important;\r\n                        min-width: 320px !important;\r\n                        z-index: 2147483647 !important;\r\n                        opacity: 1 !important;\r\n                        border: none !important;\r\n                        overflow: hidden !important;\r\n                    `;\r\n        }\r\n      } else {\r\n        modal.style.display = 'none';\r\n      }\r\n    };\r\n\r\n    // 4. A√á√ÉO DAS OP√á√ïES (DENTRO DO MODAL)\r\n    const options = modal.querySelectorAll('.energy-modal-option');\r\n    options.forEach((opt) => {\r\n      opt.onclick = function (ev) {\r\n        ev.stopPropagation();\r\n        const targetStateId = this.getAttribute('data-target');\r\n        const contextName = this.querySelector('.option-title')?.innerText;\r\n\r\n        // Atualiza label visual\r\n        const label = document.getElementById('energyContextLabel');\r\n        if (label && contextName) label.innerText = `Energia: ${contextName.replace(' (Energia)', '')}`;\r\n\r\n        // Atualiza op√ß√£o ativa (RFC-0095: Fix visual consistency with Water/Temperature modals)\r\n        options.forEach((o) => o.classList.remove('is-active'));\r\n        this.classList.add('is-active');\r\n\r\n        // Fecha modal\r\n        modal.style.display = 'none';\r\n\r\n        // Troca de tela\r\n        if (targetStateId && mainView) {\r\n          const allStates = mainView.querySelectorAll('[data-content-state]');\r\n          allStates.forEach((d) => d.style.setProperty('display', 'none', 'important'));\r\n\r\n          const targetDiv = mainView.querySelector(`[data-content-state=\"${targetStateId}\"]`);\r\n          if (targetDiv) {\r\n            targetDiv.style.setProperty('display', 'block', 'important');\r\n\r\n            // Mant√©m bot√£o ativo\r\n            newBtn.classList.add('is-active');\r\n\r\n            // Atualiza escopo angular (CRUCIAL para a sincroniza√ß√£o funcionar na pr√≥xima vez)\r\n            if (self.ctx?.$scope) {\r\n              self.ctx.$scope.mainContentStateId = targetStateId;\r\n              if (self.ctx.$scope.$applyAsync) self.ctx.$scope.$applyAsync();\r\n            }\r\n\r\n            // RFC: Dispatch myio:dashboard-state to notify FOOTER of domain change (clear selection)\r\n            // NOTE: Does NOT dispatch myio:update-date - data should already be loaded by orchestrator\r\n            // User must click \"Carregar\" button to refresh data\r\n            LogHelper.log(`[MENU] Dispatching myio:dashboard-state for domain: energy`);\r\n            window.dispatchEvent(\r\n              new CustomEvent('myio:dashboard-state', {\r\n                detail: {\r\n                  domain: 'energy',\r\n                  stateId: targetStateId,\r\n                  ts: Date.now(),\r\n                },\r\n              })\r\n            );\r\n          }\r\n        }\r\n      };\r\n    });\r\n\r\n    // 5. FECHAR AO CLICAR NO FUNDO\r\n    modal.onclick = function (e) {\r\n      if (e.target === modal) {\r\n        modal.style.display = 'none';\r\n      }\r\n    };\r\n  }, 1000);\r\n\r\n  // ==============================================================\r\n  // RFC-0087: WATER MODAL SETUP (Similar to Energy Modal)\r\n  // ==============================================================\r\n  setTimeout(() => {\r\n    LogHelper.log('[SETUP] RFC-0087: Iniciando fix do Water Modal...');\r\n\r\n    const waterBtn = document.getElementById('waterButton');\r\n    let waterModal = document.getElementById('waterContextModal');\r\n    const mainView = document.querySelector('#mainView') || document.getElementById('mainView');\r\n\r\n    if (!waterBtn || !waterModal) {\r\n      LogHelper.warn('[SETUP] Water button or modal not found');\r\n      return;\r\n    }\r\n\r\n    // 1. CLONAR BOT√ÉO (Limpar listeners antigos)\r\n    const newWaterBtn = waterBtn.cloneNode(true);\r\n    waterBtn.parentNode.replaceChild(newWaterBtn, waterBtn);\r\n\r\n    // 2. MOVER O MODAL PARA A RAIZ (evita cortes visuais)\r\n    if (waterModal.parentNode !== document.body) {\r\n      waterModal.parentNode.removeChild(waterModal);\r\n      document.body.appendChild(waterModal);\r\n    }\r\n\r\n    // 3. A√á√ÉO DE CLIQUE DO BOT√ÉO √ÅGUA\r\n    newWaterBtn.onclick = function (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n\r\n      LogHelper.log('[CLICK] Bot√£o √Ågua Clicado');\r\n\r\n      // --- LIMPEZA DE ABAS ---\r\n      const allTabs = document.querySelectorAll('.myio-tabs .tab');\r\n      allTabs.forEach((t) => t.classList.remove('is-active'));\r\n      newWaterBtn.classList.add('is-active');\r\n\r\n      // Verifica se vai abrir ou fechar\r\n      const isVisible = waterModal.style.display === 'flex';\r\n\r\n      if (!isVisible) {\r\n        // --- SINCRONIZA√á√ÉO VISUAL DO MODAL ---\r\n        const currentState = self.ctx?.$scope?.mainContentStateId || 'content_water';\r\n\r\n        const modalOptions = waterModal.querySelectorAll('.water-modal-option');\r\n        modalOptions.forEach((opt) => {\r\n          if (opt.getAttribute('data-target') === currentState) {\r\n            opt.classList.add('is-active');\r\n          } else {\r\n            opt.classList.remove('is-active');\r\n          }\r\n        });\r\n\r\n        LogHelper.log('[ACTION] Abrindo water modal sincronizado...');\r\n\r\n        // Abre o modal com CSS for√ßado\r\n        waterModal.style.cssText = `\r\n          display: flex !important;\r\n          position: fixed !important;\r\n          top: 0 !important;\r\n          left: 0 !important;\r\n          width: 100vw !important;\r\n          height: 100vh !important;\r\n          background-color: rgba(0,0,0,0.6) !important;\r\n          z-index: 2147483647 !important;\r\n          align-items: center !important;\r\n          justify-content: center !important;\r\n          opacity: 1 !important;\r\n          visibility: visible !important;\r\n        `;\r\n\r\n        // Estiliza conte√∫do interno\r\n        const content = waterModal.querySelector('.water-modal-content');\r\n        if (content) {\r\n          content.style.cssText = `\r\n            display: flex !important;\r\n            flex-direction: column !important;\r\n            background: white !important;\r\n            padding: 0 !important;\r\n            border-radius: 16px !important;\r\n            min-width: 320px !important;\r\n            z-index: 2147483647 !important;\r\n            opacity: 1 !important;\r\n            border: none !important;\r\n            overflow: hidden !important;\r\n          `;\r\n        }\r\n      } else {\r\n        waterModal.style.display = 'none';\r\n      }\r\n    };\r\n\r\n    // 4. A√á√ÉO DAS OP√á√ïES (DENTRO DO MODAL)\r\n    const waterOptions = waterModal.querySelectorAll('.water-modal-option');\r\n    waterOptions.forEach((opt) => {\r\n      opt.onclick = function (ev) {\r\n        ev.stopPropagation();\r\n        const targetStateId = this.getAttribute('data-target');\r\n        const contextName = this.querySelector('.option-title')?.innerText;\r\n\r\n        // Atualiza label visual\r\n        const label = document.getElementById('waterContextLabel');\r\n        if (label && contextName) label.innerText = `√Ågua: ${contextName}`;\r\n\r\n        // Atualiza op√ß√£o ativa\r\n        waterOptions.forEach((o) => o.classList.remove('is-active'));\r\n        this.classList.add('is-active');\r\n\r\n        // Fecha modal\r\n        waterModal.style.display = 'none';\r\n\r\n        // Troca de tela\r\n        if (targetStateId && mainView) {\r\n          const allStates = mainView.querySelectorAll('[data-content-state]');\r\n          allStates.forEach((d) => d.style.setProperty('display', 'none', 'important'));\r\n\r\n          const targetDiv = mainView.querySelector(`[data-content-state=\"${targetStateId}\"]`);\r\n          if (targetDiv) {\r\n            targetDiv.style.setProperty('display', 'block', 'important');\r\n\r\n            // Mant√©m bot√£o ativo\r\n            newWaterBtn.classList.add('is-active');\r\n\r\n            // Atualiza escopo angular\r\n            if (self.ctx?.$scope) {\r\n              self.ctx.$scope.mainContentStateId = targetStateId;\r\n              if (self.ctx.$scope.$applyAsync) self.ctx.$scope.$applyAsync();\r\n            }\r\n\r\n            // RFC: Dispatch myio:dashboard-state to notify FOOTER of domain change (clear selection)\r\n            // NOTE: Does NOT dispatch myio:update-date - data should already be loaded by orchestrator\r\n            // User must click \"Carregar\" button to refresh data\r\n            LogHelper.log(`[MENU] Dispatching myio:dashboard-state for domain: water`);\r\n            window.dispatchEvent(\r\n              new CustomEvent('myio:dashboard-state', {\r\n                detail: {\r\n                  domain: 'water',\r\n                  stateId: targetStateId,\r\n                  ts: Date.now(),\r\n                },\r\n              })\r\n            );\r\n\r\n            LogHelper.log(`[MENU] RFC-0087: Switched to water state: ${targetStateId}`);\r\n          }\r\n        }\r\n      };\r\n    });\r\n\r\n    // 5. FECHAR AO CLICAR NO FUNDO\r\n    waterModal.onclick = function (e) {\r\n      if (e.target === waterModal) {\r\n        waterModal.style.display = 'none';\r\n      }\r\n    };\r\n\r\n    LogHelper.log('[SETUP] RFC-0087: Water Modal setup complete');\r\n  }, 1100);\r\n\r\n  // ==============================================================\r\n  // RFC-0092: TEMPERATURE MODAL SETUP (Similar to Water Modal)\r\n  // ==============================================================\r\n  setTimeout(() => {\r\n    LogHelper.log('[SETUP] RFC-0092: Iniciando fix do Temperature Modal...');\r\n\r\n    const tempBtn = document.getElementById('temperatureButton');\r\n    let tempModal = document.getElementById('temperatureContextModal');\r\n    const mainView = document.querySelector('#mainView') || document.getElementById('mainView');\r\n\r\n    if (!tempBtn || !tempModal) {\r\n      LogHelper.warn('[SETUP] Temperature button or modal not found');\r\n      return;\r\n    }\r\n\r\n    // 1. CLONAR BOT√ÉO (Limpar listeners antigos)\r\n    const newTempBtn = tempBtn.cloneNode(true);\r\n    tempBtn.parentNode.replaceChild(newTempBtn, tempBtn);\r\n\r\n    // 2. MOVER O MODAL PARA A RAIZ (evita cortes visuais)\r\n    if (tempModal.parentNode !== document.body) {\r\n      tempModal.parentNode.removeChild(tempModal);\r\n      document.body.appendChild(tempModal);\r\n    }\r\n\r\n    // 3. A√á√ÉO DE CLIQUE DO BOT√ÉO TEMPERATURA\r\n    newTempBtn.onclick = function (e) {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n\r\n      LogHelper.log('[CLICK] Bot√£o Temperatura Clicado');\r\n\r\n      // --- LIMPEZA DE ABAS ---\r\n      const allTabs = document.querySelectorAll('.myio-tabs .tab');\r\n      allTabs.forEach((t) => t.classList.remove('is-active'));\r\n      newTempBtn.classList.add('is-active');\r\n\r\n      // Verifica se vai abrir ou fechar\r\n      const isVisible = tempModal.style.display === 'flex';\r\n\r\n      if (!isVisible) {\r\n        // --- SINCRONIZA√á√ÉO VISUAL DO MODAL ---\r\n        const currentState = self.ctx?.$scope?.mainContentStateId || 'content_temperature_sensors';\r\n\r\n        const modalOptions = tempModal.querySelectorAll('.temperature-modal-option');\r\n        modalOptions.forEach((opt) => {\r\n          if (opt.getAttribute('data-target') === currentState) {\r\n            opt.classList.add('is-active');\r\n          } else {\r\n            opt.classList.remove('is-active');\r\n          }\r\n        });\r\n\r\n        LogHelper.log('[ACTION] Abrindo temperature modal sincronizado...');\r\n\r\n        // Abre o modal com CSS for√ßado\r\n        tempModal.style.cssText = `\r\n          display: flex !important;\r\n          position: fixed !important;\r\n          top: 0 !important;\r\n          left: 0 !important;\r\n          width: 100vw !important;\r\n          height: 100vh !important;\r\n          background-color: rgba(0,0,0,0.6) !important;\r\n          z-index: 2147483647 !important;\r\n          align-items: center !important;\r\n          justify-content: center !important;\r\n          opacity: 1 !important;\r\n          visibility: visible !important;\r\n        `;\r\n\r\n        // Estiliza conte√∫do interno\r\n        const content = tempModal.querySelector('.temperature-modal-content');\r\n        if (content) {\r\n          content.style.cssText = `\r\n            display: flex !important;\r\n            flex-direction: column !important;\r\n            background: white !important;\r\n            padding: 0 !important;\r\n            border-radius: 16px !important;\r\n            min-width: 320px !important;\r\n            z-index: 2147483647 !important;\r\n            opacity: 1 !important;\r\n            border: none !important;\r\n            overflow: hidden !important;\r\n          `;\r\n        }\r\n      } else {\r\n        tempModal.style.display = 'none';\r\n      }\r\n    };\r\n\r\n    // 4. A√á√ÉO DAS OP√á√ïES (DENTRO DO MODAL)\r\n    const tempOptions = tempModal.querySelectorAll('.temperature-modal-option');\r\n    tempOptions.forEach((opt) => {\r\n      opt.onclick = function (ev) {\r\n        ev.stopPropagation();\r\n        const targetStateId = this.getAttribute('data-target');\r\n        const contextName = this.querySelector('.option-title')?.innerText;\r\n\r\n        // Atualiza label visual\r\n        const label = document.getElementById('temperatureContextLabel');\r\n        if (label && contextName) label.innerText = `Temperatura: ${contextName}`;\r\n\r\n        // Atualiza op√ß√£o ativa\r\n        tempOptions.forEach((o) => o.classList.remove('is-active'));\r\n        this.classList.add('is-active');\r\n\r\n        // Fecha modal\r\n        tempModal.style.display = 'none';\r\n\r\n        // Troca de tela\r\n        if (targetStateId && mainView) {\r\n          const allStates = mainView.querySelectorAll('[data-content-state]');\r\n          allStates.forEach((d) => d.style.setProperty('display', 'none', 'important'));\r\n\r\n          const targetDiv = mainView.querySelector(`[data-content-state=\"${targetStateId}\"]`);\r\n          if (targetDiv) {\r\n            targetDiv.style.setProperty('display', 'block', 'important');\r\n\r\n            // Mant√©m bot√£o ativo\r\n            newTempBtn.classList.add('is-active');\r\n\r\n            // Atualiza escopo angular\r\n            if (self.ctx?.$scope) {\r\n              self.ctx.$scope.mainContentStateId = targetStateId;\r\n              if (self.ctx.$scope.$applyAsync) self.ctx.$scope.$applyAsync();\r\n            }\r\n\r\n            // RFC-0092: Dispatch myio:dashboard-state to notify FOOTER of domain change (clear selection)\r\n            LogHelper.log(`[MENU] Dispatching myio:dashboard-state for domain: temperature`);\r\n            window.dispatchEvent(\r\n              new CustomEvent('myio:dashboard-state', {\r\n                detail: {\r\n                  domain: 'temperature',\r\n                  stateId: targetStateId,\r\n                  ts: Date.now(),\r\n                },\r\n              })\r\n            );\r\n\r\n            LogHelper.log(`[MENU] RFC-0092: Switched to temperature state: ${targetStateId}`);\r\n          }\r\n        }\r\n      };\r\n    });\r\n\r\n    // 5. FECHAR AO CLICAR NO FUNDO\r\n    tempModal.onclick = function (e) {\r\n      if (e.target === tempModal) {\r\n        tempModal.style.display = 'none';\r\n      }\r\n    };\r\n\r\n    LogHelper.log('[SETUP] RFC-0092: Temperature Modal setup complete');\r\n  }, 1200);\r\n\r\n  const originalDestroy = self.onDestroy;\r\n  self.onDestroy = function () {\r\n    if (originalDestroy) originalDestroy();\r\n\r\n    // Remove o modal do body se ele existir l√°\r\n    const modal = document.getElementById('energyContextModal');\r\n    if (modal && modal.parentNode === document.body) {\r\n      document.body.removeChild(modal);\r\n    }\r\n\r\n    // RFC-0087: Remove water modal from body\r\n    const waterModal = document.getElementById('waterContextModal');\r\n    if (waterModal && waterModal.parentNode === document.body) {\r\n      document.body.removeChild(waterModal);\r\n    }\r\n\r\n    // RFC-0092: Remove temperature modal from body\r\n    const tempModal = document.getElementById('temperatureContextModal');\r\n    if (tempModal && tempModal.parentNode === document.body) {\r\n      document.body.removeChild(tempModal);\r\n    }\r\n  };\r\n\r\n  // ==============================================================\r\n  // FIX VISUAL FINAL: GERENTE DE ABAS (Vers√£o Agressiva)\r\n  // Garante limpeza total antes de selecionar\r\n  // Coloque no FINAL do self.onInit\r\n  // ==============================================================\r\n\r\n  const energyStates = ['content_equipments', 'content_energy', 'content_store'];\r\n  // RFC-0087: Water states for tab highlighting\r\n  const waterStates = ['content_water', 'content_water_common_area', 'content_water_stores'];\r\n  // RFC-0092: Temperature states for tab highlighting\r\n  const temperatureStates = ['content_temperature', 'content_temperature_sensors', 'content_temperature_sensors_external'];\r\n\r\n  window.addEventListener('myio:switch-main-state', (ev) => {\r\n    const targetId = ev.detail?.targetStateId;\r\n    if (!targetId) return;\r\n\r\n    LogHelper.log(`[TABS] Atualizando abas para: ${targetId}`);\r\n\r\n    // 1. LIMPEZA TOTAL (T√°tica Agressiva)\r\n    // Busca TODOS os elementos com a classe .tab dentro da barra de navega√ß√£o\r\n    const allTabs = document.querySelectorAll('.myio-tabs .tab');\r\n\r\n    // Remove a classe 'is-active' de TODOS eles sem exce√ß√£o\r\n    allTabs.forEach((tab) => {\r\n      tab.classList.remove('is-active');\r\n    });\r\n\r\n    // 2. SELECIONA OS BOT√ïES ESPEC√çFICOS\r\n    const btnEnergy = document.getElementById('energyButton');\r\n    const btnWater = document.getElementById('waterButton');\r\n    const btnTemp = document.getElementById('temperatureButton');\r\n\r\n    // 3. ACENDE APENAS O CORRETO\r\n    if (energyStates.includes(targetId)) {\r\n      if (btnEnergy) btnEnergy.classList.add('is-active');\r\n    } else if (waterStates.includes(targetId)) {\r\n      // RFC-0087: Highlight water button for any water state\r\n      if (btnWater) btnWater.classList.add('is-active');\r\n    } else if (temperatureStates.includes(targetId)) {\r\n      // RFC-0092: Highlight temperature button for any temperature state\r\n      if (btnTemp) btnTemp.classList.add('is-active');\r\n    }\r\n  });\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  // 1) SEMPRE reconstr√≥i customers a partir do self.ctx.data atual\r\n  computeCustomersFromCtx();\r\n\r\n  // 2) O restante do fluxo pode continuar limitado por MAX_DATA_REFRESHES\r\n  if (_dataRefreshCount >= MAX_DATA_REFRESHES) return;\r\n  _dataRefreshCount++;\r\n};\r\n\r\nself.onDestroy = function () {\r\n  /* nada a limpar */\r\n  if (self._onDateParams) {\r\n    window.removeEventListener('myio:date-params', self._onDateParams);\r\n  }\r\n\r\n  // FIX 3: Remove listener de troca de estado\r\n  if (self._onSwitchState) {\r\n    window.removeEventListener('myio:switch-main-state', self._onSwitchState);\r\n  }\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Settings\",\r\n    \"properties\": {\r\n      \"tabSelecionadoBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Tab Ativo - Background Color\",\r\n        \"default\": \"#2F5848\"\r\n      },\r\n      \"tabSelecionadoFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Tab Ativo - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      },\r\n      \"tabNaoSelecionadoBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Tab Inativo - Background Color\",\r\n        \"default\": \"#FFFFFF\"\r\n      },\r\n      \"tabNaoSelecionadoFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Tab Inativo - Font Color\",\r\n        \"default\": \"#1C2743\"\r\n      },\r\n      \"botaoCarregarBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Carregar - Background Color\",\r\n        \"default\": \"#2F5848\"\r\n      },\r\n      \"botaoCarregarFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Carregar - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      },\r\n      \"botaoLimparBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Limpar - Background Color\",\r\n        \"default\": \"#FFFFFF\"\r\n      },\r\n      \"botaoLimparFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Limpar - Font Color\",\r\n        \"default\": \"#1C2743\"\r\n      },\r\n      \"botaoMetasBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Metas - Background Color\",\r\n        \"default\": \"#6a1b9a\"\r\n      },\r\n      \"botaoMetasFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Botao Metas - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      }\r\n    },\r\n    \"required\": []\r\n  },\r\n  \"form\": [\r\n    {\r\n      \"key\": \"tabSelecionadoBackgroundColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"tabSelecionadoFontColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"tabNaoSelecionadoBackgroundColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"tabNaoSelecionadoFontColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoCarregarBackgroundColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoCarregarFontColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoLimparBackgroundColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoLimparFontColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoMetasBackgroundColor\",\r\n      \"type\": \"color\"\r\n    },\r\n    {\r\n      \"key\": \"botaoMetasFontColor\",\r\n      \"type\": \"color\"\r\n    }\r\n  ]\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - MENU - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "d92ba4e0-c978-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}