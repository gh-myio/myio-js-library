{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_temperature_sensors_v_5_2_0",
    "name": "Widget Head Office - TEMPERATURE SENSORS - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js"
        },
        {
          "url": "https://unpkg.com/myio-js-library@0.1.180/dist/myio-js-library.umd.min.js"
        }
      ],
      "templateHtml": "<div class=\"temp-sensors-wrap\" id=\"tempSensorsWrap\">\r\n  <!-- RFC-0092: Sub-menu removed - now controlled by MENU widget -->\r\n\r\n  <div class=\"toolbar-zoom\">\r\n    <div class=\"shopping-filter-chips\" id=\"tempShoppingFilterChips\"></div>\r\n  </div>\r\n\r\n  <!-- Temperature Sensors Statistics Header -->\r\n  <div class=\"temp-sensors-stats-header\" id=\"tempSensorsStatsHeader\">\r\n    <div class=\"stat-item\">\r\n      <span class=\"stat-label\">Total de Sensores</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsTotal\">-</span>\r\n    </div>\r\n    <div class=\"stat-item highlight\">\r\n      <span class=\"stat-label\">Temperatura M√©dia</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsAvg\">-</span>\r\n    </div>\r\n    <div class=\"stat-item\">\r\n      <span class=\"stat-label\">Sensores Online</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsOnline\">-</span>\r\n    </div>\r\n    <div class=\"stat-item alert\">\r\n      <span class=\"stat-label\">Alertas</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsAlert\">-</span>\r\n    </div>\r\n\r\n    <!-- Filter Actions -->\r\n    <div class=\"filter-actions\">\r\n      <div class=\"search-wrap\" id=\"tempSearchWrap\">\r\n        <input type=\"text\" id=\"tempSensorSearch\" placeholder=\"Buscar sensor...\" autocomplete=\"off\" />\r\n      </div>\r\n      <button class=\"icon-btn\" id=\"btnTempSearch\" title=\"Buscar\" aria-label=\"Buscar\">\r\n        <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" aria-hidden=\"true\">\r\n          <path\r\n            d=\"M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z\"\r\n          />\r\n        </svg>\r\n      </button>\r\n      <button class=\"icon-btn\" id=\"btnTempFilter\" title=\"Filtros\" aria-label=\"Filtros\">\r\n        <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" aria-hidden=\"true\">\r\n          <path d=\"M3 4h18l-7 8v6l-4 2v-8L3 4z\" />\r\n        </svg>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Loading overlay -->\r\n  <div id=\"temperature-sensors-loading-overlay\" class=\"temp-sensors-loading-overlay\" style=\"display: none\">\r\n    <div class=\"loading-spinner\">\r\n      <svg style=\"width: 48px; height: 48px; animation: spin 1s linear infinite\" viewBox=\"0 0 50 50\">\r\n        <circle\r\n          cx=\"25\"\r\n          cy=\"25\"\r\n          r=\"20\"\r\n          fill=\"none\"\r\n          stroke=\"#e65100\"\r\n          stroke-width=\"5\"\r\n          stroke-linecap=\"round\"\r\n          stroke-dasharray=\"90,150\"\r\n          stroke-dashoffset=\"0\"\r\n        ></circle>\r\n      </svg>\r\n      <p>Carregando sensores de temperatura...</p>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Sensors Grid -->\r\n  <section class=\"temp-sensors-grid-container\" id=\"tempSensorsGridContainer\">\r\n    <div id=\"temp-sensors-grid\" class=\"temp-sensors-grid\"></div>\r\n  </section>\r\n\r\n  <!-- RFC-0096: Shops list for card rendering (following STORES pattern) -->\r\n  <section id=\"shopsList\" class=\"shops-list\"></section>\r\n</div>\r\n",
      "templateCss": "/* ====== RFC-0092: TEMPERATURE_SENSORS Widget Styles ====== */\r\n\r\n/* ====== TOKENS (scoped to wrap) ====== */\r\n.temp-sensors-wrap {\r\n  /* Global font scale */\r\n  --fs: 0.94;\r\n\r\n  /* Colors and layout */\r\n  --card-grad: linear-gradient(180deg, #ffffff 0%, #fff8f0 100%);\r\n  --card-bd: #ffe0b2;\r\n  --ink-1: #1c2743;\r\n  --ink-2: #6b7a90;\r\n  --orange: #e65100;\r\n  --orange-light: #ff9800;\r\n  --accent: #ff5722;\r\n  --success: #4caf50;\r\n  --warning: #ff9800;\r\n  --danger: #f44336;\r\n  --cold: #2196f3;\r\n  --shadow: 0 8px 24px rgba(230, 81, 0, 0.08);\r\n  --shadow-hover: 0 14px 36px rgba(230, 81, 0, 0.16);\r\n  --radius: 20px;\r\n\r\n  /* Typography derived from scale */\r\n  --fs-2xs: calc(11px * var(--fs));\r\n  --fs-xs: calc(12px * var(--fs));\r\n  --fs-sm: calc(13px * var(--fs));\r\n  --fs-md: calc(14px * var(--fs));\r\n  --fs-lg: calc(16px * var(--fs));\r\n  --fs-xl: calc(20px * var(--fs));\r\n  --fs-xxl: calc(28px * var(--fs));\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  box-sizing: border-box;\r\n  padding: 12px;\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow: auto;\r\n  background: transparent;\r\n}\r\n\r\n/* ====== TEMPERATURE SENSORS STATISTICS HEADER ====== */\r\n.temp-sensors-wrap > .temp-sensors-stats-header,\r\n#tempSensorsStatsHeader {\r\n  display: flex !important;\r\n  flex-direction: row !important;\r\n  flex-wrap: nowrap !important;\r\n  gap: 16px;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);\r\n  border: 1px solid #ffcc80;\r\n  border-radius: 12px;\r\n  padding: 10px 16px;\r\n  margin-bottom: 32px;\r\n  padding-bottom: 16px;\r\n  border-bottom: 3px solid #ffb74d;\r\n  box-shadow: 0 4px 12px rgba(230, 81, 0, 0.06);\r\n  width: 100%;\r\n}\r\n\r\n.temp-sensors-wrap > .temp-sensors-stats-header .stat-item,\r\n#tempSensorsStatsHeader .stat-item {\r\n  display: flex !important;\r\n  flex-direction: column !important;\r\n  gap: 2px;\r\n  flex: 1;\r\n  min-width: 0;\r\n  text-align: center;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.highlight {\r\n  background: linear-gradient(135deg, #ffecb3 0%, #ffe082 100%);\r\n  border-radius: 8px;\r\n  padding: 6px 12px;\r\n  border: 1px solid #ffc107;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.alert {\r\n  background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);\r\n  border-radius: 8px;\r\n  padding: 6px 12px;\r\n  border: 1px solid #e57373;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-label {\r\n  font-size: var(--fs-xs);\r\n  color: var(--ink-2);\r\n  font-weight: 500;\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.5px;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-value {\r\n  font-size: var(--fs-lg);\r\n  color: var(--ink-1);\r\n  font-weight: 700;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.highlight .stat-value {\r\n  color: #e65100;\r\n  font-size: var(--fs-xl);\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.alert .stat-value {\r\n  color: #c62828;\r\n  font-size: var(--fs-lg);\r\n}\r\n\r\n/* ====== TOOLBAR ZOOM ====== */\r\n.toolbar-zoom {\r\n  position: sticky;\r\n  top: 6px;\r\n  z-index: 2;\r\n  display: flex;\r\n  gap: 6px;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n/* ====== SHOPPING FILTER CHIPS ====== */\r\n.shopping-filter-chips {\r\n  display: flex;\r\n  gap: 6px;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n  flex: 1;\r\n  margin-right: 12px;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);\r\n  border: 1px solid #ffcc80;\r\n  border-radius: 8px;\r\n  padding: 3px 8px;\r\n  font-size: var(--fs-xs);\r\n  color: #e65100;\r\n  font-weight: 500;\r\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\r\n  white-space: nowrap;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip-icon {\r\n  font-size: 10px;\r\n  opacity: 0.7;\r\n}\r\n\r\n/* ====== SENSORS GRID ====== */\r\n.temp-sensors-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n  gap: 16px;\r\n  margin-top: 24px;\r\n}\r\n\r\n.temp-sensors-grid > * {\r\n  min-width: 0;\r\n  width: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* Responsive grid */\r\n@media (min-width: 1920px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(6, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1600px) and (max-width: 1919px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 15px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1280px) and (max-width: 1599px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1024px) and (max-width: 1279px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(4, 1fr);\r\n    gap: 16px;\r\n  }\r\n}\r\n\r\n@media (max-width: 1023px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n    gap: 12px;\r\n  }\r\n}\r\n\r\n/* ====== SENSOR CARD ====== */\r\n.temp-sensor-card {\r\n  position: relative;\r\n  background-color: #fff;\r\n  background-image: var(--card-grad) !important;\r\n  border: 1px solid var(--card-bd);\r\n  border-radius: var(--radius);\r\n  box-shadow: var(--shadow);\r\n  color: var(--ink-1);\r\n  padding: 16px 18px 14px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12px;\r\n  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;\r\n  cursor: pointer;\r\n}\r\n\r\n.temp-sensor-card:hover {\r\n  transform: translateY(-2px);\r\n  box-shadow: var(--shadow-hover);\r\n  border-color: #ffb74d;\r\n}\r\n\r\n/* Status-based card borders */\r\n.temp-sensor-card.status-normal {\r\n  border-left: 4px solid var(--success);\r\n}\r\n\r\n.temp-sensor-card.status-hot {\r\n  border-left: 4px solid var(--danger);\r\n}\r\n\r\n.temp-sensor-card.status-cold {\r\n  border-left: 4px solid var(--cold);\r\n}\r\n\r\n.temp-sensor-card.status-no_info,\r\n.temp-sensor-card.status-offline {\r\n  border-left: 4px solid #bdbdbd;\r\n  opacity: 0.7;\r\n}\r\n\r\n/* ====== SENSOR CARD HEADER ====== */\r\n.temp-sensor-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.temp-sensor-icon {\r\n  width: 40px;\r\n  height: 40px;\r\n  border-radius: 12px;\r\n  background: linear-gradient(135deg, #fff3e0, #ffe0b2);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  font-size: 20px;\r\n}\r\n\r\n.temp-sensor-info {\r\n  flex: 1;\r\n  min-width: 0;\r\n}\r\n\r\n.temp-sensor-name {\r\n  font-weight: 600;\r\n  font-size: var(--fs-md);\r\n  color: var(--ink-1);\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n}\r\n\r\n.temp-sensor-location {\r\n  font-size: var(--fs-xs);\r\n  color: var(--ink-2);\r\n  margin-top: 2px;\r\n}\r\n\r\n.temp-sensor-menu {\r\n  border: none;\r\n  background: transparent;\r\n  font-size: 18px;\r\n  color: var(--ink-2);\r\n  cursor: pointer;\r\n  padding: 4px 8px;\r\n  border-radius: 6px;\r\n}\r\n\r\n.temp-sensor-menu:hover {\r\n  background: #fff3e0;\r\n  color: var(--ink-1);\r\n}\r\n\r\n/* ====== SENSOR VALUE ====== */\r\n.temp-sensor-value {\r\n  text-align: center;\r\n  padding: 8px 0;\r\n}\r\n\r\n.temp-value {\r\n  font-size: var(--fs-xxl);\r\n  font-weight: 800;\r\n  color: var(--orange);\r\n  letter-spacing: 0.5px;\r\n}\r\n\r\n.status-hot .temp-value {\r\n  color: var(--danger);\r\n}\r\n\r\n.status-cold .temp-value {\r\n  color: var(--cold);\r\n}\r\n\r\n.status-no_info .temp-value,\r\n.status-offline .temp-value {\r\n  color: #9e9e9e;\r\n}\r\n\r\n/* ====== STATUS CHIP ====== */\r\n.temp-sensor-status {\r\n  display: flex;\r\n  justify-content: center;\r\n}\r\n\r\n.status-chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  padding: 4px 12px;\r\n  border-radius: 999px;\r\n  font-size: var(--fs-xs);\r\n  font-weight: 600;\r\n}\r\n\r\n.status-chip.status-normal {\r\n  background: #e8f5e9;\r\n  color: #2e7d32;\r\n}\r\n\r\n.status-chip.status-hot {\r\n  background: #ffebee;\r\n  color: #c62828;\r\n}\r\n\r\n.status-chip.status-cold {\r\n  background: #e3f2fd;\r\n  color: #1565c0;\r\n}\r\n\r\n.status-chip.status-no_info,\r\n.status-chip.status-offline {\r\n  background: #f5f5f5;\r\n  color: #757575;\r\n}\r\n\r\n.status-dot {\r\n  width: 8px;\r\n  height: 8px;\r\n  border-radius: 50%;\r\n  background: currentColor;\r\n}\r\n\r\n/* ====== SENSOR FOOTER ====== */\r\n.temp-sensor-footer {\r\n  text-align: center;\r\n  padding-top: 8px;\r\n  border-top: 1px solid #ffe0b2;\r\n}\r\n\r\n.temp-sensor-updated {\r\n  font-size: var(--fs-2xs);\r\n  color: var(--ink-2);\r\n}\r\n\r\n/* ====== EMPTY STATE ====== */\r\n.temp-sensors-empty {\r\n  grid-column: 1 / -1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 60px 20px;\r\n  text-align: center;\r\n}\r\n\r\n.temp-sensors-empty .empty-icon {\r\n  font-size: 64px;\r\n  margin-bottom: 16px;\r\n  opacity: 0.5;\r\n}\r\n\r\n.temp-sensors-empty .empty-text {\r\n  font-size: var(--fs-lg);\r\n  color: var(--ink-2);\r\n}\r\n\r\n/* ====== LOADING OVERLAY ====== */\r\n.temp-sensors-loading-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(255, 255, 255, 0.95);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n  backdrop-filter: blur(4px);\r\n}\r\n\r\n.loading-spinner {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 16px;\r\n}\r\n\r\n.loading-spinner p {\r\n  font-size: var(--fs-md);\r\n  font-weight: 600;\r\n  color: var(--ink-1);\r\n  margin: 0;\r\n}\r\n\r\n@keyframes spin {\r\n  0% {\r\n    transform: rotate(0deg);\r\n  }\r\n  100% {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* ====== FILTER ACTIONS ====== */\r\n.filter-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n  margin-left: auto;\r\n}\r\n\r\n.search-wrap {\r\n  position: relative;\r\n  width: 0;\r\n  overflow: hidden;\r\n  transition: width 0.3s ease;\r\n}\r\n\r\n.search-wrap.active {\r\n  width: 200px;\r\n}\r\n\r\n.search-wrap input {\r\n  width: 100%;\r\n  padding: 6px 12px;\r\n  border: 1px solid var(--card-bd);\r\n  border-radius: 8px;\r\n  font-size: var(--fs-sm);\r\n  outline: none;\r\n}\r\n\r\n.search-wrap input:focus {\r\n  border-color: var(--orange);\r\n  box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);\r\n}\r\n\r\n.icon-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  border: 1px solid var(--card-bd);\r\n  background: #fff;\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.icon-btn:hover {\r\n  background: #fff3e0;\r\n  border-color: var(--orange);\r\n}\r\n\r\n.icon-btn svg {\r\n  fill: var(--ink-1);\r\n}\r\n\r\n/* ====== RFC-0096: SHOPS LIST (following STORES pattern) ====== */\r\n.temp-sensors-wrap .shops-list {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n  gap: 16px;\r\n  margin-top: 24px;\r\n  padding-bottom: 100px;\r\n}\r\n\r\n.temp-sensors-wrap .shops-list > * {\r\n  min-width: 0;\r\n  width: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* Responsive grid - matching STORES */\r\n@media (min-width: 1920px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(6, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1600px) and (max-width: 1919px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 15px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1280px) and (max-width: 1599px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1024px) and (max-width: 1279px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(4, 1fr);\r\n    gap: 16px;\r\n  }\r\n}\r\n\r\n@media (max-width: 1023px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n    gap: 12px;\r\n  }\r\n}\r\n\r\n/* ====== SCROLLBAR ====== */\r\n.temp-sensors-wrap .shops-list::-webkit-scrollbar {\r\n  width: 8px;\r\n}\r\n\r\n.temp-sensors-wrap .shops-list::-webkit-scrollbar-thumb {\r\n  background: #c9d4e2;\r\n  border-radius: 6px;\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary, $ */\r\n\r\n/**\r\n * RFC-0092: TEMPERATURE_SENSORS Widget Controller\r\n *\r\n * Displays temperature sensor cards in an EQUIPMENTS-style grid layout.\r\n * Fetches sensor data from ThingsBoard API and supports shopping filter synchronization.\r\n */\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log(...args),\r\n  warn: (...args) => console.warn(...args),\r\n  error: (...args) => console.error(...args),\r\n};\r\n\r\nconst formatRelativeTime =\r\n  window.MyIOUtils?.formatRelativeTime || ((ts) => (ts ? new Date(ts).toLocaleString() : '‚Äî'));\r\n\r\nconst getCustomerNameForDevice =\r\n  window.MyIOUtils?.getCustomerNameForDevice ||\r\n  ((device) => device.customerName || device.customerId || 'N/A');\r\n\r\n// ============================================\r\n// TEMPERATURE_SENSORS WIDGET STATE\r\n// ============================================\r\nconst STATE = {\r\n  allSensors: [],\r\n  searchActive: false,\r\n  searchTerm: '',\r\n  selectedIds: null,\r\n  sortMode: 'temp_desc',\r\n  selectedShoppingIds: [],\r\n  totalShoppings: 0,\r\n  isLoading: true,\r\n};\r\n\r\nconst WIDGET_DOMAIN = 'temperature'; // Will be set in onInit\r\n\r\n// Card rendering options (from settings, with defaults)\r\nlet USE_NEW_COMPONENTS = true;\r\nlet ENABLE_SELECTION = true;\r\nlet HIDE_INFO_MENU_ITEM = true;\r\nlet DEBUG_ACTIVE = false;\r\nlet ACTIVE_TOOLTIP_DEBUG = false;\r\n\r\nLogHelper.log('[TEMPERATURE_SENSORS] Script loaded, using shared utilities:', !!window.MyIOUtils);\r\n\r\n// ============================================\r\n// UTILITY FUNCTIONS\r\n// ============================================\r\n\r\nfunction formatTemperature(value) {\r\n  if (value === null || value === undefined || isNaN(value)) return '‚Äî';\r\n  return `${Number(value).toFixed(1)}¬∞C`;\r\n}\r\n\r\nfunction getTemperatureStatus(temp, min = 18, max = 26) {\r\n  if (temp === null || temp === undefined || isNaN(temp)) return 'no_info';\r\n  if (temp < min) return 'cold';\r\n  if (temp > max) return 'hot';\r\n  return 'normal';\r\n}\r\n\r\nfunction getStatusLabel(status) {\r\n  const labels = {\r\n    normal: 'Normal',\r\n    cold: 'Frio',\r\n    hot: 'Quente',\r\n    no_info: 'Sem Dados',\r\n    offline: 'Offline',\r\n  };\r\n  return labels[status] || status;\r\n}\r\n\r\nfunction showLoadingOverlay(show) {\r\n  const overlay = document.getElementById('temperature-sensors-loading-overlay');\r\n  if (overlay) {\r\n    overlay.style.display = show ? 'flex' : 'none';\r\n  }\r\n}\r\n\r\n// ============================================\r\n// CARD RENDERING\r\n// ============================================\r\n\r\nfunction initializeSensorCards(sensors) {\r\n  const grid = document.getElementById('temp-sensors-grid');\r\n  if (!grid) {\r\n    LogHelper.error('[TEMPERATURE_SENSORS] Grid element not found');\r\n    return;\r\n  }\r\n\r\n  grid.innerHTML = '';\r\n\r\n  if (sensors.length === 0) {\r\n    grid.innerHTML = `\r\n      <div class=\"temp-sensors-empty\">\r\n        <div class=\"empty-icon\">üå°Ô∏è</div>\r\n        <div class=\"empty-text\">Nenhum sensor de temperatura encontrado</div>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  sensors.forEach((sensor) => {\r\n    const container = document.createElement('div');\r\n    grid.appendChild(container);\r\n\r\n    // Verifica se a biblioteca existe\r\n    if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.renderCardComponentHeadOffice) {\r\n      // --- L√ìGICA DE STATUS CORRIGIDA ---\r\n      // 1. Define constantes que a biblioteca ENTENDE (running/no_info)\r\n      const STATUS_ONLINE = window.MyIOLibrary?.DeviceStatusType?.POWER_ON || 'running';\r\n      const STATUS_OFFLINE = window.MyIOLibrary?.DeviceStatusType?.NO_INFO || 'no_info';\r\n\r\n      // 2. Se tem temperatura v√°lida, for√ßamos o status para ONLINE (Verde)\r\n      // Isso evita mandar 'normal'/'hot' que a lib n√£o reconhece e joga para Offline\r\n      const visualStatus =\r\n        sensor.temperature !== null && sensor.temperature !== undefined ? STATUS_ONLINE : STATUS_OFFLINE;\r\n\r\n      const entityObject = {\r\n        entityId: sensor.id,\r\n        id: sensor.id, // Alias para FOOTER\r\n        tbId: sensor.id, // ThingsBoard ID\r\n        labelOrName: sensor.label || sensor.name,\r\n        name: sensor.label || sensor.name, // Para o FOOTER mostrar no chip\r\n        label: sensor.label || sensor.name,\r\n        deviceIdentifier: sensor.identifier || 'TEMP-SENSOR',\r\n\r\n        // Dados de valor\r\n        val: sensor.temperature,\r\n        lastValue: sensor.temperature, // Para o FOOTER mostrar no chip\r\n        valType: 'temperature',\r\n        unit: '¬∞C', // Para o FOOTER mostrar a unidade\r\n        icon: 'temperature', // Para o FOOTER detectar o tipo de unidade\r\n        deviceType: 'TEMPERATURE_SENSOR',\r\n        temperatureC: sensor.temperature,\r\n        currentTemperature: sensor.temperature, // Para o card mostrar temperatura atual\r\n\r\n        // Dados de Cliente\r\n        customerName: sensor.customerName,\r\n        customerTitle: sensor.customerName, // Alias para compara√ß√£o\r\n        customerId: sensor.customerId,\r\n        updated: formatRelativeTime(sensor.lastUpdate),\r\n        // lastActivityTime √© timestamp UTC de quando a √∫ltima telemetria foi enviada\r\n        lastActivityTime: sensor.lastActivityTime,\r\n        domain: WIDGET_DOMAIN,\r\n\r\n        // Ranges de temperatura (padr√£o: temperatureMin/temperatureMax)\r\n        temperatureMin: sensor.temperatureMin,\r\n        temperatureMax: sensor.temperatureMax,\r\n\r\n        // Dados de conex√£o\r\n        centralName: sensor.centralName,\r\n        identifier: sensor.identifier,\r\n        connectionStatus: sensor.connectionStatus,\r\n        lastConnectTime: sensor.lastConnectTime || sensor.lastUpdate,\r\n        lastDisconnectTime: sensor.lastDisconnectTime,\r\n\r\n        // --- CORRE√á√ÉO VISUAL ---\r\n        // Aqui usamos o status 'traduzido' (running) em vez de sensor.status (normal)\r\n        deviceStatus: visualStatus,\r\n      };\r\n\r\n      MyIOLibrary.renderCardComponentHeadOffice(container, {\r\n        entityObject: entityObject,\r\n        debugActive: DEBUG_ACTIVE,\r\n        activeTooltipDebug: ACTIVE_TOOLTIP_DEBUG,\r\n        delayTimeConnectionInMins: window.MyIOUtils?.getDelayTimeConnectionInMins?.() ?? 60,\r\n        handleActionDashboard: async () => {\r\n          openTemperatureModal(sensor);\r\n        },\r\n        handleActionSettings: async () => {\r\n          // RFC-0092: Settings handler para sensores de temperatura\r\n          const jwt = localStorage.getItem('jwt_token');\r\n\r\n          if (!jwt) {\r\n            LogHelper.error('[TEMPERATURE_SENSORS] JWT token not found');\r\n            window.alert('Token de autentica√ß√£o n√£o encontrado');\r\n            return;\r\n          }\r\n\r\n          const tbId = sensor.id;\r\n          if (!tbId) {\r\n            window.alert('ID do dispositivo inv√°lido');\r\n            return;\r\n          }\r\n\r\n          try {\r\n            // Usa openDashboardPopupSettings se dispon√≠vel\r\n            if (MyIOLibrary.openDashboardPopupSettings) {\r\n              await MyIOLibrary.openDashboardPopupSettings({\r\n                deviceId: tbId,\r\n                label: sensor.label || sensor.name,\r\n                jwtToken: jwt,\r\n                domain: WIDGET_DOMAIN,\r\n                deviceType: sensor.deviceType || 'TERMOSTATO',\r\n                deviceProfile: sensor.deviceProfile || 'TERMOSTATO',\r\n                customerId: sensor.customerId,\r\n                customerName: sensor.customerName,\r\n                centralName: sensor.centralName,\r\n                identifier: sensor.identifier,\r\n                // Temperature specific\r\n                temperatureMin: sensor.temperatureMin,\r\n                temperatureMax: sensor.temperatureMax,\r\n                theme: 'light',\r\n                connectionData: {\r\n                  centralName: sensor.centralName || getCustomerNameForDevice(sensor),\r\n                  connectionStatusTime: sensor.lastConnectTime,\r\n                  timeVal: sensor.lastActivityTime || new Date('1970-01-01').getTime(),\r\n                  deviceStatus:\r\n                    sensor.deviceStatus !== 'power_off' && sensor.deviceStatus !== 'not_installed'\r\n                      ? 'power_on'\r\n                      : 'power_off',\r\n                  lastDisconnectTime: sensor.lastDisconnectTime || 0,\r\n                },\r\n                ui: { title: 'Configura√ß√µes', width: 900 },\r\n                onSaved: (payload) => {\r\n                  LogHelper.log('[EQUIPMENTS] [RFC-0072] Settings saved:', payload);\r\n                },\r\n                onClose: () => {\r\n                  $('.myio-settings-modal-overlay').remove();\r\n                  const overlay = document.querySelector('.myio-modal-overlay');\r\n                  if (overlay) {\r\n                    overlay.remove();\r\n                  }\r\n                  LogHelper.log('[EQUIPMENTS] [RFC-0072] Settings modal closed');\r\n                },\r\n              });\r\n            } else {\r\n              LogHelper.warn('[TEMPERATURE_SENSORS] openDashboardPopupSettings not available');\r\n              window.alert('Configura√ß√µes n√£o dispon√≠veis');\r\n            }\r\n          } catch (error) {\r\n            LogHelper.error('[TEMPERATURE_SENSORS] Error opening settings:', error);\r\n            window.alert('Erro ao abrir configura√ß√µes: ' + error.message);\r\n          }\r\n        },\r\n        handleSelect: (checked, entity) => {\r\n          const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\r\n          if (MyIOSelectionStore) {\r\n            if (checked) {\r\n              if (MyIOSelectionStore.registerEntity) {\r\n                MyIOSelectionStore.registerEntity(entity);\r\n              }\r\n              MyIOSelectionStore.add(entity.entityId || entity.id);\r\n            } else {\r\n              MyIOSelectionStore.remove(entity.entityId || entity.id);\r\n            }\r\n          }\r\n        },\r\n        handleClickCard: (ev, entity) => {\r\n          LogHelper.log(`[TEMPERATURE_SENSORS] Card clicked: ${entity.labelOrName}`);\r\n        },\r\n        useNewComponents: USE_NEW_COMPONENTS,\r\n        enableSelection: ENABLE_SELECTION,\r\n        hideInfoMenuItem: HIDE_INFO_MENU_ITEM,\r\n      });\r\n    } else {\r\n      // Fallback para card customizado\r\n      renderCustomSensorCard(container, sensor);\r\n    }\r\n  });\r\n\r\n  LogHelper.log('[TEMPERATURE_SENSORS] Rendered', sensors.length, 'sensor cards');\r\n}\r\n\r\nfunction renderCustomSensorCard(container, sensor) {\r\n  const statusClass = `status-${sensor.status}`;\r\n  const statusLabel = getStatusLabel(sensor.status);\r\n\r\n  container.innerHTML = `\r\n    <div class=\"temp-sensor-card ${statusClass}\">\r\n      <div class=\"temp-sensor-header\">\r\n        <div class=\"temp-sensor-icon\">üå°Ô∏è</div>\r\n        <div class=\"temp-sensor-info\">\r\n          <div class=\"temp-sensor-name\">${sensor.label || sensor.name}</div>\r\n          <div class=\"temp-sensor-location\">${sensor.customerName || 'N/A'}</div>\r\n        </div>\r\n        <button class=\"temp-sensor-menu\" title=\"Op√ß√µes\">‚ãÆ</button>\r\n      </div>\r\n      <div class=\"temp-sensor-value\">\r\n        <span class=\"temp-value\">${formatTemperature(sensor.temperature)}</span>\r\n      </div>\r\n      <div class=\"temp-sensor-status\">\r\n        <span class=\"status-chip ${statusClass}\">\r\n          <span class=\"status-dot\"></span>\r\n          ${statusLabel}\r\n        </span>\r\n      </div>\r\n      <div class=\"temp-sensor-footer\">\r\n        <span class=\"temp-sensor-updated\">Atualizado: ${formatRelativeTime(sensor.lastUpdate)}</span>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  // Add click handler\r\n  container.querySelector('.temp-sensor-card').addEventListener('click', () => {\r\n    openTemperatureModal(sensor);\r\n  });\r\n}\r\n\r\nasync function openTemperatureModal(sensor) {\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.openTemperatureComparisonModal) {\r\n    const token = localStorage.getItem('jwt_token');\r\n    if (!token) {\r\n      LogHelper.error('[TEMPERATURE_SENSORS] JWT token not found');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Get date range from global state or use defaults\r\n      const dateRange = window.myioDateRange || {};\r\n      const now = new Date();\r\n      const startDate = dateRange.startDate || new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();\r\n      const endDate = dateRange.endDate || now.toISOString();\r\n\r\n      await MyIOLibrary.openTemperatureComparisonModal({\r\n        token: token,\r\n        devices: [\r\n          {\r\n            id: sensor.tbId || sensor.id,\r\n            label: sensor.label || sensor.name,\r\n            customerName: sensor.customerName,\r\n            temperatureMin: sensor.temperatureMin || 18,\r\n            temperatureMax: sensor.temperatureMax || 26,\r\n          },\r\n        ],\r\n        startDate: startDate,\r\n        endDate: endDate,\r\n        locale: 'pt-BR',\r\n        theme: 'dark',\r\n        onClose: () => {\r\n          LogHelper.log('[TEMPERATURE_SENSORS] Temperature modal closed');\r\n        },\r\n      });\r\n    } catch (error) {\r\n      LogHelper.error('[TEMPERATURE_SENSORS] Error opening temperature modal:', error);\r\n    }\r\n  } else {\r\n    LogHelper.warn('[TEMPERATURE_SENSORS] openTemperatureComparisonModal not available');\r\n    window.alert('Modal de temperatura n√£o dispon√≠vel');\r\n  }\r\n}\r\n\r\n// ============================================\r\n// DATA FETCHING\r\n// ============================================\r\n\r\nasync function fetchTemperatureSensors() {\r\n  LogHelper.log('[TEMPERATURE_SENSORS] Fetching temperature sensors...');\r\n  STATE.isLoading = true;\r\n  showLoadingOverlay(true);\r\n\r\n  try {\r\n    const sensors = [];\r\n\r\n    // Method 1: Try to get sensors from ctx.data (ThingsBoard datasources)\r\n    if (self.ctx && self.ctx.data) {\r\n      self.ctx.data.forEach((data) => {\r\n        // Ignora dados do Alias \"Shopping\" se houver\r\n        if (data.datasource && data.datasource.aliasName !== 'Shopping') {\r\n          const entityId = data.datasource.entity?.id?.id;\r\n\r\n          if (entityId) {\r\n            // 1. Tenta encontrar o sensor j√° criado na lista\r\n            let existingSensor = sensors.find((s) => s.id === entityId);\r\n\r\n            // 2. Se n√£o existir, cria o esqueleto inicial e adiciona ao array\r\n            if (!existingSensor) {\r\n              existingSensor = {\r\n                id: entityId,\r\n                tbId: entityId,\r\n                name: data.datasource.name,\r\n                label: data.datasource.entityLabel || data.datasource.name,\r\n                temperature: null,\r\n                lastUpdate: null,\r\n                customerId: data.datasource.customerId || null,\r\n                customerName: 'N/A', // Inicializa com N/A\r\n                status: 'no_info',\r\n                temperatureMin: 18,\r\n                temperatureMax: 26,\r\n              };\r\n              sensors.push(existingSensor);\r\n            }\r\n\r\n            // 3. Verifica qual √© a chave de dados atual e atualiza o campo correspondente\r\n            const keyName = data.dataKey?.name;\r\n            const value = data.data?.[0]?.[1];\r\n            const ts = data.data?.[0]?.[0];\r\n\r\n            if (keyName === 'temperature') {\r\n              existingSensor.temperature = value || existingSensor.temperature;\r\n              existingSensor.lastUpdate = ts || existingSensor.lastUpdate;\r\n              existingSensor.status = getTemperatureStatus(existingSensor.temperature);\r\n            } else if (keyName === 'ownerName') {\r\n              // [CORRE√á√ÉO] Agora o c√≥digo consegue entrar aqui\r\n              if (value) {\r\n                existingSensor.customerName = value;\r\n              }\r\n            } else if (keyName === 'lastActivityTime') {\r\n              // Timestamp UTC da √∫ltima telemetria enviada pelo dispositivo\r\n              existingSensor.lastActivityTime = value || existingSensor.lastActivityTime;\r\n            } else if (keyName === 'name') {\r\n              existingSensor.name = value || existingSensor.name;\r\n            } else if (keyName === 'label') {\r\n              existingSensor.label = value || existingSensor.label;\r\n            } else if (keyName === 'identifier') {\r\n              existingSensor.identifier = value || existingSensor.identifier;\r\n            } else if (keyName === 'centralName') {\r\n              existingSensor.centralName = value || existingSensor.centralName;\r\n            } else if (keyName === 'connectionStatus') {\r\n              existingSensor.connectionStatus = value || existingSensor.connectionStatus;\r\n            } else if (keyName === 'lastConnectTime') {\r\n              existingSensor.lastConnectTime = value || existingSensor.lastConnectTime;\r\n            } else if (keyName === 'lastDisconnectTime') {\r\n              existingSensor.lastDisconnectTime = value || existingSensor.lastDisconnectTime;\r\n            }\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    // Method 2: If no sensors from ctx.data, try API fetch\r\n    if (sensors.length === 0) {\r\n      LogHelper.log('[TEMPERATURE_SENSORS] No sensors in ctx.data, trying API...');\r\n      const apiSensors = await fetchSensorsFromAPI();\r\n      sensors.push(...apiSensors);\r\n    }\r\n\r\n    STATE.allSensors = sensors;\r\n    LogHelper.log('[TEMPERATURE_SENSORS] Loaded', sensors.length, 'sensors');\r\n\r\n    return sensors;\r\n  } catch (error) {\r\n    LogHelper.error('[TEMPERATURE_SENSORS] Error fetching sensors:', error);\r\n    return [];\r\n  } finally {\r\n    STATE.isLoading = false;\r\n    showLoadingOverlay(false);\r\n  }\r\n}\r\n\r\nasync function fetchSensorsFromAPI() {\r\n  const token = localStorage.getItem('jwt_token');\r\n  if (!token) {\r\n    LogHelper.warn('[TEMPERATURE_SENSORS] No JWT token for API fetch');\r\n    return [];\r\n  }\r\n\r\n  try {\r\n    // Busca dispositivos do tipo TEMPERATURE_SENSOR\r\n    const response = await fetch('/api/tenant/devices?pageSize=1000&page=0&type=TEMPERATURE_SENSOR', {\r\n      headers: {\r\n        'X-Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`API error: ${response.status}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    const devices = result.data || [];\r\n\r\n    // Busca √∫ltima telemetria para cada dispositivo e aplica o \"Enrich\"\r\n    const sensors = await Promise.all(\r\n      devices.map(async (device) => {\r\n        try {\r\n          const telemetryResponse = await fetch(\r\n            `/api/plugins/telemetry/DEVICE/${device.id.id}/values/timeseries?keys=temperature`,\r\n            {\r\n              headers: {\r\n                'X-Authorization': `Bearer ${token}`,\r\n                'Content-Type': 'application/json',\r\n              },\r\n            }\r\n          );\r\n\r\n          let temperature = null;\r\n          let lastUpdate = null;\r\n\r\n          if (telemetryResponse.ok) {\r\n            const telemetry = await telemetryResponse.json();\r\n            if (telemetry.temperature && telemetry.temperature.length > 0) {\r\n              temperature = telemetry.temperature[0].value;\r\n              lastUpdate = telemetry.temperature[0].ts;\r\n            }\r\n          }\r\n\r\n          // =========================================================================\r\n          // [FIX] L√ìGICA TIPO \"enrichItemsWithTotals\"\r\n          // Garante recupera√ß√£o robusta de customerId e customerName\r\n          // =========================================================================\r\n\r\n          // 1. Tenta pegar o ID de v√°rias fontes poss√≠veis (fallback)\r\n          const finalCustomerId = device.customerId?.id || device.customer_id || null;\r\n\r\n          // 2. Tenta pegar o Nome de v√°rias fontes poss√≠veis (o TB retorna como customerTitle ou name)\r\n          const finalCustomerName =\r\n            device.customerTitle || device.customerName || device.customer_name || 'N/A';\r\n\r\n          return {\r\n            id: device.id.id,\r\n            tbId: device.id.id,\r\n            name: device.name,\r\n            label: device.label || device.name,\r\n            temperature: temperature,\r\n            lastUpdate: lastUpdate,\r\n\r\n            // [FIX] Usa os valores \"enriquecidos\"\r\n            customerId: finalCustomerId,\r\n            customerName: finalCustomerName,\r\n\r\n            status: getTemperatureStatus(temperature),\r\n            temperatureMin: 18,\r\n            temperatureMax: 26,\r\n          };\r\n        } catch (err) {\r\n          LogHelper.warn('[TEMPERATURE_SENSORS] Error fetching telemetry for device:', device.id.id, err);\r\n\r\n          // [FIX] Mesmo no erro, tentamos garantir os dados do cliente\r\n          const finalCustomerId = device.customerId?.id || null;\r\n          const finalCustomerName = device.customerTitle || 'N/A';\r\n\r\n          return {\r\n            id: device.id.id,\r\n            tbId: device.id.id,\r\n            name: device.name,\r\n            label: device.label || device.name,\r\n            temperature: null,\r\n            lastUpdate: null,\r\n            customerId: finalCustomerId,\r\n            customerName: finalCustomerName,\r\n            status: 'no_info',\r\n            temperatureMin: 18,\r\n            temperatureMax: 26,\r\n          };\r\n        }\r\n      })\r\n    );\r\n\r\n    return sensors;\r\n  } catch (error) {\r\n    LogHelper.error('[TEMPERATURE_SENSORS] API fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// ============================================\r\n// FILTERING & SORTING\r\n// ============================================\r\n\r\nfunction applyFilters(sensors, searchTerm, selectedIds, sortMode) {\r\n  let filtered = sensors.slice();\r\n\r\n  // Apply shopping filter\r\n  if (STATE.selectedShoppingIds && STATE.selectedShoppingIds.length > 0) {\r\n    filtered = filtered.filter((s) => {\r\n      if (!s.customerId) return true;\r\n      return STATE.selectedShoppingIds.includes(s.customerId);\r\n    });\r\n  }\r\n\r\n  // Apply multiselect filter\r\n  if (selectedIds && selectedIds.size > 0) {\r\n    filtered = filtered.filter((s) => selectedIds.has(s.id));\r\n  }\r\n\r\n  // Apply search filter\r\n  const query = (searchTerm || '').trim().toLowerCase();\r\n  if (query) {\r\n    filtered = filtered.filter(\r\n      (s) =>\r\n        String(s.label || '')\r\n          .toLowerCase()\r\n          .includes(query) ||\r\n        String(s.name || '')\r\n          .toLowerCase()\r\n          .includes(query) ||\r\n        String(s.customerName || '')\r\n          .toLowerCase()\r\n          .includes(query)\r\n    );\r\n  }\r\n\r\n  // Apply sorting\r\n  filtered.sort((a, b) => {\r\n    const tempA = Number(a.temperature) || 0;\r\n    const tempB = Number(b.temperature) || 0;\r\n    const nameA = String(a.label || a.name || '').toLowerCase();\r\n    const nameB = String(b.label || b.name || '').toLowerCase();\r\n\r\n    switch (sortMode) {\r\n      case 'temp_desc':\r\n        return tempB !== tempA ? tempB - tempA : nameA.localeCompare(nameB);\r\n      case 'temp_asc':\r\n        return tempA !== tempB ? tempA - tempB : nameA.localeCompare(nameB);\r\n      case 'alpha_asc':\r\n        return nameA.localeCompare(nameB);\r\n      case 'alpha_desc':\r\n        return nameB.localeCompare(nameA);\r\n      default:\r\n        return 0;\r\n    }\r\n  });\r\n\r\n  return filtered;\r\n}\r\n\r\nfunction reflowCards() {\r\n  const filtered = applyFilters(STATE.allSensors, STATE.searchTerm, STATE.selectedIds, STATE.sortMode);\r\n\r\n  LogHelper.log('[TEMPERATURE_SENSORS] Reflow with filters:', {\r\n    total: STATE.allSensors.length,\r\n    filtered: filtered.length,\r\n    searchTerm: STATE.searchTerm,\r\n    sortMode: STATE.sortMode,\r\n  });\r\n\r\n  initializeSensorCards(filtered);\r\n  updateSensorStats(filtered);\r\n}\r\n\r\nfunction updateSensorStats(sensors) {\r\n  const statsTotal = document.getElementById('tempSensorsStatsTotal');\r\n  const statsAvg = document.getElementById('tempSensorsStatsAvg');\r\n  const statsOnline = document.getElementById('tempSensorsStatsOnline');\r\n  const statsAlert = document.getElementById('tempSensorsStatsAlert');\r\n\r\n  if (statsTotal) statsTotal.textContent = sensors.length;\r\n\r\n  // Calculate average temperature\r\n  const validTemps = sensors.filter((s) => s.temperature !== null && !isNaN(s.temperature));\r\n  const avgTemp =\r\n    validTemps.length > 0\r\n      ? validTemps.reduce((sum, s) => sum + Number(s.temperature), 0) / validTemps.length\r\n      : 0;\r\n\r\n  if (statsAvg) statsAvg.textContent = formatTemperature(avgTemp);\r\n\r\n  // Count online sensors (with recent data)\r\n  const onlineCount = sensors.filter((s) => s.status !== 'no_info' && s.status !== 'offline').length;\r\n  if (statsOnline) statsOnline.textContent = onlineCount;\r\n\r\n  // Count alert sensors (hot or cold)\r\n  const alertCount = sensors.filter((s) => s.status === 'hot' || s.status === 'cold').length;\r\n  if (statsAlert) statsAlert.textContent = alertCount;\r\n}\r\n\r\n// ============================================\r\n// EVENT HANDLERS\r\n// ============================================\r\n\r\n// RFC-0096: Filter modal instance (lazy initialized)\r\nlet temperatureFilterModal = null;\r\n\r\n/**\r\n * RFC-0096: Initialize filter modal using shared factory from MAIN\r\n */\r\nfunction initFilterModal() {\r\n  const createFilterModal = window.MyIOUtils?.createFilterModal;\r\n\r\n  if (!createFilterModal) {\r\n    LogHelper.error('[TEMPERATURE_SENSORS] createFilterModal not available from MAIN');\r\n    return null;\r\n  }\r\n\r\n  return createFilterModal({\r\n    widgetName: 'TEMPERATURE_SENSORS',\r\n    containerId: 'temperatureSensorsFilterModalGlobal',\r\n    modalClass: 'temperature-sensors-modal',\r\n    primaryColor: '#e65100', // Orange for temperature\r\n    itemIdAttr: 'data-entity',\r\n\r\n    // Filter tabs configuration - specific for TEMPERATURE_SENSORS\r\n    filterTabs: [\r\n      {\r\n        id: 'all',\r\n        label: 'Todos',\r\n        filter: () => true,\r\n      },\r\n      {\r\n        id: 'online',\r\n        label: 'Online',\r\n        filter: (s) => s.status !== 'no_info' && s.status !== 'offline',\r\n      },\r\n      {\r\n        id: 'offline',\r\n        label: 'Offline',\r\n        filter: (s) => s.status === 'no_info' || s.status === 'offline',\r\n      },\r\n      {\r\n        id: 'normal',\r\n        label: 'Normal',\r\n        filter: (s) => s.status === 'normal',\r\n      },\r\n      {\r\n        id: 'alert',\r\n        label: 'Alerta',\r\n        filter: (s) => s.status === 'hot' || s.status === 'cold',\r\n      },\r\n    ],\r\n\r\n    // Data accessors\r\n    getItemId: (item) => item.id,\r\n    getItemLabel: (item) => item.label || item.name || item.id,\r\n    getItemValue: (item) => item.temperature,\r\n    getItemSubLabel: (item) => getCustomerNameForDevice(item),\r\n    formatValue: (val) => formatTemperature(val),\r\n\r\n    // Callbacks\r\n    onApply: ({ selectedIds, sortMode }) => {\r\n      STATE.selectedIds = selectedIds;\r\n      STATE.sortMode = sortMode;\r\n      reflowCards();\r\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filters applied via shared modal');\r\n    },\r\n\r\n    onReset: () => {\r\n      STATE.selectedIds = null;\r\n      STATE.sortMode = 'temp_desc';\r\n      STATE.searchTerm = '';\r\n      STATE.searchActive = false;\r\n\r\n      // Reset search UI\r\n      const searchWrap = document.getElementById('tempSearchWrap');\r\n      const searchInput = document.getElementById('tempSensorSearch');\r\n      if (searchWrap) searchWrap.classList.remove('active');\r\n      if (searchInput) searchInput.value = '';\r\n\r\n      reflowCards();\r\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filters reset via shared modal');\r\n    },\r\n\r\n    onClose: () => {\r\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filter modal closed');\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * RFC-0096: Open filter modal\r\n */\r\nfunction openFilterModal() {\r\n  // Lazy initialize modal\r\n  if (!temperatureFilterModal) {\r\n    temperatureFilterModal = initFilterModal();\r\n  }\r\n\r\n  if (!temperatureFilterModal) {\r\n    LogHelper.error('[TEMPERATURE_SENSORS] Failed to initialize filter modal');\r\n    window.alert('Erro ao inicializar modal de filtros. Verifique se o widget MAIN foi carregado.');\r\n    return;\r\n  }\r\n\r\n  // Open with current sensors and state\r\n  temperatureFilterModal.open(STATE.allSensors, {\r\n    selectedIds: STATE.selectedIds,\r\n    sortMode: STATE.sortMode,\r\n  });\r\n}\r\n\r\nfunction bindFilterEvents() {\r\n  // Search button toggle\r\n  const btnSearch = document.getElementById('btnTempSearch');\r\n  const searchWrap = document.getElementById('tempSearchWrap');\r\n  const searchInput = document.getElementById('tempSensorSearch');\r\n\r\n  if (btnSearch && searchWrap && searchInput) {\r\n    btnSearch.addEventListener('click', () => {\r\n      STATE.searchActive = !STATE.searchActive;\r\n      searchWrap.classList.toggle('active', STATE.searchActive);\r\n      if (STATE.searchActive) {\r\n        setTimeout(() => searchInput.focus(), 100);\r\n      }\r\n    });\r\n\r\n    searchInput.addEventListener('input', (e) => {\r\n      STATE.searchTerm = e.target.value || '';\r\n      reflowCards();\r\n    });\r\n  }\r\n\r\n  // Filter button - RFC-0096: Now opens filter modal\r\n  const btnFilter = document.getElementById('btnTempFilter');\r\n  if (btnFilter) {\r\n    btnFilter.addEventListener('click', () => {\r\n      LogHelper.log('[TEMPERATURE_SENSORS] Filter button clicked - opening modal');\r\n      openFilterModal();\r\n    });\r\n  }\r\n}\r\n\r\nfunction renderShoppingFilterChips(selection) {\r\n  const chipsContainer = document.getElementById('tempShoppingFilterChips');\r\n  if (!chipsContainer) return;\r\n\r\n  chipsContainer.innerHTML = '';\r\n\r\n  if (!selection || selection.length === 0) {\r\n    return;\r\n  }\r\n\r\n  selection.forEach((shopping) => {\r\n    const chip = document.createElement('span');\r\n    chip.className = 'filter-chip';\r\n    chip.innerHTML = `<span class=\"filter-chip-icon\">üè¨</span><span>${shopping.name}</span>`;\r\n    chipsContainer.appendChild(chip);\r\n  });\r\n\r\n  LogHelper.log('[TEMPERATURE_SENSORS] Rendered', selection.length, 'shopping filter chips');\r\n}\r\n\r\n// ============================================\r\n// WIDGET LIFECYCLE\r\n// ============================================\r\n\r\nself.onInit = async function () {\r\n  LogHelper.log('[TEMPERATURE_SENSORS] onInit - RFC-0092');\r\n\r\n  // Load card rendering options from settings\r\n  USE_NEW_COMPONENTS = self.ctx.settings?.useNewComponents ?? true;\r\n  ENABLE_SELECTION = self.ctx.settings?.enableSelection ?? true;\r\n  HIDE_INFO_MENU_ITEM = self.ctx.settings?.hideInfoMenuItem ?? true;\r\n  DEBUG_ACTIVE = self.ctx.settings?.debugActive ?? false;\r\n  ACTIVE_TOOLTIP_DEBUG = self.ctx.settings?.activeTooltipDebug ?? false;\r\n  LogHelper.log(\r\n    `[TEMPERATURE_SENSORS] Configured: debugActive=${DEBUG_ACTIVE}, activeTooltipDebug=${ACTIVE_TOOLTIP_DEBUG}`\r\n  );\r\n\r\n  showLoadingOverlay(true);\r\n\r\n  setTimeout(async () => {\r\n    // Wait for date params from parent\r\n    function waitForDateParams({ pollMs = 300, timeoutMs = 10000 } = {}) {\r\n      return new Promise((resolve) => {\r\n        let resolved = false;\r\n        let poller = null;\r\n        let timer = null;\r\n\r\n        const tryResolve = (p) => {\r\n          const s = p?.globalStartDateFilter || null;\r\n          const e = p?.globalEndDateFilter || null;\r\n          if (s && e) {\r\n            resolved = true;\r\n            cleanup();\r\n            resolve({\r\n              start: s,\r\n              end: e,\r\n              from: 'state/event',\r\n            });\r\n            return true;\r\n          }\r\n          return false;\r\n        };\r\n\r\n        const cleanup = () => {\r\n          window.removeEventListener('myio:date-params', onEvt);\r\n          if (poller) clearInterval(poller);\r\n          if (timer) clearTimeout(timer);\r\n        };\r\n\r\n        const onEvt = (ev) => tryResolve(ev.detail);\r\n        window.addEventListener('myio:date-params', onEvt);\r\n\r\n        if (tryResolve(window.myioStateParams || {})) return;\r\n\r\n        poller = setInterval(() => tryResolve(window.myioStateParams || {}), pollMs);\r\n\r\n        timer = setTimeout(() => {\r\n          if (!resolved) {\r\n            cleanup();\r\n            const end = new Date();\r\n            const start = new Date(end.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n            resolve({\r\n              start: start.toISOString(),\r\n              end: end.toISOString(),\r\n              from: 'fallback-7d',\r\n            });\r\n          }\r\n        }, timeoutMs);\r\n      });\r\n    }\r\n\r\n    const dateParams = await waitForDateParams();\r\n    LogHelper.log('[TEMPERATURE_SENSORS] Date params ready:', dateParams);\r\n\r\n    // Listen for shopping filter events\r\n    self._onFilterApplied = (ev) => {\r\n      LogHelper.log('[TEMPERATURE_SENSORS] heard myio:filter-applied:', ev.detail);\r\n\r\n      const selection = ev.detail?.selection || [];\r\n      const shoppingIds = selection.map((s) => s.value).filter((v) => v);\r\n\r\n      STATE.selectedShoppingIds = shoppingIds;\r\n      renderShoppingFilterChips(selection);\r\n      reflowCards();\r\n    };\r\n    window.addEventListener('myio:filter-applied', self._onFilterApplied);\r\n\r\n    // Listen for customers ready\r\n    self._onCustomersReady = (ev) => {\r\n      LogHelper.log('[TEMPERATURE_SENSORS] heard myio:customers-ready:', ev.detail);\r\n      const customers = ev.detail?.customers || [];\r\n      if (customers.length > 0) {\r\n        STATE.totalShoppings = customers.length;\r\n        renderShoppingFilterChips(customers);\r\n      }\r\n    };\r\n    window.addEventListener('myio:customers-ready', self._onCustomersReady, {\r\n      once: true,\r\n    });\r\n\r\n    // Fetch and render sensors\r\n    const sensors = await fetchTemperatureSensors();\r\n    initializeSensorCards(sensors);\r\n    updateSensorStats(sensors);\r\n\r\n    // Bind filter events\r\n    bindFilterEvents();\r\n\r\n    showLoadingOverlay(false);\r\n  }, 0);\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  /*\r\n    LogHelper.log('[TEMPERATURE_SENSORS] onDataUpdated');\r\n    fetchTemperatureSensors().then((sensors) => {\r\n      STATE.allSensors = sensors;\r\n      reflowCards();\r\n    });\r\n    */\r\n};\r\n\r\nself.onDestroy = function () {\r\n  if (self._onFilterApplied) {\r\n    window.removeEventListener('myio:filter-applied', self._onFilterApplied);\r\n  }\r\n  if (self._onCustomersReady) {\r\n    window.removeEventListener('myio:customers-ready', self._onCustomersReady);\r\n  }\r\n\r\n  // RFC-0096: Cleanup filter modal\r\n  if (temperatureFilterModal) {\r\n    temperatureFilterModal.destroy();\r\n    temperatureFilterModal = null;\r\n    LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filter modal destroyed');\r\n  }\r\n\r\n  LogHelper.log('[TEMPERATURE_SENSORS] Widget destroyed');\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Temperature Sensors Widget Settings\",\r\n    \"properties\": {\r\n        \"useNewComponents\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Use New Components\",\r\n            \"default\": true\r\n        },\r\n        \"enableSelection\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Enable Selection\",\r\n            \"default\": true\r\n        },\r\n        \"hideInfoMenuItem\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Hide Info Menu Item\",\r\n            \"default\": true\r\n        },\r\n        \"debugActive\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Debug Active\",\r\n            \"default\": false\r\n        },\r\n        \"activeTooltipDebug\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Active Tooltip Debug\",\r\n            \"default\": false\r\n        }\r\n    }\r\n  },\r\n  \"form\": [\r\n    \"useNewComponents\",\r\n    \"enableSelection\",\r\n    \"hideInfoMenuItem\",\r\n    \"debugActive\",\r\n    \"activeTooltipDebug\"\r\n  ]\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - TEMPERATURE SENSORS - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "d51f33f0-cf84-11f0-998e-25174baff087"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}