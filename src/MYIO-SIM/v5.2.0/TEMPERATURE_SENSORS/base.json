{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_temperature_sensors_v_5_2_0",
    "name": "Widget Head Office - TEMPERATURE SENSORS - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js"
        },
        {
          "url": "https://unpkg.com/myio-js-library@0.1.180/dist/myio-js-library.umd.min.js"
        }
      ],
      "templateHtml": "<div class=\"temp-sensors-wrap\" id=\"tempSensorsWrap\">\r\n  <!-- RFC-0092: Sub-menu removed - now controlled by MENU widget -->\r\n\r\n  <div class=\"toolbar-zoom\">\r\n    <div class=\"shopping-filter-chips\" id=\"tempShoppingFilterChips\"></div>\r\n  </div>\r\n\r\n  <!-- Temperature Sensors Statistics Header -->\r\n  <div class=\"temp-sensors-stats-header\" id=\"tempSensorsStatsHeader\">\r\n    <div class=\"stat-item\">\r\n      <span class=\"stat-label\">Total de Sensores</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsTotal\">-</span>\r\n    </div>\r\n    <div class=\"stat-item highlight\">\r\n      <span class=\"stat-label\">Temperatura M√©dia</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsAvg\">-</span>\r\n    </div>\r\n    <div class=\"stat-item\">\r\n      <span class=\"stat-label\">Sensores Online</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsOnline\">-</span>\r\n    </div>\r\n    <div class=\"stat-item alert\">\r\n      <span class=\"stat-label\">Alertas</span>\r\n      <span class=\"stat-value\" id=\"tempSensorsStatsAlert\">-</span>\r\n    </div>\r\n\r\n    <!-- Filter Actions -->\r\n    <div class=\"filter-actions\">\r\n      <div class=\"search-wrap\" id=\"tempSearchWrap\">\r\n        <input type=\"text\" id=\"tempSensorSearch\" placeholder=\"Buscar sensor...\" autocomplete=\"off\" />\r\n      </div>\r\n      <button class=\"icon-btn\" id=\"btnTempSearch\" title=\"Buscar\" aria-label=\"Buscar\">\r\n        <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" aria-hidden=\"true\">\r\n          <path\r\n            d=\"M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z\"\r\n          />\r\n        </svg>\r\n      </button>\r\n      <button class=\"icon-btn\" id=\"btnTempFilter\" title=\"Filtros\" aria-label=\"Filtros\">\r\n        <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" aria-hidden=\"true\">\r\n          <path d=\"M3 4h18l-7 8v6l-4 2v-8L3 4z\" />\r\n        </svg>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Loading overlay -->\r\n  <div id=\"temperature-sensors-loading-overlay\" class=\"temp-sensors-loading-overlay\" style=\"display: none\">\r\n    <div class=\"loading-spinner\">\r\n      <svg style=\"width: 48px; height: 48px; animation: spin 1s linear infinite\" viewBox=\"0 0 50 50\">\r\n        <circle\r\n          cx=\"25\"\r\n          cy=\"25\"\r\n          r=\"20\"\r\n          fill=\"none\"\r\n          stroke=\"#e65100\"\r\n          stroke-width=\"5\"\r\n          stroke-linecap=\"round\"\r\n          stroke-dasharray=\"90,150\"\r\n          stroke-dashoffset=\"0\"\r\n        ></circle>\r\n      </svg>\r\n      <p>Carregando sensores de temperatura...</p>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Sensors Grid -->\r\n  <section class=\"temp-sensors-grid-container\" id=\"tempSensorsGridContainer\">\r\n    <div id=\"temp-sensors-grid\" class=\"temp-sensors-grid\"></div>\r\n  </section>\r\n\r\n  <!-- RFC-0096: Shops list for card rendering (following STORES pattern) -->\r\n  <section id=\"shopsList\" class=\"shops-list\"></section>\r\n</div>\r\n",
      "templateCss": "/* ====== RFC-0092: TEMPERATURE_SENSORS Widget Styles ====== */\r\n\r\n/* ====== TOKENS (scoped to wrap) ====== */\r\n.temp-sensors-wrap {\r\n  /* Global font scale */\r\n  --fs: 0.94;\r\n\r\n  /* Colors and layout */\r\n  --card-grad: linear-gradient(180deg, #ffffff 0%, #fff8f0 100%);\r\n  --card-bd: #ffe0b2;\r\n  --ink-1: #1c2743;\r\n  --ink-2: #6b7a90;\r\n  --orange: #e65100;\r\n  --orange-light: #ff9800;\r\n  --accent: #ff5722;\r\n  --success: #4caf50;\r\n  --warning: #ff9800;\r\n  --danger: #f44336;\r\n  --cold: #2196f3;\r\n  --shadow: 0 8px 24px rgba(230, 81, 0, 0.08);\r\n  --shadow-hover: 0 14px 36px rgba(230, 81, 0, 0.16);\r\n  --radius: 20px;\r\n\r\n  /* Typography derived from scale */\r\n  --fs-2xs: calc(11px * var(--fs));\r\n  --fs-xs: calc(12px * var(--fs));\r\n  --fs-sm: calc(13px * var(--fs));\r\n  --fs-md: calc(14px * var(--fs));\r\n  --fs-lg: calc(16px * var(--fs));\r\n  --fs-xl: calc(20px * var(--fs));\r\n  --fs-xxl: calc(28px * var(--fs));\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  box-sizing: border-box;\r\n  padding: 12px;\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow: auto;\r\n  background: transparent;\r\n}\r\n\r\n/* ====== TEMPERATURE SENSORS STATISTICS HEADER ====== */\r\n.temp-sensors-wrap > .temp-sensors-stats-header,\r\n#tempSensorsStatsHeader {\r\n  display: flex !important;\r\n  flex-direction: row !important;\r\n  flex-wrap: nowrap !important;\r\n  gap: 16px;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);\r\n  border: 1px solid #ffcc80;\r\n  border-radius: 12px;\r\n  padding: 10px 16px;\r\n  margin-bottom: 32px;\r\n  padding-bottom: 16px;\r\n  border-bottom: 3px solid #ffb74d;\r\n  box-shadow: 0 4px 12px rgba(230, 81, 0, 0.06);\r\n  width: 100%;\r\n}\r\n\r\n.temp-sensors-wrap > .temp-sensors-stats-header .stat-item,\r\n#tempSensorsStatsHeader .stat-item {\r\n  display: flex !important;\r\n  flex-direction: column !important;\r\n  gap: 2px;\r\n  flex: 1;\r\n  min-width: 0;\r\n  text-align: center;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.highlight {\r\n  background: linear-gradient(135deg, #ffecb3 0%, #ffe082 100%);\r\n  border-radius: 8px;\r\n  padding: 6px 12px;\r\n  border: 1px solid #ffc107;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.alert {\r\n  background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);\r\n  border-radius: 8px;\r\n  padding: 6px 12px;\r\n  border: 1px solid #e57373;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-label {\r\n  font-size: var(--fs-xs);\r\n  color: var(--ink-2);\r\n  font-weight: 500;\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.5px;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-value {\r\n  font-size: var(--fs-lg);\r\n  color: var(--ink-1);\r\n  font-weight: 700;\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.highlight .stat-value {\r\n  color: #e65100;\r\n  font-size: var(--fs-xl);\r\n}\r\n\r\n.temp-sensors-stats-header .stat-item.alert .stat-value {\r\n  color: #c62828;\r\n  font-size: var(--fs-lg);\r\n}\r\n\r\n/* ====== TOOLBAR ZOOM ====== */\r\n.toolbar-zoom {\r\n  position: sticky;\r\n  top: 6px;\r\n  z-index: 2;\r\n  display: flex;\r\n  gap: 6px;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n/* ====== SHOPPING FILTER CHIPS ====== */\r\n.shopping-filter-chips {\r\n  display: flex;\r\n  gap: 6px;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n  flex: 1;\r\n  margin-right: 12px;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);\r\n  border: 1px solid #ffcc80;\r\n  border-radius: 8px;\r\n  padding: 3px 8px;\r\n  font-size: var(--fs-xs);\r\n  color: #e65100;\r\n  font-weight: 500;\r\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\r\n  white-space: nowrap;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip-icon {\r\n  font-size: 10px;\r\n  opacity: 0.7;\r\n}\r\n\r\n/* ====== SENSORS GRID ====== */\r\n.temp-sensors-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n  gap: 16px;\r\n  margin-top: 24px;\r\n}\r\n\r\n.temp-sensors-grid > * {\r\n  min-width: 0;\r\n  width: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* Responsive grid */\r\n@media (min-width: 1920px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(6, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1600px) and (max-width: 1919px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 15px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1280px) and (max-width: 1599px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1024px) and (max-width: 1279px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(4, 1fr);\r\n    gap: 16px;\r\n  }\r\n}\r\n\r\n@media (max-width: 1023px) {\r\n  .temp-sensors-grid {\r\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n    gap: 12px;\r\n  }\r\n}\r\n\r\n/* ====== SENSOR CARD ====== */\r\n.temp-sensor-card {\r\n  position: relative;\r\n  background-color: #fff;\r\n  background-image: var(--card-grad) !important;\r\n  border: 1px solid var(--card-bd);\r\n  border-radius: var(--radius);\r\n  box-shadow: var(--shadow);\r\n  color: var(--ink-1);\r\n  padding: 16px 18px 14px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12px;\r\n  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;\r\n  cursor: pointer;\r\n}\r\n\r\n.temp-sensor-card:hover {\r\n  transform: translateY(-2px);\r\n  box-shadow: var(--shadow-hover);\r\n  border-color: #ffb74d;\r\n}\r\n\r\n/* Status-based card borders */\r\n.temp-sensor-card.status-normal {\r\n  border-left: 4px solid var(--success);\r\n}\r\n\r\n.temp-sensor-card.status-hot {\r\n  border-left: 4px solid var(--danger);\r\n}\r\n\r\n.temp-sensor-card.status-cold {\r\n  border-left: 4px solid var(--cold);\r\n}\r\n\r\n.temp-sensor-card.status-no_info,\r\n.temp-sensor-card.status-offline {\r\n  border-left: 4px solid #bdbdbd;\r\n  opacity: 0.7;\r\n}\r\n\r\n/* ====== SENSOR CARD HEADER ====== */\r\n.temp-sensor-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.temp-sensor-icon {\r\n  width: 40px;\r\n  height: 40px;\r\n  border-radius: 12px;\r\n  background: linear-gradient(135deg, #fff3e0, #ffe0b2);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  font-size: 20px;\r\n}\r\n\r\n.temp-sensor-info {\r\n  flex: 1;\r\n  min-width: 0;\r\n}\r\n\r\n.temp-sensor-name {\r\n  font-weight: 600;\r\n  font-size: var(--fs-md);\r\n  color: var(--ink-1);\r\n  white-space: nowrap;\r\n  overflow: hidden;\r\n  text-overflow: ellipsis;\r\n}\r\n\r\n.temp-sensor-location {\r\n  font-size: var(--fs-xs);\r\n  color: var(--ink-2);\r\n  margin-top: 2px;\r\n}\r\n\r\n.temp-sensor-menu {\r\n  border: none;\r\n  background: transparent;\r\n  font-size: 18px;\r\n  color: var(--ink-2);\r\n  cursor: pointer;\r\n  padding: 4px 8px;\r\n  border-radius: 6px;\r\n}\r\n\r\n.temp-sensor-menu:hover {\r\n  background: #fff3e0;\r\n  color: var(--ink-1);\r\n}\r\n\r\n/* ====== SENSOR VALUE ====== */\r\n.temp-sensor-value {\r\n  text-align: center;\r\n  padding: 8px 0;\r\n}\r\n\r\n.temp-value {\r\n  font-size: var(--fs-xxl);\r\n  font-weight: 800;\r\n  color: var(--orange);\r\n  letter-spacing: 0.5px;\r\n}\r\n\r\n.status-hot .temp-value {\r\n  color: var(--danger);\r\n}\r\n\r\n.status-cold .temp-value {\r\n  color: var(--cold);\r\n}\r\n\r\n.status-no_info .temp-value,\r\n.status-offline .temp-value {\r\n  color: #9e9e9e;\r\n}\r\n\r\n/* ====== STATUS CHIP ====== */\r\n.temp-sensor-status {\r\n  display: flex;\r\n  justify-content: center;\r\n}\r\n\r\n.status-chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  padding: 4px 12px;\r\n  border-radius: 999px;\r\n  font-size: var(--fs-xs);\r\n  font-weight: 600;\r\n}\r\n\r\n.status-chip.status-normal {\r\n  background: #e8f5e9;\r\n  color: #2e7d32;\r\n}\r\n\r\n.status-chip.status-hot {\r\n  background: #ffebee;\r\n  color: #c62828;\r\n}\r\n\r\n.status-chip.status-cold {\r\n  background: #e3f2fd;\r\n  color: #1565c0;\r\n}\r\n\r\n.status-chip.status-no_info,\r\n.status-chip.status-offline {\r\n  background: #f5f5f5;\r\n  color: #757575;\r\n}\r\n\r\n.status-dot {\r\n  width: 8px;\r\n  height: 8px;\r\n  border-radius: 50%;\r\n  background: currentColor;\r\n}\r\n\r\n/* ====== SENSOR FOOTER ====== */\r\n.temp-sensor-footer {\r\n  text-align: center;\r\n  padding-top: 8px;\r\n  border-top: 1px solid #ffe0b2;\r\n}\r\n\r\n.temp-sensor-updated {\r\n  font-size: var(--fs-2xs);\r\n  color: var(--ink-2);\r\n}\r\n\r\n/* ====== EMPTY STATE ====== */\r\n.temp-sensors-empty {\r\n  grid-column: 1 / -1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 60px 20px;\r\n  text-align: center;\r\n}\r\n\r\n.temp-sensors-empty .empty-icon {\r\n  font-size: 64px;\r\n  margin-bottom: 16px;\r\n  opacity: 0.5;\r\n}\r\n\r\n.temp-sensors-empty .empty-text {\r\n  font-size: var(--fs-lg);\r\n  color: var(--ink-2);\r\n}\r\n\r\n/* ====== LOADING OVERLAY ====== */\r\n.temp-sensors-loading-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(255, 255, 255, 0.95);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n  backdrop-filter: blur(4px);\r\n}\r\n\r\n.loading-spinner {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 16px;\r\n}\r\n\r\n.loading-spinner p {\r\n  font-size: var(--fs-md);\r\n  font-weight: 600;\r\n  color: var(--ink-1);\r\n  margin: 0;\r\n}\r\n\r\n@keyframes spin {\r\n  0% {\r\n    transform: rotate(0deg);\r\n  }\r\n  100% {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* ====== FILTER ACTIONS ====== */\r\n.filter-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  align-items: center;\r\n  margin-left: auto;\r\n}\r\n\r\n.search-wrap {\r\n  position: relative;\r\n  width: 0;\r\n  overflow: hidden;\r\n  transition: width 0.3s ease;\r\n}\r\n\r\n.search-wrap.active {\r\n  width: 200px;\r\n}\r\n\r\n.search-wrap input {\r\n  width: 100%;\r\n  padding: 6px 12px;\r\n  border: 1px solid var(--card-bd);\r\n  border-radius: 8px;\r\n  font-size: var(--fs-sm);\r\n  outline: none;\r\n}\r\n\r\n.search-wrap input:focus {\r\n  border-color: var(--orange);\r\n  box-shadow: 0 0 0 2px rgba(230, 81, 0, 0.1);\r\n}\r\n\r\n.icon-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  border: 1px solid var(--card-bd);\r\n  background: #fff;\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.icon-btn:hover {\r\n  background: #fff3e0;\r\n  border-color: var(--orange);\r\n}\r\n\r\n.icon-btn svg {\r\n  fill: var(--ink-1);\r\n}\r\n\r\n/* ====== RFC-0096: SHOPS LIST (following STORES pattern) ====== */\r\n.temp-sensors-wrap .shops-list {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n  gap: 16px;\r\n  margin-top: 24px;\r\n  padding-bottom: 100px;\r\n}\r\n\r\n.temp-sensors-wrap .shops-list > * {\r\n  min-width: 0;\r\n  width: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* Responsive grid - matching STORES */\r\n@media (min-width: 1920px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(6, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1600px) and (max-width: 1919px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 15px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1280px) and (max-width: 1599px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 14px;\r\n  }\r\n}\r\n\r\n@media (min-width: 1024px) and (max-width: 1279px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(4, 1fr);\r\n    gap: 16px;\r\n  }\r\n}\r\n\r\n@media (max-width: 1023px) {\r\n  .temp-sensors-wrap .shops-list {\r\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\r\n    gap: 12px;\r\n  }\r\n}\r\n\r\n/* ====== SCROLLBAR ====== */\r\n.temp-sensors-wrap .shops-list::-webkit-scrollbar {\r\n  width: 8px;\r\n}\r\n\r\n.temp-sensors-wrap .shops-list::-webkit-scrollbar-thumb {\r\n  background: #c9d4e2;\r\n  border-radius: 6px;\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary, $ */\n\n/**\n * RFC-0092: TEMPERATURE_SENSORS Widget Controller\n *\n * Displays temperature sensor cards in an EQUIPMENTS-style grid layout.\n * Fetches sensor data from ThingsBoard API and supports shopping filter synchronization.\n */\n\n// ============================================\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\n// ============================================\nconst LogHelper = window.MyIOUtils?.LogHelper || {\n  log: (...args) => console.log(...args),\n  warn: (...args) => console.warn(...args),\n  error: (...args) => console.error(...args),\n};\n\nconst formatRelativeTime =\n  window.MyIOUtils?.formatRelativeTime || ((ts) => (ts ? new Date(ts).toLocaleString() : '‚Äî'));\n\nconst getCustomerNameForDevice =\n  window.MyIOUtils?.getCustomerNameForDevice ||\n  ((device) => device.customerName || device.customerId || 'N/A');\n\n// ============================================\n// TEMPERATURE_SENSORS WIDGET STATE\n// ============================================\nconst STATE = {\n  allSensors: [],\n  searchActive: false,\n  searchTerm: '',\n  selectedIds: null,\n  sortMode: 'temp_desc',\n  selectedShoppingIds: [],\n  totalShoppings: 0,\n  isLoading: true,\n};\n\nconst WIDGET_DOMAIN = 'temperature'; // Will be set in onInit\n\n// Card rendering options (from settings, with defaults)\nlet USE_NEW_COMPONENTS = true;\nlet ENABLE_SELECTION = true;\nlet HIDE_INFO_MENU_ITEM = true;\nlet DEBUG_ACTIVE = false;\nlet ACTIVE_TOOLTIP_DEBUG = false;\n\nLogHelper.log('[TEMPERATURE_SENSORS] Script loaded, using shared utilities:', !!window.MyIOUtils);\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\nfunction formatTemperature(value) {\n  if (value === null || value === undefined || isNaN(value)) return '‚Äî';\n  return `${Number(value).toFixed(1)}¬∞C`;\n}\n\nfunction getTemperatureStatus(temp, min = 18, max = 26) {\n  if (temp === null || temp === undefined || isNaN(temp)) return 'no_info';\n  if (temp < min) return 'cold';\n  if (temp > max) return 'hot';\n  return 'normal';\n}\n\nfunction getStatusLabel(status) {\n  const labels = {\n    normal: 'Normal',\n    cold: 'Frio',\n    hot: 'Quente',\n    no_info: 'Sem Dados',\n    offline: 'Offline',\n  };\n  return labels[status] || status;\n}\n\nfunction showLoadingOverlay(show) {\n  const overlay = document.getElementById('temperature-sensors-loading-overlay');\n  if (overlay) {\n    overlay.style.display = show ? 'flex' : 'none';\n  }\n}\n\n// ============================================\n// CARD RENDERING\n// ============================================\n\nfunction initializeSensorCards(sensors) {\n  const grid = document.getElementById('temp-sensors-grid');\n  if (!grid) {\n    LogHelper.error('[TEMPERATURE_SENSORS] Grid element not found');\n    return;\n  }\n\n  // --- FUN√á√ÉO AUXILIAR PARA FORMATAR O TEMPO (Adicionada agora) ---\n  function formatDuration(ms) {\n    if (!ms || ms < 0) return '0min';\n    const seconds = Math.floor(ms / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n\n    if (days > 0) return `${days}d ${hours % 24}h`;\n    if (hours > 0) return `${hours}h ${minutes % 60}m`;\n    return `${minutes}min`;\n  }\n\n  grid.innerHTML = '';\n\n  if (sensors.length === 0) {\n    grid.innerHTML = `\n      <div class=\"temp-sensors-empty\">\n        <div class=\"empty-icon\">üå°Ô∏è</div>\n        <div class=\"empty-text\">Nenhum sensor de temperatura encontrado</div>\n      </div>\n    `;\n    return;\n  }\n\n  sensors.forEach((sensor) => {\n    const container = document.createElement('div');\n    grid.appendChild(container);\n\n    if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.renderCardComponentHeadOffice) {\n      \n      // 1. CONFIGURA√á√ÉO DE TEMPO LIMITE\n      // Lembre-se: use delayInMins = 0.1 para testar o \"tra√ßo\" se quiser ver ele offline\n      const delayInMins = window.MyIOUtils?.getDelayTimeConnectionInMins?.() ?? 60;\n      const delayLimitMs = delayInMins * 60 * 1000;\n      \n      const now = Date.now();\n      const lastTs = new Date(sensor.lastUpdate || sensor.lastActivityTime || 0).getTime();\n      const timeDiff = now - lastTs;\n\n      // Valida√ß√£o: N√£o pode ter expirado E tem que ter valor\n      const isExpired = timeDiff > delayLimitMs;\n      const hasValue = sensor.temperature !== null && sensor.temperature !== undefined;\n      const hasValidData = !isExpired && hasValue;\n\n      // --- 2. C√ÅLCULO DO TEMPO EM OPERA√á√ÉO (AQUI EST√Å A M√ÅGICA) ---\n      let operationTimeFormatted = null;\n      \n      // S√≥ calculamos se o dado for v√°lido e tivermos a data de conex√£o\n      if (hasValidData && sensor.lastConnectTime) {\n          const connectTs = new Date(sensor.lastConnectTime).getTime();\n          const duration = now - connectTs;\n          // Se a dura√ß√£o for l√≥gica (positiva), formata. Sen√£o fica null.\n          if (duration >= 0) {\n              operationTimeFormatted = formatDuration(duration);\n          }\n      }\n\n      // 3. PREPARA√á√ÉO VISUAL\n      const displayValue = hasValidData ? sensor.temperature : null;\n      // Se inv√°lido, data vira null -> exibe \"-\"\n      const displayDate = hasValidData ? sensor.lastActivityTime : null;\n      // Se inv√°lido, tempo de opera√ß√£o vira null -> exibe \"-\"\n      const displayOperation = hasValidData ? operationTimeFormatted : null;\n\n      const STATUS_ONLINE = window.MyIOLibrary?.DeviceStatusType?.POWER_ON || 'running';\n      const STATUS_OFFLINE = window.MyIOLibrary?.DeviceStatusType?.NO_INFO || 'no_info';\n      const visualStatus = hasValidData ? STATUS_ONLINE : STATUS_OFFLINE;\n\n      const entityObject = {\n        entityId: sensor.id,\n        id: sensor.id, \n        tbId: sensor.id, \n        labelOrName: sensor.label || sensor.name,\n        name: sensor.label || sensor.name, \n        label: sensor.label || sensor.name,\n        deviceIdentifier: sensor.identifier || 'TEMP-SENSOR',\n\n        // Valores\n        val: displayValue,\n        lastValue: displayValue,\n        temperatureC: displayValue,\n        currentTemperature: displayValue, \n        \n        // Datas e Tempos\n        lastActivityTime: displayDate,\n        updated: hasValidData ? formatRelativeTime(sensor.lastUpdate) : '-',\n        \n        // --- NOVO CAMPO CALCULADO ---\n        // Agora a biblioteca recebe o texto pronto (ex: \"5h 30m\") ou null\n        operationHours: displayOperation,\n\n        // Outros dados\n        valType: 'temperature',\n        unit: '¬∞C', \n        icon: 'temperature', \n        deviceType: 'TEMPERATURE_SENSOR',\n        customerName: sensor.customerName,\n        customerId: sensor.customerId,\n        domain: WIDGET_DOMAIN,\n        temperatureMin: sensor.temperatureMin,\n        temperatureMax: sensor.temperatureMax,\n        centralName: sensor.centralName,\n        identifier: sensor.identifier,\n        connectionStatus: sensor.connectionStatus,\n        lastConnectTime: sensor.lastConnectTime || sensor.lastUpdate,\n        lastDisconnectTime: sensor.lastDisconnectTime,\n        deviceStatus: visualStatus,\n      };\n\n      MyIOLibrary.renderCardComponentHeadOffice(container, {\n        entityObject: entityObject,\n        debugActive: DEBUG_ACTIVE,\n        activeTooltipDebug: ACTIVE_TOOLTIP_DEBUG,\n        delayTimeConnectionInMins: delayInMins,\n        handleActionDashboard: async () => { openTemperatureModal(sensor); },\n        handleActionSettings: async () => { \n            const jwt = localStorage.getItem('jwt_token');\n            if (!jwt) return;\n            if (MyIOLibrary.openDashboardPopupSettings) {\n                await MyIOLibrary.openDashboardPopupSettings({\n                    deviceId: sensor.id,\n                    label: sensor.label || sensor.name,\n                    jwtToken: jwt,\n                    domain: WIDGET_DOMAIN,\n                    deviceType: sensor.deviceType || 'TERMOSTATO',\n                    deviceProfile: sensor.deviceProfile || 'TERMOSTATO',\n                    customerId: sensor.customerId,\n                    customerName: sensor.customerName,\n                    temperatureMin: sensor.temperatureMin,\n                    temperatureMax: sensor.temperatureMax,\n                    ui: { title: 'Configura√ß√µes', width: 900 },\n                    onClose: () => { $('.myio-settings-modal-overlay').remove(); }\n                });\n            }\n        },\n        handleSelect: (checked, entity) => { \n            const store = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\n            if (store) checked ? store.add(entity.entityId) : store.remove(entity.entityId);\n        },\n        handleClickCard: (ev, entity) => { LogHelper.log(`Click: ${entity.labelOrName}`); },\n        useNewComponents: USE_NEW_COMPONENTS,\n        enableSelection: ENABLE_SELECTION,\n        hideInfoMenuItem: HIDE_INFO_MENU_ITEM,\n      });\n    } else {\n      renderCustomSensorCard(container, sensor);\n    }\n  });\n  LogHelper.log('[TEMPERATURE_SENSORS] Cards rendered with Operation Time.');\n}\n\n// Fun√ß√µes auxiliares para manter o c√≥digo limpo (caso voc√™ n√£o as tenha separadas)\nfunction handleSettingsClick(sensor) {\n    const jwt = localStorage.getItem('jwt_token');\n    if (!jwt) return window.alert('Token n√£o encontrado');\n    \n    // ... Copie o conte√∫do original do handleActionSettings aqui ...\n    if (MyIOLibrary.openDashboardPopupSettings) {\n        MyIOLibrary.openDashboardPopupSettings({\n            deviceId: sensor.id,\n            label: sensor.label || sensor.name,\n            jwtToken: jwt,\n            domain: WIDGET_DOMAIN,\n            // ... resto dos parametros\n            onClose: () => { $('.myio-settings-modal-overlay').remove(); }\n        });\n    }\n}\n\nfunction handleSelectClick(checked, entity) {\n    const MyIOSelectionStore = window.MyIOLibrary?.MyIOSelectionStore || window.MyIOSelectionStore;\n    if (MyIOSelectionStore) {\n        checked ? MyIOSelectionStore.add(entity.entityId) : MyIOSelectionStore.remove(entity.entityId);\n    }\n}\n\nfunction renderCustomSensorCard(container, sensor) {\n  const statusClass = `status-${sensor.status}`;\n  const statusLabel = getStatusLabel(sensor.status);\n\n  container.innerHTML = `\n    <div class=\"temp-sensor-card ${statusClass}\">\n      <div class=\"temp-sensor-header\">\n        <div class=\"temp-sensor-icon\">üå°Ô∏è</div>\n        <div class=\"temp-sensor-info\">\n          <div class=\"temp-sensor-name\">${sensor.label || sensor.name}</div>\n          <div class=\"temp-sensor-location\">${sensor.customerName || 'N/A'}</div>\n        </div>\n        <button class=\"temp-sensor-menu\" title=\"Op√ß√µes\">‚ãÆ</button>\n      </div>\n      <div class=\"temp-sensor-value\">\n        <span class=\"temp-value\">${formatTemperature(sensor.temperature)}</span>\n      </div>\n      <div class=\"temp-sensor-status\">\n        <span class=\"status-chip ${statusClass}\">\n          <span class=\"status-dot\"></span>\n          ${statusLabel}\n        </span>\n      </div>\n      <div class=\"temp-sensor-footer\">\n        <span class=\"temp-sensor-updated\">Atualizado: ${formatRelativeTime(sensor.lastUpdate)}</span>\n      </div>\n    </div>\n  `;\n\n  // Add click handler\n  container.querySelector('.temp-sensor-card').addEventListener('click', () => {\n    openTemperatureModal(sensor);\n  });\n}\n\nasync function openTemperatureModal(sensor) {\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.openTemperatureComparisonModal) {\n    const token = localStorage.getItem('jwt_token');\n    if (!token) {\n      LogHelper.error('[TEMPERATURE_SENSORS] JWT token not found');\n      return;\n    }\n\n    try {\n      // Get date range from global state or use defaults\n      const dateRange = window.myioDateRange || {};\n      const now = new Date();\n      const startDate = dateRange.startDate || new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();\n      const endDate = dateRange.endDate || now.toISOString();\n\n      await MyIOLibrary.openTemperatureComparisonModal({\n        token: token,\n        devices: [\n          {\n            id: sensor.tbId || sensor.id,\n            label: sensor.label || sensor.name,\n            customerName: sensor.customerName,\n            temperatureMin: sensor.temperatureMin || 18,\n            temperatureMax: sensor.temperatureMax || 26,\n          },\n        ],\n        startDate: startDate,\n        endDate: endDate,\n        locale: 'pt-BR',\n        theme: 'dark',\n        onClose: () => {\n          LogHelper.log('[TEMPERATURE_SENSORS] Temperature modal closed');\n        },\n      });\n    } catch (error) {\n      LogHelper.error('[TEMPERATURE_SENSORS] Error opening temperature modal:', error);\n    }\n  } else {\n    LogHelper.warn('[TEMPERATURE_SENSORS] openTemperatureComparisonModal not available');\n    window.alert('Modal de temperatura n√£o dispon√≠vel');\n  }\n}\n\n// ============================================\n// DATA FETCHING\n// ============================================\n\nasync function fetchTemperatureSensors() {\n  LogHelper.log('[TEMPERATURE_SENSORS] Fetching temperature sensors...');\n  STATE.isLoading = true;\n  showLoadingOverlay(true);\n\n  try {\n    const sensors = [];\n\n    // Method 1: Try to get sensors from ctx.data (ThingsBoard datasources)\n    if (self.ctx && self.ctx.data) {\n      self.ctx.data.forEach((data) => {\n        // Ignora dados do Alias \"Shopping\" se houver\n        if (data.datasource && data.datasource.aliasName !== 'Shopping') {\n          const entityId = data.datasource.entity?.id?.id;\n\n          if (entityId) {\n            // 1. Tenta encontrar o sensor j√° criado na lista\n            let existingSensor = sensors.find((s) => s.id === entityId);\n\n            // 2. Se n√£o existir, cria o esqueleto inicial e adiciona ao array\n            if (!existingSensor) {\n              existingSensor = {\n                id: entityId,\n                tbId: entityId,\n                name: data.datasource.name,\n                label: data.datasource.entityLabel || data.datasource.name,\n                temperature: null,\n                lastUpdate: null,\n                customerId: data.datasource.customerId || null,\n                customerName: 'N/A', // Inicializa com N/A\n                status: 'no_info',\n                temperatureMin: 18,\n                temperatureMax: 26,\n              };\n              sensors.push(existingSensor);\n            }\n\n            // 3. Verifica qual √© a chave de dados atual e atualiza o campo correspondente\n            const keyName = data.dataKey?.name;\n            const value = data.data?.[0]?.[1];\n            const ts = data.data?.[0]?.[0];\n\n            if (keyName === 'temperature') {\n              existingSensor.temperature = value || existingSensor.temperature;\n              existingSensor.lastUpdate = ts || existingSensor.lastUpdate;\n              existingSensor.status = getTemperatureStatus(existingSensor.temperature);\n            } else if (keyName === 'ownerName') {\n              // [CORRE√á√ÉO] Agora o c√≥digo consegue entrar aqui\n              if (value) {\n                existingSensor.customerName = value;\n              }\n            } else if (keyName === 'lastActivityTime') {\n              // Timestamp UTC da √∫ltima telemetria enviada pelo dispositivo\n              existingSensor.lastActivityTime = value || existingSensor.lastActivityTime;\n            } else if (keyName === 'name') {\n              existingSensor.name = value || existingSensor.name;\n            } else if (keyName === 'label') {\n              existingSensor.label = value || existingSensor.label;\n            } else if (keyName === 'identifier') {\n              existingSensor.identifier = value || existingSensor.identifier;\n            } else if (keyName === 'centralName') {\n              existingSensor.centralName = value || existingSensor.centralName;\n            } else if (keyName === 'connectionStatus') {\n              existingSensor.connectionStatus = value || existingSensor.connectionStatus;\n            } else if (keyName === 'lastConnectTime') {\n              existingSensor.lastConnectTime = value || existingSensor.lastConnectTime;\n            } else if (keyName === 'lastDisconnectTime') {\n              existingSensor.lastDisconnectTime = value || existingSensor.lastDisconnectTime;\n            }\n          }\n        }\n      });\n    }\n\n    // Method 2: If no sensors from ctx.data, try API fetch\n    if (sensors.length === 0) {\n      LogHelper.log('[TEMPERATURE_SENSORS] No sensors in ctx.data, trying API...');\n      const apiSensors = await fetchSensorsFromAPI();\n      sensors.push(...apiSensors);\n    }\n\n    STATE.allSensors = sensors;\n    LogHelper.log('[TEMPERATURE_SENSORS] Loaded', sensors.length, 'sensors');\n\n    return sensors;\n  } catch (error) {\n    LogHelper.error('[TEMPERATURE_SENSORS] Error fetching sensors:', error);\n    return [];\n  } finally {\n    STATE.isLoading = false;\n    showLoadingOverlay(false);\n  }\n}\n\nasync function fetchSensorsFromAPI() {\n  const token = localStorage.getItem('jwt_token');\n  if (!token) {\n    LogHelper.warn('[TEMPERATURE_SENSORS] No JWT token for API fetch');\n    return [];\n  }\n\n  try {\n    // Busca dispositivos do tipo TEMPERATURE_SENSOR\n    const response = await fetch('/api/tenant/devices?pageSize=1000&page=0&type=TEMPERATURE_SENSOR', {\n      headers: {\n        'X-Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`API error: ${response.status}`);\n    }\n\n    const result = await response.json();\n    const devices = result.data || [];\n\n    // Busca √∫ltima telemetria para cada dispositivo e aplica o \"Enrich\"\n    const sensors = await Promise.all(\n      devices.map(async (device) => {\n        try {\n          const telemetryResponse = await fetch(\n            `/api/plugins/telemetry/DEVICE/${device.id.id}/values/timeseries?keys=temperature`,\n            {\n              headers: {\n                'X-Authorization': `Bearer ${token}`,\n                'Content-Type': 'application/json',\n              },\n            }\n          );\n\n          let temperature = null;\n          let lastUpdate = null;\n\n          if (telemetryResponse.ok) {\n            const telemetry = await telemetryResponse.json();\n            if (telemetry.temperature && telemetry.temperature.length > 0) {\n              temperature = telemetry.temperature[0].value;\n              lastUpdate = telemetry.temperature[0].ts;\n            }\n          }\n\n          // =========================================================================\n          // [FIX] L√ìGICA TIPO \"enrichItemsWithTotals\"\n          // Garante recupera√ß√£o robusta de customerId e customerName\n          // =========================================================================\n\n          // 1. Tenta pegar o ID de v√°rias fontes poss√≠veis (fallback)\n          const finalCustomerId = device.customerId?.id || device.customer_id || null;\n\n          // 2. Tenta pegar o Nome de v√°rias fontes poss√≠veis (o TB retorna como customerTitle ou name)\n          const finalCustomerName =\n            device.customerTitle || device.customerName || device.customer_name || 'N/A';\n\n          return {\n            id: device.id.id,\n            tbId: device.id.id,\n            name: device.name,\n            label: device.label || device.name,\n            temperature: temperature,\n            lastUpdate: lastUpdate,\n\n            // [FIX] Usa os valores \"enriquecidos\"\n            customerId: finalCustomerId,\n            customerName: finalCustomerName,\n\n            status: getTemperatureStatus(temperature),\n            temperatureMin: 18,\n            temperatureMax: 26,\n          };\n        } catch (err) {\n          LogHelper.warn('[TEMPERATURE_SENSORS] Error fetching telemetry for device:', device.id.id, err);\n\n          // [FIX] Mesmo no erro, tentamos garantir os dados do cliente\n          const finalCustomerId = device.customerId?.id || null;\n          const finalCustomerName = device.customerTitle || 'N/A';\n\n          return {\n            id: device.id.id,\n            tbId: device.id.id,\n            name: device.name,\n            label: device.label || device.name,\n            temperature: null,\n            lastUpdate: null,\n            customerId: finalCustomerId,\n            customerName: finalCustomerName,\n            status: 'no_info',\n            temperatureMin: 18,\n            temperatureMax: 26,\n          };\n        }\n      })\n    );\n\n    return sensors;\n  } catch (error) {\n    LogHelper.error('[TEMPERATURE_SENSORS] API fetch error:', error);\n    return [];\n  }\n}\n\n// ============================================\n// FILTERING & SORTING\n// ============================================\n\nfunction applyFilters(sensors, searchTerm, selectedIds, sortMode) {\n  let filtered = sensors.slice();\n\n  // Apply shopping filter\n  if (STATE.selectedShoppingIds && STATE.selectedShoppingIds.length > 0) {\n    filtered = filtered.filter((s) => {\n      if (!s.customerId) return true;\n      return STATE.selectedShoppingIds.includes(s.customerId);\n    });\n  }\n\n  // Apply multiselect filter\n  if (selectedIds && selectedIds.size > 0) {\n    filtered = filtered.filter((s) => selectedIds.has(s.id));\n  }\n\n  // Apply search filter\n  const query = (searchTerm || '').trim().toLowerCase();\n  if (query) {\n    filtered = filtered.filter(\n      (s) =>\n        String(s.label || '')\n          .toLowerCase()\n          .includes(query) ||\n        String(s.name || '')\n          .toLowerCase()\n          .includes(query) ||\n        String(s.customerName || '')\n          .toLowerCase()\n          .includes(query)\n    );\n  }\n\n  // Apply sorting\n  filtered.sort((a, b) => {\n    const tempA = Number(a.temperature) || 0;\n    const tempB = Number(b.temperature) || 0;\n    const nameA = String(a.label || a.name || '').toLowerCase();\n    const nameB = String(b.label || b.name || '').toLowerCase();\n\n    switch (sortMode) {\n      case 'temp_desc':\n        return tempB !== tempA ? tempB - tempA : nameA.localeCompare(nameB);\n      case 'temp_asc':\n        return tempA !== tempB ? tempA - tempB : nameA.localeCompare(nameB);\n      case 'alpha_asc':\n        return nameA.localeCompare(nameB);\n      case 'alpha_desc':\n        return nameB.localeCompare(nameA);\n      default:\n        return 0;\n    }\n  });\n\n  return filtered;\n}\n\nfunction reflowCards() {\n  const filtered = applyFilters(STATE.allSensors, STATE.searchTerm, STATE.selectedIds, STATE.sortMode);\n\n  LogHelper.log('[TEMPERATURE_SENSORS] Reflow with filters:', {\n    total: STATE.allSensors.length,\n    filtered: filtered.length,\n    searchTerm: STATE.searchTerm,\n    sortMode: STATE.sortMode,\n  });\n\n  initializeSensorCards(filtered);\n  updateSensorStats(filtered);\n}\n\nfunction updateSensorStats(sensors) {\n  const statsTotal = document.getElementById('tempSensorsStatsTotal');\n  const statsAvg = document.getElementById('tempSensorsStatsAvg');\n  const statsOnline = document.getElementById('tempSensorsStatsOnline');\n  const statsAlert = document.getElementById('tempSensorsStatsAlert');\n\n  if (statsTotal) statsTotal.textContent = sensors.length;\n\n  // Calculate average temperature\n  const validTemps = sensors.filter((s) => s.temperature !== null && !isNaN(s.temperature));\n  const avgTemp =\n    validTemps.length > 0\n      ? validTemps.reduce((sum, s) => sum + Number(s.temperature), 0) / validTemps.length\n      : 0;\n\n  if (statsAvg) statsAvg.textContent = formatTemperature(avgTemp);\n\n  // Count online sensors (with recent data)\n  const onlineCount = sensors.filter((s) => s.status !== 'no_info' && s.status !== 'offline').length;\n  if (statsOnline) statsOnline.textContent = onlineCount;\n\n  // Count alert sensors (hot or cold)\n  const alertCount = sensors.filter((s) => s.status === 'hot' || s.status === 'cold').length;\n  if (statsAlert) statsAlert.textContent = alertCount;\n}\n\n// ============================================\n// EVENT HANDLERS\n// ============================================\n\n// RFC-0096: Filter modal instance (lazy initialized)\nlet temperatureFilterModal = null;\n\n/**\n * RFC-0096: Initialize filter modal using shared factory from MAIN\n */\nfunction initFilterModal() {\n  const createFilterModal = window.MyIOUtils?.createFilterModal;\n\n  if (!createFilterModal) {\n    LogHelper.error('[TEMPERATURE_SENSORS] createFilterModal not available from MAIN');\n    return null;\n  }\n\n  return createFilterModal({\n    widgetName: 'TEMPERATURE_SENSORS',\n    containerId: 'temperatureSensorsFilterModalGlobal',\n    modalClass: 'temperature-sensors-modal',\n    primaryColor: '#e65100', // Orange for temperature\n    itemIdAttr: 'data-entity',\n\n    // Filter tabs configuration - specific for TEMPERATURE_SENSORS\n    filterTabs: [\n      {\n        id: 'all',\n        label: 'Todos',\n        filter: () => true,\n      },\n      {\n        id: 'online',\n        label: 'Online',\n        filter: (s) => s.status !== 'no_info' && s.status !== 'offline',\n      },\n      {\n        id: 'offline',\n        label: 'Offline',\n        filter: (s) => s.status === 'no_info' || s.status === 'offline',\n      },\n      {\n        id: 'normal',\n        label: 'Normal',\n        filter: (s) => s.status === 'normal',\n      },\n      {\n        id: 'alert',\n        label: 'Alerta',\n        filter: (s) => s.status === 'hot' || s.status === 'cold',\n      },\n    ],\n\n    // Data accessors\n    getItemId: (item) => item.id,\n    getItemLabel: (item) => item.label || item.name || item.id,\n    getItemValue: (item) => item.temperature,\n    getItemSubLabel: (item) => getCustomerNameForDevice(item),\n    formatValue: (val) => formatTemperature(val),\n\n    // Callbacks\n    onApply: ({ selectedIds, sortMode }) => {\n      STATE.selectedIds = selectedIds;\n      STATE.sortMode = sortMode;\n      reflowCards();\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filters applied via shared modal');\n    },\n\n    onReset: () => {\n      STATE.selectedIds = null;\n      STATE.sortMode = 'temp_desc';\n      STATE.searchTerm = '';\n      STATE.searchActive = false;\n\n      // Reset search UI\n      const searchWrap = document.getElementById('tempSearchWrap');\n      const searchInput = document.getElementById('tempSensorSearch');\n      if (searchWrap) searchWrap.classList.remove('active');\n      if (searchInput) searchInput.value = '';\n\n      reflowCards();\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filters reset via shared modal');\n    },\n\n    onClose: () => {\n      LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filter modal closed');\n    },\n  });\n}\n\n/**\n * RFC-0096: Open filter modal\n */\nfunction openFilterModal() {\n  // Lazy initialize modal\n  if (!temperatureFilterModal) {\n    temperatureFilterModal = initFilterModal();\n  }\n\n  if (!temperatureFilterModal) {\n    LogHelper.error('[TEMPERATURE_SENSORS] Failed to initialize filter modal');\n    window.alert('Erro ao inicializar modal de filtros. Verifique se o widget MAIN foi carregado.');\n    return;\n  }\n\n  // Open with current sensors and state\n  temperatureFilterModal.open(STATE.allSensors, {\n    selectedIds: STATE.selectedIds,\n    sortMode: STATE.sortMode,\n  });\n}\n\nfunction bindFilterEvents() {\n  // Search button toggle\n  const btnSearch = document.getElementById('btnTempSearch');\n  const searchWrap = document.getElementById('tempSearchWrap');\n  const searchInput = document.getElementById('tempSensorSearch');\n\n  if (btnSearch && searchWrap && searchInput) {\n    btnSearch.addEventListener('click', () => {\n      STATE.searchActive = !STATE.searchActive;\n      searchWrap.classList.toggle('active', STATE.searchActive);\n      if (STATE.searchActive) {\n        setTimeout(() => searchInput.focus(), 100);\n      }\n    });\n\n    searchInput.addEventListener('input', (e) => {\n      STATE.searchTerm = e.target.value || '';\n      reflowCards();\n    });\n  }\n\n  // Filter button - RFC-0096: Now opens filter modal\n  const btnFilter = document.getElementById('btnTempFilter');\n  if (btnFilter) {\n    btnFilter.addEventListener('click', () => {\n      LogHelper.log('[TEMPERATURE_SENSORS] Filter button clicked - opening modal');\n      openFilterModal();\n    });\n  }\n}\n\nfunction renderShoppingFilterChips(selection) {\n  const chipsContainer = document.getElementById('tempShoppingFilterChips');\n  if (!chipsContainer) return;\n\n  chipsContainer.innerHTML = '';\n\n  if (!selection || selection.length === 0) {\n    return;\n  }\n\n  selection.forEach((shopping) => {\n    const chip = document.createElement('span');\n    chip.className = 'filter-chip';\n    chip.innerHTML = `<span class=\"filter-chip-icon\">üè¨</span><span>${shopping.name}</span>`;\n    chipsContainer.appendChild(chip);\n  });\n\n  LogHelper.log('[TEMPERATURE_SENSORS] Rendered', selection.length, 'shopping filter chips');\n}\n\n// ============================================\n// WIDGET LIFECYCLE\n// ============================================\n\nself.onInit = async function () {\n  LogHelper.log('[TEMPERATURE_SENSORS] onInit - RFC-0092');\n\n  // Load card rendering options from settings\n  USE_NEW_COMPONENTS = self.ctx.settings?.useNewComponents ?? true;\n  ENABLE_SELECTION = self.ctx.settings?.enableSelection ?? true;\n  HIDE_INFO_MENU_ITEM = self.ctx.settings?.hideInfoMenuItem ?? true;\n  DEBUG_ACTIVE = self.ctx.settings?.debugActive ?? false;\n  ACTIVE_TOOLTIP_DEBUG = self.ctx.settings?.activeTooltipDebug ?? false;\n  LogHelper.log(\n    `[TEMPERATURE_SENSORS] Configured: debugActive=${DEBUG_ACTIVE}, activeTooltipDebug=${ACTIVE_TOOLTIP_DEBUG}`\n  );\n\n  showLoadingOverlay(true);\n\n  setTimeout(async () => {\n    // Wait for date params from parent\n    function waitForDateParams({ pollMs = 300, timeoutMs = 10000 } = {}) {\n      return new Promise((resolve) => {\n        let resolved = false;\n        let poller = null;\n        let timer = null;\n\n        const tryResolve = (p) => {\n          const s = p?.globalStartDateFilter || null;\n          const e = p?.globalEndDateFilter || null;\n          if (s && e) {\n            resolved = true;\n            cleanup();\n            resolve({\n              start: s,\n              end: e,\n              from: 'state/event',\n            });\n            return true;\n          }\n          return false;\n        };\n\n        const cleanup = () => {\n          window.removeEventListener('myio:date-params', onEvt);\n          if (poller) clearInterval(poller);\n          if (timer) clearTimeout(timer);\n        };\n\n        const onEvt = (ev) => tryResolve(ev.detail);\n        window.addEventListener('myio:date-params', onEvt);\n\n        if (tryResolve(window.myioStateParams || {})) return;\n\n        poller = setInterval(() => tryResolve(window.myioStateParams || {}), pollMs);\n\n        timer = setTimeout(() => {\n          if (!resolved) {\n            cleanup();\n            const end = new Date();\n            const start = new Date(end.getTime() - 7 * 24 * 60 * 60 * 1000);\n            resolve({\n              start: start.toISOString(),\n              end: end.toISOString(),\n              from: 'fallback-7d',\n            });\n          }\n        }, timeoutMs);\n      });\n    }\n\n    const dateParams = await waitForDateParams();\n    LogHelper.log('[TEMPERATURE_SENSORS] Date params ready:', dateParams);\n\n    // Listen for shopping filter events\n    self._onFilterApplied = (ev) => {\n      LogHelper.log('[TEMPERATURE_SENSORS] heard myio:filter-applied:', ev.detail);\n\n      const selection = ev.detail?.selection || [];\n      const shoppingIds = selection.map((s) => s.value).filter((v) => v);\n\n      STATE.selectedShoppingIds = shoppingIds;\n      renderShoppingFilterChips(selection);\n      reflowCards();\n    };\n    window.addEventListener('myio:filter-applied', self._onFilterApplied);\n\n    // Listen for customers ready\n    self._onCustomersReady = (ev) => {\n      LogHelper.log('[TEMPERATURE_SENSORS] heard myio:customers-ready:', ev.detail);\n      const customers = ev.detail?.customers || [];\n      if (customers.length > 0) {\n        STATE.totalShoppings = customers.length;\n        renderShoppingFilterChips(customers);\n      }\n    };\n    window.addEventListener('myio:customers-ready', self._onCustomersReady, {\n      once: true,\n    });\n\n    // Fetch and render sensors\n    const sensors = await fetchTemperatureSensors();\n    initializeSensorCards(sensors);\n    updateSensorStats(sensors);\n\n    // Bind filter events\n    bindFilterEvents();\n\n    showLoadingOverlay(false);\n  }, 0);\n};\n\nself.onDataUpdated = function () {\n  /*\n    LogHelper.log('[TEMPERATURE_SENSORS] onDataUpdated');\n    fetchTemperatureSensors().then((sensors) => {\n      STATE.allSensors = sensors;\n      reflowCards();\n    });\n    */\n};\n\nself.onDestroy = function () {\n  if (self._onFilterApplied) {\n    window.removeEventListener('myio:filter-applied', self._onFilterApplied);\n  }\n  if (self._onCustomersReady) {\n    window.removeEventListener('myio:customers-ready', self._onCustomersReady);\n  }\n\n  // RFC-0096: Cleanup filter modal\n  if (temperatureFilterModal) {\n    temperatureFilterModal.destroy();\n    temperatureFilterModal = null;\n    LogHelper.log('[TEMPERATURE_SENSORS] [RFC-0096] Filter modal destroyed');\n  }\n\n  LogHelper.log('[TEMPERATURE_SENSORS] Widget destroyed');\n};\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Temperature Sensors Widget Settings\",\r\n    \"properties\": {\r\n        \"useNewComponents\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Use New Components\",\r\n            \"default\": true\r\n        },\r\n        \"enableSelection\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Enable Selection\",\r\n            \"default\": true\r\n        },\r\n        \"hideInfoMenuItem\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Hide Info Menu Item\",\r\n            \"default\": true\r\n        },\r\n        \"debugActive\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Debug Active\",\r\n            \"default\": false\r\n        },\r\n        \"activeTooltipDebug\":{\r\n            \"type\":\"boolean\",\r\n            \"title\": \"Active Tooltip Debug\",\r\n            \"default\": false\r\n        }\r\n    }\r\n  },\r\n  \"form\": [\r\n    \"useNewComponents\",\r\n    \"enableSelection\",\r\n    \"hideInfoMenuItem\",\r\n    \"debugActive\",\r\n    \"activeTooltipDebug\"\r\n  ]\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - TEMPERATURE SENSORS - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "d51f33f0-cf84-11f0-998e-25174baff087"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}