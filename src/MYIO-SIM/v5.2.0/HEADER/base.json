{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_header_v_5_2_0",
    "name": "Widget Head Office - HEADER - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://unpkg.com/myio-js-library@latest/dist/myio-js-library.umd.min.js"
        }
      ],
      "templateHtml": "<section class=\"myio-toolbar-root\">\r\n  <!-- ‚¨áÔ∏è Wrapper que coloca os cards lado a lado em grid -->\r\n  <div class=\"myio-cards\">\r\n    <!-- üÜï Card de logo MYIO -->\r\n    <article class=\"myio-card v2 myio-card-logo\">\r\n      <!-- Bot√£o premium para voltar ao dashboard principal -->\r\n      <button\r\n        class=\"myio-back-btn\"\r\n        id=\"back-to-welcome-btn\"\r\n        title=\"Voltar ao Dashboard Principal\"\r\n        onclick=\"window.location.href='/dashboards/a6272d20-c974-11f0-84a2-1f4ed3957b2a'\"\r\n      >\r\n        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n          <path d=\"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z\"/>\r\n          <polyline points=\"9 22 9 12 15 12 15 22\"/>\r\n        </svg>\r\n      </button>\r\n      <div class=\"logo-box\">\r\n        <img src=\"/api/images/public/Gi9qaUMi2Z7G2wrdReKzMCZu5epG17lX\" alt=\"MYIO Logo\" />\r\n      </div>\r\n    </article>\r\n    <article class=\"myio-card v2\" id=\"card-equip\">\r\n      <header class=\"myio-card-hd\">\r\n        <span class=\"hd-title\">\r\n          Equipamentos\r\n          <span class=\"equip-info-trigger\" id=\"equip-info-trigger\">‚ÑπÔ∏è</span>\r\n        </span>\r\n        <span class=\"hd-ico\" aria-hidden=\"true\">\r\n          <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n            <path d=\"M4 4h16v16H4z\" stroke=\"#9BB4C9\" stroke-width=\"1.6\" />\r\n            <path d=\"M8 8h8v8H8z\" stroke=\"#9BB4C9\" stroke-width=\"1.6\" />\r\n          </svg>\r\n        </span>\r\n      </header>\r\n      <div class=\"myio-card-main\">\r\n        <div class=\"myio-kpi\"><span id=\"equip-kpi\">-</span></div>\r\n        <div class=\"myio-subrow\">\r\n          <span id=\"equip-sub\">-</span>\r\n        </div>\r\n      </div>\r\n    </article>\r\n\r\n    <article class=\"myio-card v2\" id=\"card-energy\">\r\n      <header class=\"myio-card-hd\">\r\n        <span class=\"hd-title\">\r\n          Consumo de Energia\r\n          <span class=\"energy-info-trigger\" id=\"energy-info-trigger\">‚ÑπÔ∏è</span>\r\n        </span>\r\n        <span class=\"hd-ico\" aria-hidden=\"true\">\r\n          <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n            <path d=\"M13 2L3 14h7l-1 8 10-12h-7l1-8z\" fill=\"#B7D14B\" />\r\n          </svg>\r\n        </span>\r\n      </header>\r\n      <div class=\"myio-card-main\">\r\n        <div class=\"myio-kpi\"><span id=\"energy-kpi\">-</span></div>\r\n        <div class=\"myio-subrow\">\r\n          <span id=\"energy-trend\"></span>\r\n        </div>\r\n      </div>\r\n    </article>\r\n\r\n    <article class=\"myio-card v2\" id=\"card-temp\">\r\n      <header class=\"myio-card-hd\">\r\n        <span class=\"hd-title\">\r\n          M√©dia de Temperatura\r\n          <span class=\"temp-info-trigger\" id=\"temp-info-trigger\">‚ÑπÔ∏è</span>\r\n        </span>\r\n        <span class=\"hd-ico\" aria-hidden=\"true\">\r\n          <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n            <path d=\"M10 3v10a4 4 0 104 0V3\" stroke=\"#9BB4C9\" stroke-width=\"1.6\" />\r\n          </svg>\r\n        </span>\r\n      </header>\r\n      <div class=\"myio-card-main\">\r\n        <div class=\"myio-kpi\"><span id=\"temp-kpi\">-</span></div>\r\n        <!-- RFC-0099: Subrow for comparative percentage display -->\r\n        <div class=\"myio-subrow\">\r\n          <span id=\"temp-trend\"></span>\r\n        </div>\r\n        <div class=\"chip\" id=\"temp-chip\">\r\n          - Aguardando dados\r\n          <span class=\"info-icon\" id=\"temp-info-icon\" title=\"Aguardando dados de temperatura\">\r\n            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n              <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-width=\"2\" />\r\n              <path d=\"M12 16v-4M12 8h.01\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" />\r\n            </svg>\r\n          </span>\r\n        </div>\r\n        <div class=\"myio-foot\" id=\"temp-range\"></div>\r\n      </div>\r\n    </article>\r\n\r\n    <article class=\"myio-card v2 has-bar\" id=\"card-water\" data-pct=\"87\">\r\n      <header class=\"myio-card-hd\">\r\n        <span class=\"hd-title\">\r\n          √Ågua\r\n          <span class=\"water-info-trigger\" id=\"water-info-trigger\">‚ÑπÔ∏è</span>\r\n        </span>\r\n        <span class=\"hd-ico\" aria-hidden=\"true\">\r\n          <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n            <path d=\"M12 3c-4 5-6 8-6 11a6 6 0 0012 0c0-3-2-6-6-11z\" stroke=\"#7FB8E6\" stroke-width=\"1.6\" />\r\n          </svg>\r\n        </span>\r\n      </header>\r\n      <div class=\"myio-card-main\">\r\n        <div class=\"myio-kpi\"><span id=\"water-kpi\">-</span></div>\r\n        <div class=\"myio-subrow\">\r\n          <span id=\"water-trend\"></span>\r\n        </div>\r\n      </div>\r\n    </article>\r\n  </div>\r\n</section>\r\n",
      "templateCss": ":root {\r\n  --card-bg: transparent;\r\n  --card-bg-grad: transparent;\r\n  --card-bd: #e6eef5;\r\n  --ink-1: #1c2743;\r\n  --ink-2: #6b7a90;\r\n  --ok: #1f9d55;\r\n  --warn: #d97706;\r\n  --down: #099250; /* verde para queda boa */\r\n  --up: #c2410c; /* laranja para alta ruim */\r\n  --bar-ok: #9fc131;\r\n  --bar-bg: #1c2743; /* base azul escuro, fina */\r\n  --shadow: 0 8px 24px rgba(31, 116, 164, 0.08);\r\n  --radius: 16px;\r\n}\r\n\r\n.myio-toolbar-root {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  width: 100%;\r\n  height: 100%;\r\n  padding: 8px 12px 4px 12px;\r\n  box-sizing: border-box;\r\n  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;\r\n  color: var(--ink-1);\r\n  background: transparent !important;\r\n  overflow: none !important;\r\n}\r\n.widget-type-tenant-widget_head_office_main_v_1_0_0 #container {\r\n  overflow: hidden !important;\r\n}\r\n\r\n/* For√ßa transpar√™ncia em todos os elementos internos, EXCETO a logo e cards principais */\r\n.myio-toolbar-root\r\n  *:not(.myio-card-logo):not(.myio-card-logo *):not(#card-equip):not(#card-energy):not(#card-temp):not(\r\n    #card-water\r\n  ),\r\n.myio-toolbar-root\r\n  *:not(.myio-card-logo):not(.myio-card-logo *):not(#card-equip):not(#card-energy):not(#card-temp):not(\r\n    #card-water\r\n  )::before,\r\n.myio-toolbar-root\r\n  *:not(.myio-card-logo):not(.myio-card-logo *):not(#card-equip):not(#card-energy):not(#card-temp):not(\r\n    #card-water\r\n  )::after {\r\n  background-color: transparent !important;\r\n}\r\n\r\n/* Exce√ß√£o para tabs e bot√µes que precisam de fundo branco */\r\n.tab,\r\n.myio-filter-btn {\r\n  background: #fff !important;\r\n  background-color: #fff !important;\r\n}\r\n\r\n/* ===== Cards ===== */\r\n.myio-cards {\r\n  display: grid;\r\n  grid-template-columns: repeat(5, 1fr);\r\n  gap: 10px;\r\n  background: transparent !important;\r\n}\r\n.myio-card {\r\n  background: transparent;\r\n  background-color: transparent;\r\n  background-image: none !important;\r\n  border: 1px solid var(--card-bd);\r\n  border-radius: 14px;\r\n  box-shadow: var(--shadow);\r\n  padding: 10px 12px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n  min-height: 113px;\r\n  max-height: 113px;\r\n}\r\n.myio-card-hd {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  font-size: 0.9rem;\r\n  color: var(--ink-2);\r\n}\r\n.myio-card-ico {\r\n  opacity: 0.65;\r\n}\r\n.myio-card-main {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n.myio-kpi {\r\n  font-size: 1.8rem;\r\n  font-weight: 800;\r\n  letter-spacing: 0.3px;\r\n}\r\n.myio-subrow {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  font-size: 0.9rem;\r\n  color: var(--ink-2);\r\n}\r\n.myio-foot {\r\n  font-size: 0.85rem;\r\n  color: var(--ink-2);\r\n}\r\n.dot {\r\n  width: 10px;\r\n  height: 10px;\r\n  border-radius: 10px;\r\n  display: inline-block;\r\n}\r\n.dot-ok {\r\n  background: var(--bar-ok);\r\n}\r\n\r\n.myio-bar {\r\n  height: 10px;\r\n  width: 100%;\r\n  border-radius: 20px;\r\n  background: linear-gradient(90deg, var(--bar-bg) 0 80%, #c3d3e6 80% 100%);\r\n  overflow: hidden;\r\n  border: 0;\r\n}\r\n.myio-bar-fill {\r\n  height: 100%;\r\n  border-radius: 20px;\r\n  background: var(--bar-ok);\r\n  transition: width 0.3s ease;\r\n}\r\n\r\n.ok {\r\n  color: var(--ok);\r\n  font-weight: 600;\r\n}\r\n.warn {\r\n  color: var(--warn);\r\n  font-weight: 600;\r\n}\r\n.trend.down {\r\n  color: var(--down);\r\n  font-weight: 600;\r\n}\r\n.trend.up {\r\n  color: var(--up);\r\n  font-weight: 600;\r\n}\r\n\r\n/* ===== Tabs ===== */\r\n.myio-tabs-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  gap: 12px;\r\n}\r\n.myio-tabs {\r\n  display: flex;\r\n  gap: 10px;\r\n  flex-wrap: wrap;\r\n}\r\n.tab {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  border: 1px solid #e6eef5;\r\n  background: #fff;\r\n  color: var(--ink-1);\r\n  border-radius: 12px;\r\n  padding: 8px 14px;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);\r\n}\r\n.tab:hover {\r\n  filter: brightness(0.98);\r\n}\r\n.tab.is-active {\r\n  background: #e9f0f6;\r\n  border-color: #d5e2ee;\r\n}\r\n.tab .ico {\r\n  opacity: 0.8;\r\n}\r\n\r\n/* Filtro button */\r\n.myio-filter-btn {\r\n  margin-left: auto;\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  border: 1px solid #101828;\r\n  background: #fff;\r\n  border-radius: 12px;\r\n  padding: 8px 14px;\r\n  font-weight: 700;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);\r\n}\r\n.myio-filter-btn:hover {\r\n  filter: brightness(0.98);\r\n}\r\n\r\n/* Removido - defini√ß√µes duplicadas movidas para o final do arquivo */\r\n\r\n/* ==== Modal ==== */\r\n.myio-modal {\r\n  position: fixed;\r\n  inset: 0;\r\n  display: none;\r\n  z-index: 9999;\r\n}\r\n.myio-modal[aria-hidden='false'] {\r\n  display: block;\r\n}\r\n.myio-modal-backdrop {\r\n  position: absolute;\r\n  inset: 0;\r\n  background: rgba(16, 24, 40, 0.45);\r\n}\r\n.myio-modal-card {\r\n  position: absolute;\r\n  left: 50%;\r\n  top: 50%;\r\n  transform: translate(-50%, -50%);\r\n  width: min(1000px, 92vw);\r\n  background: #fff;\r\n  border-radius: 16px;\r\n  box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);\r\n  overflow: hidden;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n.myio-modal-hd {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  padding: 16px 18px;\r\n  border-bottom: 1px solid #e6eef5;\r\n}\r\n.myio-modal-body {\r\n  padding: 16px 18px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12px;\r\n}\r\n.myio-modal-ft {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  gap: 12px;\r\n  padding: 14px 18px;\r\n  border-top: 1px solid #e6eef5;\r\n}\r\n\r\n.close-x {\r\n  border: 0;\r\n  background: transparent;\r\n  font-size: 24px;\r\n  cursor: pointer;\r\n  line-height: 1;\r\n}\r\n\r\n.flt-row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  flex-wrap: wrap;\r\n}\r\n.flt-search {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  flex: 1;\r\n  border: 2px solid #bbd0e3;\r\n  border-radius: 12px;\r\n  padding: 6px 10px;\r\n}\r\n.flt-search:focus-within {\r\n  border-color: #4f93ce;\r\n  box-shadow: 0 0 0 3px rgba(79, 147, 206, 0.15);\r\n}\r\n.flt-search input {\r\n  width: 100%;\r\n  border: 0;\r\n  outline: 0;\r\n  font-size: 15px;\r\n}\r\n\r\n.link-btn {\r\n  border: 0;\r\n  background: transparent;\r\n  font-weight: 600;\r\n  cursor: pointer;\r\n  color: #344054;\r\n}\r\n.save-btn {\r\n  border: 0;\r\n  background: #b7d14b;\r\n  color: #1c2743;\r\n  font-weight: 700;\r\n  padding: 8px 12px;\r\n  border-radius: 10px;\r\n  cursor: pointer;\r\n}\r\n.apply-btn {\r\n  border: 0;\r\n  background: #1d4f91;\r\n  color: #fff;\r\n  font-weight: 700;\r\n  padding: 10px 16px;\r\n  border-radius: 10px;\r\n  cursor: pointer;\r\n}\r\n\r\n.flt-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12px;\r\n  max-height: 48vh;\r\n  overflow: auto;\r\n  padding-right: 4px;\r\n}\r\n.flt-item {\r\n  border: 1px solid #cfdce8;\r\n  border-radius: 12px;\r\n  padding: 14px;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n}\r\n.flt-item:hover {\r\n  background: #f7faff;\r\n}\r\n.flt-radio {\r\n  width: 18px;\r\n  height: 18px;\r\n  border-radius: 10px;\r\n  border: 2px solid #6991b7;\r\n  display: inline-block;\r\n  position: relative;\r\n  flex: 0 0 auto;\r\n}\r\n.flt-item[aria-selected='true'] .flt-radio {\r\n  border-color: #1d4f91;\r\n}\r\n.flt-item[aria-selected='true'] .flt-radio::after {\r\n  content: '';\r\n  position: absolute;\r\n  inset: 3px;\r\n  border-radius: 8px;\r\n  background: #1d4f91;\r\n}\r\n\r\n.flt-title {\r\n  font-weight: 700;\r\n}\r\n.flt-chip {\r\n  margin-left: auto;\r\n  background: #eff6ff;\r\n  color: #1c2743;\r\n  padding: 2px 8px;\r\n  border-radius: 10px;\r\n  font-size: 12px;\r\n  border: 1px solid #d6e4f2;\r\n}\r\n\r\n/* ===== v2 ‚Äì acabamento premium ===== */\r\n.myio-card.v2 {\r\n  position: relative;\r\n  background: transparent;\r\n  background-color: transparent;\r\n  background-image: none !important;\r\n  border: 1px solid #e6eef5;\r\n  border-radius: 14px;\r\n  box-shadow: 0 1px 1px rgba(16, 24, 40, 0.04), 0 8px 22px rgba(31, 116, 164, 0.08);\r\n  padding: 10px 12px 12px;\r\n  transition: box-shadow 0.2s ease, transform 0.08s ease;\r\n  min-height: 113px;\r\n  max-height: 113px;\r\n}\r\n\r\n.myio-card.v2:hover {\r\n  transform: translateY(-1px);\r\n  box-shadow: 0 2px 2px rgba(16, 24, 40, 0.05), 0 10px 26px rgba(31, 116, 164, 0.12);\r\n}\r\n\r\n.myio-card.v2 .myio-card-hd {\r\n  padding-bottom: 6px;\r\n}\r\n.myio-card.v2 .hd-title {\r\n  font-size: 0.82rem;\r\n  font-weight: 700;\r\n  color: #4a5b6b;\r\n}\r\n.myio-card.v2 .hd-ico {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 24px;\r\n  height: 24px;\r\n  border: 1px solid #e3edf6;\r\n  border-radius: 8px;\r\n  background: transparent;\r\n}\r\n\r\n.myio-card.v2 .kpi {\r\n  font-size: 1.6rem;\r\n  line-height: 1.1;\r\n  font-weight: 800;\r\n  letter-spacing: 0.2px;\r\n  color: #0f1f2e;\r\n}\r\n.myio-card.v2 .subrow {\r\n  margin-top: 4px;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  color: #6b7a90;\r\n  font-size: 0.85rem;\r\n}\r\n.myio-card.v2 .foot {\r\n  margin-top: 4px;\r\n  color: #6b7a90;\r\n  font-size: 0.8rem;\r\n}\r\n\r\n/* chips (ok/warn/trend) */\r\n.chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  font-weight: 700;\r\n  font-size: 0.95rem;\r\n  margin-top: 6px;\r\n  border: none !important;\r\n}\r\n.chip.ok {\r\n  color: #1f9d55;\r\n}\r\n.chip.warn {\r\n  color: #d97706;\r\n}\r\n.chip.trend.down {\r\n  color: #099250;\r\n}\r\n.chip.trend.up {\r\n  color: #c2410c;\r\n}\r\n\r\n/* barra com ‚Äúrabinho‚Äù verde no final */\r\n.myio-card.v2 .bar {\r\n  --pct: 0; /* preenchido (0‚Äì100) */\r\n  --tail: 10; /* ‚Äúrabinho‚Äù em % do card preenchido */\r\n  margin-top: 10px;\r\n  height: 10px;\r\n  width: 100%;\r\n  background: #e6eff7;\r\n  border-radius: 20px;\r\n  overflow: hidden;\r\n  box-shadow: inset 0 1px 2px rgba(16, 24, 40, 0.08);\r\n}\r\n.myio-card.v2 .bar-fill {\r\n  height: 100%;\r\n  /* faixa azul + cauda verde no final (percentual controlado por JS) */\r\n  background: linear-gradient(\r\n    90deg,\r\n    #1d4f91 0 calc(100% - var(--tail) * 1%),\r\n    #9fc131 calc(100% - var(--tail) * 1%) 100%\r\n  );\r\n  width: calc(var(--pct) * 1%); /* recebe via JS */\r\n  transition: width 0.35s ease;\r\n}\r\n\r\n/* ‚Äú√°gua‚Äù com glow sutil */\r\n#card-water.v2 {\r\n  box-shadow: 0 1px 1px rgba(16, 24, 40, 0.04), 0 8px 22px rgba(79, 147, 206, 0.1),\r\n    0 0 0 1px rgba(122, 169, 210, 0.06) inset;\r\n}\r\n\r\n/* aliases para compatibilidade */\r\n.myio-card-main .kpi {\r\n  composes: myio-kpi;\r\n} /* se seu bundler n√£o suporta 'composes', use as regras abaixo */\r\n.myio-card-main .subrow {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  color: #6b7a90;\r\n  font-size: 0.95rem;\r\n}\r\n.myio-card-main .bar {\r\n  height: 10px;\r\n  width: 100%;\r\n  border-radius: 20px;\r\n  background: #e6eff7;\r\n  overflow: hidden;\r\n  box-shadow: inset 0 1px 2px rgba(16, 24, 40, 0.08);\r\n}\r\n.myio-card-main .bar-fill {\r\n  height: 100%;\r\n  background: linear-gradient(90deg, #1d4f91 0 calc(100% - 8%), #9fc131 calc(100% - 8%) 100%);\r\n  transition: width 0.35s;\r\n}\r\n\r\n/* Removido - defini√ß√µes duplicadas que sobrescreviam o grid principal */\r\n\r\n.myio-card.v2 .hd-title {\r\n  margin-bottom: 2px; /* aproxima do KPI */\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n.myio-card.v2 .myio-card-hd {\r\n  padding-bottom: 0; /* remove espa√ßamento desnecess√°rio */\r\n}\r\n\r\n/* ===== Info Icon with Tooltip ===== */\r\n.info-icon {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  cursor: help;\r\n  opacity: 0.6;\r\n  transition: opacity 0.2s ease;\r\n  position: relative;\r\n  margin-left: 2px;\r\n}\r\n\r\n.info-icon:hover {\r\n  opacity: 1;\r\n}\r\n\r\n.info-icon svg {\r\n  vertical-align: middle;\r\n}\r\n\r\n/* Chip com info icon */\r\n.chip .info-icon {\r\n  margin-left: 4px;\r\n}\r\n\r\n/* Ocultar textos do rodap√© dos cards - informa√ß√µes agora est√£o nos tooltips */\r\n#temp-range,\r\n#energy-peak,\r\n#water-alert {\r\n  display: none !important;\r\n}\r\n\r\n/* Cards personaliz√°veis - elementos internos herdam a cor do card */\r\n#card-equip *:not(svg):not(path):not(circle),\r\n#card-energy *:not(svg):not(path):not(circle),\r\n#card-temp *:not(svg):not(path):not(circle),\r\n#card-water *:not(svg):not(path):not(circle) {\r\n  color: inherit !important;\r\n}\r\n\r\n/* T√≠tulos dos cards personaliz√°veis */\r\n#card-equip .hd-title,\r\n#card-energy .hd-title,\r\n#card-temp .hd-title,\r\n#card-water .hd-title {\r\n  color: inherit !important;\r\n  opacity: 0.85;\r\n}\r\n\r\n/* KPIs dos cards personaliz√°veis */\r\n#card-equip .myio-kpi,\r\n#card-energy .myio-kpi,\r\n#card-temp .myio-kpi,\r\n#card-water .myio-kpi {\r\n  color: inherit !important;\r\n}\r\n\r\n/* ===== Card da Logo - Vers√£o √önica e Limpa ===== */\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo,\r\n.myio-card.v2.myio-card-logo {\r\n  position: relative !important;\r\n  background: #1f3a35 !important;\r\n  background-color: #1f3a35 !important;\r\n  background-image: none !important;\r\n  border: 0 !important;\r\n  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2) !important;\r\n  display: flex !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  padding: 0 !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo *,\r\n.myio-card.v2.myio-card-logo * {\r\n  background: none !important;\r\n  background-color: transparent !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .logo-box,\r\n.myio-card.v2.myio-card-logo .logo-box {\r\n  display: flex !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  width: 100% !important;\r\n  height: 100% !important;\r\n  background: none !important;\r\n  background-color: transparent !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .logo-box img,\r\n.myio-card.v2.myio-card-logo .logo-box img {\r\n  max-width: 336px !important; /* 240px * 1.4 = 336px */\r\n  max-height: 224px !important; /* 160px * 1.4 = 224px */\r\n  width: 140% !important; /* Escala proporcional em 40% */\r\n  height: auto !important; /* Mant√©m propor√ß√£o */\r\n  object-fit: contain !important;\r\n  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25)) !important;\r\n  background: none !important;\r\n  background-color: transparent !important;\r\n}\r\n\r\n/* Bot√£o premium de voltar - posicionado √† esquerda */\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .myio-back-btn,\r\n.myio-card.v2.myio-card-logo .myio-back-btn {\r\n  position: absolute !important;\r\n  left: 8px !important;\r\n  top: 50% !important;\r\n  transform: translateY(-50%) !important;\r\n  width: 56px !important;\r\n  height: 56px !important;\r\n  padding: 0 !important;\r\n  border: none !important;\r\n  border-radius: 12px !important;\r\n  background: rgba(255, 255, 255, 0.15) !important;\r\n  color: rgba(255, 255, 255, 0.75) !important;\r\n  cursor: pointer !important;\r\n  display: flex !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  transition: all 0.2s ease !important;\r\n  z-index: 10 !important;\r\n  opacity: 0.85 !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .myio-back-btn:hover,\r\n.myio-card.v2.myio-card-logo .myio-back-btn:hover {\r\n  background: rgba(255, 255, 255, 0.25) !important;\r\n  color: rgba(255, 255, 255, 1) !important;\r\n  opacity: 1 !important;\r\n  transform: translateY(-50%) scale(1.05) !important;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .myio-back-btn:active,\r\n.myio-card.v2.myio-card-logo .myio-back-btn:active {\r\n  transform: translateY(-50%) scale(0.95) !important;\r\n}\r\n\r\n.myio-toolbar-root .myio-cards .myio-card.v2.myio-card-logo .myio-back-btn svg,\r\n.myio-card.v2.myio-card-logo .myio-back-btn svg {\r\n  width: 32px !important;\r\n  height: 32px !important;\r\n  stroke: currentColor !important;\r\n  fill: none !important;\r\n}\r\n\r\n/* breakpoints responsivos - prioriza 5 colunas */\r\n@media (max-width: 1200px) {\r\n  .myio-cards {\r\n    grid-template-columns: repeat(5, 1fr);\r\n    gap: 8px;\r\n  }\r\n}\r\n@media (max-width: 1024px) {\r\n  .myio-cards {\r\n    grid-template-columns: repeat(5, minmax(140px, 1fr));\r\n    gap: 6px;\r\n  }\r\n}\r\n@media (max-width: 900px) {\r\n  .myio-cards {\r\n    grid-template-columns: repeat(3, 1fr);\r\n  }\r\n}\r\n@media (max-width: 600px) {\r\n  .myio-cards {\r\n    grid-template-columns: repeat(2, 1fr);\r\n  }\r\n}\r\n@media (max-width: 400px) {\r\n  .myio-cards {\r\n    grid-template-columns: 1fr;\r\n  }\r\n}\r\n\r\n@keyframes spin {\r\n  0% {\r\n    transform: rotate(0deg);\r\n  }\r\n  100% {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* Container principal do modal */\r\n.myio-modal {\r\n  position: fixed; /* Fixa o modal na tela, ignorando a rolagem */\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  display: flex; /* Permite centralizar o conte√∫do do modal */\r\n  justify-content: center; /* Centraliza horizontalmente */\r\n  align-items: center; /* Centraliza verticalmente */\r\n  z-index: 1000; /* Coloca o modal acima de todo o resto */\r\n}\r\n\r\n/* Fundo semi-transparente do modal (o \"backdrop\") */\r\n.myio-modal-backdrop {\r\n  position: absolute; /* Posi√ß√£o absoluta dentro do .myio-modal */\r\n  top: 0;\r\n  left: 0;\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: rgba(0, 0, 0, 0.5); /* Cor preta com 50% de opacidade */\r\n}\r\n\r\n/* Conte√∫do do modal (o \"cart√£o\" branco) */\r\n.myio-modal-card {\r\n  position: relative; /* Para que o conte√∫do fique acima do backdrop */\r\n  z-index: 1001;\r\n  background-color: #fff;\r\n  border-radius: 8px;\r\n  padding: 20px;\r\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n/* Estado inicial do modal (escondido) */\r\n/* Isso √© √∫til se voc√™ usar o atributo aria-hidden para mostrar/esconder */\r\n.myio-modal[aria-hidden='true'] {\r\n  display: none;\r\n}\r\n\r\n.tab input:focus {\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n}\r\n\r\n/* ============================================\r\n   PREMIUM TOOLTIP - Temperature Info\r\n   ============================================ */\r\n\r\n.temp-info-trigger {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  cursor: help;\r\n  opacity: 0.5;\r\n  transition: opacity 0.2s ease;\r\n  position: relative;\r\n  margin-left: 4px;\r\n  vertical-align: middle;\r\n}\r\n\r\n.temp-info-trigger:hover {\r\n  opacity: 1;\r\n}\r\n\r\n.temp-tooltip-container {\r\n  position: fixed;\r\n  z-index: 10000;\r\n  pointer-events: none;\r\n  opacity: 0;\r\n  transition: opacity 0.25s ease, transform 0.25s ease;\r\n  transform: translateY(5px);\r\n}\r\n\r\n.temp-tooltip-container.visible {\r\n  opacity: 1;\r\n  pointer-events: auto;\r\n  transform: translateY(0);\r\n}\r\n\r\n.temp-tooltip {\r\n  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);\r\n  border: 1px solid rgba(99, 102, 241, 0.3);\r\n  border-radius: 12px;\r\n  box-shadow:\r\n    0 20px 40px rgba(0, 0, 0, 0.4),\r\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\r\n    0 1px 0 rgba(255, 255, 255, 0.1) inset;\r\n  min-width: 320px;\r\n  max-width: 400px;\r\n  font-size: 12px;\r\n  color: #e2e8f0;\r\n  overflow: hidden;\r\n}\r\n\r\n.temp-tooltip__header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 12px 16px;\r\n  background: linear-gradient(90deg, rgba(249, 115, 22, 0.2) 0%, rgba(234, 88, 12, 0.1) 100%);\r\n  border-bottom: 1px solid rgba(249, 115, 22, 0.2);\r\n}\r\n\r\n.temp-tooltip__icon {\r\n  font-size: 16px;\r\n}\r\n\r\n.temp-tooltip__title {\r\n  font-weight: 700;\r\n  font-size: 13px;\r\n  color: #f1f5f9;\r\n  letter-spacing: 0.5px;\r\n}\r\n\r\n.temp-tooltip__content {\r\n  padding: 12px 16px;\r\n  max-height: 350px;\r\n  overflow-y: auto;\r\n}\r\n\r\n.temp-tooltip__section {\r\n  margin-bottom: 14px;\r\n  padding-bottom: 12px;\r\n  border-bottom: 1px solid rgba(148, 163, 184, 0.1);\r\n}\r\n\r\n.temp-tooltip__section:last-child {\r\n  margin-bottom: 0;\r\n  padding-bottom: 0;\r\n  border-bottom: none;\r\n}\r\n\r\n.temp-tooltip__section-title {\r\n  font-size: 11px;\r\n  font-weight: 600;\r\n  color: #94a3b8;\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.8px;\r\n  margin-bottom: 10px;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n\r\n.temp-tooltip__row {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding: 5px 0;\r\n  gap: 12px;\r\n}\r\n\r\n.temp-tooltip__label {\r\n  color: #94a3b8;\r\n  font-size: 11px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.temp-tooltip__value {\r\n  color: #f1f5f9;\r\n  font-weight: 500;\r\n  text-align: right;\r\n}\r\n\r\n.temp-tooltip__value--highlight {\r\n  color: #fdba74;\r\n  font-weight: 600;\r\n}\r\n\r\n.temp-tooltip__value--ok {\r\n  color: #4ade80;\r\n  font-weight: 600;\r\n}\r\n\r\n.temp-tooltip__value--warn {\r\n  color: #fbbf24;\r\n  font-weight: 600;\r\n}\r\n\r\n.temp-tooltip__badge {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n  padding: 3px 10px;\r\n  border-radius: 6px;\r\n  font-size: 11px;\r\n  font-weight: 600;\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.3px;\r\n}\r\n\r\n.temp-tooltip__badge--ok {\r\n  background: rgba(74, 222, 128, 0.2);\r\n  color: #4ade80;\r\n  border: 1px solid rgba(74, 222, 128, 0.3);\r\n}\r\n\r\n.temp-tooltip__badge--warn {\r\n  background: rgba(251, 191, 36, 0.2);\r\n  color: #fbbf24;\r\n  border: 1px solid rgba(251, 191, 36, 0.3);\r\n}\r\n\r\n.temp-tooltip__badge--info {\r\n  background: rgba(99, 102, 241, 0.2);\r\n  color: #a5b4fc;\r\n  border: 1px solid rgba(99, 102, 241, 0.3);\r\n}\r\n\r\n.temp-tooltip__list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 6px;\r\n  margin-top: 8px;\r\n}\r\n\r\n.temp-tooltip__list-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 6px 10px;\r\n  background: rgba(0, 0, 0, 0.2);\r\n  border-radius: 6px;\r\n  font-size: 11px;\r\n}\r\n\r\n.temp-tooltip__list-item--ok {\r\n  border-left: 3px solid #4ade80;\r\n}\r\n\r\n.temp-tooltip__list-item--warn {\r\n  border-left: 3px solid #fbbf24;\r\n}\r\n\r\n.temp-tooltip__list-item--unknown {\r\n  border-left: 3px solid #6b7280;\r\n  background: rgba(107, 114, 128, 0.1);\r\n}\r\n\r\n.temp-tooltip__list-icon {\r\n  font-size: 12px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.temp-tooltip__list-name {\r\n  flex: 1;\r\n  color: #e2e8f0;\r\n  font-weight: 500;\r\n}\r\n\r\n.temp-tooltip__list-value {\r\n  color: #94a3b8;\r\n  font-size: 10px;\r\n}\r\n\r\n.temp-tooltip__list-range {\r\n  color: #64748b;\r\n  font-size: 10px;\r\n}\r\n\r\n.temp-tooltip__notice {\r\n  display: flex;\r\n  align-items: flex-start;\r\n  gap: 8px;\r\n  padding: 10px 12px;\r\n  background: rgba(99, 102, 241, 0.1);\r\n  border: 1px solid rgba(99, 102, 241, 0.2);\r\n  border-radius: 8px;\r\n  margin-top: 12px;\r\n}\r\n\r\n.temp-tooltip__notice-icon {\r\n  font-size: 14px;\r\n  flex-shrink: 0;\r\n  margin-top: 1px;\r\n}\r\n\r\n.temp-tooltip__notice-text {\r\n  font-size: 11px;\r\n  color: #a5b4fc;\r\n  line-height: 1.5;\r\n}\r\n\r\n/* Scrollbar styling for tooltip content */\r\n.temp-tooltip__content::-webkit-scrollbar {\r\n  width: 6px;\r\n}\r\n\r\n.temp-tooltip__content::-webkit-scrollbar-track {\r\n  background: rgba(0, 0, 0, 0.2);\r\n  border-radius: 3px;\r\n}\r\n\r\n.temp-tooltip__content::-webkit-scrollbar-thumb {\r\n  background: rgba(249, 115, 22, 0.4);\r\n  border-radius: 3px;\r\n}\r\n\r\n.temp-tooltip__content::-webkit-scrollbar-thumb:hover {\r\n  background: rgba(249, 115, 22, 0.6);\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary */\r\n\r\n/***********************************\r\n *  MENU PREMIUM + FILTRO MODAL    *\r\n ***********************************/\r\nconst EVT_SWITCH = 'myio:switch-main-state';\r\n\r\nlet _dataRefreshCount = 0;\r\nconst MAX_DATA_REFRESHES = 1;\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\n// Use shared utilities from MAIN, with fallback to local implementation\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log(...args),\r\n  warn: (...args) => console.warn(...args),\r\n  error: (...args) => console.error(...args),\r\n};\r\n\r\n// ===== INFOTOOLTIP FROM LIBRARY (RFC-0105) =====\r\n/**\r\n * Get InfoTooltip from the library\r\n * @returns {object|null} InfoTooltip component or null if not available\r\n */\r\nfunction getInfoTooltip() {\r\n  return window.MyIOLibrary?.InfoTooltip || null;\r\n}\r\n\r\n// ===== SHOPPING FILTER STATE =====\r\nlet selectedShoppingIds = []; // Shopping ingestionIds selected in filter\r\n\r\n// ‚úÖ Check if filter was already applied before HEADER initialized\r\nif (\r\n  window.custumersSelected &&\r\n  Array.isArray(window.custumersSelected) &&\r\n  window.custumersSelected.length > 0\r\n) {\r\n  LogHelper.log('[HEADER] üîÑ Applying pre-existing filter:', window.custumersSelected.length, 'shoppings');\r\n  selectedShoppingIds = window.custumersSelected.map((s) => s.value).filter((v) => v);\r\n}\r\n\r\n// RFC: updateTotalConsumption moved to MAIN - use myio:request-total-consumption event\r\n// RFC: updateTotalWaterConsumption moved to MAIN - use myio:request-total-water-consumption event\r\n\r\nfunction publishSwitch(targetStateId) {\r\n  const detail = { targetStateId, source: 'menu_v_1_0_0', ts: Date.now() };\r\n  window.dispatchEvent(new CustomEvent(EVT_SWITCH, { detail }));\r\n  // console.log(\"[menu] switch ->\", detail);\r\n}\r\n\r\nfunction setActiveTab(btn, root) {\r\n  root.querySelectorAll('.tab.is-active').forEach((b) => b.classList.remove('is-active'));\r\n  btn.classList.add('is-active');\r\n}\r\n\r\nfunction bindTabs(root) {\r\n  if (root._tabsBound) return;\r\n\r\n  root._tabsBound = true;\r\n\r\n  root.addEventListener('click', (ev) => {\r\n    const tab = ev.target.closest?.('.tab');\r\n\r\n    if (tab && root.contains(tab)) {\r\n      const target = tab.getAttribute('data-target');\r\n\r\n      if (target) {\r\n        setActiveTab(tab, root);\r\n        publishSwitch(target);\r\n      }\r\n    }\r\n  });\r\n\r\n  const initial = root.querySelector('.tab.is-active') || root.querySelector('.tab');\r\n\r\n  if (initial) {\r\n    publishSwitch(initial.getAttribute('data-target'));\r\n  }\r\n}\r\n\r\nfunction injectModalGlobal() {\r\n  // ==== Config & helpers ====================================================\r\n  const PRESET_KEY = 'myio_dashboard_filter_presets_v1';\r\n  // Estado global (compartilhado entre aberturas)\r\n  if (!window.myioFilterSel) {\r\n    window.myioFilterSel = { malls: [], floors: [], places: [] };\r\n  }\r\n  if (!window.myioFilterQuery) {\r\n    window.myioFilterQuery = '';\r\n  }\r\n  if (!window.myioFilterPresets) {\r\n    try {\r\n      window.myioFilterPresets = JSON.parse(localStorage.getItem(PRESET_KEY) || '[]');\r\n    } catch {\r\n      window.myioFilterPresets = [];\r\n    }\r\n  }\r\n\r\n  // Fonte de dados: preferir window.mallsTree (formato do original)\r\n  // Se n√£o existir, converte um FILTER_DATA simples em uma √°rvore m√≠nima.\r\n  function getTree() {\r\n    if (Array.isArray(window.mallsTree) && window.mallsTree.length) {\r\n      return window.mallsTree;\r\n    }\r\n    // fallback a partir de FILTER_DATA = [{id,name,floors:n}]\r\n    if (Array.isArray(window.FILTER_DATA) && window.FILTER_DATA.length) {\r\n      return window.FILTER_DATA.map((m) => {\r\n        const mallId = m.id || crypto.randomUUID();\r\n        const floors = Array.from({ length: Number(m.floors || 1) }).map((_, i) => {\r\n          const floorId = `${mallId}-F${i + 1}`;\r\n          // sem places reais, colocamos 0..2 mockados\r\n          const places = Array.from({ length: 3 }).map((__, k) => ({\r\n            id: `${floorId}-P${k + 1}`,\r\n            name: `Loja ${k + 1}`,\r\n          }));\r\n          return { id: floorId, name: `Piso ${i + 1}`, children: places };\r\n        });\r\n        return { id: mallId, name: m.name || `Shopping ${mallId}`, children: floors };\r\n      });\r\n    }\r\n    // √∫ltimo fallback vazio\r\n    return [];\r\n  }\r\n\r\n  const mallsTree = getTree();\r\n\r\n  // Flatten para mapa id->nome (chips)\r\n  function flatten(tree) {\r\n    const list = [];\r\n    for (const mall of tree) {\r\n      list.push({ id: mall.id, name: mall.name });\r\n      for (const fl of mall.children || []) {\r\n        list.push({ id: fl.id, name: fl.name });\r\n        for (const pl of fl.children || []) list.push({ id: pl.id, name: pl.name });\r\n      }\r\n    }\r\n    return list;\r\n  }\r\n\r\n  function nodeMatchesQuery(nodeName, q) {\r\n    if (!q) return true;\r\n    return nodeName.toLowerCase().includes(q.toLowerCase());\r\n  }\r\n\r\n  function toggle(arr, val) {\r\n    return arr.includes(val) ? arr.filter((v) => v !== val) : [...arr, val];\r\n  }\r\n\r\n  function countSelected(sel) {\r\n    return (sel.malls?.length || 0) + (sel.floors?.length || 0) + (sel.places?.length || 0);\r\n  }\r\n\r\n  // ==== Constru√ß√£o do container (uma √∫nica vez) =============================\r\n  let container = document.getElementById('modalGlobal');\r\n  if (!container) {\r\n    container = document.createElement('div');\r\n    container.id = 'modalGlobal';\r\n    container.innerHTML = `\r\n      <style>\r\n        .myio-modal {\r\n          position: fixed; inset: 0; display: flex; justify-content: center; align-items: center;\r\n          background: rgba(0,0,0,0.5); z-index: 9999; opacity: 0; pointer-events: none; transition: opacity .2s;\r\n        }\r\n       .custumers {\r\n          display: flex;              /* horizontal: quadrado + texto */\r\n          align-items: center;\r\n          gap: 10px;                  /* espa√ßo entre quadrado e texto */\r\n          border: 1px solid #d9d9d9;\r\n          border-radius: 8px;\r\n          padding: 6px 10px;\r\n          margin-bottom: 6px;\r\n          background: transparent;\r\n          font-weight: 600;\r\n          color: #344054;\r\n          cursor: pointer;\r\n          transition: background 0.2s;\r\n        }\r\n        \r\n        .custumers:hover {\r\n          background: #f2f2f2;\r\n        }\r\n        \r\n        .custumers .checkbox {\r\n          width: 16px;\r\n          height: 16px;\r\n          border: 1px solid #344054;\r\n          border-radius: 3px;\r\n          flex-shrink: 0;\r\n          background-color: transparent;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n        }\r\n        \r\n        .custumers.selected .checkbox {\r\n          background-color: #1D4F91; /* quadrado preenchido quando selecionado */\r\n        }\r\n\r\n        .myio-modal[aria-hidden=\"false\"] { opacity: 1; pointer-events: auto; }\r\n        .myio-modal-card {\r\n          background: #fff; border-radius: 12px; max-width: 980px; width: 92%;\r\n          max-height: 86vh; display:flex; flex-direction:column; box-shadow: 0 4px 16px rgba(0,0,0,.28);\r\n        }\r\n        .myio-modal-hd, .myio-modal-ft { padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; }\r\n        .myio-modal-hd { border-bottom:1px solid #E6EEF5; }\r\n        .myio-modal-ft { border-top:1px solid #E6EEF5; gap: 8px; }\r\n        .myio-modal-body { padding: 14px 16px; display:flex; flex-direction:column; gap: 12px; overflow: hidden; }\r\n\r\n        .close-x { cursor:pointer; border:0; background:transparent; font-size:20px; line-height:1; }\r\n        .flt-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }\r\n        .flt-search{ position:relative; display:flex; align-items:center; gap:8px; flex:1; border:2px solid #BBD0E3; border-radius:12px; padding:6px 10px; }\r\n        .flt-search:focus-within{ border-color:#4F93CE; box-shadow: 0 0 0 3px rgba(79,147,206,.15); }\r\n        .flt-search input{ width:100%; border:0; outline:0; font-size:15px; padding-left:20px; }\r\n        .flt-search .search-ico{ position:absolute; left:10px; }\r\n\r\n        .link-btn{ border:0; background:transparent; font-weight:600; cursor:pointer; color:#344054; }\r\n        .save-btn{ border:0; background:#B7D14B; color:#1C2743; font-weight:700; padding:8px 12px; border-radius:10px; cursor:pointer; }\r\n        .apply-btn{ border:0; background:#1D4F91; color:#fff; font-weight:700; padding:10px 16px; border-radius:10px; cursor:pointer; }\r\n\r\n        .chips { display:flex; flex-wrap:wrap; gap:8px; }\r\n        .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #CFDCE8; border-radius:999px; padding:4px 10px; font-size:12px; }\r\n        .chip .rm { cursor:pointer; border:0; background:transparent; opacity:.7; }\r\n\r\n        .flt-content { display:flex; gap:12px; overflow:hidden; }\r\n        .flt-tree { flex: 1 1 auto; overflow:auto; max-height: 46vh; padding-right:4px; display:flex; flex-direction:column; gap:12px; }\r\n        .mall-card { border:1px solid #CFDCE8; border-radius:12px; padding:12px; }\r\n        .mall-head { display:flex; align-items:center; gap:8px; }\r\n        .sub { margin-top:10px; padding-left:22px; display:flex; flex-direction:column; gap:10px; }\r\n        .floor-card{ border:1px solid #E6EEF5; border-radius:10px; padding:10px; }\r\n        .floor-head{ display:flex; align-items:center; gap:8px; }\r\n        .places { margin-top:8px; padding-left:20px; display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:8px; }\r\n        .place-item{ display:flex; align-items:center; gap:8px; border:1px solid #E6EEF5; border-radius:8px; padding:6px 8px; font-size:13px; }\r\n\r\n        .presets { flex: 0 0 auto; width: 260px; border-left:1px dashed #E6EEF5; padding-left:12px; }\r\n        .preset-title{ font-size:12px; color:#6b7280; display:flex; align-items:center; gap:6px; margin-bottom:6px; }\r\n        .preset-list{ display:flex; flex-direction:column; gap:6px; }\r\n        .preset-item{ display:flex; align-items:center; justify-content:space-between; border:1px solid #E6EEF5; border-radius:8px; padding:6px 8px; }\r\n        .preset-item button{ border:0; background:transparent; cursor:pointer; }\r\n\r\n        .kbd { background:#f5f7fa; border:1px solid #e6eef5; padding:2px 6px; border-radius:6px; font-size:11px; color:#475467; }\r\n        .badge { border:1px solid #CFDCE8; border-radius:999px; padding:2px 8px; font-size:11px; color:#334155; }\r\n      </style>\r\n\r\n      <div class=\"myio-modal\" id=\"filterModal\" role=\"dialog\" aria-modal=\"true\" aria-hidden=\"true\" aria-labelledby=\"fltTitle\">\r\n        <div class=\"myio-modal-backdrop\" data-close=\"true\"></div>\r\n        <div class=\"myio-modal-card\">\r\n          <header class=\"myio-modal-hd\">\r\n            <h3 id=\"fltTitle\">Filtro avan√ßado</h3>\r\n            <button class=\"close-x\" data-close=\"true\" aria-label=\"Fechar\">√ó</button>\r\n          </header>\r\n\r\n          <div class=\"myio-modal-body\">\r\n            <!-- Barra de busca e a√ß√µes -->\r\n            <div class=\"flt-row\">\r\n              <div class=\"flt-search\">\r\n                <span class=\"search-ico\">üîé</span>\r\n                <input id=\"fltSearch\" type=\"text\" placeholder=\"Buscar shopping, piso, loja/ambiente‚Ä¶\" autocomplete=\"off\">\r\n              </div>\r\n              <button class=\"link-btn\" id=\"fltClear\">üßπ Limpar</button>\r\n              <button class=\"save-btn\" id=\"fltSave\">üíæ Salvar preset</button>\r\n              <span id=\"fltCount\" class=\"badge\" title=\"Total de sele√ß√µes\">0 selecionados</span>\r\n            </div>\r\n\r\n            <!-- Chips -->\r\n            <div id=\"fltChips\" class=\"chips\"></div>\r\n\r\n            <div class=\"flt-content\">\r\n              <!-- √Årvore -->\r\n              <div class=\"flt-tree\" id=\"fltList\" role=\"listbox\" aria-label=\"√Årvore de sele√ß√£o\"></div>\r\n\r\n              <!-- Presets -->\r\n              <aside class=\"presets\">\r\n                <div class=\"preset-title\">‚òÖ Presets salvos</div>\r\n                <div id=\"fltPresets\" class=\"preset-list\"></div>\r\n                <div style=\"margin-top:8px; font-size:12px; color:#6b7280;\">\r\n                  Dica: salve at√© <span class=\"kbd\">12</span> presets.\r\n                </div>\r\n              </aside>\r\n            </div>\r\n          </div>\r\n\r\n          <footer class=\"myio-modal-ft\">\r\n            <div style=\"flex:1; color:#6b7280; font-size:12px;\">\r\n              Use <span class=\"kbd\">Buscar</span> para filtrar n√≥s rapidamente.\r\n            </div>\r\n            <button class=\"link-btn\" data-close=\"true\">Cancelar</button>\r\n            <button class=\"apply-btn\" id=\"fltApply\">Aplicar filtro</button>\r\n          </footer>\r\n        </div>\r\n      </div>\r\n    `;\r\n    document.body.appendChild(container);\r\n\r\n    // listeners globais de fechar\r\n    container.querySelectorAll('[data-close]').forEach((btn) => {\r\n      btn.addEventListener('click', () => {\r\n        container.querySelector('.myio-modal').setAttribute('aria-hidden', 'true');\r\n      });\r\n    });\r\n  }\r\n\r\n  // ==== Refer√™ncias do DOM ==================================================\r\n  const modal = container.querySelector('.myio-modal');\r\n  const elSearch = container.querySelector('#fltSearch');\r\n  const elList = container.querySelector('#fltList');\r\n  const elClear = container.querySelector('#fltClear');\r\n  const elSave = container.querySelector('#fltSave');\r\n  const elApply = container.querySelector('#fltApply');\r\n  const elChips = container.querySelector('#fltChips');\r\n  const elPresets = container.querySelector('#fltPresets');\r\n  const elCount = container.querySelector('#fltCount');\r\n\r\n  // ==== Render helpers ======================================================\r\n  const flatMap = new Map(flatten(mallsTree).map((n) => [n.id, n.name]));\r\n\r\n  function isMallChecked(sel, mallId) {\r\n    return sel.malls.includes(mallId);\r\n  }\r\n  function isFloorChecked(sel, floorId) {\r\n    return sel.floors.includes(floorId);\r\n  }\r\n  function isPlaceChecked(sel, placeId) {\r\n    return sel.places.includes(placeId);\r\n  }\r\n\r\n  function renderCount() {\r\n    const c = countSelected(window.myioFilterSel);\r\n    elCount.textContent = `${c} selecionado${c === 1 ? '' : 's'}`;\r\n  }\r\n\r\n  function renderChips() {\r\n    elChips.innerHTML = '';\r\n    const chips = [\r\n      ...window.myioFilterSel.malls.map((id) => ({ id, label: flatMap.get(id) })),\r\n      ...window.myioFilterSel.floors.map((id) => ({ id, label: flatMap.get(id) })),\r\n      ...window.myioFilterSel.places.map((id) => ({ id, label: flatMap.get(id) })),\r\n    ].filter((c) => !!c.label);\r\n\r\n    for (const c of chips) {\r\n      const chip = document.createElement('span');\r\n      chip.className = 'chip';\r\n      chip.innerHTML = `\r\n        <span>${c.label}</span>\r\n        <button class=\"rm\" title=\"Remover\" aria-label=\"Remover sele√ß√£o\">√ó</button>\r\n      `;\r\n      chip.querySelector('.rm').addEventListener('click', () => {\r\n        window.myioFilterSel = {\r\n          malls: window.myioFilterSel.malls.filter((x) => x !== c.id),\r\n          floors: window.myioFilterSel.floors.filter((x) => x !== c.id),\r\n          places: window.myioFilterSel.places.filter((x) => x !== c.id),\r\n        };\r\n        renderAll();\r\n      });\r\n      elChips.appendChild(chip);\r\n    }\r\n  }\r\n\r\n  function renderTree() {\r\n    const q = window.myioFilterQuery || '';\r\n    elList.innerHTML = '';\r\n\r\n    mallsTree.forEach((mall) => {\r\n      // floor & place ids\r\n      const floorIds = (mall.children || []).map((f) => f.id);\r\n      const placeIds = (mall.children || []).flatMap((f) => (f.children || []).map((p) => p.id));\r\n\r\n      // decide se mall aparece pelos filtros\r\n      const mallMatch = nodeMatchesQuery(mall.name, q);\r\n      // container do mall\r\n      const mallCard = document.createElement('div');\r\n      mallCard.className = 'mall-card';\r\n      mallCard.innerHTML = `\r\n        <label class=\"mall-head\">\r\n          <input type=\"checkbox\" ${isMallChecked(window.myioFilterSel, mall.id) ? 'checked' : ''} />\r\n          <span class=\"font-medium\">${mall.name}</span>\r\n          <span class=\"badge\" style=\"margin-left:6px\">${(mall.children || []).length} pisos</span>\r\n        </label>\r\n        <div class=\"sub\"></div>\r\n      `;\r\n      const mallCheck = mallCard.querySelector('input');\r\n      const mallSub = mallCard.querySelector('.sub');\r\n\r\n      // click no mall: seleciona/deseleciona mall + floors + places\r\n      mallCheck.addEventListener('change', () => {\r\n        const checked = mallCheck.checked;\r\n        window.myioFilterSel = {\r\n          malls: checked\r\n            ? [...new Set([...window.myioFilterSel.malls, mall.id])]\r\n            : window.myioFilterSel.malls.filter((id) => id !== mall.id),\r\n          floors: checked\r\n            ? [...new Set([...window.myioFilterSel.floors, ...floorIds])]\r\n            : window.myioFilterSel.floors.filter((id) => !floorIds.includes(id)),\r\n          places: checked\r\n            ? [...new Set([...window.myioFilterSel.places, ...placeIds])]\r\n            : window.myioFilterSel.places.filter((id) => !placeIds.includes(id)),\r\n        };\r\n        renderAll();\r\n      });\r\n\r\n      // floors\r\n      (mall.children || [])\r\n        .filter((fl) => {\r\n          const floorMatch = nodeMatchesQuery(fl.name, q);\r\n          const hasPlaceMatch = (fl.children || []).some((p) => nodeMatchesQuery(p.name, q));\r\n          // Exibe o floor se: mall j√° bateu OU floor bate OR alguma loja bate\r\n          return mallMatch || floorMatch || hasPlaceMatch;\r\n        })\r\n        .forEach((fl) => {\r\n          const floorCard = document.createElement('div');\r\n          floorCard.className = 'floor-card';\r\n          floorCard.innerHTML = `\r\n            <label class=\"floor-head\">\r\n              <input type=\"checkbox\" ${isFloorChecked(window.myioFilterSel, fl.id) ? 'checked' : ''} />\r\n              <span>${fl.name}</span>\r\n              <span class=\"badge\" style=\"margin-left:6px\">${(fl.children || []).length} ambientes</span>\r\n            </label>\r\n            <div class=\"places\"></div>\r\n          `;\r\n          const floorCheck = floorCard.querySelector('input');\r\n          const placesBox = floorCard.querySelector('.places');\r\n\r\n          floorCheck.addEventListener('change', () => {\r\n            const checked = floorCheck.checked;\r\n            const thisPlaceIds = (fl.children || []).map((p) => p.id);\r\n            window.myioFilterSel = {\r\n              malls: checked\r\n                ? [...new Set([...window.myioFilterSel.malls, mall.id])]\r\n                : window.myioFilterSel.malls, // n√£o removemos o mall automaticamente (outros floors podem continuar)\r\n              floors: toggle(window.myioFilterSel.floors, fl.id),\r\n              places: checked\r\n                ? [...new Set([...window.myioFilterSel.places, ...thisPlaceIds])]\r\n                : window.myioFilterSel.places.filter((id) => !thisPlaceIds.includes(id)),\r\n            };\r\n            renderAll();\r\n          });\r\n\r\n          (fl.children || [])\r\n            .filter((p) => {\r\n              const pmatch = nodeMatchesQuery(p.name, q);\r\n              // Exibe place se qualquer n√≥ ancestral/ele mesmo bate\r\n              return mallMatch || nodeMatchesQuery(fl.name, q) || pmatch;\r\n            })\r\n            .forEach((p) => {\r\n              const li = document.createElement('label');\r\n              li.className = 'place-item';\r\n              li.innerHTML = `\r\n                <input type=\"checkbox\" ${isPlaceChecked(window.myioFilterSel, p.id) ? 'checked' : ''} />\r\n                <span class=\"text-sm\">${p.name}</span>\r\n              `;\r\n              const chk = li.querySelector('input');\r\n              chk.addEventListener('change', () => {\r\n                const checked = chk.checked;\r\n                window.myioFilterSel = {\r\n                  malls: checked\r\n                    ? [...new Set([...window.myioFilterSel.malls, mall.id])]\r\n                    : window.myioFilterSel.malls,\r\n                  floors: checked\r\n                    ? [...new Set([...window.myioFilterSel.floors, fl.id])]\r\n                    : window.myioFilterSel.floors,\r\n                  places: toggle(window.myioFilterSel.places, p.id),\r\n                };\r\n                renderAll();\r\n              });\r\n              placesBox.appendChild(li);\r\n            });\r\n\r\n          mallSub.appendChild(floorCard);\r\n        });\r\n\r\n      // S√≥ adiciona o mallCard se ele pr√≥prio ou seus filhos batem a busca\r\n      if (mallMatch || mallSub.children.length > 0) {\r\n        elList.appendChild(mallCard);\r\n      }\r\n    });\r\n    if (!window.custumersSelected) window.custumersSelected = [];\r\n\r\n    if (!elList.children.length) {\r\n      if (Array.isArray(self.ctx.$scope.custumer) && self.ctx.$scope.custumer.length) {\r\n        elList.style.textAlign = 'left';\r\n\r\n        self.ctx.$scope.custumer.forEach((c) => {\r\n          const item = document.createElement('button');\r\n          item.className = 'custumers';\r\n\r\n          // armazenar o dado no pr√≥prio bot√£o\r\n          item.custumerData = c;\r\n\r\n          // quadrado √† esquerda\r\n          const box = document.createElement('div');\r\n          box.className = 'checkbox';\r\n          item.appendChild(box);\r\n\r\n          // texto do cliente\r\n          const text = document.createElement('span');\r\n          text.textContent = c.name;\r\n          item.appendChild(text);\r\n          window.custumersSelected = [];\r\n          // clique para selecionar/deselecionar\r\n          item.addEventListener('click', () => {\r\n            const isSelected = item.classList.toggle('selected');\r\n            if (isSelected) {\r\n              window.custumersSelected.push(c); // adiciona ao array\r\n            } else {\r\n              window.custumersSelected = window.custumersSelected.filter((x) => x !== c);\r\n            }\r\n            // console.log(\"Selecionados:\", window.custumersSelected);\r\n          });\r\n          self.ctx.filterCustom = window.custumersSelected;\r\n\r\n          elList.appendChild(item);\r\n        });\r\n      } else {\r\n        const empty = document.createElement('div');\r\n        empty.style.color = '#6b7280';\r\n        empty.style.fontSize = '14px';\r\n        empty.style.textAlign = 'left';\r\n        empty.textContent = 'Nenhum resultado encontrado para o filtro atual.';\r\n        elList.appendChild(empty);\r\n      }\r\n    }\r\n  }\r\n\r\n  function renderPresets() {\r\n    elPresets.innerHTML = '';\r\n    const presets = window.myioFilterPresets || [];\r\n    if (!presets.length) {\r\n      const empty = document.createElement('div');\r\n      empty.style.color = '#6b7280';\r\n      empty.style.fontSize = '12px';\r\n      empty.textContent = 'Nenhum preset salvo ainda.';\r\n      elPresets.appendChild(empty);\r\n      return;\r\n    }\r\n    presets.slice(0, 12).forEach((p) => {\r\n      const row = document.createElement('div');\r\n      row.className = 'preset-item';\r\n      const btnApply = document.createElement('button');\r\n      btnApply.textContent = p.name;\r\n      btnApply.title = 'Aplicar preset';\r\n      btnApply.style.textDecoration = 'underline';\r\n\r\n      const btnDel = document.createElement('button');\r\n      btnDel.innerHTML = 'üóëÔ∏è';\r\n      btnDel.title = 'Excluir preset';\r\n\r\n      btnApply.addEventListener('click', () => {\r\n        // aplica sele√ß√£o do preset\r\n        window.myioFilterSel = {\r\n          malls: [...(p.selection?.malls || [])],\r\n          floors: [...(p.selection?.floors || [])],\r\n          places: [...(p.selection?.places || [])],\r\n        };\r\n        renderAll();\r\n      });\r\n\r\n      btnDel.addEventListener('click', () => {\r\n        window.myioFilterPresets = (window.myioFilterPresets || []).filter((x) => x.id !== p.id);\r\n        try {\r\n          localStorage.setItem(PRESET_KEY, JSON.stringify(window.myioFilterPresets));\r\n        } catch {\r\n          LogHelper.warn('[HEADER] Erro ao salvar presets no localStorage');\r\n        }\r\n        renderPresets();\r\n      });\r\n\r\n      row.appendChild(btnApply);\r\n      row.appendChild(btnDel);\r\n      elPresets.appendChild(row);\r\n    });\r\n  }\r\n\r\n  function renderAll() {\r\n    renderCount();\r\n    renderChips();\r\n    renderTree();\r\n    // n√£o precisa re-render presets a cada clique, mas aqui √© seguro:\r\n    renderPresets();\r\n  }\r\n\r\n  // ==== Bind de eventos de UI ==============================================\r\n  if (!elSearch._bound) {\r\n    elSearch._bound = true;\r\n    elSearch.addEventListener('input', (e) => {\r\n      window.myioFilterQuery = e.target.value || '';\r\n      renderTree();\r\n    });\r\n  }\r\n\r\n  if (!elClear._bound) {\r\n    elClear._bound = true;\r\n    elClear.addEventListener('click', () => {\r\n      window.myioFilterSel = { malls: [], floors: [], places: [] };\r\n      window.myioFilterQuery = '';\r\n      elSearch.value = '';\r\n      renderAll();\r\n    });\r\n  }\r\n\r\n  if (!elSave._bound) {\r\n    elSave._bound = true;\r\n    elSave.addEventListener('click', () => {\r\n      const name = window.prompt('Nome do preset:');\r\n      if (!name) return;\r\n      const preset = {\r\n        id: crypto.randomUUID(),\r\n        name,\r\n        selection: {\r\n          malls: [...window.myioFilterSel.malls],\r\n          floors: [...window.myioFilterSel.floors],\r\n          places: [...window.myioFilterSel.places],\r\n        },\r\n        createdAt: Date.now(),\r\n      };\r\n      const next = [preset, ...(window.myioFilterPresets || [])].slice(0, 12);\r\n      window.myioFilterPresets = next;\r\n      try {\r\n        localStorage.setItem(PRESET_KEY, JSON.stringify(next));\r\n      } catch {\r\n        LogHelper.warn('[HEADER] Erro ao salvar presets no localStorage');\r\n      }\r\n      renderPresets();\r\n    });\r\n  }\r\n\r\n  if (!elApply._bound) {\r\n    elApply._bound = true;\r\n    elApply.addEventListener('click', async () => {\r\n      // Itens selecionados\r\n      //console.log(\"Itens selecionados:\", window.custumersSelected);\r\n\r\n      const percentDiference = document.getElementById('energy-trend');\r\n\r\n      percentDiference.innerText = '';\r\n\r\n      // Desabilita bot√£o enquanto carrega\r\n      elApply.disabled = true;\r\n\r\n      // RFC: Request MAIN to update total consumption via CustomEvent\r\n      window.dispatchEvent(\r\n        new CustomEvent('myio:request-total-consumption', {\r\n          detail: {\r\n            customersArray: window.custumersSelected,\r\n            startDateISO: self.ctx.$scope.startDateISO,\r\n            endDateISO: self.ctx.$scope.endDateISO,\r\n          },\r\n        })\r\n      );\r\n\r\n      // RFC: Request MAIN to update water consumption via CustomEvent\r\n      window.dispatchEvent(\r\n        new CustomEvent('myio:request-total-water-consumption', {\r\n          detail: {\r\n            customersArray: window.custumersSelected,\r\n            startDateISO: self.ctx.$scope.startDateISO,\r\n            endDateISO: self.ctx.$scope.endDateISO,\r\n          },\r\n        })\r\n      );\r\n\r\n      // RFC-0100: Temperature will be updated via myio:filter-applied -> MAIN orchestrator\r\n      // No need to call updateTemperatureCard() directly anymore\r\n\r\n      // Reabilita bot√£o\r\n      elApply.disabled = false;\r\n\r\n      // Dispara evento com os custumers selecionados\r\n      window.dispatchEvent(\r\n        new CustomEvent('myio:filter-applied', {\r\n          detail: {\r\n            selection: window.custumersSelected,\r\n            ts: Date.now(),\r\n          },\r\n        })\r\n      );\r\n\r\n      // Fecha modal\r\n      modal.setAttribute('aria-hidden', 'true');\r\n    });\r\n  }\r\n\r\n  // ==== Abrir modal e sincronizar estado visual ============================\r\n  modal.setAttribute('aria-hidden', 'false');\r\n  // rep√µe valor de busca persistido em mem√≥ria\r\n  if (elSearch.value !== (window.myioFilterQuery || '')) {\r\n    elSearch.value = window.myioFilterQuery || '';\r\n  }\r\n  renderAll();\r\n\r\n  // Foco no input de busca\r\n  setTimeout(() => elSearch?.focus(), 0);\r\n}\r\n\r\nfunction bindFilter(root) {\r\n  if (root._filterBound) return;\r\n  root._filterBound = true;\r\n  const modal = document.getElementById('filterModal');\r\n  if (!modal) return; // se modal n√£o existe, sai\r\n\r\n  const btnApply = modal.querySelector('#fltApply');\r\n\r\n  btnApply?.addEventListener('click', () => {\r\n    modal.setAttribute('aria-hidden', 'true');\r\n  });\r\n\r\n  modal.querySelectorAll('[data-close]').forEach((btn) => {\r\n    btn.addEventListener('click', () => modal.setAttribute('aria-hidden', 'true'));\r\n  });\r\n}\r\n\r\n/* ====== Cards summary (igual antes) ====== */\r\nfunction setBarPercent(elBarFill, pct, tail = 8) {\r\n  const track = elBarFill?.parentElement;\r\n  if (!elBarFill || !track) return;\r\n  // limita 0‚Äì100\r\n  const p = Math.max(0, Math.min(100, pct || 0));\r\n  track.style.setProperty('--pct', p);\r\n  track.style.setProperty('--tail', tail); // % do preenchido que ser√° verde\r\n  elBarFill.style.width = p + '%';\r\n}\r\n\r\nfunction setSummary(data = {}) {\r\n  // === Equipamentos ===\r\n  if (data.equip) {\r\n    const pct = Math.max(0, Math.min(100, data.equip.percent ?? 0));\r\n    document.getElementById('equip-kpi').textContent = data.equip.totalStr ?? '0/0';\r\n    document.getElementById('equip-sub').textContent = `${pct}% operational`;\r\n    setBarPercent(document.getElementById('equip-bar'), pct, 8);\r\n  }\r\n\r\n  // === Energia ===\r\n  if (data.energy) {\r\n    const trendEl = document.getElementById('energy-trend');\r\n    document.getElementById('energy-kpi').textContent = data.energy.kpi ?? '--';\r\n    // trendEl.textContent = (data.energy.trendDir === 'up' ? '‚Üë ' : '// ') + (data.energy.trendText?.replace(/[‚Üë‚Üì]\\s*/,'') || '');\r\n    trendEl.classList.toggle('down', (data.energy.trendDir || 'down') === 'down');\r\n    trendEl.classList.toggle('up', (data.energy.trendDir || 'down') === 'up');\r\n    // Removido: n√£o mostramos mais textos no rodap√© dos cards\r\n    // document.getElementById(\"energy-peak\").textContent =\r\n    //     data.energy.peakText ?? \"\";\r\n  }\r\n\r\n  // === Temperatura ===\r\n  if (data.temp) {\r\n    document.getElementById('temp-kpi').textContent = '--';\r\n    // Removido: faixa ideal agora √© mostrada apenas no tooltip\r\n    // document.getElementById(\"temp-range\").textContent =\r\n    //     data.temp.rangeText ?? \"\";\r\n  }\r\n\r\n  // === √Ågua ===\r\n  if (data.water) {\r\n    const pct = Math.max(0, Math.min(100, data.water.percent ?? 0));\r\n    document.getElementById('water-kpi').textContent = `${pct}%`;\r\n    setBarPercent(document.getElementById('water-bar'), pct, 12); // cauda um pouco maior\r\n  }\r\n}\r\n\r\nwindow.myioSetMenuSummary = setSummary;\r\n\r\n/* ====== Apply Card Custom Colors ====== */\r\nfunction applyCardColors() {\r\n  const settings = self.ctx.settings;\r\n\r\n  // Card Equipamentos\r\n  const cardEquip = document.getElementById('card-equip');\r\n  if (cardEquip) {\r\n    const bgColor = settings.cardEquipamentosBackgroundColor || '#1F3A35';\r\n    const fontColor = settings.cardEquipamentosFontColor || '#F2F2F2';\r\n    cardEquip.style.setProperty('background', bgColor, 'important');\r\n    cardEquip.style.setProperty('background-color', bgColor, 'important');\r\n    cardEquip.style.setProperty('color', fontColor, 'important');\r\n  }\r\n\r\n  // Card Energia\r\n  const cardEnergy = document.getElementById('card-energy');\r\n  if (cardEnergy) {\r\n    const bgColor = settings.cardEnergiaBackgroundColor || '#1F3A35';\r\n    const fontColor = settings.cardEnergiaFontColor || '#F2F2F2';\r\n    cardEnergy.style.setProperty('background', bgColor, 'important');\r\n    cardEnergy.style.setProperty('background-color', bgColor, 'important');\r\n    cardEnergy.style.setProperty('color', fontColor, 'important');\r\n  }\r\n\r\n  // Card Temperatura\r\n  const cardTemp = document.getElementById('card-temp');\r\n  if (cardTemp) {\r\n    const bgColor = settings.cardTemperaturaBackgroundColor || '#1F3A35';\r\n    const fontColor = settings.cardTemperaturaFontColor || '#F2F2F2';\r\n    cardTemp.style.setProperty('background', bgColor, 'important');\r\n    cardTemp.style.setProperty('background-color', bgColor, 'important');\r\n    cardTemp.style.setProperty('color', fontColor, 'important');\r\n  }\r\n\r\n  // Card √Ågua\r\n  const cardWater = document.getElementById('card-water');\r\n  if (cardWater) {\r\n    const bgColor = settings.cardAguaBackgroundColor || '#1F3A35';\r\n    const fontColor = settings.cardAguaFontColor || '#F2F2F2';\r\n    cardWater.style.setProperty('background', bgColor, 'important');\r\n    cardWater.style.setProperty('background-color', bgColor, 'important');\r\n    cardWater.style.setProperty('color', fontColor, 'important');\r\n  }\r\n\r\n  LogHelper.log('[HEADER] Card colors applied from settings');\r\n}\r\n\r\n/* ====== Lifecycle ====== */\r\nself.onInit = async function ({ strt: presetStart, end: presetEnd } = {}) {\r\n  // Define timezone e datas iniciais\r\n  const hoje = new Date();\r\n\r\n  // Define datas iniciais (in√≠cio do m√™s at√© hoje)\r\n  const startDate = presetStart\r\n    ? new Date(presetStart)\r\n    : new Date(hoje.getFullYear(), hoje.getMonth(), 1, 0, 0, 0);\r\n  const endDate = presetEnd\r\n    ? new Date(presetEnd)\r\n    : new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);\r\n\r\n  // Converte para ISO strings\r\n  let timeStart = startDate.toISOString();\r\n  let timeEnd = endDate.toISOString();\r\n\r\n  const root = (self?.ctx?.$container && self.ctx.$container[0]) || document;\r\n\r\n  LogHelper.log('[HEADER] self.ctx', self.ctx);\r\n\r\n  bindTabs(root);\r\n  bindFilter(root);\r\n\r\n  // Aplicar cores personalizadas dos cards e setup do tooltip (ap√≥s o DOM estar pronto)\r\n  setTimeout(() => {\r\n    applyCardColors();\r\n\r\n    // Setup temperature tooltip directly here\r\n    const tempTrigger = root.querySelector('#temp-info-trigger');\r\n    if (tempTrigger && !tempTrigger._tooltipBound) {\r\n      tempTrigger._tooltipBound = true;\r\n      LogHelper.log('[HEADER] Temperature tooltip trigger found in onInit');\r\n\r\n      tempTrigger.addEventListener('mouseenter', (e) => {\r\n        LogHelper.log(\r\n          '[HEADER] Tooltip mouseenter - currentTemperatureData:',\r\n          window._headerTempData ? 'available' : 'not available'\r\n        );\r\n        if (window._headerTempData) {\r\n          showTemperatureTooltip(tempTrigger, window._headerTempData);\r\n        } else {\r\n          // Show tooltip even without data\r\n          showTemperatureTooltip(tempTrigger, {\r\n            globalAvg: null,\r\n            shoppingsInRange: [],\r\n            shoppingsOutOfRange: [],\r\n            devices: [],\r\n          });\r\n        }\r\n      });\r\n\r\n      tempTrigger.addEventListener('mouseleave', () => {\r\n        hideTemperatureTooltip();\r\n      });\r\n    } else {\r\n      LogHelper.warn('[HEADER] Temperature tooltip trigger NOT found in onInit');\r\n    }\r\n\r\n    // Setup energy tooltip\r\n    const energyTrigger = root.querySelector('#energy-info-trigger');\r\n    if (energyTrigger && !energyTrigger._tooltipBound) {\r\n      energyTrigger._tooltipBound = true;\r\n      LogHelper.log('[HEADER] Energy tooltip trigger found in onInit');\r\n\r\n      energyTrigger.addEventListener('mouseenter', (e) => {\r\n        LogHelper.log(\r\n          '[HEADER] Energy tooltip mouseenter - data:',\r\n          window._headerEnergyData ? 'available' : 'not available'\r\n        );\r\n        if (window._headerEnergyData) {\r\n          showEnergyTooltip(energyTrigger, window._headerEnergyData);\r\n        } else {\r\n          showEnergyTooltip(energyTrigger, {\r\n            customerTotal: null,\r\n            unfilteredTotal: null,\r\n            equipmentsTotal: null,\r\n            lojasTotal: null,\r\n            shoppingsEnergy: [],\r\n          });\r\n        }\r\n      });\r\n\r\n      energyTrigger.addEventListener('mouseleave', () => {\r\n        hideEnergyTooltip();\r\n      });\r\n    } else {\r\n      LogHelper.warn('[HEADER] Energy tooltip trigger NOT found in onInit');\r\n    }\r\n\r\n    // Setup water tooltip\r\n    const waterTrigger = root.querySelector('#water-info-trigger');\r\n    if (waterTrigger && !waterTrigger._tooltipBound) {\r\n      waterTrigger._tooltipBound = true;\r\n      LogHelper.log('[HEADER] Water tooltip trigger found in onInit');\r\n\r\n      waterTrigger.addEventListener('mouseenter', (e) => {\r\n        LogHelper.log(\r\n          '[HEADER] Water tooltip mouseenter - data:',\r\n          window._headerWaterData ? 'available' : 'not available'\r\n        );\r\n        if (window._headerWaterData) {\r\n          showWaterTooltip(waterTrigger, window._headerWaterData);\r\n        } else {\r\n          showWaterTooltip(waterTrigger, {\r\n            filteredTotal: null,\r\n            unfilteredTotal: null,\r\n            commonArea: null,\r\n            stores: null,\r\n            shoppingsWater: [],\r\n          });\r\n        }\r\n      });\r\n\r\n      waterTrigger.addEventListener('mouseleave', () => {\r\n        hideWaterTooltip();\r\n      });\r\n    } else {\r\n      LogHelper.warn('[HEADER] Water tooltip trigger NOT found in onInit');\r\n    }\r\n\r\n    // Setup equipment tooltip\r\n    const equipTrigger = root.querySelector('#equip-info-trigger');\r\n    if (equipTrigger && !equipTrigger._tooltipBound) {\r\n      equipTrigger._tooltipBound = true;\r\n      LogHelper.log('[HEADER] Equipment tooltip trigger found in onInit');\r\n\r\n      equipTrigger.addEventListener('mouseenter', (e) => {\r\n        LogHelper.log(\r\n          '[HEADER] Equipment tooltip mouseenter - data:',\r\n          window._headerEquipData ? 'available' : 'not available'\r\n        );\r\n        if (window._headerEquipData) {\r\n          showEquipmentTooltip(equipTrigger, window._headerEquipData);\r\n        } else {\r\n          showEquipmentTooltip(equipTrigger, {\r\n            totalEquipments: 0,\r\n            filteredEquipments: 0,\r\n            allShoppingsSelected: true,\r\n            categories: null,\r\n          });\r\n        }\r\n      });\r\n\r\n      equipTrigger.addEventListener('mouseleave', () => {\r\n        hideEquipmentTooltip();\r\n      });\r\n    } else {\r\n      LogHelper.warn('[HEADER] Equipment tooltip trigger NOT found in onInit');\r\n    }\r\n  }, 200);\r\n\r\n  // mocks (remova se alimentar via API/telemetria)\r\n  setSummary({\r\n    equip: { totalStr: '24/26', percent: 92 },\r\n    energy: {}, // Removido peakText - n√£o mostramos mais no rodap√©\r\n    temp: { kpi: '22.5¬∞C' }, // Removido rangeText - agora est√° apenas no tooltip\r\n    water: { percent: 87 }, // Removido alertText - n√£o mostramos mais no rodap√©\r\n  });\r\n\r\n  const filterBtn = document.getElementById('filterBtn');\r\n\r\n  if (filterBtn) {\r\n    filterBtn.addEventListener('click', () => {\r\n      injectModalGlobal(); // cria o modal se ainda n√£o existe\r\n      bindFilter(document.body); // agora os elementos existem\r\n    });\r\n  }\r\n\r\n  // Atualiza escopo com datas iniciais\r\n  self.ctx.$scope.startDateISO = timeStart;\r\n  self.ctx.$scope.endDateISO = timeEnd;\r\n\r\n  // RFC-0093: Removed myio:update-date dispatch - MENU is the single source of truth for dates\r\n  // The HEADER should NOT dispatch date events, only MENU controls the date range\r\n\r\n  // RFC-0100: Request shoppings data from MAIN orchestrator\r\n  // HEADER no longer extracts from ctx.data directly - MAIN is the source of truth\r\n  window.dispatchEvent(new CustomEvent('myio:request-shoppings-data'));\r\n};\r\n\r\n// ===== RFC-0100: HEADER receives shoppings data from MAIN =====\r\nwindow.addEventListener('myio:shoppings-data-ready', (ev) => {\r\n  LogHelper.log('[HEADER] RFC-0100: Received shoppings data from MAIN:', ev.detail);\r\n\r\n  const { shoppings = [] } = ev.detail || {};\r\n\r\n  // Store in scope for other functions\r\n  self.ctx.$scope.custumer = shoppings;\r\n\r\n  // RFC: Request MAIN to update total consumption via CustomEvent\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:request-total-consumption', {\r\n      detail: {\r\n        customersArray: shoppings,\r\n        startDateISO: self.ctx.$scope.startDateISO,\r\n        endDateISO: self.ctx.$scope.endDateISO,\r\n      },\r\n    })\r\n  );\r\n\r\n  // RFC: Request MAIN to update water consumption via CustomEvent\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:request-total-water-consumption', {\r\n      detail: {\r\n        customersArray: shoppings,\r\n        startDateISO: self.ctx.$scope.startDateISO,\r\n        endDateISO: self.ctx.$scope.endDateISO,\r\n      },\r\n    })\r\n  );\r\n\r\n  LogHelper.log(`[HEADER] RFC-0100: Stored ${shoppings.length} shoppings and requested consumption data`);\r\n});\r\n\r\n// ===== HEADER: Equipment Card Handler =====\r\n/**\r\n * RFC: Update equipment card - now receives data from EQUIPMENTS widget via event\r\n * Shows total equipment count (MOTOR, ELEVADOR, ESCADA_ROLANTE, etc)\r\n * Format: \"X / Total\" when filtered, or just \"Total\" when all shoppings selected\r\n */\r\nfunction updateEquipmentCard(eventData = null) {\r\n  const statusDevice = document.getElementById('equip-kpi');\r\n  const subtitleDevice = document.getElementById('equip-sub');\r\n\r\n  if (!eventData) {\r\n    // Show loading state\r\n    if (statusDevice) statusDevice.innerText = '-';\r\n    if (subtitleDevice) subtitleDevice.innerText = 'Aguardando dados...';\r\n    return;\r\n  }\r\n\r\n  const { totalEquipments, filteredEquipments, allShoppingsSelected } = eventData;\r\n\r\n  // RFC: Show \"Total\" when all selected, or \"Filtered / Total\" with percentage when filtered\r\n  if (allShoppingsSelected) {\r\n    if (statusDevice) statusDevice.innerText = `${totalEquipments}`;\r\n    if (subtitleDevice) subtitleDevice.innerText = 'Total de equipamentos';\r\n  } else {\r\n    // Calculate percentage\r\n    const percentage = totalEquipments > 0 ? Math.round((filteredEquipments / totalEquipments) * 100) : 0;\r\n\r\n    if (statusDevice) statusDevice.innerText = `${filteredEquipments} / ${totalEquipments}`;\r\n    if (subtitleDevice) subtitleDevice.innerText = `${percentage}%`;\r\n  }\r\n\r\n  LogHelper.log('[HEADER] Equipment card updated:', {\r\n    total: totalEquipments,\r\n    filtered: filteredEquipments,\r\n    allSelected: allShoppingsSelected,\r\n  });\r\n}\r\n\r\n// ============================================\r\n// RFC-0100: Temperature data fetching functions REMOVED\r\n// All temperature API calls are now handled by MAIN orchestrator\r\n// HEADER only receives data via myio:temperature-data-ready event\r\n// See: updateTemperatureCardFromOrchestrator() for display logic\r\n// ============================================\r\n\r\n// RFC-0093: Update energy card with total from energy-summary-ready event\r\n// Now accepts full summary object with customerTotal, unfilteredTotal, isFiltered\r\nfunction updateEnergyCardWithTotal(summary) {\r\n  const energyKpi = document.getElementById('energy-kpi');\r\n  const energyTrend = document.getElementById('energy-trend');\r\n\r\n  if (!energyKpi) return;\r\n\r\n  // Handle both old format (just number) and new format (object)\r\n  const customerTotal = typeof summary === 'object' ? summary.customerTotal : summary;\r\n  const unfilteredTotal = typeof summary === 'object' ? summary.unfilteredTotal : customerTotal;\r\n  const isFiltered = typeof summary === 'object' ? summary.isFiltered : false;\r\n\r\n  const formatEnergy = (val) =>\r\n    typeof MyIOLibrary?.formatEnergy === 'function' ? MyIOLibrary.formatEnergy(val) : `${val.toFixed(2)} kWh`;\r\n\r\n  // RFC-0093: Use same pattern as Equipment card - show \"filtered / total\" with percentage\r\n  const showComparative =\r\n    isFiltered && unfilteredTotal > 0 && Math.abs(customerTotal - unfilteredTotal) > 0.01;\r\n\r\n  if (showComparative) {\r\n    const formattedFiltered = formatEnergy(customerTotal);\r\n    const formattedTotal = formatEnergy(unfilteredTotal);\r\n    const percentage = Math.round((customerTotal / unfilteredTotal) * 100);\r\n\r\n    // RFC-0093: Reduced font size and show filtered/total format\r\n    energyKpi.innerHTML = `${formattedFiltered} <span style=\"font-size: 0.65em; color: #666;\">/ ${formattedTotal}</span>`;\r\n    energyKpi.style.fontSize = '0.85em';\r\n\r\n    // Show percentage in subrow (same style as Equipment card)\r\n    if (energyTrend) {\r\n      energyTrend.innerText = `${percentage}%`;\r\n    }\r\n\r\n    LogHelper.log(\r\n      `[HEADER] Energy card updated (filtered): ${formattedFiltered} / ${formattedTotal} (${percentage}%)`\r\n    );\r\n  } else {\r\n    // Show only total when no filter or values are the same\r\n    const formatted = formatEnergy(customerTotal);\r\n    energyKpi.innerText = formatted;\r\n    energyKpi.style.fontSize = '0.85em';\r\n\r\n    // Clear subrow when not filtered\r\n    if (energyTrend) {\r\n      energyTrend.innerText = '';\r\n    }\r\n\r\n    LogHelper.log(`[HEADER] Energy card updated from summary: ${formatted}`);\r\n  }\r\n  // RFC-0093: Removed dispatch of myio:customer-total-consumption to prevent infinite loop\r\n}\r\n\r\nfunction updateEnergyCard(energyCache) {\r\n  const energyKpi = document.getElementById('energy-kpi');\r\n  const energyTrend = document.getElementById('energy-trend');\r\n\r\n  LogHelper.log('[HEADER] Updating energy card | cache devices:', energyCache?.size || 0);\r\n\r\n  // ‚úÖ Get filtered and unfiltered consumption from orchestrator\r\n  let filteredConsumption = 0;\r\n  let unfilteredConsumption = 0;\r\n  let isFiltered = false;\r\n  let deviceCount = 0;\r\n\r\n  if (typeof window.MyIOOrchestrator?.getTotalConsumption === 'function') {\r\n    filteredConsumption = window.MyIOOrchestrator.getTotalConsumption();\r\n    unfilteredConsumption = window.MyIOOrchestrator.getUnfilteredTotalConsumption?.() || filteredConsumption;\r\n    isFiltered = window.MyIOOrchestrator.isFilterActive?.() || false;\r\n    LogHelper.log('[HEADER] Energy consumption:', { filteredConsumption, unfilteredConsumption, isFiltered });\r\n  } else {\r\n    LogHelper.warn('[HEADER] MyIOOrchestrator.getTotalConsumption not available');\r\n    // Fallback: sum all from cache (old behavior)\r\n    if (energyCache) {\r\n      energyCache.forEach((cached) => {\r\n        if (cached && cached.total_value) {\r\n          filteredConsumption += cached.total_value || 0;\r\n          deviceCount++;\r\n        }\r\n      });\r\n      unfilteredConsumption = filteredConsumption;\r\n    }\r\n  }\r\n\r\n  // ‚úÖ Format and display\r\n  if (energyKpi) {\r\n    const formatEnergy = (val) =>\r\n      typeof MyIOLibrary?.formatEnergy === 'function'\r\n        ? MyIOLibrary.formatEnergy(val)\r\n        : `${val.toFixed(2)} kWh`;\r\n\r\n    // RFC-0093: Reduced font size for the KPI\r\n    energyKpi.style.fontSize = '0.85em';\r\n\r\n    // Show \"filtered / total\" only when filter is active AND values are different\r\n    const showComparative =\r\n      isFiltered && unfilteredConsumption > 0 && Math.abs(filteredConsumption - unfilteredConsumption) > 0.01;\r\n\r\n    if (showComparative) {\r\n      const formattedFiltered = formatEnergy(filteredConsumption);\r\n      const formattedTotal = formatEnergy(unfilteredConsumption);\r\n      const percentage = Math.round((filteredConsumption / unfilteredConsumption) * 100);\r\n\r\n      energyKpi.innerHTML = `${formattedFiltered} <span style=\"font-size: 0.65em; color: #666;\">/ ${formattedTotal}</span>`;\r\n\r\n      // Show percentage in subrow (same style as Equipment card)\r\n      if (energyTrend) {\r\n        energyTrend.innerText = `${percentage}%`;\r\n      }\r\n      LogHelper.log(\r\n        `[HEADER] Energy card updated (filtered): ${formattedFiltered} / ${formattedTotal} (${percentage}%)`\r\n      );\r\n    } else {\r\n      // Show only total when no filter or values are the same\r\n      const formatted = formatEnergy(filteredConsumption);\r\n      energyKpi.innerText = formatted;\r\n\r\n      // Clear subrow when not filtered\r\n      if (energyTrend) {\r\n        energyTrend.innerText = '';\r\n      }\r\n      LogHelper.log(`[HEADER] Energy card updated: ${formatted}`);\r\n    }\r\n  } else {\r\n    LogHelper.error('[HEADER] energyKpi element not found!');\r\n  }\r\n\r\n  // ‚úÖ EMIT EVENT: Notify ENERGY widget of customer total consumption\r\n  const customerTotalEvent = {\r\n    customerTotal: filteredConsumption,\r\n    unfilteredTotal: unfilteredConsumption,\r\n    isFiltered,\r\n    deviceCount,\r\n    timestamp: Date.now(),\r\n  };\r\n\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:customer-total-consumption', {\r\n      detail: customerTotalEvent,\r\n    })\r\n  );\r\n\r\n  LogHelper.log(`[HEADER] ‚úÖ Emitted myio:customer-total-consumption:`, customerTotalEvent);\r\n}\r\n\r\nfunction updateWaterCard(waterCache) {\r\n  const waterKpi = document.getElementById('water-kpi');\r\n  const waterTrend = document.getElementById('water-trend');\r\n\r\n  LogHelper.log('[HEADER] Updating water card | cache devices:', waterCache?.size || 0);\r\n\r\n  // ‚úÖ Get water consumption from Orchestrator waterTotals (only valid TB aliases)\r\n  // RFC-0097: The API may return devices not configured in any TB alias\r\n  // We should show only the sum of devices from HidrometrosAreaComum + Todos Hidrometros Lojas\r\n  let filteredConsumption = 0;\r\n  let unfilteredConsumption = 0;\r\n  let isFiltered = false;\r\n\r\n  // PRIORIDADE 1: Usar getWaterTotals() que calcula apenas IDs v√°lidos dos Aliases TB\r\n  const waterTotals = window.MyIOOrchestrator?.getWaterTotals?.();\r\n  if (waterTotals && waterTotals.total > 0) {\r\n    filteredConsumption = waterTotals.total;\r\n    unfilteredConsumption = waterTotals.total; // Totais v√°lidos s√£o o unfiltrado tamb√©m\r\n    isFiltered = window.MyIOOrchestrator?.isFilterActive?.() || false;\r\n    LogHelper.log('[HEADER] Water consumption (from valid TB aliases):', {\r\n      filteredConsumption,\r\n      commonArea: waterTotals.commonArea,\r\n      stores: waterTotals.stores,\r\n    });\r\n  } else {\r\n    // FALLBACK: Se ainda n√£o tiver totais calculados, n√£o mostrar nada\r\n    LogHelper.warn('[HEADER] No valid water totals available yet');\r\n    filteredConsumption = 0;\r\n    unfilteredConsumption = 0;\r\n  }\r\n\r\n  // ‚úÖ Format and display - RFC-0093: Use same pattern as Equipment card\r\n  if (waterKpi) {\r\n    const formatWater = (val) =>\r\n      typeof MyIOLibrary?.formatWaterVolumeM3 === 'function'\r\n        ? MyIOLibrary.formatWaterVolumeM3(val)\r\n        : `${val.toFixed(2)} m¬≥`;\r\n\r\n    // RFC-0093: Reduced font size for the KPI (matching energy card)\r\n    waterKpi.style.fontSize = '0.85em';\r\n\r\n    // RFC-0093: Show \"filtered / total\" only when filter is active AND values are different\r\n    const showComparative =\r\n      isFiltered && unfilteredConsumption > 0 && Math.abs(filteredConsumption - unfilteredConsumption) > 0.01;\r\n\r\n    if (showComparative) {\r\n      const formattedFiltered = formatWater(filteredConsumption);\r\n      const formattedTotal = formatWater(unfilteredConsumption);\r\n      const percentage = Math.round((filteredConsumption / unfilteredConsumption) * 100);\r\n\r\n      // RFC-0093: Use same font sizes as energy card (0.65em for comparison)\r\n      waterKpi.innerHTML = `${formattedFiltered} <span style=\"font-size: 0.65em; color: #666;\">/ ${formattedTotal}</span>`;\r\n\r\n      // Show percentage in subrow (same style as Equipment card)\r\n      if (waterTrend) {\r\n        waterTrend.innerText = `${percentage}%`;\r\n      }\r\n      LogHelper.log(\r\n        `[HEADER] Water card updated (filtered): ${formattedFiltered} / ${formattedTotal} (${percentage}%)`\r\n      );\r\n    } else {\r\n      // Show only total when no filter or values are the same\r\n      const formatted = formatWater(filteredConsumption);\r\n      waterKpi.innerText = formatted;\r\n\r\n      // Clear subrow when not filtered\r\n      if (waterTrend) {\r\n        waterTrend.innerText = '';\r\n      }\r\n      LogHelper.log(`[HEADER] Water card updated: ${formatted}`);\r\n    }\r\n  } else {\r\n    LogHelper.error('[HEADER] waterKpi element not found!');\r\n  }\r\n}\r\n\r\n// ===== HEADER: Listen for energy data from MAIN orchestrator =====\r\n// RFC-0093: Listen for energy-summary-ready for the correct total (equipments + lojas)\r\nwindow._headerEnergyData = null; // Global for tooltip access\r\n\r\nwindow.addEventListener('myio:energy-summary-ready', (ev) => {\r\n  LogHelper.log('[HEADER] üìä heard myio:energy-summary-ready:', ev.detail);\r\n  const summary = ev.detail || {};\r\n\r\n  // Store for tooltip\r\n  window._headerEnergyData = summary;\r\n\r\n  if (typeof summary.customerTotal === 'number') {\r\n    // RFC-0093: Pass full summary object to show comparative (filtered/total) like Equipment card\r\n    updateEnergyCardWithTotal(summary);\r\n  }\r\n});\r\n\r\n// RFC-0093: Also listen for energy-data-ready as initial fallback (shows loading/partial data)\r\nwindow.addEventListener('myio:energy-data-ready', (ev) => {\r\n  // Only use this if we haven't received a summary yet\r\n  // The summary will have the correct total after EQUIPMENTS identifies devices\r\n  if (ev.detail && ev.detail.cache) {\r\n    // Show a loading indicator or partial data\r\n    const energyKpi = document.getElementById('energy-kpi');\r\n    if (energyKpi && energyKpi.innerText === '0,00 kWh') {\r\n      // Only update if still showing zero (summary not received yet)\r\n      updateEnergyCard(ev.detail.cache);\r\n    }\r\n  }\r\n});\r\n\r\nwindow.addEventListener('myio:water-data-ready', (ev) => {\r\n  //LogHelper.log('[HEADER] ‚úÖ Dados de √ÅGUA recebidos do Orchestrator:', ev.detail);\r\n\r\n  // RFC: Skip update if water-summary-ready already set comparative display\r\n  // The water-summary-ready event has priority as it includes filtered/unfiltered comparison\r\n  if (window._headerWaterData?.isFiltered) {\r\n    LogHelper.log('[HEADER] Skipping water-data-ready - summary with filter already applied');\r\n    return;\r\n  }\r\n\r\n  // Se 'ev.detail.cache' existir, atualiza o card\r\n  if (ev.detail && ev.detail.cache) {\r\n    updateWaterCard(ev.detail.cache);\r\n  }\r\n});\r\n\r\n// ===== HEADER: Listen for water summary (for tooltip and comparative) =====\r\nwindow._headerWaterData = null; // Global for tooltip access\r\n\r\nwindow.addEventListener('myio:water-summary-ready', (ev) => {\r\n  LogHelper.log('[HEADER] üíß heard myio:water-summary-ready:', ev.detail);\r\n  const summary = ev.detail || {};\r\n\r\n  // Store for tooltip\r\n  window._headerWaterData = summary;\r\n\r\n  // Update water card with summary data (includes comparative)\r\n  if (typeof summary.filteredTotal === 'number') {\r\n    updateWaterCardWithSummary(summary);\r\n  }\r\n});\r\n\r\n/**\r\n * Update water card with summary data (includes comparative filter/total)\r\n * @param {Object} summary - Water summary from myio:water-summary-ready\r\n */\r\nfunction updateWaterCardWithSummary(summary) {\r\n  const waterKpi = document.getElementById('water-kpi');\r\n  const waterTrend = document.getElementById('water-trend');\r\n\r\n  if (!waterKpi) return;\r\n\r\n  const { filteredTotal = 0, unfilteredTotal = 0, isFiltered = false } = summary;\r\n\r\n  const formatWater = (val) =>\r\n    typeof MyIOLibrary?.formatWaterVolumeM3 === 'function'\r\n      ? MyIOLibrary.formatWaterVolumeM3(val)\r\n      : `${val.toFixed(2)} m¬≥`;\r\n\r\n  // Show comparative when filtered and values differ\r\n  const showComparative =\r\n    isFiltered && unfilteredTotal > 0 && Math.abs(filteredTotal - unfilteredTotal) > 0.01;\r\n\r\n  waterKpi.style.fontSize = '0.85em';\r\n\r\n  if (showComparative) {\r\n    const formattedFiltered = formatWater(filteredTotal);\r\n    const formattedTotal = formatWater(unfilteredTotal);\r\n    const percentage = Math.round((filteredTotal / unfilteredTotal) * 100);\r\n\r\n    waterKpi.innerHTML = `${formattedFiltered} <span style=\"font-size: 0.65em; color: #666;\">/ ${formattedTotal}</span>`;\r\n\r\n    if (waterTrend) {\r\n      waterTrend.innerText = `${percentage}%`;\r\n    }\r\n    LogHelper.log(\r\n      `[HEADER] Water card updated (filtered): ${formattedFiltered} / ${formattedTotal} (${percentage}%)`\r\n    );\r\n  } else {\r\n    const formatted = formatWater(filteredTotal);\r\n    waterKpi.innerText = formatted;\r\n\r\n    if (waterTrend) {\r\n      waterTrend.innerText = '';\r\n    }\r\n    LogHelper.log(`[HEADER] Water card updated from summary: ${formatted}`);\r\n  }\r\n}\r\n\r\n// ===== HEADER: Listen for equipment count updates from EQUIPMENTS widget =====\r\nwindow._headerEquipData = null; // Global for tooltip access\r\n\r\nwindow.addEventListener('myio:equipment-count-updated', (ev) => {\r\n  LogHelper.log('[HEADER] üîß heard myio:equipment-count-updated:', ev.detail);\r\n\r\n  // Store for tooltip\r\n  window._headerEquipData = ev.detail;\r\n\r\n  updateEquipmentCard(ev.detail);\r\n});\r\n\r\n// ===== HEADER: Listen for shopping filter =====\r\nwindow.addEventListener('myio:filter-applied', (ev) => {\r\n  LogHelper.log('[HEADER] üî• heard myio:filter-applied:', ev.detail);\r\n\r\n  const selection = ev.detail?.selection || [];\r\n  selectedShoppingIds = selection.map((s) => s.value).filter((v) => v);\r\n\r\n  LogHelper.log(\r\n    '[HEADER] Applying shopping filter:',\r\n    selectedShoppingIds.length === 0 ? 'ALL' : `${selectedShoppingIds.length} shoppings`\r\n  );\r\n  if (selectedShoppingIds.length > 0) {\r\n    LogHelper.log('[HEADER] Selected shopping IDs:', selectedShoppingIds);\r\n  }\r\n\r\n  // Equipment card will be updated via myio:equipment-count-updated event from EQUIPMENTS widget\r\n  // Energy/Water cards will be updated via myio:orchestrator-filter-updated event\r\n  // RFC-0100: Temperature card will be updated via myio:temperature-data-ready event from MAIN\r\n  // This ensures the orchestrator has already processed the filter\r\n});\r\n\r\n// ===== HEADER: Listen for orchestrator filter update (after MAIN processes the filter) =====\r\nwindow.addEventListener('myio:orchestrator-filter-updated', (ev) => {\r\n  LogHelper.log('[HEADER] üîÑ heard myio:orchestrator-filter-updated:', ev.detail);\r\n\r\n  // Update cards with current cache - energy-summary-ready will correct the total later\r\n  if (window.MyIOOrchestrator?.getEnergyCache) {\r\n    updateEnergyCard(window.MyIOOrchestrator.getEnergyCache());\r\n  }\r\n  // RFC: Water card is now updated via water-summary-ready event which includes comparative\r\n  // Don't call updateWaterCard here as it would overwrite the comparative display\r\n});\r\n\r\n// ===== HEADER: Listen for water totals calculated from valid TB aliases =====\r\n// Este evento √© disparado quando widgets WATER_COMMON_AREA ou WATER_STORES registram seus IDs\r\nwindow.addEventListener('myio:water-totals-updated', (ev) => {\r\n  const { commonArea, stores, total } = ev.detail || {};\r\n  LogHelper.log('[HEADER] üíß heard myio:water-totals-updated:', { commonArea, stores, total });\r\n\r\n  // RFC: Skip update if water-summary-ready already set comparative display\r\n  // The water-summary-ready event has priority as it includes filtered/unfiltered comparison\r\n  if (window._headerWaterData?.isFiltered) {\r\n    LogHelper.log('[HEADER] Skipping water-totals-updated - summary with filter already applied');\r\n    return;\r\n  }\r\n\r\n  // Atualizar card de √°gua com total calculado (apenas IDs v√°lidos dos Aliases TB)\r\n  const waterKpi = document.getElementById('water-kpi');\r\n  if (waterKpi && total > 0) {\r\n    // Usar MyIOLibrary.formatWaterVolumeM3 diretamente (formatWater √© local √† fun√ß√£o updateWaterCard)\r\n    const formatted =\r\n      typeof MyIOLibrary?.formatWaterVolumeM3 === 'function'\r\n        ? MyIOLibrary.formatWaterVolumeM3(total)\r\n        : `${total.toFixed(2)} m¬≥`;\r\n    waterKpi.innerText = formatted;\r\n    LogHelper.log(`[HEADER] Water card updated from valid aliases: ${formatted}`);\r\n  }\r\n});\r\n\r\n// ===== RFC-0100: HEADER listens for temperature data from MAIN orchestrator =====\r\nlet currentTemperatureData = null;\r\nwindow._headerTempData = null; // Global for tooltip access\r\n\r\nwindow.addEventListener('myio:temperature-data-ready', (ev) => {\r\n  LogHelper.log('[HEADER] RFC-0100: Received temperature data from MAIN:', ev.detail);\r\n  const data = ev.detail;\r\n  if (data) {\r\n    currentTemperatureData = data;\r\n    window._headerTempData = data; // Store globally for tooltip\r\n    updateTemperatureCardFromOrchestrator(data);\r\n  }\r\n});\r\n\r\n/**\r\n * RFC-0105: Build temperature tooltip content HTML\r\n * Uses InfoTooltip CSS classes for consistent styling\r\n */\r\nfunction buildTemperatureTooltipContent(data) {\r\n  const {\r\n    globalAvg,\r\n    filteredAvg,\r\n    isFiltered,\r\n    shoppingsInRange = [],\r\n    shoppingsOutOfRange = [],\r\n    shoppingsUnknownRange = [],\r\n  } = data || {};\r\n\r\n  const totalShoppings = shoppingsInRange.length + shoppingsOutOfRange.length + shoppingsUnknownRange.length;\r\n\r\n  // Build shopping list HTML\r\n  let shoppingListHtml = '';\r\n\r\n  if (shoppingsInRange.length > 0) {\r\n    shoppingListHtml += `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">\r\n          <span>‚úÖ</span> Dentro da Faixa (${shoppingsInRange.length})\r\n        </div>\r\n        ${shoppingsInRange.map((s) => {\r\n          const rangeText = s.min != null && s.max != null ? `(${s.min}‚Äì${s.max}¬∞C)` : '';\r\n          return `\r\n          <div class=\"myio-info-tooltip__row\">\r\n            <span class=\"myio-info-tooltip__label\">‚úî ${s.name} <span style=\"color:#94a3b8;font-size:10px;\">${rangeText}</span></span>\r\n            <span class=\"myio-info-tooltip__value\" style=\"color:#22c55e;\">${s.avg?.toFixed(1)}¬∞C</span>\r\n          </div>`;\r\n        }).join('')}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  if (shoppingsOutOfRange.length > 0) {\r\n    shoppingListHtml += `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">\r\n          <span>‚ö†Ô∏è</span> Fora da Faixa (${shoppingsOutOfRange.length})\r\n        </div>\r\n        ${shoppingsOutOfRange.map((s) => {\r\n          const rangeText = s.min != null && s.max != null ? `(${s.min}‚Äì${s.max}¬∞C)` : '';\r\n          return `\r\n          <div class=\"myio-info-tooltip__row\">\r\n            <span class=\"myio-info-tooltip__label\">‚ö† ${s.name} <span style=\"color:#94a3b8;font-size:10px;\">${rangeText}</span></span>\r\n            <span class=\"myio-info-tooltip__value\" style=\"color:#f59e0b;\">${s.avg?.toFixed(1)}¬∞C</span>\r\n          </div>`;\r\n        }).join('')}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  if (shoppingsUnknownRange.length > 0) {\r\n    shoppingListHtml += `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">\r\n          <span>‚ùì</span> Faixa N√£o Definida (${shoppingsUnknownRange.length})\r\n        </div>\r\n        ${shoppingsUnknownRange.map((s) => `\r\n          <div class=\"myio-info-tooltip__row\">\r\n            <span class=\"myio-info-tooltip__label\">? ${s.name} <span style=\"color:#94a3b8;font-size:10px;\">(sem configura√ß√£o)</span></span>\r\n            <span class=\"myio-info-tooltip__value\" style=\"color:#6b7280;\">${s.avg?.toFixed(1)}¬∞C</span>\r\n          </div>\r\n        `).join('')}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  // Status badge\r\n  const okCount = shoppingsInRange.length;\r\n  const warnCount = shoppingsOutOfRange.length;\r\n  const unknownCount = shoppingsUnknownRange.length;\r\n\r\n  let statusHtml = '';\r\n  if (totalShoppings > 0) {\r\n    const okPerc = Math.round((okCount / totalShoppings) * 100);\r\n    const warnPerc = Math.round((warnCount / totalShoppings) * 100);\r\n    const unknownPerc = Math.round((unknownCount / totalShoppings) * 100);\r\n\r\n    statusHtml = `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">üìä Resumo</div>\r\n        <div style=\"display:flex;gap:8px;flex-wrap:wrap;\">\r\n          <span style=\"background:#dcfce7;color:#15803d;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;\">\r\n            ‚úÖ ${okCount} OK (${okPerc}%)\r\n          </span>\r\n          ${warnCount > 0 ? `<span style=\"background:#fef3c7;color:#b45309;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;\">\r\n            ‚ö†Ô∏è ${warnCount} Alerta (${warnPerc}%)\r\n          </span>` : ''}\r\n          ${unknownCount > 0 ? `<span style=\"background:#f3f4f6;color:#6b7280;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;\">\r\n            ‚ùì ${unknownCount} N/D (${unknownPerc}%)\r\n          </span>` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  // Averages section\r\n  const avgValue = isFiltered ? (filteredAvg || globalAvg || '--') : (globalAvg || '--');\r\n  const avgLabel = isFiltered ? 'M√©dia Filtrada' : 'M√©dia Geral';\r\n  const avgFormatted = typeof avgValue === 'number' ? avgValue.toFixed(1) + '¬∞C' : avgValue;\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">üå°Ô∏è ${avgLabel}</div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Temperatura:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${avgFormatted}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Shoppings:</span>\r\n        <span class=\"myio-info-tooltip__value\">${totalShoppings}</span>\r\n      </div>\r\n    </div>\r\n\r\n    ${statusHtml}\r\n    ${shoppingListHtml}\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">‚ÑπÔ∏è</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        S√£o considerados apenas os <strong>sensores em ambientes climatiz√°veis</strong> que estejam <strong>ativos</strong>.\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nfunction showTemperatureTooltip(triggerElement, data) {\r\n  LogHelper.log('[HEADER] showTemperatureTooltip called', { triggerElement, data });\r\n\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot show temperature tooltip');\r\n    return;\r\n  }\r\n\r\n  const content = buildTemperatureTooltipContent(data);\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: 'üå°Ô∏è',\r\n    title: 'Temperatura - Vis√£o Geral',\r\n    content: content\r\n  });\r\n}\r\n\r\nfunction hideTemperatureTooltip() {\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot hide temperature tooltip');\r\n    return;\r\n  }\r\n  InfoTooltip.startDelayedHide();\r\n}\r\n\r\n// ===== ENERGY TOOLTIP FUNCTIONS =====\r\n\r\n/**\r\n * RFC-0105: Build energy tooltip content HTML\r\n */\r\nfunction buildEnergyTooltipContent(data) {\r\n  const {\r\n    customerTotal = 0,\r\n    equipmentsTotal = 0,\r\n    lojasTotal = 0,\r\n    deviceCount = 0,\r\n    shoppingsEnergy = [],\r\n  } = data || {};\r\n\r\n  const formatEnergy = (val) => {\r\n    if (val == null || isNaN(val)) return '--';\r\n    if (typeof MyIOLibrary?.formatEnergy === 'function') {\r\n      return MyIOLibrary.formatEnergy(val);\r\n    }\r\n    return val >= 1000 ? `${(val / 1000).toFixed(2)} MWh` : `${val.toFixed(2)} kWh`;\r\n  };\r\n\r\n  // Build shopping table HTML if available\r\n  let shoppingTableHtml = '';\r\n  if (shoppingsEnergy && shoppingsEnergy.length > 0) {\r\n    const rows = shoppingsEnergy\r\n      .sort((a, b) => (b.equipamentos || 0) + (b.lojas || 0) - ((a.equipamentos || 0) + (a.lojas || 0)))\r\n      .map((s) => `\r\n        <div class=\"myio-info-tooltip__row\" style=\"font-size:11px;\">\r\n          <span class=\"myio-info-tooltip__label\">${s.name}</span>\r\n          <span class=\"myio-info-tooltip__value\">${formatEnergy((s.equipamentos || 0) + (s.lojas || 0))}</span>\r\n        </div>\r\n      `).join('');\r\n\r\n    shoppingTableHtml = `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">\r\n          <span>üè¢</span> Por Shopping\r\n        </div>\r\n        ${rows}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Resumo Geral\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Consumo Total:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatEnergy(customerTotal)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Equipamentos:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(equipmentsTotal)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Lojas:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(lojasTotal)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Dispositivos:</span>\r\n        <span class=\"myio-info-tooltip__value\">${deviceCount || 0}</span>\r\n      </div>\r\n    </div>\r\n\r\n    ${shoppingTableHtml}\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">‚ÑπÔ∏è</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        O consumo total inclui <strong>equipamentos de √°rea comum</strong> e <strong>medidores de lojas</strong>.\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nfunction showEnergyTooltip(triggerElement, data) {\r\n  LogHelper.log('[HEADER] showEnergyTooltip called', { triggerElement, data });\r\n\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot show energy tooltip');\r\n    return;\r\n  }\r\n\r\n  const content = buildEnergyTooltipContent(data);\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: '‚ö°',\r\n    title: 'Detalhes de Consumo de Energia',\r\n    content: content\r\n  });\r\n}\r\n\r\nfunction hideEnergyTooltip() {\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot hide energy tooltip');\r\n    return;\r\n  }\r\n  InfoTooltip.startDelayedHide();\r\n}\r\n\r\n// ============================================\r\n// WATER TOOLTIP FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * RFC-0105: Build water tooltip content using InfoTooltip classes\r\n */\r\nfunction buildWaterTooltipContent(data) {\r\n  const { filteredTotal = 0, commonArea = 0, stores = 0, deviceCount = 0, shoppingsWater = [] } = data || {};\r\n\r\n  // Format water value\r\n  const formatWater = (val) => {\r\n    if (val == null || isNaN(val)) return '--';\r\n    if (typeof MyIOLibrary?.formatWaterVolumeM3 === 'function') {\r\n      return MyIOLibrary.formatWaterVolumeM3(val);\r\n    }\r\n    return `${val.toFixed(2)} m¬≥`;\r\n  };\r\n\r\n  // Build shopping list HTML if available\r\n  let shoppingListHtml = '';\r\n  if (shoppingsWater && shoppingsWater.length > 0) {\r\n    const rows = shoppingsWater\r\n      .sort((a, b) => (b.areaComum || 0) + (b.lojas || 0) - ((a.areaComum || 0) + (a.lojas || 0)))\r\n      .map((s) => `\r\n        <div class=\"myio-info-tooltip__row\" style=\"font-size:11px;\">\r\n          <span class=\"myio-info-tooltip__label\">${s.name}</span>\r\n          <span class=\"myio-info-tooltip__value\">${formatWater((s.areaComum || 0) + (s.lojas || 0))}</span>\r\n        </div>\r\n      `).join('');\r\n\r\n    shoppingListHtml = `\r\n      <div class=\"myio-info-tooltip__section\">\r\n        <div class=\"myio-info-tooltip__section-title\">\r\n          <span>üè¢</span> Por Shopping\r\n        </div>\r\n        ${rows}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Resumo Geral\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Consumo Total:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatWater(filteredTotal)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">√Årea Comum:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatWater(commonArea)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Lojas:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatWater(stores)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Dispositivos:</span>\r\n        <span class=\"myio-info-tooltip__value\">${deviceCount || 0}</span>\r\n      </div>\r\n    </div>\r\n\r\n    ${shoppingListHtml}\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">‚ÑπÔ∏è</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        O consumo total considera <strong>hidr√¥metros de √°rea comum</strong> e <strong>hidr√¥metros de lojas</strong>.\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nfunction showWaterTooltip(triggerElement, data) {\r\n  LogHelper.log('[HEADER] showWaterTooltip called', { triggerElement, data });\r\n\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot show water tooltip');\r\n    return;\r\n  }\r\n\r\n  const content = buildWaterTooltipContent(data);\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: 'üíß',\r\n    title: 'Detalhes de Consumo de √Ågua',\r\n    content: content\r\n  });\r\n}\r\n\r\nfunction hideWaterTooltip() {\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot hide water tooltip');\r\n    return;\r\n  }\r\n  InfoTooltip.startDelayedHide();\r\n}\r\n\r\n// ============================================\r\n// EQUIPMENT TOOLTIP FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * RFC-0105: Build equipment tooltip content using InfoTooltip classes\r\n */\r\nfunction buildEquipmentTooltipContent(data) {\r\n  const {\r\n    totalEquipments = 0,\r\n    filteredEquipments = 0,\r\n    allShoppingsSelected = true,\r\n    categories = null,\r\n  } = data || {};\r\n\r\n  // Category colors for badges\r\n  const categoryColors = {\r\n    climatizacao: { bg: '#ecfeff', border: '#06b6d4', text: '#0891b2' },\r\n    elevadores: { bg: '#f5f3ff', border: '#8b5cf6', text: '#7c3aed' },\r\n    escadasRolantes: { bg: '#fffbeb', border: '#f59e0b', text: '#d97706' },\r\n    outros: { bg: '#f1f5f9', border: '#64748b', text: '#475569' },\r\n  };\r\n\r\n  // Build categories HTML\r\n  let categoriesHtml = '';\r\n  if (categories) {\r\n    const categoryOrder = ['climatizacao', 'elevadores', 'escadasRolantes', 'outros'];\r\n\r\n    categoryOrder.forEach((key) => {\r\n      const cat = categories[key];\r\n      if (cat) {\r\n        const colors = categoryColors[key] || categoryColors.outros;\r\n        const displayValue = allShoppingsSelected ? cat.total : `${cat.filtered} / ${cat.total}`;\r\n        const percentage = cat.total > 0 ? Math.round((cat.filtered / cat.total) * 100) : 0;\r\n        const percentText = !allShoppingsSelected ? ` (${percentage}%)` : '';\r\n\r\n        categoriesHtml += `\r\n          <div style=\"display:flex;align-items:center;gap:10px;padding:10px 12px;background:${colors.bg};border-radius:8px;margin-bottom:8px;border-left:3px solid ${colors.border};\">\r\n            <span style=\"font-size:16px;\">${cat.icon}</span>\r\n            <div style=\"flex:1;\">\r\n              <div style=\"font-weight:600;color:#334155;font-size:12px;\">${cat.label}</div>\r\n              <div style=\"font-size:11px;color:#64748b;margin-top:2px;\">${\r\n                allShoppingsSelected ? 'Total' : `Filtrados${percentText}`\r\n              }</div>\r\n            </div>\r\n            <span style=\"font-weight:700;color:${colors.text};font-size:14px;\">${displayValue}</span>\r\n          </div>\r\n        `;\r\n      }\r\n    });\r\n  }\r\n\r\n  // Summary values\r\n  const summaryDisplay = allShoppingsSelected\r\n    ? `${totalEquipments}`\r\n    : `${filteredEquipments} / ${totalEquipments}`;\r\n  const percentageTotal = totalEquipments > 0 ? Math.round((filteredEquipments / totalEquipments) * 100) : 0;\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Resumo Geral\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Total de Equipamentos:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${summaryDisplay}</span>\r\n      </div>\r\n      ${!allShoppingsSelected ? `\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Percentual Filtrado:</span>\r\n        <span class=\"myio-info-tooltip__value\">${percentageTotal}%</span>\r\n      </div>\r\n      ` : ''}\r\n    </div>\r\n\r\n    ${categoriesHtml ? `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìã</span> Por Categoria\r\n      </div>\r\n      ${categoriesHtml}\r\n    </div>\r\n    ` : ''}\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">‚ÑπÔ∏è</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        Equipamentos monitorados: <strong>Escadas Rolantes</strong>, <strong>Elevadores</strong>,\r\n        <strong>Chillers</strong>, <strong>Bombas</strong>, <strong>Fancoils</strong>, e outros\r\n        equipamentos de <strong>Climatiza√ß√£o</strong>.\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nfunction showEquipmentTooltip(triggerElement, data) {\r\n  LogHelper.log('[HEADER] showEquipmentTooltip called', { triggerElement, data });\r\n\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot show equipment tooltip');\r\n    return;\r\n  }\r\n\r\n  const content = buildEquipmentTooltipContent(data);\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: '‚öôÔ∏è',\r\n    title: 'Detalhes de Equipamentos',\r\n    content: content\r\n  });\r\n}\r\n\r\nfunction hideEquipmentTooltip() {\r\n  // RFC-0105: Use InfoTooltip from library (required)\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    console.error('[HEADER] InfoTooltip not available - cannot hide equipment tooltip');\r\n    return;\r\n  }\r\n  InfoTooltip.startDelayedHide();\r\n}\r\n\r\n// Setup tooltip trigger events\r\nfunction setupTemperatureTooltip() {\r\n  // Try to find trigger in widget container first, then fallback to document\r\n  const root = (self?.ctx?.$container && self.ctx.$container[0]) || document;\r\n  const trigger = root.querySelector\r\n    ? root.querySelector('#temp-info-trigger')\r\n    : document.getElementById('temp-info-trigger');\r\n\r\n  if (!trigger || trigger._tooltipBound) return;\r\n\r\n  trigger._tooltipBound = true;\r\n  LogHelper.log('[HEADER] Temperature tooltip trigger found and bound');\r\n\r\n  trigger.addEventListener('mouseenter', () => {\r\n    LogHelper.log(\r\n      '[HEADER] Temperature tooltip mouseenter, data:',\r\n      currentTemperatureData ? 'available' : 'not available'\r\n    );\r\n    if (currentTemperatureData) {\r\n      showTemperatureTooltip(trigger, currentTemperatureData);\r\n    }\r\n  });\r\n\r\n  trigger.addEventListener('mouseleave', () => {\r\n    hideTemperatureTooltip();\r\n  });\r\n\r\n  // Also hide on click outside\r\n  document.addEventListener('click', (e) => {\r\n    if (!e.target.closest('.temp-tooltip-container') && !e.target.closest('#temp-info-trigger')) {\r\n      hideTemperatureTooltip();\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * RFC-0100: Simplified temperature card update - receives data from MAIN orchestrator\r\n * @param {Object} data - Temperature data from myio:temperature-data-ready event\r\n */\r\nfunction updateTemperatureCardFromOrchestrator(data) {\r\n  const tempKpi = document.getElementById('temp-kpi');\r\n  const tempTrend = document.getElementById('temp-trend');\r\n  const tempChip = document.querySelector('#card-temp .chip');\r\n\r\n  const { globalAvg, filteredAvg, isFiltered, shoppingsInRange = [], shoppingsOutOfRange = [] } = data || {};\r\n\r\n  // Setup tooltip on first update\r\n  setupTemperatureTooltip();\r\n\r\n  // RFC-0099/RFC-0100: Update KPI with comparative display when filtered\r\n  if (tempKpi) {\r\n    tempKpi.style.fontSize = '0.85em';\r\n\r\n    const showComparative =\r\n      isFiltered && globalAvg != null && filteredAvg != null && Math.abs(filteredAvg - globalAvg) > 0.05;\r\n\r\n    if (showComparative) {\r\n      tempKpi.innerHTML = `${filteredAvg.toFixed(\r\n        1\r\n      )}¬∞C <span style=\"font-size: 0.65em; color: #666;\">/ ${globalAvg.toFixed(1)}¬∞C</span>`;\r\n\r\n      const percentageDiff = ((filteredAvg - globalAvg) / globalAvg) * 100;\r\n      const absDiff = Math.abs(percentageDiff).toFixed(0);\r\n      const isAbove = percentageDiff > 0;\r\n\r\n      if (tempTrend) {\r\n        const diffLabel = isAbove ? 'acima da m√©dia' : 'abaixo da m√©dia';\r\n        const diffColor = isAbove ? '#f57c00' : '#0288d1';\r\n        tempTrend.innerHTML = `<span style=\"color: ${diffColor};\">${absDiff}% ${diffLabel}</span>`;\r\n      }\r\n\r\n      LogHelper.log(\r\n        `[HEADER] RFC-0100: Temperature card updated (filtered): ${filteredAvg.toFixed(\r\n          1\r\n        )}¬∞C / ${globalAvg.toFixed(1)}¬∞C (${absDiff}% ${isAbove ? 'above' : 'below'})`\r\n      );\r\n    } else {\r\n      tempKpi.innerText = globalAvg != null ? `${globalAvg.toFixed(1)}¬∞C` : '--¬∞C';\r\n      if (tempTrend) tempTrend.innerText = '';\r\n    }\r\n  }\r\n\r\n  // Update chip status (simplified - detailed info is now in the premium tooltip)\r\n  if (!tempChip) return;\r\n\r\n  const totalShoppings = shoppingsInRange.length + shoppingsOutOfRange.length;\r\n  const chipStyle = 'font-size: 10px; display: flex; align-items: center; gap: 4px;';\r\n\r\n  if (totalShoppings === 0) {\r\n    tempChip.innerHTML = `<span style=\"${chipStyle}\">-- Sem dados</span>`;\r\n    tempChip.className = 'chip';\r\n  } else if (shoppingsOutOfRange.length === 0) {\r\n    tempChip.innerHTML = `<span style=\"${chipStyle}\">‚úî Todos na faixa</span>`;\r\n    tempChip.className = 'chip ok';\r\n  } else if (shoppingsInRange.length === 0) {\r\n    tempChip.innerHTML = `<span style=\"${chipStyle}\">‚ö† Todos fora da faixa</span>`;\r\n    tempChip.className = 'chip warn';\r\n  } else {\r\n    tempChip.innerHTML = `<span style=\"${chipStyle}\">‚ö† ${shoppingsOutOfRange.length} fora da faixa</span>`;\r\n    tempChip.className = 'chip warn';\r\n  }\r\n}\r\n\r\nself.onDataUpdated = function () {\r\n  if (_dataRefreshCount >= MAX_DATA_REFRESHES) {\r\n    return;\r\n  }\r\n\r\n  _dataRefreshCount++;\r\n\r\n  // Equipment card will be updated via myio:equipment-count-updated event from EQUIPMENTS widget\r\n  // No need to call updateEquipmentCard() here anymore\r\n\r\n  // RFC-0100: Request temperature data from MAIN orchestrator instead of fetching directly\r\n  // Temperature card will be updated via myio:temperature-data-ready event\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:request-temperature-data', {\r\n      detail: {\r\n        startTs: self.ctx?.$scope?.startDateISO\r\n          ? new Date(self.ctx.$scope.startDateISO).getTime()\r\n          : Date.now() - 30 * 24 * 60 * 60 * 1000,\r\n        endTs: self.ctx.$scope?.endDateISO ? new Date(self.ctx.$scope.endDateISO).getTime() : Date.now(),\r\n      },\r\n    })\r\n  );\r\n};\r\n\r\nself.onDestroy = function () {\r\n  /* nada a limpar */\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Settings\",\r\n    \"properties\": {\r\n      \"cardEquipamentosBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card Equipamentos - Background Color\",\r\n        \"default\": \"#1F3A35\"\r\n      },\r\n      \"cardEquipamentosFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card Equipamentos - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      },\r\n      \"cardEnergiaBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card Consumo de Energia - Background Color\",\r\n        \"default\": \"#1F3A35\"\r\n      },\r\n      \"cardEnergiaFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card Consumo de Energia - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      },\r\n      \"cardTemperaturaBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card M√©dia de Temperatura - Background Color\",\r\n        \"default\": \"#1F3A35\"\r\n      },\r\n      \"cardTemperaturaFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card M√©dia de Temperatura - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      },\r\n      \"cardAguaBackgroundColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card √Ågua - Background Color\",\r\n        \"default\": \"#1F3A35\"\r\n      },\r\n      \"cardAguaFontColor\": {\r\n        \"type\": \"string\",\r\n        \"title\": \"Card √Ågua - Font Color\",\r\n        \"default\": \"#F2F2F2\"\r\n      }\r\n    }\r\n  }\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - HEADER - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "0d6046f0-c977-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}