{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_temperature_v_5_2_0",
    "name": "Widget Head Office - TEMPERATURE - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
        },
        {
          "url": "https://unpkg.com/myio-js-library@0.1.180/dist/myio-js-library.umd.min.js"
        },
        {
          "url": "https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
        }
      ],
      "templateHtml": "<section class=\"tb-temp-root\">\r\n  <!-- Loading overlay -->\r\n  <div id=\"temperature-loading-overlay\" class=\"temperature-loading-overlay\" style=\"display: none\">\r\n    <div class=\"loading-spinner\">\r\n      <svg style=\"width: 48px; height: 48px; animation: spin 1s linear infinite\" viewBox=\"0 0 50 50\">\r\n        <circle\r\n          cx=\"25\"\r\n          cy=\"25\"\r\n          r=\"20\"\r\n          fill=\"none\"\r\n          stroke=\"#e65100\"\r\n          stroke-width=\"5\"\r\n          stroke-linecap=\"round\"\r\n          stroke-dasharray=\"90,150\"\r\n          stroke-dashoffset=\"0\"\r\n        ></circle>\r\n      </svg>\r\n      <p>Carregando dados de temperatura...</p>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- KPI Header Cards -->\r\n  <header class=\"header\">\r\n    <div class=\"kpi-card\">\r\n      <div class=\"kpi-head\">\r\n        <span class=\"kpi-title\">Temperatura Media Global</span>\r\n        <i class=\"kpi-ico\">üå°Ô∏è</i>\r\n      </div>\r\n      <div class=\"kpi-value\" id=\"avgTemp\">--</div>\r\n      <div class=\"kpi-sub\">\r\n        <span id=\"avgTempTarget\">Meta: 23¬∞C +/- 2¬∞C</span>\r\n      </div>\r\n      <div class=\"kpi-progress\">\r\n        <div class=\"bar\" id=\"avgTempBar\" style=\"width: 0%\"></div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"kpi-card\">\r\n      <div class=\"kpi-head\">\r\n        <span class=\"kpi-title\">Total de Sensores</span>\r\n        <i class=\"kpi-ico\">üìä</i>\r\n      </div>\r\n      <div class=\"kpi-value\" id=\"totalSensors\">--</div>\r\n      <div class=\"kpi-sub\">Sensores Monitorados</div>\r\n    </div>\r\n\r\n    <div class=\"kpi-card\">\r\n      <div class=\"kpi-head\">\r\n        <span class=\"kpi-title\">Shoppings Online</span>\r\n        <i class=\"kpi-ico\">üè¨</i>\r\n      </div>\r\n      <div class=\"kpi-value\" id=\"shoppingsOnline\">--</div>\r\n      <div class=\"kpi-sub\">\r\n        <span class=\"badge badge-on\" id=\"shoppingsBadge\">Ativo</span>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"kpi-card alert-card\">\r\n      <div class=\"kpi-head\">\r\n        <span class=\"kpi-title\">Alertas</span>\r\n        <i class=\"kpi-ico\">‚ö†Ô∏è</i>\r\n      </div>\r\n      <div class=\"kpi-value\" id=\"alertCount\">--</div>\r\n      <div class=\"kpi-sub\">Fora do intervalo ideal</div>\r\n    </div>\r\n  </header>\r\n\r\n  <!-- RFC-0098: Container for createConsumptionChartWidget (widget injects its own HTML) -->\r\n  <section id=\"temperature-chart-widget\" class=\"chart-card chart-card-7days\"></section>\r\n\r\n  <!-- Temperature Comparison Chart -->\r\n  <section class=\"chart-card\">\r\n    <h3 class=\"chart-title\">Comparativo de Temperatura por Shopping</h3>\r\n    <p class=\"chart-sub\">Evolucao da temperatura media ao longo do dia em cada shopping center</p>\r\n    <div class=\"chart-container\">\r\n      <canvas id=\"tempChart\"></canvas>\r\n    </div>\r\n  </section>\r\n\r\n  <!-- Shopping Temperature List -->\r\n  <section class=\"list-card\">\r\n    <h3 class=\"list-title\">Temperatura por Shopping Center</h3>\r\n    <p class=\"list-sub\">Status de temperatura consolidado de cada shopping</p>\r\n\r\n    <div class=\"shopping-list\" id=\"shoppingList\">\r\n      <!-- rows generated via JS -->\r\n    </div>\r\n  </section>\r\n</section>\r\n",
      "templateCss": "/* RFC-0092: TEMPERATURE Widget Styles (Head Office) */\r\n\r\n:root {\r\n  --ink-1: #1c2743;\r\n  --ink-2: #6b7a90;\r\n  --ink-3: #9aa6b2;\r\n  --brand: #e65100;\r\n  --brand-light: #ff9800;\r\n  --accent: #ff5722;\r\n  --bg: #f5f8fb;\r\n  --card: #ffffff;\r\n  --bd: #e6eef5;\r\n  --ok: #15a34a;\r\n  --warn: #d97706;\r\n  --danger: #c62828;\r\n  --cold: #1565c0;\r\n  --muted: #e6eef5;\r\n  --shadow: 0 8px 24px rgba(230, 81, 0, 0.08);\r\n  --shadow-2: 0 14px 36px rgba(230, 81, 0, 0.12);\r\n}\r\n\r\n/* === CONTAINER PRINCIPAL === */\r\n.tb-temp-root {\r\n  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;\r\n  color: var(--ink-1);\r\n  height: 100%;\r\n  max-height: 100%;\r\n  overflow-y: auto;\r\n  overflow-x: hidden;\r\n  padding: 16px 12px 16px 16px;\r\n  box-sizing: border-box;\r\n  scroll-behavior: smooth;\r\n  background: transparent;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n}\r\n\r\n/* === LOADING OVERLAY === */\r\n.temperature-loading-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(255, 255, 255, 0.95);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 1000;\r\n  backdrop-filter: blur(4px);\r\n}\r\n\r\n.loading-spinner {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 16px;\r\n}\r\n\r\n.loading-spinner p {\r\n  font-size: 14px;\r\n  font-weight: 600;\r\n  color: var(--ink-1);\r\n  margin: 0;\r\n}\r\n\r\n@keyframes spin {\r\n  0% {\r\n    transform: rotate(0deg);\r\n  }\r\n  100% {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* ===== KPI HEADER ===== */\r\n.header {\r\n  display: grid;\r\n  grid-template-columns: repeat(4, 1fr);\r\n  gap: 16px;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.kpi-card {\r\n  background: var(--card);\r\n  border: 1px solid var(--bd);\r\n  border-radius: 16px;\r\n  padding: 16px;\r\n  box-shadow: var(--shadow);\r\n  transition: transform 0.2s, box-shadow 0.2s;\r\n}\r\n\r\n.kpi-card:hover {\r\n  transform: translateY(-2px);\r\n  box-shadow: var(--shadow-2);\r\n}\r\n\r\n.kpi-card.alert-card {\r\n  background: linear-gradient(135deg, #fff3e0, #ffe0b2);\r\n  border-color: #ffb74d;\r\n}\r\n\r\n.kpi-head {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n.kpi-title {\r\n  font-size: 13px;\r\n  color: var(--ink-2);\r\n  font-weight: 500;\r\n}\r\n\r\n.kpi-ico {\r\n  font-style: normal;\r\n  font-size: 18px;\r\n  opacity: 0.65;\r\n}\r\n\r\n.kpi-value {\r\n  font-size: 32px;\r\n  font-weight: 800;\r\n  letter-spacing: 0.2px;\r\n  color: var(--brand);\r\n}\r\n\r\n.kpi-value.has-alerts {\r\n  color: var(--danger);\r\n}\r\n\r\n.kpi-sub {\r\n  font-size: 12px;\r\n  color: var(--ink-2);\r\n  margin-top: 6px;\r\n}\r\n\r\n.kpi-progress {\r\n  height: 6px;\r\n  border-radius: 6px;\r\n  background: #eff5fa;\r\n  margin-top: 10px;\r\n  overflow: hidden;\r\n}\r\n\r\n.kpi-progress .bar {\r\n  height: 100%;\r\n  background: linear-gradient(90deg, var(--brand), var(--brand-light));\r\n  transition: width 0.3s ease;\r\n}\r\n\r\n/* ===== BADGE ===== */\r\n.badge {\r\n  font-size: 12px;\r\n  padding: 4px 10px;\r\n  border-radius: 999px;\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n.badge-on {\r\n  background: #e7f7ee;\r\n  color: var(--ok);\r\n  border: 1px solid #b8efcf;\r\n}\r\n\r\n.badge-on::before {\r\n  content: '';\r\n  width: 6px;\r\n  height: 6px;\r\n  border-radius: 50%;\r\n  background: var(--ok);\r\n}\r\n\r\n/* ===== CHART ===== */\r\n.chart-card {\r\n  background: var(--card);\r\n  border: 1px solid var(--bd);\r\n  border-radius: 16px;\r\n  padding: 20px;\r\n  margin-bottom: 20px;\r\n  box-shadow: var(--shadow);\r\n}\r\n\r\n.chart-title {\r\n  margin: 0 0 4px 0;\r\n  font-size: 18px;\r\n  font-weight: 700;\r\n  color: var(--ink-1);\r\n}\r\n\r\n.chart-sub {\r\n  margin: 0 0 16px 0;\r\n  font-size: 13px;\r\n  color: var(--ink-2);\r\n}\r\n\r\n.chart-container {\r\n  position: relative;\r\n  height: 300px;\r\n  width: 100%;\r\n}\r\n\r\n/* RFC-0098: 7-Day Chart Styles */\r\n.chart-card-7days {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.chart-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 16px;\r\n  flex-wrap: wrap;\r\n  gap: 12px;\r\n}\r\n\r\n.chart-title-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n}\r\n\r\n.chart-controls {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  flex-wrap: wrap;\r\n}\r\n\r\n.config-btn {\r\n  background: transparent;\r\n  border: none;\r\n  font-size: 18px;\r\n  cursor: pointer;\r\n  padding: 4px 8px;\r\n  border-radius: 6px;\r\n  transition: background 0.2s;\r\n}\r\n\r\n.config-btn:hover {\r\n  background: rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.maximize-btn {\r\n  background: transparent;\r\n  border: 1px solid var(--bd);\r\n  font-size: 16px;\r\n  cursor: pointer;\r\n  padding: 6px 10px;\r\n  border-radius: 6px;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.maximize-btn:hover {\r\n  background: var(--brand-light);\r\n  border-color: var(--brand-light);\r\n  color: white;\r\n}\r\n\r\n/* Chart Tabs */\r\n.chart-tabs {\r\n  display: flex;\r\n  gap: 4px;\r\n  background: var(--muted);\r\n  padding: 4px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.chart-tab {\r\n  padding: 6px 14px;\r\n  font-size: 12px;\r\n  font-weight: 500;\r\n  border: none;\r\n  background: transparent;\r\n  color: var(--ink-2);\r\n  cursor: pointer;\r\n  border-radius: 6px;\r\n  transition: all 0.2s;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chart-tab:hover {\r\n  color: var(--ink-1);\r\n  background: rgba(255, 255, 255, 0.5);\r\n}\r\n\r\n.chart-tab.active {\r\n  background: white;\r\n  color: var(--brand);\r\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n/* ===== SHOPPING LIST ===== */\r\n.list-card {\r\n  background: var(--card);\r\n  border: 1px solid var(--bd);\r\n  border-radius: 16px;\r\n  padding: 20px;\r\n  box-shadow: var(--shadow);\r\n}\r\n\r\n.list-title {\r\n  margin: 0 0 4px 0;\r\n  font-size: 18px;\r\n  font-weight: 700;\r\n  color: var(--ink-1);\r\n}\r\n\r\n.list-sub {\r\n  margin: 0 0 16px 0;\r\n  font-size: 13px;\r\n  color: var(--ink-2);\r\n}\r\n\r\n.shopping-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12px;\r\n}\r\n\r\n/* Shopping Row */\r\n.shopping-row {\r\n  display: grid;\r\n  grid-template-columns: 1fr 120px 140px 100px 40px;\r\n  gap: 16px;\r\n  align-items: center;\r\n  background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);\r\n  border: 1px solid var(--bd);\r\n  border-radius: 12px;\r\n  padding: 14px 18px;\r\n  box-shadow: var(--shadow);\r\n  cursor: pointer;\r\n  transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;\r\n}\r\n\r\n.shopping-row:hover {\r\n  transform: translateY(-2px);\r\n  box-shadow: var(--shadow-2);\r\n  border-color: var(--brand-light);\r\n}\r\n\r\n/* Status-based left border */\r\n.shopping-row.status-normal {\r\n  border-left: 4px solid var(--ok);\r\n}\r\n\r\n.shopping-row.status-hot {\r\n  border-left: 4px solid var(--danger);\r\n}\r\n\r\n.shopping-row.status-cold {\r\n  border-left: 4px solid var(--cold);\r\n}\r\n\r\n.shopping-row.status-no_info {\r\n  border-left: 4px solid #bdbdbd;\r\n  opacity: 0.7;\r\n}\r\n\r\n.shopping-left {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.dot {\r\n  width: 12px;\r\n  height: 12px;\r\n  border-radius: 50%;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.dot.normal {\r\n  background: var(--ok);\r\n  box-shadow: 0 0 6px rgba(21, 163, 74, 0.4);\r\n}\r\n\r\n.dot.hot {\r\n  background: var(--danger);\r\n  box-shadow: 0 0 6px rgba(198, 40, 40, 0.4);\r\n}\r\n\r\n.dot.cold {\r\n  background: var(--cold);\r\n  box-shadow: 0 0 6px rgba(21, 101, 192, 0.4);\r\n}\r\n\r\n.dot.no_info {\r\n  background: #bdbdbd;\r\n}\r\n\r\n.shopping-name {\r\n  font-weight: 600;\r\n  font-size: 14px;\r\n  color: var(--ink-1);\r\n}\r\n\r\n.shopping-sensors {\r\n  font-size: 12px;\r\n  color: var(--ink-3);\r\n  margin-top: 2px;\r\n}\r\n\r\n.ft {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 2px;\r\n}\r\n\r\n.ft .label {\r\n  font-size: 11px;\r\n  color: var(--ink-2);\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.3px;\r\n}\r\n\r\n.ft .value {\r\n  font-weight: 700;\r\n  font-size: 14px;\r\n  color: var(--ink-1);\r\n}\r\n\r\n/* Status Badge */\r\n.status-badge {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  padding: 4px 10px;\r\n  border-radius: 999px;\r\n  font-size: 11px;\r\n  font-weight: 600;\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.3px;\r\n}\r\n\r\n.status-badge.normal {\r\n  background: #e8f5e9;\r\n  color: #2e7d32;\r\n}\r\n\r\n.status-badge.hot {\r\n  background: #ffebee;\r\n  color: #c62828;\r\n}\r\n\r\n.status-badge.cold {\r\n  background: #e3f2fd;\r\n  color: #1565c0;\r\n}\r\n\r\n.status-badge.no_info {\r\n  background: #f5f5f5;\r\n  color: #757575;\r\n}\r\n\r\n/* Action Button */\r\n.shopping-action {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  border: 1px solid var(--bd);\r\n  background: #fff;\r\n  border-radius: 8px;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.shopping-action:hover {\r\n  background: #fff3e0;\r\n  border-color: var(--brand);\r\n}\r\n\r\n.shopping-action svg {\r\n  fill: var(--ink-2);\r\n}\r\n\r\n.shopping-action:hover svg {\r\n  fill: var(--brand);\r\n}\r\n\r\n/* Empty List */\r\n.empty-list {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 40px 20px;\r\n  color: var(--ink-2);\r\n  font-size: 14px;\r\n}\r\n\r\n/* ===== RESPONSIVE ===== */\r\n@media (max-width: 1200px) {\r\n  .header {\r\n    grid-template-columns: repeat(2, 1fr);\r\n  }\r\n\r\n  .shopping-row {\r\n    grid-template-columns: 1fr 100px 120px 80px 40px;\r\n    gap: 12px;\r\n  }\r\n}\r\n\r\n@media (max-width: 920px) {\r\n  .header {\r\n    grid-template-columns: 1fr;\r\n  }\r\n\r\n  .shopping-row {\r\n    grid-template-columns: 1fr;\r\n    gap: 10px;\r\n  }\r\n\r\n  .shopping-left {\r\n    margin-bottom: 8px;\r\n  }\r\n\r\n  .ft {\r\n    flex-direction: row;\r\n    gap: 8px;\r\n    align-items: center;\r\n  }\r\n\r\n  .ft .label {\r\n    min-width: 80px;\r\n  }\r\n\r\n  .shopping-action {\r\n    position: absolute;\r\n    right: 12px;\r\n    top: 50%;\r\n    transform: translateY(-50%);\r\n  }\r\n}\r\n",
      "controllerScript": "/* global self, window, document, localStorage, MyIOLibrary, Chart */\r\n\r\n/**\r\n * RFC-0092: TEMPERATURE Widget Controller (Head Office)\r\n *\r\n * Shopping-level temperature comparison panel.\r\n * Aggregates sensor data per shopping center and displays consolidated averages.\r\n */\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log(...args),\r\n  warn: (...args) => console.warn(...args),\r\n  error: (...args) => console.error(...args),\r\n};\r\n\r\nconst formatRelativeTime =\r\n  window.MyIOUtils?.formatRelativeTime || ((ts) => (ts ? new Date(ts).toLocaleString() : '‚Äî'));\r\n\r\n// ============================================\r\n// WIDGET STATE\r\n// ============================================\r\nconst STATE = {\r\n  shoppingData: [],\r\n  allSensors: [],\r\n  selectedShoppingIds: [],\r\n  dateRange: {\r\n    start: null,\r\n    end: null,\r\n  },\r\n  chartInstance: null,\r\n  isLoading: false,\r\n};\r\n\r\n// RFC-0098: Chart configuration state for 7-day temperature chart\r\nconst chartConfig = {\r\n  period: 7,\r\n  startDate: null,\r\n  endDate: null,\r\n  vizMode: 'total',\r\n  chartType: 'line',\r\n};\r\n\r\n// RFC-0098: Consumption 7 Days Chart instance\r\nlet consumptionChartInstance = null;\r\nlet cachedChartData = null;\r\n\r\n// Settings defaults\r\nconst DEFAULT_SETTINGS = {\r\n  useDemoData: false,\r\n  targetTemp: 23,\r\n  targetTol: 2,\r\n};\r\n\r\nLogHelper.log('[TEMPERATURE] RFC-0092: Widget script loaded');\r\n\r\n// ============================================\r\n// DEMO DATA (for preview mode)\r\n// ============================================\r\nfunction makeDemo() {\r\n  const hours = ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'];\r\n  const mk = (arr) => arr.map((v, i) => ({ t: hours[i], v }));\r\n\r\n  // Shopping-level aggregated data\r\n  const shoppingSeries = [\r\n    {\r\n      label: 'Shopping Center A',\r\n      data: mk([22.0, 21.7, 21.8, 22.3, 23.0, 23.6, 23.2, 22.5]),\r\n      avgTemp: 22.4,\r\n      sensorCount: 12,\r\n    },\r\n    {\r\n      label: 'Shopping Center B',\r\n      data: mk([22.2, 22.0, 22.1, 22.5, 23.2, 23.8, 23.4, 22.7]),\r\n      avgTemp: 22.7,\r\n      sensorCount: 8,\r\n    },\r\n    {\r\n      label: 'Shopping Center C',\r\n      data: mk([21.9, 21.6, 21.7, 22.1, 22.9, 23.4, 23.0, 22.3]),\r\n      avgTemp: 22.1,\r\n      sensorCount: 15,\r\n    },\r\n    {\r\n      label: 'Shopping Center D',\r\n      data: mk([23.2, 23.1, 23.3, 24.0, 24.5, 25.0, 24.6, 24.1]),\r\n      avgTemp: 24.0,\r\n      sensorCount: 10,\r\n    },\r\n  ];\r\n\r\n  // KPIs\r\n  const globalAvgTemp = 22.8;\r\n  const totalSensors = 45;\r\n  const shoppingsOnline = 4;\r\n  const alertCount = 1;\r\n\r\n  return { shoppingSeries, globalAvgTemp, totalSensors, shoppingsOnline, alertCount };\r\n}\r\n\r\n// ============================================\r\n// UTILITY FUNCTIONS\r\n// ============================================\r\n\r\nfunction formatTemperature(value) {\r\n  if (value === null || value === undefined || isNaN(value)) return '--';\r\n  return `${Number(value).toFixed(1)}¬∞C`;\r\n}\r\n\r\nfunction formatKW(value) {\r\n  return `${Number(value || 0).toFixed(1)} kW`;\r\n}\r\n\r\nfunction formatOperationTime(minutes) {\r\n  const min = Number(minutes || 0);\r\n  const h = Math.floor(min / 60);\r\n  const m = min % 60;\r\n  return `${h}h ${String(m).padStart(2, '0')}m`;\r\n}\r\n\r\nfunction getTemperatureStatus(avgTemp, target = 23, tolerance = 2) {\r\n  if (avgTemp === null || avgTemp === undefined || isNaN(avgTemp)) return 'no_info';\r\n  if (avgTemp < target - tolerance) return 'cold';\r\n  if (avgTemp > target + tolerance) return 'hot';\r\n  return 'normal';\r\n}\r\n\r\nfunction showLoadingOverlay(show) {\r\n  const overlay = document.getElementById('temperature-loading-overlay');\r\n  if (overlay) {\r\n    overlay.style.display = show ? 'flex' : 'none';\r\n  }\r\n}\r\n\r\n// ============================================\r\n// KPIs RENDERING\r\n// ============================================\r\n\r\nfunction setKpis({ globalAvgTemp, totalSensors, shoppingsOnline, alertCount }) {\r\n  const ctx = self.ctx;\r\n  const target = Number(ctx.settings?.targetTemp ?? DEFAULT_SETTINGS.targetTemp);\r\n  const tol = Number(ctx.settings?.targetTol ?? DEFAULT_SETTINGS.targetTol);\r\n\r\n  // Average Temperature KPI\r\n  const $avgTemp = document.getElementById('avgTemp');\r\n  const $avgTempBar = document.getElementById('avgTempBar');\r\n  const $avgTempTarget = document.getElementById('avgTempTarget');\r\n\r\n  if ($avgTemp) $avgTemp.textContent = formatTemperature(globalAvgTemp);\r\n  if ($avgTempTarget) $avgTempTarget.textContent = `Meta: ${target}¬∞C +/- ${tol}¬∞C`;\r\n  if ($avgTempBar) {\r\n    const span = Math.max(0, Math.min(100, ((globalAvgTemp - (target - tol)) / (2 * tol)) * 100));\r\n    $avgTempBar.style.width = `${span}%`;\r\n  }\r\n\r\n  // Total Sensors KPI\r\n  const $totalSensors = document.getElementById('totalSensors');\r\n  if ($totalSensors) $totalSensors.textContent = totalSensors || 0;\r\n\r\n  // Shoppings Online KPI\r\n  const $shoppingsOnline = document.getElementById('shoppingsOnline');\r\n  const $shoppingsBadge = document.getElementById('shoppingsBadge');\r\n  if ($shoppingsOnline) $shoppingsOnline.textContent = shoppingsOnline || 0;\r\n  if ($shoppingsBadge) $shoppingsBadge.classList.toggle('badge-on', shoppingsOnline > 0);\r\n\r\n  // Alerts KPI\r\n  const $alertCount = document.getElementById('alertCount');\r\n  if ($alertCount) {\r\n    $alertCount.textContent = alertCount || 0;\r\n    $alertCount.classList.toggle('has-alerts', alertCount > 0);\r\n  }\r\n}\r\n\r\n// ============================================\r\n// CHART RENDERING\r\n// ============================================\r\n\r\nfunction renderComparisonChart(shoppingSeries) {\r\n  const canvas = document.getElementById('tempChart');\r\n  if (!canvas) {\r\n    LogHelper.error('[TEMPERATURE] Chart canvas not found');\r\n    return;\r\n  }\r\n\r\n  // Destroy existing chart\r\n  if (STATE.chartInstance) {\r\n    STATE.chartInstance.destroy();\r\n    STATE.chartInstance = null;\r\n  }\r\n\r\n  if (!shoppingSeries || shoppingSeries.length === 0) {\r\n    LogHelper.warn('[TEMPERATURE] No data for chart');\r\n    return;\r\n  }\r\n\r\n  const labels = shoppingSeries[0]?.data?.map((p) => p.t) || [];\r\n\r\n  // Color palette for shopping centers\r\n  const colors = [\r\n    { border: '#e65100', bg: 'rgba(230, 81, 0, 0.1)' },\r\n    { border: '#1565c0', bg: 'rgba(21, 101, 192, 0.1)' },\r\n    { border: '#2e7d32', bg: 'rgba(46, 125, 50, 0.1)' },\r\n    { border: '#7b1fa2', bg: 'rgba(123, 31, 162, 0.1)' },\r\n    { border: '#c62828', bg: 'rgba(198, 40, 40, 0.1)' },\r\n    { border: '#00838f', bg: 'rgba(0, 131, 143, 0.1)' },\r\n    { border: '#ef6c00', bg: 'rgba(239, 108, 0, 0.1)' },\r\n    { border: '#6a1b9a', bg: 'rgba(106, 27, 154, 0.1)' },\r\n  ];\r\n\r\n  const datasets = shoppingSeries.map((series, i) => ({\r\n    label: `${series.label} (${series.sensorCount || 0} sensores)`,\r\n    data: series.data.map((p) => p.v),\r\n    fill: false,\r\n    tension: 0.35,\r\n    borderWidth: 2,\r\n    borderColor: colors[i % colors.length].border,\r\n    backgroundColor: colors[i % colors.length].bg,\r\n    pointRadius: 3,\r\n    pointHoverRadius: 5,\r\n  }));\r\n\r\n  STATE.chartInstance = new Chart(canvas.getContext('2d'), {\r\n    type: 'line',\r\n    data: { labels, datasets },\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: false,\r\n      interaction: {\r\n        mode: 'index',\r\n        intersect: false,\r\n      },\r\n      scales: {\r\n        x: {\r\n          grid: { color: 'rgba(28,39,67,0.08)', drawTicks: false },\r\n          ticks: { font: { size: 11 } },\r\n        },\r\n        y: {\r\n          grid: { color: 'rgba(28,39,67,0.08)' },\r\n          suggestedMin: 18,\r\n          suggestedMax: 30,\r\n          ticks: {\r\n            font: { size: 11 },\r\n            callback: (value) => `${value}¬∞C`,\r\n          },\r\n        },\r\n      },\r\n      plugins: {\r\n        legend: {\r\n          display: true,\r\n          position: 'bottom',\r\n          labels: {\r\n            boxWidth: 12,\r\n            padding: 15,\r\n            font: { size: 11 },\r\n          },\r\n        },\r\n        tooltip: {\r\n          backgroundColor: 'rgba(28, 39, 67, 0.95)',\r\n          titleFont: { size: 13 },\r\n          bodyFont: { size: 12 },\r\n          padding: 12,\r\n          callbacks: {\r\n            label: (context) => {\r\n              const label = context.dataset.label || '';\r\n              const value = context.parsed.y;\r\n              return `${label}: ${formatTemperature(value)}`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  LogHelper.log('[TEMPERATURE] Chart rendered with', shoppingSeries.length, 'shopping series');\r\n}\r\n\r\n// ============================================\r\n// SHOPPING LIST RENDERING\r\n// ============================================\r\n\r\nfunction renderShoppingList(shoppingSeries) {\r\n  const $list = document.getElementById('shoppingList');\r\n  if (!$list) return;\r\n\r\n  $list.innerHTML = '';\r\n\r\n  if (!shoppingSeries || shoppingSeries.length === 0) {\r\n    $list.innerHTML = `\r\n      <div class=\"empty-list\">\r\n        <span>Nenhum shopping com sensores de temperatura</span>\r\n      </div>\r\n    `;\r\n    return;\r\n  }\r\n\r\n  const ctx = self.ctx;\r\n  const target = Number(ctx.settings?.targetTemp ?? DEFAULT_SETTINGS.targetTemp);\r\n  const tol = Number(ctx.settings?.targetTol ?? DEFAULT_SETTINGS.targetTol);\r\n\r\n  shoppingSeries.forEach((shopping) => {\r\n    const status = getTemperatureStatus(shopping.avgTemp, target, tol);\r\n    const statusLabels = {\r\n      normal: 'Normal',\r\n      cold: 'Frio',\r\n      hot: 'Quente',\r\n      no_info: 'Sem Dados',\r\n    };\r\n\r\n    const row = document.createElement('div');\r\n    row.className = `shopping-row status-${status}`;\r\n    row.innerHTML = `\r\n      <div class=\"shopping-left\">\r\n        <span class=\"dot ${status}\"></span>\r\n        <div>\r\n          <div class=\"shopping-name\">${shopping.label}</div>\r\n          <div class=\"shopping-sensors\">${shopping.sensorCount || 0} sensores</div>\r\n        </div>\r\n      </div>\r\n      <div class=\"ft\">\r\n        <div class=\"label\">Temp. Media</div>\r\n        <div class=\"value\">${formatTemperature(shopping.avgTemp)}</div>\r\n      </div>\r\n      <div class=\"ft\">\r\n        <div class=\"label\">Min / Max</div>\r\n        <div class=\"value\">${formatTemperature(shopping.minTemp)} / ${formatTemperature(\r\n      shopping.maxTemp\r\n    )}</div>\r\n      </div>\r\n      <div class=\"ft\">\r\n        <div class=\"label\">Status</div>\r\n        <div class=\"value status-badge ${status}\">${statusLabels[status]}</div>\r\n      </div>\r\n      <button class=\"shopping-action\" title=\"Ver detalhes\" aria-label=\"Ver detalhes\">\r\n        <svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\">\r\n          <path d=\"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z\"/>\r\n        </svg>\r\n      </button>\r\n    `;\r\n\r\n    // Add click handler for details\r\n    row.querySelector('.shopping-action').addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      openShoppingTemperatureModal(shopping);\r\n    });\r\n\r\n    row.addEventListener('click', () => {\r\n      openShoppingTemperatureModal(shopping);\r\n    });\r\n\r\n    $list.appendChild(row);\r\n  });\r\n\r\n  LogHelper.log('[TEMPERATURE] Shopping list rendered with', shoppingSeries.length, 'items');\r\n}\r\n\r\nasync function openShoppingTemperatureModal(shopping) {\r\n  LogHelper.log('[TEMPERATURE] Opening modal for shopping:', shopping.label);\r\n\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.openTemperatureComparisonModal) {\r\n    const token = localStorage.getItem('jwt_token');\r\n    if (!token) {\r\n      LogHelper.error('[TEMPERATURE] JWT token not found');\r\n      return;\r\n    }\r\n\r\n    // Get sensors for this shopping\r\n    const shoppingSensors = STATE.allSensors.filter((s) => s.customerId === shopping.customerId);\r\n\r\n    const devices = shoppingSensors.map((sensor) => ({\r\n      id: sensor.id,\r\n      label: sensor.label || sensor.name,\r\n      customerName: shopping.label,\r\n      temperatureMin: sensor.temperatureMin || 18,\r\n      temperatureMax: sensor.temperatureMax || 26,\r\n    }));\r\n\r\n    if (devices.length === 0) {\r\n      window.alert(`Nenhum sensor encontrado para ${shopping.label}`);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const dateRange = window.myioDateRange || {};\r\n      const now = new Date();\r\n      const startDate = dateRange.startDate || new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();\r\n      const endDate = dateRange.endDate || now.toISOString();\r\n\r\n      await MyIOLibrary.openTemperatureComparisonModal({\r\n        token: token,\r\n        devices: devices,\r\n        startDate: startDate,\r\n        endDate: endDate,\r\n        locale: 'pt-BR',\r\n        theme: 'dark',\r\n        onClose: () => {\r\n          LogHelper.log('[TEMPERATURE] Shopping temperature modal closed');\r\n        },\r\n      });\r\n    } catch (error) {\r\n      LogHelper.error('[TEMPERATURE] Error opening temperature modal:', error);\r\n    }\r\n  } else {\r\n    LogHelper.warn('[TEMPERATURE] openTemperatureComparisonModal not available');\r\n    window.alert('Modal de temperatura n√£o dispon√≠vel');\r\n  }\r\n}\r\n\r\n// ============================================\r\n// DATA AGGREGATION\r\n// ============================================\r\n\r\nfunction aggregateByShoppingCenter(sensors) {\r\n  const shoppingMap = new Map();\r\n\r\n  sensors.forEach((sensor) => {\r\n    const customerId = sensor.customerId || 'unknown';\r\n    const customerName = sensor.customerName || 'Desconhecido';\r\n\r\n    if (!shoppingMap.has(customerId)) {\r\n      shoppingMap.set(customerId, {\r\n        customerId,\r\n        label: customerName,\r\n        sensors: [],\r\n        temperatures: [],\r\n        avgTemp: null,\r\n        minTemp: null,\r\n        maxTemp: null,\r\n        sensorCount: 0,\r\n        lastUpdate: 0,\r\n        data: [],\r\n      });\r\n    }\r\n\r\n    const shopping = shoppingMap.get(customerId);\r\n    shopping.sensors.push(sensor);\r\n\r\n    if (sensor.temperature !== null && sensor.temperature !== undefined && !isNaN(sensor.temperature)) {\r\n      shopping.temperatures.push(Number(sensor.temperature));\r\n      shopping.lastUpdate = Math.max(shopping.lastUpdate, sensor.lastUpdate || 0);\r\n    }\r\n  });\r\n\r\n  // Calculate aggregates\r\n  const result = Array.from(shoppingMap.values()).map((shopping) => {\r\n    const temps = shopping.temperatures;\r\n    if (temps.length > 0) {\r\n      shopping.avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;\r\n      shopping.minTemp = Math.min(...temps);\r\n      shopping.maxTemp = Math.max(...temps);\r\n    }\r\n    shopping.sensorCount = shopping.sensors.length;\r\n\r\n    // Generate mock time series data for chart (in production, this would come from API)\r\n    const hours = ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'];\r\n    shopping.data = hours.map((t) => ({\r\n      t,\r\n      v: shopping.avgTemp !== null ? shopping.avgTemp + (Math.random() - 0.5) * 2 : null,\r\n    }));\r\n\r\n    return shopping;\r\n  });\r\n\r\n  // Sort by average temperature descending\r\n  result.sort((a, b) => (b.avgTemp || 0) - (a.avgTemp || 0));\r\n\r\n  return result;\r\n}\r\n\r\n// ============================================\r\n// DATA FETCHING\r\n// ============================================\r\n\r\nasync function fetchTemperatureData() {\r\n  LogHelper.log('[TEMPERATURE] Fetching temperature data...');\r\n  STATE.isLoading = true;\r\n  showLoadingOverlay(true);\r\n\r\n  try {\r\n    const ctx = self.ctx;\r\n    const useDemo = !!ctx.settings?.useDemoData;\r\n\r\n    if (useDemo) {\r\n      const demoData = makeDemo();\r\n      return demoData;\r\n    }\r\n\r\n    // RFC-0100: Try to get data from orchestrator first\r\n    const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n    if (orchestrator && typeof orchestrator.getTemperatureCache === 'function') {\r\n      const tempCache = orchestrator.getTemperatureCache();\r\n      if (tempCache && tempCache.allShoppingsData && tempCache.allShoppingsData.length > 0) {\r\n        LogHelper.log('[TEMPERATURE] Using data from orchestrator:', tempCache.allShoppingsData.length, 'shoppings');\r\n\r\n        // Transform orchestrator data to shoppingSeries format\r\n        const shoppingSeries = tempCache.allShoppingsData.map((shop) => ({\r\n          label: shop.name,\r\n          shoppingId: shop.customerId,\r\n          shoppingName: shop.name,\r\n          avgTemp: shop.avg,\r\n          sensorCount: shop.deviceCount || 0,\r\n          data: [], // Historical data not available from orchestrator yet\r\n        }));\r\n\r\n        STATE.allSensors = tempCache.devices || [];\r\n        STATE.shoppingData = shoppingSeries;\r\n        STATE.orchestratorData = tempCache;\r\n\r\n        return {\r\n          shoppingSeries,\r\n          globalAvgTemp: tempCache.globalAvg || tempCache.filteredAvg,\r\n          totalSensors: tempCache.devices?.length || 0,\r\n          shoppingsOnline: shoppingSeries.length,\r\n          alertCount: tempCache.shoppingsOutOfRange?.length || 0,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Fallback: Collect sensors from ctx.data\r\n    const sensors = [];\r\n    if (ctx && ctx.data) {\r\n      ctx.data.forEach((data) => {\r\n        if (data.datasource && data.datasource.aliasName !== 'Shopping') {\r\n          const entityId = data.datasource.entity?.id?.id;\r\n          const keyName = data.dataKey?.name;\r\n\r\n          if (entityId && keyName === 'temperature') {\r\n            const existingSensor = sensors.find((s) => s.id === entityId);\r\n            if (!existingSensor) {\r\n              sensors.push({\r\n                id: entityId,\r\n                name: data.datasource.name,\r\n                label: data.datasource.entityLabel || data.datasource.name,\r\n                temperature: data.data?.[0]?.[1] || null,\r\n                lastUpdate: data.data?.[0]?.[0] || null,\r\n                customerId: data.datasource.customerId || null,\r\n                customerName: data.datasource.customerName || 'N/A',\r\n                temperatureMin: 18,\r\n                temperatureMax: 26,\r\n              });\r\n            } else {\r\n              existingSensor.temperature = data.data?.[0]?.[1] || existingSensor.temperature;\r\n              existingSensor.lastUpdate = data.data?.[0]?.[0] || existingSensor.lastUpdate;\r\n            }\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    STATE.allSensors = sensors;\r\n\r\n    // Filter by selected shoppings\r\n    let filteredSensors = sensors;\r\n    if (STATE.selectedShoppingIds && STATE.selectedShoppingIds.length > 0) {\r\n      filteredSensors = sensors.filter((s) => STATE.selectedShoppingIds.includes(s.customerId));\r\n    }\r\n\r\n    // Aggregate by shopping center\r\n    const shoppingSeries = aggregateByShoppingCenter(filteredSensors);\r\n\r\n    // Calculate global KPIs\r\n    const allTemps = filteredSensors\r\n      .filter((s) => s.temperature !== null && !isNaN(s.temperature))\r\n      .map((s) => Number(s.temperature));\r\n\r\n    const globalAvgTemp = allTemps.length > 0 ? allTemps.reduce((a, b) => a + b, 0) / allTemps.length : null;\r\n\r\n    const ctx2 = self.ctx;\r\n    const target = Number(ctx2.settings?.targetTemp ?? DEFAULT_SETTINGS.targetTemp);\r\n    const tol = Number(ctx2.settings?.targetTol ?? DEFAULT_SETTINGS.targetTol);\r\n\r\n    const alertCount = shoppingSeries.filter((s) => {\r\n      const status = getTemperatureStatus(s.avgTemp, target, tol);\r\n      return status === 'hot' || status === 'cold';\r\n    }).length;\r\n\r\n    return {\r\n      shoppingSeries,\r\n      globalAvgTemp,\r\n      totalSensors: filteredSensors.length,\r\n      shoppingsOnline: shoppingSeries.filter((s) => s.sensorCount > 0).length,\r\n      alertCount,\r\n    };\r\n  } catch (error) {\r\n    LogHelper.error('[TEMPERATURE] Error fetching data:', error);\r\n    return makeDemo();\r\n  } finally {\r\n    STATE.isLoading = false;\r\n    showLoadingOverlay(false);\r\n  }\r\n}\r\n\r\n// ============================================\r\n// MAIN UPDATE FUNCTION\r\n// ============================================\r\n\r\nasync function updateAll() {\r\n  const data = await fetchTemperatureData();\r\n\r\n  if (!data) {\r\n    LogHelper.warn('[TEMPERATURE] No data available, using demo');\r\n    const demo = makeDemo();\r\n    renderComparisonChart(demo.shoppingSeries);\r\n    setKpis(demo);\r\n    renderShoppingList(demo.shoppingSeries);\r\n    return;\r\n  }\r\n\r\n  STATE.shoppingData = data.shoppingSeries;\r\n  renderComparisonChart(data.shoppingSeries);\r\n  setKpis(data);\r\n  renderShoppingList(data.shoppingSeries);\r\n}\r\n\r\n// ============================================\r\n// RFC-0098: TEMPERATURE 7-DAY CHART FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * RFC-0098: Fetch real temperature day averages via orchestrator\r\n * Returns structured data with per-shopping breakdown\r\n */\r\nasync function fetch7DaysTemperature(period = 7) {\r\n  LogHelper.log('[TEMPERATURE] [RFC-0098] Fetching real temperature data for', period, 'days');\r\n\r\n  // Calculate time range\r\n  const now = new Date();\r\n  const endTs = now.getTime();\r\n  const startTs = endTs - period * 24 * 60 * 60 * 1000;\r\n\r\n  // Try to get data from orchestrator\r\n  const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n  if (orchestrator && typeof orchestrator.fetchTemperatureDayAverages === 'function') {\r\n    try {\r\n      const data = await orchestrator.fetchTemperatureDayAverages(startTs, endTs);\r\n      if (data && data.labels && data.labels.length > 0) {\r\n        LogHelper.log('[TEMPERATURE] [RFC-0098] Got real data from orchestrator:', data.labels.length, 'days');\r\n        return data;\r\n      }\r\n    } catch (err) {\r\n      LogHelper.error('[TEMPERATURE] [RFC-0098] Error fetching from orchestrator:', err);\r\n    }\r\n  }\r\n\r\n  // Fallback: Generate empty structure with date labels\r\n  LogHelper.warn('[TEMPERATURE] [RFC-0098] Orchestrator not available, using empty data');\r\n  const labels = [];\r\n  for (let i = period - 1; i >= 0; i--) {\r\n    const dayDate = new Date(now);\r\n    dayDate.setDate(now.getDate() - i);\r\n    labels.push(dayDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));\r\n  }\r\n\r\n  return {\r\n    labels,\r\n    dailyTotals: new Array(period).fill(null),\r\n    shoppingData: {},\r\n    shoppingNames: {},\r\n    fetchTimestamp: Date.now(),\r\n  };\r\n}\r\n\r\n/**\r\n * RFC-0098: Data fetching adapter for the standardized Consumption7DaysChart component\r\n */\r\nasync function fetchTemperatureDataAdapter(period) {\r\n  LogHelper.log('[TEMPERATURE] [RFC-0098] Fetching data via adapter for', period, 'days');\r\n\r\n  // Update chartConfig period\r\n  chartConfig.period = period;\r\n\r\n  // Fetch temperature data\r\n  const data = await fetch7DaysTemperature(period);\r\n\r\n  return {\r\n    labels: data.labels || [],\r\n    dailyTotals: data.dailyTotals || [],\r\n    shoppingData: data.shoppingData || {},\r\n    shoppingNames: data.shoppingNames || {},\r\n    fetchTimestamp: Date.now(),\r\n  };\r\n}\r\n\r\n/**\r\n * RFC-0098: Initialize the 7-day temperature chart using the standardized component\r\n */\r\nasync function initializeTemperature7DaysChart() {\r\n  // RFC-0098: Check for createConsumptionChartWidget first (it creates its own canvas)\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.createConsumptionChartWidget) {\r\n    LogHelper.log('[TEMPERATURE] [RFC-0098] Using createConsumptionChartWidget component');\r\n\r\n    // Get widget container for ThingsBoard compatibility\r\n    const $container = self.ctx?.$container || null;\r\n\r\n    // Check if container exists (either via $container or document)\r\n    const containerId = 'temperature-chart-widget';\r\n    const containerEl = $container\r\n      ? $container[0]?.querySelector?.(`#${containerId}`) || $container.find?.(`#${containerId}`)?.[0]\r\n      : document.getElementById(containerId);\r\n\r\n    if (!containerEl) {\r\n      LogHelper.warn('[TEMPERATURE] [RFC-0098] Container temperature-chart-widget not found');\r\n      return;\r\n    }\r\n\r\n    // Get customer attributes for ideal range\r\n    const ctx = self.ctx;\r\n    const minTemp = Number(ctx.settings?.minTemperature ?? 20);\r\n    const maxTemp = Number(ctx.settings?.maxTemperature ?? 24);\r\n\r\n    consumptionChartInstance = MyIOLibrary.createConsumptionChartWidget({\r\n      domain: 'temperature',\r\n      containerId: 'temperature-chart-widget',\r\n      title: 'Temperatura - 7 dias',\r\n      unit: '¬∞C',\r\n      decimalPlaces: 1,\r\n      chartHeight: 280,\r\n      defaultPeriod: chartConfig.period || 7,\r\n      defaultChartType: chartConfig.chartType || 'line',\r\n      defaultVizMode: chartConfig.vizMode || 'total',\r\n      theme: 'light',\r\n      $container: $container,\r\n\r\n      // Ideal range from customer attributes\r\n      idealRange:\r\n        minTemp > 0 || maxTemp > 0\r\n          ? {\r\n              min: minTemp,\r\n              max: maxTemp,\r\n              color: 'rgba(34, 197, 94, 0.15)',\r\n              borderColor: 'rgba(34, 197, 94, 0.4)',\r\n              label: 'Faixa Ideal',\r\n              enabled: true,\r\n            }\r\n          : null,\r\n\r\n      // Data fetching via adapter\r\n      fetchData: fetchTemperatureDataAdapter,\r\n\r\n      // Callbacks\r\n      onDataLoaded: (data) => {\r\n        cachedChartData = data;\r\n        LogHelper.log('[TEMPERATURE] [RFC-0098] Data loaded:', data.labels?.length, 'days');\r\n      },\r\n      onError: (error) => {\r\n        LogHelper.error('[TEMPERATURE] [RFC-0098] Chart error:', error);\r\n      },\r\n    });\r\n\r\n    // Render the chart\r\n    await consumptionChartInstance.render();\r\n    LogHelper.log('[TEMPERATURE] [RFC-0098] Temperature 7-day chart rendered successfully');\r\n    return;\r\n  }\r\n\r\n  // Fallback: Legacy initialization (simplified)\r\n  LogHelper.warn('[TEMPERATURE] [RFC-0098] createConsumptionChartWidget not available');\r\n}\r\n\r\n/**\r\n * RFC-0098: Setup chart tab handlers for temperature 7-day chart\r\n * NOTE: The createConsumptionChartWidget component now handles tabs internally.\r\n * This function is kept for backwards compatibility with external tabs if present.\r\n */\r\nfunction setupTemperatureChartTabs() {\r\n  // RFC-0098: The widget component injects its own tabs, so external tabs may not exist\r\n  const vizTabs = document.querySelectorAll('.viz-mode-tabs .chart-tab');\r\n  const typeTabs = document.querySelectorAll('.chart-type-tabs .chart-tab');\r\n\r\n  if (vizTabs.length === 0 && typeTabs.length === 0) {\r\n    LogHelper.log('[TEMPERATURE] [RFC-0098] No external tabs found - widget handles tabs internally');\r\n    return;\r\n  }\r\n\r\n  // Setup external vizMode tabs (if present)\r\n  vizTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      vizTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newVizMode = tab.dataset.viz;\r\n      chartConfig.vizMode = newVizMode;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setVizMode === 'function') {\r\n        consumptionChartInstance.setVizMode(newVizMode);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Setup external chartType tabs (if present)\r\n  typeTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      typeTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newChartType = tab.dataset.type;\r\n      chartConfig.chartType = newChartType;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setChartType === 'function') {\r\n        consumptionChartInstance.setChartType(newChartType);\r\n      }\r\n    });\r\n  });\r\n\r\n  LogHelper.log('[TEMPERATURE] [RFC-0098] External tab handlers setup (if present)');\r\n}\r\n\r\n// ============================================\r\n// EVENT HANDLERS\r\n// ============================================\r\n\r\nfunction bindEventListeners() {\r\n  // Listen for shopping filter events\r\n  self._onFilterApplied = (ev) => {\r\n    LogHelper.log('[TEMPERATURE] heard myio:filter-applied:', ev.detail);\r\n\r\n    const selection = ev.detail?.selection || [];\r\n    const shoppingIds = selection.map((s) => s.value).filter((v) => v);\r\n\r\n    STATE.selectedShoppingIds = shoppingIds;\r\n    updateAll();\r\n  };\r\n  window.addEventListener('myio:filter-applied', self._onFilterApplied);\r\n\r\n  // Listen for date range updates\r\n  self._onDateUpdate = (ev) => {\r\n    LogHelper.log('[TEMPERATURE] heard myio:update-date:', ev.detail);\r\n\r\n    STATE.dateRange.start = ev.detail?.startDate;\r\n    STATE.dateRange.end = ev.detail?.endDate;\r\n    updateAll();\r\n  };\r\n  window.addEventListener('myio:update-date', self._onDateUpdate);\r\n\r\n  // RFC-0100: Listen for temperature data from MAIN orchestrator\r\n  self._onTemperatureDataReady = (ev) => {\r\n    LogHelper.log('[TEMPERATURE] RFC-0100: Received myio:temperature-data-ready:', ev.detail);\r\n    const data = ev.detail;\r\n    if (data && data.allShoppingsData) {\r\n      // Store data in STATE for use by chart and other components\r\n      STATE.orchestratorData = data;\r\n\r\n      // Transform orchestrator data to shoppingSeries format\r\n      const shoppingSeries = data.allShoppingsData.map((shop) => ({\r\n        label: shop.name,\r\n        shoppingId: shop.customerId,\r\n        shoppingName: shop.name,\r\n        avgTemp: shop.avg,\r\n        sensorCount: shop.deviceCount || 0,\r\n        data: [], // Historical data not available from orchestrator yet\r\n      }));\r\n\r\n      STATE.shoppingData = shoppingSeries;\r\n      STATE.allSensors = data.devices || [];\r\n\r\n      // Update comparison chart with real data\r\n      renderComparisonChart(shoppingSeries);\r\n      setKpis({\r\n        globalAvgTemp: data.globalAvg || data.filteredAvg,\r\n        totalSensors: data.devices?.length || 0,\r\n        shoppingsOnline: shoppingSeries.length,\r\n        alertCount: data.shoppingsOutOfRange?.length || 0,\r\n      });\r\n      renderShoppingList(shoppingSeries);\r\n    }\r\n  };\r\n  window.addEventListener('myio:temperature-data-ready', self._onTemperatureDataReady);\r\n}\r\n\r\n// ============================================\r\n// WIDGET LIFECYCLE\r\n// ============================================\r\n\r\nself.onInit = function () {\r\n  LogHelper.log('[TEMPERATURE] RFC-0092: onInit');\r\n  const ctx = self.ctx;\r\n\r\n  // Set target temp display\r\n  const $avgTempTarget = document.getElementById('avgTempTarget');\r\n  if ($avgTempTarget) {\r\n    const target = Number(ctx.settings?.targetTemp ?? DEFAULT_SETTINGS.targetTemp);\r\n    const tol = Number(ctx.settings?.targetTol ?? DEFAULT_SETTINGS.targetTol);\r\n    $avgTempTarget.textContent = `Meta: ${target}¬∞C +/- ${tol}¬∞C`;\r\n  }\r\n\r\n  // Bind event listeners\r\n  bindEventListeners();\r\n\r\n  // RFC-0098: Setup tab handlers for 7-day chart\r\n  setupTemperatureChartTabs();\r\n\r\n  // RFC-0098: Initialize 7-day temperature chart (async)\r\n  setTimeout(() => {\r\n    initializeTemperature7DaysChart();\r\n  }, 500);\r\n\r\n  // Initial render\r\n  updateAll();\r\n\r\n  // RFC-0100: Request temperature data from MAIN orchestrator\r\n  // The data will arrive via myio:temperature-data-ready event\r\n  setTimeout(() => {\r\n    const dateRange = window.myioGlobalDates || {};\r\n    const startTs = dateRange.startMs || Date.now() - 7 * 24 * 60 * 60 * 1000;\r\n    const endTs = dateRange.endMs || Date.now();\r\n\r\n    window.dispatchEvent(\r\n      new CustomEvent('myio:request-temperature-data', {\r\n        detail: { startTs, endTs },\r\n      })\r\n    );\r\n    LogHelper.log('[TEMPERATURE] RFC-0100: Requested temperature data from MAIN');\r\n  }, 100);\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  LogHelper.log('[TEMPERATURE] onDataUpdated');\r\n  updateAll();\r\n};\r\n\r\nself.onResize = function () {\r\n  // Chart.js handles resize automatically\r\n  if (STATE.chartInstance) {\r\n    STATE.chartInstance.resize();\r\n  }\r\n};\r\n\r\nself.onDestroy = function () {\r\n  // RFC-0098: Cleanup 7-day consumption chart instance\r\n  if (consumptionChartInstance && typeof consumptionChartInstance.destroy === 'function') {\r\n    LogHelper.log('[TEMPERATURE] [RFC-0098] Destroying consumption chart instance');\r\n    consumptionChartInstance.destroy();\r\n    consumptionChartInstance = null;\r\n  }\r\n\r\n  // Cleanup comparison chart\r\n  if (STATE.chartInstance) {\r\n    STATE.chartInstance.destroy();\r\n    STATE.chartInstance = null;\r\n  }\r\n\r\n  // Remove event listeners\r\n  if (self._onFilterApplied) {\r\n    window.removeEventListener('myio:filter-applied', self._onFilterApplied);\r\n  }\r\n  if (self._onDateUpdate) {\r\n    window.removeEventListener('myio:update-date', self._onDateUpdate);\r\n  }\r\n  if (self._onTemperatureDataReady) {\r\n    window.removeEventListener('myio:temperature-data-ready', self._onTemperatureDataReady);\r\n  }\r\n\r\n  LogHelper.log('[TEMPERATURE] Widget destroyed');\r\n};\r\n",
      "settingsSchema": "{}",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - TEMPERATURE - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "990976a0-c97b-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}