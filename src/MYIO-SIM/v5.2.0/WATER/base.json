{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_water_v_5_2_0",
    "name": "Widget Head Office - WATER - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://unpkg.com/myio-js-library@latest/dist/myio-js-library.umd.min.js"
        },
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
        },
        {
          "url": "https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
        }
      ],
      "templateHtml": "<div class=\"water-dashboard\">\r\n  <div class=\"toolbar-zoom\">\r\n    <div class=\"shopping-filter-chips\" id=\"waterShoppingFilterChips\"></div>\r\n    <button id=\"fontMinus\" aria-label=\"Diminuir fonte\">−</button>\r\n    <button id=\"fontPlus\" aria-label=\"Aumentar fonte\">＋</button>\r\n  </div>\r\n  <!-- Header -->\r\n  <h2 class=\"title\">Gestão de Água</h2>\r\n  <p class=\"subtitle\">Monitoramento de consumo e métricas de eficiência hídrica</p>\r\n\r\n  <!-- Cards -->\r\n  <div class=\"cards\">\r\n    <!-- Consumo Total de Lojas -->\r\n    <div class=\"card\" id=\"total-consumption-stores-card\">\r\n      <p class=\"label\">Consumo Total Lojas</p>\r\n      <h3 class=\"value\" id=\"total-consumption-stores-value\">\r\n        <svg\r\n          class=\"loading-spinner\"\r\n          style=\"width: 24px; height: 24px; animation: spin 1s linear infinite\"\r\n          viewBox=\"0 0 50 50\"\r\n        >\r\n          <circle\r\n            cx=\"25\"\r\n            cy=\"25\"\r\n            r=\"20\"\r\n            fill=\"none\"\r\n            stroke=\"#0288d1\"\r\n            stroke-width=\"5\"\r\n            stroke-linecap=\"round\"\r\n            stroke-dasharray=\"90,150\"\r\n            stroke-dashoffset=\"0\"\r\n          ></circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"total-consumption-stores-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"total-consumption-stores-info\">Hidrômetros de lojas</span>\r\n    </div>\r\n\r\n    <!-- Consumo Total de Área Comum -->\r\n    <div class=\"card\" id=\"total-consumption-common-area-card\">\r\n      <p class=\"label\">Consumo Total Área Comum</p>\r\n      <h3 class=\"value\" id=\"total-consumption-common-area-value\">\r\n        <svg\r\n          class=\"loading-spinner\"\r\n          style=\"width: 24px; height: 24px; animation: spin 1s linear infinite\"\r\n          viewBox=\"0 0 50 50\"\r\n        >\r\n          <circle\r\n            cx=\"25\"\r\n            cy=\"25\"\r\n            r=\"20\"\r\n            fill=\"none\"\r\n            stroke=\"#0288d1\"\r\n            stroke-width=\"5\"\r\n            stroke-linecap=\"round\"\r\n            stroke-dasharray=\"90,150\"\r\n            stroke-dashoffset=\"0\"\r\n          ></circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"total-consumption-common-area-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"total-consumption-common-area-info\">Hidrômetros de áreas comuns</span>\r\n    </div>\r\n\r\n    <!-- Consumo Total Geral -->\r\n    <div class=\"card highlight\" id=\"total-consumption-card\">\r\n      <p class=\"label\">Consumo Total</p>\r\n      <h3 class=\"value\" id=\"total-consumption-value\">\r\n        <svg\r\n          class=\"loading-spinner\"\r\n          style=\"width: 24px; height: 24px; animation: spin 1s linear infinite\"\r\n          viewBox=\"0 0 50 50\"\r\n        >\r\n          <circle\r\n            cx=\"25\"\r\n            cy=\"25\"\r\n            r=\"20\"\r\n            fill=\"none\"\r\n            stroke=\"#0288d1\"\r\n            stroke-width=\"5\"\r\n            stroke-linecap=\"round\"\r\n            stroke-dasharray=\"90,150\"\r\n            stroke-dashoffset=\"0\"\r\n          ></circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"total-consumption-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"total-consumption-info\">Lojas + Área Comum</span>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Charts -->\r\n  <div class=\"charts\">\r\n    <!-- RFC-0098: Container for createConsumptionChartWidget (widget injects its own HTML) -->\r\n    <div id=\"water-chart-widget\" class=\"chart-box chart-box-water\"></div>\r\n\r\n    <!-- RFC-0102: Container for createDistributionChartWidget (widget injects its own HTML) -->\r\n    <div id=\"water-distribution-widget\" class=\"chart-box chart-box-water\"></div>\r\n  </div>\r\n  <br />\r\n</div>\r\n",
      "templateCss": "/* ============================================ */\r\n/* WATER WIDGET - RFC-0087                     */\r\n/* Based on ENERGY widget structure            */\r\n/* ============================================ */\r\n\r\n.water-dashboard {\r\n  font-family: 'Inter', sans-serif;\r\n  color: #0c4a6e;\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  box-sizing: border-box;\r\n\r\n  /* Same as ENERGY widget */\r\n  width: 100%;\r\n  height: 100%;\r\n  overflow: auto;\r\n\r\n  /* Espaçamento */\r\n  padding: 20px;\r\n  padding-bottom: 80px;\r\n\r\n  /* Water theme background */\r\n  background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%);\r\n}\r\n\r\n.title {\r\n  margin: 0;\r\n  font-size: 22px;\r\n  font-weight: 600;\r\n  color: #0c4a6e;\r\n}\r\n\r\n.subtitle {\r\n  margin: 0 0 20px;\r\n  color: #64748b;\r\n  font-size: 14px;\r\n}\r\n\r\n.cards {\r\n  display: flex;\r\n  gap: 16px;\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.card {\r\n  flex: 1;\r\n  background: linear-gradient(180deg, #ffffff 0%, #f0f9ff 100%);\r\n  border: 1px solid #bae6fd;\r\n  border-radius: 12px;\r\n  padding: 16px;\r\n  box-shadow: 0 4px 12px rgba(2, 136, 209, 0.08);\r\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\r\n}\r\n\r\n.card:hover {\r\n  transform: translateY(-2px);\r\n  box-shadow: 0 8px 20px rgba(2, 136, 209, 0.12);\r\n}\r\n\r\n.card.highlight {\r\n  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);\r\n  border: 2px solid #0288d1;\r\n}\r\n\r\n.card.highlight .value {\r\n  color: #0284c7;\r\n}\r\n\r\n.label {\r\n  font-size: 13px;\r\n  color: #64748b;\r\n  margin: 0 0 4px 0;\r\n}\r\n\r\n.value {\r\n  font-size: 22px;\r\n  font-weight: 700;\r\n  margin: 4px 0;\r\n  color: #0c4a6e;\r\n}\r\n\r\n.trend {\r\n  font-size: 12px;\r\n}\r\n\r\n.trend.up {\r\n  color: #dc2626;\r\n} /* Red for increase (bad) */\r\n.trend.down {\r\n  color: #16a34a;\r\n} /* Green for decrease (good) */\r\n.trend.neutral {\r\n  color: #64748b;\r\n} /* Gray for no change */\r\n\r\n.progress-bar {\r\n  background: #e0f2fe;\r\n  height: 8px;\r\n  border-radius: 6px;\r\n  margin: 6px 0;\r\n}\r\n\r\n.progress {\r\n  background: #0288d1;\r\n  height: 100%;\r\n  border-radius: 6px;\r\n}\r\n\r\n.meta {\r\n  font-size: 12px;\r\n  color: #64748b;\r\n}\r\n\r\n/* Charts grid */\r\n.charts {\r\n  display: grid;\r\n  grid-template-columns: minmax(400px, 1fr) minmax(350px, 1fr);\r\n  gap: 16px;\r\n  margin-bottom: 100px !important;\r\n  width: 100%;\r\n  position: relative;\r\n  min-height: 500px !important;\r\n  height: auto !important;\r\n  overflow: visible !important;\r\n}\r\n\r\n/* Responsive: Stack vertically on smaller screens */\r\n@media (max-width: 1200px) {\r\n  .charts {\r\n    grid-template-columns: 1fr;\r\n    margin-bottom: 120px !important;\r\n    min-height: 900px !important;\r\n  }\r\n}\r\n\r\n.chart-box {\r\n  background: #fff;\r\n  border: 1px solid #bae6fd;\r\n  border-radius: 12px;\r\n  padding: 16px;\r\n  min-width: 0;\r\n  min-height: 380px !important; /* FIX: Same as ENERGY */\r\n  height: auto;\r\n  display: flex;\r\n  flex-direction: column;\r\n  position: relative;\r\n  box-shadow: 0 4px 12px rgba(2, 136, 209, 0.06);\r\n}\r\n\r\n.chart-box canvas {\r\n  flex: 1;\r\n  min-height: 250px !important;\r\n  max-height: 300px !important; /* FIX: Prevent infinite growth (same as ENERGY) */\r\n  width: 100% !important;\r\n  height: 300px !important;\r\n}\r\n\r\n.chart-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 12px;\r\n  gap: 12px;\r\n}\r\n\r\n.chart-header h4 {\r\n  margin: 0;\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  color: #0c4a6e;\r\n}\r\n\r\n.chart-controls {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.control-label {\r\n  font-size: 13px;\r\n  color: #64748b;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chart-select {\r\n  padding: 6px 12px;\r\n  border: 1px solid #7dd3fc;\r\n  border-radius: 8px;\r\n  background: #fff;\r\n  font-size: 13px;\r\n  color: #0c4a6e;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n  outline: none;\r\n}\r\n\r\n.chart-select:hover {\r\n  border-color: #0288d1;\r\n}\r\n\r\n.chart-select:focus {\r\n  border-color: #0288d1;\r\n  box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.15);\r\n}\r\n\r\n/* Configuration button */\r\n.config-btn {\r\n  padding: 6px 12px;\r\n  border: 1px solid #7dd3fc;\r\n  border-radius: 8px;\r\n  background: #fff;\r\n  font-size: 16px;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n  outline: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.config-btn:hover {\r\n  border-color: #0288d1;\r\n  background: #f0f9ff;\r\n}\r\n\r\n.config-btn:focus {\r\n  border-color: #0288d1;\r\n  box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.15);\r\n}\r\n\r\n/* ====== CONTROLES DE ZOOM ====== */\r\n.toolbar-zoom {\r\n  position: sticky;\r\n  top: 6px;\r\n  z-index: 2;\r\n  display: flex;\r\n  gap: 6px;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n/* ====== SHOPPING FILTER CHIPS ====== */\r\n.shopping-filter-chips {\r\n  display: flex;\r\n  gap: 6px;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n  flex: 1;\r\n  margin-right: 12px;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);\r\n  border: 1px solid #7dd3fc;\r\n  border-radius: 8px;\r\n  padding: 3px 8px;\r\n  font-size: 12px;\r\n  color: #0c4a6e;\r\n  font-weight: 500;\r\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\r\n  white-space: nowrap;\r\n}\r\n\r\n.shopping-filter-chips .filter-chip-icon {\r\n  font-size: 10px;\r\n  opacity: 0.7;\r\n}\r\n\r\n.toolbar-zoom button {\r\n  border: 1px solid #bae6fd;\r\n  background: #fff;\r\n  border-radius: 10px;\r\n  padding: 4px 10px;\r\n  font-size: 16px;\r\n  color: #0c4a6e;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(2, 136, 209, 0.08);\r\n}\r\n\r\n.toolbar-zoom button:hover {\r\n  background: #f0f9ff;\r\n  border-color: #0288d1;\r\n}\r\n\r\n/* Loading spinner */\r\n.loading-spinner {\r\n  display: inline-block;\r\n}\r\n\r\n.device-info {\r\n  display: block;\r\n  font-size: 11px;\r\n  color: #64748b;\r\n  margin-top: 4px;\r\n}\r\n\r\n@keyframes spin {\r\n  from {\r\n    transform: rotate(0deg);\r\n  }\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* ============================================ */\r\n/* RFC-0097: Chart TABs Styles                 */\r\n/* ============================================ */\r\n\r\n.chart-tabs {\r\n  display: inline-flex;\r\n  gap: 2px;\r\n  background: #f0f9ff;\r\n  border-radius: 8px;\r\n  padding: 2px;\r\n}\r\n\r\n.chart-tab {\r\n  padding: 4px 10px;\r\n  border: none;\r\n  background: transparent;\r\n  border-radius: 6px;\r\n  cursor: pointer;\r\n  font-size: 12px;\r\n  font-weight: 500;\r\n  color: #64748b;\r\n  transition: all 0.2s;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chart-tab:hover {\r\n  background: #e0f2fe;\r\n  color: #0c4a6e;\r\n}\r\n\r\n.chart-tab.active {\r\n  background: #0288d1;\r\n  color: #fff;\r\n  box-shadow: 0 1px 3px rgba(2, 136, 209, 0.3);\r\n}\r\n\r\n/* RFC-0097: Title group with settings icon */\r\n.chart-title-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.chart-title-group .config-btn {\r\n  order: -1; /* Icon before title */\r\n}\r\n\r\n/* RFC-0097: Maximize button */\r\n.maximize-btn {\r\n  background: transparent;\r\n  border: 1px solid #7dd3fc;\r\n  border-radius: 6px;\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n  font-size: 16px;\r\n  color: #0288d1;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.maximize-btn:hover {\r\n  background: #e0f2fe;\r\n  border-color: #0288d1;\r\n}\r\n\r\n/* RFC-0097: Loading overlay */\r\n.chart-loading-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(240, 249, 255, 0.9);\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 10;\r\n  border-radius: 12px;\r\n  gap: 12px;\r\n}\r\n\r\n.chart-loading-spinner {\r\n  width: 40px;\r\n  height: 40px;\r\n  border: 3px solid #bae6fd;\r\n  border-top-color: #0288d1;\r\n  border-radius: 50%;\r\n  animation: spin 1s linear infinite;\r\n}\r\n\r\n.chart-loading-overlay span {\r\n  color: #0c4a6e;\r\n  font-size: 14px;\r\n  font-weight: 500;\r\n}\r\n\r\n/* Responsive adjustments for chart controls */\r\n@media (max-width: 600px) {\r\n  .chart-header {\r\n    flex-direction: column;\r\n    align-items: flex-start;\r\n  }\r\n\r\n  .chart-controls {\r\n    flex-wrap: wrap;\r\n    justify-content: flex-start;\r\n    width: 100%;\r\n  }\r\n\r\n  .chart-tabs {\r\n    margin-bottom: 4px;\r\n  }\r\n}\r\n",
      "controllerScript": "/* global self, window, document, Chart, MyIOLibrary */\r\n// ============================================\r\n// MYIO-SIM 1.0.0 - WATER Widget Controller\r\n// RFC-0087: Water Consumption Dashboard\r\n// Based on ENERGY widget structure\r\n// ============================================\r\n\r\n// ============================================\r\n// CACHE CONFIGURATION\r\n// ============================================\r\n\r\nlet totalConsumptionCache = {\r\n  data: null,\r\n  storesTotal: 0,\r\n  commonAreaTotal: 0,\r\n  timestamp: null,\r\n};\r\n\r\nconst TOTAL_CONSUMPTION_CACHE_TTL = 5 * 60 * 1000; // 5 minutos\r\n\r\n// ============================================\r\n// RFC-0097: CHART CONFIGURATION STATE\r\n// ============================================\r\n\r\nconst chartConfig = {\r\n  period: 7, // days: 7, 14, 30, or 0 (custom)\r\n  startDate: null, // ISO string for custom period\r\n  endDate: null, // ISO string for custom period\r\n  granularity: '1d', // '1d' (day) or '1h' (hour)\r\n  vizMode: 'total', // 'total' or 'separate'\r\n  chartType: 'line', // 'line' or 'bar'\r\n};\r\n\r\n// RFC-0097: Cache for chart data (avoid re-fetch when switching vizMode/chartType)\r\nlet cachedChartData = null;\r\n\r\n// RFC-0097: Fullscreen state\r\nlet isChartFullscreen = false;\r\nlet fullscreenChartInstance = null;\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Verifica cache de consumo total\r\n */\r\nfunction getCachedTotalConsumption() {\r\n  if (!totalConsumptionCache.data) return null;\r\n\r\n  const age = Date.now() - totalConsumptionCache.timestamp;\r\n  if (age > TOTAL_CONSUMPTION_CACHE_TTL) {\r\n    console.log('[WATER] Total consumption cache expired');\r\n    return null;\r\n  }\r\n\r\n  console.log('[WATER] Using cached total consumption data');\r\n  return totalConsumptionCache.data;\r\n}\r\n\r\n/**\r\n * Armazena dados de consumo total no cache\r\n */\r\nfunction cacheTotalConsumption(storesTotal, commonAreaTotal, totalGeral) {\r\n  totalConsumptionCache = {\r\n    data: {\r\n      storesTotal,\r\n      commonAreaTotal,\r\n      totalGeral,\r\n    },\r\n    storesTotal,\r\n    commonAreaTotal,\r\n    timestamp: Date.now(),\r\n  };\r\n  console.log('[WATER] Total consumption data cached:', totalConsumptionCache.data);\r\n}\r\n\r\n/**\r\n * Formata volume de água em m³\r\n */\r\nfunction formatWaterVolume(value) {\r\n  if (value == null || isNaN(value)) return '- m³';\r\n  if (value >= 1000) {\r\n    return (value / 1000).toFixed(2).replace('.', ',') + 'k m³';\r\n  }\r\n  return value.toFixed(1).replace('.', ',') + ' m³';\r\n}\r\n\r\n// ============================================\r\n// WIDGET CONTAINER HELPER\r\n// ============================================\r\n\r\n/**\r\n * Gets element by ID within the widget container (not global document)\r\n * This is required for ThingsBoard widgets to work correctly\r\n */\r\nfunction $id(id) {\r\n  if (self.ctx && self.ctx.$container) {\r\n    return self.ctx.$container[0].querySelector(`#${id}`);\r\n  }\r\n  // Fallback to global document (should not happen in ThingsBoard context)\r\n  return document.getElementById(id);\r\n}\r\n\r\n// ============================================\r\n// UI UPDATE FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Renderiza a UI do card de consumo de LOJAS\r\n */\r\nfunction renderStoresConsumptionUI(data, valueEl, trendEl, infoEl) {\r\n  console.log('[WATER] renderStoresConsumptionUI called:', { data, hasValueEl: !!valueEl });\r\n  if (!data) {\r\n    console.log('[WATER] renderStoresConsumptionUI: data is null/undefined, returning');\r\n    return;\r\n  }\r\n\r\n  const totalGeral = data.totalGeral || 0;\r\n  const storesTotal = data.storesTotal || 0;\r\n  const storesPercentage = totalGeral > 0 ? (storesTotal / totalGeral) * 100 : 0;\r\n\r\n  if (valueEl) {\r\n    console.log('[WATER] Setting stores value to:', formatWaterVolume(storesTotal));\r\n    valueEl.textContent = formatWaterVolume(storesTotal);\r\n  } else {\r\n    console.log('[WATER] WARNING: valueEl is null for stores card!');\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = `${storesPercentage.toFixed(1)}% do total`;\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    infoEl.textContent = 'Hidrômetros de lojas';\r\n  }\r\n\r\n  console.log('[WATER] Card de Lojas atualizado:', { storesTotal, storesPercentage });\r\n}\r\n\r\n/**\r\n * Renderiza a UI do card de consumo de ÁREA COMUM\r\n */\r\nfunction renderCommonAreaConsumptionUI(data, valueEl, trendEl, infoEl) {\r\n  if (!data) return;\r\n\r\n  const totalGeral = data.totalGeral || 0;\r\n  const commonAreaTotal = data.commonAreaTotal || 0;\r\n  const commonAreaPercentage = totalGeral > 0 ? (commonAreaTotal / totalGeral) * 100 : 0;\r\n\r\n  if (valueEl) {\r\n    valueEl.textContent = formatWaterVolume(commonAreaTotal);\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = `${commonAreaPercentage.toFixed(1)}% do total`;\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    infoEl.textContent = 'Hidrômetros de áreas comuns';\r\n  }\r\n\r\n  console.log('[WATER] Card de Área Comum atualizado:', { commonAreaTotal, commonAreaPercentage });\r\n}\r\n\r\n/**\r\n * Renderiza a UI do card de consumo TOTAL\r\n */\r\nfunction renderTotalConsumptionUI(data, valueEl, trendEl, infoEl) {\r\n  if (!data) return;\r\n\r\n  const totalGeral = data.totalGeral || 0;\r\n\r\n  if (valueEl) {\r\n    valueEl.textContent = formatWaterVolume(totalGeral);\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = 'Lojas + Área Comum';\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    const storesTotal = data.storesTotal || 0;\r\n    const commonAreaTotal = data.commonAreaTotal || 0;\r\n    infoEl.textContent = `${formatWaterVolume(storesTotal)} lojas | ${formatWaterVolume(\r\n      commonAreaTotal\r\n    )} área comum`;\r\n  }\r\n\r\n  console.log('[WATER] Card Total atualizado:', { totalGeral });\r\n}\r\n\r\n/**\r\n * Inicializa cards com estado de loading\r\n */\r\nfunction initializeCards() {\r\n  const loadingSpinner = `\r\n    <svg class=\"loading-spinner\" style=\"width:24px; height:24px; animation: spin 1s linear infinite;\" viewBox=\"0 0 50 50\">\r\n      <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"none\" stroke=\"#0288d1\" stroke-width=\"5\" stroke-linecap=\"round\"\r\n              stroke-dasharray=\"90,150\" stroke-dashoffset=\"0\">\r\n      </circle>\r\n    </svg>\r\n  `;\r\n\r\n  // Stores card\r\n  const storesValueEl = $id('total-consumption-stores-value');\r\n  const storesTrendEl = $id('total-consumption-stores-trend');\r\n  if (storesValueEl) storesValueEl.innerHTML = loadingSpinner;\r\n  if (storesTrendEl) {\r\n    storesTrendEl.textContent = 'Aguardando dados...';\r\n    storesTrendEl.className = 'trend neutral';\r\n  }\r\n\r\n  // Common Area card\r\n  const commonAreaValueEl = $id('total-consumption-common-area-value');\r\n  const commonAreaTrendEl = $id('total-consumption-common-area-trend');\r\n  if (commonAreaValueEl) commonAreaValueEl.innerHTML = loadingSpinner;\r\n  if (commonAreaTrendEl) {\r\n    commonAreaTrendEl.textContent = 'Aguardando dados...';\r\n    commonAreaTrendEl.className = 'trend neutral';\r\n  }\r\n\r\n  // Total card\r\n  const totalValueEl = $id('total-consumption-value');\r\n  const totalTrendEl = $id('total-consumption-trend');\r\n  if (totalValueEl) totalValueEl.innerHTML = loadingSpinner;\r\n  if (totalTrendEl) {\r\n    totalTrendEl.textContent = 'Aguardando dados...';\r\n    totalTrendEl.className = 'trend neutral';\r\n  }\r\n\r\n  console.log('[WATER] Cards initialized with loading state');\r\n}\r\n\r\n/**\r\n * Atualiza todos os cards com dados\r\n */\r\nfunction updateAllCards(data) {\r\n  console.log('[WATER] Updating all cards with data:', data);\r\n\r\n  // Stores\r\n  renderStoresConsumptionUI(\r\n    data,\r\n    $id('total-consumption-stores-value'),\r\n    $id('total-consumption-stores-trend'),\r\n    $id('total-consumption-stores-info')\r\n  );\r\n\r\n  // Common Area\r\n  renderCommonAreaConsumptionUI(\r\n    data,\r\n    $id('total-consumption-common-area-value'),\r\n    $id('total-consumption-common-area-trend'),\r\n    $id('total-consumption-common-area-info')\r\n  );\r\n\r\n  // Total\r\n  renderTotalConsumptionUI(\r\n    data,\r\n    $id('total-consumption-value'),\r\n    $id('total-consumption-trend'),\r\n    $id('total-consumption-info')\r\n  );\r\n}\r\n\r\n// ============================================\r\n// CHART FUNCTIONS\r\n// ============================================\r\n\r\nlet lineChartInstance = null;\r\nlet pieChartInstance = null; // Legacy reference (kept for backwards compatibility)\r\n\r\n// RFC-0098: Consumption 7 Days Chart instance (new standardized component)\r\nlet consumptionChartInstance = null;\r\n\r\n// RFC-0102: Distribution Chart instance (new standardized component)\r\nlet distributionChartInstance = null;\r\n\r\n// RFC-0098: Cache TTL for chart data (5 minutes)\r\nconst CHART_CACHE_TTL = 5 * 60 * 1000;\r\n\r\n/**\r\n * RFC-0098: Get shopping name from multiple sources (same pattern as ENERGY)\r\n */\r\nfunction getShoppingNameForFilter(customerId) {\r\n  if (!customerId) return 'Sem Shopping';\r\n\r\n  // Priority 1: Try to get from waterCache (has customerName from API /totals)\r\n  const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n  if (orchestrator && typeof orchestrator.getWaterCache === 'function') {\r\n    const waterCache = orchestrator.getWaterCache();\r\n\r\n    // Find any device with this customerId and get customerName\r\n    for (const [ingestionId, deviceData] of waterCache) {\r\n      if (deviceData.customerId === customerId && deviceData.customerName) {\r\n        return deviceData.customerName;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Priority 2: Try from window.custumersSelected (MENU filter)\r\n  if (window.custumersSelected && Array.isArray(window.custumersSelected)) {\r\n    const shopping = window.custumersSelected.find(\r\n      (c) => c.value === customerId || c.ingestionId === customerId\r\n    );\r\n    if (shopping && shopping.name) return shopping.name;\r\n  }\r\n\r\n  // Priority 3: Try from ctx.$scope.custumer\r\n  if (self.ctx?.$scope?.custumer && Array.isArray(self.ctx.$scope.custumer)) {\r\n    const shopping = self.ctx.$scope.custumer.find((c) => c.value === customerId);\r\n    if (shopping && shopping.name) return shopping.name;\r\n  }\r\n\r\n  // Fallback\r\n  return `Shopping ${customerId.substring(0, 8)}...`;\r\n}\r\n\r\n/**\r\n * RFC-0098: Get selected shopping IDs (ingestionIds) from filter\r\n * Same pattern as ENERGY - uses window.custumersSelected from MENU filter\r\n */\r\nfunction getSelectedShoppingIds() {\r\n  // Check if there are selected customers from MENU filter\r\n  if (\r\n    window.custumersSelected &&\r\n    Array.isArray(window.custumersSelected) &&\r\n    window.custumersSelected.length > 0\r\n  ) {\r\n    // Use ingestionId if available, fallback to value (which is also ingestionId)\r\n    const selectedIds = window.custumersSelected.map((c) => c.ingestionId || c.value).filter(Boolean);\r\n\r\n    if (selectedIds.length > 0) {\r\n      console.log('[WATER] [RFC-0098] Using filtered shopping ingestionIds:', selectedIds);\r\n      return selectedIds;\r\n    }\r\n  }\r\n\r\n  // Fallback: return empty array (will use widget's customerId)\r\n  console.log('[WATER] [RFC-0098] No shopping filter active, using widget customerId');\r\n  return [];\r\n}\r\n\r\n/**\r\n * RFC-0098: Fetch water consumption for a period, grouped by day\r\n * Water API (/water/devices/totals) returns total_value per device (not consumption array like energy)\r\n * So we need to make one API call per day to get daily breakdown.\r\n * Fetches in batches of 3 with delay between batches to avoid rate limiting.\r\n * @param {string} customerId - Customer ID\r\n * @param {number} startTs - Start timestamp (unused, we use dayBoundaries)\r\n * @param {number} endTs - End timestamp (unused, we use dayBoundaries)\r\n * @param {Array} dayBoundaries - Array of { label, startTs, endTs }\r\n * @returns {Promise<number[]>} - Array of daily totals\r\n */\r\nasync function fetchWaterPeriodConsumptionByDay(customerId, startTs, endTs, dayBoundaries) {\r\n  try {\r\n    const BATCH_SIZE = 3;\r\n    const BATCH_DELAY_MS = 500; // 200ms delay between batches\r\n    const dailyTotals = [];\r\n\r\n    // Process in batches of 3\r\n    for (let i = 0; i < dayBoundaries.length; i += BATCH_SIZE) {\r\n      const batch = dayBoundaries.slice(i, i + BATCH_SIZE);\r\n\r\n      // Fetch batch in parallel\r\n      const batchPromises = batch.map(async (day) => {\r\n        try {\r\n          const result = await window.MyIOUtils.fetchWaterDayConsumption(customerId, day.startTs, day.endTs);\r\n          return result?.total || 0;\r\n        } catch (dayError) {\r\n          console.warn(`[WATER] [RFC-0098] Error fetching day ${day.label}:`, dayError);\r\n          return 0;\r\n        }\r\n      });\r\n\r\n      const batchResults = await Promise.all(batchPromises);\r\n      dailyTotals.push(...batchResults);\r\n\r\n      // Add delay before next batch (except for last batch)\r\n      if (i + BATCH_SIZE < dayBoundaries.length) {\r\n        await new Promise((resolve) => setTimeout(resolve, BATCH_DELAY_MS));\r\n      }\r\n    }\r\n\r\n    console.log(\r\n      `[WATER] [RFC-0098] Period consumption for ${customerId.slice(0, 8)}:`,\r\n      dailyTotals.map((v) => v.toFixed(2))\r\n    );\r\n    return dailyTotals;\r\n  } catch (error) {\r\n    console.error('[WATER] Error fetching period consumption:', error);\r\n    return new Array(dayBoundaries.length).fill(0);\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0098: Fetch water consumption for N days with real API data\r\n * Returns structured data with per-shopping breakdown for vizMode support\r\n */\r\nasync function fetch7DaysConsumption(period = 7, fallbackCustomerId = null) {\r\n  // Get filtered shopping IDs or use fallback customerId\r\n  const selectedShoppingIds = getSelectedShoppingIds();\r\n\r\n  // Use fallback from MAIN if no filter active\r\n  const fallbackId = fallbackCustomerId || window.myioHoldingCustomerId;\r\n  const customerIds = selectedShoppingIds.length > 0 ? selectedShoppingIds : fallbackId ? [fallbackId] : [];\r\n\r\n  if (!customerIds || customerIds.length === 0) {\r\n    console.warn('[WATER] [RFC-0098] No customer IDs available');\r\n    return { labels: [], dailyTotals: [], shoppingData: {}, shoppingNames: {} };\r\n  }\r\n\r\n  // Check cache\r\n  if (cachedChartData && cachedChartData.fetchTimestamp) {\r\n    const cacheAge = Date.now() - cachedChartData.fetchTimestamp;\r\n    const sameCustomers =\r\n      cachedChartData.customerIds?.length === customerIds.length &&\r\n      cachedChartData.customerIds?.every((id) => customerIds.includes(id));\r\n\r\n    if (cacheAge < CHART_CACHE_TTL && sameCustomers) {\r\n      console.log('[WATER] [RFC-0098] Using cached data (age:', Math.round(cacheAge / 1000), 's)');\r\n      return cachedChartData;\r\n    }\r\n  }\r\n\r\n  console.log('[WATER] [RFC-0098] Fetching', period, 'days for customers:', customerIds);\r\n\r\n  const shoppingData = {};\r\n  const shoppingNames = {};\r\n\r\n  customerIds.forEach((cid) => {\r\n    shoppingData[cid] = [];\r\n    shoppingNames[cid] = getShoppingNameForFilter(cid);\r\n  });\r\n\r\n  // Calculate period boundaries\r\n  const now = new Date();\r\n  const periodStart = new Date(now);\r\n  periodStart.setDate(now.getDate() - (period - 1));\r\n  periodStart.setHours(0, 0, 0, 0);\r\n  const startTs = periodStart.getTime();\r\n\r\n  const periodEnd = new Date(now);\r\n  periodEnd.setHours(23, 59, 59, 999);\r\n  const endTs = periodEnd.getTime();\r\n\r\n  // Build day boundaries\r\n  const dayBoundaries = [];\r\n  for (let i = 0; i < period; i++) {\r\n    const dayDate = new Date(periodStart);\r\n    dayDate.setDate(periodStart.getDate() + i);\r\n    dayDate.setHours(0, 0, 0, 0);\r\n\r\n    const dayStart = dayDate.getTime();\r\n    const dayEnd = new Date(dayDate);\r\n    dayEnd.setHours(23, 59, 59, 999);\r\n\r\n    const label = dayDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });\r\n    dayBoundaries.push({ label, startTs: dayStart, endTs: dayEnd.getTime() });\r\n  }\r\n\r\n  const labels = dayBoundaries.map((d) => d.label);\r\n\r\n  // Fetch data for all customers in parallel\r\n  console.log('[WATER] [RFC-0098] Executing', customerIds.length, 'API calls (one per shopping)...');\r\n  const fetchPromises = customerIds.map((customerId) =>\r\n    fetchWaterPeriodConsumptionByDay(customerId, startTs, endTs, dayBoundaries)\r\n  );\r\n\r\n  const results = await Promise.all(fetchPromises);\r\n\r\n  results.forEach((dailyValues, idx) => {\r\n    const customerId = customerIds[idx];\r\n    shoppingData[customerId] = dailyValues;\r\n  });\r\n\r\n  // Calculate daily totals\r\n  const dailyTotals = [];\r\n  for (let dayIdx = 0; dayIdx < period; dayIdx++) {\r\n    let dayTotal = 0;\r\n    for (const customerId of customerIds) {\r\n      dayTotal += shoppingData[customerId][dayIdx] || 0;\r\n    }\r\n    dailyTotals.push(dayTotal);\r\n  }\r\n\r\n  const result = {\r\n    labels,\r\n    dailyTotals,\r\n    shoppingData,\r\n    shoppingNames,\r\n    customerIds,\r\n    fetchTimestamp: Date.now(),\r\n  };\r\n\r\n  // Update cache\r\n  cachedChartData = result;\r\n\r\n  console.log('[WATER] [RFC-0098] Data fetched:', {\r\n    days: period,\r\n    shoppings: customerIds.length,\r\n    totalPoints: labels.length,\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * RFC-0098: Data fetching adapter for the standardized Consumption7DaysChart component\r\n * Wraps existing fetch logic to conform to the component's expected interface\r\n * @param {number} period - Number of days to fetch\r\n * @returns {Promise<object>} - Consumption7DaysData formatted data\r\n */\r\nasync function fetchWaterConsumptionDataAdapter(period) {\r\n  console.log('[WATER] [RFC-0098] Fetching data via adapter for', period, 'days');\r\n\r\n  // Update chartConfig period for compatibility with existing modal\r\n  chartConfig.period = period;\r\n\r\n  // Use existing fetch logic\r\n  const data = await fetch7DaysConsumption(period);\r\n\r\n  return {\r\n    labels: data.labels || [],\r\n    dailyTotals: data.dailyTotals || [],\r\n    shoppingData: data.shoppingData || {},\r\n    shoppingNames: data.shoppingNames || {},\r\n    fetchTimestamp: Date.now(),\r\n  };\r\n}\r\n\r\n/**\r\n * RFC-0098: Inicializa o gráfico de linha (7 dias)\r\n * Uses standardized Consumption7DaysChart component\r\n */\r\nasync function initializeLineChart() {\r\n  // RFC-0098: Use standardized widget component if available (preferred)\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.createConsumptionChartWidget) {\r\n    console.log('[WATER] [RFC-0098] Using createConsumptionChartWidget component');\r\n\r\n    // Get widget container for ThingsBoard compatibility\r\n    const $container = self.ctx?.$container || null;\r\n\r\n    consumptionChartInstance = MyIOLibrary.createConsumptionChartWidget({\r\n      domain: 'water',\r\n      containerId: 'water-chart-widget',\r\n      title: 'Consumo de Água - 7 dias',\r\n      unit: 'm³',\r\n      decimalPlaces: 1,\r\n      chartHeight: 280,\r\n      defaultPeriod: chartConfig.period || 7,\r\n      defaultChartType: chartConfig.chartType || 'line',\r\n      defaultVizMode: chartConfig.vizMode || 'total',\r\n      theme: 'light',\r\n      $container: $container,\r\n\r\n      // Data fetching via adapter\r\n      fetchData: fetchWaterConsumptionDataAdapter,\r\n\r\n      // Callbacks\r\n      onMaximizeClick: () => {\r\n        console.log('[WATER] [RFC-0098] Maximize button clicked');\r\n        openFullscreenModal();\r\n      },\r\n      onDataLoaded: (data) => {\r\n        // Update cache for fullscreen and other features\r\n        cachedChartData = data;\r\n        console.log('[WATER] [RFC-0098] Data loaded:', data.labels?.length, 'days');\r\n      },\r\n      onError: (error) => {\r\n        console.error('[WATER] [RFC-0098] Chart error:', error);\r\n      },\r\n    });\r\n\r\n    // Render the chart\r\n    await consumptionChartInstance.render();\r\n    console.log('[WATER] [RFC-0098] Consumption chart rendered successfully');\r\n\r\n    // Store reference for compatibility with existing code\r\n    lineChartInstance = consumptionChartInstance.getChartInstance();\r\n    return;\r\n  }\r\n\r\n  // RFC-0098: Component is required - no fallback to legacy canvas\r\n  console.error('[WATER] [RFC-0098] createConsumptionChartWidget not available');\r\n}\r\n\r\n/**\r\n * RFC-0102: Inicializa o gráfico de distribuição usando createDistributionChartWidget\r\n * @deprecated Use distributionChartInstance API instead\r\n */\r\nasync function initializePieChart(data) {\r\n  // RFC-0102: Distribution chart is now initialized via createDistributionChartWidget\r\n  // This function is kept for backwards compatibility\r\n  if (distributionChartInstance) {\r\n    console.log('[WATER] [RFC-0102] Refreshing distribution chart');\r\n    await distributionChartInstance.refresh();\r\n    return;\r\n  }\r\n  console.warn('[WATER] [RFC-0102] Distribution chart instance not available');\r\n}\r\n\r\n/**\r\n * RFC-0102: Initialize distribution chart widget\r\n */\r\nasync function initializeDistributionChartWidget() {\r\n  if (typeof MyIOLibrary === 'undefined' || !MyIOLibrary.createDistributionChartWidget) {\r\n    console.error('[WATER] [RFC-0102] createDistributionChartWidget not available');\r\n    return;\r\n  }\r\n\r\n  console.log('[WATER] [RFC-0102] Initializing distribution chart widget...');\r\n\r\n  // Calculate distribution data for water using REAL data from waterCache\r\n  const calculateWaterDistribution = async (mode) => {\r\n    const cachedData = getCachedTotalConsumption();\r\n    const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n\r\n    if (mode === 'groups') {\r\n      // Lojas vs Área Comum\r\n      return {\r\n        Lojas: cachedData?.storesTotal || 0,\r\n        'Área Comum': cachedData?.commonAreaTotal || 0,\r\n      };\r\n    } else if (mode === 'stores' || mode === 'common') {\r\n      // Aggregate consumption by shopping using real data from waterCache\r\n      if (!orchestrator || typeof orchestrator.getWaterCache !== 'function') {\r\n        console.warn('[WATER] Orchestrator not available for distribution calculation');\r\n        return null;\r\n      }\r\n\r\n      const waterCache = orchestrator.getWaterCache();\r\n      const waterValidIds = orchestrator.getWaterValidIds?.() || { stores: new Set(), commonArea: new Set() };\r\n\r\n      if (!waterCache || waterCache.size === 0) {\r\n        console.warn('[WATER] Water cache is empty');\r\n        return null;\r\n      }\r\n\r\n      // Select the target category based on mode\r\n      const targetIds = mode === 'stores' ? waterValidIds.stores : waterValidIds.commonArea;\r\n\r\n      console.log(`[WATER] Calculating distribution for mode: ${mode}, valid IDs: ${targetIds.size}`);\r\n\r\n      // Aggregate by shopping (customerId)\r\n      const shoppingDistribution = {};\r\n\r\n      waterCache.forEach((deviceData, ingestionId) => {\r\n        // Only include devices from the selected category\r\n        if (!targetIds.has(ingestionId)) {\r\n          return;\r\n        }\r\n\r\n        const consumption = Number(deviceData.total_value) || 0;\r\n        const customerId = deviceData.customerId;\r\n        const shoppingName = getShoppingNameForFilter(customerId);\r\n\r\n        shoppingDistribution[shoppingName] = (shoppingDistribution[shoppingName] || 0) + consumption;\r\n      });\r\n\r\n      console.log(`[WATER] Distribution by ${mode}:`, shoppingDistribution);\r\n      return shoppingDistribution;\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  // Get widget container for ThingsBoard compatibility\r\n  const $container = self.ctx?.$container || null;\r\n\r\n  distributionChartInstance = MyIOLibrary.createDistributionChartWidget({\r\n    domain: 'water',\r\n    containerId: 'water-distribution-widget',\r\n    title: 'Distribuição de Consumo de Água',\r\n    unit: 'm³',\r\n    decimalPlaces: 1,\r\n    chartHeight: 300,\r\n    theme: 'light',\r\n    $container: $container,\r\n\r\n    // Visualization modes for water\r\n    modes: [\r\n      { value: 'groups', label: 'Lojas vs Área Comum' },\r\n      { value: 'stores', label: 'Lojas por Shopping' },\r\n      { value: 'common', label: 'Área Comum por Shopping' },\r\n    ],\r\n    defaultMode: 'groups',\r\n\r\n    // Custom group colors for water\r\n    groupColors: {\r\n      Lojas: '#10b981',\r\n      'Área Comum': '#0288d1',\r\n    },\r\n\r\n    // Data fetching\r\n    fetchDistribution: calculateWaterDistribution,\r\n\r\n    // Get shopping colors from orchestrator for consistency\r\n    getShoppingColors: () => {\r\n      const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n      return orchestrator?.getShoppingColors?.() || null;\r\n    },\r\n\r\n    // Callbacks\r\n    onModeChange: (mode) => {\r\n      console.log(`[WATER] [RFC-0102] Distribution mode changed to: ${mode}`);\r\n    },\r\n    onDataLoaded: (data) => {\r\n      console.log('[WATER] [RFC-0102] Distribution data loaded:', Object.keys(data).length, 'items');\r\n    },\r\n    onError: (error) => {\r\n      console.error('[WATER] [RFC-0102] Distribution chart error:', error);\r\n    },\r\n  });\r\n\r\n  try {\r\n    await distributionChartInstance.render();\r\n    console.log('[WATER] [RFC-0102] Distribution chart rendered successfully');\r\n\r\n    // Store legacy reference for backwards compatibility\r\n    pieChartInstance = distributionChartInstance.getChartInstance();\r\n  } catch (error) {\r\n    console.error('[WATER] [RFC-0102] Failed to render distribution chart:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0102: Atualiza o gráfico de distribuição com novo modo\r\n * @deprecated Use distributionChartInstance.setMode() instead\r\n */\r\nasync function updatePieChartMode(mode) {\r\n  console.log('[WATER] [RFC-0102] Updating distribution chart mode:', mode);\r\n\r\n  if (distributionChartInstance) {\r\n    await distributionChartInstance.setMode(mode);\r\n  } else {\r\n    console.warn('[WATER] [RFC-0102] Distribution chart instance not available');\r\n  }\r\n}\r\n\r\n// ============================================\r\n// ZOOM CONTROLS\r\n// ============================================\r\n\r\nlet currentZoom = 100;\r\nconst MIN_ZOOM = 70;\r\nconst MAX_ZOOM = 130;\r\n\r\nfunction setupZoomControls() {\r\n  const fontMinus = $id('fontMinus');\r\n  const fontPlus = $id('fontPlus');\r\n  const dashboard = document.querySelector('.water-dashboard');\r\n\r\n  if (fontMinus) {\r\n    fontMinus.addEventListener('click', () => {\r\n      if (currentZoom > MIN_ZOOM) {\r\n        currentZoom -= 10;\r\n        if (dashboard) {\r\n          dashboard.style.fontSize = `${currentZoom}%`;\r\n        }\r\n        console.log('[WATER] Zoom decreased to:', currentZoom);\r\n      }\r\n    });\r\n  }\r\n\r\n  if (fontPlus) {\r\n    fontPlus.addEventListener('click', () => {\r\n      if (currentZoom < MAX_ZOOM) {\r\n        currentZoom += 10;\r\n        if (dashboard) {\r\n          dashboard.style.fontSize = `${currentZoom}%`;\r\n        }\r\n        console.log('[WATER] Zoom increased to:', currentZoom);\r\n      }\r\n    });\r\n  }\r\n\r\n  console.log('[WATER] Zoom controls initialized');\r\n}\r\n\r\n// ============================================\r\n// EVENT HANDLERS\r\n// ============================================\r\n\r\n/**\r\n * Handler para dados de água vindos do MAIN\r\n * Suporta dois formatos:\r\n * 1. cache Map - quando MAIN envia dados agregados do waterCache\r\n * 2. source/data - quando MAIN envia dados específicos por categoria\r\n */\r\nfunction handleWaterDataReady(event) {\r\n  const { source, data, cache } = event.detail || {};\r\n  console.log('[WATER] Received water data:', { source, hasCache: !!cache, hasData: !!data });\r\n\r\n  // Atualiza cache local\r\n  const cached = getCachedTotalConsumption() || { storesTotal: 0, commonAreaTotal: 0, totalGeral: 0 };\r\n\r\n  // PRIORIDADE 1: Usar totais calculados pelo Orchestrator (apenas IDs válidos dos Aliases TB)\r\n  const orchestratorTotals = window.MyIOOrchestrator?.getWaterTotals?.();\r\n  if (orchestratorTotals && orchestratorTotals.total > 0) {\r\n    cached.storesTotal = orchestratorTotals.stores;\r\n    cached.commonAreaTotal = orchestratorTotals.commonArea;\r\n    cached.totalGeral = orchestratorTotals.total;\r\n\r\n    console.log('[WATER] Using Orchestrator totals (valid TB aliases):', {\r\n      total: cached.totalGeral,\r\n      stores: cached.storesTotal,\r\n      commonArea: cached.commonAreaTotal,\r\n    });\r\n  }\r\n  // FALLBACK: Formato 1 - cache Map do MAIN (dados agregados - NÃO RECOMENDADO)\r\n  else if (cache instanceof Map && cache.size > 0) {\r\n    let totalFromCache = 0;\r\n    cache.forEach((device) => {\r\n      totalFromCache += Number(device.total_value || 0);\r\n    });\r\n\r\n    // FALLBACK: Estima split 60/40 (será corrigido quando widgets registrarem IDs)\r\n    cached.storesTotal = totalFromCache * 0.6;\r\n    cached.commonAreaTotal = totalFromCache * 0.4;\r\n    cached.totalGeral = totalFromCache;\r\n\r\n    console.log('[WATER] FALLBACK: Using estimated 60/40 split (waiting for valid IDs):', {\r\n      total: totalFromCache,\r\n      stores: cached.storesTotal,\r\n      commonArea: cached.commonAreaTotal,\r\n      devices: cache.size,\r\n    });\r\n  }\r\n  // Formato 2: source/data específico por categoria\r\n  else if (source === 'WATER_COMMON_AREA' && data) {\r\n    cached.commonAreaTotal = data.totalConsumption || 0;\r\n    cached.totalGeral = cached.storesTotal + cached.commonAreaTotal;\r\n  } else if (source === 'WATER_STORES' && data) {\r\n    cached.storesTotal = data.totalConsumption || 0;\r\n    cached.totalGeral = cached.storesTotal + cached.commonAreaTotal;\r\n  }\r\n\r\n  // Atualiza cache\r\n  cacheTotalConsumption(cached.storesTotal, cached.commonAreaTotal, cached.totalGeral);\r\n\r\n  // Atualiza UI\r\n  updateAllCards(cached);\r\n\r\n  // Atualiza pie chart\r\n  initializePieChart(cached);\r\n}\r\n\r\n/**\r\n * Handler para mudança de filtro/data\r\n */\r\nfunction handleDateUpdate(event) {\r\n  console.log('[WATER] Date update received:', event.detail);\r\n\r\n  // Show loading state\r\n  initializeCards();\r\n\r\n  // Request fresh data from MAIN\r\n  window.dispatchEvent(\r\n    new CustomEvent('myio:request-water-data', {\r\n      detail: { requestor: 'WATER' },\r\n    })\r\n  );\r\n}\r\n\r\n// ============================================\r\n// RFC-0098: FULLSCREEN MODAL FUNCTIONS\r\n// ============================================\r\n\r\n// RFC-0098: Reference to fullscreen modal instance\r\nlet fullscreenModalInstance = null;\r\n\r\n/**\r\n * RFC-0098: Open fullscreen modal using createConsumptionModal\r\n * Replaces legacy fullscreen chart code with standardized component\r\n */\r\nasync function openFullscreenModal() {\r\n  if (typeof MyIOLibrary === 'undefined' || !MyIOLibrary.createConsumptionModal) {\r\n    console.error('[WATER] [RFC-0098] createConsumptionModal not available');\r\n    return;\r\n  }\r\n\r\n  console.log('[WATER] [RFC-0098] Opening fullscreen modal...');\r\n\r\n  // RFC-0098: Get cached data from the consumption chart widget for instant display\r\n  const initialData = cachedChartData || consumptionChartInstance?.getCachedData?.() || null;\r\n  if (initialData) {\r\n    console.log('[WATER] [RFC-0098] Using cached data for modal (instant display)');\r\n  }\r\n\r\n  fullscreenModalInstance = MyIOLibrary.createConsumptionModal({\r\n    domain: 'water',\r\n    title: 'Consumo de Água',\r\n    unit: 'm³',\r\n    decimalPlaces: 1,\r\n    defaultPeriod: chartConfig.period || 7,\r\n    defaultChartType: chartConfig.chartType || 'line',\r\n    defaultVizMode: chartConfig.vizMode || 'total',\r\n    theme: 'light',\r\n    showSettingsButton: false, // Settings configured in widget before maximizing\r\n    fetchData: fetchWaterConsumptionDataAdapter,\r\n    initialData: initialData, // RFC-0098: Pass cached data for instant display\r\n    onClose: () => {\r\n      console.log('[WATER] [RFC-0098] Fullscreen modal closed');\r\n      fullscreenModalInstance = null;\r\n      isChartFullscreen = false;\r\n    },\r\n  });\r\n\r\n  isChartFullscreen = true;\r\n  await fullscreenModalInstance.open();\r\n}\r\n\r\n// ============================================\r\n// LEGACY FULLSCREEN CODE - DEPRECATED (RFC-0098)\r\n// Kept temporarily for backwards compatibility\r\n// ============================================\r\n\r\n/**\r\n * @deprecated Use openFullscreenModal() instead\r\n */\r\nfunction toggleChartFullscreen() {\r\n  // RFC-0098: Redirect to new modal-based fullscreen\r\n  openFullscreenModal();\r\n}\r\n\r\n/**\r\n * RFC-0097: Open fullscreen chart overlay\r\n */\r\nfunction openFullscreenChart() {\r\n  // Get parent document (outside iframe/widget)\r\n  const parentDoc = window.parent?.document || document;\r\n\r\n  // Remove existing fullscreen if any\r\n  const existing = parentDoc.getElementById('water-fullscreen-chart');\r\n  if (existing) existing.remove();\r\n\r\n  // Create fullscreen container\r\n  const container = parentDoc.createElement('div');\r\n  container.id = 'water-fullscreen-chart';\r\n  container.innerHTML = `\r\n    <div class=\"fullscreen-overlay\">\r\n      <div class=\"fullscreen-content\">\r\n        <div class=\"fullscreen-header\">\r\n          <div class=\"fullscreen-title-group\">\r\n            <button class=\"fullscreen-config-btn\" id=\"fullscreenConfigBtn\" title=\"Configurar período\">⚙️</button>\r\n            <h3 id=\"fullscreenChartTitle\">Consumo de Água - Últimos ${chartConfig.period} dias</h3>\r\n          </div>\r\n          <button class=\"fullscreen-close-btn\" title=\"Fechar\">✕</button>\r\n        </div>\r\n        <div class=\"fullscreen-controls\">\r\n          <div class=\"fullscreen-tabs\" id=\"fullscreenVizTabs\">\r\n            <button class=\"fullscreen-tab active\" data-viz=\"total\">Consolidado</button>\r\n            <button class=\"fullscreen-tab\" data-viz=\"separate\">Por Shopping</button>\r\n          </div>\r\n          <div class=\"fullscreen-tabs\" id=\"fullscreenTypeTabs\">\r\n            <button class=\"fullscreen-tab active\" data-type=\"line\">Linhas</button>\r\n            <button class=\"fullscreen-tab\" data-type=\"bar\">Barras</button>\r\n          </div>\r\n        </div>\r\n        <div class=\"fullscreen-chart-container\">\r\n          <canvas id=\"fullscreenWaterChart\"></canvas>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <style>\r\n      #water-fullscreen-chart {\r\n        position: fixed;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100vw;\r\n        height: 100vh;\r\n        z-index: 99999;\r\n        background: rgba(0, 0, 0, 0.85);\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-overlay {\r\n        width: 100%;\r\n        height: 100%;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-content {\r\n        width: 90%;\r\n        max-width: 1400px;\r\n        height: 85vh;\r\n        background: white;\r\n        border-radius: 16px;\r\n        padding: 24px;\r\n        display: flex;\r\n        flex-direction: column;\r\n        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);\r\n      }\r\n      #water-fullscreen-chart .fullscreen-header {\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n        margin-bottom: 16px;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-title-group {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 12px;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-config-btn {\r\n        background: #f0f9ff;\r\n        border: 1px solid #bae6fd;\r\n        border-radius: 8px;\r\n        padding: 8px 12px;\r\n        font-size: 18px;\r\n        cursor: pointer;\r\n        transition: all 0.2s;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-config-btn:hover {\r\n        background: #e0f2fe;\r\n        border-color: #0288d1;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-header h3 {\r\n        font-size: 1.5rem;\r\n        color: #0288d1;\r\n        margin: 0;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-close-btn {\r\n        background: #f3f4f6;\r\n        border: none;\r\n        width: 40px;\r\n        height: 40px;\r\n        border-radius: 8px;\r\n        font-size: 20px;\r\n        cursor: pointer;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-close-btn:hover {\r\n        background: #e5e7eb;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-controls {\r\n        display: flex;\r\n        gap: 16px;\r\n        margin-bottom: 16px;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-tabs {\r\n        display: flex;\r\n        background: #f3f4f6;\r\n        border-radius: 8px;\r\n        padding: 4px;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-tab {\r\n        padding: 8px 16px;\r\n        border: none;\r\n        background: transparent;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-size: 14px;\r\n        color: #4b5563;\r\n        transition: all 0.2s;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-tab:hover {\r\n        background: #e5e7eb;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-tab.active {\r\n        background: white;\r\n        color: #0288d1;\r\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\r\n      }\r\n      #water-fullscreen-chart .fullscreen-chart-container {\r\n        flex: 1;\r\n        min-height: 0;\r\n        position: relative;\r\n      }\r\n      #water-fullscreen-chart .fullscreen-chart-container canvas {\r\n        width: 100% !important;\r\n        height: 100% !important;\r\n      }\r\n    </style>\r\n  `;\r\n\r\n  parentDoc.body.appendChild(container);\r\n\r\n  // Setup close button\r\n  const closeBtn = container.querySelector('.fullscreen-close-btn');\r\n  if (closeBtn) {\r\n    closeBtn.addEventListener('click', () => {\r\n      isChartFullscreen = false;\r\n      closeFullscreenChart();\r\n      const maximizeBtn = $id('maximizeChartBtn');\r\n      if (maximizeBtn) {\r\n        maximizeBtn.innerHTML = '⛶';\r\n        maximizeBtn.title = 'Maximizar para tela toda';\r\n      }\r\n    });\r\n  }\r\n\r\n  // RFC-0098: Config button removed from fullscreen - settings handled by main component\r\n\r\n  // Setup viz tabs\r\n  const vizTabs = container.querySelectorAll('#fullscreenVizTabs .fullscreen-tab');\r\n  vizTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      vizTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n      chartConfig.vizMode = tab.dataset.viz;\r\n\r\n      // Sync with main widget tabs\r\n      const mainVizTabs = document.querySelectorAll('.viz-mode-tabs .chart-tab');\r\n      mainVizTabs.forEach((t) => t.classList.toggle('active', t.dataset.viz === chartConfig.vizMode));\r\n\r\n      rebuildFullscreenChart(container);\r\n    });\r\n  });\r\n\r\n  // Setup type tabs\r\n  const typeTabs = container.querySelectorAll('#fullscreenTypeTabs .fullscreen-tab');\r\n  typeTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      typeTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n      chartConfig.chartType = tab.dataset.type;\r\n\r\n      // Sync with main widget tabs\r\n      const mainTypeTabs = document.querySelectorAll('.chart-type-tabs .chart-tab');\r\n      mainTypeTabs.forEach((t) => t.classList.toggle('active', t.dataset.type === chartConfig.chartType));\r\n\r\n      rebuildFullscreenChart(container);\r\n    });\r\n  });\r\n\r\n  // Sync initial tab states\r\n  vizTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.viz === chartConfig.vizMode));\r\n  typeTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.type === chartConfig.chartType));\r\n\r\n  // Add ESC key handler\r\n  parentDoc.addEventListener('keydown', handleFullscreenEsc);\r\n\r\n  // Build initial chart\r\n  rebuildFullscreenChart(container);\r\n}\r\n\r\n/**\r\n * RFC-0097: Close fullscreen chart\r\n */\r\nfunction closeFullscreenChart() {\r\n  const parentDoc = window.parent?.document || document;\r\n  const container = parentDoc.getElementById('water-fullscreen-chart');\r\n  if (container) {\r\n    container.remove();\r\n  }\r\n\r\n  if (fullscreenChartInstance) {\r\n    fullscreenChartInstance.destroy();\r\n    fullscreenChartInstance = null;\r\n  }\r\n\r\n  parentDoc.removeEventListener('keydown', handleFullscreenEsc);\r\n}\r\n\r\n/**\r\n * RFC-0097: Handle ESC key in fullscreen\r\n */\r\nfunction handleFullscreenEsc(e) {\r\n  if (e.key === 'Escape' && isChartFullscreen) {\r\n    toggleChartFullscreen();\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0097: Rebuild fullscreen chart with current config\r\n */\r\nfunction rebuildFullscreenChart(container) {\r\n  const canvas = container.querySelector('#fullscreenWaterChart');\r\n  if (!canvas || typeof Chart === 'undefined') return;\r\n\r\n  if (fullscreenChartInstance) {\r\n    fullscreenChartInstance.destroy();\r\n  }\r\n\r\n  const ctx = canvas.getContext('2d');\r\n  const data = cachedChartData || { labels: [], dailyTotals: [], shoppingData: null, shoppingNames: null };\r\n\r\n  // Build datasets based on vizMode\r\n  let datasets = [];\r\n  const colors = ['#0288d1', '#06b6d4', '#0891b2', '#22d3ee', '#67e8f9', '#0369a1', '#0c4a6e'];\r\n\r\n  if (chartConfig.vizMode === 'separate' && data.shoppingData && Object.keys(data.shoppingData).length > 1) {\r\n    let colorIndex = 0;\r\n    for (const [shoppingId, values] of Object.entries(data.shoppingData)) {\r\n      const shoppingName = data.shoppingNames?.[shoppingId] || `Shopping ${shoppingId.slice(0, 8)}`;\r\n      datasets.push({\r\n        label: shoppingName,\r\n        data: values,\r\n        borderColor: colors[colorIndex % colors.length],\r\n        backgroundColor:\r\n          chartConfig.chartType === 'line'\r\n            ? `${colors[colorIndex % colors.length]}20`\r\n            : colors[colorIndex % colors.length],\r\n        fill: chartConfig.chartType === 'line',\r\n        tension: 0.4,\r\n        borderWidth: 2,\r\n        pointRadius: chartConfig.chartType === 'line' ? 4 : 0,\r\n        borderRadius: chartConfig.chartType === 'bar' ? 4 : 0,\r\n      });\r\n      colorIndex++;\r\n    }\r\n  } else {\r\n    datasets.push({\r\n      label: 'Consumo (m³)',\r\n      data: data.dailyTotals,\r\n      borderColor: '#0288d1',\r\n      backgroundColor: chartConfig.chartType === 'line' ? 'rgba(2, 136, 209, 0.1)' : '#0288d1',\r\n      fill: chartConfig.chartType === 'line',\r\n      tension: 0.4,\r\n      borderWidth: 2,\r\n      pointRadius: chartConfig.chartType === 'line' ? 4 : 0,\r\n      borderRadius: chartConfig.chartType === 'bar' ? 4 : 0,\r\n    });\r\n  }\r\n\r\n  // Calculate Y-axis max\r\n  const allValues = datasets.flatMap((ds) => ds.data);\r\n  const maxValue = Math.max(...allValues, 0);\r\n  const yAxisMax = maxValue > 0 ? Math.ceil((maxValue * 1.1) / 50) * 50 : 250;\r\n\r\n  fullscreenChartInstance = new Chart(ctx, {\r\n    type: chartConfig.chartType,\r\n    data: {\r\n      labels: data.labels,\r\n      datasets,\r\n    },\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: false,\r\n      animation: false,\r\n      plugins: {\r\n        legend: {\r\n          display: chartConfig.vizMode === 'separate',\r\n          position: 'top',\r\n          labels: { font: { size: 13 } },\r\n        },\r\n        tooltip: {\r\n          callbacks: {\r\n            label: function (context) {\r\n              return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} m³`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n      scales: {\r\n        y: {\r\n          beginAtZero: true,\r\n          max: yAxisMax,\r\n          title: { display: true, text: 'm³', font: { size: 14 } },\r\n        },\r\n        x: {\r\n          ticks: { font: { size: 12 } },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  console.log('[WATER] [RFC-0097] Fullscreen chart rebuilt');\r\n}\r\n\r\n/**\r\n * RFC-0097: Setup maximize button handler\r\n */\r\nfunction setupMaximizeButton() {\r\n  const maximizeBtn = $id('maximizeChartBtn');\r\n  if (!maximizeBtn) {\r\n    console.warn('[WATER] [RFC-0097] Maximize button not found');\r\n    return;\r\n  }\r\n\r\n  maximizeBtn.addEventListener('click', toggleChartFullscreen);\r\n  console.log('[WATER] [RFC-0097] Maximize button handler setup complete');\r\n}\r\n\r\n/**\r\n * RFC-0098: Setup chart tab handlers\r\n * NOTE: The createConsumptionChartWidget component now handles tabs internally.\r\n * This function is kept for backwards compatibility with external tabs if present.\r\n */\r\nfunction setupChartTabHandlers() {\r\n  // RFC-0098: The widget component injects its own tabs, so external tabs may not exist\r\n  const vizTabs = document.querySelectorAll('.viz-mode-tabs .chart-tab');\r\n  const typeTabs = document.querySelectorAll('.chart-type-tabs .chart-tab');\r\n\r\n  if (vizTabs.length === 0 && typeTabs.length === 0) {\r\n    console.log('[WATER] [RFC-0098] No external tabs found - widget handles tabs internally');\r\n    return;\r\n  }\r\n\r\n  // Setup external vizMode tabs (if present)\r\n  vizTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      vizTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newVizMode = tab.dataset.viz;\r\n      chartConfig.vizMode = newVizMode;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setVizMode === 'function') {\r\n        consumptionChartInstance.setVizMode(newVizMode);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Setup external chartType tabs (if present)\r\n  typeTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      typeTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newChartType = tab.dataset.type;\r\n      chartConfig.chartType = newChartType;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setChartType === 'function') {\r\n        consumptionChartInstance.setChartType(newChartType);\r\n      }\r\n    });\r\n  });\r\n\r\n  console.log('[WATER] [RFC-0098] External tab handlers setup (if present)');\r\n}\r\n\r\n// RFC-0098: Legacy chart functions removed (rerenderLineChart, openChartConfigModal, etc.) - settings handled by component\r\n\r\n// ============================================\r\n// INITIALIZATION\r\n// ============================================\r\n\r\n// RFC-0093: Function to render shopping filter chips in toolbar\r\nfunction renderShoppingFilterChips(selection) {\r\n  const chipsContainer = $id('waterShoppingFilterChips');\r\n  if (!chipsContainer) return;\r\n\r\n  chipsContainer.innerHTML = '';\r\n\r\n  if (!selection || selection.length === 0) {\r\n    return; // No filter applied, hide chips\r\n  }\r\n\r\n  selection.forEach((shopping) => {\r\n    const chip = document.createElement('span');\r\n    chip.className = 'filter-chip';\r\n    chip.innerHTML = `<span class=\"filter-chip-icon\">💧</span><span>${shopping.name}</span>`;\r\n    chipsContainer.appendChild(chip);\r\n  });\r\n\r\n  console.log('[WATER] 📍 Rendered', selection.length, 'shopping filter chips');\r\n}\r\n\r\nfunction setupEventListeners() {\r\n  // Listen for water data from MAIN\r\n  window.addEventListener('myio:water-data-ready', handleWaterDataReady);\r\n\r\n  // Listen for water totals calculated from valid TB aliases (Orchestrator)\r\n  window.addEventListener('myio:water-totals-updated', (ev) => {\r\n    const { commonArea, stores, total } = ev.detail || {};\r\n    console.log('[WATER] 💧 heard myio:water-totals-updated:', { commonArea, stores, total });\r\n\r\n    if (total > 0) {\r\n      // Atualiza com totais reais do Orchestrator\r\n      cacheTotalConsumption(stores, commonArea, total);\r\n\r\n      // Atualiza UI\r\n      const cached = { storesTotal: stores, commonAreaTotal: commonArea, totalGeral: total };\r\n      updateAllCards(cached);\r\n      initializePieChart(cached);\r\n\r\n      console.log('[WATER] ✅ Updated with Orchestrator totals:', cached);\r\n    }\r\n  });\r\n\r\n  // Listen for date/filter updates\r\n  window.addEventListener('myio:update-date', handleDateUpdate);\r\n\r\n  // RFC-0093: Listen for shopping filter changes\r\n  window.addEventListener('myio:filter-applied', (ev) => {\r\n    const selection = ev.detail?.selection || [];\r\n    console.log('[WATER] 🔥 heard myio:filter-applied:', selection.length, 'shoppings');\r\n    renderShoppingFilterChips(selection);\r\n  });\r\n\r\n  // RFC-0093: Check for pre-existing filter when WATER initializes\r\n  if (\r\n    window.custumersSelected &&\r\n    Array.isArray(window.custumersSelected) &&\r\n    window.custumersSelected.length > 0\r\n  ) {\r\n    console.log('[WATER] 🔄 Applying pre-existing filter:', window.custumersSelected.length, 'shoppings');\r\n    renderShoppingFilterChips(window.custumersSelected);\r\n  }\r\n\r\n  // Distribution mode selector\r\n  const distributionSelect = $id('distributionMode');\r\n  if (distributionSelect) {\r\n    distributionSelect.addEventListener('change', (e) => {\r\n      updatePieChartMode(e.target.value);\r\n    });\r\n  }\r\n\r\n  console.log('[WATER] Event listeners setup complete');\r\n}\r\n\r\nfunction cleanup() {\r\n  window.removeEventListener('myio:water-data-ready', handleWaterDataReady);\r\n  window.removeEventListener('myio:update-date', handleDateUpdate);\r\n\r\n  // RFC-0098: Cleanup consumption chart instance first\r\n  if (consumptionChartInstance && typeof consumptionChartInstance.destroy === 'function') {\r\n    console.log('[WATER] [RFC-0098] Destroying consumption chart instance');\r\n    consumptionChartInstance.destroy();\r\n    consumptionChartInstance = null;\r\n  }\r\n\r\n  // RFC-0102: Cleanup distribution chart instance\r\n  if (distributionChartInstance && typeof distributionChartInstance.destroy === 'function') {\r\n    console.log('[WATER] [RFC-0102] Destroying distribution chart instance');\r\n    distributionChartInstance.destroy();\r\n    distributionChartInstance = null;\r\n  }\r\n\r\n  if (lineChartInstance) {\r\n    lineChartInstance.destroy();\r\n    lineChartInstance = null;\r\n  }\r\n\r\n  if (pieChartInstance) {\r\n    pieChartInstance.destroy();\r\n    pieChartInstance = null;\r\n  }\r\n}\r\n\r\n// ============================================\r\n// THINGSBOARD WIDGET HOOKS\r\n// ============================================\r\n\r\nself.onInit = function () {\r\n  console.log('[WATER] Widget initialized');\r\n  console.log('[WATER] DEBUG: Chart.js available?', typeof Chart !== 'undefined');\r\n  console.log('[WATER] DEBUG: MyIOLibrary available?', typeof MyIOLibrary !== 'undefined');\r\n  console.log('[WATER] DEBUG: water-chart-widget container?', !!$id('water-chart-widget'));\r\n  console.log('[WATER] DEBUG: water-distribution-widget container?', !!$id('water-distribution-widget'));\r\n\r\n  // Initialize cards with loading state\r\n  initializeCards();\r\n\r\n  // Setup zoom controls\r\n  setupZoomControls();\r\n\r\n  // Setup event listeners\r\n  setupEventListeners();\r\n\r\n  // RFC-0097: Setup chart tab handlers (vizMode and chartType)\r\n  setupChartTabHandlers();\r\n\r\n  // RFC-0097: Setup maximize button for fullscreen\r\n  setupMaximizeButton();\r\n\r\n  // RFC-0098: Chart config button handled by createConsumption7DaysChart component via settingsButtonId and onSettingsClick\r\n\r\n  // Initialize charts with empty/loading state\r\n  setTimeout(() => {\r\n    console.log('[WATER] DEBUG setTimeout: Initializing charts...');\r\n\r\n    initializeLineChart();\r\n\r\n    // RFC-0102: Initialize distribution chart widget\r\n    initializeDistributionChartWidget();\r\n\r\n    // FIX: Check Orchestrator totals FIRST (may already be available)\r\n    const orchestratorTotals = window.MyIOOrchestrator?.getWaterTotals?.();\r\n    if (orchestratorTotals && orchestratorTotals.total > 0) {\r\n      console.log('[WATER] Using Orchestrator totals on init:', orchestratorTotals);\r\n      const data = {\r\n        storesTotal: orchestratorTotals.stores,\r\n        commonAreaTotal: orchestratorTotals.commonArea,\r\n        totalGeral: orchestratorTotals.total,\r\n      };\r\n      cacheTotalConsumption(data.storesTotal, data.commonAreaTotal, data.totalGeral);\r\n      initializePieChart(data);\r\n      updateAllCards(data);\r\n    } else {\r\n      // Check if we already have cached data from MAIN\r\n      const cached = getCachedTotalConsumption();\r\n      if (cached) {\r\n        console.log('[WATER] Using cached data on init:', cached);\r\n        initializePieChart(cached);\r\n        updateAllCards(cached);\r\n      } else {\r\n        // Initialize with zeros while waiting for real data\r\n        const emptyData = {\r\n          storesTotal: 0,\r\n          commonAreaTotal: 0,\r\n          totalGeral: 0,\r\n        };\r\n        initializePieChart(emptyData);\r\n        // Keep loading state on cards\r\n      }\r\n    }\r\n  }, 500);\r\n\r\n  // Request data from MAIN immediately\r\n  setTimeout(() => {\r\n    console.log('[WATER] Requesting water data from MAIN...');\r\n    window.dispatchEvent(\r\n      new CustomEvent('myio:request-water-data', {\r\n        detail: { requestor: 'WATER' },\r\n      })\r\n    );\r\n  }, 200);\r\n\r\n  // FIX: Retry request after 2 seconds if cards still show loading\r\n  setTimeout(() => {\r\n    const storesValueEl = $id('total-consumption-stores-value');\r\n    const hasSpinner = storesValueEl?.querySelector('.loading-spinner');\r\n    if (hasSpinner) {\r\n      console.log('[WATER] Cards still loading, retrying data request...');\r\n\r\n      // Check Orchestrator totals again\r\n      const orchestratorTotals = window.MyIOOrchestrator?.getWaterTotals?.();\r\n      if (orchestratorTotals && orchestratorTotals.total > 0) {\r\n        console.log('[WATER] Retry: Found Orchestrator totals:', orchestratorTotals);\r\n        const data = {\r\n          storesTotal: orchestratorTotals.stores,\r\n          commonAreaTotal: orchestratorTotals.commonArea,\r\n          totalGeral: orchestratorTotals.total,\r\n        };\r\n        cacheTotalConsumption(data.storesTotal, data.commonAreaTotal, data.totalGeral);\r\n        updateAllCards(data);\r\n        initializePieChart(data);\r\n      } else {\r\n        // Request from MAIN again\r\n        window.dispatchEvent(\r\n          new CustomEvent('myio:request-water-data', {\r\n            detail: { requestor: 'WATER', retry: true },\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }, 2000);\r\n\r\n  // FIX: Final retry after 5 seconds - last attempt before giving up\r\n  setTimeout(() => {\r\n    const storesValueEl = $id('total-consumption-stores-value');\r\n    const hasSpinner = storesValueEl?.querySelector('.loading-spinner');\r\n    if (hasSpinner) {\r\n      console.log('[WATER] Final retry - cards still loading after 5s...');\r\n\r\n      const orchestratorTotals = window.MyIOOrchestrator?.getWaterTotals?.();\r\n      if (orchestratorTotals && orchestratorTotals.total > 0) {\r\n        console.log('[WATER] Final retry: Found Orchestrator totals:', orchestratorTotals);\r\n        const data = {\r\n          storesTotal: orchestratorTotals.stores,\r\n          commonAreaTotal: orchestratorTotals.commonArea,\r\n          totalGeral: orchestratorTotals.total,\r\n        };\r\n        cacheTotalConsumption(data.storesTotal, data.commonAreaTotal, data.totalGeral);\r\n        updateAllCards(data);\r\n        initializePieChart(data);\r\n      } else {\r\n        // Show zero values instead of infinite loading\r\n        console.log('[WATER] No data available, showing zero values');\r\n        const emptyData = {\r\n          storesTotal: 0,\r\n          commonAreaTotal: 0,\r\n          totalGeral: 0,\r\n        };\r\n        updateAllCards(emptyData);\r\n        initializePieChart(emptyData);\r\n      }\r\n    }\r\n  }, 5000);\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  // Data updates handled via custom events\r\n};\r\n\r\nself.onResize = function () {\r\n  // Charts auto-resize\r\n};\r\n\r\nself.onDestroy = function () {\r\n  console.log('[WATER] Widget destroyed');\r\n  cleanup();\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Water Summary Widget Settings\",\r\n    \"properties\": {\r\n        \"labelWidget\":{\r\n            \"type\":\"string\",\r\n            \"title\": \"Widget Label\",\r\n            \"default\": \"Resumo de água\"\r\n        }\r\n    }\r\n  },\r\n  \"form\": [\r\n    \"labelWidget\"\r\n  ]\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - WATER - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "e93720f0-c97b-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}