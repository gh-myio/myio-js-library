{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_head_office_energy_v_5_2_0",
    "name": "Widget Head Office - ENERGY - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
        },
        {
          "url": "https://unpkg.com/myio-js-library@0.1.180/dist/myio-js-library.umd.min.js"
        },
        {
          "url": "https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
        }
      ],
      "templateHtml": "<div class=\"energy-dashboard\">\r\n  <!-- Header -->\r\n  <h2 class=\"title\">Gestão de Energia</h2>\r\n\r\n  <!-- Cards -->\r\n  <div class=\"cards\">\r\n    <!-- Consumo Total de Lojas (sem equipamentos) -->\r\n    <div class=\"card\" id=\"total-consumption-stores-card\">\r\n      <p class=\"label\">Consumo Total Lojas</p>\r\n      <h3 class=\"value\" id=\"total-consumption-stores-value\">\r\n        <svg\r\n          class=\"loading-spinner\"\r\n          style=\"width: 24px; height: 24px; animation: spin 1s linear infinite\"\r\n          viewBox=\"0 0 50 50\"\r\n        >\r\n          <circle\r\n            cx=\"25\"\r\n            cy=\"25\"\r\n            r=\"20\"\r\n            fill=\"none\"\r\n            stroke=\"#6c2fbf\"\r\n            stroke-width=\"5\"\r\n            stroke-linecap=\"round\"\r\n            stroke-dasharray=\"90,150\"\r\n            stroke-dashoffset=\"0\"\r\n          ></circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"total-consumption-stores-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"total-consumption-stores-info\">Apenas lojas</span>\r\n    </div>\r\n\r\n    <!-- Consumo Total de Equipamentos (NOVO) -->\r\n    <div class=\"card\" id=\"total-consumption-equipments-card\">\r\n      <p class=\"label\">Consumo Total Equipamentos</p>\r\n      <h3 class=\"value\" id=\"total-consumption-equipments-value\">\r\n        <svg\r\n          class=\"loading-spinner\"\r\n          style=\"width: 24px; height: 24px; animation: spin 1s linear infinite\"\r\n          viewBox=\"0 0 50 50\"\r\n        >\r\n          <circle\r\n            cx=\"25\"\r\n            cy=\"25\"\r\n            r=\"20\"\r\n            fill=\"none\"\r\n            stroke=\"#6c2fbf\"\r\n            stroke-width=\"5\"\r\n            stroke-linecap=\"round\"\r\n            stroke-dasharray=\"90,150\"\r\n            stroke-dashoffset=\"0\"\r\n          ></circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"total-consumption-equipments-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"total-consumption-equipments-info\">Elevadores, escadas, HVAC, etc.</span>\r\n    </div>\r\n\r\n    <!-- DESABILITADO TEMPORARIAMENTE: Pico de Demanda -->\r\n    <!--\r\n    <div class=\"card\" id=\"peak-demand-card\">\r\n      <p class=\"label\">Pico de Demanda</p>\r\n      <h3 class=\"value\" id=\"peak-demand-value\">\r\n        <svg class=\"loading-spinner\" style=\"width:24px; height:24px; animation: spin 1s linear infinite;\" viewBox=\"0 0 50 50\">\r\n          <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"none\" stroke=\"#6c2fbf\" stroke-width=\"5\" stroke-linecap=\"round\"\r\n                  stroke-dasharray=\"90,150\" stroke-dashoffset=\"0\">\r\n          </circle>\r\n        </svg>\r\n      </h3>\r\n      <span class=\"trend neutral\" id=\"peak-demand-trend\">Aguardando dados...</span>\r\n      <span class=\"device-info\" id=\"peak-demand-device\"></span>\r\n    </div>\r\n    -->\r\n\r\n    <!-- DESABILITADO TEMPORARIAMENTE: Meta x Consumo Real -->\r\n    <!--\r\n    <div class=\"card\">\r\n      <p class=\"label\">Meta x Consumo Real</p>\r\n      <h3 class=\"value\">87%</h3>\r\n      <div class=\"progress-bar\">\r\n        <div class=\"progress\" style=\"width:87%\"></div>\r\n      </div>\r\n      <span class=\"meta\">Acima da meta de 85%</span>\r\n    </div>\r\n    -->\r\n  </div>\r\n\r\n  <!-- Charts -->\r\n  <div class=\"charts\">\r\n    <!-- RFC-0098: Container for createConsumptionChartWidget (widget injects its own HTML) -->\r\n    <div id=\"energy-chart-widget\" class=\"chart-box chart-box-energy\"></div>\r\n\r\n    <!-- RFC-0102: Container for createDistributionChartWidget (widget injects its own HTML) -->\r\n    <div id=\"energy-distribution-widget\" class=\"chart-box chart-box-energy\"></div>\r\n  </div>\r\n  <br />\r\n</div>\r\n",
      "templateCss": "/* ============================================ */\r\n/* ENERGY WIDGET - SCROLL FIX (RFC-0073)       */\r\n/* ============================================ */\r\n\r\n/*\r\n  SOLUÇÃO: Igual ao widget EQUIPMENTS (que funciona perfeitamente)\r\n  - Aceita a altura limitada do container ThingsBoard\r\n  - Cria scroll interno com overflow: auto\r\n*/\r\n\r\n.energy-dashboard {\r\n  font-family: 'Inter', sans-serif;\r\n  color: #1c2743;\r\n\r\n  /* Layout */\r\n  position: relative;\r\n  box-sizing: border-box;\r\n\r\n  /* CRITICAL: Igual ao .equip-wrap do EQUIPMENTS */\r\n  width: 100%;\r\n  height: 100%; /* Aceita altura do container ThingsBoard */\r\n  overflow: auto; /* Cria scroll vertical interno quando necessário */\r\n\r\n  /* Espaçamento */\r\n  padding: 20px;\r\n}\r\n\r\n.title {\r\n  margin: 0;\r\n  font-size: 22px;\r\n  font-weight: 600;\r\n}\r\n\r\n.subtitle {\r\n  margin: 0 0 20px;\r\n  color: #6b7a90;\r\n  font-size: 14px;\r\n}\r\n\r\n.cards {\r\n  display: flex;\r\n  gap: 16px;\r\n  margin-bottom: 24px;\r\n}\r\n\r\n.card {\r\n  flex: 1;\r\n  background: linear-gradient(180deg, #ffffff 0%, #f7fbff 100%);\r\n  border: 1px solid #e6eef5;\r\n  border-radius: 12px;\r\n  padding: 16px;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);\r\n}\r\n\r\n.label {\r\n  font-size: 13px;\r\n  color: #6b7a90;\r\n}\r\n\r\n.value {\r\n  font-size: 22px;\r\n  margin: 4px 0;\r\n}\r\n\r\n.trend {\r\n  font-size: 12px;\r\n}\r\n\r\n.trend.up {\r\n  color: #dc2626;\r\n} /* Red for increase in demand (bad) */\r\n.trend.down {\r\n  color: #16a34a;\r\n} /* Green for decrease in demand (good) */\r\n.trend.neutral {\r\n  color: #6b7280;\r\n} /* Gray for no change */\r\n\r\n.progress-bar {\r\n  background: #e6eef5;\r\n  height: 8px;\r\n  border-radius: 6px;\r\n  margin: 6px 0;\r\n}\r\n\r\n.progress {\r\n  background: #2563eb;\r\n  height: 100%;\r\n  border-radius: 6px;\r\n}\r\n\r\n.meta {\r\n  font-size: 12px;\r\n  color: #6b7a90;\r\n}\r\n\r\n/* RFC-0073: Fixed layout at 100% zoom with proper proportions */\r\n.charts {\r\n  display: grid;\r\n  grid-template-columns: minmax(400px, 1fr) minmax(350px, 1fr);\r\n  gap: 16px;\r\n  width: 100%;\r\n  position: relative;\r\n  min-height: 500px !important; /* Força altura mínima para os gráficos */\r\n  height: auto !important;\r\n  overflow: visible !important;\r\n}\r\n\r\n/* Responsive: Stack vertically on smaller screens */\r\n@media (max-width: 1200px) {\r\n  .charts {\r\n    grid-template-columns: 1fr;\r\n    min-height: 900px !important; /* Altura maior para empilhamento vertical */\r\n  }\r\n}\r\n\r\n.chart-box {\r\n  background: #fff;\r\n  border: 1px solid #e6eef5;\r\n  border-radius: 12px;\r\n  padding: 16px;\r\n  min-width: 0; /* RFC-0073: Prevent overflow */\r\n  min-height: 450px !important; /* Garante espaço mínimo para os gráficos */\r\n  height: auto;\r\n  display: flex;\r\n  flex-direction: column;\r\n  position: relative;\r\n}\r\n\r\n/* RFC-0097: Green background for energy chart */\r\n.chart-box-energy {\r\n  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\r\n  border: 1px solid #86efac;\r\n  min-height: 380px !important; /* Override default 450px - ajustado ao gráfico */\r\n}\r\n\r\n/* RFC-0097: Fullscreen mode */\r\n.chart-box-energy.fullscreen {\r\n  position: fixed !important;\r\n  top: 0 !important;\r\n  left: 0 !important;\r\n  right: 0 !important;\r\n  bottom: 0 !important;\r\n  width: 100vw !important;\r\n  height: 100vh !important;\r\n  z-index: 9999 !important;\r\n  border-radius: 0 !important;\r\n  margin: 0 !important;\r\n  padding: 24px !important;\r\n  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\r\n}\r\n\r\n.chart-box-energy.fullscreen canvas {\r\n  max-height: calc(100vh - 120px) !important;\r\n  height: calc(100vh - 120px) !important;\r\n}\r\n\r\n/* RFC-0097: Loading overlay */\r\n.chart-loading-overlay {\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: rgba(240, 253, 244, 0.9);\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  z-index: 10;\r\n  border-radius: 12px;\r\n  gap: 12px;\r\n}\r\n\r\n.chart-loading-spinner {\r\n  width: 40px;\r\n  height: 40px;\r\n  border: 3px solid #86efac;\r\n  border-top-color: #22c55e;\r\n  border-radius: 50%;\r\n  animation: spin 1s linear infinite;\r\n}\r\n\r\n@keyframes spin {\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n.chart-loading-overlay span {\r\n  color: #166534;\r\n  font-size: 14px;\r\n  font-weight: 500;\r\n}\r\n\r\n/* RFC-0097: Title group with settings icon */\r\n.chart-title-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.chart-title-group .config-btn {\r\n  order: -1; /* Icon before title */\r\n}\r\n\r\n/* RFC-0097: Maximize button */\r\n.maximize-btn {\r\n  background: transparent;\r\n  border: 1px solid #86efac;\r\n  border-radius: 6px;\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n  font-size: 16px;\r\n  color: #166534;\r\n  transition: all 0.2s;\r\n}\r\n\r\n.maximize-btn:hover {\r\n  background: #dcfce7;\r\n  border-color: #22c55e;\r\n}\r\n\r\n.chart-box canvas {\r\n  flex: 1;\r\n  min-height: 250px !important;\r\n  max-height: 300px !important; /* RFC-0097: Fix height to prevent infinite growth */\r\n  width: 100% !important;\r\n  height: 300px !important;\r\n}\r\n\r\n.chart-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 12px;\r\n  gap: 12px;\r\n}\r\n\r\n.chart-header h4 {\r\n  margin: 0;\r\n  font-size: 16px;\r\n  font-weight: 600;\r\n  color: #1c2743;\r\n}\r\n\r\n.chart-controls {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.control-label {\r\n  font-size: 13px;\r\n  color: #6b7a90;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chart-select {\r\n  padding: 6px 12px;\r\n  border: 1px solid #d1d5db;\r\n  border-radius: 8px;\r\n  background: #fff;\r\n  font-size: 13px;\r\n  color: #1c2743;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n  outline: none;\r\n}\r\n\r\n.chart-select:hover {\r\n  border-color: #2563eb;\r\n}\r\n\r\n.chart-select:focus {\r\n  border-color: #2563eb;\r\n  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\r\n}\r\n\r\n/* RFC-0073: Configuration button for 7-day chart */\r\n.config-btn {\r\n  padding: 6px 12px;\r\n  border: 1px solid #d1d5db;\r\n  border-radius: 8px;\r\n  background: #fff;\r\n  font-size: 16px;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n  outline: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.config-btn:hover {\r\n  border-color: #2563eb;\r\n  background: #f3f8fc;\r\n}\r\n\r\n.config-btn:focus {\r\n  border-color: #2563eb;\r\n  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);\r\n}\r\n\r\n/* ====== CONTROLES DE ZOOM ====== */\r\n.toolbar-zoom {\r\n  position: sticky;\r\n  top: 6px;\r\n  z-index: 2;\r\n  display: flex;\r\n  gap: 6px;\r\n  justify-content: flex-end;\r\n  margin-bottom: 8px;\r\n}\r\n.toolbar-zoom button {\r\n  border: 1px solid var(--card-bd);\r\n  background: #fff;\r\n  border-radius: 10px;\r\n  padding: 4px 10px;\r\n  font-size: var(--fs-lg);\r\n  color: var(--ink-1);\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);\r\n}\r\n.toolbar-zoom button:hover {\r\n  background: #f3f8fc;\r\n}\r\n\r\n.cards-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(4, 1fr); /* 4 cards por linha */\r\n  gap: 16px; /* espaço entre os cards */\r\n}\r\n\r\n.cards-grid > * {\r\n  min-width: 0;\r\n  width: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* Peak Demand Card Styles */\r\n#peak-demand-card {\r\n  position: relative;\r\n}\r\n\r\n#peak-demand-value {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  min-height: 32px;\r\n}\r\n\r\n.loading-spinner {\r\n  display: inline-block;\r\n}\r\n\r\n.device-info {\r\n  display: block;\r\n  font-size: 11px;\r\n  color: #6b7280;\r\n  margin-top: 4px;\r\n}\r\n\r\n@keyframes spin {\r\n  from {\r\n    transform: rotate(0deg);\r\n  }\r\n  to {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n/* ============================================ */\r\n/* RFC-0097: Chart TABs Styles                 */\r\n/* ============================================ */\r\n\r\n.chart-tabs {\r\n  display: inline-flex;\r\n  gap: 2px;\r\n  background: #f1f5f9;\r\n  border-radius: 8px;\r\n  padding: 2px;\r\n  margin-right: 8px;\r\n}\r\n\r\n.chart-tab {\r\n  padding: 6px 12px;\r\n  border: none;\r\n  background: transparent;\r\n  border-radius: 6px;\r\n  font-size: 12px;\r\n  font-weight: 500;\r\n  color: #64748b;\r\n  cursor: pointer;\r\n  transition: all 0.2s;\r\n  white-space: nowrap;\r\n}\r\n\r\n.chart-tab:hover {\r\n  color: #1e293b;\r\n}\r\n\r\n.chart-tab.active {\r\n  background: #fff;\r\n  color: #6c2fbf;\r\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\r\n}\r\n\r\n/* Responsive: Stack tabs on smaller screens */\r\n@media (max-width: 900px) {\r\n  .chart-controls {\r\n    flex-wrap: wrap;\r\n    justify-content: flex-end;\r\n  }\r\n\r\n  .chart-tabs {\r\n    margin-bottom: 4px;\r\n  }\r\n}\r\n",
      "controllerScript": "/* global self, window, document, MyIOLibrary, Chart */\r\n\r\n// ============================================\r\n// MYIO-SIM 5.2.0 - ENERGY Widget Controller\r\n// ============================================\r\n\r\n// ============================================\r\n// SHARED UTILITIES (from MAIN via window.MyIOUtils)\r\n// ============================================\r\n// Use shared utilities from MAIN, with fallback to local implementation\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => LogHelper.log(...args),\r\n  warn: (...args) => LogHelper.warn(...args),\r\n  error: (...args) => LogHelper.error(...args),\r\n};\r\n\r\n// ============================================\r\n// DEBUG FLAGS\r\n// ============================================\r\n\r\n/**\r\n * RFC-0073: Debug flag to use mock data for day total consumption\r\n * Set to true to bypass API calls and return mock data for 7-day chart\r\n */\r\nconst MOCK_DEBUG_DAY_CONSUMPTION = false;\r\n\r\n// ============================================\r\n// CACHE CONFIGURATION\r\n// ============================================\r\n\r\n// RFC-0097: Chart configuration state\r\nconst chartConfig = {\r\n  period: 7, // days: 7, 14, 30, or 0 (custom)\r\n  startDate: null, // ISO string for custom period\r\n  endDate: null, // ISO string for custom period\r\n  granularity: '1d', // '1d' (day) or '1h' (hour)\r\n  vizMode: 'total', // 'total' or 'separate'\r\n  chartType: 'line', // 'line' or 'bar'\r\n};\r\n\r\n// RFC-0097: Cache for chart data (avoid re-fetch when switching vizMode/chartType)\r\nlet cachedChartData = null;\r\nconst CHART_CACHE_TTL = 60 * 1000; // 1 minute cache TTL\r\n\r\n/**\r\n * Renderiza a UI do card de consumo total com dados\r\n */\r\n// NOVO CÓDIGO PARA O WIDGET ENERGY\r\n\r\n/**\r\n * Renderiza a UI do card de consumo de LOJAS (sem equipamentos)\r\n * @param {object} energyData - O objeto de resumo completo vindo do MAIN.\r\n */\r\nfunction renderTotalConsumptionStoresUI(energyData, valueEl, trendEl, infoEl) {\r\n  if (!energyData) return;\r\n\r\n  const totalGeral = energyData.customerTotal;\r\n  const lojasTotal = energyData.difference; // Lojas = customerTotal - equipmentsTotal\r\n\r\n  const lojasPercentage = totalGeral > 0 ? (lojasTotal / totalGeral) * 100 : 0;\r\n  const lojasFormatted = MyIOLibrary.formatEnergy(lojasTotal);\r\n\r\n  if (valueEl) {\r\n    valueEl.textContent = lojasFormatted;\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = `${lojasPercentage.toFixed(1)}% do total`;\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    infoEl.textContent = 'Apenas lojas';\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Card de Lojas atualizado:', { lojasTotal, lojasFormatted, lojasPercentage });\r\n}\r\n\r\n/**\r\n * Renderiza a UI do card de consumo de EQUIPAMENTOS\r\n * @param {object} energyData - O objeto de resumo completo vindo do MAIN.\r\n */\r\nfunction renderTotalConsumptionEquipmentsUI(energyData, valueEl, trendEl, infoEl) {\r\n  if (!energyData) return;\r\n\r\n  const totalGeral = energyData.customerTotal;\r\n  const equipamentosTotal = energyData.equipmentsTotal;\r\n\r\n  const equipamentosPercentage = totalGeral > 0 ? (equipamentosTotal / totalGeral) * 100 : 0;\r\n  const equipamentosFormatted = MyIOLibrary.formatEnergy(equipamentosTotal);\r\n\r\n  if (valueEl) {\r\n    valueEl.textContent = equipamentosFormatted;\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = `${equipamentosPercentage.toFixed(1)}% do total`;\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    infoEl.textContent = 'Elevadores, escadas, HVAC, etc.';\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Card de Equipamentos atualizado:', {\r\n    equipamentosTotal,\r\n    equipamentosFormatted,\r\n    equipamentosPercentage,\r\n  });\r\n}\r\n\r\n/**\r\n * Inicializa o card de consumo total de LOJAS com estado de loading\r\n */\r\nfunction initializeTotalConsumptionStoresCard() {\r\n  const valueEl = document.getElementById('total-consumption-stores-value');\r\n  const trendEl = document.getElementById('total-consumption-stores-trend');\r\n\r\n  // Show loading state\r\n  if (valueEl) {\r\n    valueEl.innerHTML = `\r\n      <svg class=\"loading-spinner\" style=\"width:24px; height:24px; animation: spin 1s linear infinite;\" viewBox=\"0 0 50 50\">\r\n        <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"none\" stroke=\"#6c2fbf\" stroke-width=\"5\" stroke-linecap=\"round\"\r\n                stroke-dasharray=\"90,150\" stroke-dashoffset=\"0\">\r\n        </circle>\r\n      </svg>\r\n    `;\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = 'Aguardando dados...';\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Stores consumption card initialized with loading state');\r\n}\r\n\r\n/**\r\n * Inicializa o card de consumo total de EQUIPAMENTOS com estado de loading\r\n */\r\nfunction initializeTotalConsumptionEquipmentsCard() {\r\n  const valueEl = document.getElementById('total-consumption-equipments-value');\r\n  const trendEl = document.getElementById('total-consumption-equipments-trend');\r\n\r\n  // Show loading state\r\n  if (valueEl) {\r\n    valueEl.innerHTML = `\r\n      <svg class=\"loading-spinner\" style=\"width:24px; height:24px; animation: spin 1s linear infinite;\" viewBox=\"0 0 50 50\">\r\n        <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"none\" stroke=\"#6c2fbf\" stroke-width=\"5\" stroke-linecap=\"round\"\r\n                stroke-dasharray=\"90,150\" stroke-dashoffset=\"0\">\r\n        </circle>\r\n      </svg>\r\n    `;\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = 'Aguardando dados...';\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Equipments consumption card initialized with loading state');\r\n}\r\n\r\n/**\r\n * Atualiza o card de consumo total de LOJAS\r\n * @param {object} summary - O objeto de resumo calculado pelo widget MAIN.\r\n */\r\nfunction updateTotalConsumptionStoresCard(summary) {\r\n  LogHelper.log('[ENERGY] Atualizando card de consumo de LOJAS:', summary);\r\n\r\n  if (!summary) return;\r\n\r\n  const valueEl = document.getElementById('total-consumption-stores-value');\r\n  const trendEl = document.getElementById('total-consumption-stores-trend');\r\n  const infoEl = document.getElementById('total-consumption-stores-info');\r\n\r\n  renderTotalConsumptionStoresUI(summary, valueEl, trendEl, infoEl);\r\n}\r\n\r\n/**\r\n * Atualiza o card de consumo total de EQUIPAMENTOS\r\n * @param {object} summary - O objeto de resumo calculado pelo widget MAIN.\r\n */\r\nfunction updateTotalConsumptionEquipmentsCard(summary) {\r\n  LogHelper.log('[ENERGY] Atualizando card de consumo de EQUIPAMENTOS:', summary);\r\n\r\n  if (!summary) return;\r\n\r\n  const valueEl = document.getElementById('total-consumption-equipments-value');\r\n  const trendEl = document.getElementById('total-consumption-equipments-trend');\r\n  const infoEl = document.getElementById('total-consumption-equipments-info');\r\n\r\n  renderTotalConsumptionEquipmentsUI(summary, valueEl, trendEl, infoEl);\r\n}\r\n\r\n/**\r\n * DEPRECATED: Inicializa o card de consumo total com estado de loading\r\n */\r\nfunction initializeTotalConsumptionCard() {\r\n  const valueEl = document.getElementById('total-consumption-value');\r\n  const trendEl = document.getElementById('total-consumption-trend');\r\n  const infoEl = document.getElementById('total-consumption-info');\r\n\r\n  // Show loading state\r\n  if (valueEl) {\r\n    valueEl.innerHTML = `\r\n      <svg class=\"loading-spinner\" style=\"width:24px; height:24px; animation: spin 1s linear infinite;\" viewBox=\"0 0 50 50\">\r\n        <circle cx=\"25\" cy=\"25\" r=\"20\" fill=\"none\" stroke=\"#6c2fbf\" stroke-width=\"5\" stroke-linecap=\"round\"\r\n                stroke-dasharray=\"90,150\" stroke-dashoffset=\"0\">\r\n        </circle>\r\n      </svg>\r\n    `;\r\n  }\r\n\r\n  if (trendEl) {\r\n    trendEl.textContent = 'Aguardando dados...';\r\n    trendEl.className = 'trend neutral';\r\n  }\r\n\r\n  if (infoEl) {\r\n    infoEl.textContent = '';\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Total consumption card initialized with loading state');\r\n}\r\n\r\n/**\r\n * RFC-0073: Get selected shopping IDs (ingestionIds) from filter\r\n * RFC-0096: Fixed - window.custumersSelected already contains only selected items\r\n *           Each item has: { name, value (ingestionId), customerId, ingestionId }\r\n */\r\nfunction getSelectedShoppingIds() {\r\n  // Check if there are selected customers from MENU filter\r\n  if (\r\n    window.custumersSelected &&\r\n    Array.isArray(window.custumersSelected) &&\r\n    window.custumersSelected.length > 0\r\n  ) {\r\n    // RFC-0096: All items in custumersSelected are already selected, no need to filter by .selected\r\n    // Use ingestionId if available, fallback to value (which is also ingestionId)\r\n    const selectedIds = window.custumersSelected.map((c) => c.ingestionId || c.value).filter(Boolean);\r\n\r\n    if (selectedIds.length > 0) {\r\n      LogHelper.log('[ENERGY] [RFC-0096] Using filtered shopping ingestionIds:', selectedIds);\r\n      return selectedIds;\r\n    }\r\n  }\r\n\r\n  // Fallback: return empty array (will use widget's customerId)\r\n  LogHelper.log('[ENERGY] [RFC-0096] No shopping filter active, using widget customerId');\r\n  return [];\r\n}\r\n\r\n/**\r\n * Get selected shopping ingestionIds from filter for energyCache filtering\r\n * The energyCache stores customerId as the shopping's ingestionId (not ThingsBoard customerId)\r\n * @returns {string[]} - Array of ingestionIds from selected shoppings, or empty if no filter/all selected\r\n */\r\nfunction getSelectedShoppingCustomerIds() {\r\n  // Check if there are selected customers from MENU filter\r\n  if (\r\n    window.custumersSelected &&\r\n    Array.isArray(window.custumersSelected) &&\r\n    window.custumersSelected.length > 0\r\n  ) {\r\n    // Check if ALL shoppings are selected (no real filter)\r\n    // Compare with total available customers from ctx.$scope.custumer\r\n    const totalCustomers = self.ctx?.$scope?.custumer?.length || 0;\r\n    if (totalCustomers > 0 && window.custumersSelected.length >= totalCustomers) {\r\n      LogHelper.log('[ENERGY] All shoppings selected - no filter applied');\r\n      return []; // No filter when all are selected\r\n    }\r\n\r\n    // Use ingestionId (or value which is also ingestionId) to match energyCache.customerId\r\n    // Note: energyCache stores the shopping's ingestionId as customerId, not ThingsBoard customerId\r\n    const ingestionIds = window.custumersSelected.map((c) => c.ingestionId || c.value).filter(Boolean);\r\n\r\n    if (ingestionIds.length > 0) {\r\n      LogHelper.log('[ENERGY] Using filtered shopping ingestionIds for energyCache:', ingestionIds);\r\n      return ingestionIds;\r\n    }\r\n  }\r\n\r\n  // Fallback: return empty array (no filter active)\r\n  return [];\r\n}\r\n\r\n// ============================================\r\n// CHART FUNCTIONS\r\n// ============================================\r\n\r\n// Global chart references for later updates\r\nlet lineChartInstance = null;\r\nlet pieChartInstance = null; // Legacy reference (kept for backwards compatibility)\r\n\r\n// RFC-0098: Consumption 7 Days Chart instance (new standardized component)\r\nlet consumptionChartInstance = null;\r\n\r\n// RFC-0102: Distribution Chart instance (new standardized component)\r\nlet distributionChartInstance = null;\r\n\r\n// RFC-0097: Fullscreen state\r\nlet isChartFullscreen = false;\r\n\r\n// RFC-0098: Line chart update state (prevents concurrent updates)\r\nlet isUpdatingLineChart = false;\r\nlet pendingLineChartUpdate = null;\r\n\r\n/**\r\n * RFC-0097: Show loading overlay on energy chart\r\n */\r\nfunction showChartLoading() {\r\n  const overlay = document.getElementById('lineChartLoading');\r\n  if (overlay) {\r\n    overlay.style.display = 'flex';\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0097: Hide loading overlay on energy chart\r\n */\r\nfunction hideChartLoading() {\r\n  const overlay = document.getElementById('lineChartLoading');\r\n  if (overlay) {\r\n    overlay.style.display = 'none';\r\n  }\r\n}\r\n\r\n// RFC-0098: Reference to fullscreen modal instance\r\nlet fullscreenModalInstance = null;\r\n\r\n/**\r\n * RFC-0098: Open fullscreen modal using createConsumptionModal\r\n * Replaces legacy fullscreen chart code with standardized component\r\n */\r\nasync function openFullscreenModal() {\r\n  if (typeof MyIOLibrary === 'undefined' || !MyIOLibrary.createConsumptionModal) {\r\n    LogHelper.error('[ENERGY] [RFC-0098] createConsumptionModal not available');\r\n    return;\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0098] Opening fullscreen modal...');\r\n\r\n  // RFC-0098: Get cached data from the consumption chart widget for instant display\r\n  const initialData = cachedChartData || consumptionChartInstance?.getCachedData?.() || null;\r\n  if (initialData) {\r\n    LogHelper.log('[ENERGY] [RFC-0098] Using cached data for modal (instant display)');\r\n  }\r\n\r\n  fullscreenModalInstance = MyIOLibrary.createConsumptionModal({\r\n    domain: 'energy',\r\n    title: 'Consumo de Energia',\r\n    unit: 'kWh',\r\n    unitLarge: 'MWh',\r\n    thresholdForLargeUnit: 1000,\r\n    decimalPlaces: 1,\r\n    defaultPeriod: chartConfig.period || 7,\r\n    defaultChartType: chartConfig.chartType || 'line',\r\n    defaultVizMode: chartConfig.vizMode || 'total',\r\n    theme: 'light',\r\n    showSettingsButton: false, // Settings configured in widget before maximizing\r\n    fetchData: fetchConsumptionDataAdapter,\r\n    initialData: initialData, // RFC-0098: Pass cached data for instant display\r\n    onClose: () => {\r\n      LogHelper.log('[ENERGY] [RFC-0098] Fullscreen modal closed');\r\n      fullscreenModalInstance = null;\r\n      isChartFullscreen = false;\r\n    },\r\n  });\r\n\r\n  isChartFullscreen = true;\r\n  await fullscreenModalInstance.open();\r\n}\r\n\r\n// ============================================\r\n// LEGACY FULLSCREEN CODE - DEPRECATED (RFC-0098)\r\n// Kept temporarily for backwards compatibility\r\n// ============================================\r\n\r\n/**\r\n * @deprecated Use openFullscreenModal() instead\r\n */\r\nfunction toggleChartFullscreen() {\r\n  // RFC-0098: Redirect to new modal-based fullscreen\r\n  openFullscreenModal();\r\n}\r\n\r\n/**\r\n * RFC-0097: Opens fullscreen chart overlay in parent document (like filter modal)\r\n */\r\nfunction openFullscreenChart() {\r\n  // Get target document (parent if in iframe, otherwise current)\r\n  const targetDoc = window.parent?.document || document;\r\n  const targetBody = targetDoc.body;\r\n\r\n  // Check if already exists\r\n  let container = targetDoc.getElementById('energyChartFullscreenGlobal');\r\n  if (container) {\r\n    container.style.display = 'flex';\r\n    rebuildFullscreenChart(container);\r\n    return;\r\n  }\r\n\r\n  // Create fullscreen container with injected styles\r\n  container = targetDoc.createElement('div');\r\n  container.id = 'energyChartFullscreenGlobal';\r\n  container.innerHTML = `\r\n    <style>\r\n      #energyChartFullscreenGlobal {\r\n        position: fixed;\r\n        inset: 0;\r\n        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);\r\n        z-index: 999999;\r\n        display: flex;\r\n        flex-direction: column;\r\n        padding: 24px;\r\n        box-sizing: border-box;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-header {\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n        margin-bottom: 16px;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-title-group {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 12px;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-header h3 {\r\n        margin: 0;\r\n        font-size: 20px;\r\n        font-weight: 600;\r\n        color: #166534;\r\n        font-family: 'Inter', sans-serif;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-config-btn {\r\n        background: #fff;\r\n        border: 1px solid #86efac;\r\n        border-radius: 8px;\r\n        padding: 8px 12px;\r\n        font-size: 18px;\r\n        cursor: pointer;\r\n        transition: all 0.2s;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-config-btn:hover {\r\n        background: #dcfce7;\r\n        border-color: #22c55e;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-close-btn {\r\n        background: #fff;\r\n        border: 1px solid #86efac;\r\n        border-radius: 8px;\r\n        padding: 8px 16px;\r\n        font-size: 14px;\r\n        font-weight: 500;\r\n        color: #166534;\r\n        cursor: pointer;\r\n        transition: all 0.2s;\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 6px;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-close-btn:hover {\r\n        background: #dcfce7;\r\n        border-color: #22c55e;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-chart-container {\r\n        flex: 1;\r\n        background: #fff;\r\n        border-radius: 12px;\r\n        padding: 20px;\r\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);\r\n        display: flex;\r\n        flex-direction: column;\r\n        min-height: 0;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-controls {\r\n        display: flex;\r\n        gap: 12px;\r\n        margin-bottom: 16px;\r\n        flex-wrap: wrap;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-tabs {\r\n        display: inline-flex;\r\n        gap: 2px;\r\n        background: #f1f5f9;\r\n        border-radius: 8px;\r\n        padding: 2px;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-tab {\r\n        padding: 8px 16px;\r\n        border: none;\r\n        background: transparent;\r\n        border-radius: 6px;\r\n        font-size: 13px;\r\n        font-weight: 500;\r\n        color: #64748b;\r\n        cursor: pointer;\r\n        transition: all 0.2s;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-tab:hover {\r\n        color: #1e293b;\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-tab.active {\r\n        background: #fff;\r\n        color: #166534;\r\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\r\n      }\r\n      #energyChartFullscreenGlobal .fullscreen-canvas-wrap {\r\n        flex: 1;\r\n        position: relative;\r\n        min-height: 0;\r\n      }\r\n      #energyChartFullscreenGlobal canvas {\r\n        width: 100% !important;\r\n        height: 100% !important;\r\n      }\r\n    </style>\r\n    <div class=\"fullscreen-header\">\r\n      <div class=\"fullscreen-title-group\">\r\n        <button class=\"fullscreen-config-btn\" id=\"fullscreenConfigBtn\" title=\"Configurar período\">⚙️</button>\r\n        <h3 id=\"fullscreenChartTitle\">Consumo dos últimos 7 dias</h3>\r\n      </div>\r\n      <button class=\"fullscreen-close-btn\" id=\"closeFullscreenChart\">\r\n        <span>✕</span> Fechar\r\n      </button>\r\n    </div>\r\n    <div class=\"fullscreen-chart-container\">\r\n      <div class=\"fullscreen-controls\">\r\n        <div class=\"fullscreen-tabs\" id=\"fullscreenVizTabs\">\r\n          <button class=\"fullscreen-tab active\" data-viz=\"total\">Consolidado</button>\r\n          <button class=\"fullscreen-tab\" data-viz=\"separate\">Por Shopping</button>\r\n        </div>\r\n        <div class=\"fullscreen-tabs\" id=\"fullscreenTypeTabs\">\r\n          <button class=\"fullscreen-tab active\" data-type=\"line\">Linhas</button>\r\n          <button class=\"fullscreen-tab\" data-type=\"bar\">Barras</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"fullscreen-canvas-wrap\">\r\n        <canvas id=\"fullscreenLineChart\"></canvas>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  targetBody.appendChild(container);\r\n  targetBody.style.overflow = 'hidden';\r\n\r\n  // Setup event handlers\r\n  setupFullscreenHandlers(container, targetDoc);\r\n\r\n  // Render chart in fullscreen\r\n  rebuildFullscreenChart(container);\r\n\r\n  // ESC key handler\r\n  targetDoc.addEventListener('keydown', handleFullscreenEsc);\r\n}\r\n\r\n/**\r\n * RFC-0097: Setup fullscreen chart event handlers\r\n */\r\nfunction setupFullscreenHandlers(container, targetDoc) {\r\n  // Close button\r\n  const closeBtn = container.querySelector('#closeFullscreenChart');\r\n  if (closeBtn) {\r\n    closeBtn.addEventListener('click', () => {\r\n      isChartFullscreen = false;\r\n      closeFullscreenChart();\r\n      const maximizeBtn = document.getElementById('maximizeChartBtn');\r\n      if (maximizeBtn) {\r\n        maximizeBtn.innerHTML = '⛶';\r\n        maximizeBtn.title = 'Maximizar para tela toda';\r\n      }\r\n    });\r\n  }\r\n\r\n  // RFC-0098: Config button removed from fullscreen - settings handled by main component\r\n  // The fullscreen view inherits settings from the main chart\r\n\r\n  // Viz mode tabs\r\n  const vizTabs = container.querySelectorAll('#fullscreenVizTabs .fullscreen-tab');\r\n  vizTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      vizTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n      chartConfig.vizMode = tab.dataset.viz;\r\n\r\n      // Sync with main widget tabs\r\n      const mainVizTabs = document.querySelectorAll('.viz-mode-tabs .chart-tab');\r\n      mainVizTabs.forEach((t) => t.classList.toggle('active', t.dataset.viz === chartConfig.vizMode));\r\n\r\n      rebuildFullscreenChart(container);\r\n    });\r\n  });\r\n\r\n  // Chart type tabs\r\n  const typeTabs = container.querySelectorAll('#fullscreenTypeTabs .fullscreen-tab');\r\n  typeTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      typeTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n      chartConfig.chartType = tab.dataset.type;\r\n\r\n      // Sync with main widget tabs\r\n      const mainTypeTabs = document.querySelectorAll('.chart-type-tabs .chart-tab');\r\n      mainTypeTabs.forEach((t) => t.classList.toggle('active', t.dataset.type === chartConfig.chartType));\r\n\r\n      rebuildFullscreenChart(container);\r\n    });\r\n  });\r\n\r\n  // Sync initial tab states\r\n  vizTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.viz === chartConfig.vizMode));\r\n  typeTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.type === chartConfig.chartType));\r\n}\r\n\r\n// Reference to fullscreen chart instance\r\nlet fullscreenChartInstance = null;\r\n\r\n/**\r\n * RFC-0097: Rebuild chart in fullscreen container\r\n */\r\nfunction rebuildFullscreenChart(container) {\r\n  if (!cachedChartData) {\r\n    LogHelper.warn('[ENERGY] [RFC-0097] No cached data for fullscreen chart');\r\n    return;\r\n  }\r\n\r\n  // Update title\r\n  const titleEl = container.querySelector('#fullscreenChartTitle');\r\n  if (titleEl) {\r\n    const mainTitle = document.getElementById('lineChartTitle');\r\n    titleEl.textContent = mainTitle?.textContent || 'Consumo de Energia';\r\n  }\r\n\r\n  // Get canvas\r\n  const canvas = container.querySelector('#fullscreenLineChart');\r\n  if (!canvas) return;\r\n\r\n  // Destroy previous instance\r\n  if (fullscreenChartInstance) {\r\n    fullscreenChartInstance.destroy();\r\n    fullscreenChartInstance = null;\r\n  }\r\n\r\n  const { labels, dailyTotals, shoppingData, shoppingNames } = cachedChartData;\r\n\r\n  // Calculate max Y value\r\n  let maxValue = 0;\r\n  if (dailyTotals && dailyTotals.length > 0) {\r\n    maxValue = Math.max(...dailyTotals);\r\n  }\r\n  if (shoppingData) {\r\n    Object.values(shoppingData).forEach((values) => {\r\n      if (Array.isArray(values)) {\r\n        const shoppingMax = Math.max(...values);\r\n        if (shoppingMax > maxValue) maxValue = shoppingMax;\r\n      }\r\n    });\r\n  }\r\n  const yAxisMax = maxValue > 0 ? Math.ceil((maxValue * 1.1) / 1000) * 1000 : 10000;\r\n\r\n  let datasets = [];\r\n  const colors = ['#166534', '#2563eb', '#16a34a', '#ea580c', '#dc2626', '#8b5cf6', '#0891b2', '#65a30d'];\r\n\r\n  if (chartConfig.vizMode === 'separate' && shoppingData && Object.keys(shoppingData).length > 1) {\r\n    let colorIndex = 0;\r\n    for (const [shoppingId, values] of Object.entries(shoppingData)) {\r\n      const shoppingName = shoppingNames?.[shoppingId] || `Shopping ${shoppingId.slice(0, 8)}`;\r\n      const color = colors[colorIndex % colors.length];\r\n      datasets.push({\r\n        label: shoppingName,\r\n        data: values,\r\n        borderColor: color,\r\n        backgroundColor: chartConfig.chartType === 'bar' ? color + '80' : color + '20',\r\n        fill: chartConfig.chartType === 'line',\r\n        tension: 0.3,\r\n        pointRadius: chartConfig.chartType === 'line' ? 5 : 0,\r\n        pointBackgroundColor: color,\r\n        borderWidth: 2,\r\n      });\r\n      colorIndex++;\r\n    }\r\n  } else {\r\n    datasets.push({\r\n      label: 'Consumo Total (kWh)',\r\n      data: dailyTotals,\r\n      borderColor: '#166534',\r\n      backgroundColor: chartConfig.chartType === 'bar' ? '#16653480' : 'rgba(22, 101, 52, 0.1)',\r\n      fill: chartConfig.chartType === 'line',\r\n      tension: 0.3,\r\n      pointRadius: chartConfig.chartType === 'line' ? 5 : 0,\r\n      pointBackgroundColor: '#166534',\r\n      borderWidth: 3,\r\n    });\r\n  }\r\n\r\n  fullscreenChartInstance = new Chart(canvas, {\r\n    type: chartConfig.chartType,\r\n    data: { labels, datasets },\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: false,\r\n      animation: false,\r\n      plugins: {\r\n        legend: {\r\n          display: chartConfig.vizMode === 'separate',\r\n          position: 'top',\r\n          labels: { font: { size: 13 } },\r\n        },\r\n        tooltip: {\r\n          callbacks: {\r\n            label: (context) => {\r\n              const value = context.parsed.y || 0;\r\n              if (value >= 1000) {\r\n                return `${context.dataset.label}: ${(value / 1000).toLocaleString('pt-BR', {\r\n                  maximumFractionDigits: 2,\r\n                })} MWh`;\r\n              }\r\n              return `${context.dataset.label}: ${value.toLocaleString('pt-BR', {\r\n                maximumFractionDigits: 2,\r\n              })} kWh`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n      scales: {\r\n        y: {\r\n          beginAtZero: true,\r\n          max: yAxisMax,\r\n          title: {\r\n            display: true,\r\n            text: yAxisMax >= 1000 ? 'Consumo (MWh)' : 'Consumo (kWh)',\r\n            font: { size: 14 },\r\n          },\r\n          ticks: {\r\n            font: { size: 12 },\r\n            callback: function (value) {\r\n              if (yAxisMax >= 1000) return (value / 1000).toFixed(1);\r\n              return value.toFixed(0);\r\n            },\r\n          },\r\n        },\r\n        x: {\r\n          title: {\r\n            display: true,\r\n            text: chartConfig.granularity === '1h' ? 'Hora' : 'Data',\r\n            font: { size: 14 },\r\n          },\r\n          ticks: { font: { size: 12 } },\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0097] Fullscreen chart rebuilt');\r\n}\r\n\r\n/**\r\n * RFC-0097: Close fullscreen chart overlay\r\n */\r\nfunction closeFullscreenChart() {\r\n  const targetDoc = window.parent?.document || document;\r\n  const container = targetDoc.getElementById('energyChartFullscreenGlobal');\r\n\r\n  if (container) {\r\n    container.style.display = 'none';\r\n  }\r\n\r\n  targetDoc.body.style.overflow = '';\r\n  targetDoc.removeEventListener('keydown', handleFullscreenEsc);\r\n\r\n  // Destroy fullscreen chart instance\r\n  if (fullscreenChartInstance) {\r\n    fullscreenChartInstance.destroy();\r\n    fullscreenChartInstance = null;\r\n  }\r\n\r\n  // RFC-0098: Sync main chart via component API\r\n  if (consumptionChartInstance && typeof consumptionChartInstance.refresh === 'function') {\r\n    consumptionChartInstance.refresh();\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0097] Fullscreen closed');\r\n}\r\n\r\n/**\r\n * RFC-0097: ESC key handler for fullscreen mode\r\n */\r\nfunction handleFullscreenEsc(e) {\r\n  if (e.key === 'Escape' && isChartFullscreen) {\r\n    toggleChartFullscreen();\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0097: Setup maximize button handler\r\n */\r\nfunction setupMaximizeButton() {\r\n  const maximizeBtn = document.getElementById('maximizeChartBtn');\r\n  if (!maximizeBtn) {\r\n    LogHelper.warn('[ENERGY] [RFC-0097] Maximize button not found');\r\n    return;\r\n  }\r\n\r\n  maximizeBtn.addEventListener('click', toggleChartFullscreen);\r\n  LogHelper.log('[ENERGY] [RFC-0097] Maximize button handler setup complete');\r\n}\r\n\r\n/**\r\n * RFC-0097: Fetches consumption for a period and groups by day\r\n * Fetches in batches of 3 with delay between batches to avoid rate limiting.\r\n * @param {string} customerId - Customer ID\r\n * @param {number} startTs - Start timestamp (unused, we use dayBoundaries)\r\n * @param {number} endTs - End timestamp (unused, we use dayBoundaries)\r\n * @param {Array} dayBoundaries - Array of { label, startTs, endTs }\r\n * @returns {Promise<number[]>} - Array of daily totals\r\n */\r\nasync function fetchPeriodConsumptionByDay(customerId, startTs, endTs, dayBoundaries) {\r\n  try {\r\n    const BATCH_SIZE = 3;\r\n    const BATCH_DELAY_MS = 500; // 500ms delay between batches\r\n    const dailyTotals = [];\r\n\r\n    // Process in batches of 3\r\n    for (let i = 0; i < dayBoundaries.length; i += BATCH_SIZE) {\r\n      const batch = dayBoundaries.slice(i, i + BATCH_SIZE);\r\n\r\n      // Fetch batch in parallel\r\n      const batchPromises = batch.map(async (day) => {\r\n        try {\r\n          const result = await window.MyIOUtils.fetchEnergyDayConsumption(customerId, day.startTs, day.endTs);\r\n          return result?.total || 0;\r\n        } catch (dayError) {\r\n          LogHelper.warn(`[ENERGY] [RFC-0097] Error fetching day ${day.label}:`, dayError);\r\n          return 0;\r\n        }\r\n      });\r\n\r\n      const batchResults = await Promise.all(batchPromises);\r\n      dailyTotals.push(...batchResults);\r\n\r\n      // Add delay before next batch (except for last batch)\r\n      if (i + BATCH_SIZE < dayBoundaries.length) {\r\n        await new Promise((resolve) => setTimeout(resolve, BATCH_DELAY_MS));\r\n      }\r\n    }\r\n\r\n    LogHelper.log(\r\n      `[ENERGY] [RFC-0097] Period consumption for ${customerId.slice(0, 8)}:`,\r\n      dailyTotals.map((v) => v.toFixed(2))\r\n    );\r\n    return dailyTotals;\r\n  } catch (error) {\r\n    LogHelper.error('[ENERGY] Error fetching period consumption:', error);\r\n    return new Array(dayBoundaries.length).fill(0);\r\n  }\r\n}\r\n\r\n/**\r\n * Busca o consumo total de todos os devices para um dia específico\r\n * @param {string} customerId - ID do customer\r\n * @param {number} startTs - Início do dia em ms\r\n * @param {number} endTs - Fim do dia em ms\r\n * @returns {Promise<number>} - Total de consumo em kWh\r\n */\r\nasync function fetchDayTotalConsumption(customerId, startTs, endTs) {\r\n  // RFC-0073: Debug mock data\r\n  if (MOCK_DEBUG_DAY_CONSUMPTION) {\r\n    const dayDate = new Date(startTs);\r\n    const dayOfWeek = dayDate.getDay(); // 0 = Sunday, 6 = Saturday\r\n\r\n    // Generate realistic consumption patterns\r\n    // Weekends have lower consumption, weekdays higher\r\n    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;\r\n\r\n    // Base consumption varies by customer (use customerId to generate deterministic values)\r\n    const customerSeed = customerId ? Math.abs(customerId.charCodeAt(0)) : 50;\r\n    const baseConsumption = 8000 + (customerSeed % 4000); // 8000-12000 kWh base\r\n\r\n    // Weekend reduction (20-30% less)\r\n    const weekendFactor = isWeekend ? 0.7 + Math.random() * 0.1 : 1.0;\r\n\r\n    // Daily variation (±15%)\r\n    const variation = 0.85 + Math.random() * 0.3;\r\n\r\n    const mockConsumption = baseConsumption * weekendFactor * variation;\r\n\r\n    LogHelper.log(\r\n      `[ENERGY] [MOCK] Day total (${dayDate.toLocaleDateString()}): ${mockConsumption.toFixed(2)} kWh`\r\n    );\r\n\r\n    // Simulate API delay\r\n    await new Promise((resolve) => setTimeout(resolve, 50));\r\n\r\n    return mockConsumption;\r\n  }\r\n\r\n  try {\r\n    const result = await window.MyIOUtils.fetchEnergyDayConsumption(customerId, startTs, endTs, '1d');\r\n\r\n    // RFC-0097: API returns array directly or { devices: [...] }\r\n    // Format: [{ id, name, type, consumption: [{ timestamp, value }] }]\r\n    let total = 0;\r\n    const devices = Array.isArray(result) ? result : result?.devices || result?.data || [];\r\n\r\n    if (Array.isArray(devices)) {\r\n      devices.forEach((device) => {\r\n        // Check for new API format with consumption array\r\n        if (Array.isArray(device.consumption)) {\r\n          device.consumption.forEach((entry) => {\r\n            total += Number(entry.value) || 0;\r\n          });\r\n        } else {\r\n          // Fallback for old format with total_value\r\n          total += Number(device.total_value) || Number(device.value) || 0;\r\n        }\r\n      });\r\n    }\r\n\r\n    // If no devices processed, use the pre-calculated total\r\n    if (total === 0 && result.total > 0) {\r\n      total = result.total;\r\n    }\r\n\r\n    LogHelper.log(`[ENERGY] Day total (${new Date(startTs).toLocaleDateString()}): ${total.toFixed(2)} kWh`);\r\n    return total;\r\n  } catch (error) {\r\n    LogHelper.error('[ENERGY] Error fetching day total:', error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n/**\r\n * Classifica EQUIPAMENTOS (não lojas) em categorias\r\n * IMPORTANTE: Lojas são identificadas pelo lojasIngestionIds do orchestrator\r\n * Esta função APENAS classifica equipamentos\r\n *\r\n * REGRAS (mesma lógica do EQUIPMENTS):\r\n * 1. Se deviceType = \"3F_MEDIDOR\" E deviceProfile existe → usa deviceProfile como deviceType\r\n * 2. Classifica baseado no deviceType (não no label):\r\n *    - ELEVADOR/ELEVATOR → Elevadores\r\n *    - ESCADA_ROLANTE → Escadas Rolantes\r\n *    - CHILLER, AR_CONDICIONADO, AC → Climatização\r\n *    - Resto → Outros Equipamentos\r\n */\r\nfunction classifyEquipmentDetailed(device) {\r\n  let deviceType = (device.deviceType || '').toUpperCase();\r\n  const deviceProfile = (device.deviceProfile || '').toUpperCase();\r\n  const identifier = (device.deviceIdentifier || device.name || '').toUpperCase();\r\n  const labelOrName = (device.labelOrName || device.label || device.name || '').toUpperCase();\r\n\r\n  // RFC-0076: REGRA 1: Se é 3F_MEDIDOR e tem deviceProfile válido, usa o deviceProfile como deviceType\r\n  if (deviceType === '3F_MEDIDOR' && deviceProfile && deviceProfile !== 'N/D') {\r\n    deviceType = deviceProfile;\r\n  }\r\n\r\n  // RFC-0076: REGRA 2 (CRITICAL FIX): Se deviceType está vazio mas há deviceProfile, usa deviceProfile\r\n  if (!deviceType && deviceProfile && deviceProfile !== 'N/D') {\r\n    deviceType = deviceProfile;\r\n  }\r\n\r\n  // RFC-0076: Priority 1 - ELEVATORS\r\n  // Check deviceType first (now includes deviceProfile!), then fallback to name patterns\r\n  if (deviceType === 'ELEVADOR' || deviceType === 'ELEVATOR') {\r\n    return 'Elevadores';\r\n  }\r\n  // Fallback: Check name patterns for elevators\r\n  if (\r\n    labelOrName.includes('ELEVADOR') ||\r\n    labelOrName.includes('ELEVATOR') ||\r\n    labelOrName.includes(' ELV') ||\r\n    labelOrName.includes('ELV ') ||\r\n    (labelOrName.includes('ELV.') && !labelOrName.includes('ESRL'))\r\n  ) {\r\n    return 'Elevadores';\r\n  }\r\n\r\n  // RFC-0076: Priority 2 - ESCALATORS\r\n  // Check deviceType first, then fallback to name patterns\r\n  if (deviceType === 'ESCADA_ROLANTE' || deviceType === 'ESCALATOR') {\r\n    return 'Escadas Rolantes';\r\n  }\r\n  // Fallback: Check name patterns for escalators\r\n  if (\r\n    labelOrName.includes('ESCADA') ||\r\n    labelOrName.includes('ESCALATOR') ||\r\n    labelOrName.includes('ESRL') ||\r\n    labelOrName.includes('ESC.ROL')\r\n  ) {\r\n    return 'Escadas Rolantes';\r\n  }\r\n\r\n  // RFC-0076: Priority 3 - CLIMATIZAÇÃO (HVAC)\r\n  // Check for CAG in identifier or labelOrName (same as EQUIPMENTS widget)\r\n  const hasCAG = identifier.includes('CAG') || labelOrName.includes('CAG');\r\n\r\n  const hvacTypes = ['CHILLER', 'FANCOIL', 'AR_CONDICIONADO', 'AC', 'HVAC', 'BOMBA'];\r\n  const hvacNamePatterns =\r\n    labelOrName.includes('FANCOIL') ||\r\n    labelOrName.includes('CHILLER') ||\r\n    labelOrName.includes('CAG') ||\r\n    labelOrName.includes('HVAC') ||\r\n    labelOrName.includes('BOMBA') ||\r\n    labelOrName.includes('AR COND') ||\r\n    labelOrName.includes('MOTR');\r\n\r\n  if (hasCAG || hvacTypes.includes(deviceType) || hvacNamePatterns) {\r\n    return 'Climatização';\r\n  }\r\n\r\n  // RFC-0076: Default - Everything else is \"Outros Equipamentos\"\r\n  // This includes: MOTOR and any other equipment type\r\n  return 'Outros Equipamentos';\r\n}\r\n\r\n/**\r\n * Calcula distribuição baseada no modo selecionado\r\n * @param {string} mode - Modo de visualização (groups, elevators, escalators, hvac, others, stores)\r\n * @returns {Object} - Distribuição {label: consumption}\r\n */\r\nasync function calculateDistributionByMode(mode) {\r\n  try {\r\n    const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n\r\n    if (!orchestrator || typeof orchestrator.getEnergyCache !== 'function') {\r\n      LogHelper.warn('[ENERGY] Orchestrator not available');\r\n      return null;\r\n    }\r\n\r\n    const energyCache = orchestrator.getEnergyCache();\r\n\r\n    if (!energyCache || energyCache.size === 0) {\r\n      LogHelper.warn('[ENERGY] Energy cache is empty');\r\n      return null;\r\n    }\r\n\r\n    // Get filtered shopping customerIds (if filter is active)\r\n    const filteredCustomerIds = getSelectedShoppingCustomerIds();\r\n    const hasFilter = filteredCustomerIds.length > 0;\r\n\r\n    LogHelper.log(\r\n      `[ENERGY] Calculating distribution for mode: ${mode}${\r\n        hasFilter ? ` (filtered by ${filteredCustomerIds.length} shoppings)` : ' (all shoppings)'\r\n      }`\r\n    );\r\n\r\n    // Create a filtered view of energyCache if filter is active\r\n    const filteredEnergyCache = new Map();\r\n    if (hasFilter) {\r\n      energyCache.forEach((deviceData, ingestionId) => {\r\n        if (filteredCustomerIds.includes(deviceData.customerId)) {\r\n          filteredEnergyCache.set(ingestionId, deviceData);\r\n        }\r\n      });\r\n      LogHelper.log(\r\n        `[ENERGY] Filtered energyCache: ${filteredEnergyCache.size} devices (from ${energyCache.size} total)`\r\n      );\r\n    } else {\r\n      // No filter - use all devices\r\n      energyCache.forEach((deviceData, ingestionId) => {\r\n        filteredEnergyCache.set(ingestionId, deviceData);\r\n      });\r\n    }\r\n\r\n    // Use filteredEnergyCache for all calculations\r\n    const workingCache = filteredEnergyCache;\r\n\r\n    if (mode === 'groups') {\r\n      // Por grupos de equipamentos (padrão)\r\n      const groups = {\r\n        Elevadores: 0,\r\n        'Escadas Rolantes': 0,\r\n        Climatização: 0,\r\n        'Outros Equipamentos': 0,\r\n        Lojas: 0,\r\n      };\r\n\r\n      // RFC-0076: Device counters for debugging\r\n      const deviceCounters = {\r\n        Elevadores: 0,\r\n        'Escadas Rolantes': 0,\r\n        Climatização: 0,\r\n        'Outros Equipamentos': 0,\r\n        Lojas: 0,\r\n      };\r\n\r\n      // Get lojas IDs from orchestrator (same logic as MAIN uses)\r\n      const lojasIngestionIds = orchestrator.getLojasIngestionIds?.() || new Set();\r\n      LogHelper.log(`[ENERGY] Using lojasIngestionIds from orchestrator: ${lojasIngestionIds.size} lojas`);\r\n\r\n      let sampleCount = 0;\r\n      workingCache.forEach((deviceData, ingestionId) => {\r\n        const consumption = Number(deviceData.total_value) || 0;\r\n\r\n        // Priority 1: Check if it's a LOJA (using same logic as MAIN)\r\n        if (lojasIngestionIds.has(ingestionId)) {\r\n          groups['Lojas'] += consumption;\r\n          deviceCounters['Lojas']++;\r\n\r\n          if (sampleCount < 10) {\r\n            LogHelper.log(`[ENERGY] 🔍 Device classification sample #${sampleCount + 1}:`, {\r\n              name: deviceData.name,\r\n              ingestionId: ingestionId,\r\n              classified: 'Lojas (from lojasIngestionIds)',\r\n              consumption: consumption,\r\n            });\r\n            sampleCount++;\r\n          }\r\n          return; // Skip further classification\r\n        }\r\n\r\n        // RFC-0076: Priority 2: Classify EQUIPMENTS (everything that's not a loja)\r\n        const label = String(\r\n          deviceData.label || deviceData.entityLabel || deviceData.entityName || deviceData.name || ''\r\n        ).toLowerCase();\r\n\r\n        // RFC-0076: CRITICAL FIX - Get metadata from energyCache deviceData\r\n        // The energyCache should have all fields from ThingsBoard entity\r\n        const device = {\r\n          deviceType: deviceData.deviceType || deviceData.type || '',\r\n          deviceProfile: deviceData.deviceProfile || deviceData.additionalInfo?.deviceProfile || '',\r\n          deviceIdentifier:\r\n            deviceData.deviceIdentifier ||\r\n            deviceData.additionalInfo?.deviceIdentifier ||\r\n            deviceData.name ||\r\n            '',\r\n          name: deviceData.name || deviceData.entityName || '',\r\n          labelOrName: label,\r\n          label: label,\r\n        };\r\n\r\n        const type = classifyEquipmentDetailed(device);\r\n        groups[type] = (groups[type] || 0) + consumption;\r\n        deviceCounters[type] = (deviceCounters[type] || 0) + 1;\r\n\r\n        // RFC-0076: Enhanced logging - Log ALL devices that could be elevators\r\n        const couldBeElevator =\r\n          deviceData.deviceType === '3F_MEDIDOR' ||\r\n          deviceData.type === '3F_MEDIDOR' ||\r\n          deviceData.deviceType === 'ELEVADOR' ||\r\n          deviceData.type === 'ELEVADOR' ||\r\n          (deviceData.deviceProfile && deviceData.deviceProfile.toUpperCase() === 'ELEVADOR') ||\r\n          (deviceData.additionalInfo?.deviceProfile &&\r\n            deviceData.additionalInfo.deviceProfile.toUpperCase() === 'ELEVADOR') ||\r\n          (deviceData.name && deviceData.name.toUpperCase().includes('ELV'));\r\n\r\n        // RFC-0076: Log first 30 devices for debugging (increased from 10)\r\n        if (sampleCount < 30 || couldBeElevator) {\r\n          LogHelper.log(\r\n            `[ENERGY] 🔍 Device classification ${couldBeElevator ? '⚡ ELEVATOR CANDIDATE' : 'sample'} #${\r\n              sampleCount + 1\r\n            }:`,\r\n            {\r\n              name: deviceData.name,\r\n              ingestionId: ingestionId,\r\n              deviceType: deviceData.deviceType,\r\n              deviceProfile: deviceData.deviceProfile,\r\n              deviceIdentifier: deviceData.deviceIdentifier,\r\n              additionalInfo: deviceData.additionalInfo,\r\n              label: label,\r\n              classified: type,\r\n              consumption: consumption,\r\n              deviceObject: device,\r\n              namePattern: {\r\n                hasELV: label.toUpperCase().includes('ELV'),\r\n                hasELEVADOR: label.toUpperCase().includes('ELEVADOR'),\r\n                hasESRL: label.toUpperCase().includes('ESRL'),\r\n                hasESCADA: label.toUpperCase().includes('ESCADA'),\r\n                hasCAG:\r\n                  (deviceData.name || '').toUpperCase().includes('CAG') ||\r\n                  label.toUpperCase().includes('CAG'),\r\n                hasMOTR: label.toUpperCase().includes('MOTR'),\r\n              },\r\n            }\r\n          );\r\n          if (!couldBeElevator) sampleCount++;\r\n        }\r\n\r\n        // RFC-0076: Log Elevadores and Escadas Rolantes specifically\r\n        if (type === 'Elevadores' || type === 'Escadas Rolantes') {\r\n          LogHelper.log(`[ENERGY] ✅ Found ${type}:`, {\r\n            name: deviceData.name,\r\n            deviceType: deviceData.deviceType,\r\n            deviceProfile: deviceData.deviceProfile,\r\n            consumption: consumption,\r\n            classifiedBy: 'name-pattern',\r\n          });\r\n        }\r\n      });\r\n\r\n      // RFC-0076: Enhanced logging for debugging\r\n      LogHelper.log('[ENERGY] ============================================');\r\n      LogHelper.log('[ENERGY] Distribution by groups (RFC-0076):');\r\n      LogHelper.log(\r\n        '[ENERGY] - Total devices processed:',\r\n        workingCache.size,\r\n        hasFilter ? `(filtered from ${energyCache.size})` : ''\r\n      );\r\n      LogHelper.log('[ENERGY] - Lojas from orchestrator:', lojasIngestionIds.size);\r\n      LogHelper.log('[ENERGY] Device counts by category:');\r\n      Object.entries(deviceCounters).forEach(([cat, count]) => {\r\n        LogHelper.log(`[ENERGY]   - ${cat}: ${count} devices, ${groups[cat].toFixed(2)} kWh`);\r\n      });\r\n      LogHelper.log('[ENERGY] Distribution breakdown (consumption):', groups);\r\n\r\n      // RFC-0076: Warning and diagnostic info if no elevators found\r\n      if (deviceCounters['Elevadores'] === 0) {\r\n        LogHelper.warn('[ENERGY] ⚠️  No elevators detected in energyCache. Possible causes:');\r\n        LogHelper.warn('[ENERGY]     1. Elevators may not have energy measurement devices');\r\n        LogHelper.warn('[ENERGY]     2. Elevator devices may not be included in /energy/devices/totals API');\r\n        LogHelper.warn('[ENERGY]     3. deviceType/deviceProfile metadata may be missing from energyCache');\r\n        LogHelper.warn('[ENERGY]     4. Elevator naming convention may differ from expected patterns');\r\n        LogHelper.warn(\"[ENERGY]     Expected patterns: 'ELEVADOR', 'ELEVATOR', 'ELV' in device name/label\");\r\n\r\n        // Print sample of \"Outros Equipamentos\" to help identify misclassified elevators\r\n        LogHelper.log(\"[ENERGY] 📋 Sample of 'Outros Equipamentos' (first 20 devices):\");\r\n        let othersCount = 0;\r\n        workingCache.forEach((deviceData, ingestionId) => {\r\n          if (!lojasIngestionIds.has(ingestionId) && othersCount < 20) {\r\n            const label = String(\r\n              deviceData.label || deviceData.entityLabel || deviceData.entityName || deviceData.name || ''\r\n            ).toLowerCase();\r\n            const device = {\r\n              deviceType: deviceData.deviceType || '',\r\n              deviceProfile: deviceData.deviceProfile || '',\r\n              deviceIdentifier: deviceData.deviceIdentifier || '',\r\n              name: deviceData.name || '',\r\n              labelOrName: label,\r\n              label: label,\r\n            };\r\n            const classification = classifyEquipmentDetailed(device);\r\n            if (classification === 'Outros Equipamentos') {\r\n              LogHelper.log(\r\n                `[ENERGY]    - \"${deviceData.name || label}\" (deviceType: ${device.deviceType}, profile: ${\r\n                  device.deviceProfile\r\n                })`\r\n              );\r\n              othersCount++;\r\n            }\r\n          }\r\n        });\r\n      }\r\n\r\n      LogHelper.log('[ENERGY] ============================================');\r\n\r\n      return groups;\r\n    } else {\r\n      // Por shopping para tipo específico\r\n      let equipmentType;\r\n      switch (mode) {\r\n        case 'elevators':\r\n          equipmentType = 'Elevadores';\r\n          break;\r\n        case 'escalators':\r\n          equipmentType = 'Escadas Rolantes';\r\n          break;\r\n        case 'hvac':\r\n          equipmentType = 'Climatização';\r\n          break;\r\n        case 'others':\r\n          equipmentType = 'Outros Equipamentos';\r\n          break;\r\n        case 'stores':\r\n          equipmentType = 'Lojas';\r\n          break;\r\n        default:\r\n          equipmentType = 'Elevadores';\r\n      }\r\n\r\n      // Get lojas IDs from orchestrator (same logic as MAIN uses)\r\n      const lojasIngestionIds = orchestrator.getLojasIngestionIds?.() || new Set();\r\n\r\n      // Agrupar por shopping\r\n      const shoppingDistribution = {};\r\n\r\n      workingCache.forEach((deviceData, ingestionId) => {\r\n        const consumption = Number(deviceData.total_value) || 0;\r\n        let type;\r\n\r\n        // RFC-0076: Check if it's a loja first (using same logic as MAIN)\r\n        if (lojasIngestionIds.has(ingestionId)) {\r\n          type = 'Lojas';\r\n        } else {\r\n          // Classify equipment (includes deviceProfile, deviceIdentifier and name)\r\n          const label = String(\r\n            deviceData.label || deviceData.entityLabel || deviceData.entityName || deviceData.name || ''\r\n          ).toLowerCase();\r\n          const device = {\r\n            deviceType: deviceData.deviceType || '',\r\n            deviceProfile: deviceData.deviceProfile || '',\r\n            deviceIdentifier: deviceData.deviceIdentifier || '',\r\n            name: deviceData.name || '',\r\n            labelOrName: label,\r\n            label: label,\r\n          };\r\n          type = classifyEquipmentDetailed(device);\r\n        }\r\n\r\n        // Só incluir se for do tipo selecionado\r\n        if (type === equipmentType) {\r\n          const customerId = deviceData.customerId;\r\n          const shoppingName = getShoppingName(customerId);\r\n\r\n          shoppingDistribution[shoppingName] = (shoppingDistribution[shoppingName] || 0) + consumption;\r\n        }\r\n      });\r\n\r\n      LogHelper.log(\r\n        `[ENERGY] Distribution by ${mode}${hasFilter ? ' (filtered)' : ''}:`,\r\n        shoppingDistribution\r\n      );\r\n      return shoppingDistribution;\r\n    }\r\n  } catch (error) {\r\n    LogHelper.error('[ENERGY] Error calculating distribution by mode:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Obtém o nome do shopping pelo customerId\r\n */\r\nfunction getShoppingName(customerId) {\r\n  if (!customerId) return 'Sem Shopping';\r\n\r\n  // Priority 1: Try to get from energyCache (has customerName from API /totals)\r\n  const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n  if (orchestrator && typeof orchestrator.getEnergyCache === 'function') {\r\n    const energyCache = orchestrator.getEnergyCache();\r\n\r\n    // Find any device with this customerId and get customerName\r\n    for (const [ingestionId, deviceData] of energyCache) {\r\n      if (deviceData.customerId === customerId && deviceData.customerName) {\r\n        return deviceData.customerName;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Priority 2: Tentar buscar dos customers carregados\r\n  if (window.custumersSelected && Array.isArray(window.custumersSelected)) {\r\n    const shopping = window.custumersSelected.find((c) => c.value === customerId);\r\n    if (shopping) return shopping.name;\r\n  }\r\n\r\n  // Priority 3: Tentar buscar do ctx\r\n  if (self.ctx.$scope?.custumer && Array.isArray(self.ctx.$scope.custumer)) {\r\n    const shopping = self.ctx.$scope.custumer.find((c) => c.value === customerId);\r\n    if (shopping) return shopping.name;\r\n  }\r\n\r\n  // Fallback\r\n  return `Shopping ${customerId.substring(0, 8)}...`;\r\n}\r\n\r\n/**\r\n * RFC-0098: Data fetching adapter for the standardized Consumption7DaysChart component\r\n * Wraps existing fetch logic to conform to the component's expected interface\r\n * @param {number} period - Number of days to fetch\r\n * @returns {Promise<object>} - Consumption7DaysData formatted data\r\n */\r\nasync function fetchConsumptionDataAdapter(period) {\r\n  LogHelper.log('[ENERGY] [RFC-0098] Fetching data via adapter for', period, 'days');\r\n\r\n  // Get customer ID from MAIN (exposed via window.myioHoldingCustomerId)\r\n  const customerId = window.myioHoldingCustomerId;\r\n  if (!customerId) {\r\n    LogHelper.error(\r\n      '[ENERGY] [RFC-0098] ❌ customerId not found - MAIN has not initialized window.myioHoldingCustomerId'\r\n    );\r\n    return { labels: [], dailyTotals: [], shoppingData: {}, shoppingNames: {} };\r\n  }\r\n\r\n  // Get filtered shopping IDs or use widget's customerId\r\n  const selectedShoppingIds = getSelectedShoppingIds();\r\n  const customerIds = selectedShoppingIds.length > 0 ? selectedShoppingIds : [customerId];\r\n\r\n  // Update chartConfig period for compatibility with existing modal\r\n  chartConfig.period = period;\r\n\r\n  // Use existing fetch logic\r\n  const data = await fetch7DaysConsumptionFiltered(customerIds, true);\r\n\r\n  return {\r\n    labels: data.labels || [],\r\n    dailyTotals: data.dailyTotals || [],\r\n    shoppingData: data.shoppingData || {},\r\n    shoppingNames: data.shoppingNames || {},\r\n    fetchTimestamp: Date.now(),\r\n    customerIds: customerIds,\r\n  };\r\n}\r\n\r\n/**\r\n * Inicializa os gráficos com dados reais\r\n * RFC-0098: Now uses createConsumption7DaysChart for the line chart\r\n */\r\nasync function initializeCharts() {\r\n  LogHelper.log('[ENERGY] [RFC-0098] Initializing charts with standardized component...');\r\n\r\n  // Get customer ID from MAIN (exposed via window.myioHoldingCustomerId)\r\n  const customerId = window.myioHoldingCustomerId;\r\n\r\n  if (!customerId) {\r\n    LogHelper.error(\r\n      '[ENERGY] [RFC-0098] ❌ customerId not found - MAIN has not initialized window.myioHoldingCustomerId'\r\n    );\r\n    return;\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Customer ID (from MAIN):', customerId);\r\n\r\n  // Get widget container for ThingsBoard compatibility (shared by all widgets)\r\n  const $container = self.ctx?.$container || null;\r\n\r\n  // RFC-0098: Initialize line chart using the standardized widget component\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.createConsumptionChartWidget) {\r\n    LogHelper.log('[ENERGY] [RFC-0098] Using createConsumptionChartWidget component');\r\n\r\n    consumptionChartInstance = MyIOLibrary.createConsumptionChartWidget({\r\n      domain: 'energy',\r\n      containerId: 'energy-chart-widget',\r\n      title: 'Consumo de Energia - 7 dias',\r\n      unit: 'kWh',\r\n      unitLarge: 'MWh',\r\n      thresholdForLargeUnit: 1000,\r\n      decimalPlaces: 1,\r\n      chartHeight: 280,\r\n      defaultPeriod: chartConfig.period || 7,\r\n      defaultChartType: chartConfig.chartType || 'line',\r\n      defaultVizMode: chartConfig.vizMode || 'total',\r\n      theme: 'light',\r\n      $container: $container,\r\n\r\n      // Data fetching via adapter\r\n      fetchData: fetchConsumptionDataAdapter,\r\n\r\n      // Callbacks\r\n      onMaximizeClick: () => {\r\n        LogHelper.log('[ENERGY] [RFC-0098] Maximize button clicked');\r\n        openFullscreenModal();\r\n      },\r\n      onDataLoaded: (data) => {\r\n        // Update cache for fullscreen and other features\r\n        cachedChartData = data;\r\n        LogHelper.log('[ENERGY] [RFC-0098] Data loaded:', data.labels?.length, 'days');\r\n      },\r\n      onError: (error) => {\r\n        LogHelper.error('[ENERGY] [RFC-0098] Chart error:', error);\r\n      },\r\n    });\r\n\r\n    // Render the chart\r\n    await consumptionChartInstance.render();\r\n    LogHelper.log('[ENERGY] [RFC-0098] Consumption chart rendered successfully');\r\n\r\n    // Store reference for compatibility with existing code\r\n    lineChartInstance = consumptionChartInstance.getChartInstance();\r\n  } else {\r\n    LogHelper.error('[ENERGY] [RFC-0098] createConsumptionChartWidget not available in MyIOLibrary!');\r\n    return;\r\n  }\r\n\r\n  // RFC-0102: Initialize distribution chart using createDistributionChartWidget\r\n  if (typeof MyIOLibrary !== 'undefined' && MyIOLibrary.createDistributionChartWidget) {\r\n    LogHelper.log('[ENERGY] [RFC-0102] Initializing distribution chart widget...');\r\n\r\n    distributionChartInstance = MyIOLibrary.createDistributionChartWidget({\r\n      domain: 'energy',\r\n      containerId: 'energy-distribution-widget',\r\n      title: 'Distribuição de Energia',\r\n      unit: 'kWh',\r\n      unitLarge: 'MWh',\r\n      thresholdForLargeUnit: 1000,\r\n      decimalPlaces: 2,\r\n      chartHeight: 300,\r\n      theme: 'light',\r\n      $container: $container,\r\n\r\n      // Visualization modes\r\n      modes: [\r\n        { value: 'groups', label: 'Por Grupos de Equipamentos' },\r\n        { value: 'elevators', label: 'Elevadores por Shopping' },\r\n        { value: 'escalators', label: 'Escadas Rolantes por Shopping' },\r\n        { value: 'hvac', label: 'Climatização por Shopping' },\r\n        { value: 'others', label: 'Outros Equipamentos por Shopping' },\r\n        { value: 'stores', label: 'Lojas por Shopping' },\r\n      ],\r\n      defaultMode: 'groups',\r\n\r\n      // Data fetching - uses existing calculateDistributionByMode function\r\n      fetchDistribution: async (mode) => {\r\n        LogHelper.log(`[ENERGY] [RFC-0102] Fetching distribution for mode: ${mode}`);\r\n        return await calculateDistributionByMode(mode);\r\n      },\r\n\r\n      // Get shopping colors from orchestrator for consistency\r\n      getShoppingColors: () => {\r\n        const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n        return orchestrator?.getShoppingColors?.() || null;\r\n      },\r\n\r\n      // Callbacks\r\n      onModeChange: (mode) => {\r\n        LogHelper.log(`[ENERGY] [RFC-0102] Distribution mode changed to: ${mode}`);\r\n      },\r\n      onDataLoaded: (data) => {\r\n        LogHelper.log('[ENERGY] [RFC-0102] Distribution data loaded:', Object.keys(data).length, 'items');\r\n      },\r\n      onError: (error) => {\r\n        LogHelper.error('[ENERGY] [RFC-0102] Distribution chart error:', error);\r\n      },\r\n    });\r\n\r\n    // Render the distribution chart after a delay to ensure orchestrator is ready\r\n    setTimeout(async () => {\r\n      try {\r\n        await distributionChartInstance.render();\r\n        LogHelper.log('[ENERGY] [RFC-0102] Distribution chart rendered successfully');\r\n\r\n        // Store legacy reference for backwards compatibility\r\n        pieChartInstance = distributionChartInstance.getChartInstance();\r\n      } catch (error) {\r\n        LogHelper.error('[ENERGY] [RFC-0102] Failed to render distribution chart:', error);\r\n      }\r\n\r\n      // RFC-0098: Setup chart tab handlers (now using component API)\r\n      setupChartTabHandlersRFC0098();\r\n    }, 2000); // Delay to ensure orchestrator is ready\r\n  } else {\r\n    LogHelper.error('[ENERGY] [RFC-0102] createDistributionChartWidget not available in MyIOLibrary!');\r\n  }\r\n}\r\n\r\n/**\r\n * RFC-0098: Setup chart tab handlers\r\n * NOTE: The createConsumptionChartWidget component now handles tabs internally.\r\n * This function is kept for backwards compatibility with external tabs if present.\r\n */\r\nfunction setupChartTabHandlersRFC0098() {\r\n  // RFC-0098: The widget component injects its own tabs, so external tabs may not exist\r\n  // If external tabs are present, sync them with the widget API\r\n  const vizTabs = document.querySelectorAll('.viz-mode-tabs .chart-tab');\r\n  const typeTabs = document.querySelectorAll('.chart-type-tabs .chart-tab');\r\n\r\n  if (vizTabs.length === 0 && typeTabs.length === 0) {\r\n    LogHelper.log('[ENERGY] [RFC-0098] No external tabs found - widget handles tabs internally');\r\n    return;\r\n  }\r\n\r\n  // Setup external vizMode tabs (if present)\r\n  vizTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      vizTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newVizMode = tab.dataset.viz;\r\n      chartConfig.vizMode = newVizMode;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setVizMode === 'function') {\r\n        consumptionChartInstance.setVizMode(newVizMode);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Setup external chartType tabs (if present)\r\n  typeTabs.forEach((tab) => {\r\n    tab.addEventListener('click', () => {\r\n      typeTabs.forEach((t) => t.classList.remove('active'));\r\n      tab.classList.add('active');\r\n\r\n      const newChartType = tab.dataset.type;\r\n      chartConfig.chartType = newChartType;\r\n\r\n      if (consumptionChartInstance && typeof consumptionChartInstance.setChartType === 'function') {\r\n        consumptionChartInstance.setChartType(newChartType);\r\n      }\r\n    });\r\n  });\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0098] External tab handlers setup (if present)');\r\n}\r\n\r\n/**\r\n * RFC-0097: Fetch consumption for configured period (respects shopping filter and chart config)\r\n * Returns data structured for caching and re-rendering\r\n * OPTIMIZED: Makes only N API calls (one per shopping) instead of N x Days\r\n */\r\nasync function fetch7DaysConsumptionFiltered(customerIds, forceRefresh = false) {\r\n  if (!customerIds || customerIds.length === 0) {\r\n    return { labels: [], dailyTotals: [], shoppingData: {}, shoppingNames: {} };\r\n  }\r\n\r\n  // RFC-0097: Use configured period or default to 7 days\r\n  const period = chartConfig.period || 7;\r\n  const granularity = chartConfig.granularity || '1d';\r\n\r\n  // RFC-0097: Check if cache is valid (same customerIds and not expired)\r\n  if (!forceRefresh && cachedChartData && cachedChartData.fetchTimestamp) {\r\n    const cacheAge = Date.now() - cachedChartData.fetchTimestamp;\r\n    const sameCustomers =\r\n      cachedChartData.customerIds &&\r\n      cachedChartData.customerIds.length === customerIds.length &&\r\n      cachedChartData.customerIds.every((id) => customerIds.includes(id));\r\n\r\n    if (cacheAge < CHART_CACHE_TTL && sameCustomers) {\r\n      LogHelper.log('[ENERGY] [RFC-0097] Using cached data (age:', Math.round(cacheAge / 1000), 's)');\r\n      return cachedChartData;\r\n    }\r\n  }\r\n\r\n  LogHelper.log(\r\n    '[ENERGY] [RFC-0097] Fetching',\r\n    period,\r\n    'days with granularity',\r\n    granularity,\r\n    'for customers:',\r\n    customerIds\r\n  );\r\n\r\n  const shoppingData = {}; // { customerId: [values per day...] }\r\n  const shoppingNames = {}; // { customerId: name }\r\n\r\n  // Initialize shopping data\r\n  customerIds.forEach((cid) => {\r\n    shoppingData[cid] = [];\r\n    shoppingNames[cid] = getShoppingNameForFilter(cid);\r\n  });\r\n\r\n  // Calculate period start/end timestamps (full period, not per day)\r\n  const now = new Date();\r\n  const periodStart = new Date(now);\r\n  periodStart.setDate(now.getDate() - (period - 1));\r\n  periodStart.setHours(0, 0, 0, 0);\r\n  const startTs = periodStart.getTime();\r\n\r\n  const periodEnd = new Date(now);\r\n  periodEnd.setHours(23, 59, 59, 999);\r\n  const endTs = periodEnd.getTime();\r\n\r\n  // Build day labels and day boundaries for grouping\r\n  const dayBoundaries = []; // { label, startTs, endTs }\r\n  for (let i = 0; i < period; i++) {\r\n    const dayDate = new Date(periodStart);\r\n    dayDate.setDate(periodStart.getDate() + i);\r\n    dayDate.setHours(0, 0, 0, 0);\r\n\r\n    const dayStart = dayDate.getTime();\r\n    const dayEnd = new Date(dayDate);\r\n    dayEnd.setHours(23, 59, 59, 999);\r\n\r\n    const label = dayDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });\r\n    dayBoundaries.push({ label, startTs: dayStart, endTs: dayEnd.getTime() });\r\n  }\r\n\r\n  const labels = dayBoundaries.map((d) => d.label);\r\n\r\n  // OPTIMIZATION: Only N API calls (one per shopping for entire period)\r\n  LogHelper.log('[ENERGY] [RFC-0097] Executing', customerIds.length, 'API calls (one per shopping)...');\r\n\r\n  const fetchPromises = customerIds.map((customerId) =>\r\n    fetchPeriodConsumptionByDay(customerId, startTs, endTs, dayBoundaries)\r\n  );\r\n\r\n  const results = await Promise.all(fetchPromises);\r\n\r\n  // Process results - each result is an array of daily totals for that shopping\r\n  results.forEach((dailyValues, idx) => {\r\n    const customerId = customerIds[idx];\r\n    shoppingData[customerId] = dailyValues;\r\n  });\r\n\r\n  // Calculate daily totals (sum across all shoppings)\r\n  const dailyTotals = [];\r\n  for (let dayIdx = 0; dayIdx < period; dayIdx++) {\r\n    let dayTotal = 0;\r\n    for (const customerId of customerIds) {\r\n      dayTotal += shoppingData[customerId][dayIdx] || 0;\r\n    }\r\n    dailyTotals.push(dayTotal);\r\n  }\r\n\r\n  // RFC-0097: Store in cache for re-rendering\r\n  cachedChartData = {\r\n    labels,\r\n    dailyTotals,\r\n    shoppingData,\r\n    shoppingNames,\r\n    customerIds,\r\n    fetchTimestamp: Date.now(),\r\n  };\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0097] Data cached:', {\r\n    days: period,\r\n    shoppings: customerIds.length,\r\n    totalPoints: labels.length,\r\n    parallelCalls: fetchPromises.length,\r\n  });\r\n\r\n  return cachedChartData;\r\n}\r\n\r\n/**\r\n * RFC-0073: Helper to get shopping name for chart label\r\n */\r\nfunction getShoppingNameForFilter(customerId) {\r\n  if (window.custumersSelected && Array.isArray(window.custumersSelected)) {\r\n    const shopping = window.custumersSelected.find((c) => c.value === customerId);\r\n    if (shopping) return shopping.name;\r\n  }\r\n  return 'Shopping';\r\n}\r\n\r\n/**\r\n * RFC-0102: Atualiza o gráfico de distribuição usando o novo componente\r\n * @param {string} mode - Mode to display: \"groups\", \"elevators\", \"escalators\", \"hvac\", \"others\", \"stores\"\r\n * @deprecated Use distributionChartInstance.setMode() or distributionChartInstance.refresh() instead\r\n */\r\nasync function updatePieChart(mode = 'groups') {\r\n  // RFC-0102: Use the new distribution chart widget API\r\n  if (distributionChartInstance) {\r\n    try {\r\n      LogHelper.log(`[ENERGY] [RFC-0102] Updating distribution chart with mode: ${mode}`);\r\n      await distributionChartInstance.setMode(mode);\r\n    } catch (error) {\r\n      LogHelper.error('[ENERGY] [RFC-0102] Error updating distribution chart:', error);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Legacy fallback (should not be reached if component is initialized)\r\n  LogHelper.warn('[ENERGY] [RFC-0102] Distribution chart instance not available, legacy code path');\r\n}\r\n\r\n/**\r\n * RFC-0102: Distribution mode selector is now handled by the component internally\r\n * @deprecated The createDistributionChartWidget component handles mode selection internally\r\n */\r\nfunction setupDistributionModeSelector() {\r\n  // RFC-0102: Mode selector is now handled by createDistributionChartWidget component\r\n  // This function is kept for backwards compatibility but does nothing\r\n  LogHelper.log(\r\n    '[ENERGY] [RFC-0102] Distribution mode selector handled by component - skipping legacy setup'\r\n  );\r\n}\r\n\r\n// RFC-0098: Legacy chart functions removed - now using createConsumption7DaysChart component\r\n// RFC-0098: Legacy modal functions removed (openChartConfigModal, closeChartConfigModal, etc.) - settings handled by component\r\n// RFC-0098: initializeMockCharts removed - chart requires customerId and component\r\n\r\n// ============================================\r\n// MAIN INITIALIZATION\r\n// ============================================\r\n\r\n// RFC-0097: Guard to prevent multiple initializations and store handlers for cleanup\r\nlet energyWidgetInitialized = false;\r\nlet registeredHandlers = {\r\n  handleEnergySummary: null,\r\n  handleFilterApplied: null,\r\n  handleEquipmentMetadataEnriched: null,\r\n};\r\n\r\n/**\r\n * RFC-0097: Cleanup function to remove all event listeners\r\n */\r\nfunction cleanupEventListeners() {\r\n  if (registeredHandlers.handleEnergySummary) {\r\n    window.removeEventListener('myio:energy-summary-ready', registeredHandlers.handleEnergySummary);\r\n    if (window.parent !== window) {\r\n      window.parent.removeEventListener('myio:energy-summary-ready', registeredHandlers.handleEnergySummary);\r\n    }\r\n  }\r\n  if (registeredHandlers.handleFilterApplied) {\r\n    window.removeEventListener('myio:filter-applied', registeredHandlers.handleFilterApplied);\r\n    if (window.parent !== window) {\r\n      window.parent.removeEventListener('myio:filter-applied', registeredHandlers.handleFilterApplied);\r\n    }\r\n  }\r\n  if (registeredHandlers.handleEquipmentMetadataEnriched) {\r\n    window.removeEventListener(\r\n      'myio:equipment-metadata-enriched',\r\n      registeredHandlers.handleEquipmentMetadataEnriched\r\n    );\r\n    if (window.parent !== window) {\r\n      window.parent.removeEventListener(\r\n        'myio:equipment-metadata-enriched',\r\n        registeredHandlers.handleEquipmentMetadataEnriched\r\n      );\r\n    }\r\n  }\r\n  LogHelper.log('[ENERGY] [RFC-0097] Event listeners cleaned up');\r\n}\r\n\r\n// ============================================\r\n// WIDGET ENERGY - FUNÇÃO DE INICIALIZAÇÃO COMPLETA\r\n// ============================================\r\nself.onInit = async function () {\r\n  // RFC-0097: Prevent multiple initializations\r\n  if (energyWidgetInitialized) {\r\n    LogHelper.log('[ENERGY] [RFC-0097] Widget already initialized, skipping...');\r\n    return;\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] Initializing energy charts and consumption cards...');\r\n\r\n  // RFC-0097: Cleanup any existing listeners before adding new ones\r\n  cleanupEventListeners();\r\n\r\n  // 1. INICIALIZA A UI: Mostra os spinners de \"loading\" para o usuário.\r\n  // -----------------------------------------------------------------\r\n  initializeCharts();\r\n  initializeTotalConsumptionStoresCard(); // Novo: card de lojas\r\n  initializeTotalConsumptionEquipmentsCard(); // Novo: card de equipamentos\r\n  // initializePeakDemandCard(); // DESABILITADO TEMPORARIAMENTE\r\n\r\n  // 2. LÓGICA DO CARD \"CONSUMO TOTAL\": Pede os dados ao MAIN.\r\n  //    Este é o novo fluxo corrigido que resolve o problema do loading.\r\n  // -----------------------------------------------------------------\r\n\r\n  // Primeiro, prepara o \"ouvinte\" que vai receber os dados quando o MAIN responder.\r\n  // ✅ Listen on both window and window.parent to support both iframe and non-iframe contexts\r\n  registeredHandlers.handleEnergySummary = (ev) => {\r\n    LogHelper.log('[ENERGY] Resumo de energia recebido do orquestrador!', ev.detail);\r\n    // Chama as funções que atualizam os cards na tela com os dados recebidos.\r\n    updateTotalConsumptionStoresCard(ev.detail); // Novo: card de lojas\r\n    updateTotalConsumptionEquipmentsCard(ev.detail); // Novo: card de equipamentos\r\n  };\r\n\r\n  window.addEventListener('myio:energy-summary-ready', registeredHandlers.handleEnergySummary);\r\n\r\n  if (window.parent !== window) {\r\n    window.parent.addEventListener('myio:energy-summary-ready', registeredHandlers.handleEnergySummary);\r\n  }\r\n\r\n  // RFC-0073: Listen to shopping filter changes and update charts\r\n  registeredHandlers.handleFilterApplied = async (ev) => {\r\n    LogHelper.log('[ENERGY] [RFC-0073] Shopping filter applied, updating charts...', ev.detail);\r\n\r\n    // Invalidate cache when filter changes\r\n    cachedChartData = null;\r\n\r\n    // RFC-0102: Update distribution chart to reflect filtered data\r\n    if (distributionChartInstance) {\r\n      LogHelper.log('[ENERGY] [RFC-0102] Refreshing distribution chart after filter change');\r\n      await distributionChartInstance.refresh();\r\n    }\r\n\r\n    // RFC-0098: Update line chart using component API if available\r\n    if (consumptionChartInstance && typeof consumptionChartInstance.refresh === 'function') {\r\n      LogHelper.log('[ENERGY] [RFC-0098] Refreshing chart via component API');\r\n      await consumptionChartInstance.refresh(true); // Force refresh to bypass cache\r\n    } else {\r\n      LogHelper.error('[ENERGY] [RFC-0098] Component not available for refresh');\r\n    }\r\n  };\r\n\r\n  window.addEventListener('myio:filter-applied', registeredHandlers.handleFilterApplied);\r\n\r\n  if (window.parent !== window) {\r\n    window.parent.addEventListener('myio:filter-applied', registeredHandlers.handleFilterApplied);\r\n  }\r\n\r\n  // RFC-0076: Listen to equipment metadata enrichment from EQUIPMENTS widget\r\n  // This forces chart updates when EQUIPMENTS finishes enriching the cache with deviceType/deviceProfile\r\n  registeredHandlers.handleEquipmentMetadataEnriched = async (ev) => {\r\n    LogHelper.log('[ENERGY] [RFC-0076] 🔧 Equipment metadata enriched! Forcing chart update...', ev.detail);\r\n\r\n    // RFC-0102: Force immediate update of distribution chart to pick up elevator classifications\r\n    if (distributionChartInstance) {\r\n      LogHelper.log('[ENERGY] [RFC-0102] Refreshing distribution chart after metadata enrichment');\r\n      await distributionChartInstance.refresh();\r\n    }\r\n\r\n    LogHelper.log('[ENERGY] [RFC-0076] [RFC-0102] Charts updated with enriched metadata');\r\n  };\r\n\r\n  window.addEventListener(\r\n    'myio:equipment-metadata-enriched',\r\n    registeredHandlers.handleEquipmentMetadataEnriched\r\n  );\r\n\r\n  if (window.parent !== window) {\r\n    window.parent.addEventListener(\r\n      'myio:equipment-metadata-enriched',\r\n      registeredHandlers.handleEquipmentMetadataEnriched\r\n    );\r\n  }\r\n\r\n  // RFC-0097: Mark widget as initialized\r\n  energyWidgetInitialized = true;\r\n\r\n  // DEPOIS (NOVO CÓDIGO PARA O onInit DO WIDGET ENERGY)\r\n\r\n  // Em seguida, inicia um \"vigia\" que espera o Orquestrador ficar pronto.\r\n  const waitForOrchestratorAndRequestSummary = () => {\r\n    let attempts = 0;\r\n    const maxAttempts = 50; // Tenta por 10 segundos (50 * 200ms)\r\n\r\n    const intervalId = setInterval(() => {\r\n      attempts++;\r\n\r\n      // ✅ CORREÇÃO: Procura no \"quarto\" (window) E na \"sala principal\" (window.parent)\r\n      const orchestrator = window.MyIOOrchestrator || window.parent?.MyIOOrchestrator;\r\n\r\n      // VERIFICA SE O ORQUESTRADOR FOI ENCONTRADO EM UM DOS DOIS LUGARES\r\n      if (orchestrator && typeof orchestrator.requestSummary === 'function') {\r\n        // SUCESSO! Orquestrador encontrado.\r\n        clearInterval(intervalId); // Para de vigiar\r\n        LogHelper.log(`[ENERGY] Orquestrador encontrado após ${attempts} tentativas. Solicitando resumo.`);\r\n\r\n        // Chama a função do orquestrador encontrado\r\n        orchestrator.requestSummary();\r\n      } else if (attempts >= maxAttempts) {\r\n        // FALHA: Timeout\r\n        clearInterval(intervalId); // Para de vigiar\r\n        LogHelper.error(\r\n          '[ENERGY] TIMEOUT: Orquestrador não foi encontrado após 10 segundos. O card não será carregado.'\r\n        );\r\n      }\r\n    }, 200); // Verifica a cada 200ms\r\n  };\r\n\r\n  // Inicia o \"vigia\"\r\n  waitForOrchestratorAndRequestSummary();\r\n\r\n  // 4. OUTROS LISTENERS (Bônus): Mantém a robustez do widget.\r\n  // -----------------------------------------------------------------\r\n\r\n  // Limpa os caches se um evento global de limpeza for disparado.\r\n  window.addEventListener('myio:telemetry:clear', (ev) => {\r\n    LogHelper.log('[ENERGY] Evento de limpeza de cache recebido.', ev.detail);\r\n\r\n    // Reinicializa os cards para o estado de loading\r\n    initializeTotalConsumptionCard();\r\n    //initializePeakDemandCard();\r\n  });\r\n};\r\n\r\n// ============================================\r\n// WIDGET ENERGY - CLEANUP ON DESTROY\r\n// ============================================\r\n\r\nself.onDestroy = function () {\r\n  LogHelper.log('[ENERGY] [RFC-0073] Widget destroying, cleaning up modals');\r\n\r\n  // RFC-0073: Remove chart configuration modal if it exists\r\n  const globalContainer = document.getElementById('energyChartConfigModalGlobal');\r\n  if (globalContainer) {\r\n    const modal = globalContainer.querySelector('#chartConfigModal');\r\n    if (modal && modal._escHandler) {\r\n      document.removeEventListener('keydown', modal._escHandler);\r\n      modal._escHandler = null;\r\n    }\r\n\r\n    // Remove global modal container from document.body\r\n    globalContainer.remove();\r\n    LogHelper.log('[ENERGY] [RFC-0073] Global modal container removed on destroy');\r\n  }\r\n\r\n  // Remove modal-open class if widget is destroyed with modal open\r\n  document.body.classList.remove('modal-open');\r\n\r\n  // RFC-0097: Cleanup fullscreen mode if active\r\n  if (isChartFullscreen) {\r\n    closeFullscreenChart();\r\n    isChartFullscreen = false;\r\n  }\r\n\r\n  // RFC-0097: Remove fullscreen container from parent document\r\n  const targetDoc = window.parent?.document || document;\r\n  const fullscreenContainer = targetDoc.getElementById('energyChartFullscreenGlobal');\r\n  if (fullscreenContainer) {\r\n    fullscreenContainer.remove();\r\n    LogHelper.log('[ENERGY] [RFC-0097] Fullscreen container removed on destroy');\r\n  }\r\n\r\n  // RFC-0097: Cleanup event listeners and reset initialization flag\r\n  cleanupEventListeners();\r\n  energyWidgetInitialized = false;\r\n  cachedChartData = null;\r\n  isUpdatingLineChart = false;\r\n  pendingLineChartUpdate = null;\r\n\r\n  // RFC-0098: Cleanup consumption chart instance\r\n  if (consumptionChartInstance && typeof consumptionChartInstance.destroy === 'function') {\r\n    LogHelper.log('[ENERGY] [RFC-0098] Destroying consumption chart instance');\r\n    consumptionChartInstance.destroy();\r\n    consumptionChartInstance = null;\r\n  }\r\n\r\n  LogHelper.log('[ENERGY] [RFC-0097] Widget destroyed, state reset');\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"Settings\",\r\n    \"properties\": {},\r\n    \"required\": []\r\n  }\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Widget Head Office - ENERGY - v.5.2.0\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "e2f8a260-c974-11f0-84a2-1f4ed3957b2a"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}