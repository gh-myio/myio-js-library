[{"id":"becdaea7.25c7a","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"d415fa7.58cd708","type":"tab","label":"Monitoramento","disabled":false,"info":""},{"id":"89f6a7f4.954d2","type":"tab","label":"Old","disabled":false,"info":""},{"id":"24176e81.38a36a","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"cfa6c531.a6501","type":"tab","label":"Monitoramento","disabled":false,"info":""},{"id":"c84f852a.1a5f7","type":"tab","label":"Ingestion","disabled":false,"info":""},{"id":"2aa6d15a.9c1b9e","type":"group","z":"becdaea7.25c7a","name":"Check","style":{"label":true},"nodes":["839ab9d8.1527d8","9ca9ef0f.4a2ca","56bc2ba1.040794","32c45d3b.b0f9c2","7f780c40.ad45e4","69a79861.6bcc18","576dbbef.c8b814","c7e20ce1.fc6c6","b3c3a42e.37de88"],"x":34,"y":899,"w":912,"h":202},{"id":"6079ae30.11a","type":"group","z":"becdaea7.25c7a","name":"CENTRAL_UUID","style":{"label":true},"nodes":["fd385c3c.97816","89654428.c08bf8"],"x":2194,"y":359,"w":472,"h":82},{"id":"aa61127e.dfa2","type":"group","z":"becdaea7.25c7a","name":"MQTT","style":{"label":true},"nodes":["6a14f3b2.cd8b2c","5de6353b.c9836c","5678a6c3.be7e98","93ee4531.4db7d8","ca7c6620.0b5198","4f64022e.9cb7ec","3222e76f.436098","6f667024.d1f12","d533a111.18fe2","4fcbc1eb.eccfc","5921e588.5a6e3c","daa9d598.ad4b48","da6682b4.03803","3f51507f.fcbcb","ff932835.497da8","6e1ff75e.4dbe98","b502336.ae18dd","70ed4a2b.d46c74","9ed92e5.979edd","ce30e30e.34805","2ae9d86e.868248","22b7b982.5a8756","b2fd8c1e.51fb8"],"x":34,"y":339,"w":1402,"h":522},{"id":"c1cbadfb.e1717","type":"group","z":"becdaea7.25c7a","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#2e333a","fill-opacity":"0.75","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["40ba6155.b83af","7d8665fa.724d8c","53984edd.f5119","b03c073c.9439f8","850190cd.c6501","70bb562.5d3c1a8","f9313b64.f3bff8","b5cbc498.2c9f98","22d8c4dd.21622c","e380933.484de7","cc8a241.442b0d8","9ccf073c.e28b58","26b20f6e.45125","bdb8c20f.cd761","684edfe7.206f7","8910a6ba.4492b8","6caba71c.7eb1e8","cefe1d3.9c357e","3ee80cbe.1a0c94","cfb585fb.952da8","c0abbc64.2befb","3d46bc65.73bdc4","6f72d925.cfdcd8","228622e2.42571e","9776ddb5.6c8a2","86e2b266.9d4d2","8ede833.ea3028","fb04ecea.1cde8","bffada98.675438","bc7b91f1.4e901","a19ffb44.9bc388","7ad0b4ce.eed08c","51ffd916.0ff668","4ce03ed0.51ace","4c2782a3.24b03c","3ac1e674.d1f2ea"],"x":34,"y":1299,"w":832,"h":622},{"id":"67e6d874.0be2b8","type":"group","z":"becdaea7.25c7a","name":"Thingsboard","style":{"label":true},"nodes":["9e1f3d18.d0c9b","a0e942b2.80ccc","fd779987.067b58","dd87d608.186da8","bf146f56.27e28","c7d9af0d.01512","7cfeedaf.f39904"],"x":1514,"y":339,"w":632,"h":222},{"id":"b095103f.6b3f6","type":"group","z":"becdaea7.25c7a","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#2e333a","fill-opacity":"0.75","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["33473175.074c4e","e5b8cecc.efa3f","5dfbd516.aa87fc","5a1369c5.4648e8","ed9931d4.f5849","ff513e91.b729b","e95795f7.55d038","dc362b94.84e168","7f760094.afd2e","dda47afd.ea5c08","908a2120.21e11","64a6e668.c469b8","d484c241.7c79b","88381070.aca0e","7dc27e43.7f419","56b48147.4676a","f1abc7b5.c8ae68","2055050f.73cb8a","824be4a7.e851e8","3f59333b.4fae3c","c63564f6.89a668"],"x":34,"y":2519,"w":932,"h":282},{"id":"6aa2d64c.7c2d58","type":"group","z":"becdaea7.25c7a","name":"Store devices to flow.devices","style":{"label":true},"nodes":["9d296fb6.8302b","ea3c563b.84ebe8","bb638599.31abb8","dbf10ba.b4181f8","b0d36d.d7896c9","958abd31.7566","2129af69.05ed6","ad1d0e33.cf6f5","ef9886d5.21dae8","ff965f7e.d53cb","5d952e9b.da68e","12c16f62.71ddb1","5820ee2f.90f","7a39ceb3.28125"],"x":34,"y":39,"w":1932,"h":182},{"id":"9537256a.e8bc68","type":"group","z":"becdaea7.25c7a","name":"Get pulses every 1 min","style":{"label":true},"nodes":["bf0570b5.73ee8","786014a5.2c487c","2920c7dd.625ff8","909d4384.2ad36","7416219b.e3dc5","66ad4504.e5fd3c","f2e09fc0.c5039","79add3dc.46d82c","9b58ea20.906e18","a3621c83.8b462","bdca7b0c.2358b8"],"x":994,"y":899,"w":962,"h":122},{"id":"3488480d.8a4888","type":"group","z":"cfa6c531.a6501","name":"Missing Hidrometers","style":{"label":true},"nodes":["e287aea.020775","1ae58005.a6705","69005efc.325c88","a4be6daf.1257","c44b1414.263848","83059dc8.5ea2c","883e9978.1a8128","c6b0ff65.504458"],"x":34,"y":239},{"id":"59e68346.37013c","type":"group","z":"cfa6c531.a6501","name":"Central Monitor","style":{"label":true},"nodes":["1f7588e.71ee5f7","11b04527.73d1e3","e3d34de7.44dd8","6b49f332.e9bbfc","e841fec1.cdc68","afbb6659.b698c","62d2ea4a.edcf1c"],"x":34,"y":39},{"id":"6c0d0c03.5bd6c4","type":"group","z":"cfa6c531.a6501","name":"Missing Energy","style":{"label":true},"nodes":["16ad5c47.76e67c","50d5633c.283da4","a85ffd35.087aa","6543a13c.2d431","48c2ced2.547028","f821427b.0044e","7edaf6c7.ed4828","8a5c96c9.c03488"],"x":34,"y":459},{"id":"dffe1eb8.eb0158","type":"group","z":"becdaea7.25c7a","name":"Get Wh3 every 15 minutes","style":{"label":true},"nodes":["717dba9f.c290f4","8340a25c.0361a","4d19dd7e.fc5f2c","86a98892.5a7788","8d5ae88e.485648","b24ac173.c0fea8","57ea04d2.9c7b0c","e0d3780b.06cb6","8dd32a76.4646e8","191334e9.0d8d33","4b14d1c0.5df5b8","70fd2ab.092e054","303029f.2d4c056","d02c07a8.717f28","5450fb0f.aade34","cc2bc090.e2d078","176d870f.fcf6a1"],"x":34,"y":2879,"w":1152,"h":222},{"id":"9833aba1.1eba1","type":"group","z":"becdaea7.25c7a","style":{"stroke":"#2e333a","stroke-opacity":"1","fill":"#2e333a","fill-opacity":"0.75","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["7b58de6a.a6f2a","832254c1.0f7ee8","beafe48d.eb7488","e20d79bf.1fa0b8","94334f91.8fc64"],"x":34,"y":3339,"w":932,"h":162},{"id":"8265624b.5df1","type":"group","z":"becdaea7.25c7a","name":"","style":{"label":true},"nodes":["8963802e.bc5f7","7e046cea.8711ec","a6332aa3.034868","6b606767.4339d","82888aa0.34bb48","1276eff8.2a76c"],"x":34,"y":3819,"w":1072,"h":142},{"id":"1f056320.d796b5","type":"group","z":"becdaea7.25c7a","name":"","style":{"label":true},"nodes":["a5354b50.e84cc","f4fa4c9d.9f797","973e9b8e.4c2a98","f5604d2d.53f7a","899c9dd7.fb5828","e6934534.f8c3d8","c85e014e.db7e2","b5c15d36.625ad","a9200fa9.d5ba5","a14d4f7b.b6da28","45a4609c.4ca448","7aae873d.1506e8","bc8c9907.5035d8","a665d4c0.e8edb","33825453.a2a73c","cb4166bd.821838","5cd1f548.c8a5f4","26e3b2c.fb57c4e","9eafb180.81f1c8"],"x":34,"y":3519,"w":1072,"h":302},{"id":"43536f5a.fc53e8","type":"group","z":"becdaea7.25c7a","name":"Fix values in database","style":{"label":true},"nodes":["d7384028.d9a628","3cb14d52.779ef2","bef9faab.220a38","5f3d9fbb.8b94f","f8427433.14813","ab573c18.a5b0e","d3488100.e8789"],"x":1234,"y":2519,"w":932,"h":122},{"id":"e2863feb.d7fdd","type":"group","z":"becdaea7.25c7a","name":"SYNC DEVICE STATUS TO THINGSBOARD","style":{"label":true},"nodes":["c458485c.65d7c8","5c3ce61f.fa496","9c673c08.6b5598","1922c7b3.d9d89"],"x":1514,"y":599,"w":362,"h":222},{"id":"379d0ae0.f07416","type":"group","z":"becdaea7.25c7a","name":"ATTRIBUTES_SYNC","style":{"label":true},"nodes":["99ad4a97.1830b","8b368a4a.820378","e30987e3.419318","b6f479bd.df8be8","5d6f6a1.506d614","9ff3e56f.a1e2a8"],"x":1954,"y":599,"w":612,"h":242},{"id":"ba7623fd.d47d2","type":"mqtt-broker","z":"","name":"Thingsboard","broker":"mqtt.myio-bas.com","port":"1883","clientid":"gymrs1uec369jdzdwgoh","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"bc2be450.1f54a8","type":"postgreSQLConfig","z":"","name":"Myio","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"c3259202.9eb35","type":"postgreSQLConfig","z":"53f99bff.c6d4b4","name":"Myio","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"2c45df63.f68c4","type":"postgreSQLConfig","z":"","name":"DB","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"fe0bbd9.5bb3e4","type":"postgreSQLConfig","name":"","host":"127.0.0.1","hostFieldType":"str","port":"5432","portFieldType":"num","database":"hubot","databaseFieldType":"str","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"hubot","userFieldType":"str","password":"teta","passwordFieldType":"str"},{"id":"b7242f71.79e57","type":"postgreSQLConfig","z":"","name":"DB","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"96d7818b.f1efc","type":"postgreSQLConfig","z":"","name":"","host":"127.0.0.1","hostFieldType":"str","port":"5432","portFieldType":"num","database":"hubot","databaseFieldType":"str","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"hubot","userFieldType":"str","password":"hubot","passwordFieldType":"str"},{"id":"39cf2c0b.db0a44","type":"postgreSQLConfig","z":"becdaea7.25c7a","name":"DB","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"2c9b8cee.257e44","type":"postgreSQLConfig","z":"","name":"Myio","host":"DB_HOST","hostFieldType":"env","port":"DB_PORT","portFieldType":"env","database":"DB_DATABASE","databaseFieldType":"env","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"DB_USERNAME","userFieldType":"env","password":"DB_PASSWORD","passwordFieldType":"env"},{"id":"6eac0185.312bb","type":"postgreSQLConfig","z":"","name":"","host":"127.0.0.1","hostFieldType":"str","port":"5432","portFieldType":"num","database":"hubot","databaseFieldType":"str","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"hubot","userFieldType":"str","password":"hubot","passwordFieldType":"str"},{"id":"e119bc39.937ae8","type":"postgreSQLConfig","z":"becdaea7.25c7a","name":"","host":"127.0.0.1","hostFieldType":"str","port":"5432","portFieldType":"num","database":"hubot","databaseFieldType":"str","ssl":"false","sslFieldType":"bool","applicationName":"","applicationNameType":"str","max":"10","maxFieldType":"num","idle":"1000","idleFieldType":"num","connectionTimeout":"10000","connectionTimeoutFieldType":"num","user":"hubot","userFieldType":"str","password":"teta","passwordFieldType":"str"},{"id":"2671f5e8.1472d2","type":"mqtt-broker","name":"Ingestion Myio","broker":"ingestion.myio-bas.com","port":1883,"clientid":"","usetls":false,"keepalive":60,"cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"f4b225a0.d1d85","type":"mqtt-broker","z":"","name":"Staging Ingestion","broker":"staging.ingestion.myio-bas.com","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"e2b71376.50c688","type":"mqtt-broker","z":"","name":"Production Ingestion","broker":"data.myio-bas.com","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"1afbccb0.7121f3","type":"mqtt-config","z":"","name":"Myio BAS","broker":"mqtt.data.apps.myio-bas.com","port":"1883","username":"","password":""},{"id":"ef15ab35.aa9ac8","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":1180,"wires":[["78b01bb6.a0b754"]]},{"id":"78b01bb6.a0b754","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT * FROM slaves;","postgreSQLConfig":"bc2be450.1f54a8","split":false,"rowsPerMsg":1,"outputs":1,"x":350,"y":1180,"wires":[["9022882c.20d648"]]},{"id":"4d0ce037.2aa2b","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n    time_bucket('15 minutes', timestamp) AS bucket,\n    SUM(value) AS total_value\nFROM\n    consumption_realtime\nWHERE\n    slave_id = {{ msg.slave_id }}\n    AND timestamp >= NOW() - INTERVAL '1 month'\n    AND timestamp <= NOW()\nGROUP BY\n    bucket\nORDER BY\n    bucket;\n","postgreSQLConfig":"bc2be450.1f54a8","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1220,"wires":[["ad4b167d.409e38"]]},{"id":"e89c28bf.08e868","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":1220,"wires":[["f6254031.bbbec"]]},{"id":"f6254031.bbbec","type":"function","z":"becdaea7.25c7a","name":"","func":"const slaves = flow.get('slaves') || [];\n\nif (this.currIndex == null) {\n    this.currIndex = 0;\n}\n\nif (slaves.length === 0) {\n    return null;\n}\n\n\n\nconst slave = slaves[this.currIndex];\n\nif (this.currIndex < slaves.length) {\n    this.currIndex = this.currIndex + 1;\n} else {\n    this.currIndex = 0;\n}\n\nmsg.slave_id = slave.id;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":340,"y":1220,"wires":[["4d0ce037.2aa2b"]]},{"id":"9022882c.20d648","type":"change","z":"becdaea7.25c7a","name":"","rules":[{"t":"set","p":"slaves","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":555,"y":1180,"wires":[[]],"l":false},{"id":"ad4b167d.409e38","type":"function","z":"becdaea7.25c7a","name":"","func":"msg.payload = {\n    [msg.slave.name]: msg.payload.map((reading) => ({\n        ts: new Date(reading.bucket).getTime(),\n        values: {\n            Wh: reading.total_value,\n        }\n    }))\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":1220,"wires":[["cdd2bdae.eb3b5"]]},{"id":"cdd2bdae.eb3b5","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":850,"y":1220,"wires":[]},{"id":"f0f7989e.392e28","type":"http in","z":"becdaea7.25c7a","name":"Day with the lowest consumption","url":"/dash_api/day_with_lowest_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":170,"y":2240,"wires":[["72ac0cb5.5cad04"]]},{"id":"64c7c771.871608","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":620,"y":2240,"wires":[]},{"id":"ee6eeaf4.cf8f48","type":"http in","z":"becdaea7.25c7a","name":"Get Device Info","url":"/dash_api/device_details/:slave_id","method":"get","upload":false,"swaggerDoc":"","x":120,"y":2280,"wires":[["85855e63.93274"]]},{"id":"c6a55e98.51c78","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":620,"y":2280,"wires":[]},{"id":"72ac0cb5.5cad04","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM (\n    SELECT\n        time_bucket('1 hour', timestamp) AS timestamp,\n        AVG(value) AS value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    day\nORDER BY\n    total_consumption_kwh ASC\nLIMIT 1;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":450,"y":2240,"wires":[["64c7c771.871608"]]},{"id":"85855e63.93274","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT *\n  FROM slaves\n WHERE id = {{ msg.req.params.slave_id }}","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":450,"y":2280,"wires":[["c6a55e98.51c78"]]},{"id":"89b260fd.ace0d","type":"http in","z":"becdaea7.25c7a","name":"Min and Max demand","url":"/dash_api/demand/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":140,"y":2120,"wires":[["4faf8287.e1c4bc"]]},{"id":"4faf8287.e1c4bc","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,\n    MIN(min_hourly_value) AS min_daily_demand,\n    MAX(max_hourly_value) AS max_daily_demand\nFROM (\n    SELECT\n        time_bucket('1 hour', timestamp) AS timestamp,\n        MIN(value) AS min_hourly_value,\n        MAX(value) AS max_hourly_value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    day\nORDER BY\n    day;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":490,"y":2120,"wires":[["6793db43.b52064"]]},{"id":"6793db43.b52064","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":720,"y":2120,"wires":[]},{"id":"26f6655.a3e7b9a","type":"http in","z":"becdaea7.25c7a","name":"Total consumption SUM","url":"/dash_api/total_consumption_sum/:slave_id/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":140,"y":2160,"wires":[["160a8ca.36ed973"]]},{"id":"160a8ca.36ed973","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS avg_value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp <= TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n),\ncumulative_sum AS (\n    SELECT\n        slave_id,\n        hour,\n        avg_value,\n        SUM(avg_value) OVER (PARTITION BY slave_id ORDER BY hour) AS running_total\n    FROM\n        hourly_data\n)\nSELECT\n    slave_id,\n    MAX(running_total) / 1000 AS total_consumption_kwh\nFROM\n    cumulative_sum\nGROUP BY\n    slave_id;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":490,"y":2160,"wires":[["1d30d03d.610d7"]]},{"id":"1d30d03d.610d7","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":720,"y":2160,"wires":[]},{"id":"37aaa258.bdfe6e","type":"http in","z":"becdaea7.25c7a","name":"[G] Total daily consumption","url":"/dash_api/total_daily_consumption/multiple/:slave_ids/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":150,"y":1980,"wires":[["25d4b21f.77d5ae"]]},{"id":"25d4b21f.77d5ae","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS hourly_avg\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = ANY(ARRAY[{{msg.req.params.slave_ids}}])\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n)\nSELECT\n    slave_id,\n    SUM(hourly_avg) / 1000 AS total_consumption_kwh\nFROM\n    hourly_data\nGROUP BY\n    slave_id\nORDER BY\n    slave_id;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":530,"y":1980,"wires":[["b228d140.fb67a"]]},{"id":"b228d140.fb67a","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":760,"y":1980,"wires":[]},{"id":"d5514c85.8576c","type":"http in","z":"becdaea7.25c7a","name":"[G] Total consumption SUM","url":"/dash_api/total_consumption_sum/multiple/:slave_ids/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":150,"y":2020,"wires":[["1cb7f8f8.7ff577"]]},{"id":"1cb7f8f8.7ff577","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS avg_value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = ANY(ARRAY[{{msg.req.params.slave_ids}}])\n        AND timestamp <= TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n),\ncumulative_sum AS (\n    SELECT\n        slave_id,\n        hour,\n        avg_value,\n        SUM(avg_value) OVER (PARTITION BY slave_id ORDER BY hour) AS running_total\n    FROM\n        hourly_data\n)\nSELECT\n    slave_id,\n    MAX(running_total) / 1000 AS total_consumption_kwh\nFROM\n    cumulative_sum\nGROUP BY\n    slave_id\nORDER BY\n    slave_id;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":530,"y":2020,"wires":[["8cabfc8b.0dac1"]]},{"id":"8cabfc8b.0dac1","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":760,"y":2020,"wires":[]},{"id":"2a0c1d74.f69622","type":"http in","z":"becdaea7.25c7a","name":"[G] Min and Max demand","url":"/dash_api/demand/multiple/:slave_ids/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":150,"y":2060,"wires":[["4a19a5da.32154c"]]},{"id":"4a19a5da.32154c","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        MIN(value) AS min_hourly_value,\n        MAX(value) AS max_hourly_value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = ANY(ARRAY[{{msg.req.params.slave_ids}}])\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n)\nSELECT\n    slave_id,\n    MIN(min_hourly_value) AS absolute_min_demand,\n    MAX(max_hourly_value) AS absolute_max_demand,\n    (SELECT hour FROM hourly_data h2 WHERE h2.slave_id = h1.slave_id AND h2.min_hourly_value = MIN(h1.min_hourly_value) LIMIT 1) AS min_demand_hour,\n    (SELECT hour FROM hourly_data h2 WHERE h2.slave_id = h1.slave_id AND h2.max_hourly_value = MAX(h1.max_hourly_value) LIMIT 1) AS max_demand_hour\nFROM \n    hourly_data h1\nGROUP BY\n    slave_id\nORDER BY\n    slave_id;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":530,"y":2060,"wires":[["e981d713.3f3d68"]]},{"id":"e981d713.3f3d68","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":760,"y":2060,"wires":[]},{"id":"e2d4ba37.064a78","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2290,"y":520,"wires":[]},{"id":"15c858e0.626057","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1060,"y":2120,"wires":[["fea8f174.ad3cc"]]},{"id":"a1c58766.7fb958","type":"http request","z":"becdaea7.25c7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1400,"y":2120,"wires":[["cb419109.ef9e3"]]},{"id":"cb419109.ef9e3","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1600,"y":2120,"wires":[]},{"id":"fea8f174.ad3cc","type":"function","z":"becdaea7.25c7a","name":"","func":"const time = new Date().getTime();\nmsg.url = `http://192.168.0.1/reqproc/proc_get?cmd=data_volume_limit_switch,data_volume_limit_unit,data_volume_limit_size,data_volume_alert_percent,monthly_tx_bytes,monthly_rx_bytes,monthly_time,traffic_alined_delta&multi_data=1`\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1230,"y":2120,"wires":[["a1c58766.7fb958"]]},{"id":"9d433ffa.3ea81","type":"function","z":"becdaea7.25c7a","name":"","func":"msg.payload = 'isTest=false&goformId=LOGIN&username=YWRtaW4%3D&password=YWRtaW4%3D';\nmsg.url = 'http://192.168.0.1/reqproc/proc_post';\nmsg.headers = {\n    'COntent-type': 'application/x-www-form-urlencoded; charset=UTF-8'\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1190,"y":2240,"wires":[["ca81cf71.e60e"]]},{"id":"e7a53aa9.e76468","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1030,"y":2240,"wires":[["9d433ffa.3ea81"]]},{"id":"ca81cf71.e60e","type":"http request","z":"becdaea7.25c7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1360,"y":2240,"wires":[["d4ed2a8d.ed6818"]]},{"id":"d4ed2a8d.ed6818","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1570,"y":2240,"wires":[]},{"id":"839ab9d8.1527d8","type":"http in","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","url":"/Check","method":"post","upload":false,"swaggerDoc":"","x":140,"y":1000,"wires":[["7f780c40.ad45e4"]]},{"id":"9ca9ef0f.4a2ca","type":"debug","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":675,"y":960,"wires":[],"l":false},{"id":"56bc2ba1.040794","type":"function","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"Format name","func":"const pattern = /\\s\\([^()]+\\)$/;\nconst deviceName = msg.payload.device;\nconst newDeviceName = deviceName.replace(pattern, '');\n\nmsg.payload = {\n    device: newDeviceName,\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":355,"y":1000,"wires":[["32c45d3b.b0f9c2","c7e20ce1.fc6c6"]],"l":false},{"id":"32c45d3b.b0f9c2","type":"function","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"get slaveId","func":"const payload = msg.payload;\nconst devices = flow.get('devices') || {};\nconst device = devices[payload.device];\nconst slaveId = device.slaveId;\n\n return {\n        payload: {\n            id: slaveId,\n        }\n    }\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":1000,"wires":[["9ca9ef0f.4a2ca","576dbbef.c8b814"]]},{"id":"7f780c40.ad45e4","type":"change","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","rules":[{"t":"set","p":"type","pt":"msg","to":"http","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":295,"y":1000,"wires":[["56bc2ba1.040794"]],"l":false},{"id":"69a79861.6bcc18","type":"http response","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","statusCode":"200","headers":{},"x":860,"y":1060,"wires":[]},{"id":"576dbbef.c8b814","type":"change","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"\"","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":1060,"wires":[["69a79861.6bcc18"]]},{"id":"c7e20ce1.fc6c6","type":"debug","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":435,"y":940,"wires":[],"l":false},{"id":"b3c3a42e.37de88","type":"send-check","z":"becdaea7.25c7a","g":"2aa6d15a.9c1b9e","x":710,"y":1000,"wires":[]},{"id":"fd385c3c.97816","type":"inject","z":"becdaea7.25c7a","g":"6079ae30.11a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"CENTRAL_UUID","payloadType":"env","x":2310,"y":400,"wires":[["89654428.c08bf8"]]},{"id":"89654428.c08bf8","type":"debug","z":"becdaea7.25c7a","g":"6079ae30.11a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2550,"y":400,"wires":[]},{"id":"6a14f3b2.cd8b2c","type":"myio-emitter","z":"becdaea7.25c7a","g":"aa61127e.dfa2","x":110,"y":640,"wires":[["5de6353b.c9836c"],["5678a6c3.be7e98"],["93ee4531.4db7d8"],[],[],["5678a6c3.be7e98"],["ca7c6620.0b5198"],["4f64022e.9cb7ec"],[],[],[],[]]},{"id":"5de6353b.c9836c","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":420,"wires":[["3f51507f.fcbcb"]]},{"id":"5678a6c3.be7e98","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":500,"wires":[["ff932835.497da8"]]},{"id":"93ee4531.4db7d8","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":580,"wires":[["b2fd8c1e.51fb8"]]},{"id":"ca7c6620.0b5198","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":660,"wires":[["b502336.ae18dd"]]},{"id":"4f64022e.9cb7ec","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":740,"wires":[["70ed4a2b.d46c74"]]},{"id":"3222e76f.436098","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Associate slave to msg","func":"const slaveId = msg.payload.id;\nconst channels = msg.payload.channels;\n\nconst slaveData = flow.get('slave_data');\n\nif (!slaveData) {\n    node.log(\"Received input from emitter but slave data is not set yet.\");\n    return null;\n}\n\nconst slave = slaveData.find((_slave) => _slave.id === slaveId);\n\nif (!slave) {\n    node.log(\"Could not find slave!\");\n    return null;\n}\n\nmsg.type = slave.type;\nmsg.slave = slave;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":820,"wires":[["9ed92e5.979edd"]]},{"id":"6f667024.d1f12","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Atualização de dispositivo","info":"","x":410,"y":380,"wires":[]},{"id":"d533a111.18fe2","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Temperatura","info":"","x":370,"y":460,"wires":[]},{"id":"4fcbc1eb.eccfc","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Potencia","info":"","x":360,"y":540,"wires":[]},{"id":"5921e588.5a6e3c","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Corrente","info":"","x":362.89581298828125,"y":621.2222290039062,"wires":[]},{"id":"daa9d598.ad4b48","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Voltagem","info":"","x":360,"y":700,"wires":[]},{"id":"da6682b4.03803","type":"comment","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Humidade","info":"","x":360,"y":780,"wires":[]},{"id":"3f51507f.fcbcb","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform channel list to device","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\n\nmsg.lastReading = lastReading;\n\nlet channelsList = slave.channels_list;\n\nconst devices = {};\n\nfunction getDeviceReading(type, payload) {\n    if (!payload) return null;\n    if (type === 'lamp' || type === 'plug') {\n        return payload.output === 100 ? \"on\": \"off\";\n    } else if (type === 'presence_sensor') {\n        return payload.input === 100 ? \"detected\" : \"not_detected\";\n    } else if (type === 'door_sensor') {\n        return payload.input === 100 ? \"open\" : \"closed\";\n    }\n\n    return payload.output === 100 ? 'on' : 'off';\n}\n\nif (slave.type === 'infrared') {\n    const name = slave.name.trimStart().trim();\n    devices[name] = [{\n        status: getDeviceReading('presence_sensor', lastReading.channels[0]),\n    }]\n} else {\n    for (let i = 0; i < channelsList.length; i++) {\n        const channel = channelsList[i];\n        const name = channel.name.trimStart().trim();\n        \n        const reading = getDeviceReading(channel.type, lastReading.channels[channel.channel]);\n        \n        msg.debug = {\n            reading,\n            name,\n            channel,\n            lastReading\n        }\n\n        if (!reading) continue;\n        \n        devices[name] = [{\n            \"ts\": new Date().getTime(),\n            \"values\": {\n                \"status\": reading\n            }\n        }];\n    }\n}\n\nif (Object.keys(devices).length === 0) {\n    return null;\n}\n\nmsg.payload = devices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":730,"y":420,"wires":[["ce30e30e.34805"]]},{"id":"ff932835.497da8","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform temperature reading to device update","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\n\nconst name = slave.name.trimStart().trim();\nlet key = 'temperature';\n\nif (!lastReading.hasOwnProperty('temperature')) {\n    key = 'value';\n}\n\nmsg.payload = {\n    [name]: [{\n        \"temperature\": lastReading[key],\n    }]\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":780,"y":500,"wires":[["ce30e30e.34805"]]},{"id":"6e1ff75e.4dbe98","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform consumption reading to device update","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\nconst deviceMap = {\n    '0': 'a',\n    '1': 'b',\n    '2': 'c'\n};\n\nfunction getMultiplier(deviceName) {\n    const match = deviceName.match(/x(\\d+)/i);\n    return match ? parseInt(match[1], 10) : 1;\n}\n\nfunction getNameWithoutMultipliers(deviceName) {\n    return deviceName.replace(/ x\\d+\\.?\\d*[AV]?/gi, '').trim();\n}\n\nconst name = slave.name;\nconst cleanName = getNameWithoutMultipliers(name);\n\nmsg.payload = {\n    [cleanName]: [{\n        \"consumption\": lastReading.value * getMultiplier(name),\n        \"a\": lastReading.phases ? lastReading.phases.a * getMultiplier(name) : null,\n        \"b\": lastReading.phases ? lastReading.phases.b * getMultiplier(name) : null,\n        \"c\": lastReading.phases ? lastReading.phases.c * getMultiplier(name) : null\n    }]\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":600,"wires":[["ce30e30e.34805"]]},{"id":"b502336.ae18dd","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform current reading to device update","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\nconst deviceMap = {\n    '0': 'a',\n    '1': 'b',\n    '2': 'c'\n};\n\nfunction getMultiplier(deviceName) {\n    const match = deviceName.match(/ x(\\d+\\.?\\d*)A/i);\n    return match ? parseFloat(match[1]) : 1;\n}\n\nfunction getNameWithoutMultipliers(deviceName) {\n    return deviceName.replace(/ x\\d+\\.?\\d*[AV]?/gi, '').trim();\n}\n\nconst name = slave.name;\nconst cleanName = getNameWithoutMultipliers(name);\n\nmsg.payload = {\n    [cleanName]: [{\n        \"total_current\": lastReading.total_current * getMultiplier(name),\n        \"current_a\": lastReading.a * getMultiplier(name),\n        \"current_b\": lastReading.b * getMultiplier(name),\n        \"current_c\": lastReading.c * getMultiplier(name)\n    }]\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":770,"y":660,"wires":[["ce30e30e.34805"]]},{"id":"70ed4a2b.d46c74","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform voltage reading to device update","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\nconst voltage = lastReading.voltage;\nconst fp = lastReading.fp;\nlet a, b, c;\nlet fpA, fpB, fpC;\nif (voltage) {\n    a = voltage.a;\n    b = voltage.b;\n    c = voltage.c;\n}\nif (fp) {\n    fpA = fp.a;\n    fpB = fp.b;\n    fpC = fp.c;\n}\n\nfunction getMultiplier(deviceName) {\n    const match = deviceName.match(/ x(\\d+\\.?\\d*)V/i);\n    return match ? parseFloat(match[1]) : 1;\n}\n\nfunction getNameWithoutMultipliers(deviceName) {\n    return deviceName.replace(/ x\\d+\\.?\\d*[AV]?/gi, '').trim();\n}\n\nconst name = slave.name;\nconst cleanName = getNameWithoutMultipliers(name);\nconst multiplier = getMultiplier(name);\n\nmsg.payload = {\n    [cleanName]: [{\n        \"fp_a\": fpA,\n        \"fp_b\": fpB,\n        \"fp_c\": fpC,\n        \"voltage_a\": a ? a * multiplier : null,\n        \"voltage_b\": b ? b * multiplier : null,\n        \"voltage_c\": c ? c * multiplier : null\n    }]\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":770,"y":740,"wires":[["2ae9d86e.868248","ce30e30e.34805"]]},{"id":"9ed92e5.979edd","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Format humidity","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\n\nmsg.payload = {\n    [slave.name]: [{\n        \"humidity\": lastReading.humidity\n    }]\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":820,"wires":[["ce30e30e.34805"]]},{"id":"ce30e30e.34805","type":"link out","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"","links":["2104a251.44990e","5c469c9c.a2b1a4","a63e54b8.182d88","1f10f022.461","dd87d608.186da8"],"x":1395,"y":580,"wires":[]},{"id":"2ae9d86e.868248","type":"debug","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1210,"y":720,"wires":[]},{"id":"40ba6155.b83af","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"[G] Average Consumption Per Weekday","url":"/dash_api/avg_consumption_per_weekday/multiple/:slave_ids/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":210,"y":1660,"wires":[["53984edd.f5119"]]},{"id":"7d8665fa.724d8c","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":780,"y":1660,"wires":[]},{"id":"53984edd.f5119","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    EXTRACT(DOW FROM timestamp) AS weekday,\n    AVG(value) / 1000 AS avg_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = ANY(ARRAY[{{msg.req.params.slave_ids}}])\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    slave_id, weekday\nORDER BY\n    slave_id, weekday;\n","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":550,"y":1660,"wires":[["7d8665fa.724d8c"]]},{"id":"b03c073c.9439f8","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"[G] Day with the most consumption","url":"/dash_api/day_with_most_consumption/multiple/:slave_ids/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1700,"wires":[["70bb562.5d3c1a8"]]},{"id":"850190cd.c6501","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":780,"y":1700,"wires":[]},{"id":"70bb562.5d3c1a8","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    DATE(timestamp) AS day,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}])\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    slave_id, day\nHAVING\n    SUM(value) = (\n        SELECT MAX(daily_consumption)\n        FROM (\n            SELECT slave_id, DATE(timestamp) AS day, SUM(value) AS daily_consumption\n            FROM consumption_realtime\n            WHERE slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}])\n                AND timestamp\n            BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n                AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n            GROUP BY slave_id, DATE(timestamp)\n        ) AS daily_totals\n        WHERE daily_totals.slave_id = consumption_realtime.slave_id\n    )\nORDER BY\n    slave_id, total_consumption_kwh DESC;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":550,"y":1700,"wires":[["850190cd.c6501"]]},{"id":"f9313b64.f3bff8","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"[G] Weekday with the most consumption","url":"/dash_api/weekday_with_most_consumption/multiple/:slave_ids/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":220,"y":1740,"wires":[["22d8c4dd.21622c"]]},{"id":"b5cbc498.2c9f98","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":780,"y":1740,"wires":[]},{"id":"22d8c4dd.21622c","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    EXTRACT(DOW FROM timestamp) AS weekday,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}])\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    slave_id, weekday\nHAVING\n    SUM(value) = (\n        SELECT MAX(weekly_consumption)\n        FROM (\n            SELECT slave_id, EXTRACT(DOW FROM timestamp) AS weekday, SUM(value) AS weekly_consumption\n            FROM consumption_realtime\n            WHERE slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}])\n                AND timestamp\n            BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n                AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n            GROUP BY slave_id, EXTRACT(DOW FROM timestamp)\n        ) AS weekly_totals\n        WHERE weekly_totals.slave_id = consumption_realtime.slave_id\n    )\nORDER BY\n    slave_id, total_consumption_kwh DESC;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":550,"y":1740,"wires":[["b5cbc498.2c9f98"]]},{"id":"e380933.484de7","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"[G] Hour with the most consumption","url":"/dash_api/hour_with_most_consumption/multiple/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1780,"wires":[["9ccf073c.e28b58"]]},{"id":"cc8a241.442b0d8","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":780,"y":1780,"wires":[]},{"id":"9ccf073c.e28b58","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    DATE_TRUNC('hour', timestamp) AS hour,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}]::integer[])\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    slave_id, hour\nHAVING\n    SUM(value) = (\n        SELECT MAX(hourly_consumption)\n        FROM (\n            SELECT slave_id, DATE_TRUNC('hour', timestamp) AS hour, SUM(value) AS hourly_consumption\n            FROM consumption_realtime\n            WHERE slave_id = ANY(ARRAY[{{ msg.req.params.slave_ids }}]::integer[])\n                AND timestamp\n            BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n                AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n            GROUP BY slave_id, DATE_TRUNC('hour', timestamp)\n        ) AS hourly_totals\n        WHERE hourly_totals.slave_id = consumption_realtime.slave_id\n    )\nORDER BY\n    slave_id, total_consumption_kwh DESC;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":550,"y":1780,"wires":[["cc8a241.442b0d8"]]},{"id":"26b20f6e.45125","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Total consumption","url":"/dash_api/total_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":150,"y":1540,"wires":[["bdb8c20f.cd761"]]},{"id":"bdb8c20f.cd761","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n) AS hourly_data\nGROUP BY\n    slave_id;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1540,"wires":[["684edfe7.206f7"]]},{"id":"684edfe7.206f7","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1540,"wires":[]},{"id":"8910a6ba.4492b8","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Average Consumption Per Weekday","url":"/dash_api/avg_consumption_per_weekday/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1340,"wires":[["cefe1d3.9c357e"]]},{"id":"6caba71c.7eb1e8","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1340,"wires":[]},{"id":"cefe1d3.9c357e","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    weekday,\n    AVG(hourly_consumption) / 1000 AS avg_hourly_consumption_kwh\nFROM (\n    SELECT\n        EXTRACT(DOW FROM time_bucket('1 hour', timestamp)) AS weekday,\n        SUM(value) AS hourly_consumption\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        EXTRACT(DOW FROM time_bucket('1 hour', timestamp)),\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    weekday\nORDER BY\n    weekday;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1340,"wires":[["6caba71c.7eb1e8"]]},{"id":"3ee80cbe.1a0c94","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Day with the most consumption","url":"/dash_api/day_with_most_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1380,"wires":[["c0abbc64.2befb"]]},{"id":"cfb585fb.952da8","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1380,"wires":[]},{"id":"c0abbc64.2befb","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM (\n    SELECT\n        time_bucket('1 hour', timestamp) AS timestamp,\n        AVG(value) AS value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    day\nORDER BY\n    total_consumption_kwh DESC\nLIMIT 1;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1380,"wires":[["cfb585fb.952da8"]]},{"id":"3d46bc65.73bdc4","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Weekday with the most consumption","url":"/dash_api/weekday_with_most_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":210,"y":1420,"wires":[["228622e2.42571e"]]},{"id":"6f72d925.cfdcd8","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1420,"wires":[]},{"id":"228622e2.42571e","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    EXTRACT(DOW FROM timestamp) AS weekday,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = {{ msg.req.params.slave_id }}\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    weekday\nORDER BY\n    total_consumption_kwh DESC\nLIMIT 1;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1420,"wires":[["6f72d925.cfdcd8"]]},{"id":"9776ddb5.6c8a2","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Hour with the most consumption","url":"/dash_api/hour_with_most_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1460,"wires":[["8ede833.ea3028"]]},{"id":"86e2b266.9d4d2","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1460,"wires":[]},{"id":"8ede833.ea3028","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    DATE_TRUNC('hour', timestamp) AS hour,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM\n    consumption_realtime\nWHERE\n    slave_id = {{ msg.req.params.slave_id }}\n    AND timestamp\nBETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    hour\nORDER BY\n    total_consumption_kwh DESC\nLIMIT 1;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1460,"wires":[["86e2b266.9d4d2"]]},{"id":"fb04ecea.1cde8","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Consumption per day","url":"/dash_api/daily_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":160,"y":1500,"wires":[["bc7b91f1.4e901"]]},{"id":"bffada98.675438","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1500,"wires":[]},{"id":"bc7b91f1.4e901","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,\n    SUM(value) / 1000 AS total_consumption_kwh\nFROM (\n    SELECT\n        time_bucket('1 hour', timestamp) AS timestamp,\n        AVG(value) AS value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    day\nORDER BY\n    day;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1500,"wires":[["bffada98.675438"]]},{"id":"a19ffb44.9bc388","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Average Consumption","url":"/dash_api/avg_consumption/:slave_id/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":160,"y":1580,"wires":[["7ad0b4ce.eed08c"]]},{"id":"7ad0b4ce.eed08c","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT\n    slave_id,\n    AVG(hourly_consumption) / 1000 AS avg_hourly_consumption_kwh\nFROM (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        SUM(value) AS hourly_consumption\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.req.params.slave_id }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n) AS hourly_data\nGROUP BY\n    slave_id;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":510,"y":1580,"wires":[["51ffd916.0ff668"]]},{"id":"51ffd916.0ff668","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":740,"y":1580,"wires":[]},{"id":"4ce03ed0.51ace","type":"http in","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"Fetch all slaves","url":"/dash_api/slaves","method":"get","upload":false,"swaggerDoc":"","x":140,"y":1880,"wires":[["4c2782a3.24b03c"]]},{"id":"4c2782a3.24b03c","type":"postgresql","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","query":"SELECT *\nFROM slaves\nORDER BY id;","postgreSQLConfig":"c3259202.9eb35","split":false,"rowsPerMsg":1,"outputs":1,"x":550,"y":1880,"wires":[["3ac1e674.d1f2ea"]]},{"id":"3ac1e674.d1f2ea","type":"http response","z":"becdaea7.25c7a","g":"c1cbadfb.e1717","name":"","statusCode":"200","headers":{},"x":780,"y":1880,"wires":[]},{"id":"9e1f3d18.d0c9b","type":"function","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"Delayed Queue","func":"const bufferKey = 'latestMessages';\nconst lastSentKey = 'lastSentTimes';\n\nconst latestMessages = context.get(bufferKey) || {};\nconst lastSentTimes = context.get(lastSentKey) || {};\n\n// Get the TTL from flow context or default to 5000ms\nconst deviceTTL = flow.get('deviceTTL') || 5000;\nconst now = Date.now();\n\n// Handle \"FLUSH\" payload\nif (typeof msg.payload === 'string' && msg.payload === 'FLUSH') {\n    const newPayload = {};\n    \n    // Flush messages for devices whose TTL has expired\n    for (const [deviceName, telemetry] of Object.entries(latestMessages)) {\n        const lastSentTime = lastSentTimes[deviceName] || 0;\n        if (now - lastSentTime >= deviceTTL) {\n            newPayload[deviceName] = [telemetry];\n            lastSentTimes[deviceName] = now;\n            // Clear the flushed message\n            delete latestMessages[deviceName];\n        }\n    }\n\n    // Save the cleaned states to context\n    context.set(bufferKey, latestMessages);\n    context.set(lastSentKey, lastSentTimes);\n\n    return Object.keys(newPayload).length > 0 ? { payload: newPayload } : null;\n}\n\n// Process normal payloads\nif (typeof msg.payload === 'object') {\n    // Update the latest message for each device\n    for (const [deviceName, telemetryArray] of Object.entries(msg.payload)) {\n        if (telemetryArray.length > 0) {\n            latestMessages[deviceName] = {\n                ...latestMessages[deviceName],\n                ...telemetryArray[telemetryArray.length - 1],\n            }\n        }\n    }\n    \n    context.set(bufferKey, latestMessages);\n}\n\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1780,"y":380,"wires":[["fd779987.067b58","bf146f56.27e28"]]},{"id":"a0e942b2.80ccc","type":"inject","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"30","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"FLUSH","payloadType":"str","x":1620,"y":440,"wires":[["9e1f3d18.d0c9b"]]},{"id":"fd779987.067b58","type":"debug","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2020,"y":440,"wires":[]},{"id":"dd87d608.186da8","type":"link in","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"","links":["6a8d76a0.316138","fc544c8d.06834","4c51ea40.64a4e4","bca8fcee.f61da","27b46fbd.c51ed","737a7284.a50ecc","e56cde5c.56f23","ce30e30e.34805","df4fb9f6.4d2108"],"x":1555,"y":380,"wires":[["db876438.2f1928"]]},{"id":"db876438.2f1928","type":"function","z":"becdaea7.25c7a","name":"Add namespace","func":"const keys = Object.keys(msg.payload);\n\nconst newPayload = keys.reduce((acc, key) => {\n    acc[`${key} (Campinas Shopping)`] = msg.payload[key];\n    return acc;\n}, {});\n\nmsg.payload = newPayload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1615,"y":380,"wires":[["9e1f3d18.d0c9b"]],"l":false},{"id":"bf146f56.27e28","type":"mqtt out","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"","topic":"v1/gateway/telemetry","qos":"","retain":"","broker":"ba7623fd.d47d2","x":2020,"y":380,"wires":[]},{"id":"babf66b4.7f11f8","type":"http in","z":"becdaea7.25c7a","name":"Average Consumption v2","url":"/dash_api/avg_consumption_v2/:device/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":990,"y":1980,"wires":[["c4e4858e.23e2f8"]]},{"id":"c4e4858e.23e2f8","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS consumption_date,               \n    SUM(value) / 1000 AS total_consumption_kwh, \n    COUNT(DISTINCT EXTRACT(HOUR FROM timestamp)) AS total_hours, \n    (SUM(value) / 1000) / NULLIF(COUNT(DISTINCT EXTRACT(HOUR FROM timestamp)), 0) AS hours_per_kwh\nFROM\n    consumption_realtime\nWHERE\n    name = {{ msg.req.params.device }}              \n    AND timestamp BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000) \nGROUP BY\n    consumption_date                       \nORDER BY\n    consumption_date;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":1370,"y":1980,"wires":[["2ef70ea2.2aadf2"]]},{"id":"2ef70ea2.2aadf2","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":1600,"y":1980,"wires":[]},{"id":"4618adcf.d16a54","type":"http in","z":"becdaea7.25c7a","name":"Average Consumption lojas","url":"/dash_api/lojas_consumption/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":1000,"y":2040,"wires":[["bfedd1fb.81e8f"]]},{"id":"bfedd1fb.81e8f","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,  \n\tMAX(value)/1000 AS max_consumption,\n\tMIN(value)/1000 AS min_consumption,\n    SUM(value)/1000 AS total_consumption_kwh, \n    COUNT(DISTINCT date_trunc('hour', timestamp)) AS total_hours, \n    (SUM(value) / 1000) / COUNT(DISTINCT date_trunc('hour', timestamp)) AS hours_per_kwh\nFROM\n    consumption_realtime\nWHERE         \n    timestamp BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000) \nGROUP BY\n    time_bucket('1 day', timestamp)                       \nORDER BY\n    day;                                                                                                   \n","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":1370,"y":2040,"wires":[["c1d7e870.83f938"]]},{"id":"c1d7e870.83f938","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":1600,"y":2040,"wires":[]},{"id":"c7d9af0d.01512","type":"function","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"Add namespace","func":"const keys = Object.keys(msg.payload);\n\nconst newPayload = keys.reduce((acc, key) => {\n    acc[`${key} (Campinas Shopping)`] = msg.payload[key];\n    return acc;\n}, {});\n\nmsg.payload = newPayload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1615,"y":520,"wires":[["bf146f56.27e28"]],"l":false},{"id":"7cfeedaf.f39904","type":"link in","z":"becdaea7.25c7a","g":"67e6d874.0be2b8","name":"BYPASS","links":["53a6ab82.0071c4","ebdffc40.f7516","9b58ea20.906e18","485123c6.ef3814","191334e9.0d8d33","1922c7b3.d9d89"],"x":1555,"y":520,"wires":[["c7d9af0d.01512"]]},{"id":"9d9bf611.676bd8","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":3180,"wires":[["4c2fd28e.da60bc"]]},{"id":"4c2fd28e.da60bc","type":"change","z":"becdaea7.25c7a","name":"","rules":[{"t":"set","p":"lastSuccessfulRun","pt":"flow","to":"2025-04-28T15:00:00.000Z","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":3180,"wires":[[]]},{"id":"b2fd8c1e.51fb8","type":"switch","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Slave is SCD?","property":"slave.name","propertyType":"msg","rules":[{"t":"cont","v":"SCD","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":580,"wires":[["22b7b982.5a8756"],["6e1ff75e.4dbe98"]]},{"id":"22b7b982.5a8756","type":"function","z":"becdaea7.25c7a","g":"aa61127e.dfa2","name":"Transform consumption reading to nivel de agua","func":"const slave = msg.slave;\nconst lastReading = msg.payload;\n\nlet [_ignore, deviceName, offset, height, multiplier] = slave.name.split(' ');\n\n\noffset = parseInt(offset, 10);\nmultiplier = parseFloat(multiplier.replace(/x/i, ''));\nheight = parseInt(height);\n\n\nconst waterLevel = (msg.payload.value - offset) * multiplier;\nconst percentage = parseFloat((waterLevel / height).toFixed(2));\n\nmsg.payload = {\n    [deviceName]: [{\n        water_level: waterLevel,\n        water_percentage: percentage,\n    }]\n};\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":560,"wires":[["ce30e30e.34805"]]},{"id":"3426fc19.b01704","type":"http in","z":"becdaea7.25c7a","name":"Shopping Total consumption SUM","url":"/dash_api/shopping_total_consumption_sum/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":180,"y":2360,"wires":[["383787eb.97af48"]]},{"id":"383787eb.97af48","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n   day,\n   SUM(value * delta_t_hours) / 1000 AS total_consumption_kwh\nFROM (\n   SELECT\n       time_bucket('1 day', timestamp) AS day,\n       value,\n       EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (PARTITION BY slave_id ORDER BY timestamp))) / 3600 AS delta_t_hours\n   FROM\n       consumption_realtime\n   WHERE\n  timestamp BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n       AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000) \n) AS subquery\nGROUP BY\n   day\nORDER BY\n   day;\n","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":490,"y":2360,"wires":[["893c7d24.8d1b7"]]},{"id":"893c7d24.8d1b7","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":740,"y":2360,"wires":[]},{"id":"ae00d18e.885c1","type":"http in","z":"becdaea7.25c7a","name":"Shopping Total pulses SUM","url":"/dash_api/shopping_total_pulses_sum/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":160,"y":2420,"wires":[["cdc8a141.835d1"]]},{"id":"cdc8a141.835d1","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT\n   day,\n   SUM(value) AS total_consumption_liters\nFROM (\n   SELECT\n       time_bucket('1 day', timestamp) AS day,\n       value\n   FROM\n       channel_pulse_log\n   WHERE\n        timestamp BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000) \n) AS subquery\nGROUP BY\n   day\nORDER BY\n   day;\n","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":470,"y":2420,"wires":[["1dd5fcf7.312ce3"]]},{"id":"1dd5fcf7.312ce3","type":"http response","z":"becdaea7.25c7a","name":"","statusCode":"200","headers":{},"x":700,"y":2420,"wires":[]},{"id":"3e774b3c.321044","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1050,"y":2360,"wires":[["a6c7c86b.fc0898"]]},{"id":"a6c7c86b.fc0898","type":"function","z":"becdaea7.25c7a","name":"","func":"const devices = flow.get('devices'); \nconst centralId = env.get('CENTRAL_UUID');\n\nconst newDevices = {};\n\nObject.keys(devices).forEach((key) => {\n    const device = devices[key]; \n\n    newDevices[`${key} (Campinas Shopping)`] = {\n        centralId,\n        slaveId: device.slaveId,\n    };\n});\n\nmsg.payload = newDevices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1220,"y":2360,"wires":[["6df0b468.0fb18c","c5f1ff2.0791c"]]},{"id":"c5f1ff2.0791c","type":"mqtt out","z":"becdaea7.25c7a","name":"Attribute","topic":"v1/gateway/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":1580,"y":2300,"wires":[]},{"id":"6df0b468.0fb18c","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1560,"y":2360,"wires":[]},{"id":"33473175.074c4e","type":"function","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","func":"const name = msg.req.params.name\nconsole.log(\"name\",name)\nconst devices = flow.get('devices') || {};\n\nconst device = devices[name];\n\nmsg.payload = device.slaveId;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":2600,"wires":[["5dfbd516.aa87fc"]]},{"id":"e5b8cecc.efa3f","type":"http response","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","statusCode":"200","headers":{},"x":880,"y":2600,"wires":[]},{"id":"5dfbd516.aa87fc","type":"postgresql","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS consumption_date,                           \n    SUM(value) / 1000 AS total_consumption_kwh, \n    COUNT(DISTINCT EXTRACT(HOUR FROM timestamp)) AS total_hours, \n    (SUM(value) / 1000) / NULLIF(COUNT(DISTINCT EXTRACT(HOUR FROM timestamp)), 0) AS hours_per_kwh\nFROM\n    consumption_realtime\nWHERE\nslave_id = {{ msg.payload }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nGROUP BY\n    consumption_date                       \nORDER BY\n    consumption_date;","postgreSQLConfig":"96d7818b.f1efc","split":false,"rowsPerMsg":1,"outputs":1,"x":690,"y":2600,"wires":[["e5b8cecc.efa3f"]]},{"id":"5a1369c5.4648e8","type":"http in","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Average Consumption v3","url":"/dash_api/avg_consumption_v3/:name/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":170,"y":2600,"wires":[["33473175.074c4e"]]},{"id":"ed9931d4.f5849","type":"http in","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Min and Max demand V2","url":"/dash_api/demand_v2/:name/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":170,"y":2640,"wires":[["dc362b94.84e168"]]},{"id":"ff513e91.b729b","type":"postgresql","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","query":"SELECT\n    time_bucket('1 day', timestamp) AS day,\n    MIN(min_hourly_value)/1000 AS min_daily_demand,\n    MAX(max_hourly_value)/1000 AS max_daily_demand\nFROM (\n    SELECT\n        time_bucket('1 hour', timestamp) AS timestamp,\n        MIN(value) AS min_hourly_value,\n        MAX(value) AS max_hourly_value\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.payload }}\n        AND timestamp\n    BETWEEN TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        time_bucket('1 hour', timestamp)\n) AS hourly_data\nGROUP BY\n    day\nORDER BY\n    day;","postgreSQLConfig":"39cf2c0b.db0a44","split":false,"rowsPerMsg":1,"outputs":1,"x":690,"y":2640,"wires":[["e95795f7.55d038"]]},{"id":"e95795f7.55d038","type":"http response","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","statusCode":"200","headers":{},"x":880,"y":2640,"wires":[]},{"id":"dc362b94.84e168","type":"function","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","func":"const name = msg.req.params.name\nconsole.log(\"name\",name)\nconst devices = flow.get('devices') || {};\n\nconst device = devices[name];\n\nmsg.payload = device.slaveId;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":2640,"wires":[["ff513e91.b729b"]]},{"id":"7f760094.afd2e","type":"comment","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Consumption report V3","info":"","x":160,"y":2560,"wires":[]},{"id":"dda47afd.ea5c08","type":"http response","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","statusCode":"200","headers":{},"x":880,"y":2680,"wires":[]},{"id":"908a2120.21e11","type":"http in","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Total daily consumption sum","url":"dash_api/v2/total_daily_consumption/:names/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":180,"y":2680,"wires":[["64a6e668.c469b8"]]},{"id":"64a6e668.c469b8","type":"function","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","func":"let names = msg.req.params.names;\nnames = names.split(\",\");\nconst devices = flow.get('devices') || {};\n\nconst id_devices = [];\n\nfor (let name of names) {\n    // const cleanName = name.replace(/\\s*\\([^)]*\\)$/, '');\n    const cleanName = name.replace(/ \\([^)]*\\)$/, '');\n\n    \n    if (devices[cleanName]) {\n        if (!devices[cleanName].slaveId) {\n            node.warn('Device has no slave id:' + cleanName);\n            continue;\n        }\n        id_devices.push(devices[cleanName].slaveId);\n    } else {\n        node.warn(`Dispositivo não encontrado: ${cleanName}`);\n    }\n}\n\nmsg.payload = id_devices.join(',');\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":2680,"wires":[["d484c241.7c79b"]]},{"id":"d484c241.7c79b","type":"postgresql","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS hourly_avg\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id IN ({{ msg.payload }})\n        AND timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n),\ndaily_sums AS (\n    SELECT\n        DATE_TRUNC('day', hour) AS day,\n        slave_id,\n        SUM(hourly_avg) / 1000 AS daily_sum_kwh\n    FROM\n        hourly_data\n    GROUP BY\n        DATE_TRUNC('day', hour),\n        slave_id\n)\nSELECT\n    day,\n    SUM(daily_sum_kwh) AS total_daily_consumption_kwh,\n    AVG(daily_sum_kwh) AS avg_daily_sum_kwh,\n    MIN(daily_sum_kwh) AS min_daily_sum_kwh,\n    MAX(daily_sum_kwh) AS max_daily_sum_kwh\nFROM \n    daily_sums\nGROUP BY\n    day\nORDER BY\n    day;","postgreSQLConfig":"96d7818b.f1efc","split":false,"rowsPerMsg":1,"outputs":1,"x":690,"y":2680,"wires":[["dda47afd.ea5c08"]]},{"id":"88381070.aca0e","type":"http in","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Consumption per device in a range.","url":"/dash_api/v2/consumption_per_device/:names/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":200,"y":2720,"wires":[["7dc27e43.7f419"]]},{"id":"7dc27e43.7f419","type":"function","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","func":"let names = msg.req.params.names;\nnames = names.split(\",\");\nconst devices = flow.get('devices') || {};\n\nconst id_devices = [];\n\nfor (let name of names) {\n    // const cleanName = name.replace(/\\s*\\([^)]*\\)$/, '');\n    const cleanName = name.replace(/ \\([^)]*\\)$/, '');\n    \n    if (devices[cleanName]) {\n        if (!devices[cleanName].slaveId) {\n            node.warn('Device has no slave id:' + cleanName);\n            continue;\n        }\n        id_devices.push(devices[cleanName].slaveId);\n    } else {\n        node.warn(`Dispositivo não encontrado: ${cleanName}`);\n    }\n}\n\nmsg.payload = id_devices.join(',');\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":2720,"wires":[["56b48147.4676a"]]},{"id":"56b48147.4676a","type":"postgresql","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS hourly_avg\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id IN ({{ msg.payload }})\n        AND timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n)\nSELECT\n    hd.slave_id,\n    s.name AS device_name,\n    SUM(hd.hourly_avg) / 1000 AS total_consumption_kwh\nFROM \n    hourly_data hd\nJOIN \n    slaves s ON s.id = hd.slave_id\nGROUP BY\n    hd.slave_id,\n    s.name\nORDER BY\n    hd.slave_id;","postgreSQLConfig":"96d7818b.f1efc","split":false,"rowsPerMsg":1,"outputs":1,"x":710,"y":2720,"wires":[["f1abc7b5.c8ae68"]]},{"id":"f1abc7b5.c8ae68","type":"http response","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","statusCode":"200","headers":{},"x":880,"y":2720,"wires":[]},{"id":"2055050f.73cb8a","type":"http in","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"Consumption per specific device in range","url":"/dash_api/v2/consumption_per_specific_device/:name/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":220,"y":2760,"wires":[["824be4a7.e851e8"]]},{"id":"824be4a7.e851e8","type":"function","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","func":"const name = msg.req.params.name;\nconst devices = flow.get('devices') || {};\n\n\n// const cleanName = name.replace(/\\s*\\([^)]*\\)$/, '');\nconst cleanName = name.replace(/ \\([^)]*\\)$/, '');\n\n    \nif (devices[cleanName]) {\n    if (!devices[cleanName].slaveId) {\n        node.warn('Device has no slave id:' + cleanName);\n        return null;\n    }\n    \n    msg.slaveId = devices[cleanName].slaveId;\n    return msg;\n}\n\nnode.warn(`Dispositivo não encontrado: ${cleanName}`);\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":2760,"wires":[["3f59333b.4fae3c"]]},{"id":"3f59333b.4fae3c","type":"postgresql","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","query":"WITH hourly_data AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS hour,\n        AVG(value) AS hourly_avg\n    FROM\n        consumption_realtime\n    WHERE\n        slave_id = {{ msg.slaveId }}\n        AND timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n    GROUP BY\n        slave_id, hour\n)\nSELECT\n    DATE_TRUNC('day', hour) AS day,\n    AVG(hourly_avg) / 1000 AS avg_consumption,\n    MIN(hourly_avg) / 1000 AS min_consumption,\n    MAX(hourly_avg) / 1000 AS max_consumption,\n    SUM(hourly_avg) / 1000 AS total_consumption\nFROM \n    hourly_data\nGROUP BY\n    DATE_TRUNC('day', hour)\nORDER BY\n    day;","postgreSQLConfig":"96d7818b.f1efc","split":false,"rowsPerMsg":1,"outputs":1,"x":710,"y":2760,"wires":[["c63564f6.89a668"]]},{"id":"c63564f6.89a668","type":"http response","z":"becdaea7.25c7a","g":"b095103f.6b3f6","name":"","statusCode":"200","headers":{},"x":880,"y":2760,"wires":[]},{"id":"9ff3e5fd.eb2858","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1050,"y":2460,"wires":[["6dd50167.ef18"]]},{"id":"6dd50167.ef18","type":"function","z":"becdaea7.25c7a","name":"","func":"const devices = flow.get('devices'); \nconst centralId = env.get('CENTRAL_UUID');\n\nconst messages = [];\n\nObject.keys(devices).forEach((key) => {\n    const device = devices[key]; \n\n    const message = {\n        payload: {\n            device: {\n                centralId: centralId\n            }\n        }\n    };\n\n    messages.push(message);\n});\n\nmsg.payload = messages;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1220,"y":2460,"wires":[["2081a1a6.2df6be"]]},{"id":"2081a1a6.2df6be","type":"function","z":"becdaea7.25c7a","name":"Add namespace","func":"const devices = flow.get('devices'); \nconst keys = Object.keys(devices);\nconst newDevices = [];\n\nconst newPayload = keys.reduce((acc, key) => {\n    if (key.startsWith(\"Hidr.\")) {\n        let index = key.toLowerCase().indexOf(\"x\"); \n        let newKey = index !== -1 ? key.slice(0, index) : key;\n        newKey = newKey.slice(6);\n        if(newKey !=\"Dog_E\"){\n            acc[`${newKey}(Campinas Shopping)`] = {\n                centralId: msg.payload[0].payload.device.centralId\n            };\n            return acc;\n        }\n        \n            acc[`${newKey} (Campinas Shopping)`] = {\n                centralId: msg.payload[0].payload.device.centralId\n            };\n        newDevices.push(newKey); // Armazena apenas a chave modificada, se necessário\n    }\n    return acc;\n}, {}); \n\nmsg.payload = newPayload;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1345,"y":2460,"wires":[["32dbe0ff.ebf15"]],"l":false},{"id":"32dbe0ff.ebf15","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1560,"y":2460,"wires":[]},{"id":"9d296fb6.8302b","type":"inject","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"600","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":140,"wires":[["ea3c563b.84ebe8"]]},{"id":"ea3c563b.84ebe8","type":"get-data","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","selectedOption":"slaves","x":320,"y":140,"wires":[["bb638599.31abb8","958abd31.7566"]]},{"id":"bb638599.31abb8","type":"split","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":490,"y":140,"wires":[["dbf10ba.b4181f8"]]},{"id":"dbf10ba.b4181f8","type":"switch","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Device Type","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"outlet","vt":"str"},{"t":"eq","v":"three_phase_sensor","vt":"str"},{"t":"eq","v":"infrared","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":650,"y":140,"wires":[["b0d36d.d7896c9"],["2129af69.05ed6"],["ad1d0e33.cf6f5"]]},{"id":"b0d36d.d7896c9","type":"function","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Transform slave outlet devices","func":"const slave = msg.payload;\nconst channels = slave.channels_list\nconst config = slave.config; // This might be null\n\nconst devices = {\n    [slave.name]: {\n        slaveId: slave.id,\n        name: slave.name\n    }\n};\n\nconst centralId = env.get('CENTRAL_UUID');\n\nfor (let i = 0; i < channels.length; i++) {\n    const channel = channels[i];\n    let channelConfig;\n    \n    if (config && config.channelConfig) {\n        const channelConfigKey = `channel${channel.channel}`;\n\n        if (config.channelConfig.hasOwnProperty(channelConfigKey)) {\n            channelConfig = config.channelConfig[channelConfigKey];\n        }\n    }\n    const name = channel.name.trimStart().trim();\n    devices[name] = {\n        type: channel.type,\n        name: channel.name,\n        channelType: channelConfig ? channelConfig.channel_type : null,\n        outputType: channelConfig ? channelConfig.output : null,\n        slaveId: channel.slaveId,\n        channelId: channel.channel,\n        deviceKind: channel.type,\n        deviceName: channel.name,\n        uniqueId: `${centralId}_${channel.slaveId}_${channel.id}`,\n    };\n\n    \n}\nmsg.payload = devices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":990,"y":100,"wires":[["ef9886d5.21dae8","7a39ceb3.28125"]]},{"id":"958abd31.7566","type":"change","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Set slave_data to flow","rules":[{"t":"set","p":"slave_data","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":80,"wires":[[]]},{"id":"2129af69.05ed6","type":"function","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Transform slave three_phase_sensor devices","func":"const slave = msg.payload;\nconst channels = slave.channels_list\nconst config = slave.config; // This might be null\n\nconst devices = {\n    [slave.name]: {\n        slaveId: slave.id,\n    }\n};\n\nconst centralId = env.get('CENTRAL_UUID');\n\n\ndevices[slave.name] = {\n    version: slave.version,\n    temperature_correction: slave.temperature_correction,\n    deviceKind: 'energy',\n    slaveId: slave.id,\n    name: slave.name,\n    centralId,\n};\n\nmsg.payload = devices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":950,"y":140,"wires":[["ef9886d5.21dae8"]]},{"id":"ad1d0e33.cf6f5","type":"function","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Transform slave infrared devices","func":"const slave = msg.payload;\nconst channels = slave.channels_list\nconst config = slave.config; // This might be null\n\nconst slaveName = slave.name.trimStart().trim();\nconst centralId = env.get('CENTRAL_UUID');\n\nconst devices = {\n    [slaveName]: {\n        version: slave.version,\n        temperature_correction: slave.temperature_correction,\n        deviceKind: 'temperature_sensor',\n        deviceName: slaveName,\n    }\n};\n\nfor (let i = 0; i < channels.length; i++) {\n    const channel = channels[i];\n    let channelConfig;\n    \n    if (config && config.channelConfig) {\n        const channelConfigKey = `channel${channel.channel}`;\n\n        if (config.channelConfig.hasOwnProperty(channelConfigKey)) {\n            channelConfig = config.channelConfig[channelConfigKey];\n        }\n    }\n    \n    devices[channel.name] = {\n        type: channel.type,\n        name: channel.name,\n        channelType: channelConfig ? channelConfig.channel_type : null,\n        outputType: channelConfig ? channelConfig.output : null,\n        slaveId: channel.slaveId,\n        channelId: channel.channel,\n        uniqueId: `${centralId}_${channel.slaveId}_${channel.id}`,\n    };\n\n    \n}\n\nmsg.payload = devices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":990,"y":180,"wires":[["ef9886d5.21dae8"]]},{"id":"ef9886d5.21dae8","type":"function","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","func":"// const keys = Object.keys(msg.payload);\n\n// const newPayload = keys.reduce((acc, key) => {\n//     acc[`${key} (Benfica)`] = msg.payload[key];\n//     return acc;\n// }, {});\n\n// msg.payload = newPayload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1260,"y":140,"wires":[["5d952e9b.da68e"]]},{"id":"ff965f7e.d53cb","type":"debug","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1810,"y":80,"wires":[]},{"id":"5d952e9b.da68e","type":"join","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1410,"y":140,"wires":[["12c16f62.71ddb1"]]},{"id":"12c16f62.71ddb1","type":"function","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Merge into a single obj","func":"msg.payload = msg.payload.reduce((acc, obj) => {\n    const keys = Object.keys(obj);\n    for (const key of keys) {\n        acc[key] = obj[key];\n    }\n\n    return acc;\n}, {});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1600,"y":140,"wires":[["ff965f7e.d53cb","5820ee2f.90f"]]},{"id":"5820ee2f.90f","type":"change","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"Store to flow.devices","rules":[{"t":"set","p":"devices","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1840,"y":140,"wires":[[]]},{"id":"7a39ceb3.28125","type":"debug","z":"becdaea7.25c7a","g":"6aa2d64c.7c2d58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1300,"y":80,"wires":[]},{"id":"bf0570b5.73ee8","type":"postgresql","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","query":"SELECT *\n  FROM channel_pulse_log\n WHERE timestamp > '{{{ msg.payload.dateStart }}}'\n   AND (slave_id, channel) IN {{{ msg.payload.devices }}};","postgreSQLConfig":"2c9b8cee.257e44","split":false,"rowsPerMsg":1,"outputs":1,"x":1510,"y":940,"wires":[["7416219b.e3dc5","66ad4504.e5fd3c"]]},{"id":"786014a5.2c487c","type":"inject","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1110,"y":940,"wires":[["2920c7dd.625ff8"]]},{"id":"2920c7dd.625ff8","type":"function","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"Assembly devices","func":"function formatForPostgresInQuery(arrayOfArrays) {\n    // Map each sub-array to a string in the format \"(x, y)\"\n    const formattedItems = arrayOfArrays.map(subArray => \n        `(${subArray.join(', ')})`\n    );\n\n    // Join all the formatted items into one string with proper enclosing\n    return `(${formattedItems.join(', ')})`;\n}\n\n\n// Fetch all flow sensor devices:\n\nconst devices = flow.get('devices') || {};\nconst now = new Date();\n\nnow.setMinutes(now.getMinutes() - 1);\n\n\nconst flowDevices = [];\n\nfor (const devKey in devices) {\n    const device = devices[devKey];\n    if (device.type === 'flow_sensor') {\n        flowDevices.push([device.slaveId, device.channelId]);\n    }\n}\n\nif (flowDevices.length === 0) {\n    return null;\n}\n\nmsg.payload = {\n    devices: formatForPostgresInQuery(flowDevices),\n    dateStart: now.toISOString(),\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":940,"wires":[["bf0570b5.73ee8","909d4384.2ad36"]]},{"id":"909d4384.2ad36","type":"debug","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1535,"y":980,"wires":[],"l":false},{"id":"7416219b.e3dc5","type":"function","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"Map devices","func":"// Fetch all flow sensor devices:\nconst devices = flow.get('devices') || {};\n\n// Extrai o multiplicador do nome do device (ex: \"Hidr. Name x100 2810m3\" -> 100)\nfunction getMultiplier(deviceName) {\n  const match = deviceName.match(/ x(\\d+\\.?\\d*)/i);\n  return match ? parseFloat(match[1]) : 1;\n}\n\n// Limpa o nome: remove \"Hidr.\" e variações + multiplicador\n// Ex: \"Hidr. Teta x100 2810m3\" -> \"Teta 2810m3\"\nfunction getCleanName(deviceName) {\n  return deviceName\n    .replace(/^hidr\\.?\\s*/i, '')      // Remove \"Hidr.\", \"Hidr \", \"HIDR.\" etc do início\n    .replace(/ x\\d+\\.?\\d*[AV]?/gi, '') // Remove multiplicador\n    .trim();\n}\n\nfunction findDevice(slaveId, channel) {\n  for (const devKey in devices) {\n    const device = devices[devKey];\n    if (device.slaveId === slaveId && device.channelId === channel) {\n      return device;\n    }\n  }\n  return null;\n}\n\n// Agrupa por nome limpo, aplicando o multiplicador nos pulsos\nmsg.payload = msg.payload.reduce((acc, reading) => {\n  const device = findDevice(reading.slave_id, reading.channel);\n  if (!device) return acc;\n\n  const cleanName = getCleanName(device.name);\n  const multiplier = getMultiplier(device.name);\n  const multipliedPulses = reading.value * multiplier;\n  const ts = new Date(reading.timestamp).getTime();\n\n  if (!(cleanName in acc)) {\n    acc[cleanName] = [];\n  }\n\n  acc[cleanName].push({\n    ts: ts,\n    values: { pulses: multipliedPulses },\n  });\n\n  return acc;\n}, {});\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1730,"y":940,"wires":[["9b58ea20.906e18","a3621c83.8b462"]]},{"id":"66ad4504.e5fd3c","type":"debug","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1675,"y":980,"wires":[],"l":false},{"id":"f2e09fc0.c5039","type":"function","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"Assembly devices","func":"function formatForPostgresInQuery(arrayOfArrays) {\n    // Map each sub-array to a string in the format \"(x, y)\"\n    const formattedItems = arrayOfArrays.map(subArray => \n        `(${subArray.join(', ')})`\n    );\n\n    // Join all the formatted items into one string with proper enclosing\n    return `(${formattedItems.join(', ')})`;\n}\n\n\n// Fetch all flow sensor devices:\n\nconst devices = flow.get('devices') || {};\nconst now = new Date();\n\nnow.setMinutes(now.getMinutes() - 800);\n\n\nconst flowDevices = [];\n\nfor (const devKey in devices) {\n    const device = devices[devKey];\n    if (device.type === 'flow_sensor') {\n        flowDevices.push([device.slaveId, device.channelId]);\n    }\n}\n\nif (flowDevices.length === 0) {\n    return null;\n}\n\nmsg.payload = {\n    devices: formatForPostgresInQuery(flowDevices),\n    dateStart: now.toISOString(),\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":980,"wires":[["bdca7b0c.2358b8"]]},{"id":"79add3dc.46d82c","type":"inject","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1100,"y":980,"wires":[["f2e09fc0.c5039"]]},{"id":"9b58ea20.906e18","type":"link out","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","links":["dc43faa3.6655e8","70ab5ed0.0dc2b","9f905f0e.09722","7cfeedaf.f39904"],"x":1895,"y":940,"wires":[]},{"id":"a3621c83.8b462","type":"debug","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1895,"y":980,"wires":[],"l":false},{"id":"bdca7b0c.2358b8","type":"debug","z":"becdaea7.25c7a","g":"9537256a.e8bc68","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1455,"y":980,"wires":[],"l":false},{"id":"5770604.6149fa","type":"inject","z":"89f6a7f4.954d2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":280,"y":280,"wires":[["3808f9d8.f0e34e"]]},{"id":"3808f9d8.f0e34e","type":"change","z":"89f6a7f4.954d2","name":"","rules":[{"t":"set","p":"lastSuccessfulRun","pt":"flow","to":"2024-12-12T21:45:00.000Z","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":280,"wires":[[]]},{"id":"1075325b.05312e","type":"postgresql","z":"89f6a7f4.954d2","name":"Get last 15 minutes","query":"SELECT \n  time_bucket('15 minutes', timestamp) AS quinze_min,\n  (AVG(value) * 0.25) AS value_wh,\n  slave_id\nFROM consumption_realtime\nWHERE slave_id = 12\n  AND timestamp >= '2024-11-06 00:00:00'\n  AND timestamp <= '2024-11-06 23:59:59'\nGROUP BY quinze_min, slave_id\nORDER BY quinze_min DESC;","postgreSQLConfig":"fe0bbd9.5bb3e4","split":false,"rowsPerMsg":1,"outputs":1,"x":570,"y":80,"wires":[["9d560e72.53dc3"]]},{"id":"437f32d6.c25ba4","type":"inject","z":"89f6a7f4.954d2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":80,"wires":[["1075325b.05312e"]]},{"id":"e6d1f76b.d0eae8","type":"debug","z":"89f6a7f4.954d2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":950,"y":120,"wires":[]},{"id":"9d560e72.53dc3","type":"function","z":"89f6a7f4.954d2","name":"","func":"msg.payload = msg.payload.reduce((acc, value) => {\n    return acc + value.value_wh;\n}, 0) / 1000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":120,"wires":[["e6d1f76b.d0eae8"]]},{"id":"95a63ddc.ae4c","type":"postgresql","z":"89f6a7f4.954d2","name":"Get last 15 minutes","query":"SELECT \n  time_bucket('15 minutes', timestamp) AS quinze_min,\n  (AVG(value) * 0.25) AS value_wh,\n  slave_id\nFROM consumption_realtime\nWHERE slave_id IN {{{ msg.payload.devices }}}\n  AND timestamp >= '{{{ msg.payload.dateStart }}}'\n  AND timestamp < '2025-02-26T03:00:00.000Z'\nGROUP BY quinze_min, slave_id\nORDER BY quinze_min DESC;","postgreSQLConfig":"fe0bbd9.5bb3e4","split":false,"rowsPerMsg":1,"outputs":1,"x":630,"y":500,"wires":[["ad3d201c.10866","8cc7b4b2.d8336"]]},{"id":"3545ac7c.35f164","type":"inject","z":"89f6a7f4.954d2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":260,"y":500,"wires":[["78c883c1.e7bee4","4debfe00.62392c"]]},{"id":"ad3d201c.10866","type":"debug","z":"89f6a7f4.954d2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":870,"y":500,"wires":[]},{"id":"78c883c1.e7bee4","type":"function","z":"89f6a7f4.954d2","name":"","func":"function formatForPostgresInQuery(devices) {\n    return `(${devices.join(', ')})`;\n}\n\n// Get the current time\nconst now = new Date();\nnode.warn(now);\n// Round down to the nearest 15-minute interval\nnow.setMinutes(now.getMinutes() - now.getMinutes() % 15, 0, 0);\n\n// Get the timestamp of the last successful run\nlet lastSuccessfulRun = new Date('2024-12-12T21:45:00.000Z');\n\nnode.warn(lastSuccessfulRun);\n\n// Check if at least 15 minutes have passed since the last successful run\nconst timeDifference = now.getTime() - lastSuccessfulRun.getTime();\nconst fifteenMinutesInMs = 15 * 60 * 1000;\n\nif (timeDifference < fifteenMinutesInMs) {\n    node.warn('Less than 15 minutes since last run. Skipping query.');\n    return null;\n}\n\n// Fetch all energy sensor devices\nconst devices = flow.get('devices') || {};\nconst energySensors = Object.values(devices)\n    .filter(device => device.name.indexOf('3F') > -1)\n    .map(device => device.slaveId);\n\nif (energySensors.length === 0) {\n    node.warn('No energy sensors.');\n    return null;\n}\n\nmsg.payload = {\n    devices: formatForPostgresInQuery(energySensors),\n    dateStart: lastSuccessfulRun.toISOString(),\n    dateEnd: now.toISOString()\n};\n// flow.set('lastSuccessfulRun', now.toISOString());\n\nnode.warn('Query parameters:');\nnode.warn(JSON.stringify(msg.payload, null, 2));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":500,"wires":[["95a63ddc.ae4c"]]},{"id":"8cc7b4b2.d8336","type":"function","z":"89f6a7f4.954d2","name":"","func":"// Fetch all flow sensor devices:\nconst devices = flow.get('devices') || {};\n\nfunction findDevice(slaveId) {\n    for (const devKey in devices) {\n        const device = devices[devKey];\n        \n        if (device.slaveId === slaveId) {\n            return device;\n        }\n    }\n}\n\nconst mappedDevices = {};\n\nmsg.payload = msg.payload.reduce((acc, reading) => {\n    const device = findDevice(reading.slave_id);\n    \n    if (!device) {\n        return acc;\n    }\n    \n    if (!(device.name in acc)) {\n        acc[device.name] = [];\n    }\n    \n    acc[device.name].push({\n        ts: new Date(reading.quinze_min).getTime(),\n        values: {\n            Wh3: reading.value_wh,\n        }\n    });\n    \n    return acc;\n}, {});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":860,"y":540,"wires":[["fbfcd01f.eb3dc","49cf667e.9ea378"]]},{"id":"fbfcd01f.eb3dc","type":"debug","z":"89f6a7f4.954d2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1050,"y":540,"wires":[]},{"id":"49cf667e.9ea378","type":"function","z":"89f6a7f4.954d2","name":"Queue","func":"const MAX_READINGS = 300;\nconst SEND_INTERVAL = 1500; // 5 seconds\nconst MAX_BYTES_PER_SECOND = 30 * 1024 / 8; // 200 kbps in bytes per second\nconst MAX_BYTES_PER_INTERVAL = MAX_BYTES_PER_SECOND * (SEND_INTERVAL / 1000);\n\n// Initialize queue in the node context if it doesn't exist\nif (!context.get('queue')) {\n    context.set('queue', []);\n}\n\n// Function to process and send the next batch\nfunction processNextBatch() {\n    const queue = context.get('queue');\n    let batchSize = 0;\n    let batchData = {};\n\n    while (queue.length > 0 && Object.keys(batchData).length < MAX_READINGS && batchSize < MAX_BYTES_PER_INTERVAL) {\n        const currentItem = queue[0];\n        const deviceName = currentItem.device;\n\n        if (!batchData[deviceName]) {\n            batchData[deviceName] = [];\n        }\n\n        const reading = currentItem.readings.shift();\n        batchData[deviceName].push(reading);\n        batchSize += JSON.stringify(reading).length;\n\n        if (currentItem.readings.length === 0) {\n            queue.shift(); // Remove the current device if all readings are sent\n        }\n    }\n\n    context.set('queue', queue);\n\n    if (Object.keys(batchData).length > 0) {\n        const msg = {\n            topic: 'energy/batch',\n            payload: batchData\n        };\n        node.send(msg);\n        node.status({fill:\"green\", shape:\"dot\", text:`Sent ${batchSize} bytes`});\n    } else {\n        node.status({fill:\"yellow\", shape:\"ring\", text:\"Queue empty\"});\n    }\n\n    // Always schedule the next batch, even if the queue is currently empty\n    setTimeout(() => {\n        context.set('isProcessing', false);\n        checkAndStartProcessing();\n    }, SEND_INTERVAL);\n}\n\n// Function to check queue and start processing if necessary\nfunction checkAndStartProcessing() {\n    const queue = context.get('queue');\n    if (queue.length > 0 && !context.get('isProcessing')) {\n        context.set('isProcessing', true);\n        processNextBatch();\n    }\n}\n\n// Main function logic\nif (msg.payload) {\n    const queue = context.get('queue');\n    const devices = Object.keys(msg.payload);\n\n    // Add new data to the queue\n    devices.forEach(device => {\n        const existingItem = queue.find(item => item.device === device);\n        if (existingItem) {\n            existingItem.readings = existingItem.readings.concat(msg.payload[device]);\n        } else {\n            queue.push({\n                device: device,\n                readings: msg.payload[device]\n            });\n        }\n    });\n\n    context.set('queue', queue);\n\n    // Check and start processing if it's not already running\n    checkAndStartProcessing();\n}\n\n// Return null to prevent the original message from being passed through\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1030,"y":580,"wires":[["45807a99.2800dc","485123c6.ef3814"]]},{"id":"4debfe00.62392c","type":"function","z":"89f6a7f4.954d2","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":580,"wires":[[]]},{"id":"8525ad02.7d435","type":"comment","z":"89f6a7f4.954d2","name":"BACKFILL DATA","info":"","x":280,"y":380,"wires":[]},{"id":"329a49f5.76604e","type":"inject","z":"89f6a7f4.954d2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":250,"y":700,"wires":[["e77c76a1.a0169"]]},{"id":"e77c76a1.a0169","type":"function","z":"89f6a7f4.954d2","name":"","func":"const name = \"3F SCP0LXXX Outback\"\nconsole.log(\"name\",name)\nconst devices = flow.get('devices') || {};\n\nconst device = devices[name];\n\nmsg.payload = device.slaveId;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":760,"wires":[["eecac876.6a7108"]]},{"id":"eecac876.6a7108","type":"debug","z":"89f6a7f4.954d2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":700,"y":780,"wires":[]},{"id":"45807a99.2800dc","type":"debug","z":"89f6a7f4.954d2","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1230,"y":540,"wires":[]},{"id":"485123c6.ef3814","type":"link out","z":"89f6a7f4.954d2","name":"","links":["7cfeedaf.f39904"],"x":1195,"y":660,"wires":[]},{"id":"b0e0aa9d.07465","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1200,"y":1220,"wires":[["72e2ef57.594fb8"]]},{"id":"72e2ef57.594fb8","type":"function","z":"becdaea7.25c7a","name":"","func":"const devices = flow.get('devices'); \nconst centralId = env.get('CENTRAL_UUID');\n\nconst messages = [];\n\nObject.keys(devices).forEach((key) => {\n    const device = devices[key];\n\n    const message = {\n        payload: {\n            name: key,\n            device: {\n                centralId: centralId\n            }\n        }\n    };\n\n    messages.push(message);\n});\n\nmsg.payload = messages;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1370,"y":1220,"wires":[["b35746e2.f76d2"]]},{"id":"b35746e2.f76d2","type":"function","z":"becdaea7.25c7a","name":"Add namespace","func":"const devices = flow.get('devices') || {}; \nconst centralId = msg.payload?.[0]?.payload?.device?.centralId || 'N/A';\n\nconst newPayload = Object.keys(devices).reduce((acc, key) => {\n    const device = devices[key];\n\n    acc[`${key} (Campinas Shopping)`] = {\n        centralId,\n        slaveId: device.slaveId,\n    };\n\n    return acc;\n}, {});\n\nmsg.payload = newPayload;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1495,"y":1220,"wires":[["f5a6ca68.305f88"]],"l":false},{"id":"f5a6ca68.305f88","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1610,"y":1220,"wires":[]},{"id":"6e3aa452.27dc94","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1200,"y":1380,"wires":[["f71184d9.243ce"]]},{"id":"f71184d9.243ce","type":"function","z":"becdaea7.25c7a","name":"","func":"const devices = flow.get('devices'); \nconst centralId = env.get('CENTRAL_UUID');\n\nconst newDevices = {};\n\nObject.keys(devices).forEach((key) => {\n    let device = devices[key]; \n\n    newDevices[`${key} (Campinas Shopping)`] = {\n        centralId,\n        slaveId: device.slaveId\n    };\n});\n\nmsg.payload = newDevices;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1370,"y":1380,"wires":[["4e2b7e70.57d108"]]},{"id":"4e2b7e70.57d108","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1710,"y":1380,"wires":[]},{"id":"5cebaf38.f4266","type":"comment","z":"becdaea7.25c7a","name":"Central ID dispositivo","info":"","x":1270,"y":1180,"wires":[]},{"id":"434292a3.c1526c","type":"comment","z":"becdaea7.25c7a","name":"Central ID Hidrometro","info":"","x":1240,"y":1320,"wires":[]},{"id":"3d707446.751bbc","type":"mqtt out","z":"becdaea7.25c7a","name":"Attribute","topic":"v1/gateway/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":1700,"y":1280,"wires":[]},{"id":"cdd71ff9.6eca4","type":"comment","z":"becdaea7.25c7a","name":"Slave Id + Central Id","info":"","x":1230,"y":1460,"wires":[]},{"id":"16ad5c47.76e67c","type":"postgresql","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","query":"SELECT \n    s.id AS slave_id,\n    s.name AS slave_name,\n    MAX(cr.timestamp) AS last_reading\nFROM \n    slaves s\nLEFT JOIN \n    consumption_realtime cr ON s.id = cr.slave_id\nWHERE \n    s.type = 'three_phase_sensor'\nGROUP BY \n    s.id, s.name\nHAVING \n    MAX(cr.timestamp) < NOW() - INTERVAL '72 hours'\n    OR MAX(cr.timestamp) IS NULL;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":350,"y":500,"wires":[["a85ffd35.087aa","7edaf6c7.ed4828"]]},{"id":"e287aea.020775","type":"inject","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"43200","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":280,"wires":[["1ae58005.a6705"]]},{"id":"1ae58005.a6705","type":"postgresql","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","query":"SELECT \n    c.slave_id,\n    c.channel,\n    c.name AS channel_name,\n    s.name AS slave_name,\n    MAX(cpl.timestamp) AS last_reading\nFROM \n    channels c\nLEFT JOIN \n    channel_pulse_log cpl ON c.slave_id = cpl.slave_id AND c.channel = cpl.channel\nLEFT JOIN \n    slaves s ON c.slave_id = s.id\nWHERE \n    c.name LIKE 'Hidr.%'\n  AND c.slave_id IS NOT NULL\nGROUP BY \n    c.slave_id, c.channel, c.name, s.name\nHAVING \n    MAX(cpl.timestamp) < NOW() - INTERVAL '72 hours'\n    OR MAX(cpl.timestamp) IS NULL;","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":380,"y":280,"wires":[["69005efc.325c88","a4be6daf.1257","883e9978.1a8128"]]},{"id":"69005efc.325c88","type":"debug","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":590,"y":280,"wires":[]},{"id":"a4be6daf.1257","type":"function","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","func":"// Parse input JSON (array of objects)\nconst data = msg.payload;\n\n// Table headers\nconst headers = [\"ID\", \"Ch\", \"Channel Name\", \"Last Reading\"];\nconst colWidths = [4, 4, 20, 12]; // Adjusted widths: slave_id, channel, channel_name, last_reading\n\n// Custom text to prepend\nconst customText = \"Devices with no readings in 72+ hours:\\n\";\n\n// Function to validate and format date\nfunction formatDate(dateStr) {\n    if (!dateStr) return \"No Reading\";\n    try {\n        const date = new Date(dateStr);\n        if (isNaN(date.getTime())) return \"Invalid Date\";\n        return date.toISOString().split('T')[0];\n    } catch (e) {\n        return \"Invalid Date\";\n    }\n}\n\n// Check if a device has an issue (last_reading is null or > 72 hours old)\nfunction hasIssue(row) {\n    if (!row.last_reading) return true;\n    try {\n        const lastReading = new Date(row.last_reading);\n        const now = new Date();\n        const hoursDiff = (now - lastReading) / (1000 * 60 * 60); // Convert ms to hours\n        return hoursDiff > 72;\n    } catch (e) {\n        return true; // Treat invalid dates as issues\n    }\n}\n\n// Format a single row\nfunction formatRow(row, widths, isHeader = false) {\n    const id = String(row.slave_id || row.id).padEnd(widths[0]);\n    const channel = String(row.channel || row.ch).padEnd(widths[1]);\n    const name = (row.channel_name || \"\").substring(0, widths[2]).padEnd(widths[2]);\n    const reading = isHeader \n        ? String(row.last_reading).padEnd(widths[3]) \n        : formatDate(row.last_reading).padEnd(widths[3]);\n    return `${id}${channel}${name}${reading}`;\n}\n\n// Determine if there are any devices with issues\nconst hasIssues = data.some(row => hasIssue(row));\n\n// Create table: custom text + headers + separator + rows\nlet output = customText;\noutput += formatRow({ id: headers[0], ch: headers[1], channel_name: headers[2], last_reading: headers[3] }, colWidths, true);\noutput += \"\\n\" + \"-\".repeat(colWidths.reduce((a, b) => a + b, 0)) + \"\\n\";\ndata.forEach(row => {\n    output += formatRow(row, colWidths, false) + \"\\n\";\n});\n\n// Set output to msg.payload and add hasIssues flag\nmsg.payload = output;\nmsg.hasIssues = hasIssues;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":600,"y":320,"wires":[["c44b1414.263848","83059dc8.5ea2c"]]},{"id":"c44b1414.263848","type":"debug","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":770,"y":320,"wires":[]},{"id":"83059dc8.5ea2c","type":"change","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","rules":[{"t":"set","p":"monitoringIssues","pt":"flow","to":"hasIssues","tot":"msg"},{"t":"set","p":"issueText","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":770,"y":360,"wires":[[]]},{"id":"1f7588e.71ee5f7","type":"inject","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"","props":[{"p":"url","v":"http://healthchecks.myio-bas.com/ping/75452b59-a2fc-4a88-8a8a-29bf4be1b3ec","vt":"str"},{"p":"topic","vt":"str"}],"repeat":"20","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":130,"y":100,"wires":[["62d2ea4a.edcf1c"]]},{"id":"11b04527.73d1e3","type":"http request","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":350,"y":100,"wires":[["e3d34de7.44dd8"]]},{"id":"e3d34de7.44dd8","type":"switch","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"OK","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":100,"wires":[["6b49f332.e9bbfc"],["e841fec1.cdc68","afbb6659.b698c"]]},{"id":"6b49f332.e9bbfc","type":"debug","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"Healthcheck sent.","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":690,"y":80,"wires":[]},{"id":"e841fec1.cdc68","type":"debug","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"Healthcheck failed.","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":690,"y":120,"wires":[]},{"id":"afbb6659.b698c","type":"function","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"","func":"let healthcheckFailureCount = flow.get('healthcheck_failure_count');\n\nif (healthcheckFailureCount == null) {\n    healthcheckFailureCount = 0;\n}\n\nhealthcheckFailureCount += 1;\n\nflow.set('healthcheck_failure_count', healthcheckFailureCount);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":650,"y":160,"wires":[[]]},{"id":"62d2ea4a.edcf1c","type":"function","z":"cfa6c531.a6501","g":"59e68346.37013c","name":"","func":"const monitoringIssues = flow.get('monitoringIssues') || false;\nconst issueText = flow.get('issueText') || '';\nconst energyIssuesText = flow.get('energyIssuesText') || '';\n\nif (monitoringIssues) {\n    msg.payload = `${issueText}\\r\\n\\r\\n\\r\\n${energyIssuesText}`;\n}\n msg.payload = `${issueText}\\r\\n\\r\\n\\r\\n${energyIssuesText}`;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":235,"y":100,"wires":[["11b04527.73d1e3"]],"l":false},{"id":"50d5633c.283da4","type":"inject","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"43200","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":500,"wires":[["16ad5c47.76e67c"]]},{"id":"a85ffd35.087aa","type":"function","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","func":"// Parse input JSON (array of objects)\nconst data = msg.payload;\n\n// Table headers\nconst headers = [\"ID\", \"Device Name\", \"Last Reading\"];\nconst colWidths = [4, 20, 12]; // Widths: slave_id, slave_name, last_reading\n\n// Custom text to prepend\nconst customText = \"Energy devices with no readings in 72+ hours:\\n\";\n\n// Function to validate and format date\nfunction formatDate(dateStr) {\n    if (!dateStr) return \"No Reading\";\n    try {\n        const date = new Date(dateStr);\n        if (isNaN(date.getTime())) return \"Invalid Date\";\n        return date.toISOString().split('T')[0];\n    } catch (e) {\n        return \"Invalid Date\";\n    }\n}\n\n// Check if a device has an issue (last_reading is null or > 72 hours old)\nfunction hasIssue(row) {\n    if (!row.last_reading) return true;\n    try {\n        const lastReading = new Date(row.last_reading);\n        const now = new Date();\n        const hoursDiff = (now - lastReading) / (1000 * 60 * 60); // Convert ms to hours\n        return hoursDiff > 72;\n    } catch (e) {\n        return true; // Treat invalid dates as issues\n    }\n}\n\n// Format a single row\nfunction formatRow(row, widths, isHeader = false) {\n    const id = String(row.slave_id || row.id).padEnd(widths[0]);\n    const name = (row.slave_name || \"\").substring(0, widths[1]).padEnd(widths[1]);\n    const reading = isHeader \n        ? String(row.last_reading).padEnd(widths[2]) \n        : formatDate(row.last_reading).padEnd(widths[2]);\n    return `${id}${name}${reading}`;\n}\n\n// Determine if there are any devices with issues\nconst hasIssues = data.some(row => hasIssue(row));\n\n// Create table: custom text + headers + separator + rows\nlet output = customText;\noutput += formatRow({ id: headers[0], slave_name: headers[1], last_reading: headers[2] }, colWidths, true);\noutput += \"\\n\" + \"-\".repeat(colWidths.reduce((a, b) => a + b, 0)) + \"\\n\";\ndata.forEach(row => {\n    output += formatRow(row, colWidths, false) + \"\\n\";\n});\n\n// Set output to msg.payload and add hasIssues flag\nmsg.payload = output;\nmsg.hasIssues = hasIssues;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":500,"wires":[["6543a13c.2d431","48c2ced2.547028"]]},{"id":"6543a13c.2d431","type":"debug","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":740,"y":500,"wires":[]},{"id":"48c2ced2.547028","type":"change","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","rules":[{"t":"set","p":"monitoringIssues","pt":"flow","to":"hasIssues","tot":"msg"},{"t":"set","p":"energyIssuesText","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":540,"wires":[[]]},{"id":"717dba9f.c290f4","type":"postgresql","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"Get last 15 minutes","query":"WITH slave_multipliers AS (\n  SELECT \n    id,\n    COALESCE(\n      CASE \n        WHEN name ~ ' x\\d+\\.?\\d*($|\\s)' THEN \n          CAST(REGEXP_REPLACE(name, '.* x(\\d+\\.?\\d*)(?:$|\\s).*', '\\1') AS NUMERIC)\n        ELSE 1\n      END,\n      1\n    ) AS multiplier\n  FROM slaves\n)\nSELECT \n  time_bucket('15 minutes', cr.timestamp) AS quinze_min,\n  (AVG(cr.value) * 0.25 * sm.multiplier) AS value_wh,\n  cr.slave_id\nFROM consumption_realtime cr\nJOIN slave_multipliers sm ON cr.slave_id = sm.id\nWHERE cr.slave_id IN {{{ msg.payload.devices }}}\n  AND cr.timestamp >= '{{{ msg.payload.dateStart }}}'\nGROUP BY quinze_min, cr.slave_id, sm.multiplier\nORDER BY quinze_min DESC;","postgreSQLConfig":"e119bc39.937ae8","split":false,"rowsPerMsg":1,"outputs":1,"x":490,"y":2960,"wires":[["4d19dd7e.fc5f2c","b24ac173.c0fea8"]]},{"id":"8340a25c.0361a","type":"inject","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"900","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":2960,"wires":[["86a98892.5a7788"]]},{"id":"4d19dd7e.fc5f2c","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":675,"y":2920,"wires":[],"l":false},{"id":"86a98892.5a7788","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","func":"function formatForPostgresInQuery(devices) {\n    return `(${devices.join(', ')})`;\n}\n\n// Get the current time\nconst now = new Date();\n\n// Round down to the nearest 15-minute interval\nnow.setMinutes(now.getMinutes() - now.getMinutes() % 15, 0, 0);\n\n// Get the timestamp of the last successful run\nlet lastSuccessfulRun = flow.get('lastSuccessfulRun');\n\nif (!lastSuccessfulRun) {\n    // If it's the first run, set it to 15 minutes ago\n    lastSuccessfulRun = new Date(now.getTime() - 15 * 60000);\n} else {\n    lastSuccessfulRun = new Date(lastSuccessfulRun);\n}\n\n// Check if at least 15 minutes have passed since the last successful run\nconst timeDifference = now.getTime() - lastSuccessfulRun.getTime();\nconst fifteenMinutesInMs = 15 * 60 * 1000;\n\nif (timeDifference < fifteenMinutesInMs) {\n    node.warn('Less than 15 minutes since last run. Skipping query.');\n    return null;\n}\n\n// Fetch all energy sensor devices\nconst devices = flow.get('devices') || {};\nconst energySensors = Object.values(devices)\n    .filter(device => device.deviceKind === 'energy')\n    .map(device => device.slaveId);\n\nif (energySensors.length === 0) {\n    node.warn('No energy sensors.');\n    return null;\n}\n\nmsg.payload = {\n    devices: formatForPostgresInQuery(energySensors),\n    dateStart: lastSuccessfulRun.toISOString(),\n    dateEnd: now.toISOString()\n};\n\n// Store the current time as the last successful run\nflow.set('lastSuccessfulRun', now.toISOString());\n\nnode.warn('Query parameters:');\nnode.warn(JSON.stringify(msg.payload, null, 2));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":2960,"wires":[["8d5ae88e.485648","717dba9f.c290f4"]]},{"id":"8d5ae88e.485648","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":415,"y":2920,"wires":[],"l":false},{"id":"b24ac173.c0fea8","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","func":"// Fetch all flow sensor devices:\nconst devices = flow.get('devices') || {};\n\nfunction findDevice(slaveId) {\n    for (const devKey in devices) {\n        const device = devices[devKey];\n        \n        if (device.slaveId === slaveId) {\n            return device;\n        }\n    }\n}\n\nconst mappedDevices = {};\n\nmsg.payload = msg.payload.reduce((acc, reading) => {\n    const device = findDevice(reading.slave_id);\n    \n    if (!device) {\n        return acc;\n    }\n    \n    if (!(device.name in acc)) {\n        acc[device.name] = [];\n    }\n    \n    acc[device.name].push({\n        ts: new Date(reading.quinze_min).getTime(),\n        values: {\n            Wh3: reading.value_wh,\n        }\n    });\n    \n    return acc;\n}, {});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":2960,"wires":[["57ea04d2.9c7b0c","e0d3780b.06cb6"]]},{"id":"57ea04d2.9c7b0c","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":855,"y":2920,"wires":[],"l":false},{"id":"e0d3780b.06cb6","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"Queue","func":"const MAX_READINGS = 300;\nconst SEND_INTERVAL = 1500; // 5 seconds\nconst MAX_BYTES_PER_SECOND = 30 * 1024 / 8; // 200 kbps in bytes per second\nconst MAX_BYTES_PER_INTERVAL = MAX_BYTES_PER_SECOND * (SEND_INTERVAL / 1000);\n\n// Initialize queue in the node context if it doesn't exist\nif (!context.get('queue')) {\n    context.set('queue', []);\n}\n\n// Function to process and send the next batch\nfunction processNextBatch() {\n    const queue = context.get('queue');\n    let batchSize = 0;\n    let batchData = {};\n\n    while (queue.length > 0 && Object.keys(batchData).length < MAX_READINGS && batchSize < MAX_BYTES_PER_INTERVAL) {\n        const currentItem = queue[0];\n        const deviceName = currentItem.device;\n\n        if (!batchData[deviceName]) {\n            batchData[deviceName] = [];\n        }\n\n        const reading = currentItem.readings.shift();\n        batchData[deviceName].push(reading);\n        batchSize += JSON.stringify(reading).length;\n\n        if (currentItem.readings.length === 0) {\n            queue.shift(); // Remove the current device if all readings are sent\n        }\n    }\n\n    context.set('queue', queue);\n\n    if (Object.keys(batchData).length > 0) {\n        const msg = {\n            topic: 'energy/batch',\n            payload: batchData\n        };\n        node.send(msg);\n        node.status({fill:\"green\", shape:\"dot\", text:`Sent ${batchSize} bytes`});\n    } else {\n        node.status({fill:\"yellow\", shape:\"ring\", text:\"Queue empty\"});\n    }\n\n    // Always schedule the next batch, even if the queue is currently empty\n    setTimeout(() => {\n        context.set('isProcessing', false);\n        checkAndStartProcessing();\n    }, SEND_INTERVAL);\n}\n\n// Function to check queue and start processing if necessary\nfunction checkAndStartProcessing() {\n    const queue = context.get('queue');\n    if (queue.length > 0 && !context.get('isProcessing')) {\n        context.set('isProcessing', true);\n        processNextBatch();\n    }\n}\n\n// Main function logic\nif (msg.payload) {\n    const queue = context.get('queue');\n    const devices = Object.keys(msg.payload);\n\n    // Add new data to the queue\n    devices.forEach(device => {\n        const existingItem = queue.find(item => item.device === device);\n        if (existingItem) {\n            existingItem.readings = existingItem.readings.concat(msg.payload[device]);\n        } else {\n            queue.push({\n                device: device,\n                readings: msg.payload[device]\n            });\n        }\n    });\n\n    context.set('queue', queue);\n\n    // Check and start processing if it's not already running\n    checkAndStartProcessing();\n}\n\n// Return null to prevent the original message from being passed through\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":2960,"wires":[["8dd32a76.4646e8","191334e9.0d8d33"]]},{"id":"8dd32a76.4646e8","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1035,"y":2960,"wires":[],"l":false},{"id":"191334e9.0d8d33","type":"link out","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","links":["c679bdd1.0c0f","6538625b.8565cc","7cfeedaf.f39904"],"x":1035,"y":2920,"wires":[]},{"id":"4b14d1c0.5df5b8","type":"postgresql","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"Get last 15 minutes","query":"WITH slave_multipliers AS (\n  SELECT \n    id,\n    COALESCE(\n      CASE \n        WHEN name ~ ' x\\d+\\.?\\d*($|\\s)' THEN \n          CAST(REGEXP_REPLACE(name, '.* x(\\d+\\.?\\d*)(?:$|\\s).*', '\\1') AS NUMERIC)\n        ELSE 1\n      END,\n      1\n    ) AS multiplier\n  FROM slaves\n)\nSELECT \n  time_bucket('15 minutes', cr.timestamp) AS quinze_min,\n  (AVG(cr.value) * 0.25 * sm.multiplier) AS value_wh,\n  cr.slave_id\nFROM consumption_realtime cr\nJOIN slave_multipliers sm ON cr.slave_id = sm.id\nWHERE cr.slave_id IN {{{ msg.payload.devices }}}\n  AND cr.timestamp >= '2025-03-01 00:00:00'\n  AND cr.timestamp <= '2025-04-07 23:59:59'\n  AND cr.slave_id = 10\nGROUP BY quinze_min, cr.slave_id, sm.multiplier\nORDER BY quinze_min DESC;","postgreSQLConfig":"e119bc39.937ae8","split":false,"rowsPerMsg":1,"outputs":1,"x":490,"y":3020,"wires":[["d02c07a8.717f28","cc2bc090.e2d078"]]},{"id":"70fd2ab.092e054","type":"inject","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":3020,"wires":[["303029f.2d4c056"]]},{"id":"303029f.2d4c056","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","func":"function formatForPostgresInQuery(devices) {\n    return `(${devices.join(', ')})`;\n}\n\n// Get the current time\nconst now = new Date();\n\n// Round down to the nearest 15-minute interval\nnow.setMinutes(now.getMinutes() - now.getMinutes() % 15, 0, 0);\n\n// Get the timestamp of the last successful run\nlet lastSuccessfulRun = false; // flow.get('lastSuccessfulRun');\n\nif (!lastSuccessfulRun) {\n    // If it's the first run, set it to 15 minutes ago\n    lastSuccessfulRun = new Date(now.getTime() - 15 * 60000);\n} else {\n    lastSuccessfulRun = new Date(lastSuccessfulRun);\n}\n\n// Check if at least 15 minutes have passed since the last successful run\nconst timeDifference = now.getTime() - lastSuccessfulRun.getTime();\nconst fifteenMinutesInMs = 15 * 60 * 1000;\n\nif (timeDifference < fifteenMinutesInMs) {\n    node.warn('Less than 15 minutes since last run. Skipping query.');\n    return null;\n}\n\n// Fetch all energy sensor devices\nconst devices = flow.get('devices') || {};\nconst energySensors = Object.values(devices)\n    .filter(device => device.deviceKind === 'energy')\n    .map(device => device.slaveId);\n\nif (energySensors.length === 0) {\n    node.warn('No energy sensors.');\n    return null;\n}\n\nmsg.payload = {\n    devices: formatForPostgresInQuery(energySensors),\n    dateStart: lastSuccessfulRun.toISOString(),\n    dateEnd: now.toISOString()\n};\n\n// Store the current time as the last successful run\nflow.set('lastSuccessfulRun', now.toISOString());\n\nnode.warn('Query parameters:');\nnode.warn(JSON.stringify(msg.payload, null, 2));\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":3020,"wires":[["4b14d1c0.5df5b8"]]},{"id":"d02c07a8.717f28","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":730,"y":3060,"wires":[]},{"id":"5450fb0f.aade34","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"Queue","func":"const MAX_READINGS = 300;\nconst SEND_INTERVAL = 1500; // 5 seconds\nconst MAX_BYTES_PER_SECOND = 30 * 1024 / 8; // 200 kbps in bytes per second\nconst MAX_BYTES_PER_INTERVAL = MAX_BYTES_PER_SECOND * (SEND_INTERVAL / 1000);\n\n// Initialize queue in the node context if it doesn't exist\nif (!context.get('queue')) {\n    context.set('queue', []);\n}\n\n// Function to process and send the next batch\nfunction processNextBatch() {\n    const queue = context.get('queue');\n    let batchSize = 0;\n    let batchData = {};\n\n    while (queue.length > 0 && Object.keys(batchData).length < MAX_READINGS && batchSize < MAX_BYTES_PER_INTERVAL) {\n        const currentItem = queue[0];\n        const deviceName = currentItem.device;\n\n        if (!batchData[deviceName]) {\n            batchData[deviceName] = [];\n        }\n\n        const reading = currentItem.readings.shift();\n        batchData[deviceName].push(reading);\n        batchSize += JSON.stringify(reading).length;\n\n        if (currentItem.readings.length === 0) {\n            queue.shift(); // Remove the current device if all readings are sent\n        }\n    }\n\n    context.set('queue', queue);\n\n    if (Object.keys(batchData).length > 0) {\n        const msg = {\n            topic: 'energy/batch',\n            payload: batchData\n        };\n        node.send(msg);\n        node.status({fill:\"green\", shape:\"dot\", text:`Sent ${batchSize} bytes`});\n    } else {\n        node.status({fill:\"yellow\", shape:\"ring\", text:\"Queue empty\"});\n    }\n\n    // Always schedule the next batch, even if the queue is currently empty\n    setTimeout(() => {\n        context.set('isProcessing', false);\n        checkAndStartProcessing();\n    }, SEND_INTERVAL);\n}\n\n// Function to check queue and start processing if necessary\nfunction checkAndStartProcessing() {\n    const queue = context.get('queue');\n    if (queue.length > 0 && !context.get('isProcessing')) {\n        context.set('isProcessing', true);\n        processNextBatch();\n    }\n}\n\n// Main function logic\nif (msg.payload) {\n    const queue = context.get('queue');\n    const devices = Object.keys(msg.payload);\n\n    // Add new data to the queue\n    devices.forEach(device => {\n        const existingItem = queue.find(item => item.device === device);\n        if (existingItem) {\n            existingItem.readings = existingItem.readings.concat(msg.payload[device]);\n        } else {\n            queue.push({\n                device: device,\n                readings: msg.payload[device]\n            });\n        }\n    });\n\n    context.set('queue', queue);\n\n    // Check and start processing if it's not already running\n    checkAndStartProcessing();\n}\n\n// Return null to prevent the original message from being passed through\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":3020,"wires":[["191334e9.0d8d33","176d870f.fcf6a1"]]},{"id":"cc2bc090.e2d078","type":"function","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","func":"// Fetch all flow sensor devices:\nconst devices = flow.get('devices') || {};\n\nfunction findDevice(slaveId) {\n    for (const devKey in devices) {\n        const device = devices[devKey];\n        \n        if (device.slaveId === slaveId) {\n            return device;\n        }\n    }\n}\n\nconst mappedDevices = {};\n\nmsg.payload = msg.payload.reduce((acc, reading) => {\n    const device = findDevice(reading.slave_id);\n    \n    if (!device) {\n        return acc;\n    }\n    \n    if (!(device.name in acc)) {\n        acc[device.name] = [];\n    }\n    \n    acc[device.name].push({\n        ts: new Date(reading.quinze_min).getTime(),\n        values: {\n            Wh3: reading.value_wh,\n        }\n    });\n    \n    return acc;\n}, {});\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":3020,"wires":[["5450fb0f.aade34"]]},{"id":"176d870f.fcf6a1","type":"debug","z":"becdaea7.25c7a","g":"dffe1eb8.eb0158","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1070,"y":3040,"wires":[]},{"id":"7b58de6a.a6f2a","type":"comment","z":"becdaea7.25c7a","g":"9833aba1.1eba1","name":"Consumption report V5","info":"","x":160,"y":3380,"wires":[]},{"id":"832254c1.0f7ee8","type":"function","z":"becdaea7.25c7a","g":"9833aba1.1eba1","name":"","func":"let slaveIds = msg.req.params.slaveIds;\n\nmsg.payload = slaveIds.split(',');\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":500,"y":3460,"wires":[["beafe48d.eb7488"]]},{"id":"beafe48d.eb7488","type":"postgresql","z":"becdaea7.25c7a","g":"9833aba1.1eba1","name":"","query":"WITH hourly_data AS (\n    SELECT\n        cr.slave_id,\n        time_bucket('1 hour', cr.timestamp) AS hour,\n        AVG(cr.value) AS hourly_avg\n    FROM\n        consumption_realtime cr\n    JOIN \n        slaves s ON cr.slave_id = s.id\n    WHERE\n        cr.slave_id IN ({{ msg.payload }})\n        AND cr.timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n        AND (cr.value / 3.0) <= (\n            CASE COALESCE(s.clamp_type, '0')\n                WHEN '0' THEN 50\n                WHEN '1' THEN 100\n                WHEN '2' THEN 400\n                WHEN '3' THEN 1000\n                WHEN '4' THEN 2000\n                WHEN '5' THEN 1600\n                WHEN '6' THEN 1000\n                ELSE 0\n            END * 220\n        )\n    GROUP BY\n        cr.slave_id, hour\n)\nSELECT\n    hd.slave_id,\n    s.name AS device_name,\n    SUM(hd.hourly_avg) / 1000 AS total_consumption_kwh\nFROM \n    hourly_data hd\nJOIN \n    slaves s ON s.id = hd.slave_id\nGROUP BY\n    hd.slave_id,\n    s.name\nORDER BY\n    hd.slave_id;\n","postgreSQLConfig":"6eac0185.312bb","split":false,"rowsPerMsg":1,"outputs":1,"x":690,"y":3460,"wires":[["e20d79bf.1fa0b8"]]},{"id":"e20d79bf.1fa0b8","type":"http response","z":"becdaea7.25c7a","g":"9833aba1.1eba1","name":"","statusCode":"200","headers":{},"x":880,"y":3460,"wires":[]},{"id":"94334f91.8fc64","type":"http in","z":"becdaea7.25c7a","g":"9833aba1.1eba1","name":"Consumption per device in a range.","url":"/dash_api/v3/consumption_per_device/:slaveIds/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":200,"y":3460,"wires":[["832254c1.0f7ee8"]]},{"id":"8963802e.bc5f7","type":"http in","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"Average Consumption pulses V2","url":"/dash_api/v2/devices_pulses/:slaveIds/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":190,"y":3920,"wires":[["7e046cea.8711ec"]]},{"id":"7e046cea.8711ec","type":"function","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"","func":"const slaveIds = msg.req.params.slaveIds;\n\nmsg.payload = slaveIds.split(\",\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":3920,"wires":[["a6332aa3.034868"]]},{"id":"a6332aa3.034868","type":"postgresql","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"","query":"WITH channel_info AS (\n    SELECT\n        slave_id,\n        name,\n        COALESCE(CAST((regexp_match(name, 'x([0-9.]+)'))[1] AS FLOAT), 1) AS multiplier\n    FROM\n        channels\n    WHERE\n        slave_id = ANY (ARRAY[{{ msg.payload }}])\n        AND channel = 1\n),\nhourly_metrics AS (\n    SELECT\n        c.slave_id,\n        time_bucket('1 hour', cpl.timestamp) AS consumption_hour,\n        SUM(cpl.value) AS hourly_consumption_L\n    FROM\n        channel_info c\n    INNER JOIN\n        channel_pulse_log cpl\n        ON c.slave_id = cpl.slave_id\n        AND cpl.timestamp >= TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND cpl.timestamp < TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n        AND cpl.value >= 0\n        AND cpl.channel = 1\n    GROUP BY\n        c.slave_id, consumption_hour\n),\ntotals_per_slave AS (\n    SELECT\n        slave_id,\n        SUM(hourly_consumption_L) AS total_consumption_L,\n        COUNT(DISTINCT EXTRACT(HOUR FROM consumption_hour)) AS active_hours,\n        MAX(hourly_consumption_L) AS max_hourly_consumption_L,\n        MIN(hourly_consumption_L) AS min_hourly_consumption_L\n    FROM\n        hourly_metrics\n    GROUP BY\n        slave_id\n),\nmax_min_hours AS (\n    SELECT\n        h.slave_id,\n        MIN(CASE WHEN h.hourly_consumption_L = d.max_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM h.consumption_hour) END) AS hour_of_max_consumption,\n        MIN(CASE WHEN h.hourly_consumption_L = d.min_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM h.consumption_hour) END) AS hour_of_min_consumption\n    FROM\n        hourly_metrics h\n    JOIN\n        totals_per_slave d ON h.slave_id = d.slave_id\n    GROUP BY\n        h.slave_id\n)\nSELECT\n    c.slave_id,\n    c.name AS device_name,\n    COALESCE(d.total_consumption_L, 0) AS total_consumption_L,\n    c.multiplier,\n    (COALESCE(d.total_consumption_L, 0) * c.multiplier) / 1000 AS total_consumption_m3,\n    COALESCE(d.active_hours, 0) AS active_hours,\n    COALESCE(d.max_hourly_consumption_L, 0) AS max_hourly_consumption_L,\n    COALESCE(d.min_hourly_consumption_L, 0) AS min_hourly_consumption_L,\n    m.hour_of_max_consumption,\n    m.hour_of_min_consumption\nFROM\n    channel_info c\nLEFT JOIN\n    totals_per_slave d ON c.slave_id = d.slave_id\nLEFT JOIN\n    max_min_hours m ON c.slave_id = m.slave_id\nORDER BY\n    total_consumption_m3 DESC;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":650,"y":3920,"wires":[["1276eff8.2a76c"]]},{"id":"6b606767.4339d","type":"http response","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"","statusCode":"200","headers":{},"x":1020,"y":3920,"wires":[]},{"id":"82888aa0.34bb48","type":"comment","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"Pulses report V4","info":"Pulses report","x":140,"y":3860,"wires":[]},{"id":"1276eff8.2a76c","type":"function","z":"becdaea7.25c7a","g":"8265624b.5df1","name":"","func":"const devices = msg.payload;\n\nconst processedDevices = devices.map(device => {\n  const multiplierMatch = device.device_name.match(/x(\\d+)/);\n  const multiplier = multiplierMatch ? parseInt(multiplierMatch[1], 10) : 1;\n\n  const cleanedName = device.device_name\n    .replace(/^Hidr\\.\\s*/, '') \n    .replace(/\\s*x\\d+.*$/, ''); \n\n  const totalConsumptionL = parseFloat(device.total_consumption_l) * multiplier;\n  const maxHourlyConsumptionL = parseFloat(device.max_hourly_consumption_l) * multiplier;\n  const minHourlyConsumptionL = parseFloat(device.min_hourly_consumption_l) * multiplier;\n  const avgLPerHour = parseFloat(device.avg_l_per_hour) * multiplier;\n\n  return {\n    ...device, \n    device_name: cleanedName, \n    total_consumption_l: totalConsumptionL.toString(),\n    max_hourly_consumption_l: maxHourlyConsumptionL.toString(),\n    min_hourly_consumption_l: minHourlyConsumptionL.toString(),\n    avg_l_per_hour: avgLPerHour.toString()\n  };\n});\n\nmsg.payload = processedDevices;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":3920,"wires":[["6b606767.4339d"]]},{"id":"a5354b50.e84cc","type":"http in","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"Average Consumption pulses V2","url":"/dash_api/devices_pulses/:name/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":190,"y":3620,"wires":[["f4fa4c9d.9f797"]]},{"id":"f4fa4c9d.9f797","type":"function","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","func":"const nameParam = msg.req.params.name;\nconst nameArray = nameParam.split(\",\");\nconst ids = [];\n\nconst devicesObj = flow.get('devices') || {};\nconst devicesArray = Object.values(devicesObj); \nnode.warn(\"deviceArray\", devicesArray);\n\nnameArray.forEach(data => {\n    const device = devicesArray.find(device => \n        device.name && device.name.indexOf(data) > -1 \n    );\n    node.warn(device);\n    \n    if (device && device.slaveId !== undefined) { \n        ids.push(device.slaveId);\n    } else {\n        node.warn(\"Dispositivo não encontrado para: \" + data);\n    }\n});\nmsg.payload = ids.join(\",\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":3620,"wires":[["973e9b8e.4c2a98"]]},{"id":"973e9b8e.4c2a98","type":"postgresql","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","query":"WITH hourly_metrics AS (\n    SELECT\n        slave_id,\n        time_bucket('1 hour', timestamp) AS consumption_hour,\n        SUM(value) AS hourly_consumption_L\n    FROM\n        channel_pulse_log\n    WHERE\n        slave_id = ANY (ARRAY[{{ msg.payload }}])\n        AND timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n        AND value >= 0\n    GROUP BY\n        slave_id, consumption_hour\n),\ntotals_per_slave AS (\n    SELECT\n        slave_id,\n        SUM(hourly_consumption_L) AS total_consumption_L,\n        COUNT(DISTINCT EXTRACT(HOUR FROM consumption_hour)) AS active_hours,\n        MAX(hourly_consumption_L) AS max_hourly_consumption_L,\n        MIN(hourly_consumption_L) AS min_hourly_consumption_L\n    FROM\n        hourly_metrics\n    GROUP BY\n        slave_id\n),\nmax_min_hours AS (\n    SELECT\n        h.slave_id,\n        MAX(CASE WHEN h.hourly_consumption_L = d.max_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM (h.consumption_hour AT TIME ZONE 'UTC' AT TIME ZONE 'America/Sao_Paulo')) END) AS hour_of_max_consumption,\n        MIN(CASE WHEN h.hourly_consumption_L = d.min_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM (h.consumption_hour AT TIME ZONE 'UTC' AT TIME ZONE 'America/Sao_Paulo')) END) AS hour_of_min_consumption\n    FROM\n        hourly_metrics h\n    JOIN\n        totals_per_slave d ON h.slave_id = d.slave_id\n    GROUP BY\n        h.slave_id\n)\nSELECT\n    d.slave_id,\n    s.name AS device_name,\n    d.total_consumption_L,\n    d.active_hours,\n    ROUND(d.total_consumption_L / NULLIF(d.active_hours, 0)::numeric, 2) AS avg_L_per_hour,\n    d.max_hourly_consumption_L,\n    d.min_hourly_consumption_L,\n    m.hour_of_max_consumption,\n    m.hour_of_min_consumption\nFROM\n    totals_per_slave d\nLEFT JOIN\n    max_min_hours m ON d.slave_id = m.slave_id\nJOIN\n    slaves s ON s.id = d.slave_id\nORDER BY\n    d.slave_id;\n","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":650,"y":3620,"wires":[["33825453.a2a73c"]]},{"id":"f5604d2d.53f7a","type":"http response","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","statusCode":"200","headers":{},"x":1020,"y":3620,"wires":[]},{"id":"899c9dd7.fb5828","type":"http in","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"Daily Devices Pulses V2","url":"/dash_api/demand_pulses/:name/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":170,"y":3660,"wires":[["e6934534.f8c3d8"]]},{"id":"e6934534.f8c3d8","type":"function","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","func":"const nameParam = msg.req.params.name;\nconst nameArray = nameParam.split(\",\");\nconst ids = [];\n\nconst devicesObj = flow.get('devices') || {};\nconst devicesArray = Object.values(devicesObj); \nnode.warn(\"deviceArray\", devicesArray);\n\nnameArray.forEach(data => {\n    const device = devicesArray.find(device => \n        device.name && device.name.indexOf(data) > -1 \n    );\n    node.warn(device);\n    \n    if (device && device.slaveId !== undefined) { \n        ids.push(device.slaveId);\n    } else {\n        node.warn(\"Dispositivo não encontrado para: \" + data);\n    }\n});\nmsg.payload = ids.join(\",\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":440,"y":3660,"wires":[["c85e014e.db7e2","a665d4c0.e8edb","5cd1f548.c8a5f4","26e3b2c.fb57c4e"]]},{"id":"c85e014e.db7e2","type":"postgresql","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","query":"WITH hourly_metrics AS (\n    SELECT\n        c.slave_id,\n        time_bucket('1 day', cpl.timestamp, INTERVAL '3 hours') AS consumption_date,\n        time_bucket('1 hour', cpl.timestamp) AS consumption_hour,\n        SUM(cpl.value) AS hourly_consumption_L,\n        COALESCE(CAST((regexp_match(c.name, 'x([0-9.]+)'))[1] AS FLOAT), 1) AS multiplier\n    FROM\n        channels c\n    LEFT JOIN\n        channel_pulse_log cpl\n        ON c.slave_id = cpl.slave_id\n        AND cpl.timestamp >= TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n        AND cpl.timestamp < TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n        AND cpl.value >= 0\n        AND cpl.channel = 1\n    WHERE\n        c.slave_id = {{ msg.payload }}\n        AND c.channel = 1\n    GROUP BY\n        c.slave_id, c.name, consumption_date, consumption_hour\n),\ndaily_metrics AS (\n    SELECT\n        consumption_date,\n        SUM(hourly_consumption_L * multiplier) / 1000 AS total_consumption_m3,\n        COUNT(DISTINCT EXTRACT(HOUR FROM consumption_hour)) AS active_hours,\n        MAX(hourly_consumption_L * multiplier) / 1000 AS max_hourly_consumption_m3,\n        MIN(hourly_consumption_L * multiplier) / 1000 AS min_hourly_consumption_m3,\n        multiplier\n    FROM\n        hourly_metrics\n    GROUP BY\n        consumption_date, multiplier\n),\nmax_min_hours AS (\n    SELECT\n        h.consumption_date,\n        MAX(CASE WHEN (h.hourly_consumption_L * h.multiplier) / 1000 = d.max_hourly_consumption_m3 \n                 THEN EXTRACT(HOUR FROM h.consumption_hour) END) AS hour_of_max_consumption,\n        MIN(CASE WHEN (h.hourly_consumption_L * h.multiplier) / 1000 = d.min_hourly_consumption_m3 \n                 THEN EXTRACT(HOUR FROM h.consumption_hour) END) AS hour_of_min_consumption\n    FROM\n        hourly_metrics h\n    JOIN\n        daily_metrics d\n    ON\n        h.consumption_date = d.consumption_date\n    GROUP BY\n        h.consumption_date\n)\nSELECT\n    to_char(d.consumption_date, 'YYYY-MM-DD\"T\"HH24:MI:SS.MS\"Z\"') AS consumption_date,\n    ROUND(d.total_consumption_m3::numeric, 2) AS total_consumption_m3,\n    d.active_hours,\n    ROUND((d.total_consumption_m3 / NULLIF(d.active_hours, 0))::numeric, 2) AS avg_m3_per_hour,\n    ROUND(d.max_hourly_consumption_m3::numeric, 2) AS max_hourly_consumption_m3,\n    ROUND(d.min_hourly_consumption_m3::numeric, 2) AS min_hourly_consumption_m3,\n    m.hour_of_max_consumption,\n    m.hour_of_min_consumption\nFROM\n    daily_metrics d\nLEFT JOIN\n    max_min_hours m\nON\n    d.consumption_date = m.consumption_date\nWHERE\n    d.consumption_date >= TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n    AND d.consumption_date < TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\nORDER BY\n    d.consumption_date;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":650,"y":3660,"wires":[["b5c15d36.625ad","bc8c9907.5035d8"]]},{"id":"b5c15d36.625ad","type":"http response","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","statusCode":"200","headers":{},"x":1020,"y":3660,"wires":[]},{"id":"a9200fa9.d5ba5","type":"comment","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"Pulses report Multiple V1","info":"Pulses report","x":170,"y":3560,"wires":[]},{"id":"a14d4f7b.b6da28","type":"http in","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"Average Consumption lojas Agua","url":"/dash_api/lojas_consumption_pulses/:start_ts/:end_ts","method":"get","upload":false,"swaggerDoc":"","x":190,"y":3700,"wires":[["45a4609c.4ca448"]]},{"id":"45a4609c.4ca448","type":"postgresql","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","query":"WITH hourly_metrics AS (\n    SELECT\n        time_bucket('1 day', timestamp) AS consumption_date,\n        time_bucket('1 hour', timestamp) AS consumption_hour,\n        SUM(value) AS hourly_consumption_L\n    FROM\n        channel_pulse_log\n    WHERE\n        timestamp BETWEEN \n            TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000)\n            AND TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000)\n        AND value >= 0\n    GROUP BY\n        consumption_date, consumption_hour\n),\ndaily_metrics AS (\n    SELECT\n        consumption_date,\n        SUM(hourly_consumption_L) AS total_consumption_L,\n        COUNT(DISTINCT EXTRACT(HOUR FROM consumption_hour)) AS active_hours,\n        MAX(hourly_consumption_L) AS max_hourly_consumption_L,\n        MIN(hourly_consumption_L) AS min_hourly_consumption_L\n    FROM\n        hourly_metrics\n    GROUP BY\n        consumption_date\n),\nmax_min_hours AS (\n    SELECT\n        h.consumption_date,\n        MAX(CASE WHEN h.hourly_consumption_L = d.max_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM (h.consumption_hour AT TIME ZONE 'UTC' AT TIME ZONE 'America/Sao_Paulo')) END) AS hour_of_max_consumption,\n        MIN(CASE WHEN h.hourly_consumption_L = d.min_hourly_consumption_L \n                 THEN EXTRACT(HOUR FROM (h.consumption_hour AT TIME ZONE 'UTC' AT TIME ZONE 'America/Sao_Paulo')) END) AS hour_of_min_consumption\n    FROM\n        hourly_metrics h\n    JOIN\n        daily_metrics d\n    ON\n        h.consumption_date = d.consumption_date\n    GROUP BY\n        h.consumption_date\n)\nSELECT\n    d.consumption_date,\n    d.total_consumption_L,\n    d.active_hours,\n    ROUND(d.total_consumption_L / NULLIF(d.active_hours, 0)::numeric, 2) AS avg_L_per_hour,\n    d.max_hourly_consumption_L,\n    d.min_hourly_consumption_L,\n    m.hour_of_max_consumption,\n    m.hour_of_min_consumption\nFROM\n    daily_metrics d\nLEFT JOIN\n    max_min_hours m\nON\n    d.consumption_date = m.consumption_date\nORDER BY\n    d.consumption_date;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":650,"y":3700,"wires":[["7aae873d.1506e8"]]},{"id":"7aae873d.1506e8","type":"http response","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","statusCode":"200","headers":{},"x":1020,"y":3700,"wires":[]},{"id":"bc8c9907.5035d8","type":"debug","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":795,"y":3580,"wires":[],"l":false},{"id":"a665d4c0.e8edb","type":"debug","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":595,"y":3580,"wires":[],"l":false},{"id":"33825453.a2a73c","type":"function","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","func":"const devices = msg.payload;\n\nconst processedDevices = devices.map(device => {\n  const multiplierMatch = device.device_name.match(/x(\\d+)/);\n  const multiplier = multiplierMatch ? parseInt(multiplierMatch[1], 10) : 1;\n\n  const cleanedName = device.device_name\n    .replace(/^Hidr\\.\\s*/, '') \n    .replace(/\\s*x\\d+.*$/, ''); \n\n  const totalConsumptionL = parseFloat(device.total_consumption_l) * multiplier;\n  const maxHourlyConsumptionL = parseFloat(device.max_hourly_consumption_l) * multiplier;\n  const minHourlyConsumptionL = parseFloat(device.min_hourly_consumption_l) * multiplier;\n  const avgLPerHour = parseFloat(device.avg_l_per_hour) * multiplier;\n\n  return {\n    ...device, \n    device_name: cleanedName, \n    total_consumption_l: totalConsumptionL.toString(),\n    max_hourly_consumption_l: maxHourlyConsumptionL.toString(),\n    min_hourly_consumption_l: minHourlyConsumptionL.toString(),\n    avg_l_per_hour: avgLPerHour.toString()\n  };\n});\n\nmsg.payload = processedDevices;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":3620,"wires":[["f5604d2d.53f7a"]]},{"id":"cb4166bd.821838","type":"debug","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":975,"y":3580,"wires":[],"l":false},{"id":"5cd1f548.c8a5f4","type":"debug","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":3740,"wires":[]},{"id":"26e3b2c.fb57c4e","type":"postgresql","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","query":"SELECT TO_TIMESTAMP({{ msg.req.params.end_ts }}::bigint / 1000) AS endTs,\n       TO_TIMESTAMP({{ msg.req.params.start_ts }}::bigint / 1000) AS startTs;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":680,"y":3760,"wires":[["9eafb180.81f1c8"]]},{"id":"9eafb180.81f1c8","type":"debug","z":"becdaea7.25c7a","g":"1f056320.d796b5","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":840,"y":3780,"wires":[]},{"id":"1dedc184.ba6486","type":"mqtt in","z":"c84f852a.1a5f7","name":"","topic":"gateway/72620ea0-bc58-454e-806c-30c564ee7442/fetch","qos":"2","datatype":"auto-detect","broker":"2671f5e8.1472d2","x":290,"y":200,"wires":[["dca1b620.4fca4","8d1672b4.a293d8","220f877f.d70c9"]]},{"id":"e4b4e1be.6cdb4","type":"postgresql","z":"c84f852a.1a5f7","name":"","query":"SELECT\n  time_bucket('5 minutes', cr.timestamp)    AS timestamp,\n  cr.slave_id,\n  AVG(cr.value)          AS value,\n  AVG(cr.value_reactive) AS value_reactive\nFROM consumption_realtime cr\nJOIN slaves s\n  ON cr.slave_id = s.id\nWHERE\n      -- start *after* the bucket containing last_ts\n      cr.timestamp >  ('{{{ msg.payload.last_energy_ts }}}'::timestamptz\n                       + INTERVAL '5 minutes')\n  AND cr.timestamp <= ('{{{ msg.payload.last_energy_ts }}}'::timestamptz\n                       + INTERVAL '1 hour')\n  AND (cr.value / 3.0) <= (\n    CASE COALESCE(s.clamp_type::text, '0')\n      WHEN '0' THEN 50\n      WHEN '1' THEN 100\n      WHEN '2' THEN 400\n      WHEN '3' THEN 1000\n      WHEN '4' THEN 2000\n      WHEN '5' THEN 1600\n      WHEN '6' THEN 1000\n      ELSE 0\n    END * 220\n  )\nGROUP BY timestamp, cr.slave_id\nORDER BY timestamp, cr.slave_id;\n","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":830,"y":160,"wires":[["cefd538e.971bd"]]},{"id":"2d93cbaa.679a34","type":"function","z":"c84f852a.1a5f7","name":"function 11","func":"const UUID = '72620ea0-bc58-454e-806c-30c564ee7442'; // env.get('CENTRAL_UUID');\nmsg.topic = `gateway/${UUID}/data`;\n\n// normalize lastEnergyTs, defaulting in your flow if not set\nconst lastEnergyTs = msg.payload.last_energy_ts || '2024-11-01T00:00:00.000Z';\n\nmsg.originalLastEnergyTs = lastEnergyTs;\nmsg.payload.last_energy_ts = lastEnergyTs;\n\n// parse and compare to “now”\nconst lastDate = new Date(lastEnergyTs);\nconst now = new Date();\n\nif (lastDate > now) {\n    msg.payload = [];\n    // last_ts is in the future → emit an empty-array on output 2\n    return [null, msg];\n}\n\n// otherwise continue with the normal payload on output 1\nreturn [msg, null];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":675,"y":180,"wires":[["e4b4e1be.6cdb4"],["5dfd4b2a.560dfc"]],"l":false},{"id":"5dfd4b2a.560dfc","type":"mqtt out","z":"c84f852a.1a5f7","name":"","topic":"","qos":"","retain":"","broker":"2671f5e8.1472d2","x":1050,"y":200,"wires":[]},{"id":"c1266b62.d08118","type":"postgresql","z":"c84f852a.1a5f7","name":"","query":"WITH raw_ts AS (\n  -- 1) use exactly what the cloud sent, or fall back to the first 2023+ reading\n  SELECT\n    COALESCE(\n      NULLIF('{{{ msg.payload.last_water_ts }}}','')::timestamptz,\n      (\n        SELECT MIN(timestamp)\n          FROM channel_pulse_log\n         WHERE timestamp > '2025-01-01T00:00:00Z'\n           AND channel   = 1\n      )\n    ) AS start_ts\n),\nchannel_info AS (\n  -- 2) lookup your per-slave multiplier\n  SELECT\n    slave_id,\n    MAX(\n      COALESCE(\n        (regexp_match(name, 'x([0-9]+\\\\.?[0-9]*)'))[1]::float,\n        1\n      )\n    ) AS multiplier\n  FROM channels\n  WHERE channel = 1\n    AND type    = 'flow_sensor'\n    AND slave_id IS NOT NULL\n  GROUP BY slave_id\n),\nbounds AS (\n  -- 3) from that start_ts, either take a full hour (if there's data),\n  --    or jump to the end of the very next non‐empty 5m bucket\n  SELECT\n    r.start_ts,\n    CASE\n      WHEN EXISTS (\n        SELECT 1\n          FROM channel_pulse_log c\n          JOIN channel_info ci ON c.slave_id = ci.slave_id\n         WHERE c.timestamp >  r.start_ts\n           AND c.timestamp <= r.start_ts + INTERVAL '1 hour'\n           AND c.channel   = 1\n           AND c.value     > 0\n           AND c.value     < 10000\n      )\n      THEN r.start_ts + INTERVAL '1 hour'\n      ELSE (\n        SELECT MIN(time_bucket('5 minutes', c2.timestamp) + INTERVAL '5 minutes')\n          FROM channel_pulse_log c2\n          JOIN channel_info ci2 ON c2.slave_id = ci2.slave_id\n         WHERE c2.timestamp > r.start_ts\n           AND c2.channel   = 1\n           AND c2.value     > 0\n           AND c2.value     < 10000\n      )\n    END AS end_ts\n  FROM raw_ts r\n),\nmain_data AS (\n  -- 4) aggregate _all_ pulses in that (start_ts, end_ts] window\n  SELECT\n    time_bucket('5 minutes', c.timestamp)  AS bucket_start,\n    c.slave_id,\n    SUM(c.value)                            AS sum_value,\n    (SUM(c.value) * ci.multiplier) / 1000   AS value\n  FROM channel_pulse_log c\n  JOIN channel_info    ci ON c.slave_id = ci.slave_id\n  JOIN bounds          b  ON TRUE\n  WHERE\n        c.timestamp >  b.start_ts\n    AND c.timestamp <= b.end_ts\n    AND c.channel   = 1\n    AND c.value     > 0\n    AND c.value     < 10000\n  GROUP BY bucket_start, c.slave_id, ci.multiplier\n)\n-- 5) return exactly one row _and_ use end_ts as the returned timestamp\nSELECT\n  (SELECT end_ts FROM bounds) AS timestamp,\n  slave_id,\n  sum_value,\n  value,\n  1                            AS channel\nFROM main_data\nORDER BY timestamp DESC, slave_id\nLIMIT 1;\n","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":830,"y":220,"wires":[["5dfd4b2a.560dfc"]]},{"id":"c8e830a8.9dd548","type":"function","z":"c84f852a.1a5f7","name":"function 10","func":"const UUID = '72620ea0-bc58-454e-806c-30c564ee7442'; \nmsg.topic = `gateway/${UUID}/water`;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":675,"y":220,"wires":[["c1266b62.d08118"]],"l":false},{"id":"cefd538e.971bd","type":"function","z":"c84f852a.1a5f7","name":"Send gap: true if empty response","func":"// Node-RED Function node\n\n// grab the lastEnergyTs that your cloud sent\nconst lastTs = msg.originalLastEnergyTs;\n\nif (!lastTs) {\n    node.error('originalLastEnergyTs not set on msg');\n    return null;\n}\n\n// if we got an empty array of readings → signal a gap\nif (Array.isArray(msg.payload) && msg.payload.length === 0) {\n    // compute next_date = lastTs + 1 hour\n    const next = new Date(lastTs);\n    next.setHours(next.getHours() + 1);\n\n    // SAFEGUARD: Don't send a next_date in the future\n    const now = new Date();\n    if (next > now) {\n        node.warn(`Not sending gap: next_date (${next.toISOString()}) is in the future (now: ${now.toISOString()})`);\n        return null;\n    }\n\n    msg.payload = {\n        gap: true,\n        next_date: next.toISOString()\n    };\n}\n\n// otherwise msg.payload remains the array of readings\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":955,"y":160,"wires":[["5dfd4b2a.560dfc","1694e769.902d91"]],"l":false},{"id":"c7179f82.3ee798","type":"inject","z":"c84f852a.1a5f7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"CENTRAL_UUID","payloadType":"env","x":170,"y":100,"wires":[["ba07a05.89c51e"]]},{"id":"ba07a05.89c51e","type":"debug","z":"c84f852a.1a5f7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":305,"y":100,"wires":[],"l":false},{"id":"dca1b620.4fca4","type":"json","z":"c84f852a.1a5f7","name":"","property":"payload","action":"","pretty":false,"x":570,"y":180,"wires":[["2d93cbaa.679a34"]]},{"id":"8d1672b4.a293d8","type":"json","z":"c84f852a.1a5f7","name":"","property":"payload","action":"","pretty":false,"x":570,"y":220,"wires":[["c8e830a8.9dd548"]]},{"id":"b6dc59cf.208ee8","type":"function","z":"c84f852a.1a5f7","name":"Send status","func":"// Gateway Status Update Function Node\n// Generates a properly formatted status message to be published via MQTT\nconst UUID = env.get('CENTRAL_UUID');\n// Configuration (adjust these values as needed)\nconst gatewayId = UUID;\nconst status = msg.status || \"ok\"; // 'ok' or 'error'\nconst slaves = msg.slaves || []; // Default slave IDs\nconst waterChannels = [1];\n\n// Generate the status message\nconst statusMessage = {\n    status: status,\n    timestamp: new Date().toISOString(),\n    metadata: {\n        slaves: slaves,\n        waterChannels: waterChannels,\n        source: \"node-red\"\n    }\n};\n\n// Set the topic for MQTT\nmsg.topic = `gateway/${gatewayId}/status`;\n\n// Set the payload to the status message\nmsg.payload = statusMessage;\n\n// Send the message\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":590,"y":300,"wires":[["8677e327.702fa8","5fff063f.151d6"]]},{"id":"f619f19b.b1746","type":"inject","z":"c84f852a.1a5f7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":170,"y":300,"wires":[["cbfb9ac4.6e777"]]},{"id":"5fff063f.151d6","type":"mqtt out","z":"c84f852a.1a5f7","name":"","topic":"","qos":"","retain":"","broker":"2671f5e8.1472d2","x":770,"y":300,"wires":[]},{"id":"cbfb9ac4.6e777","type":"postgresql","z":"c84f852a.1a5f7","name":"","query":"SELECT id FROM slaves;","postgreSQLConfig":"b7242f71.79e57","split":false,"rowsPerMsg":1,"outputs":1,"x":350,"y":300,"wires":[["def72096.08f598"]]},{"id":"def72096.08f598","type":"function","z":"c84f852a.1a5f7","name":"Set slaves","func":"msg.slaves = msg.payload.map((slave) => slave.id);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":475,"y":300,"wires":[["b6dc59cf.208ee8"]],"l":false},{"id":"8677e327.702fa8","type":"debug","z":"c84f852a.1a5f7","name":"debug 64","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":760,"y":340,"wires":[]},{"id":"10008291.f0d9fd","type":"comment","z":"c84f852a.1a5f7","name":"1. Get the central UUID here","info":"It will appear on the logs","x":200,"y":60,"wires":[]},{"id":"b5af2647.fa6a7","type":"comment","z":"c84f852a.1a5f7","name":"2. Change the topic to use the central UUID","info":"It will appear on the logs","x":250,"y":160,"wires":[]},{"id":"95d33861.63c96","type":"comment","z":"c84f852a.1a5f7","name":"3. Nothing to do here, just leave it as it is.","info":"## This will register the gateway in\n\nhttps://ingestion.myio-bas.com","x":240,"y":260,"wires":[]},{"id":"7ea164be.3c339c","type":"comment","z":"c84f852a.1a5f7","name":"4. Accept the gateway","info":"Go on https://ingestion.myio-bas.com/\n\nAnd register the current gateway","x":180,"y":380,"wires":[]},{"id":"a61cc1ae.b71d08","type":"mqtt out","z":"becdaea7.25c7a","name":"Attribute","topic":"v1/gateway/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":1600,"y":1600,"wires":[]},{"id":"136027e1.018f8","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1180,"y":1560,"wires":[["cc779d0.d2c16e"]]},{"id":"cc779d0.d2c16e","type":"function","z":"becdaea7.25c7a","name":"","func":"\nconst devices = flow.get('devices') || {}; \nconst centralId = env.get('CENTRAL_UUID');\n\nconst payload = {};\n\nfor (const key of Object.keys(devices)) {\n    if(key.includes(\"SCD\")&& key ==\"SCD Nível_Terraço 132 168 x1.95\"){\n    const device = devices[key]; \n    \n    // Ajustar regex para capturar o nome e o multiplicador opcional\n    const match = key.match(/^(.*?)(?:\\s*x(\\d+))?$/);\n    if (!match) {\n        continue;\n    }\n    \n    let actualName = match[1].trim(); // sempre pega o nome antes do \" xN\" ou o nome todo\n    const multiplier = match[2] ? parseInt(match[2], 10) : 1; // se não tiver multiplicador, usa 1\n   actualName = actualName.slice(4,17)\n  \n    payload[`${actualName} (Campinas Shopping)`] = {\n        centralId,\n        slaveId: device.slaveId,\n        multiplier,\n    };\n    }\n}\nmsg.payload = payload;\nreturn msg","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1370,"y":1680,"wires":[["4638b2b3.f98de4","a61cc1ae.b71d08"]]},{"id":"4638b2b3.f98de4","type":"debug","z":"becdaea7.25c7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1620,"y":1680,"wires":[]},{"id":"f7abce43.99bad","type":"mqtt out","z":"becdaea7.25c7a","name":"Attribute","topic":"v1/gateway/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":1600,"y":1160,"wires":[]},{"id":"d7384028.d9a628","type":"inject","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"900","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1350,"y":2560,"wires":[["3cb14d52.779ef2"]]},{"id":"3cb14d52.779ef2","type":"postgresql","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","query":"WITH LastTimestamp AS (\n  SELECT MAX(timestamp) AS max_timestamp\n  FROM channel_pulse_log\n),\nTimeDiff AS (\n  SELECT\n    timestamp,\n    channel,\n    value,\n    slave_id,\n    reading,\n    LAG(timestamp) OVER (PARTITION BY slave_id, channel ORDER BY timestamp) AS prev_timestamp,\n    EXTRACT(EPOCH FROM (timestamp - LAG(timestamp) OVER (PARTITION BY slave_id, channel ORDER BY timestamp))) AS time_diff_seconds\n  FROM channel_pulse_log\n  WHERE\n    channel = 1\n    AND timestamp >= (SELECT max_timestamp - INTERVAL '30 minutes' FROM LastTimestamp)\n    AND timestamp <= (SELECT max_timestamp FROM LastTimestamp)\n),\nOutliers AS (\n  SELECT\n    timestamp,\n    channel,\n    value,\n    slave_id,\n    reading,\n    time_diff_seconds,\n    (time_diff_seconds * 3) AS max_allowable_value\n  FROM TimeDiff\n  WHERE\n    value > (time_diff_seconds * 3)\n    AND value > 10\n),\nUpdatedRows AS (\n  UPDATE channel_pulse_log cpl\n  SET value = 0\n  FROM Outliers\n  WHERE\n    cpl.timestamp = Outliers.timestamp\n    AND cpl.slave_id = Outliers.slave_id\n    AND cpl.channel = Outliers.channel\n    AND cpl.value = Outliers.value\n    AND cpl.reading = Outliers.reading\n  RETURNING cpl.slave_id\n)\nSELECT\n  COUNT(*) AS affected_rows,\n  ARRAY_AGG(slave_id) AS affected_slave_ids\nFROM UpdatedRows;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":1550,"y":2560,"wires":[["bef9faab.220a38","5f3d9fbb.8b94f"]]},{"id":"bef9faab.220a38","type":"debug","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1740,"y":2560,"wires":[]},{"id":"5f3d9fbb.8b94f","type":"function","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","func":"if (msg.payload[0].affected_rows > 0) {\n    msg.payload = {\n      \"payload\": {\n        \"summary\": `Detectados dispositivos com leitura inválida. ${msg.payload.affected_rows} corrigidos.`,\n        \"severity\": \"info\",\n        \"source\": \"InvalidPulsesDetection\"\n      },\n      \"routing_key\": \"0d3a200b4fd9410fc09c866e9d49f8b0\",\n      \"event_action\": \"trigger\"\n    };    \n    return msg;\n}\n\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":2600,"wires":[["ab573c18.a5b0e","d3488100.e8789"]]},{"id":"f8427433.14813","type":"http request","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://events.pagerduty.com/v2/enqueue","tls":"","persist":false,"proxy":"","authType":"","x":2070,"y":2600,"wires":[[]]},{"id":"ab573c18.a5b0e","type":"debug","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1940,"y":2560,"wires":[]},{"id":"d3488100.e8789","type":"switch","z":"becdaea7.25c7a","g":"43536f5a.fc53e8","name":"","property":"payload.affected_rows","propertyType":"msg","rules":[{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1930,"y":2600,"wires":[["f8427433.14813"]]},{"id":"c458485c.65d7c8","type":"inject","z":"becdaea7.25c7a","g":"e2863feb.d7fdd","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"8","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1630,"y":640,"wires":[["5c3ce61f.fa496"]]},{"id":"5c3ce61f.fa496","type":"http request","z":"becdaea7.25c7a","g":"e2863feb.d7fdd","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://localhost:8080/v2/slaves","tls":"","persist":false,"proxy":"","authType":"","x":1670,"y":700,"wires":[["9c673c08.6b5598"]]},{"id":"9c673c08.6b5598","type":"function","z":"becdaea7.25c7a","g":"e2863feb.d7fdd","name":"Map status to device","func":"const slaveStatusMap = {};\nconst devices = flow.get('devices');\n\nfunction getNameWithoutMultipliers(deviceName) {\n    return deviceName.replace(/ x\\d+\\.?\\d*[AV]?/gi, '').trim();\n}\n\nfor (const slave of msg.payload) {\n    slaveStatusMap[slave.id] = slave.status;\n}\n\nconst deviceStatusMap = {};\n\nfor (const device in devices) {\n    if (devices[device].slaveId && devices[device].name !== '' && device !== '') {\n        const nameWithoutMulitplier = getNameWithoutMultipliers(device);\n        \n        deviceStatusMap[nameWithoutMulitplier] = [{\n            ts: new Date().getTime(),\n            values: {\n                connectionStatus: slaveStatusMap[\n                    devices[device].slaveId\n                ]\n            }\n        }];\n    }\n}\n\nmsg.payload = deviceStatusMap;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1680,"y":780,"wires":[["1922c7b3.d9d89"]]},{"id":"1922c7b3.d9d89","type":"link out","z":"becdaea7.25c7a","g":"e2863feb.d7fdd","name":"link out 3","links":["36b5efb3ab8764e1","5579a5e6.a0c3ec","7cfeedaf.f39904"],"x":1835,"y":680,"wires":[]},{"id":"2b4c2a32.be7fce","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2120,"y":1020,"wires":[["a2a4ff6d.a5aaf"]]},{"id":"a2a4ff6d.a5aaf","type":"postgresql","z":"becdaea7.25c7a","name":"","query":"SELECT 1;","postgreSQLConfig":"2c45df63.f68c4","split":false,"rowsPerMsg":1,"outputs":1,"x":2300,"y":1020,"wires":[["b5b62c79.07c5c"]]},{"id":"b5b62c79.07c5c","type":"debug","z":"becdaea7.25c7a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2500,"y":1020,"wires":[]},{"id":"1694e769.902d91","type":"debug","z":"c84f852a.1a5f7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1090,"y":160,"wires":[]},{"id":"220f877f.d70c9","type":"debug","z":"c84f852a.1a5f7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":590,"y":140,"wires":[]},{"id":"f821427b.0044e","type":"mqtt out","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","topic":"v1/devices/me/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":770,"y":580,"wires":[]},{"id":"7edaf6c7.ed4828","type":"function","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","func":"msg.payload = {\n    missingEnergyReadings: msg.payload,\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":615,"y":580,"wires":[["f821427b.0044e","8a5c96c9.c03488"]],"l":false},{"id":"8a5c96c9.c03488","type":"debug","z":"cfa6c531.a6501","g":"6c0d0c03.5bd6c4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":740,"y":620,"wires":[]},{"id":"883e9978.1a8128","type":"function","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","func":"msg.payload = {\n    missingWaterReadings: msg.payload,\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":555,"y":400,"wires":[["c6b0ff65.504458"]],"l":false},{"id":"c6b0ff65.504458","type":"mqtt out","z":"cfa6c531.a6501","g":"3488480d.8a4888","name":"","topic":"v1/devices/me/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":750,"y":400,"wires":[]},{"id":"98a0aceb.84e8e8","type":"myio-emitter","z":"becdaea7.25c7a","x":90,"y":4140,"wires":[["501a9ddf.0ae60c"],["501a9ddf.0ae60c"],["501a9ddf.0ae60c"],[],["501a9ddf.0ae60c"],["501a9ddf.0ae60c"],[],[],[],["501a9ddf.0ae60c"],["501a9ddf.0ae60c"],[]]},{"id":"501a9ddf.0ae60c","type":"function","z":"becdaea7.25c7a","name":"","func":"let objetoCircular = global.get('statusCircular') || {};\nlet keyToCheck = msg.payload.id;\nif (Object.keys(objetoCircular).length >0  ) {\n\n       if (objetoCircular.hasOwnProperty(keyToCheck)) {\n        // Altera o valor para 'online'\n        objetoCircular[keyToCheck] = 'online';\n        global.set('statusCircular', objetoCircular);\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":280,"y":4140,"wires":[["6b0c5d48.010414"]]},{"id":"6b0c5d48.010414","type":"debug","z":"becdaea7.25c7a","name":"cabelo curto","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":450,"y":4140,"wires":[]},{"id":"4e735ceb.7c9064","type":"function","z":"becdaea7.25c7a","name":"function 30","func":"let objetosDentro = global.get('statusCircular') || {};\nlet vetor = flow.get('slave_data') || [];\n\nif (Object.keys(objetosDentro).length === 0) {\n\n    for (let item of vetor) {\n        \n        objetosDentro[item.id] = 'offline';\n    }\n    global.set('statusCircular',objetosDentro);\n    return null;\n}\n\nfor (let key in objetosDentro) {\n  objetosDentro[key] = 'offline';\n}\n\nglobal.set('statusCircular',objetosDentro);\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":395,"y":4380,"wires":[[]],"l":false},{"id":"b1e9b129.7b5aa","type":"mqtt out","z":"becdaea7.25c7a","name":"","topic":"v1/devices/me/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":570,"y":4340,"wires":[]},{"id":"43a2cf79.2d17e","type":"inject","z":"becdaea7.25c7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5400","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":4300,"wires":[["a122c53c.f7be88"]]},{"id":"8815f8f5.35e928","type":"function","z":"becdaea7.25c7a","name":"function 30","func":"\nconst httpDevices = msg.payload;\nconst objetosDentro = global.get('statusCircular') || {};\n\nmsg.payload = {\n  offlineDevices: httpDevices.filter((slave) => {\n    return objetosDentro[slave.id] === 'offline';\n  })};\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":335,"y":4300,"wires":[["b1e9b129.7b5aa","b77b52f9.e085c8","4e735ceb.7c9064"]],"l":false},{"id":"b77b52f9.e085c8","type":"debug","z":"becdaea7.25c7a","name":"Pudim de geleia","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":540,"y":4280,"wires":[]},{"id":"a122c53c.f7be88","type":"http request","z":"becdaea7.25c7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://localhost:8080/v2/slaves","tls":"","persist":false,"proxy":"","authType":"","x":255,"y":4300,"wires":[["8815f8f5.35e928"]],"l":false},{"id":"6f23ca4.e16e734","type":"data-fetcher","z":"c84f852a.1a5f7","name":"","mqtt":"1afbccb0.7121f3","uuidOverride":"72620ea0-bc58-454e-806c-30c564ee7442","x":150,"y":560,"wires":[]},{"id":"99ad4a97.1830b","type":"inject","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"paylod","v":"CENTRAL_UUID","vt":"env"}],"repeat":"300","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2090,"y":700,"wires":[["8b368a4a.820378"]]},{"id":"8b368a4a.820378","type":"function","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"","func":"const devices = flow.get('devices'); \nconst centralId = env.get('CENTRAL_UUID');\nconst newDeviceList = {};\n\nfunction getNameWithoutMultipliers(deviceName) {\n    return deviceName.replace(/ x\\d+\\.?\\d*[AV]?/gi, '').trim();\n}\n\nfunction handleDeviceType(name) {\n  const upper = (name || '').toUpperCase().normalize('NFD').replace(/\\p{Diacritic}/gu, '');\n\n  // ENERGY\n  if (upper.includes('COMPRESSOR')) return 'COMPRESSOR';\n  if (upper.includes('VENT')) return 'VENTILADOR';\n  if (upper.includes('ESRL')) return 'ESCADA_ROLANTE';\n  if (upper.includes('ELEV')) return 'ELEVADOR';\n  if ( \n         (  upper.includes('MOTR') && !upper.includes('CHILLER') ) \n      || upper.includes('MOTOR') \n      || upper.includes('RECALQUE')\n     ) return 'MOTOR';\n     \n  if (upper.includes('RELOGIO') || upper.includes('RELOG') || upper.includes('REL ')) return 'RELOGIO';\n  if (upper.includes('ENTRADA') || upper.includes('SUBESTACAO') || upper.includes('SUBESTACAO') || upper.includes('SUBEST')) return 'ENTRADA';\n  \n  if (upper.includes('3F')) { \n        if (upper.includes('CHILLER')) {\n            return 'CHILLER';\n        } else if (upper.includes('FANCOIL')) {\n            return 'FANCOIL';\n        } else if (upper.includes('TRAFO')) {\n            return 'ENTRADA';\n        } else if (upper.includes('ENTRADA')) {\n            return 'ENTRADA';\n        } else if (upper.includes('CAG')) {\n            return 'BOMBA_CAG';\n        } else {\n            return '3F_MEDIDOR';\n        }\n     }\n         \n\n  // WATER\n  if (upper.includes('HIDR') || upper.includes('BANHEIRO')) return 'HIDROMETRO';\n\n  // Corrige para casar com o typeMap: CAIXA_DAGUA\n  if (upper.includes('CAIXA DAGUA') || upper.includes('CX DAGUA') || upper.includes('CXDAGUA') || upper.includes('SCD'))\n    return 'CAIXA_DAGUA';\n\n  // Novo (presentes no typeMap como water)\n  if (upper.includes('TANK') || upper.includes('TANQUE') || upper.includes('RESERVATORIO')) return 'TANK';\n\n  // Extras (não mapeados no typeMap, mas mantidos)\n  if (upper.includes('AUTOMATICO')) return 'SELETOR_AUTO_MANUAL';\n  if (upper.includes('TERMOSTATO') || upper.includes('TERMO') || upper.includes('TEMP')) return 'TERMOSTATO';\n  if (upper.includes('ABRE')) return 'SOLENOIDE';\n  if (upper.includes('AUTOMACAO') || upper.includes('GW_AUTO')) return 'GLOBAL_AUTOMACAO';\n  if (upper.includes(' AC ') || upper.endsWith(' AC')) return 'CONTROLE REMOTO';\n\n  return '3F_MEDIDOR';\n}\n\n\nObject.keys(devices).forEach((key) => {\n    const device = devices[key];\n    \n    if (devices[key].slaveId && devices[key].name) {\n        const cleanName = getNameWithoutMultipliers(device.name);    \n    \n        newDeviceList[cleanName] = {\n            deviceType: handleDeviceType(key),\n            centralId: centralId,\n            slaveId: devices[key].slaveId\n        };\n    }\n});\n\nmsg.payload = newDeviceList;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2060,"y":800,"wires":[["b6f479bd.df8be8","9ff3e56f.a1e2a8"]]},{"id":"e30987e3.419318","type":"mqtt out","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"","topic":"v1/gateway/attributes","qos":"","retain":"","broker":"ba7623fd.d47d2","x":2440,"y":680,"wires":[]},{"id":"b6f479bd.df8be8","type":"debug","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":2440,"y":800,"wires":[]},{"id":"5d6f6a1.506d614","type":"comment","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"Envia o atributo Central ID dispositivo + deviceType","info":"","x":2170,"y":640,"wires":[]},{"id":"9ff3e56f.a1e2a8","type":"function","z":"becdaea7.25c7a","g":"379d0ae0.f07416","name":"Add namespace","func":"const keys = Object.keys(msg.payload);\n\nconst newPayload = keys.reduce((acc, key) => {\n    acc[`${key} (Campinas Shopping)`] = msg.payload[key];\n    return acc;\n}, {});\n\nmsg.payload = newPayload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2255,"y":720,"wires":[["e30987e3.419318"]],"l":false}]