const DATA_API_HOST="https://api.data.apps.myio-bas.com",GROUPS={"Entrada e Rel√≥gios":[],"Administra√ß√£o e Bombas":[],Lojas:[]},DEFAULT_CUSTOMER_ID="73d4c75d-c311-4e98-a852-10a2231007c4",DEVICE_SPRITES={relogio:{on:"/api/images/public/ljHZostWg0G5AfKiyM8oZixWRIIGRASB",off:"/api/images/public/rYrcTQlf90m7zH9ZIbldz6KIZ7jdb5DU"},subestacao:{on:"/api/images/public/TQHPFqiejMW6lOSVsb8Pi85WtC0QKOLU",off:"/api/images/public/HnlvjodeBRFBc90xVglYI9mIpF6UgUmi"},bomba_chiller:{on:"/api/images/public/Rge8Q3t0CP5PW8XyTn9bBK9aVP6uzSTT",off:"/api/images/public/8Ezn8qVBJ3jXD0iDfnEAZ0MZhAP1b5Ts"},default:{on:"/api/images/public/f9Ce4meybsdaAhAkUlAfy5ei3I4kcN4k",off:"/api/images/public/sdTe2CPTbLPkbEXBHwaxjSAGVbp4wtIa"}};function normalizeLabel(e=""){return String(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g," ")}function classifyDevice(e=""){const t=normalizeLabel(e);return/\brelogio\b/.test(t)?"relogio":/subesta/.test(t)?"subestacao":/bomba|chiller/.test(t)?"bomba_chiller":/administra/.test(t)?"administracao":"default"}function getDeviceImage(e,t={}){const n=classifyDevice(e),o=DEVICE_SPRITES[n]||DEVICE_SPRITES.default;return t.isOn??!0?o.on:o.off}function isLojaLabel(e=""){return"default"===classifyDevice(e)}function openDemand(e){console.log("[openDemand] Opening demand modal with attrs:",e);const t=e.entityId||e.deviceId&&e.deviceId.id||e.id;if(!t)return console.error("[openDemand] No device ID found in attrs:",e),void alert("Erro: ID do dispositivo n√£o encontrado");let n,o;if(e.startDate&&e.endDate)n=e.startDate.includes("T")?e.startDate.slice(0,10):e.startDate,o=e.endDate.includes("T")?e.endDate.slice(0,10):e.endDate;else{const e=DatesStore.get();n=e.start,o=e.end}if(!n||!o)return void alert("Por favor, selecione um per√≠odo antes de visualizar a demanda");const a=new Date(`${n}T00:00:00-03:00`).getTime(),r=new Date(`${o}T23:59:59-03:00`).getTime(),i=e.label||e.name||"Dispositivo";$("#myio-demand-overlay").remove();const s=`\n    <div id="myio-demand-overlay" style="\n      position: fixed;\n      inset: 0;\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: rgba(0, 0, 0, 0.5);\n    ">\n      <div class="demand-modal-card" id="demand-modal-card" style="\n        background: white;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n        width: 90%;\n        max-width: 800px;\n        max-height: 90vh;\n        display: flex;\n        flex-direction: column;\n        transition: all 0.3s ease;\n      ">\n        \x3c!-- Header --\x3e\n        <div style="\n          background: #4A148C;\n          color: white;\n          padding: 16px 20px;\n          border-radius: 8px 8px 0 0;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        ">\n          <div style="display: flex; align-items: center; gap: 10px;">\n            <span style="font-size: 24px;">‚ö°</span>\n            <h3 style="margin: 0; font-size: 18px;">Demanda - ${i}</h3>\n          </div>\n          <div style="display: flex; align-items: center; gap: 8px;">\n            <button id="export-pdf-btn" style="\n              background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);\n              color: #333;\n              border: none;\n              border-radius: 6px;\n              padding: 8px 16px;\n              cursor: pointer;\n              display: flex;\n              align-items: center;\n              gap: 6px;\n              font-size: 14px;\n              font-weight: 600;\n              transition: all 0.3s ease;\n              box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);\n            "\n            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 10px rgba(255, 193, 7, 0.4)';"\n            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(255, 193, 7, 0.3)';">\n              <span style="font-size: 16px;">üìÑ</span>\n              <span>Exportar PDF</span>\n              <span style="\n                background: #FF5722;\n                color: white;\n                font-size: 10px;\n                padding: 2px 6px;\n                border-radius: 10px;\n                font-weight: 700;\n              ">PICO DE DEMANDA</span>\n            </button>\n            <button id="fullscreen-toggle" style="\n              background: #2196F3;\n              color: white;\n              border: none;\n              border-radius: 6px;\n              width: 36px;\n              height: 36px;\n              cursor: pointer;\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              font-size: 20px;\n              transition: all 0.3s ease;\n            "\n            onmouseover="this.style.background='#1976D2';"\n            onmouseout="this.style.background='#2196F3';">\n              <span id="fullscreen-icon">‚õ∂</span>\n            </button>\n            <button id="close-demand-modal" style="\n              background: #f44336;\n              color: white;\n              border: none;\n              border-radius: 50%;\n              width: 32px;\n              height: 32px;\n              cursor: pointer;\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              font-size: 18px;\n              font-weight: bold;\n            ">√ó</button>\n          </div>\n        </div>\n        \n        \x3c!-- Body --\x3e\n        <div class="demand-modal-body" style="\n          padding: 20px;\n          flex: 1;\n          overflow-y: auto;\n        ">\n          \x3c!-- Period info --\x3e\n          <div style="\n            color: #666;\n            font-size: 14px;\n            margin-bottom: 10px;\n          ">\n            Per√≠odo: ${formatDateBR(n)} ‚Üí ${formatDateBR(o)}\n          </div>\n          \n          \x3c!-- Peak value pill (will be updated) --\x3e\n          <div id="demand-peak-info" style="\n            display: none;\n            background: #FFC107;\n            color: #333;\n            padding: 8px 16px;\n            border-radius: 20px;\n            font-weight: 600;\n            display: inline-block;\n            margin: 10px 0;\n          "></div>\n          \n          \x3c!-- Loading state --\x3e\n          <div id="demand-loading" style="\n            text-align: center;\n            padding: 40px;\n            color: #666;\n          ">\n            <div style="font-size: 48px; margin-bottom: 10px;">‚è≥</div>\n            <div>Carregando dados de demanda<span class="loading-dots">...</span></div>\n          </div>\n          \n          \x3c!-- Error state (hidden by default) --\x3e\n          <div id="demand-error" style="\n            display: none;\n            text-align: center;\n            padding: 40px;\n            color: #d32f2f;\n          ">\n            <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>\n            <div id="demand-error-message">Erro ao carregar dados</div>\n          </div>\n          \n          \x3c!-- Chart container (hidden during loading) --\x3e\n          <div id="demand-chart-container" style="\n            display: none;\n            position: relative;\n            height: 400px;\n            margin-top: 20px;\n          ">\n            <canvas id="demandChart"></canvas>\n            <div style="\n              margin-top: 10px;\n              padding: 10px;\n              background: #f5f5f5;\n              border-radius: 4px;\n              font-size: 12px;\n              color: #666;\n            ">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n                <strong>Controles de Zoom:</strong>\n                <button id="reset-zoom-btn" style="\n                  background: #4A148C;\n                  color: white;\n                  border: none;\n                  border-radius: 4px;\n                  padding: 4px 12px;\n                  font-size: 12px;\n                  cursor: pointer;\n                  display: flex;\n                  align-items: center;\n                  gap: 4px;\n                  transition: all 0.2s ease;\n                "\n                onmouseover="this.style.background='#6A1B9A';"\n                onmouseout="this.style.background='#4A148C';">\n                  <span style="font-size: 14px;">üîÑ</span>\n                  <span>Resetar Zoom</span>\n                </button>\n              </div>\n              <ul style="margin: 5px 0 0 20px; padding: 0;">\n                <li>üñ±Ô∏è <strong>Roda do mouse:</strong> Role para zoom in/out</li>\n                <li>üñ±Ô∏è <strong>Arrastar:</strong> Clique e arraste para selecionar √°rea de zoom</li>\n                <li>‚å®Ô∏è <strong>Ctrl + Arrastar:</strong> Mova o gr√°fico horizontalmente</li>\n                <li>üëÜ <strong>Toque:</strong> Pin√ßa para zoom (dispositivos touch)</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,d=$(s);$("body").append(d),$("#close-demand-modal, #myio-demand-overlay").on("click",(function(e){"close-demand-modal"!==e.target.id&&"myio-demand-overlay"!==e.target.id||($("#myio-demand-overlay").remove(),window.demandChartInstance&&(window.demandChartInstance.destroy(),window.demandChartInstance=null))})),$(document).on("keydown.demandModal",(function(e){"Escape"===e.key&&($("#myio-demand-overlay").remove(),window.demandChartInstance&&(window.demandChartInstance.destroy(),window.demandChartInstance=null),$(document).off("keydown.demandModal"))}));let l=!1;$("#fullscreen-toggle").on("click",(function(){const e=$("#demand-modal-card"),t=$("#myio-demand-overlay"),n=$("#fullscreen-icon");l?(e.css({width:"90%","max-width":"800px",height:"auto","max-height":"90vh","border-radius":"8px",margin:"auto"}),t.css("padding",""),n.text("‚õ∂"),window.demandChartInstance&&setTimeout((()=>{window.demandChartInstance.resize()}),300)):(e.css({width:"100%","max-width":"100%",height:"100vh","max-height":"100vh","border-radius":"0",margin:"0"}),t.css("padding","0"),n.text("‚õ∂"),window.demandChartInstance&&setTimeout((()=>{window.demandChartInstance.resize()}),300)),l=!l})),$("#export-pdf-btn").on("click",(async function(){try{const t=$(this),a=t.html();t.prop("disabled",!0).html('<span style="font-size: 16px;">‚è≥</span> Gerando PDF...'),void 0===window.jspdf&&await(e="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",new Promise(((t,n)=>{if(document.querySelector(`script[src="${e}"]`))return void t();const o=document.createElement("script");o.src=e,o.onload=t,o.onerror=n,document.head.appendChild(o)})));const{jsPDF:r}=window.jspdf,s=new r("p","mm","a4");s.setFontSize(20),s.setTextColor(74,20,140),s.text("Relat√≥rio de Demanda",20,20),s.setFontSize(14),s.setTextColor(0,0,0),s.text(`Dispositivo: ${i}`,20,35),s.setFontSize(12),s.text(`Per√≠odo: ${formatDateBR(n)} - ${formatDateBR(o)}`,20,45);const d=$("#demand-peak-info").text();if(d&&(s.setFontSize(12),s.setTextColor(255,152,0),s.text(d,20,55)),window.demandChartInstance){const e=document.getElementById("demandChart"),t=e.toDataURL("image/png"),n=170,o=e.height*n/e.width;s.addImage(t,"PNG",20,70,n,o);const a=70+o+20;s.setFontSize(12),s.setTextColor(0,0,0),s.text("Dados de Demanda",20,a);const r=window.lastProcessedDemandData;if(r&&r.points){s.setFontSize(10);let e=a+10;s.text("Data/Hora",20,e),s.text("Demanda (kW)",120,e);const t=Math.min(r.points.length,10);for(let n=0;n<t;n++){e+=7;const t=r.points[n];s.text(formatTimestamp(t.x),20,e),s.text(t.y.toFixed(2),120,e)}r.points.length>t&&(e+=10,s.setFontSize(8),s.text(`... e mais ${r.points.length-t} registros`,20,e))}}s.setFontSize(8),s.setTextColor(128,128,128),s.text(`Gerado em: ${(new Date).toLocaleString("pt-BR")}`,20,280),s.text("MyIO Energy Management System",120,280),s.save(`demanda_${i.replace(/\s+/g,"_")}_${(new Date).toISOString().slice(0,10)}.pdf`),t.prop("disabled",!1).html(a)}catch(e){console.error("[PDF Export] Error:",e),alert("Erro ao gerar PDF. Por favor, tente novamente.");const t=$("#export-pdf-btn");t.prop("disabled",!1).html(t.data("original-html")||"Exportar PDF")}var e})),$("#reset-zoom-btn").on("click",(function(){window.demandChartInstance&&(window.demandChartInstance.resetZoom(),console.log("[DEMAND] Chart zoom reset to original view"))}));let c=0;const p=setInterval((()=>{c=(c+1)%4,$(".loading-dots").text(".".repeat(c))}),500);fetchDemandTelemetry(t,a,r).then((e=>{clearInterval(p);const t=processDemandData(e);0===t.points.length?showDemandError("Sem pontos de demanda no per√≠odo selecionado"):($("#demand-loading").hide(),$("#demand-chart-container").show(),t.max.value>0&&$("#demand-peak-info").text(`M√°xima: ${t.max.value.toFixed(2)} kW √†s ${formatTimestamp(t.max.timestamp)}`).css("display","inline-block"),renderDemandChart(t))})).catch((e=>{clearInterval(p),console.error("[openDemand] Error fetching telemetry:",e),showDemandError("Falha ao carregar telemetria: "+e.message)}))}async function fetchDemandTelemetry(e,t,n){const o=localStorage.getItem("jwt_token");if(!o)throw new Error("Token de autentica√ß√£o n√£o encontrado");const a=`/api/plugins/telemetry/DEVICE/${e}/values/timeseries?keys=consumption&startTs=${t}&endTs=${n}&limit=50000&intervalType=MILLISECONDS&interval=54000000 &agg=SUM&orderBy=ASC`;console.log("[fetchDemandTelemetry] Fetching from:",a);const r=await fetch(a,{headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${o}`}});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const i=await r.json();return console.log("[fetchDemandTelemetry] Received data:",i),i}function processDemandData(e){let t=[],n=null,o=!1;if(e.consumption&&e.consumption.length>0?(n="consumption",o=!0):e.demand&&e.demand.length>0?(n="demand",o=!1):e.power&&e.power.length>0&&(n="power",o=!0),!n)return{points:[],max:{value:0,timestamp:null}};const a=e[n];let r=[];for(let e=1;e<a.length&&e<10;e++){const t=a[e].ts-a[e-1].ts;r.push(t)}r.length>0&&(r.reduce(((e,t)=>e+t)),r.length);t=a.filter((e=>{const t=parseFloat(e.value);return null!==e.value&&void 0!==e.value&&!isNaN(t)})).map(((e,t,a)=>{const r=parseFloat(e.value);let i,s=r;if("consumption"===n&&t>0){s=r-parseFloat(a[t-1].value),s<0&&(s=0)}return i="consumption"===n?s/1e3:o?r/1e3:r,{x:e.ts||e.timestamp,y:i}})).filter((e=>e.y>=0)).sort(((e,t)=>e.x-t.x)),"consumption"===n&&t.length>0&&t.shift();let i={value:0,timestamp:null};return t.forEach((e=>{e.y>i.value&&(i.value=e.y,i.timestamp=e.x)})),console.log(`[processDemandData] Processed ${t.length} points from '${n}', max: ${i.value} kW`),window.lastProcessedDemandData={points:t,max:i,seriesKey:n,needsConversion:o},{points:t,max:i,seriesKey:n,needsConversion:o}}async function renderDemandChart(e){if("undefined"==typeof Chart)return console.error("[renderDemandChart] Chart.js not loaded"),void showDemandError("Chart.js n√£o est√° carregado. Recarregue a p√°gina.");if(!Chart.registry.plugins.get("zoom"))try{await loadScript("https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"),console.log("[renderDemandChart] Chart.js zoom plugin loaded successfully")}catch(e){console.error("[renderDemandChart] Failed to load zoom plugin:",e)}const t=document.getElementById("demandChart").getContext("2d");window.demandChartInstance&&window.demandChartInstance.destroy();const n={datasets:[{label:"Demanda (kW)",data:e.points.map((e=>({x:new Date(e.x),y:e.y}))),borderColor:"#4A148C",backgroundColor:"rgba(74, 20, 140, 0.1)",borderWidth:2,fill:!0,tension:.25,pointRadius:0,pointHoverRadius:5,pointBackgroundColor:"#4A148C",pointBorderColor:"#fff",pointBorderWidth:2}]},o={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{title:e=>formatTimestamp(e[0].parsed.x),label:e=>`Demanda: ${e.parsed.y.toFixed(2)} kW`}},zoom:{zoom:{wheel:{enabled:!0,speed:.1},pinch:{enabled:!0},mode:"x",drag:{enabled:!0,backgroundColor:"rgba(74, 20, 140, 0.1)",borderColor:"#4A148C",borderWidth:1}},pan:{enabled:!0,mode:"x",modifierKey:"ctrl"},limits:{x:{min:"original",max:"original"}}}},scales:{x:{type:"linear",title:{display:!0,text:"Tempo"},ticks:{callback:function(e){return formatTimestamp(e)},maxTicksLimit:10,autoSkip:!0}},y:{title:{display:!0,text:"Demanda (kW)"},beginAtZero:!0}}};e.max.value>0&&(o.plugins.annotation||(o.plugins.annotation={annotations:{}}),o.plugins.annotation.annotations.maxLine={type:"line",yMin:e.max.value,yMax:e.max.value,borderColor:"#FF5722",borderWidth:2,borderDash:[5,5],label:{display:!0,content:`M√°x: ${e.max.value.toFixed(2)} kW`,position:"end",backgroundColor:"#FF5722",color:"white",padding:4}});try{window.demandChartInstance=new Chart(t,{type:"line",data:n,options:o})}catch(e){console.error("[renderDemandChart] Error creating chart:",e),showDemandError("Erro ao criar gr√°fico: "+e.message)}}function showDemandError(e){$("#demand-loading").hide(),$("#demand-error-message").text(e),$("#demand-error").show()}function formatDateBR(e){if(!e)return"";const[t,n,o]=e.split("-");return`${o}/${n}/${t}`}function formatTimestamp(e){const t=new Date(e);return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function loadScript(e){return new Promise(((t,n)=>{if(document.querySelector(`script[src="${e}"]`))return void t();const o=document.createElement("script");o.src=e,o.onload=t,o.onerror=n,document.head.appendChild(o)}))}window.getDeviceImage=getDeviceImage,window.openDemand=openDemand,window.loadScript=loadScript;const DatesStore=(()=>{let e={start:"",end:""};function t(e){return e&&e.includes("T")?e.slice(0,10):e}return{get:()=>({...e}),set({start:n,end:o}={}){n&&(e.start=t(n)),o&&(e.end=t(o)),console.log("[DATES] set ‚Üí",JSON.stringify(e)),$("#startDate").val(e.start||""),$("#endDate").val(e.end||""),EventBus.emit("dates:changed",{...e})}}})(),EventBus=(()=>{const e={};return{on(t,n){(e[t]=e[t]||[]).push(n)},off(t,n){e[t]=(e[t]||[]).filter((e=>e!==n))},emit(t,n){(e[t]||[]).forEach((e=>e(n)))}}})();function initializeMainBoardController(e){const t=self.ctx;t.getDates=()=>({start:e.startDate,end:e.endDate}),t.setDates=t=>{e.startDate=t.start,e.endDate=t.end},$(document).off("change.myioDatesMain","#startDate,#endDate").on("change.myioDatesMain","#startDate,#endDate",(()=>{const t=$("#startDate").val(),n=$("#endDate").val();e.startDate=t,e.endDate=n,console.log("[MAIN] Inputs changed",{start:t,end:n})})),$(document).off("click.myioLoadMain","#btn-load").on("click.myioLoadMain","#btn-load",(async t=>{t.preventDefault();const{startDate:n,endDate:o}=e;if(!n||!o)return alert("Selecione as duas datas.");console.log("[MAIN] Load clicked with",{startDate:n,endDate:o}),await loadMainBoardData(n,o),console.log("[MAIN] Board refresh completed")}))}const MyIOAuth=(()=>{const e=new URL(`${DATA_API_HOST}/api/v1/auth`),t="ADMIN_DASHBOARD_CLIENT",n="admin_dashboard_secret_2025",o=60,a=500,r=3;let i=null,s=0,d=null;function l(){return Date.now()}async function c(e){return new Promise((t=>setTimeout(t,e)))}return{getToken:async function(){return d||(function(){if(!i)return!0;const e=1e3*o;return l()>=s-e}()?(d=async function(){const o={client_id:t,client_secret:n};let d=0;for(;;)try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!t.ok){const e=await t.text().catch((()=>""));throw new Error(`Auth falhou: HTTP ${t.status} ${t.statusText} ${e}`)}const n=await t.json();if(!n||!n.access_token||!n.expires_in)throw new Error("Resposta de auth n√£o contem campos esperados.");return i=n.access_token,s=l()+1e3*Number(n.expires_in),console.log("[MyIOAuth] Novo token obtido. Expira em ~",Math.round(Number(n.expires_in)/60),"min"),i}catch(e){if(d++,console.warn(`[MyIOAuth] Erro ao obter token (tentativa ${d}/${r}):`,e?.message||e),d>=r)throw e;const t=a*Math.pow(2,d-1);await c(t)}}().finally((()=>{d=null})),d):i)},getExpiryInfo:function(){return{expiresAt:s,expiresInSeconds:Math.max(0,Math.floor((s-l())/1e3))}},clearCache:function(){i=null,s=0,d=null}}})();function toSpOffsetNoMs(e,t=!1){const n="number"==typeof e?new Date(e):e instanceof Date?e:new Date(String(e));if(Number.isNaN(n.getTime()))throw new Error("Data inv√°lida");t&&n.setHours(23,59,59,999);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:${String(n.getSeconds()).padStart(2,"0")}-03:00`}function toISOWithOffset(e,t=!1,n="America/Sao_Paulo"){const o=new Date(e);if(Number.isNaN(o.getTime()))throw new Error("Invalid date");t&&o.setHours(23,59,59,999);const a=new Intl.DateTimeFormat("sv-SE",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(o).reduce(((e,t)=>(e[t.type]=t.value,e)),{}),r=`${a.year}-${a.month}-${a.day}T${a.hour}:${a.minute}:${a.second}`,i=new Date(r).getTime(),s=Math.round((i-o.getTime())/6e4),d=s<=0?"+":"-",l=Math.abs(s);return`${r}${d}${String(Math.floor(l/60)).padStart(2,"0")}:${String(l%60).padStart(2,"0")}`}async function fetchWithAuth(e,t={},n=!0){const o=await MyIOAuth.getToken(),a=await fetch(e,{...t,headers:{...t.headers||{},Authorization:`Bearer ${o}`}});if(401===a.status&&n){console.warn(`[fetchWithAuth] 401 on ${e.split("?")[0]} - refreshing token and retrying`),MyIOAuth.clearCache();const n=await MyIOAuth.getToken(),o=await fetch(e,{...t,headers:{...t.headers||{},Authorization:`Bearer ${n}`}});if(!o.ok){const e=await o.text().catch((()=>""));throw new Error(`[HTTP ${o.status}] ${e}`)}return o}if(!a.ok){const e=await a.text().catch((()=>""));throw new Error(`[HTTP ${a.status}] ${e}`)}return a}function isValidUUID(e){if(!e||"string"!=typeof e)return!1;return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)}function formatDateToYMD(e,t=!1){const n=self.ctx.timeWindow.timezone||self.ctx.settings.timezone||"America/Sao_Paulo",o=new Date(e);if(t){let e=new Intl.DateTimeFormat("sv-SE",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(o);return e.includes(" ")?e.replace(" ","T"):`${e}T00:00:00`}{const e=new Intl.DateTimeFormat("default",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(o);return`${e.find((e=>"year"===e.type)).value}-${e.find((e=>"month"===e.type)).value}-${e.find((e=>"day"===e.type)).value}`}}function determineInterval(e,t){return(t-e)/864e5>2?"1 month":"1 day"}function fmtPerc(e){const t=Number(e);return isNaN(t)?"0.0":t>0&&t<.1?"<0,1":t.toFixed(1)}function createInfoCard(e,t,n,o){return $(`\n<div class="info-card" style="height: 170px;">\n  <div class="device-main-content" style="display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 4px;">\n    \n    <div class="device-title-row" style="margin-bottom: 2px;">\n      <span class="device-title" title="${e}">${e}</span>\n    </div>\n\n    ${o?`<img class="device-image" src="${o}" />`:""}\n\n    <div class="device-data-row">\n        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; font-weight: bold; color: #28a745;">\n          <span class="flash-icon flash">‚ö°</span>\n          <span class="consumption-value">${MyIOLibrary.formatEnergy(t)}</span>\n          ${null!=n?`<span class="device-title-percent" style="color: rgba(0,0,0,0.5); font-weight: 500;">(${MyIOLibrary.formatNumberReadable(n)}%)</span>`:""}\n        </div>\n    </div>\n\n  </div>\n</div>\n`)}async function openDashboardPopupEnergy(e,t,n,o,a,r,i,s,d){$("#dashboard-popup").remove();const l=self.ctx.settings||{};let c=s,p=d;$("#start-date").val(c||""),$("#end-date").val(p||"");const u=new Date(`${c}`),m=new Date(`${p}`),g=u.getTime(),f=m.getTime(),h=r||"SEM-LABEL",b=o,x=toISOWithOffset(g),y=toISOWithOffset(f,!0);window.consumption=0;let v=0,w=0,D="neutral",C=!1,I="",S=0;const k=getDeviceImage(h),E=e,T=localStorage.getItem("jwt_token");let A={label:"",andar:"",numeroLoja:"",identificadorMedidor:"",identificadorDispositivo:"",guid:"",consumoDiario:0,consumoMadrugada:0};function P(){const e=A.label?A.label.toUpperCase():h.toUpperCase(),t="increase"===D?"+":"decrease"===D?"-":"",n="increase"===D?"‚ñ≤":"decrease"===D?"‚ñº":"",o="increase"===D?"#D32F2F":"decrease"===D?"#388E3C":"#000";return`\n<div class="myio-sum-comparison-card" style="\n    flex: 1; \n    display: flex; \n    flex-direction: column; \n    justify-content: flex-start; \n    padding: 12px; \n    box-sizing: border-box; \n    background-color: var(--tb-service-background,#fff); \n    border-radius: var(--tb-border-radius,4px); \n    box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05);\n    min-height: 0;\n">\n    \x3c!-- T√≠tulo --\x3e\n    <div style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:4px; display:flex; align-items:center; justify-content:center; gap:8px;">\n     <div class="myio-lightning-icon-container">\n            <svg xmlns="http://www.w3.org/2000/svg" width="28px" height="28px" viewBox="0 -880 960 960" fill="var(--tb-primary-700,#FFC107)" style="display:block;">\n                <path d="m456-200 174-340H510v-220L330-420h126v220Zm24 120q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/>\n            </svg>\n        </div>\n        ${e}\n    </div>\n\n    \x3c!-- √çcone --\x3e\n    <div style="text-align:center; margin-bottom:8px;">\n        <img src="${k}" alt="√≠cone" width="92" height="92" style="object-fit: contain;" />\n    </div>\n\n    \x3c!-- Valor + Percentual --\x3e\n    <div style="display:flex; justify-content:center; align-items:center; margin-bottom:4px; display: none">\n        <div style="font-size:1.4rem; font-weight:600; color:#212121;">\n            ${MyIOLibrary.formatEnergy(window.consumption)}\n        </div>\n        <div style="margin-left:8px; font-size:1rem; font-weight:600; color: ${o};">\n            ${t}${MyIOLibrary.formatNumberReadable(v)}%\n            ${n}\n        </div>\n    </div>\n      <style>\n    .info-item {\n      display: flex;\n      flex-direction: column;\n      gap: 2px;\n      padding: 6px;\n      border: 1px solid #ccc;\n      border-radius: 4px;\n      background: #f9f9f9;\n    }\n    .info-item label {\n      font-size: 0.85rem;\n      font-weight: 600;\n    }\n    .info-item input {\n      padding: 4px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      outline: none;\n      font-size: 0.85rem;\n      background: #fff;\n    }\n  </style>\n\n    \x3c!-- √öltimo per√≠odo --\x3e\n    <div style="text-align:center; font-size:0.85rem; color:#757575; margin-bottom:12px; display: none">\n        √öltimo per√≠odo: <strong>${MyIOLibrary.formatEnergy(S)}</strong>\n    </div>\n\n    \x3c!-- Campos extras --\x3e\n    <div style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem;">\n      \n      <div class="info-item">\n        <label>Etiqueta</label>\n        <input type="text" value="${e}" readonly>\n      </div>\n      \n      <div class="info-item">\n        <label>Andar</label>\n        <input type="text" value="${A.andar}" readonly>\n      </div>\n      \n      <div class="info-item">\n        <label>N√∫mero da Loja</label>\n        <input type="text" value="${A.numeroLoja}" readonly>\n      </div>\n      \n      <div class="info-item">\n        <label>Identificador do Medidor</label>\n        <input type="text" value="${A.identificadorMedidor}" readonly>\n      </div>\n      \n      <div class="info-item">\n        <label>Identificador do Dispositivo</label>\n        <input type="text" value="${A.identificadorDispositivo}" readonly>\n      </div>\n      \n      <div class="info-item">\n        <label>GUID</label>\n        <input type="text" value="${A.guid}" readonly>\n      </div>\n      \n      <div style="margin-top: 12px;">\n          <button id="device" style="\n            width: 100%;\n            padding: 12px 16px;\n            background: linear-gradient(135deg, #4A148C 0%, #6A1B9A 100%);\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 14px;\n            font-weight: 600;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n            transition: all 0.3s ease;\n            box-shadow: 0 2px 8px rgba(74, 20, 140, 0.3);\n          " \n          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(74, 20, 140, 0.4)';" \n          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(74, 20, 140, 0.3)';">\n            <span style="font-size: 20px;">‚ö°</span>\n            <span>Visualizar telemetrias instant√¢neas</span>\n          </button>\n      </div>\n\n    </div>\n\n</div>\n        `}function z(){const e=document.getElementById("consumo-widget-container");e&&(e.innerHTML=P())}const M=$(`\n  <div id="dashboard-overlay" style="\n    position: fixed;\n    inset: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10000;\n    background: rgba(0,0,0,0.25);\n  ">\n    <div id="dashboard-modal" style="\n      width: 80vw;\n      border-radius: 10px;\n      background: #f7f7f7;\n      box-shadow: 0 0 20px rgba(0,0,0,0.35);\n      overflow: auto;\n      display: flex;\n      flex-direction: column;\n    ">\n      \x3c!-- cabe√ßalho --\x3e\n      <div id="dashboard-header" style="\n        height: 56px;\n        background: #4A148C;\n        color: #fff;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 0 20px;\n        font-weight: 700;\n        font-size: 1.05rem;\n      ">\n        <div>Consumo de Energia</div>\n        <button id="close-dashboard-popup" style="\n          background: #f44336;\n          color: #fff;\n          border: none;\n          border-radius: 50%;\n          width: 34px;\n          height: 34px;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 18px;\n          line-height: 1;\n        ">√ó</button>\n      </div>\n\n      \x3c!-- conte√∫do com os cards --\x3e\n      <div id="dashboard-cards-wrap" style="\n        display: flex;\n        gap: 20px;\n        padding: 20px;\n        box-sizing: border-box;\n        align-items: stretch;\n        min-height: calc(90vh - 56px);\n      ">\n        \x3c!-- Card 1 (33%) --\x3e\n        <div style="\n          flex: 0 0 33%;\n          display: flex;\n          flex-direction: column;\n          min-width: 0;\n          border-radius: 6px;\n          background: #fff;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.08);\n          overflow: hidden;\n        ">\n          <div id="consumo-widget-container" class="myio-sum-comparison-card" style="\n            padding: 16px;\n            display: flex;\n            flex-direction: column;\n            justify-content: space-between;\n            height: 100%;\n            box-sizing: border-box;\n          ">\n            ${P()}\n          </div>\n        </div>\n\n        \x3c!-- Card 2 (65%) --\x3e\n        <div style="\n          flex: 0 0 65%;\n          display: flex;\n          flex-direction: column;\n          min-width: 0;\n          border-radius: 6px;\n          background: #fff;\n          box-shadow: 0 2px 6px rgba(0,0,0,0.08);\n          overflow: hidden;\n        ">\n          <div id="chart-container" style="\n            padding: 16px;\n            width: 100%;\n            height: 100%;\n            box-sizing: border-box;\n          ">\n            \x3c!-- gr√°fico --\x3e\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>\n`);$("body").append(M);const R={start:"",end:""};function O({start:e,end:t}){e&&(R.start=e),t&&(R.end=t),console.log("[DETAIL] set dates ‚Üí",R),M.find("#start-date").val(R.start||""),M.find("#end-date").val(R.end||"")}O(DatesStore.get()),M.off("change.detailDates","#start-date,#end-date").on("change.detailDates","#start-date,#end-date",(()=>{O({start:M.find("#start-date").val(),end:M.find("#end-date").val()})})),M.off("click.detailLoad",".detail-load").on("click.detailLoad",".detail-load",(async()=>{const{start:e,end:t}=R;if(!e||!t)return alert("Selecione as datas de in√≠cio e fim.");console.log("[DETAIL] Load clicked with",{start:e,end:t});try{const r=toISOWithOffset(new Date(`${e}T00:00:00`)),i=toISOWithOffset(new Date(`${t}T23:59:59`),!0);console.log("[DETAIL] Rendering chart",{startIso:r,endIso:i,deviceId:a}),self.chartInstance?.destroy&&(console.log("[DETAIL] Destroying existing chart instance"),self.chartInstance.destroy()),self.chartContainerElement&&(self.chartContainerElement.innerHTML="");const s=self.ctx.timeWindow.timezone||self.ctx.settings.timezone||"America/Sao_Paulo";self.chartInstance=window.EnergyChartSDK.renderTelemetryChart(self.chartContainerElement,{version:"v2",clientId:CLIENT_ID,clientSecret:CLIENT_SECRET,deviceId:a,readingType:"energy",startDate:r,endDate:i,granularity:"1d",theme:self.ctx.settings?.theme||"light",timezone:s,iframeBaseUrl:"https://graphs.apps.myio-bas.com",apiBaseUrl:DATA_API_HOST});const d=new Date(`${e}`),l=new Date(`${t}`);console.log(`[DETAIL] Fetching comparison data for gatewayId: ${o}, slaveId: ${n}`);const c=await window.EnergyChartSDK.EnergyChart.getEnergyComparisonSum({gatewayId:o,slaveId:n,startTs:new Date(d),endTs:new Date(l),apiBaseUrl:DATA_API_HOST});console.log("[DETAIL] Comparison data received:",c),window.consumption=c.currentPeriod.totalKwh||0,S=c.previousPeriod.totalKwh||0;const p=window.consumption-S;let u=0;0!==S?u=p/Math.abs(S)*100:window.consumption>0&&(u=100),v=u,w=Math.abs(u).toFixed(1),D=u>0?"increase":u<0?"decrease":"neutral",console.log(`[DETAIL] Updated consumption: ${window.consumption} kWh, percentage: ${v}%`),z(),console.log("[DETAIL] Data refresh complete")}catch(e){console.error("[DETAIL] Error",e),self.chartContainerElement&&(self.chartContainerElement.innerHTML=`<div style="padding: 20px; text-align: center; color: red;">Erro: ${e.message}</div>`)}})),self.chartContainerElement=document.getElementById("chart-container"),self.chartContainerElement?(console.log("[DETAIL] popup open",{deviceId:e,gatewayId:o,slaveId:n}),M.on("remove",(()=>console.log("[DETAIL] popup closed"))),$(document).on("click","#close-dashboard-popup",(()=>{$("#dashboard-overlay").remove()})),A=await async function(){try{const e=await fetch(`/api/device/${E}`,{headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${T}`}});if(!e.ok)throw new Error("Erro ao buscar entidade");const t=await e.json(),n=t.label||t.name||"Sem etiqueta",o=await fetch(`/api/plugins/telemetry/DEVICE/${E}/values/attributes?scope=SERVER_SCOPE`,{headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${T}`}});if(!o.ok)throw new Error("Erro ao buscar atributos");const a=await o.json(),r=e=>{const t=a.find((t=>t.key===e));return t?t.value:""};return{label:n,andar:r("floor")||"",numeroLoja:r("NumLoja")||"",identificadorMedidor:r("IDMedidor")||"",identificadorDispositivo:r("deviceId")||"",guid:r("guid")||"",consumoDiario:Number(r("maxDailyConsumption"))||0,consumoMadrugada:Number(r("maxNightConsumption"))||0}}catch(e){return console.error("Erro ao buscar dados da entidade/atributos:",e),{}}}(),A.label&&(r=A.label),z(),await async function(){C=!0,I="",z();try{const e=A.consumoDiario||0,t=A.consumoMadrugada||0;if(window.consumption=e,S=t,0===t&&0===e)v=0,w="0",D="neutral";else if(0===t&&e>0)v=100,w="100",D="increase";else{const n=(e-t)/t*100;v=n,w=Math.abs(n).toFixed(1),D=n>0?"increase":n<0?"decrease":"neutral"}}catch(e){I="Erro ao carregar dados: "+e.message,console.error(e)}finally{C=!1,z()}}(),$(document).off("click.demandButton","#device").on("click.demandButton","#device",(function(t){t.preventDefault(),console.log(`[DEMAND] Button clicked for device: ${e}, entityLabel: ${r}`),console.log("[DEMAND] Button clicked for startDate:",s),console.log("[DEMAND] Button clicked for endDate:",d);const n=localStorage.getItem("jwt_token");if(!n)throw new Error("Token de autentica√ß√£o n√£o encontrado");const o=MyIOLibrary.openDemandModal({token:n,deviceId:e,startDate:s,endDate:d,label:r,telemetryQuery:{keys:"a,b,c",limit:5e6,intervalType:"MILLISECONDS",interval:54e6,agg:"MAX",orderBy:"DESC"},yAxisLabel:"Pot√™ncia (kW)",correctionFactor:1e3,onClose:()=>{console.log("‚úÖ Demand Modal closed successfully")}});console.log("‚ö° Demand Modal opened:",o)})),function({ingestionId:e,startDateTime:t,endDateTime:n,settings:o}){let a;if(self.chartInstance&&"function"==typeof self.chartInstance.destroy&&(self.chartInstance.destroy(),self.chartInstance=null),self.chartContainerElement&&(self.chartContainerElement.innerHTML=""),!window.EnergyChartSDK||"function"!=typeof window.EnergyChartSDK.renderTelemetryChart)return console.error("EnergyChartSDK v2 (renderTelemetryChart) not loaded!"),void(self.chartContainerElement&&(self.chartContainerElement.innerHTML='<div style="padding: 20px; text-align: center; color: red;">EnergyChartSDK v2 (renderTelemetryChart) not loaded. Check widget configuration and browser console.</div>'));a=window.EnergyChartSDK.renderTelemetryChart;const r=self.ctx.timeWindow.timezone||self.ctx.settings.timezone||"America/Sao_Paulo",i=o.theme||"light";console.log("[popup] deviceId:",e),console.log("[popup] start:",t,"end:",n),console.log(`Initializing v2 chart with: deviceId=${e}, startDateTime=${t}, endDateTime=${n}, granularity=1d, theme=${i}, apiBaseUrl=${DATA_API_HOST}, timezone=${r}`),self.chartInstance=a(self.chartContainerElement,{version:"v2",clientId:"ADMIN_DASHBOARD_CLIENT",clientSecret:"admin_dashboard_secret_2025",deviceId:e,readingType:"energy",startDate:t,endDate:n,granularity:"1d",theme:i,timezone:r,iframeBaseUrl:"https://graphs.apps.myio-bas.com",apiBaseUrl:DATA_API_HOST}),self.chartInstance&&"function"==typeof self.chartInstance.on?(self.chartInstance.on("drilldown",(e=>{console.log("v2 SDK Drilldown Event:",e)})),self.chartInstance.on("error",(e=>{console.error("v2 SDK Error Event:",e),self.chartContainerElement&&(self.chartContainerElement.innerHTML=`<div style="padding: 20px; text-align: center; color: red;">v2 Chart Error: ${e.message||"Unknown error"}</div>`)}))):self.chartInstance&&console.warn("EnergyChartSDK v2 instance does not have an 'on' method for event listeners.")}({ingestionId:a,startDateTime:x,endDateTime:y,settings:l}),await async function(){const e={gatewayId:b,slaveId:n,startTs:new Date(g),endTs:new Date(f),apiBaseUrl:DATA_API_HOST};try{const t=await window.EnergyChartSDK.EnergyChart.getEnergyComparisonSum(e);window.consumption=t.currentPeriod.totalKwh||0,S=t.previousPeriod.totalKwh||0;const n=window.consumption-S;let o=0;0!==S?o=n/Math.abs(S)*100:window.consumption>0&&(o=100),v=o,w=Math.abs(o).toFixed(1),D=o>0?"increase":o<0?"decrease":"neutral",z()}catch(e){console.error("Erro ao buscar dados comparativos:",e)}}(),$("#close-dashboard-popup").on("click",(()=>$("#dashboard-overlay").remove()))):console.error("[DETAIL] #chart-container not found. Abort chart render.")}async function openDashboardPopup(e,t,n){$("#dashboard-popup").remove();const o=localStorage.getItem("jwt_token");const a=await async function(e,t){try{const n=await fetch(`/api/device/${e}`,{headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${t}`}});if(!n.ok)throw new Error("Erro ao buscar entidade");const o=await n.json(),a=o.label||o.name||"Sem etiqueta",r=await fetch(`/api/plugins/telemetry/DEVICE/${e}/values/attributes?scope=SERVER_SCOPE`,{headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${t}`}});if(!r.ok)throw new Error("Erro ao buscar atributos");const i=await r.json(),s=e=>{const t=i.find((t=>t.key===e));return t?t.value:""};return{etiqueta:a,andar:s("floor"),numeroLoja:s("NumLoja"),identificadorMedidor:s("IDMedidor"),identificadorDispositivo:s("deviceId"),guid:s("guid"),consumoDiario:Number(s("maxDailyConsumption"))||0,consumoMadrugada:Number(s("maxNightConsumption"))||0,consumoComercial:Number(s("maxBusinessConsumption"))||0}}catch(e){return console.error("Erro ao buscar dados da entidade/atributos:",e),{}}}(e,o),r=$(`\n<div id="dashboard-popup"\n    style="position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #f7f7f7; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.4); z-index: 10000; display: flex; flex-direction: column; font-family: Arial, sans-serif;">\n\n    \x3c!-- Cabe√ßalho --\x3e\n    <div\n        style="background: #4A148C; color: white; padding: 12px 20px; font-weight: bold; font-size: 1.1rem; border-top-left-radius: 10px; border-top-right-radius: 10px; flex-shrink: 0;">\n        Configura√ß√µes\n        <button id="close-dashboard-popup"\n            style="float: right; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer;">√ó</button>\n    </div>\n\n    \x3c!-- Conte√∫do --\x3e\n    <div class="popup-content" style="display: flex; justify-content: space-evenly; gap: 10px; padding: 10px; flex: 1; flex-wrap: wrap; box-sizing: border-box; overflow-y: auto;">\n        \n        \x3c!-- Card Esquerdo --\x3e\n        <div class="card"\n            style="flex: 1 1 300px; max-width: 45%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; box-sizing: border-box; min-height: 0;">\n            \n            <div style="flex: 1 1 auto; overflow-y: auto; min-height: 0;">\n                <h3 style="color: #4A148C; margin-bottom: 20px;">${a.etiqueta||""}</h3>\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Etiqueta</label>\n                <input type="text" class="form-input" value="${a.etiqueta||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Andar</label>\n                <input type="text" class="form-input" value="${a.andar||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">N√∫mero da Loja</label>\n                <input type="text" class="form-input" value="${a.numeroLoja||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Identificador do Medidor</label>\n                <input type="text" class="form-input" value="${a.identificadorMedidor||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Identificador do Dispositivo</label>\n                <input type="text" class="form-input" value="${a.identificadorDispositivo||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">GUID</label>\n                <input type="text" class="form-input" value="${a.guid||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n            </div>\n\n            <div style="margin-top: 20px; text-align: right; flex-shrink: 0;">\n </div>\n        </div>\n\n        \x3c!-- Card Direito --\x3e\n        <div class="card"\n            style="flex: 1 1 300px; max-width: 45%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; box-sizing: border-box; min-height: 0;">\n            \n            <div style="flex: 1 1 auto; overflow-y: auto; min-height: 0;">\n                <h3 style="color: #4A148C; margin-bottom: 20px;">Alarmes Energia - ${a.etiqueta}</h3>\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Consumo M√°ximo Di√°rio (kWh)</label>\n                <input type="text" class="form-input" value="${a.consumoDiario||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Consumo M√°ximo na Madrugada (0h - 06h) (kWh)</label>\n                <input type="text" class="form-input" value="${a.consumoMadrugada||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n\n                <label style="display:block; margin-bottom:4px; font-weight:500; color:#333;">Consumo M√°ximo Hor√°rio Comercial (09h - 22h) (kWh)</label>\n                <input type="text" class="form-input" value="${a.consumoComercial||""}" style="width:100%; margin-bottom:16px; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;" />\n            </div>\n\n            <div style="margin-top: 20px; text-align: right; flex-shrink: 0;">\n\n                <button \n    onclick="$('#dashboard-popup').remove();" \n    class="btn-desfazer" \n    style="background:#ccc; color:black; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">\n    Fechar\n</button>\n                <button class="btn-salvar" style="background:#4A148C; color:white; padding:6px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-left:10px;">Salvar</button>\n            </div>\n        </div>\n    </div>\n</div>\n`);$("body").append(r),$("#close-dashboard-popup").on("click",(()=>$("#dashboard-popup").remove())),r.find(".btn-salvar").on("click",(async()=>{const t=r.find("input.form-input"),n=t.eq(0).val(),a={floor:t.eq(1).val(),NumLoja:t.eq(2).val(),IDMedidor:t.eq(3).val(),deviceId:t.eq(4).val(),guid:t.eq(5).val(),maxDailyConsumption:t.eq(6).val(),maxNightConsumption:t.eq(7).val(),maxBusinessConsumption:t.eq(8).val()};try{const t=await fetch(`/api/device/${e}`,{method:"GET",headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${o}`}});if(!t.ok)throw new Error("Erro ao buscar entidade para atualizar label");const r=await t.json();r.label=n;if(!(await fetch("/api/device",{method:"POST",headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${o}`},body:JSON.stringify(r)})).ok)throw new Error("Erro ao atualizar etiqueta (label)");if(!(await fetch(`/api/plugins/telemetry/DEVICE/${e}/SERVER_SCOPE`,{method:"POST",headers:{"Content-Type":"application/json","X-Authorization":`Bearer ${o}`},body:JSON.stringify(a)})).ok)throw new Error("Erro ao salvar atributos");alert("Configura√ß√µes salvas com sucesso!"),$("#dashboard-popup").remove(),location.reload()}catch(e){console.error("Erro ao salvar configura√ß√µes:",e),alert("Erro ao salvar. Verifique o console.")}}))}function updateReportTable(){const e=$("#reportBody");e.empty(),self.ctx.$scope.reportData&&0!==self.ctx.$scope.reportData.length?self.ctx.$scope.reportData.forEach((t=>{const n=t.deviceId||"-";let o;o=t.isValid?$(`\n                <tr>\n                    <td>${t.entityLabel}</td>\n                    <td>${n}</td>\n                    <td>${null!=t.consumptionKwh?MyIOLibrary.formatEnergy(t.consumptionKwh):"-"}</td>\n                </tr>\n            `):$(`\n                <tr class="invalid-device">\n                    <td>${t.entityLabel}</td>\n                    <td colspan="2">${t.error||"Inv√°lido"}</td>\n                </tr>\n            `),e.append(o)})):e.append('<tr><td colspan="3" class="no-data">Nenhum dado dispon√≠vel</td></tr>')}function exportToCSVAll(e){if(!e?.length)return void alert("Erro: Nenhum dado dispon√≠vel para exportar.");const t=[],n=new Date,o=`DATA EMISS√ÉO: ${n.getDate().toString().padStart(2,"0")}/${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getFullYear()} - ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;let a=0;e.forEach((e=>{a+=e.consumptionKwh})),t.push(["DATA EMISS√ÉO",o]),t.push(["Total",a.toFixed(2)]),t.push(["Loja","Identificador","Consumo"]),e.forEach((e=>{t.push([e.entityLabel||e.deviceName||"-",e.deviceId||"-",null!=e.consumptionKwh?formatNumberReadable(e.consumptionKwh):"0,00"])}));const r="data:text/csv;charset=utf-8,"+t.map((e=>e.join(";"))).join("\n"),i=document.createElement("a");i.setAttribute("href",encodeURI(r)),i.setAttribute("download",`relatorio_consumo_geral_por_loja_${(new Date).toISOString().slice(0,10)}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i)}function renderHeaderStats(e){const t=document.getElementById("storesCount"),n=document.getElementById("totalKwh");if(!t||!n)return;const o=Array.isArray(e)?e.length:0,a=(Array.isArray(e)?e:[]).reduce(((e,t)=>e+(Number(t.consumptionKwh)||0)),0);t.textContent=o.toString(),n.textContent=MyIOLibrary.formatEnergy(a)}async function fetchCustomerTotalsPage({baseUrl:e,token:t,page:n=1,limit:o=200}){const a=`${e}&page=${n}&limit=${o}`;console.info(`[fetchCustomerTotalsPage] GET page=${n} limit=${o} ‚Üí ${a}`);const r=await fetch(a,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok){const e=await r.text().catch((()=>""));throw new Error(`[fetchCustomerTotalsPage] ${r.status} ${r.statusText} ${e}`)}const i=await r.json(),s=Array.isArray(i?.data)?i.data.length:0,d=Number(i?.pagination?.pages||1),l=Number(i?.pagination?.total??s);return console.debug(`[fetchCustomerTotalsPage] page=${n} got=${s} pages=${d} total=${l}`),i}async function fetchAllCustomerTotals({baseUrl:e,token:t,limit:n=200}){console.log(`[fetchAllCustomerTotals] Start limit=${n}`),console.log("[fetchAllCustomerTotals] Probe first page...");const o=await fetchCustomerTotalsPage({baseUrl:e,token:t,page:1,limit:n}),a=Array.isArray(o?.data)?[...o.data]:[];let r=Number(o?.pagination?.pages||1);if(r>1)for(let o=2;o<=r;o++){const r=await fetchCustomerTotalsPage({baseUrl:e,token:t,page:o,limit:n});Array.isArray(r?.data)&&a.push(...r.data)}else{if((Array.isArray(o?.data)?o.data.length:0)===n){let o=2;for(;;){const r=await fetchCustomerTotalsPage({baseUrl:e,token:t,page:o,limit:n}),i=Array.isArray(r?.data)?r.data:[];if(a.push(...i),i.length<n)break;if(o++,o>200){console.warn(`[fetchAllCustomerTotals] Safety break at page ${o}`);break}}}}return console.log(`[fetchAllCustomerTotals] Done. items=${a.length}`),a}async function openDashboardPopupAllReport(e,t){$("#dashboard-popup").remove();const n=$('\n<div id="dashboard-popup" style="\n    position: fixed; top: 5%; left: 5%;\n    width: 90%; height: 90%;\n    background: white;\n    border-radius: 8px;\n    box-shadow: 0 0 15px rgba(0,0,0,0.5);\n    z-index: 10000;\n    overflow: hidden;\n    display: flex; flex-direction: column;\n">\n    <div style="\n        background: #4A148C;\n        color: white;\n        padding: 12px 20px;\n        font-weight: bold;\n        font-size: 1.1rem;\n        border-top-left-radius: 10px;\n        border-top-right-radius: 10px;\n        flex-shrink: 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        position: relative;\n    ">\n        Consumo Geral por Loja\n        <button id="close-dashboard-popup" style="\n            position: absolute; top: 10px; right: 10px;\n            background: #f44336; color: white; border: none;\n            border-radius: 50%; width: 30px; height: 30px;\n            font-weight: bold; cursor: pointer;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10001;\n        ">√ó</button>\n    </div>\n    <div style="flex: 1; overflow: auto;">\n        \n<div class="widget-container">\n    <div class="widget-header">\n        <h3 class="widget-title">Relat√≥rio de Consumo de Energia</h3>\n        <div class="date-range">\n            <input type="date" id="startDate">\n            <span>at√©</span>\n            <input type="date" id="endDate">\n            <button class="load-button" id="loadDataBtn">\n                <i class="material-icons">refresh</i>\n                Carregar\n            </button>\n        </div>\n        <div id="report-stats" style="\n          display:flex; gap:14px; align-items:center; \n          background:#f5f5f5; border:1px solid #e0e0e0; \n          border-radius:6px; padding:6px 10px; font-size:14px;">\n          <span>üõçÔ∏è Lojas: <strong id="storesCount">0</strong></span>\n          <span>‚ö° Total consumo: <strong id="totalKwh">0,00 kWh</strong></span>\n        </div>\n        <div style="display: flex; gap: 10px;"> \n            <button id="exportCsvBtn" disabled\n              style="background-color: #ccc; color: #666; padding: 8px 16px; border: none; border-radius: 4px; cursor: not-allowed;">\n             <span class="material-icons" style="font-size: 18px; line-height: 18px;">file_download</span>\n            CSV\n            </button>\n        </div>\n    </div>\n    <div id="errorMessage" class="error-message" style="display:none;"></div>\n    <div class="table-container" style="position: relative;">\n        <div id="loadingOverlay" class="loading-overlay" style="display:none;">\n            <i class="material-icons" style="font-size: 48px; color: #5c307d;">hourglass_empty</i>\n        </div>\n        <table id="reportTable">\n            <thead>\n                <tr>\n                    <th class="sortable" data-sort-key="entityLabel">\n                        <span class="label">Loja</span><span class="arrow"></span>\n                    </th>\n                    <th class="sortable" data-sort-key="deviceId">\n                        <span class="label">Identificador</span><span class="arrow"></span>\n                    </th>\n                    <th class="sortable" data-sort-key="consumptionKwh">\n                        <span class="label">Consumo</span><span class="arrow"></span>\n                    </th>\n                </tr>\n            </thead>\n            <tbody id="reportBody">\n                <tr><td colspan="3" class="no-data">Nenhum dado dispon√≠vel</td></tr>\n            </tbody>\n        </table>\n    </div>\n</div>\n<style id="report-sort-style">\n#dashboard-popup th.sortable {\n  user-select: none;\n  cursor: pointer;\n  white-space: nowrap;\n}\n#dashboard-popup th.sortable .label { margin-right: 8px; font-weight: 600; }\n#dashboard-popup th.sortable .arrow {\n  display: inline-block;\n  width: 0; height: 0;\n  border-left: 5px solid transparent;\n  border-right: 5px solid transparent;\n  border-bottom: 7px solid currentColor; /* ‚ñ≤ shape */\n  transform: rotate(180deg);             /* default ‚Üì */\n  transition: transform 120ms ease;\n  opacity: .85; vertical-align: middle;\n}\n#dashboard-popup th.sortable.asc  .arrow { transform: rotate(0deg); }     /* ‚Üë */\n#dashboard-popup th.sortable.desc .arrow { transform: rotate(180deg); }   /* ‚Üì */\n#dashboard-popup th.sortable.active { filter: brightness(1.05); }\n\n#container {\n    overflow-y: auto;\n}\n\n#main.loading {\n    height: 100%;\n    width: 100%;\n    padding: 0;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: absolute;\n}\n\n#Myio{\n    width: 150px;\n    background-color: #3e1a7d;\n    padding: 10px;\n    border-radius: 5px;\n}\n\n#ReportHeader{\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-end;\n    padding: 5px;\n}\n\np{\n    font-size: 13px;\n    margin: 0;\n    font-family: Roboto;\n}\n\n.button{\n    all: unset;\n    cursor: pointer;\n    position: absolute;\n    top: 8px;\n    right: 40px;\n}\n\n.example-form-field{\n    margin: 0;\n}\n.hide-in-csv.button{\n    right: 60px;\n}\n\n.widget-container {\n    font-family: \'Roboto\', sans-serif;\n    padding: 20px;\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.widget-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 20px;\n    flex-wrap: wrap;\n    gap: 16px;\n}\n\n.widget-title {\n    font-size: 10px;\n    font-weight: 200;\n    color: #333;\n    margin: 0;\n}\n\n.date-range {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.date-range input[type="date"] {\n    padding: 8px;\n    border: 1px solid #e0e0e0;\n    border-radius: 4px;\n    font-family: \'Roboto\', sans-serif;\n    font-size: 14px;\n    color: #333;\n    background-color: white;\n}\n\n.date-range input[type="date"]:focus {\n    outline: none;\n    border-color: #5c307d;\n}\n\n.date-range span {\n    color: #666;\n    font-size: 14px;\n}\n\n.export-buttons {\n    display: flex;\n    gap: 10px;\n}\n\n.export-button {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    background-color: #5c307d;\n    color: white;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    transition: background-color 0.2s;\n}\n\n.export-button:hover {\n    background-color: #4a265f;\n}\n\n.export-button:disabled {\n    background-color: #ccc;\n    cursor: not-allowed;\n}\n\n.table-container {\n    flex: 1;\n    overflow: auto;\n    border: 1px solid #e0e0e0;\n    border-radius: 4px;\n}\n\ntable {\n    width: 100%;\n    border-collapse: collapse;\n    background-color: white;\n}\n\nth {\n    background-color: #5c307d;\n    color: white;\n    padding: 12px;\n    text-align: left;\n    font-weight: 500;\n    cursor: pointer;\n    user-select: none;\n    position: sticky;\n    top: 0;\n    z-index: 1;\n}\n\nth:hover {\n    background-color: #4a265f;\n}\n\ntd {\n    padding: 12px;\n    border-bottom: 1px solid #e0e0e0;\n}\n\ntr:nth-child(even) {\n    background-color: #f5f7fa;\n}\n\ntr:hover {\n    background-color: #f0f2f5;\n}\n\n.loading-overlay {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: rgba(255, 255, 255, 0.8);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    z-index: 2;\n}\n\n.error-message {\n    color: #d32f2f;\n    padding: 12px;\n    background-color: #ffebee;\n    border-radius: 4px;\n    margin-bottom: 16px;\n}\n\n.no-data {\n    text-align: center;\n    padding: 32px;\n    color: #666;\n}\n\n.sort-icon {\n    margin-left: 4px;\n    font-size: 12px;\n}\n\n.error-cell {\n    color: #d32f2f;\n    font-style: italic;\n}\n\n.invalid-device {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    color: #d32f2f;\n}\n\n.invalid-device .material-icons {\n    font-size: 16px;\n    color: #d32f2f;\n}\n\n.load-button {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 4px;\n    background-color: #5c307d;\n    color: white;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    transition: background-color 0.2s;\n}\n\n.load-button:hover {\n    background-color: #4a265f;\n}\n\n.load-button:disabled {\n    background-color: #ccc;\n    cursor: not-allowed;\n}\n\n.load-button .material-icons {\n    font-size: 18px;\n}\n.widget-container { font-family: \'Roboto\', sans-serif; padding: 20px; height: 100%; display: flex; flex-direction: column; }\n/* ... resto do CSS ... */\n</style>\n\n    </div>\n</div>\n');$("body").append(n);const o={start:"",end:""};function a({start:e,end:t}){e&&(o.start=e),t&&(o.end=t),console.log("[ALL] set dates ‚Üí",o),n.find("#startDate").val(o.start||""),n.find("#endDate").val(o.end||"")}a(DatesStore.get()),n.off("change.allDates","#startDate,#endDate").on("change.allDates","#startDate,#endDate",(()=>{a({start:n.find("#startDate").val(),end:n.find("#endDate").val()})}));const r=self.ctx.settings&&self.ctx.settings.customerId||DEFAULT_CUSTOMER_ID;console.log("[ALL] popup open",{customerId:r}),n.on("remove",(()=>console.log("[ALL] popup closed")));const i=(self.ctx.datasources||[]).filter((e=>{console.log("ds >>> ",e);const t=(e.label||e.entity?.label||e.entityLabel||e.entityName||"").toLowerCase();return!(/bomba.*secund[a√°]ria/.test(t)||/^administra[c√ß][a√£]o\s*1\b/.test(t)||/^administra[c√ß][a√£]o\s*2\b/.test(t)||/chiller/.test(t)||/^entrada\b/.test(t)||/^rel[o√≥]gio\b/.test(t))}));i.sort(((e,t)=>{const n=(e.entity.label||"").toLowerCase(),o=(t.entity.label||"").toLowerCase();return n<o?-1:n>o?1:0})),console.log(`datasources count: ${i.length}`),console.log("datasources >>> ",i);const s=self.ctx.$scope.$injector.get(self.ctx.servicesMap.get("attributeService"));self.ctx.$scope.reportData=i.map((e=>{const t=e.label||`Dispositivo (ID: ${e.entityId.substring(0,5)})`;return{entityId:e.entityId,entityType:e.entityType,deviceName:t,entityLabel:t,centralId:null,slaveId:null,consumptionKwh:null,error:null,isValid:!1}}));const d=i.map((async e=>{const t=e.label||e.entityLabel||e.entityName||`Dispositivo (ID: ${e.entityId.substring(0,5)})`;let n={entityId:e.entityId,entityAliasId:e.entityAliasId,deviceName:t,entityLabel:t,centralId:null,slaveId:null,consumptionKwh:null,error:null,isValid:!1};try{if(!e.entityId||!e.entityType)throw new Error("Contexto do dispositivo ausente");const t=await s.getEntityAttributes({id:e.entityId,entityType:e.entityType},"SERVER_SCOPE",["centralId","slaveId","deviceId","ingestionId"]).toPromise(),o=Array.isArray(t)?t:t?.data??[],a=o.find((e=>"centralId"===e.key)),r=o.find((e=>"slaveId"===e.key)),i=o.find((e=>"deviceId"===e.key)),d=o.find((e=>"ingestionId"===e.key)),l=a?a.value:null,c=r?r.value:null,p="string"==typeof c?parseInt(c,10):c,u=i?i.value:null,m=d?.value||null;!l||null===p||isNaN(p)?(n.error="Dispositivo n√£o configurado corretamente",n.isValid=!1):(n.centralId=l,n.slaveId=p,n.isValid=!0,n.deviceId=u,n.ingestionId=m)}catch(e){console.error(`Erro ao buscar atributos de ${t}:`,e),n.error="Erro ao buscar atributos",n.isValid=!1}return n}));self.ctx.$scope.reportData=await Promise.all(d),updateReportTable(self.ctx.$scope.reportData),renderHeaderStats(self.ctx.$scope.reportData),$("#loadDataBtn").on("click",(async()=>{const e=$("#startDate").val(),t=$("#endDate").val();if(!e||!t)return void alert("Selecione as duas datas antes de carregar.");const[n,o,a]=e.split("-").map(Number),[r,i,s]=t.split("-").map(Number),d=new Date(n,o-1,a,0,0,0,0),l=new Date(r,i-1,s,23,59,59,999);if(0===(self.ctx.datasources||[]).length)return void console.warn("Nenhum datasource encontrado");const c=self.ctx.settings&&self.ctx.settings.customerId||DEFAULT_CUSTOMER_ID;if(c)try{const e=toISOWithOffset(d),t=toISOWithOffset(l,!0),n=`${DATA_API_HOST}/api/v1/telemetry/customers/${c}/energy/devices/totals?startTime=${encodeURIComponent(e)}&endTime=${encodeURIComponent(t)}`;console.log(`[loadDataBtn] Calling Data API customer totals: ${n.split("?")[0]} with customerId=${c}`);const o=await MyIOAuth.getToken(),a=(await fetchAllCustomerTotals({baseUrl:n,token:o,limit:100})).filter((e=>{const t=(e.label||e.entity?.label||e.entityLabel||e.entityName||"").toLowerCase();return!(/bomba.*secund[a√°]ria/.test(t)||/^administra[c√ß][a√£]o\s*1\b/.test(t)||/^administra[c√ß][a√£]o\s*2\b/.test(t)||/chiller/.test(t)||/^entrada\b/.test(t)||/^rel[o√≥]gio\b/.test(t))}));a.sort(((e,t)=>{const n=(e.entity?.label||e.label||"").toLowerCase(),o=(t.entity?.label||t.label||"").toLowerCase();return n.localeCompare(o)})),console.log(`datasources (filtrados) count: ${a.length}`);const r=new Map;let i=0;a.forEach((e=>{e.id&&r.set(String(e.id),e)})),self.ctx.$scope.reportData.forEach((e=>{if(e.ingestionId&&isValidUUID(e.ingestionId)){const t=r.get(String(e.ingestionId));t?e.consumptionKwh=Number(t.total_value||0):(e.consumptionKwh=0,i++)}else e.consumptionKwh=0,e.error="Dispositivo sem ingestionId v√°lido",e.isValid=!1,console.warn(`[loadDataBtn] Device '${e.entityLabel}' has invalid or missing ingestionId`)})),self.ctx.$scope.sortColumn=self.ctx.$scope.sortColumn||"consumptionKwh",self.ctx.$scope.sortReverse=self.ctx.$scope.sortReverse??!0,applySortAndDetectChanges(),Array.isArray(self.ctx.$scope.reportDataSorted)&&self.ctx.$scope.reportDataSorted.length&&(self.ctx.$scope.reportData=self.ctx.$scope.reportDataSorted),updateReportTable(self.ctx.$scope.reportData),habilitarBotaoExport(),renderHeaderStats(self.ctx.$scope.reportData),updateMainReportSortUI(),attachMainReportSortHeaderHandlers(),console.log(`[loadDataBtn] Successfully updated ${self.ctx.$scope.reportData.length} devices in report table`)}catch(e){console.error("[loadDataBtn] Error fetching from Data API:",e),alert("Erro ao buscar dados da API. Veja console para detalhes.")}else alert("customerId ausente. Configure o widget (settings.customerId) ou DEFAULT_CUSTOMER_ID.")})),$("#exportCsvBtn").on("click",(()=>{exportToCSVAll(self.ctx.$scope.reportData)})),$("#close-dashboard-popup").on("click",(()=>$("#dashboard-popup").remove()))}function getSaoPauloISOString(e,t=!1){return e?t?`${e}T23:59:59.999-03:00`:`${e}T00:00:00.000-03:00`:""}function applySortAndDetectChanges(){if(!self.ctx.$scope.reportData)return self.ctx.$scope.reportDataSorted=[],void self.ctx.detectChanges();let e=[...self.ctx.$scope.reportData];e.sort(((e,t)=>{let n=e[self.ctx.$scope.sortColumn],o=t[self.ctx.$scope.sortColumn];return"consumptionKwh"===self.ctx.$scope.sortColumn&&(n=Number(n),o=Number(o)),n<o?self.ctx.$scope.sortReverse?1:-1:n>o?self.ctx.$scope.sortReverse?-1:1:0})),self.ctx.$scope.reportDataSorted=e,self.ctx.detectChanges()}function updateMainReportSortUI(){const e=self.ctx.$scope.sortColumn||"consumptionKwh",t=!!self.ctx.$scope.sortReverse;$("#reportTable th.sortable").removeClass("active asc desc");const n=$(`#reportTable th.sortable[data-sort-key="${e}"]`);n.length&&(n.addClass("active"),n.addClass(t?"desc":"asc"))}function attachMainReportSortHeaderHandlers(){$(document).off("click.myioHeaderSort","#reportTable th.sortable").on("click.myioHeaderSort","#reportTable th.sortable",(function(){const e=$(this).data("sort-key");e&&(self.ctx.$scope.sortColumn===e?self.ctx.$scope.sortReverse=!self.ctx.$scope.sortReverse:(self.ctx.$scope.sortColumn=e,self.ctx.$scope.sortReverse=!1),applySortAndDetectChanges(),Array.isArray(self.ctx.$scope.reportDataSorted)&&self.ctx.$scope.reportDataSorted.length&&(self.ctx.$scope.reportData=self.ctx.$scope.reportDataSorted),updateReportTable(self.ctx.$scope.reportData),updateMainReportSortUI(),$("#reportSortBy").val(self.ctx.$scope.sortColumn),$("#reportSortDir").val(self.ctx.$scope.sortReverse?"desc":"asc"))}))}function getDateRangeArray(e,t){const n=[];let o=new Date(e);const a=new Date(t);for(;o<=a;)n.push(o.toISOString().slice(0,10)),o.setDate(o.getDate()+1);return n}function exportToCSV(e,t,n,o,a){if(!e?.length)return void alert("Erro: Nenhum dado dispon√≠vel para exportar.");const r=[];r.push(["Dispositivo/Loja",t,o]),r.push(["DATA EMISS√ÉO",a]),r.push(["Total",n]),r.push(["Data","Consumo"]),e.forEach((e=>{r.push([e.date||"-",null!=e.consumptionKwh?formatNumberReadable(e.consumptionKwh):"0,00"])}));const i="data:text/csv;charset=utf-8,"+r.map((e=>e.join(";"))).join("\n"),s=document.createElement("a");s.setAttribute("href",encodeURI(i)),s.setAttribute("download",`relatorio_consumo_${(new Date).toISOString().slice(0,10)}_${t}.csv`),document.body.appendChild(s),s.click(),document.body.removeChild(s)}function formatNumberReadable(e){return null==e||isNaN(e)?"-":e.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function habilitarBotaoExport(){const e=document.getElementById("btn-export-csv")||document.getElementById("exportCsvBtn");e.disabled=!1,e.style.backgroundColor="#5c307d",e.style.color="#fff",e.style.cursor="pointer"}function openDashboardPopupReport(e,t,n,o,a,r,i,s){$("#dashboard-popup").remove();const d=$(`\n  <div id="dashboard-popup" style="\n    position: fixed; top: 5%; left: 5%; \n    width: 90%; height: 90%; \n    background: white; \n    border-radius: 8px; \n    box-shadow: 0 0 15px rgba(0,0,0,0.5); \n    z-index: 10000; \n    overflow: hidden;\n    display: flex; flex-direction: column;\n  ">\n    <div style="\n      background: #4A148C; \n      color: white; \n      padding: 12px 20px; \n      font-weight: bold; \n      font-size: 1.1rem; \n      border-top-left-radius: 10px; \n      border-top-right-radius: 10px;\n      flex-shrink: 0;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      position: relative;\n    ">\n      Consumo de Loja\n      <button id="close-dashboard-popup" style="\n        position: absolute; top: 10px; right: 10px; \n        background: #f44336; color: white; border: none; \n        border-radius: 50%; width: 30px; height: 30px; \n        font-weight: bold; cursor: pointer; \n        box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10001;\n      ">√ó</button>\n    </div>\n    <div style="flex: 1; overflow: auto;">\n      ${`\n\n    <div style="\n      font-family: 'Roboto', sans-serif; \n      padding: 20px; \n      height: 100%; \n      box-sizing: border-box; \n      display: flex; \n      flex-direction: column;\n      background: white;\n    ">\n      <div style="\n        display: flex; \n        justify-content: space-between; \n        align-items: center; \n        margin-bottom: 20px; \n        flex-wrap: wrap; \n        gap: 16px;\n      ">\n        <div>\n            <h2 style="font-size: 18px; font-weight: 500; color: #333; margin: 0 0 -20px 0;">Relat√≥rio Consumo de Energia Geral por Loja </h2>\n            <h2 style="font-size: 18px; font-weight: 500; color: #333; margin: 0 0 -20px 0;">Dispositivo/Loja: ${r} - ${s} </h2>\n            <div style="display: flex; flex-direction=row">\n                <h2 style="font-size: 18px; font-weight: 500; color: #333; margin: 0 5px 0 0;">DATA EMISS√ÉO: </h2>\n                <h2 id ="inssueDate" style="font-size: 18px; font-weight: 500; color: #333; margin: 0;">  </h2>\n            </div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 8px;">\n          <input id="start-date" type="date" style="\n            padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; color: #333; background: white;\n          ">\n          <span style="color: #666; font-size: 14px;">at√©</span>\n          <input id="end-date" type="date" style="\n            padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px; color: #333; background: white;\n          ">\n          <button id="btn-load" style="\n            padding: 8px 16px; \n            border: none; border-radius: 4px; \n            background-color: #5c307d; \n            color: white; \n            cursor: pointer; \n            font-size: 14px; \n            display: flex; \n            align-items: center; \n            gap: 8px;\n            transition: background-color 0.2s;\n          " onmouseover="this.style.backgroundColor='#4a265f';" onmouseout="this.style.backgroundColor='#5c307d';">\n            <span class="material-icons" style="font-size: 18px; line-height: 18px;">refresh</span>\n            Carregar\n          </button>\n        </div>\n  \n        <div style="display: flex; gap: 10px;"> \n            <button id="btn-export-csv" disabled\n              style="background-color: #ccc; color: #666; padding: 8px 16px; border: none; border-radius: 4px; cursor: not-allowed;">\n             <span class="material-icons" style="font-size: 18px; line-height: 18px;">file_download</span>\n            CSV\n            </button>\n\n        </div>\n        \n\n        \n      </div>\n\n  \n      <div style="\n        flex: 1; \n        overflow: auto; \n        border: 1px solid #e0e0e0; \n        border-radius: 4px; \n        position: relative; \n        background: white;\n      ">\n        <div style="\n          position: absolute; \n          top: 0; left: 0; right: 0; bottom: 0; \n          background: rgba(255,255,255,0.8); \n          display: none; \n          justify-content: center; \n          align-items: center; \n          z-index: 2;\n        " id="loading-overlay">\n          <span class="material-icons" style="font-size: 48px; color: #5c307d;">hourglass_empty</span>\n        </div>\n        \n        <table style="width: 100%; border-collapse: collapse; background: white;">\n          <thead>\n            <tr id="total-row" style="font-weight: bold; background-color: #c4c4c4;">\n              <td style="padding: 12px; color:#696969;">Total:</td>\n              <td id="total-consumo" style="padding: 12px;">0</td>\n            </tr>\n            <tr>\n              <th class="sortable" data-sort-key="date" style="\n                background-color: #5c307d; color: white; padding: 12px; text-align: left; font-weight: 500;\n                user-select: none; position: sticky; top: 0; z-index: 1; cursor: pointer;\n              ">\n                <span class="label">Data</span><span class="arrow"></span>\n              </th>\n              <th class="sortable" data-sort-key="consumptionKwh" style="\n                background-color: #5c307d; color: white; padding: 12px; text-align: left; font-weight: 500;\n                user-select: none; position: sticky; top: 0; z-index: 1; cursor: pointer;\n              ">\n                <span class="label">Consumo</span><span class="arrow"></span>\n              </th>\n            </tr>\n          </thead>\n          <tbody id="table-body" style="font-size: 14px; color: #333;">\n            <tr>\n              <td colspan="2" style="text-align: center; padding: 32px; color: #666;">Nenhum dado dispon√≠vel</td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n  \n    \x3c!-- Material Icons font link --\x3e\n    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">\n    \n    <style id="detail-sort-style">\n    #dashboard-popup th.sortable {\n      user-select: none;\n      cursor: pointer;\n      white-space: nowrap;\n    }\n    #dashboard-popup th.sortable .label { margin-right: 8px; font-weight: 600; }\n    #dashboard-popup th.sortable .arrow {\n      display: inline-block;\n      width: 0; height: 0;\n      border-left: 5px solid transparent;\n      border-right: 5px solid transparent;\n      border-bottom: 7px solid currentColor; /* ‚ñ≤ shape */\n      transform: rotate(180deg);             /* default ‚Üì */\n      transition: transform 120ms ease;\n      opacity: .85; vertical-align: middle;\n    }\n    #dashboard-popup th.sortable.asc  .arrow { transform: rotate(0deg); }     /* ‚Üë */\n    #dashboard-popup th.sortable.desc .arrow { transform: rotate(180deg); }   /* ‚Üì */\n    #dashboard-popup th.sortable.active { filter: brightness(1.05); }\n    </style>\n  `}\n    </div>\n  </div>\n`);$("body").append(d);const l={start:"",end:""};function c({start:e,end:t}){e&&(l.start=e),t&&(l.end=t),console.log("[REPORT] set dates ‚Üí",l),d.find("#start-date").val(l.start||""),d.find("#end-date").val(l.end||"")}function p(){const e=document.getElementById("table-body");if(!e)return;const t=self.ctx.$scope.reportData||[];if(0===t.length)return void(e.innerHTML='<tr><td colspan="2" style="text-align: center; padding: 32px; color: #666;">Nenhum dado dispon√≠vel</td></tr>');let n=t;t.length>0&&(self.ctx.$scope.detailSortColumn=self.ctx.$scope.detailSortColumn||"date",self.ctx.$scope.detailSortReverse=self.ctx.$scope.detailSortReverse||!1,n=function(e){const t=self.ctx.$scope.detailSortColumn||"date",n=!!self.ctx.$scope.detailSortReverse;return[...e].sort(((e,o)=>{let a=e[t],r=o[t];if("consumptionKwh"===t)a=Number(a||0),r=Number(r||0);else{const e=e=>{const[t,n,o]=String(e).split("/");return new Date(`${o}-${n}-${t}T00:00:00-03:00`)};a=e(a),r=e(r)}return a<r?n?1:-1:a>r?n?-1:1:0}))}(t)),e.innerHTML="",n.forEach(((t,n)=>{const o=document.createElement("tr"),a=n%2!=0,r=a?"white":"inherit",i=a?"#CCCCCC":"inherit";o.innerHTML=`\n        <td style="padding: 8px 12px; color: ${r}; background-color: ${i}; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5)">${t.date}</td>\n        <td style="padding: 8px 12px; color: ${r}; background-color: ${i};text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5)">${MyIOLibrary.formatEnergy(t.consumptionKwh)}</td>\n    `,e.appendChild(o)}))}function u(){const e=self.ctx.$scope.detailSortColumn||"date",t=!!self.ctx.$scope.detailSortReverse;$("#table-body").closest("table").find("th.sortable").removeClass("active asc desc");const n=$("#table-body").closest("table").find(`th.sortable[data-sort-key="${e}"]`);n.length&&(n.addClass("active"),n.addClass(t?"desc":"asc"))}c(DatesStore.get()),d.off("change.reportDates","#start-date,#end-date").on("change.reportDates","#start-date,#end-date",(()=>{c({start:d.find("#start-date").val(),end:d.find("#end-date").val()})})),console.log("[REPORT] popup open",{deviceId:e,ingestionId:a}),d.on("remove",(()=>console.log("[REPORT] popup closed"))),$("#close-dashboard-popup").on("click",(()=>$("#dashboard-popup").remove())),d.off("click.reportLoad",".report-load, #btn-load").on("click.reportLoad",".report-load, #btn-load",(async()=>{const{start:e,end:t}=l;if(!e||!t)return alert("Selecione as datas de in√≠cio e fim.");if(console.log("[REPORT] Load clicked with",{start:e,end:t}),a&&isValidUUID(a))try{const n=toISOWithOffset(new Date(e+"T00:00:00-03:00")),o=toISOWithOffset(new Date(t+"T23:59:59-03:00"),!0);console.log(`[REPORT] Fetching data for ingestionId=${a} from ${n} to ${o}`);const r=`${DATA_API_HOST}/api/v1/telemetry/devices/${a}/energy?startTime=${encodeURIComponent(n)}&endTime=${encodeURIComponent(o)}&granularity=1d&page=1&pageSize=1000&deep=0`;console.log(`[REPORT] Calling Data API: ${r.split("?")[0]} with deviceId=${a}`);const i=await fetchWithAuth(r),s=await i.json();if(!Array.isArray(s)||0===s.length)return console.warn("[REPORT] Data API returned empty or invalid response"),self.ctx.$scope.reportData=[],self.ctx.$scope.totalConsumption=0,void p();const d=s[0].consumption||[],l=getDateRangeArray(e,t),c={};let u=0;d.forEach((e=>{if(e.timestamp&&null!=e.value){const t=e.timestamp.slice(0,10),n=Number(e.value);c[t]||(c[t]=0),c[t]+=n,u+=n}}));const m=new Date,g=String(m.getDate()).padStart(2,"0"),f=String(m.getMonth()+1).padStart(2,"0"),h=m.getFullYear(),b=String(m.getHours()).padStart(2,"0"),x=` ${g}/${f}/${h} - ${b}:${String(m.getMinutes()).padStart(2,"0")}`,y=l.map((e=>{const[t,n,o]=e.split("-");return{date:`${o}/${n}/${t}`,consumptionKwh:null!=c[e]?c[e]:0}}));self.ctx.$scope.reportData=y,self.ctx.$scope.totalConsumption=u,self.ctx.$scope.insueDate=x,document.getElementById("total-consumo").textContent=MyIOLibrary.formatEnergy(u),document.getElementById("inssueDate").textContent=x,p(),habilitarBotaoExport(),applySortAndDetectChanges(),console.log(`[REPORT] Successfully processed ${d.length} consumption records, total: ${u} kWh`)}catch(e){console.error("[REPORT] Error fetching from Data API:",e),alert("Erro ao buscar dados da API. Veja console para detalhes."),self.ctx.$scope.reportData=[],self.ctx.$scope.totalConsumption=0,p()}else alert("Dispositivo n√£o possui ingestionId v√°lido para consulta na Data API.")})),$("#btn-export-csv").on("click",(()=>{self.ctx.$scope.reportData?exportToCSV(self.ctx.$scope.reportData,r,self.ctx.$scope.totalConsumption,s,self.ctx.$scope.insueDate):alert("Fun√ß√£o exportar CSV ainda n√£o implementada.")})),self.ctx.$scope.detailSortColumn=self.ctx.$scope.detailSortColumn||"date",self.ctx.$scope.detailSortReverse=self.ctx.$scope.detailSortReverse||!1,u(),$(document).off("click.myioDetailHeaderSort","#dashboard-popup th.sortable").on("click.myioDetailHeaderSort","#dashboard-popup th.sortable",(function(){const e=$(this).data("sort-key");e&&(self.ctx.$scope.detailSortColumn===e?self.ctx.$scope.detailSortReverse=!self.ctx.$scope.detailSortReverse:(self.ctx.$scope.detailSortColumn=e,self.ctx.$scope.detailSortReverse=!1),p(),u())}))}function getAdminConsumption(e){try{const t=document.querySelector(`div[data-entity-label="${e}"]`);if(!t)return console.warn(`[getAdminConsumption] ‚ö†Ô∏è Div com data-entity-label="${e}" n√£o encontrada.`),0;const n=t.querySelector("span.consumption-value");if(!n)return console.warn(`[getAdminConsumption] ‚ö†Ô∏è Span .consumption-value n√£o encontrado dentro da div de "${e}".`),0;const o=n.textContent.trim(),a=o.replace(/\./g,"").replace(",","."),r=parseFloat(a);return isNaN(r)?(console.warn(`[getAdminConsumption] ‚ö†Ô∏è Valor inv√°lido em "${e}": "${o}" (normalizado: "${a}")`),0):r}catch(t){return console.error(`[getAdminConsumption] ‚ùå Erro inesperado ao capturar consumo de "${e}":`,t),0}}function updateInfoCardsAndChart(e,t){let n=0,o=0;t.forEach((({label:e="",val:t})=>{/subesta/i.test(e)?n+=t:/rel[√≥o]gio/i.test(e)&&(o+=t)}));const a=self.ctx,r=e[Object.keys(GROUPS)[0]],i=getAdminConsumption("Administra√ß√£o 1"),s=getAdminConsumption("Administra√ß√£o 2");i||console.warn("[updateInfoCardsAndChart] ‚ö†Ô∏è Administra√ß√£o 1 n√£o encontrada nos items."),s||console.warn("[updateInfoCardsAndChart] ‚ö†Ô∏è Administra√ß√£o 2 n√£o encontrada nos items.");const d=(e[Object.keys(GROUPS)[1]]>1e3?e[Object.keys(GROUPS)[1]]/1e3:e[Object.keys(GROUPS)[1]])-(i+s),l=e[Object.keys(GROUPS)[2]],c=n+o,p=1e3*d+l,u=c-p;let m,g,f,h;if(u>=0)f="√Årea Comum",h=u,m=[d,l,h],g=["Chiller e Bombas",Object.keys(GROUPS)[2],"√Årea Comum"];else{f="√Årea Comum",h=-Math.abs(u),m=[d,l,h],g=["Chiller e Bombas",Object.keys(GROUPS)[2],"√Årea Comum (-)"],console.warn(`[delta NOK] ‚ö†Ô∏è delta: "${u}" | Entrada Total: "${c}" | Consumo Total: "${p}" (Lojas "${l}", Admin "${1e3*(i+s)}" e Bombas "${1e3*d}")`)}const b=a.groupDivs["√Årea Comum"].find("#area-comum-list"),x=e=>r>0?(e/r*100).toFixed(1):"0.0",y=1e3*d+l+h,v=e=>y>0?(e/y*100).toFixed(1):"0.0";b.empty(),b.append(createInfoCard("Total Entrada Subesta√ß√£o",n,x(n),"/api/images/public/TQHPFqiejMW6lOSVsb8Pi85WtC0QKOLU")),b.append(createInfoCard("Total Entrada Rel√≥gios",o,x(o),"/api/images/public/ljHZostWg0G5AfKiyM8oZixWRIIGRASB"));const w=1e3*d;b.append(createInfoCard("Bombas e Chiller",w,v(w),"/api/images/public/Rge8Q3t0CP5PW8XyTn9bBK9aVP6uzSTT")),b.append(createInfoCard("Lojas",l,v(l),"/api/images/public/f9Ce4meybsdaAhAkUlAfy5ei3I4kcN4k")),b.append(createInfoCard(f,h,v(h),"/api/images/public/oXk6v7hN8TCaBHYD4PQo5oM5fr7xuUAb")),a.areaChart&&a.areaChart.destroy();const $=m.map(((e,t)=>0===t?1e3*e:e)),D=$.reduce(((e,t)=>e+t),0);a.areaChart=new Chart(document.getElementById("areaChart").getContext("2d"),{type:"pie",data:{labels:g,datasets:[{label:"Consumo",data:$,backgroundColor:u>=0?["#2196f3","#4caf50","#ff9800"]:["#2196f3","#4caf50","#f44336"]}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:0},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{const t=e.dataIndex,n=g[t],o=$[t]??0;let a=D>0?(o/D*100).toFixed(1):"0.0";return a=MyIOLibrary.formatNumberReadable(a),`${n} (${a}%)`}}}}}});const C=document.getElementById("areaLegend");if(C){C.innerHTML="";const e=a.areaChart.data.datasets[0].backgroundColor;g.forEach(((t,n)=>{const o=$[n]??0,a=D>0?(o/D*100).toFixed(1):"0.0",r=t.length>7?t.slice(0,7)+"...":t,i=document.createElement("li");i.innerHTML=`\n        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;background:${e[n]};"></span>\n        <span>${r} (${MyIOLibrary.formatNumberReadable(a)}%)</span>\n      `,C.appendChild(i)}))}}async function loadMainBoardData(e,t){try{await self.onInit({strt:e,end:t}),self.ctx.detectChanges?.()}catch(e){console.error("[MAIN] Error loading board data:",e)}}function styleOnPicker(){const e=document.querySelector(".daterangepicker .drp-buttons");if(!e)return;const t=e.querySelector(".applyBtn"),n=e.querySelector(".cancelBtn");[t,n].forEach((e=>{e&&(e.classList.add("tbx-btn"),e.style.setProperty("display","inline-flex","important"),e.style.setProperty("align-items","center","important"),e.style.setProperty("justify-content","center","important"),e.style.setProperty("height","34px","important"),e.style.setProperty("padding","6px 14px","important"),e.style.setProperty("border-radius","8px","important"),e.style.setProperty("font-weight","600","important"),e.style.setProperty("font-size","13px","important"),e.style.setProperty("line-height","1","important"),e.style.setProperty("cursor","pointer","important"),e.style.setProperty("user-select","none","important"),e.style.setProperty("box-shadow","0 1px 2px rgba(16,24,40,.06)","important"),e.style.setProperty("margin-left","8px","important"),e.style.setProperty("border","none","important"))})),t&&(t.style.setProperty("background","#1989ff","important"),t.style.setProperty("color","#fff","important")),n&&(n.style.setProperty("background","#ffe6e6","important"),n.style.setProperty("color","#b42318","important"),n.style.setProperty("border","1px solid #ffd3d3","important"))}function classify(e){const t=(e||"").toLowerCase(),n=Object.keys(GROUPS);return ctx.groupDivs={[n[0]]:$(".group-card.entrada"),[n[1]]:$(".group-card.administracao"),[n[2]]:$(".group-card.lojas"),"√Årea Comum":$(".group-card.area-comum")},/subesta|rel[√≥o]gio|entrada/.test(t)?[n[0]]:/administra|adm\.?|bomba|chiller/.test(t)?[n[1]]:[n[2]]}function getValueByDatakey(e,t,n){for(const o of e)if(o.datasource.name===t&&o.dataKey.name===n){const e=o.data?.[0]?.[1];return null!=e?e:(console.warn(`Valor n√£o encontrado para ${t} - ${n}`),null)}}self.onInit=async function({strt:e,end:t}={}){if("undefined"==typeof Chart){const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js",e.onload=()=>{console.log("[Chart.js] Loaded successfully")},e.onerror=()=>{console.error("[Chart.js] Failed to load")},document.head.appendChild(e)}var n,o=$('input[name="startDatetimes"]');function a(){if(n&&n.getDates){const e=n.getDates();return{startDate:e.startISO,endDate:e.endISO}}return{startDate:self.ctx.$scope.startTs||(new Date).toISOString(),endDate:self.ctx.$scope.endTs||(new Date).toISOString()}}console.log("[DateRangePicker] Using MyIOLibrary.createDateRangePicker"),MyIOLibrary.createDateRangePicker(o[0],{presetStart:e,presetEnd:t,onApply:function(e){console.log("[DateRangePicker] Applied:",e),self.ctx.$scope.startTs=e.startISO,self.ctx.$scope.endTs=e.endISO}}).then((function(e){n=e,console.log("[DateRangePicker] Successfully initialized")})).catch((function(e){console.error("[DateRangePicker] Failed to initialize:",e)})),styleOnPicker();const r=new Date,i=new Date(r.getFullYear(),r.getMonth(),1);var s={startDate:e||i.toISOString(),endDate:t||r.toISOString()};self.ctx.$scope.startTs=s.startDate,self.ctx.$scope.endTs=s.endDate,console.log("Datas definidas:",s.startDate,s.endDate),$(".load-button").off("click").on("click",(async()=>{var e=a();self.ctx.$scope.startTs=e.startDate,self.ctx.$scope.endTs=e.endDate,DatesStore.set({start:e.startDate,end:e.endDate}),updateMainReportSortUI(),updateInfoCardsAndChart(u,g),await loadMainBoardData(e.startDate,e.endDate)}));const d=self.ctx;d.groups=GROUPS;const l=Object.keys(GROUPS);d.groupDivs={[l[0]]:$(".group-card.entrada"),[l[1]]:$(".group-card.administracao"),[l[2]]:$(".group-card.lojas"),"√Årea Comum":$(".group-card.area-comum")},d.$areaChartCanvas=document.getElementById("areaChart"),d.$lockOverlay=$(".widget-lock-overlay"),$(".search-bar").on("input",(function(){const e=$(this).val().toLowerCase();$(".device-card-centered").each((function(){const t=$(this).find(".device-title").text().toLowerCase();$(this).toggle(t.includes(e))}))})),d.$lockOverlay.find("button").on("click",(()=>{"myio2025"===d.$lockOverlay.find("input").val()?d.$lockOverlay.remove():alert("Senha incorreta!")})),d.$lockOverlay.remove(),d.$container.off("click",".device-card-centered").on("click",".device-card-centered",(function(){const e=$(this).data("entity-id"),t=$(this).data("entity-type");var n=a();self.ctx.$scope.startTs=n.startDate,self.ctx.$scope.endTs=n.endDate;const o=$(this).data("entity-slaveid"),r=$(this).data("entity-ingestionid"),i=$(this).data("entity-label")||"SEM-LABEL",s=$(this).data("entity-centralid"),d=$(this).find(".consumption-value");openDashboardPopupEnergy(e,t,o,s,r,i,Number(d.data("entity-consumption")||d.text().replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",",".")),n.startDate,n.endDate)})),d.$container.off("click",".card-action").on("click",".card-action",(function(e){e.stopPropagation();const t=$(this).closest(".device-card-centered"),n=t.data("entity-id"),o=t.data("entity-type"),r=t.data("entity-slaveid"),i=t.data("entity-ingestionid"),s=t.data("entity-updated-identifiers"),d=t.data("entity-label")||"SEM-LABEL",l=t.data("entity-centralid"),c=$(this).data("action"),p=t.find(".consumption-value"),u=Number(p.data("entity-consumption")||p.text().replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",","."));if(console.log(`[A√ß√£o] ${c} em ${d} (ID: ${n}, Tipo: ${o})`),console.log(`[CLICK] >>> card-action > Detalhes: SlaveID=${r}, IngestionID=${i}, CentralID=${l}, Consumption=${u}, UpdatedIdentifiers=${s}`),"dashboard"===c){var m=a();self.ctx.$scope.startTs=m.startDate,self.ctx.$scope.endTs=m.endDate,openDashboardPopupEnergy(n,o,r,l,i,d,u,m.startDate,m.endDate)}else"report"===c?openDashboardPopupReport(n,o,r,l,i,d,u,s):"settings"===c&&openDashboardPopup(n,o)})),d.$container.off("click",".checkbox-icon").on("click",".checkbox-icon",(function(e){e.stopPropagation();const t=$(this),n="true"===t.attr("data-checked");t.attr("data-checked",!n),t.attr("src",n?"/api/images/public/CDKhFbw8zLJOPPkQvQrbceQ5uO8ZZvxE":"/api/images/public/1CNdGBAdq10lMHZDiHkml7HwQs370L6v")})),$(".menu-toggle-btn").on("click",(function(){$(".menu-dropdown").toggle()})),$(".menu-dropdown .menu-item").on("click",(function(){const e=$(this).data("report"),t=$(".checkbox-icon[data-checked='true']").closest(".device-card-centered");if("lojas"===e&&t.length>0){confirm("Deseja considerar apenas as lojas selecionadas?")?t.each((function(){openDashboardPopupReport($(this).data("entity-id"),$(this).data("entity-type"))})):openDashboardPopupReport("default-shopping-id","ASSET")}else openDashboardPopupReport("default-shopping-id","ASSET");$(".menu-dropdown").hide()})),$(".menu-item").on("click",(function(){$(".menu-item").removeClass("active"),$(this).addClass("active");$(this).text().trim()})),$(".btn-report").on("click",(()=>{openDashboardPopupAllReport("default-shopping-id","ASSET")})),$(".btn-report.shopping").on("click",(()=>{openDashboardPopupReport("default-shopping-id","ASSET")}));for(const e in d.groups)d.groups[e]=[],d.groupDivs[e].find(".card-list").empty();const c=d.datasources||[],p={},u={[l[0]]:0,[l[1]]:0,[l[2]]:0};let m=0;c.forEach((e=>{const{entityId:t,entityType:n}=e,o=e.entityName,a=e.entityLabel,r=getValueByDatakey(d.data,o,"centralId"),i=getValueByDatakey(d.data,o,"slaveId"),s=getValueByDatakey(d.data,o,"ingestionId"),l=classify(a||o);r&&i&&(p[t]={entityId:t,entityType:n,label:a,group:l,sourceName:o,slaveId:i,centralId:r,ingestionId:s,val:0})}));try{if(0===c.length)return void console.warn("Nenhum dispositivo v√°lido encontrado.");const e=self.ctx.settings&&self.ctx.settings.customerId||DEFAULT_CUSTOMER_ID;if(!e)return void alert("customerId ausente. Configure o widget (settings.customerId) ou DEFAULT_CUSTOMER_ID.");const t=new URL(`${DATA_API_HOST}/api/v1/telemetry/customers/${e}/energy/devices/totals`),n=s.startDate,o=s.endDate;t.searchParams.set("startTime",n),t.searchParams.set("endTime",o),t.searchParams.set("deep","1");const a=await MyIOAuth.getToken(),r=await fetch(t.toString(),{headers:{Authorization:`Bearer ${a}`}});if(!r.ok){let e=`API request failed with status ${r.status}`;try{const t=await r.json();t?.error&&(e=t.error)}catch{}throw new Error(e)}const i=await r.json(),d=Array.isArray(i)?i:i.data||[];if(!Array.isArray(d))throw new Error("Resposta inesperada do Data API: n√£o h√° array em `data`.");const l=new Map;let u=0;d.forEach((e=>{e.id&&l.set(String(e.id),e)})),console.log(`[onInit] Created device map with ${l.size} entries from Data API`);for(const e of Object.values(p))if(e.ingestionId&&isValidUUID(e.ingestionId)){const t=l.get(String(e.ingestionId));t?(e.val=Number(t.total_value||0),e.consumptionKwh=e.val,e.isValid=!0):(e.val=0,e.consumptionKwh=0,e.isValid=!0)}else e.val=0,e.consumptionKwh=0,e.error="N√£o mapeado: defina ingestionId v√°lido em SERVER_SCOPE",e.isValid=!1,u++;u>0&&console.warn(`[onInit] Skipped ${u} entities without valid ingestionId`),console.log(`[onInit] Successfully mapped ${Object.values(p).filter((e=>e.isValid)).length} devices using ingestionId`)}catch(e){console.error("Erro ao buscar dados do ingestion:",e)}const g=Object.values(p).sort(((e,t)=>t.val-e.val));g.forEach((e=>{const t=e.group;u[t]+=e.val,m+=e.val})),g.forEach((({entityId:e,entityType:t,ingestionId:n,label:o,val:a,slaveId:r,centralId:i,sourceName:s})=>{const l=s.split(" ")[1].split(",").map((e=>e.includes("SCP")?e:"-")),c=o||s,p=classify(c),m=u[p]||0,g=m>0?(a/m*100).toFixed(1):"0.0",f=a>0,h=getDeviceImage(c,{isOn:f}),b=$(`\n      <div class="device-card-centered clickable" \n          data-entity-id="${e}" \n          data-entity-label="${c}" \n          data-entity-type="${t}" \n          data-entity-slaveid="${r}" \n          data-entity-ingestionid="${n}"\n          data-entity-consumption="${a}"\n          data-entity-centralid="${i}" \n          data-entity-updated-identifiers='${JSON.stringify(l)}'>\n        <div class="card-actions" style="width: 15%">\n          <div class="card-action" data-action="dashboard" title="Dashboard"><img src="/api/images/public/TAVXE0sTbCZylwGsMF9lIWdllBB3iFtS"/></div>\n          <div class="card-action" data-action="report" title="Relat√≥rio"><img src="/api/images/public/d9XuQwMYQCG2otvtNSlqUHGavGaSSpz4"/></div>\n          <div class="card-action" data-action="settings" title="Configura√ß√µes"><img src="/api/images/public/5n9tze6vED2uwIs5VvJxGzNNZ9eV4yoz"/></div>\n        </div>\n        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 85%">\n          <div class="device-title-row">\n            <span class="device-title" title="${c}">\n              ${c.length>15?c.slice(0,15)+"‚Ä¶":c}\n            </span>\n          </div>\n          <img class="device-image ${f?"blink":""}" src="${h}" />\n          <div class="device-data-row">\n            <div class="consumption-main">\n              <span class="flash-icon ${f?"flash":""}">‚ö°</span>\n              <span class="consumption-value" data-entity-consumption="${a}">${MyIOLibrary.formatEnergy(a)}</span>\n              <span class="device-title-percent">(${MyIOLibrary.formatNumberReadable(g)}%)</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `),x=d.groupDivs[p].find(`.device-card-centered[data-entity-id="${e}"]`);x.length?(x.find(".consumption-value").text(MyIOLibrary.formatEnergy(a)),x.find(".device-title-percent").text(`(${g}%)`),x.find(".device-image").attr("src",h),x.find(".flash-icon").toggleClass("flash",f),x.find(".device-image").toggleClass("blink",f)):(d.groupDivs[p].find(".card-list").append(b),d.groups[p].push({label:o,val:a,$card:b}),d.groupDivs[p].find(`[data-group-count="${p}"]`).text(`${d.groups[p].length}`))}));for(const e in u)d.groupDivs[e].find(`[data-group="${e}"]`).text(MyIOLibrary.formatEnergy(u[e]));updateInfoCardsAndChart(u,g),d.$lockOverlay.remove()},self.onDataUpdated=async function(){};