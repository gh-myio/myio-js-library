<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MYIO TELEMETRY Widget Demo v5.2.0</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <!-- Load MYIO Library from local dist -->
    <script src="../../../../../dist/myio-js-library.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Inter, "Inter var", "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .demo-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .demo-header {
        background: linear-gradient(135deg, #3E1A7D 0%, #5a2d9e 100%);
        color: white;
        padding: 24px 28px;
        border-radius: 16px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(62, 26, 125, 0.25);
      }

      .demo-header h1 {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 8px;
        letter-spacing: 0.3px;
      }

      .demo-header p {
        opacity: 0.9;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .demo-controls {
        background: white;
        padding: 16px 20px;
        border-radius: 14px;
        margin-bottom: 20px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .demo-controls button {
        padding: 10px 18px;
        border: 1px solid #E8EEF4;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s ease;
        background: white;
      }

      .demo-controls button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .demo-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3E1A7D 0%, #5a2d9e 100%) !important;
        color: white !important;
        border-color: #3E1A7D !important;
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #34c759 100%) !important;
        color: white !important;
        border-color: #28a745 !important;
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%) !important;
        color: #212529 !important;
        border-color: #ffc107 !important;
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #e4606d 100%) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .selection-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 14px;
        margin-bottom: 20px;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
      }

      .selection-summary h3 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
        font-weight: 700;
      }

      .selection-text {
        font-size: 0.95rem;
        opacity: 0.95;
      }

      .widget-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        min-height: 600px;
      }

      .analytics-panel {
        background: white;
        border-radius: 14px;
        margin-top: 20px;
        padding: 16px 20px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      }

      .analytics-panel h4 {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        color: #3E1A7D;
        font-weight: 700;
      }

      .analytics-log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        max-height: 180px;
        overflow-y: auto;
        font-family: "SF Mono", Monaco, Consolas, monospace;
        font-size: 0.8rem;
      }

      .analytics-log .log-entry {
        margin-bottom: 6px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .analytics-log .log-entry.event {
        background: #e3f2fd;
        color: #1565c0;
      }

      .analytics-log .log-entry.action {
        background: #f3e5f5;
        color: #6a1b9a;
      }

      .filter-tabs {
        display: flex;
        gap: 8px;
        margin-left: auto;
      }

      .filter-tab {
        padding: 6px 14px !important;
        font-size: 12px !important;
        border-radius: 20px !important;
        background: #f5f5f5 !important;
        border: none !important;
      }

      .filter-tab.active {
        background: linear-gradient(135deg, #3E1A7D 0%, #5a2d9e 100%) !important;
        color: white !important;
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <div class="demo-header">
        <h1>MYIO TELEMETRY Widget Demo v5.2.0</h1>
        <p>Demo do widget de telemetria com cards de dispositivos, filtros, busca e soma de consumo. Baseado no controller.js v5.2.0.</p>
      </div>

      <div class="selection-summary">
        <h3>Resumo de Consumo</h3>
        <div class="selection-text" id="summary-text">Nenhum item selecionado</div>
      </div>

      <div class="demo-controls">
        <button id="compare-btn" class="btn-primary" disabled>Comparar Selecionados</button>
        <button id="clear-btn" class="btn-warning">Limpar Selecao</button>
        <button id="select-all-btn" class="btn-success">Selecionar Todos</button>
        <button id="refresh-btn" class="btn-danger">Atualizar Cards</button>

        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">Todos</button>
          <button class="filter-tab" data-filter="energy">Energia</button>
          <button class="filter-tab" data-filter="water">Agua</button>
          <button class="filter-tab" data-filter="temperature">Temperatura</button>
        </div>
      </div>

      <div class="widget-container">
        <section class="shops-root">
          <header class="shops-header">
            <div class="shops-header-left">
              <h2 class="shops-title" id="labelWidgetId">TELEMETRIA - DEMO</h2>
              <span class="shops-count" id="shopsCount">(0)</span>
            </div>

            <div class="shops-header-actions">
              <div class="search-wrap" id="searchWrap">
                <input type="text" id="shopsSearch" placeholder="Buscar..." autocomplete="off">
              </div>

              <button class="icon-btn" id="btnSearch" title="Buscar" aria-label="Buscar">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z"/>
                </svg>
              </button>

              <button class="icon-btn" id="btnFilter" title="Filtros" aria-label="Filtros">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z"/>
                </svg>
              </button>

              <a class="shops-total" id="shopsTotal">0,00 kWh</a>
            </div>
          </header>

          <section id="shopsList" class="shops-list"></section>
        </section>
      </div>

      <div class="analytics-panel">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <h4 style="margin: 0;">Analytics Log</h4>
          <button id="clear-log-btn" class="btn-warning" style="padding: 4px 10px; font-size: 11px;">Limpar</button>
        </div>
        <div class="analytics-log" id="analytics-log"></div>
      </div>
    </div>

    <script>
      // Access MYIO Library components
      const MyIO = window.MyIOLibrary || {};
      const {
        renderCardComponentV5,
        renderCardComponent,
        MyIOSelectionStore,
        MyIODraggableCard,
        MyIOChartModal
      } = MyIO;

      // ===================== MOCK DATA =====================
      // Based on controller.js entityObject structure
      const mockEntities = [
        {
          entityId: "dev-001",
          labelOrName: "BOMBA PISCINA 01",
          deviceIdentifier: "MOT-001",
          entityType: "DEVICE",
          deviceType: "MOTOR",
          slaveId: "01",
          ingestionId: "ing-motor-001",
          val: 1250.45,
          centralId: "21.111.222.333",
          perc: 18.5,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Campinas",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 300000,
          timeVal: Date.now() - 60000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-002",
          labelOrName: "RELOGIO ENTRADA PRINCIPAL",
          deviceIdentifier: "REL-001",
          entityType: "DEVICE",
          deviceType: "RELOGIO",
          slaveId: "02",
          ingestionId: "ing-relogio-001",
          val: 3560.80,
          centralId: "21.111.222.334",
          perc: 52.3,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Mestre Alvaro",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 120000,
          timeVal: Date.now() - 30000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-003",
          labelOrName: "HIDROMETRO JARDIM",
          deviceIdentifier: "HID-001",
          entityType: "DEVICE",
          deviceType: "HIDROMETRO",
          slaveId: "03",
          ingestionId: "ing-hidro-001",
          val: 156.20,
          centralId: "21.111.222.335",
          perc: 12.8,
          deviceStatus: "power_off",
          valType: "WATER",
          centralName: "Central Teta",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 1800000,
          timeVal: Date.now() - 900000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-004",
          labelOrName: "LOJA VITINHO ELETRO",
          deviceIdentifier: "MED-001",
          entityType: "DEVICE",
          deviceType: "3F_MEDIDOR",
          slaveId: "04",
          ingestionId: "ing-medidor-001",
          val: 890.33,
          centralId: "21.111.222.336",
          perc: 13.1,
          deviceStatus: "no_info",
          valType: "ENERGY",
          centralName: "Central Ilha Plaza",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 3600000,
          timeVal: Date.now() - 1800000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-005",
          labelOrName: "ENTRADA GERAL BLOCO A",
          deviceIdentifier: "ENT-001",
          entityType: "DEVICE",
          deviceType: "ENTRADA",
          slaveId: "05",
          ingestionId: "ing-entrada-001",
          val: 5670.90,
          centralId: "21.111.222.337",
          perc: 83.4,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Meier",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 60000,
          timeVal: Date.now() - 15000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-006",
          labelOrName: "CAIXA DAGUA COBERTURA",
          deviceIdentifier: "CXA-001",
          entityType: "DEVICE",
          deviceType: "CAIXA_DAGUA",
          slaveId: "06",
          ingestionId: "ing-caixa-001",
          val: 0,
          centralId: "21.111.222.338",
          perc: 72.5,
          deviceStatus: "danger",
          valType: "TANK",
          centralName: "Central BB Campos",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 7200000,
          timeVal: Date.now() - 3600000,
          waterLevel: 145.2,
          waterPercentage: 72.5,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-007",
          labelOrName: "FANCOIL CINEMA 01",
          deviceIdentifier: "FANCOIL",
          entityType: "DEVICE",
          deviceType: "FANCOIL",
          slaveId: "07",
          ingestionId: "ing-fancoil-001",
          val: 234.56,
          centralId: "21.111.222.339",
          perc: 3.4,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Cinema",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 180000,
          timeVal: Date.now() - 45000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-008",
          labelOrName: "ELEVADOR BLOCO B",
          deviceIdentifier: "ELV",
          entityType: "DEVICE",
          deviceType: "ELEVADOR",
          slaveId: "08",
          ingestionId: "ing-elevador-001",
          val: 456.78,
          centralId: "21.111.222.340",
          perc: 6.7,
          deviceStatus: "maintenance",
          valType: "ENERGY",
          centralName: "Central Bloco B",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 900000,
          timeVal: Date.now() - 600000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-009",
          labelOrName: "TERMOSTATO SALA TI",
          deviceIdentifier: "TERM-001",
          entityType: "DEVICE",
          deviceType: "TERMOSTATO",
          slaveId: "09",
          ingestionId: "ing-termo-001",
          val: 0,
          centralId: "21.111.222.341",
          perc: 0,
          deviceStatus: "power_on",
          valType: "TEMPERATURE",
          centralName: "Central TI",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 120000,
          timeVal: Date.now() - 30000,
          waterLevel: null,
          waterPercentage: null,
          temperature: 22.5,
          temperatureMin: 18,
          temperatureMax: 26,
          temperatureStatus: "normal"
        },
        {
          entityId: "dev-010",
          labelOrName: "CAG CENTRAL AR",
          deviceIdentifier: "CAG",
          entityType: "DEVICE",
          deviceType: "CAG",
          slaveId: "10",
          ingestionId: "ing-cag-001",
          val: 2340.12,
          centralId: "21.111.222.342",
          perc: 34.4,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central HVAC",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 240000,
          timeVal: Date.now() - 90000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-011",
          labelOrName: "ADMINISTRACAO GERAL",
          deviceIdentifier: "ADM-001",
          entityType: "DEVICE",
          deviceType: "3F_MEDIDOR",
          slaveId: "11",
          ingestionId: "ing-adm-001",
          val: 1567.89,
          centralId: "21.111.222.343",
          perc: 23.0,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Admin",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 300000,
          timeVal: Date.now() - 120000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        },
        {
          entityId: "dev-012",
          labelOrName: "ESCADA ROLANTE PISO 1",
          deviceIdentifier: "ESC",
          entityType: "DEVICE",
          deviceType: "ESCADA_ROLANTE",
          slaveId: "12",
          ingestionId: "ing-escada-001",
          val: 678.45,
          centralId: "21.111.222.344",
          perc: 10.0,
          deviceStatus: "power_on",
          valType: "ENERGY",
          centralName: "Central Piso 1",
          customerName: "Shopping ABC",
          connectionStatusTime: Date.now() - 180000,
          timeVal: Date.now() - 60000,
          waterLevel: null,
          waterPercentage: null,
          temperature: null,
          temperatureMin: null,
          temperatureMax: null,
          temperatureStatus: null
        }
      ];

      // ===================== ANALYTICS LOGGING =====================
      function logAnalytics(event, data, type = 'event') {
        const logContainer = document.getElementById('analytics-log');
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${event}: ${JSON.stringify(data)}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // ===================== STATE =====================
      let currentFilter = 'all';
      let searchTerm = '';

      // ===================== HELPERS =====================
      function formatValue(val, valType) {
        if (valType === 'WATER') return `${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} m3`;
        if (valType === 'TANK') return `${val.toLocaleString('pt-BR', { minimumFractionDigits: 1 })}%`;
        if (valType === 'TEMPERATURE') return `${val}C`;
        return `${val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} kWh`;
      }

      function calculateTotal(entities) {
        const energyTotal = entities
          .filter(e => e.valType === 'ENERGY')
          .reduce((sum, e) => sum + (e.val || 0), 0);
        return energyTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      }

      function filterEntities(entities, filter, search) {
        let filtered = [...entities];

        // Apply type filter
        if (filter === 'energy') {
          filtered = filtered.filter(e => e.valType === 'ENERGY');
        } else if (filter === 'water') {
          filtered = filtered.filter(e => e.valType === 'WATER' || e.valType === 'TANK');
        } else if (filter === 'temperature') {
          filtered = filtered.filter(e => e.valType === 'TEMPERATURE' || e.deviceType === 'TERMOSTATO');
        }

        // Apply search filter
        if (search) {
          const term = search.toLowerCase();
          filtered = filtered.filter(e =>
            e.labelOrName.toLowerCase().includes(term) ||
            e.deviceType.toLowerCase().includes(term) ||
            e.centralName.toLowerCase().includes(term)
          );
        }

        return filtered;
      }

      // ===================== RENDER CARDS =====================
      function renderCards() {
        const $list = $('#shopsList');
        $list.empty();

        const filtered = filterEntities(mockEntities, currentFilter, searchTerm);

        // Update count and total
        $('#shopsCount').text(`(${filtered.length})`);
        $('#shopsTotal').text(`${calculateTotal(filtered)} kWh`);

        filtered.forEach((entity) => {
          let $card;

          // Try to use MyIO library renderCardComponentV5
          if (typeof renderCardComponentV5 === 'function') {
            $card = renderCardComponentV5({
              entityObject: entity,
              useNewComponents: true,
              enableSelection: true,
              enableDragDrop: true,
              handleActionDashboard: (ent) => {
                logAnalytics('Dashboard Clicked', { entityId: ent.entityId, name: ent.labelOrName }, 'action');
              },
              handleActionReport: (ent) => {
                logAnalytics('Report Clicked', { entityId: ent.entityId, name: ent.labelOrName }, 'action');
              },
              handleActionSettings: (ent) => {
                logAnalytics('Settings Clicked', { entityId: ent.entityId, name: ent.labelOrName }, 'action');
              },
              handleSelect: (ent) => {
                logAnalytics('Selection Changed', { entityId: ent.entityId, name: ent.labelOrName }, 'action');
              },
              handleClickCard: (ent) => {
                logAnalytics('Card Clicked', { entityId: ent.entityId, name: ent.labelOrName }, 'action');
              }
            });
            $list.append($card[0]);
          } else if (typeof renderCardComponent === 'function') {
            // Fallback to legacy
            $card = renderCardComponent({
              entityObject: entity,
              handleActionDashboard: (ent) => {
                logAnalytics('Dashboard Clicked (Legacy)', { entityId: ent.entityId }, 'action');
              },
              handleClickCard: (ent) => {
                logAnalytics('Card Clicked (Legacy)', { entityId: ent.entityId }, 'action');
              }
            });
            $list.append($card[0]);
          } else {
            // Fallback: create simple card HTML
            const statusClass = entity.deviceStatus === 'power_on' ? 'on' :
                               entity.deviceStatus === 'power_off' ? 'off' :
                               entity.deviceStatus === 'danger' ? 'danger' : 'unknown';

            const cardHtml = `
              <div class="card-wrapper" data-entity-id="${entity.entityId}">
                <div class="device-card device-card-centered" style="
                  background: white;
                  border-radius: 14px;
                  padding: 16px;
                  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
                  border: 1px solid #E8EEF4;
                  width: 100%;
                  min-height: 120px;
                ">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                      <div style="font-weight: 700; font-size: 13px; color: #1C2743; margin-bottom: 4px;">
                        ${entity.labelOrName}
                      </div>
                      <div style="font-size: 11px; color: #6b7a90; margin-bottom: 8px;">
                        ${entity.deviceType} | ${entity.deviceIdentifier}
                      </div>
                    </div>
                    <div style="
                      width: 10px; height: 10px; border-radius: 50%;
                      background: ${statusClass === 'on' ? '#28a745' : statusClass === 'off' ? '#dc3545' : statusClass === 'danger' ? '#ffc107' : '#6c757d'};
                    "></div>
                  </div>
                  <div style="font-weight: 800; font-size: 20px; color: #3E1A7D; margin-top: 12px;">
                    ${entity.valType === 'TANK' ? entity.waterPercentage + '%' :
                      entity.valType === 'TEMPERATURE' ? entity.temperature + 'C' :
                      formatValue(entity.val, entity.valType)}
                  </div>
                  <div style="font-size: 10px; color: #6b7a90; margin-top: 4px;">
                    ${entity.centralName}
                  </div>
                </div>
              </div>
            `;
            $list.append(cardHtml);
          }
        });

        logAnalytics('Cards Rendered', {
          count: filtered.length,
          filter: currentFilter,
          search: searchTerm || 'none'
        }, 'event');
      }

      // ===================== SELECTION STORE SETUP =====================
      if (MyIOSelectionStore) {
        MyIOSelectionStore.setAnalytics({
          track: (event, data) => {
            logAnalytics(event, data, 'event');
          }
        });

        MyIOSelectionStore.on('selection:change', (data) => {
          const summaryText = document.getElementById('summary-text');
          const compareBtn = document.getElementById('compare-btn');

          if (data.selectedIds.length === 0) {
            summaryText.textContent = 'Nenhum item selecionado';
            compareBtn.disabled = true;
          } else {
            const display = MyIOSelectionStore.getMultiUnitTotalDisplay?.() || '';
            summaryText.innerHTML = `
              <strong>${data.selectedIds.length} itens selecionados</strong><br>
              ${display}
            `;
            compareBtn.disabled = data.selectedIds.length < 2;
          }

          logAnalytics('Selection Changed', {
            count: data.selectedIds.length,
            ids: data.selectedIds
          }, 'action');
        });
      }

      // ===================== EVENT HANDLERS =====================
      // Compare button
      document.getElementById('compare-btn').addEventListener('click', () => {
        if (MyIOSelectionStore) {
          logAnalytics('Compare Button Clicked', { action: 'open_comparison' }, 'action');
          MyIOSelectionStore.openComparison?.();
        }
      });

      // Clear button
      document.getElementById('clear-btn').addEventListener('click', () => {
        if (MyIOSelectionStore) {
          logAnalytics('Clear Selection Clicked', { action: 'clear' }, 'action');
          MyIOSelectionStore.clear?.();
        }
        document.getElementById('summary-text').textContent = 'Nenhum item selecionado';
        document.getElementById('compare-btn').disabled = true;
      });

      // Select all button
      document.getElementById('select-all-btn').addEventListener('click', () => {
        if (MyIOSelectionStore) {
          mockEntities.forEach(entity => {
            MyIOSelectionStore.add?.(entity.entityId);
          });
          logAnalytics('Select All Clicked', { action: 'select_all' }, 'action');
        }
      });

      // Refresh button
      document.getElementById('refresh-btn').addEventListener('click', () => {
        renderCards();
        if (MyIOSelectionStore) {
          MyIOSelectionStore.clear?.();
        }
        logAnalytics('Cards Refreshed', { action: 'refresh' }, 'action');
      });

      // Clear log button
      document.getElementById('clear-log-btn').addEventListener('click', () => {
        document.getElementById('analytics-log').innerHTML = '';
      });

      // Search functionality
      document.getElementById('btnSearch').addEventListener('click', () => {
        const $wrap = $('#searchWrap');
        $wrap.toggleClass('active');
        if ($wrap.hasClass('active')) {
          $('#shopsSearch').focus();
        }
      });

      document.getElementById('shopsSearch').addEventListener('input', (e) => {
        searchTerm = e.target.value;
        renderCards();
      });

      // Filter tabs
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.dataset.filter;
          renderCards();
          logAnalytics('Filter Changed', { filter: currentFilter }, 'action');
        });
      });

      // ===================== INITIAL RENDER =====================
      renderCards();

      logAnalytics('Demo Loaded', {
        components: {
          MyIOSelectionStore: !!MyIOSelectionStore,
          MyIODraggableCard: !!MyIODraggableCard,
          MyIOChartModal: !!MyIOChartModal,
          renderCardComponentV5: !!renderCardComponentV5,
          renderCardComponent: !!renderCardComponent
        },
        mockEntitiesCount: mockEntities.length
      }, 'event');
    </script>
  </body>
</html>
