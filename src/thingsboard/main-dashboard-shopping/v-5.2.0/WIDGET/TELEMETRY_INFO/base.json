{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "fqn": "widget_shopping_dashboard_info_v_5_2_0",
    "name": "Widget - Shopping Dashboard - INFO - v.5.2.0",
    "deprecated": false,
    "image": null,
    "description": null,
    "descriptor": {
      "type": "latest",
      "sizeX": 7.5,
      "sizeY": 3,
      "resources": [
        {
          "url": "https://unpkg.com/myio-js-library@latest/dist/myio-js-library.umd.min.js"
        },
        {
          "url": "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
        }
      ],
      "templateHtml": "<!--\r\n  ThingsBoard Widget: TELEMETRY_INFO (MyIO v-5.2.0)\r\n  RFC-0056: Grid 2 columns layout with 6 categories\r\n  - Entrada, Climatiza√ß√£o, Elevadores, Esc. Rolantes, Lojas, √Årea Comum (residual)\r\n-->\r\n\r\n<section class=\"telemetry-info-root\">\r\n  <!-- HEADER -->\r\n  <header class=\"info-header\">\r\n    <!-- RFC-0105: btnInfoSummary √© criado dinamicamente pelo controller -->\r\n    <h2 class=\"info-title\" id=\"infoTitleHeader\">‚ÑπÔ∏è Informa√ß√µes de Energia</h2>\r\n    <button\r\n      class=\"btn-expand\"\r\n      id=\"btnExpandModal\"\r\n      title=\"Expandir visualiza√ß√£o\"\r\n      style=\"display: none !important; cursor: pointer !important; z-index: 9999 !important;\"\r\n      onclick=\"console.log('[TELEMETRY_INFO] Button clicked!'); if(window.TELEMETRY_INFO_openModal) { window.TELEMETRY_INFO_openModal(); } else { alert('Function not loaded yet!'); }\">\r\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n        <path d=\"M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7\"/>\r\n      </svg>\r\n    </button>\r\n  </header>\r\n\r\n  <!-- GRID 2 COLUNAS -->\r\n  <div class=\"info-grid\">\r\n\r\n    <!-- ========== ROW 1: ENTRADA + LOJAS ========== -->\r\n    <div class=\"info-card entrada-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üì•</span>\r\n        <h3 class=\"card-title\">Entrada</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"entradaTotal\">0,00 kWh</span>\r\n        </div>\r\n        <div class=\"devices-list\" id=\"entradaDevices\">\r\n          <!-- Dispositivos de entrada (opcional) -->\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"info-card lojas-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üè™</span>\r\n        <h3 class=\"card-title\">Lojas</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"lojasTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"lojasPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- ========== WATER DOMAIN: BANHEIROS (hidden by default) ========== -->\r\n    <div class=\"info-card banheiros-card\" style=\"display: none;\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üöø</span>\r\n        <h3 class=\"card-title\">Banheiros</h3>\r\n        <span class=\"info-tooltip\" title=\"Consumo de √°gua em banheiros e √°reas sanit√°rias\">‚ÑπÔ∏è</span>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"banheirosTotal\">0,00 m¬≥</span>\r\n          <span class=\"stat-perc\" id=\"banheirosPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- ========== ROW 2: CLIMATIZA√á√ÉO + ELEVADORES ========== -->\r\n    <div class=\"info-card climatizacao-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">‚ùÑÔ∏è</span>\r\n        <h3 class=\"card-title\">Climatiza√ß√£o</h3>\r\n        <span class=\"info-tooltip\" title=\"Climatiza√ß√£o = CAG + Fancoils + Chillers + Bombas (Prim√°rias + Secund√°rias + Condensadoras)\">‚ÑπÔ∏è</span>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"climatizacaoTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"climatizacaoPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"info-card elevadores-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üõó</span>\r\n        <h3 class=\"card-title\">Elevadores</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"elevadoresTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"elevadoresPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- ========== ROW 3: ESC. ROLANTES + OUTROS EQUIPAMENTOS ========== -->\r\n    <div class=\"info-card escadas-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üé¢</span>\r\n        <h3 class=\"card-title\">Esc. Rolantes</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"escadasRolantesTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"escadasRolantesPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"info-card outros-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">‚öôÔ∏è</span>\r\n        <h3 class=\"card-title\">Outros Equipamentos</h3>\r\n        <span class=\"info-tooltip\" title=\"Equipamentos n√£o classificados nas categorias principais\">‚ÑπÔ∏è</span>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"outrosTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"outrosPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- ========== ROW 4: √ÅREA COMUM + TOTAL (SAME ROW) ========== -->\r\n    <div class=\"info-card area-comum-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üè¢</span>\r\n        <h3 class=\"card-title\">√Årea Comum</h3>\r\n        <span class=\"info-tooltip\" title=\"Entrada - (Lojas + Climatiza√ß√£o + Elevadores + Esc. Rolantes + Outros)\">‚ÑπÔ∏è</span>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"areaComumTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"areaComumPerc\">(0%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"info-card total-card\">\r\n      <div class=\"card-header\">\r\n        <span class=\"card-icon\">üìä</span>\r\n        <h3 class=\"card-title\">Total Consumidores</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"stat-row main-stat\">\r\n          <span class=\"stat-value\" id=\"consumidoresTotal\">0,00 kWh</span>\r\n          <span class=\"stat-perc\" id=\"consumidoresPerc\">(100%)</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- ========== ROW 5: GR√ÅFICO (FULL WIDTH) ========== -->\r\n    <div class=\"info-card chart-card\">\r\n      <div class=\"card-header\">\r\n        <h3 class=\"card-title\">Distribui√ß√£o de Consumo</h3>\r\n      </div>\r\n      <div class=\"card-body\">\r\n        <div class=\"chart-container\">\r\n          <canvas id=\"consumptionPieChart\"></canvas>\r\n        </div>\r\n        <div class=\"chart-legend\" id=\"chartLegend\">\r\n          <!-- Legenda gerada dinamicamente -->\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n  </div>\r\n\r\n  <!-- ========== MODAL EXPANDIDA (PREMIUM CLEAN) ========== -->\r\n  <div class=\"modal-overlay\" id=\"modalExpanded\" style=\"display: none;\" onclick=\"if(event.target.id === 'modalExpanded') { window.TELEMETRY_INFO_closeModal && window.TELEMETRY_INFO_closeModal(); }\">\r\n    <div class=\"modal-container\">\r\n      <!-- Close Button (Floating) -->\r\n      <button\r\n        class=\"btn-close-floating\"\r\n        id=\"btnCloseModal\"\r\n        title=\"Fechar\"\r\n        onclick=\"console.log('[TELEMETRY_INFO] Close button clicked!'); window.TELEMETRY_INFO_closeModal && window.TELEMETRY_INFO_closeModal()\">\r\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\">\r\n          <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n          <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n        </svg>\r\n      </button>\r\n\r\n      <!-- Modal Content: Chart Only -->\r\n      <div class=\"modal-body-clean\">\r\n        <h2 class=\"modal-title-clean\" id=\"modalTitleHeader\">Distribui√ß√£o de Consumo de Energia</h2>\r\n\r\n        <!-- Inner White Container for Chart -->\r\n        <div class=\"modal-chart-inner-container\">\r\n          <div class=\"modal-chart-wrapper\">\r\n            <canvas id=\"modalConsumptionPieChart\"></canvas>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"modal-legend-clean\" id=\"modalChartLegend\">\r\n          <!-- Legenda gerada dinamicamente -->\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</section>\r\n",
      "templateCss": "/*\r\n * ThingsBoard Widget: TELEMETRY_INFO (MyIO v-5.2.0)\r\n * RFC-0056: Light Mode Theme + Grid 2 Columns Layout\r\n * Paleta MyIO: #5B2EBC (primary), #00C896 (accent)\r\n */\r\n\r\n/* ========== CSS VARIABLES (MyIO Design System) ========== */\r\n\r\n:root {\r\n  --myio-primary: #5B2EBC;        /* Purple - Primary brand color */\r\n  --myio-accent: #00C896;         /* Teal/Green - Accent color */\r\n  --myio-bg: #FFFFFF;             /* White - Background */\r\n  --myio-bg-secondary: #F9F9F9;   /* Light gray - Secondary background */\r\n  --myio-text: #222222;           /* Dark gray - Primary text */\r\n  --myio-text-secondary: #666666; /* Medium gray - Secondary text */\r\n  --myio-text-tertiary: #999999;  /* Light gray - Tertiary text */\r\n  --myio-border: #E0E0E0;         /* Light gray - Borders */\r\n  --myio-border-light: #F0F0F0;   /* Very light gray - Subtle borders */\r\n  --myio-shadow: rgba(0, 0, 0, 0.05);      /* Subtle shadow */\r\n  --myio-shadow-hover: rgba(0, 0, 0, 0.1); /* Hover shadow */\r\n}\r\n\r\n/* ========== ROOT CONTAINER ========== */\r\n\r\n.telemetry-info-root {\r\n  display: flex;\r\n  flex-direction: column;\r\n  height: 100%;\r\n  padding: 16px;\r\n  background: var(--myio-bg, #FFFFFF);\r\n  color: var(--myio-text, #222222);\r\n  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\r\n  box-sizing: border-box;\r\n}\r\n\r\n/* ========== HEADER ========== */\r\n\r\n.info-header {\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.info-title {\r\n  font-size: 20px;\r\n  font-weight: 600;\r\n  color: var(--myio-primary, #5B2EBC);\r\n  margin: 0;\r\n  letter-spacing: -0.01em;\r\n}\r\n\r\n/* ========== CONTENT GRID (RFC-0056: 2 Columns) ========== */\r\n\r\n.info-grid {\r\n  display: grid;\r\n  grid-template-columns: repeat(2, 1fr);\r\n  gap: 16px;\r\n  flex: 1;\r\n  min-height: 0;\r\n}\r\n\r\n/* ========== CARDS ========== */\r\n\r\n/* RFC-0105: Compact 2-line cards */\r\n.info-card {\r\n  background: var(--myio-bg-secondary, #F9F9F9);\r\n  border: 1px solid var(--myio-border, #E0E0E0);\r\n  border-radius: 10px;\r\n  padding: 10px 12px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  overflow: hidden;\r\n  transition: all 0.2s ease;\r\n  box-shadow: 0 2px 8px var(--myio-shadow, rgba(0, 0, 0, 0.05));\r\n}\r\n\r\n.info-card:hover {\r\n  border-color: var(--myio-accent, #00C896);\r\n  box-shadow: 0 4px 12px var(--myio-shadow-hover, rgba(0, 0, 0, 0.1));\r\n  transform: translateY(-2px);\r\n}\r\n\r\n/* RFC-0056 FIX: Layout Grid\r\n * ROW 1: [Entrada] [Lojas]\r\n * ROW 2: [Climatiza√ß√£o] [Elevadores]\r\n * ROW 3: [Esc. Rolantes] [Outros]\r\n * ROW 4: [√É√Å√Årea Comum] [Total Consumidores]  ‚Üê SAME ROW (2 columns)\r\n * ROW 5: [Chart - Full Width]                ‚Üê FULL WIDTH (100%)\r\n */\r\n\r\n/* Chart ALWAYS takes full width (100%) */\r\n.chart-card {\r\n  grid-column: 1 / -1; /* Span all columns (both in 2-col grid) */\r\n}\r\n\r\n/* Desktop: √É√Å√Årea Comum + Total side by side */\r\n@media (min-width: 769px) {\r\n  .area-comum-card {\r\n    grid-column: 1; /* First column */\r\n  }\r\n\r\n  .total-card {\r\n    grid-column: 2; /* Second column */\r\n  }\r\n}\r\n\r\n/* RFC-0105: Compact 2-line card layout */\r\n.card-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.card-icon {\r\n  font-size: 16px;\r\n  line-height: 1;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.card-title {\r\n  font-size: 13px;\r\n  font-weight: 600;\r\n  margin: 0;\r\n  color: var(--myio-primary, #5B2EBC);\r\n  letter-spacing: -0.01em;\r\n  white-space: nowrap;\r\n  flex: 1;\r\n}\r\n\r\n/* Tooltip icon - floats right in card-header */\r\n.info-tooltip {\r\n  font-size: 12px;\r\n  color: var(--myio-accent, #00C896);\r\n  cursor: help;\r\n  opacity: 0.7;\r\n  transition: opacity 0.2s ease;\r\n  flex-shrink: 0;\r\n  margin-left: auto;\r\n}\r\n\r\n.info-tooltip:hover {\r\n  opacity: 1;\r\n}\r\n\r\n.card-body {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0;\r\n}\r\n\r\n/* ========== STATS (RFC-0056 FIX: Valor + Percentual na mesma linha) ========== */\r\n\r\n.stat-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  gap: 8px;\r\n  font-size: 12px;\r\n  line-height: 1.2;\r\n}\r\n\r\n.stat-row.main-stat {\r\n  font-size: 14px;\r\n  font-weight: 600;\r\n}\r\n\r\n.stat-label {\r\n  color: var(--myio-text-secondary, #666666);\r\n  flex-shrink: 0;\r\n}\r\n\r\n.stat-value {\r\n  font-weight: 600;\r\n  color: var(--myio-text, #222222);\r\n  text-align: left; /* RFC-0056: Alinhado √É¬† esquerda */\r\n  font-variant-numeric: tabular-nums;\r\n  flex: 1; /* RFC-0056: Cresce para ocupar espa√ßo dispon√≠vel */\r\n}\r\n\r\n.stat-perc {\r\n  color: var(--myio-accent, #00C896);\r\n  font-weight: 500;\r\n  font-size: 11px;\r\n  text-align: right;\r\n  flex-shrink: 0;\r\n  font-variant-numeric: tabular-nums;\r\n  white-space: nowrap;\r\n}\r\n\r\n/* ========== DEVICES LIST ========== */\r\n\r\n.devices-list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n  font-size: 12px;\r\n  color: var(--myio-text-secondary, #666666);\r\n  margin-top: 8px;\r\n  padding-left: 16px;\r\n  max-height: 120px;\r\n  overflow-y: auto;\r\n}\r\n\r\n.devices-list:empty {\r\n  display: none;\r\n}\r\n\r\n.device-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  padding: 2px 0;\r\n}\r\n\r\n.device-item::before {\r\n  content: \"√¢‚Ç¨¬¢\";\r\n  color: var(--myio-accent, #00C896);\r\n  font-weight: bold;\r\n}\r\n\r\n/* ========== RESIDUAL NOTE ========== */\r\n\r\n.residual-note {\r\n  margin-top: 8px;\r\n  padding: 8px;\r\n  background: var(--myio-bg, #FFFFFF);\r\n  border: 1px dashed var(--myio-border, #E0E0E0);\r\n  border-radius: 6px;\r\n  text-align: center;\r\n}\r\n\r\n.residual-note small {\r\n  font-size: 11px;\r\n  color: var(--myio-text-tertiary, #999999);\r\n  font-style: italic;\r\n}\r\n\r\n/* ========== CHART ========== */\r\n\r\n.chart-container {\r\n  position: relative;\r\n  height: 300px;\r\n  margin-bottom: 16px;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.chart-container canvas {\r\n  max-height: 100%;\r\n  max-width: 100%;\r\n}\r\n\r\n.chart-legend {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  gap: 16px;\r\n  justify-content: center;\r\n  padding-top: 12px;\r\n  border-top: 1px solid var(--myio-border-light, #F0F0F0);\r\n}\r\n\r\n.legend-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  font-size: 13px;\r\n}\r\n\r\n.legend-color {\r\n  width: 16px;\r\n  height: 16px;\r\n  border-radius: 4px;\r\n  flex-shrink: 0;\r\n  box-shadow: 0 2px 4px var(--myio-shadow, rgba(0, 0, 0, 0.05));\r\n}\r\n\r\n.legend-label {\r\n  color: var(--myio-text-secondary, #666666);\r\n}\r\n\r\n.legend-value {\r\n  font-weight: 600;\r\n  color: var(--myio-text, #222222);\r\n  font-variant-numeric: tabular-nums;\r\n}\r\n\r\n/* ========== SCROLLBARS ========== */\r\n\r\n.card-body::-webkit-scrollbar,\r\n.devices-list::-webkit-scrollbar {\r\n  width: 6px;\r\n}\r\n\r\n.card-body::-webkit-scrollbar-track,\r\n.devices-list::-webkit-scrollbar-track {\r\n  background: var(--myio-border-light, #F0F0F0);\r\n  border-radius: 3px;\r\n}\r\n\r\n.card-body::-webkit-scrollbar-thumb,\r\n.devices-list::-webkit-scrollbar-thumb {\r\n  background: var(--myio-border, #E0E0E0);\r\n  border-radius: 3px;\r\n}\r\n\r\n.card-body::-webkit-scrollbar-thumb:hover,\r\n.devices-list::-webkit-scrollbar-thumb:hover {\r\n  background: var(--myio-text-secondary, #666666);\r\n}\r\n\r\n/* ========== RESPONSIVE ========== */\r\n\r\n/* Mobile: 1 coluna */\r\n@media (max-width: 768px) {\r\n  /* Keep 2 columns, but make most cards full width; keep √É√Å√Årea Comum + Total side by side */\r\n  .info-grid {\r\n    grid-template-columns: repeat(2, 1fr);\r\n  }\r\n\r\n  /* Default: all cards span both columns (full width) */\r\n  .info-grid .info-card {\r\n    grid-column: 1 / -1;\r\n  }\r\n\r\n  /* Override: √É√Å√Årea Comum + Total stay on the same row (one per column) */\r\n  .info-grid .area-comum-card {\r\n    grid-column: 1;\r\n  }\r\n  .info-grid .total-card {\r\n    grid-column: 2;\r\n  }\r\n\r\n  /* Chart remains full width */\r\n  .info-grid .chart-card {\r\n    grid-column: 1 / -1;\r\n  }\r\n\r\n  .telemetry-info-root {\r\n    padding: 12px;\r\n  }\r\n\r\n  .info-grid {\r\n    gap: 12px;\r\n  }\r\n\r\n  .info-card {\r\n    padding: 12px;\r\n  }\r\n\r\n  .info-title {\r\n    font-size: 18px;\r\n  }\r\n\r\n  .card-title {\r\n    font-size: 14px;\r\n  }\r\n\r\n  .stat-row {\r\n    font-size: 13px;\r\n  }\r\n\r\n  .stat-row.main-stat {\r\n    font-size: 15px;\r\n  }\r\n\r\n  .chart-container {\r\n    height: 250px;\r\n  }\r\n\r\n  .chart-legend {\r\n    flex-direction: column;\r\n    align-items: flex-start;\r\n    gap: 8px;\r\n  }\r\n}\r\n\r\n/* Tablet: 2 colunas (mant√É¬©m) */\r\n@media (min-width: 769px) and (max-width: 1200px) {\r\n  .info-grid {\r\n    grid-template-columns: repeat(2, 1fr);\r\n  }\r\n}\r\n\r\n/* Desktop: 2 colunas (mant√É¬©m) */\r\n@media (min-width: 1201px) {\r\n  .info-grid {\r\n    grid-template-columns: repeat(2, 1fr);\r\n  }\r\n}\r\n\r\n/* ========== LOADING STATE ========== */\r\n\r\n.info-card.loading {\r\n  opacity: 0.6;\r\n  pointer-events: none;\r\n}\r\n\r\n.info-card.loading::after {\r\n  content: \"\";\r\n  position: absolute;\r\n  top: 50%;\r\n  left: 50%;\r\n  width: 24px;\r\n  height: 24px;\r\n  margin: -12px 0 0 -12px;\r\n  border: 3px solid var(--myio-border, #E0E0E0);\r\n  border-top-color: var(--myio-accent, #00C896);\r\n  border-radius: 50%;\r\n  animation: spin 0.8s linear infinite;\r\n}\r\n\r\n@keyframes spin {\r\n  to { transform: rotate(360deg); }\r\n}\r\n\r\n/* ========== EMPTY STATE ========== */\r\n\r\n.empty-state {\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 32px;\r\n  color: var(--myio-text-secondary, #666666);\r\n  text-align: center;\r\n  gap: 8px;\r\n}\r\n\r\n.empty-state-icon {\r\n  font-size: 48px;\r\n  opacity: 0.5;\r\n}\r\n\r\n.empty-state-text {\r\n  font-size: 14px;\r\n  color: var(--myio-text-secondary, #666666);\r\n}\r\n\r\n.empty-state-hint {\r\n  font-size: 12px;\r\n  color: var(--myio-text-tertiary, #999999);\r\n  margin-top: 4px;\r\n}\r\n\r\n/* ========== EXPAND BUTTON ========== */\r\n\r\n.info-header {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.btn-expand {\r\n  background: var(--myio-primary, #5B2EBC);\r\n  color: white;\r\n  border: none;\r\n  border-radius: 8px;\r\n  padding: 8px 12px;\r\n  cursor: pointer;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  transition: all 0.2s ease;\r\n  box-shadow: 0 2px 6px var(--myio-shadow, rgba(0, 0, 0, 0.05));\r\n}\r\n\r\n.btn-expand:hover {\r\n  background: var(--myio-accent, #00C896);\r\n  box-shadow: 0 4px 12px var(--myio-shadow-hover, rgba(0, 0, 0, 0.1));\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.btn-expand svg {\r\n  display: block;\r\n}\r\n\r\n/* ========== MODAL OVERLAY (PREMIUM CLEAN) ========== */\r\n\r\n/* Prevent body scroll when modal is open */\r\nbody.modal-open-telemetry-info {\r\n  overflow: hidden !important;\r\n}\r\n\r\n.modal-overlay {\r\n  position: fixed !important;\r\n  top: 0 !important;\r\n  left: 0 !important;\r\n  right: 0 !important;\r\n  bottom: 0 !important;\r\n  width: 100vw !important;\r\n  height: 100vh !important;\r\n  background: rgba(0, 0, 0, 0.75) !important;\r\n  z-index: 2147483647 !important;\r\n  display: flex !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  backdrop-filter: blur(8px) saturate(180%) !important;\r\n  animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n  padding: 3vh 3vw !important;\r\n  box-sizing: border-box !important;\r\n}\r\n\r\n@keyframes fadeIn {\r\n  from {\r\n    opacity: 0;\r\n    backdrop-filter: blur(0px) saturate(100%);\r\n  }\r\n  to {\r\n    opacity: 1;\r\n    backdrop-filter: blur(8px) saturate(180%);\r\n  }\r\n}\r\n\r\n/* ========== MODAL CONTAINER (PREMIUM CLEAN) ========== */\r\n\r\n.modal-container {\r\n  background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%) !important;\r\n  border-radius: 24px !important;\r\n  width: 100% !important;\r\n  height: 100% !important;\r\n  max-width: 1400px !important;\r\n  max-height: 900px !important;\r\n  display: flex !important;\r\n  flex-direction: column !important;\r\n  box-shadow:\r\n    0 50px 100px -20px rgba(50, 50, 93, 0.25),\r\n    0 30px 60px -30px rgba(0, 0, 0, 0.3),\r\n    inset 0 -2px 6px 0 rgba(10, 37, 64, 0.05) !important;\r\n  animation: modalAppear 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;\r\n  overflow: hidden !important;\r\n  position: relative !important;\r\n  border: 1px solid rgba(255, 255, 255, 0.8) !important;\r\n}\r\n\r\n@keyframes modalAppear {\r\n  from {\r\n    opacity: 0;\r\n    transform: scale(0.94) translateY(20px);\r\n  }\r\n  to {\r\n    opacity: 1;\r\n    transform: scale(1) translateY(0);\r\n  }\r\n}\r\n\r\n/* ========== CLOSE BUTTON (FLOATING) ========== */\r\n\r\n.btn-close-floating {\r\n  position: absolute;\r\n  top: 24px;\r\n  right: 24px;\r\n  background: rgba(255, 255, 255, 0.9);\r\n  backdrop-filter: blur(10px);\r\n  border: 1px solid rgba(91, 46, 188, 0.1);\r\n  width: 48px;\r\n  height: 48px;\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\r\n  color: var(--myio-primary, #5B2EBC);\r\n  z-index: 100;\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);\r\n}\r\n\r\n.btn-close-floating:hover {\r\n  background: var(--myio-primary, #5B2EBC);\r\n  color: white;\r\n  transform: rotate(90deg) scale(1.05);\r\n  box-shadow: 0 8px 24px rgba(91, 46, 188, 0.3);\r\n}\r\n\r\n.btn-close-floating:active {\r\n  transform: rotate(90deg) scale(0.95);\r\n}\r\n\r\n/* ========== MODAL BODY (CLEAN LAYOUT) ========== */\r\n\r\n.modal-body-clean {\r\n  flex: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 80px 60px 60px 60px;\r\n  overflow-y: auto;\r\n  overflow-x: hidden;\r\n  box-sizing: border-box;\r\n  width: 100%;\r\n}\r\n\r\n/* ========== MODAL TITLE (CLEAN) ========== */\r\n\r\n.modal-title-clean {\r\n  font-size: 32px;\r\n  font-weight: 700;\r\n  color: var(--myio-primary, #5B2EBC);\r\n  margin: 0 0 48px 0;\r\n  text-align: center;\r\n  letter-spacing: -0.03em;\r\n  line-height: 1.2;\r\n  background: linear-gradient(135deg, var(--myio-primary, #5B2EBC) 0%, #7B4ED9 100%);\r\n  -webkit-background-clip: text;\r\n  -webkit-text-fill-color: transparent;\r\n  background-clip: text;\r\n}\r\n\r\n/* ========== CHART INNER CONTAINER (WHITE BOX) ========== */\r\n\r\n.modal-chart-inner-container {\r\n  flex: 1 1 auto !important;\r\n  width: 100% !important;\r\n  max-width: 900px !important;\r\n  background: #FFFFFF !important;\r\n  border-radius: 20px !important;\r\n  padding: 48px !important;\r\n  margin: 0 auto 40px auto !important;\r\n  box-shadow:\r\n    0 10px 40px rgba(0, 0, 0, 0.08),\r\n    0 4px 12px rgba(91, 46, 188, 0.05),\r\n    inset 0 1px 0 rgba(255, 255, 255, 1) !important;\r\n  border: 1px solid rgba(91, 46, 188, 0.08) !important;\r\n  box-sizing: border-box !important;\r\n  display: flex !important;\r\n  flex-direction: column !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  position: relative !important;\r\n}\r\n\r\n.modal-chart-inner-container::before {\r\n  content: '';\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  right: 0;\r\n  height: 2px;\r\n  background: linear-gradient(90deg,\r\n    transparent 0%,\r\n    rgba(91, 46, 188, 0.1) 25%,\r\n    rgba(91, 46, 188, 0.2) 50%,\r\n    rgba(91, 46, 188, 0.1) 75%,\r\n    transparent 100%);\r\n  border-radius: 20px 20px 0 0;\r\n}\r\n\r\n/* ========== CHART WRAPPER (PREMIUM) ========== */\r\n\r\n.modal-chart-wrapper {\r\n  width: 100% !important;\r\n  max-width: 650px !important;\r\n  aspect-ratio: 1 !important;\r\n  position: relative !important;\r\n  display: flex !important;\r\n  align-items: center !important;\r\n  justify-content: center !important;\r\n  box-sizing: border-box !important;\r\n  margin: 0 auto !important;\r\n}\r\n\r\n.modal-chart-wrapper canvas {\r\n  max-height: 100% !important;\r\n  max-width: 100% !important;\r\n  width: 100% !important;\r\n  height: auto !important;\r\n  filter: drop-shadow(0 4px 20px rgba(91, 46, 188, 0.12)) !important;\r\n  display: block !important;\r\n  margin: 0 auto !important;\r\n  position: relative !important;\r\n  left: 0 !important;\r\n  right: 0 !important;\r\n}\r\n\r\n/* ========== LEGEND (CLEAN) ========== */\r\n\r\n.modal-legend-clean {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  gap: 32px;\r\n  justify-content: center;\r\n  align-items: center;\r\n  padding: 32px 40px;\r\n  background: rgba(255, 255, 255, 0.5);\r\n  backdrop-filter: blur(10px);\r\n  border-radius: 20px;\r\n  border: 1px solid rgba(91, 46, 188, 0.08);\r\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);\r\n  max-width: 900px;\r\n  width: 100%;\r\n  box-sizing: border-box;\r\n  margin: 0 auto;\r\n}\r\n\r\n.modal-legend-clean .legend-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n  font-size: 16px;\r\n  font-weight: 500;\r\n  transition: transform 0.2s ease;\r\n}\r\n\r\n.modal-legend-clean .legend-item:hover {\r\n  transform: translateY(-2px);\r\n}\r\n\r\n.modal-legend-clean .legend-color {\r\n  width: 24px;\r\n  height: 24px;\r\n  border-radius: 8px;\r\n  flex-shrink: 0;\r\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.modal-legend-clean .legend-item:hover .legend-color {\r\n  transform: scale(1.1);\r\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);\r\n}\r\n\r\n.modal-legend-clean .legend-label {\r\n  color: var(--myio-text, #222222);\r\n  font-weight: 500;\r\n}\r\n\r\n.modal-legend-clean .legend-value {\r\n  font-weight: 700;\r\n  color: var(--myio-primary, #5B2EBC);\r\n  font-variant-numeric: tabular-nums;\r\n  margin-left: 4px;\r\n}\r\n\r\n/* ========== MODAL RESPONSIVE ========== */\r\n\r\n@media (max-width: 1200px) {\r\n  .modal-body-clean {\r\n    padding: 60px 40px 40px 40px;\r\n  }\r\n\r\n  .modal-title-clean {\r\n    font-size: 28px;\r\n    margin-bottom: 32px;\r\n  }\r\n\r\n  .modal-chart-inner-container {\r\n    max-width: 700px;\r\n    padding: 36px;\r\n    margin-bottom: 32px;\r\n  }\r\n\r\n  .modal-chart-wrapper {\r\n    max-width: 500px;\r\n  }\r\n\r\n  .modal-legend-clean {\r\n    gap: 24px;\r\n    padding: 24px 32px;\r\n  }\r\n}\r\n\r\n@media (max-width: 768px) {\r\n  .modal-overlay {\r\n    padding: 2vh 2vw !important;\r\n  }\r\n\r\n  .modal-container {\r\n    border-radius: 16px !important;\r\n  }\r\n\r\n  .btn-close-floating {\r\n    top: 16px;\r\n    right: 16px;\r\n    width: 40px;\r\n    height: 40px;\r\n  }\r\n\r\n  .modal-body-clean {\r\n    padding: 40px 24px 24px 24px;\r\n  }\r\n\r\n  .modal-title-clean {\r\n    font-size: 24px;\r\n    margin-bottom: 24px;\r\n  }\r\n\r\n  .modal-chart-inner-container {\r\n    max-width: 100%;\r\n    padding: 24px;\r\n    margin-bottom: 24px;\r\n  }\r\n\r\n  .modal-chart-wrapper {\r\n    max-width: 100%;\r\n  }\r\n\r\n  .modal-legend-clean {\r\n    gap: 16px;\r\n    padding: 20px 24px;\r\n    flex-direction: column;\r\n  }\r\n\r\n  .modal-legend-clean .legend-item {\r\n    width: 100%;\r\n    justify-content: space-between;\r\n  }\r\n}\r\n\r\n/* ========== OVERRIDES: Pairing and font reduction ========== */\r\n\r\n/* Maintain 2-column pairs on all widths; chart remains full width */\r\n@media (max-width: 768px) {\r\n  .info-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 12px !important; }\r\n  .info-grid .info-card { grid-column: auto !important; }\r\n  .info-grid > .chart-card { grid-column: 1 / -1 !important; }\r\n}\r\n\r\n/* Ensure chart spans both columns on all widths */\r\n.info-grid > .chart-card { grid-column: 1 / -1 !important; }\r\n\r\n/* RFC-0105: Compact 2-line card layout overrides */\r\n/* Card structure - ONLY 2 lines: [icon+name...info] and [value...%] */\r\n/* Note: domain-specific cards excluded - controlled via JS for domain switching */\r\n.info-card:not(.chart-card):not(.banheiros-card):not(.climatizacao-card):not(.elevadores-card):not(.escadas-card):not(.outros-card) {\r\n  padding: 6px 10px !important;\r\n  min-height: auto !important;\r\n  max-height: 50px !important;\r\n  overflow: hidden !important;\r\n  display: flex !important;\r\n  flex-direction: column !important;\r\n  justify-content: center !important;\r\n}\r\n\r\n/* Domain-switchable cards - same styling but respects display:none from JS */\r\n/* banheiros = water only, climatizacao/elevadores/escadas/outros = energy only */\r\n.info-card.banheiros-card,\r\n.info-card.climatizacao-card,\r\n.info-card.elevadores-card,\r\n.info-card.escadas-card,\r\n.info-card.outros-card {\r\n  padding: 6px 10px !important;\r\n  min-height: auto !important;\r\n  max-height: 50px !important;\r\n  overflow: hidden !important;\r\n  flex-direction: column !important;\r\n  justify-content: center !important;\r\n}\r\n\r\n/* Line 1: Header - [Icon][Title]...[‚ÑπÔ∏è] */\r\n.info-card:not(.chart-card) .card-header {\r\n  display: flex !important;\r\n  flex-direction: row !important;\r\n  align-items: center !important;\r\n  margin: 0 !important;\r\n  padding: 0 !important;\r\n  gap: 4px !important;\r\n  border: none !important;\r\n  flex-shrink: 0 !important;\r\n  height: 18px !important;\r\n  line-height: 18px !important;\r\n}\r\n\r\n/* Line 2: Body - [Value]...[%] */\r\n.info-card:not(.chart-card) .card-body {\r\n  display: block !important;\r\n  margin: 0 !important;\r\n  padding: 0 !important;\r\n  flex-shrink: 0 !important;\r\n  height: 20px !important;\r\n  line-height: 20px !important;\r\n}\r\n\r\n.info-card:not(.chart-card) .stat-row.main-stat {\r\n  display: flex !important;\r\n  flex-direction: row !important;\r\n  align-items: center !important;\r\n  justify-content: space-between !important;\r\n  margin: 0 !important;\r\n  padding: 0 !important;\r\n  height: 20px !important;\r\n  line-height: 20px !important;\r\n}\r\n\r\n/* Hide all other elements */\r\n.info-card:not(.chart-card) .devices-list,\r\n.info-card:not(.chart-card) .stat-row:not(.main-stat),\r\n.info-card:not(.chart-card) .residual-note {\r\n  display: none !important;\r\n}\r\n\r\n/* Font sizes - compact */\r\n.info-title { font-size: 13px !important; }\r\n.info-card:not(.chart-card) .card-title {\r\n  font-size: 11px !important;\r\n  margin: 0 !important;\r\n  padding: 0 !important;\r\n  line-height: 18px !important;\r\n  white-space: nowrap !important;\r\n  overflow: hidden !important;\r\n  text-overflow: ellipsis !important;\r\n  flex: 1 !important;\r\n}\r\n.info-card:not(.chart-card) .card-icon {\r\n  font-size: 13px !important;\r\n  line-height: 18px !important;\r\n  flex-shrink: 0 !important;\r\n}\r\n.info-card:not(.chart-card) .info-tooltip {\r\n  font-size: 10px !important;\r\n  line-height: 18px !important;\r\n  flex-shrink: 0 !important;\r\n  margin-left: auto !important;\r\n}\r\n.info-card:not(.chart-card) .stat-value {\r\n  font-size: 13px !important;\r\n  font-weight: 600 !important;\r\n  line-height: 20px !important;\r\n}\r\n.info-card:not(.chart-card) .stat-perc {\r\n  font-size: 10px !important;\r\n  line-height: 20px !important;\r\n}\r\n\r\n/* Empty states */\r\n.empty-state-icon { font-size: 32px !important; }\r\n.empty-state-text { font-size: 10px !important; }\r\n.empty-state-hint, .empty-state-hint small { font-size: 9px !important; }\r\n\r\n/* Chart legend - main widget */\r\n.legend-item { font-size: 9px !important; }\r\n.legend-label { font-size: 9px !important; }\r\n.legend-value { font-size: 9px !important; }\r\n",
      "controllerScript": "/* global self, window, document, sessionStorage, Chart */\r\n\r\n/* =========================================================================\r\n * ThingsBoard Widget: TELEMETRY_INFO (MyIO v-5.2.0)\r\n * RFC-0056: 6 Categories + Light Mode + Grid 2 Columns\r\n * - Consolida informa√É¬ß√É¬µes de entrada e consumidores\r\n * - Gr√É¬°fico de pizza com distribui√É¬ß√É¬£o de consumo (5 categorias)\r\n * - Integrado com MyIO Orchestrator (RFC-0042)\r\n * - √É¬Årea Comum calculado como residual\r\n *\r\n * Autor: MyIO Team\r\n * Data: 2025-01-24\r\n * Vers√É¬£o: 2.0.0 (RFC-0056)\r\n * =========================================================================*/\r\n\r\n// ===================== CONFIGURATION =====================\r\n\r\n// RFC-0091: Use shared LogHelper from MAIN widget via window.MyIOUtils\r\nconst LogHelper = window.MyIOUtils?.LogHelper || {\r\n  log: (...args) => console.log('[TELEMETRY_INFO]', ...args),\r\n  warn: (...args) => console.warn('[TELEMETRY_INFO]', ...args),\r\n  error: (...args) => console.error('[TELEMETRY_INFO]', ...args),\r\n};\r\n\r\n// Widget configuration\r\n// NOTE: WIDGET_DOMAIN variable was removed - always use getWidgetDomain() function\r\nlet SHOW_DEVICES_LIST = false;\r\n\r\n/**\r\n * Get widget domain from settings.\r\n * @returns {string} The configured domain or empty string\r\n */\r\nfunction getWidgetDomain() {\r\n  return self.ctx.settings?.DOMAIN || '';\r\n}\r\n\r\n// RFC-0056: Chart colors with MyIO palette (6 categories)\r\nlet CHART_COLORS = {\r\n  climatizacao: '#00C896', // Teal (MyIO accent)\r\n  elevadores: '#5B2EBC', // Purple (MyIO primary)\r\n  escadasRolantes: '#FF6B6B', // Red\r\n  lojas: '#FFC107', // Yellow\r\n  outros: '#9C27B0', // Deep Purple\r\n  areaComum: '#4CAF50', // Green (residual)\r\n};\r\n\r\n// RFC-0002: Domain labels for multi-domain support (energy, water, gas)\r\nconst DOMAIN_LABELS = {\r\n  energy: {\r\n    title: 'Energia',\r\n    unit: 'kWh',\r\n    icon: '‚ÑπÔ∏è',\r\n  },\r\n  water: {\r\n    title: '√Ågua 111',\r\n    unit: 'm¬≥',\r\n    icon: 'üíß',\r\n  },\r\n  gas: {\r\n    title: 'G√°s',\r\n    unit: 'm¬≥',\r\n    icon: 'üî•',\r\n  },\r\n};\r\n\r\n/**\r\n * RFC-0002: Get domain label configuration\r\n * @param {string} domain - Domain identifier ('energy', 'water', 'gas')\r\n * @returns {Object} Domain configuration with title, unit, and icon\r\n */\r\nfunction getDomainLabel(domain = 'energy') {\r\n  // Always fallback to 'energy' if domain is invalid or undefined\r\n  return DOMAIN_LABELS[domain] || DOMAIN_LABELS.energy;\r\n}\r\n\r\n/**\r\n * RFC-0105: Aggregate device status from MyIOOrchestratorData\r\n * This function runs in the widget context where orchestrator data is accessible.\r\n * Returns both counts AND device lists for the summary tooltip.\r\n *\r\n * @param {string} domain - Domain ('energy' or 'water')\r\n * @returns {Object} Status aggregation with counts and device lists\r\n */\r\nfunction aggregateDeviceStatusFromOrchestrator(domain) {\r\n  const result = {\r\n    hasData: false,\r\n    normal: 0,\r\n    alert: 0,\r\n    failure: 0,\r\n    standby: 0,\r\n    offline: 0,\r\n    noConsumption: 0,\r\n    normalDevices: [],\r\n    alertDevices: [],\r\n    failureDevices: [],\r\n    standbyDevices: [],\r\n    offlineDevices: [],\r\n    noConsumptionDevices: [],\r\n  };\r\n\r\n  // RFC-0105: Use items stored from processOrchestratorData (primary source)\r\n  // Falls back to window.MyIOOrchestratorData if available\r\n  let items = RECEIVED_ORCHESTRATOR_ITEMS;\r\n\r\n  if (!items || items.length === 0) {\r\n    // Fallback: try window.MyIOOrchestratorData\r\n    const orchestratorData = window.MyIOOrchestratorData || window.parent?.MyIOOrchestratorData;\r\n    if (orchestratorData && orchestratorData[domain]) {\r\n      items = orchestratorData[domain].items || [];\r\n    }\r\n  }\r\n\r\n  if (!items || items.length === 0) {\r\n    LogHelper.log('[RFC-0105] No items available for device status aggregation');\r\n    return result;\r\n  }\r\n\r\n  result.hasData = true;\r\n  LogHelper.log(`[RFC-0105] Aggregating device status from ${items.length} items`);\r\n\r\n  // Threshold for \"no consumption\" - devices with value below this are considered zero\r\n  const NO_CONSUMPTION_THRESHOLD = domain === 'water' ? 0.001 : 0.01; // m¬≥ for water, kWh for energy\r\n\r\n  // Map deviceStatus values to our status categories\r\n  const statusMapping = {\r\n    'power_on': 'normal',\r\n    'warning': 'alert',\r\n    'failure': 'failure',\r\n    'standby': 'standby',\r\n    'power_off': 'offline',\r\n    'maintenance': 'offline',\r\n    'no_info': 'offline',\r\n    'not_installed': 'offline',\r\n    'offline': 'offline',\r\n  };\r\n\r\n  items.forEach((item) => {\r\n    const deviceInfo = {\r\n      id: item.id || item.deviceId || '',\r\n      label: item.label || item.entityLabel || item.name || item.deviceIdentifier || '',\r\n      name: item.name || item.entityLabel || '',\r\n    };\r\n\r\n    const deviceStatus = item.deviceStatus || 'no_info';\r\n    const value = Number(item.value || item.val || 0);\r\n\r\n    // Check for \"no consumption\" first (value is 0 or very close to 0)\r\n    // Only applies to online devices (not offline/no_info)\r\n    const isOnline = !['no_info', 'offline', 'not_installed', 'maintenance', 'power_off'].includes(deviceStatus);\r\n\r\n    if (isOnline && Math.abs(value) < NO_CONSUMPTION_THRESHOLD) {\r\n      result.noConsumption++;\r\n      result.noConsumptionDevices.push(deviceInfo);\r\n      return;\r\n    }\r\n\r\n    // Map deviceStatus to our categories\r\n    const mappedStatus = statusMapping[deviceStatus] || 'offline';\r\n\r\n    // Increment count and add to device list\r\n    result[mappedStatus]++;\r\n    result[mappedStatus + 'Devices'].push(deviceInfo);\r\n  });\r\n\r\n  LogHelper.log(`[RFC-0105] Device status aggregation complete: ${items.length} items processed`);\r\n  return result;\r\n}\r\n\r\n/**\r\n * RFC-0002: Format value based on domain\r\n * @param {number} value - Numeric value\r\n * @param {string} domain - Domain ('energy' or 'water')\r\n * @returns {string} Formatted string with unit\r\n */\r\nfunction formatValue(value, domain = 'energy') {\r\n  if (domain === 'water') {\r\n    // Format as m¬≥ with 2 decimals\r\n    return value.toFixed(2).replace('.', ',') + ' m¬≥';\r\n  }\r\n  // Default: energy (kWh)\r\n  return formatEnergy(value);\r\n}\r\n\r\n// ===================== STATE =====================\r\n\r\nconst STATE = {\r\n  entrada: {\r\n    devices: [],\r\n    total: 0,\r\n    perc: 100,\r\n  },\r\n  consumidores: {\r\n    climatizacao: { devices: [], total: 0, perc: 0 },\r\n    elevadores: { devices: [], total: 0, perc: 0 },\r\n    escadasRolantes: { devices: [], total: 0, perc: 0 },\r\n    lojas: { devices: [], total: 0, perc: 0 },\r\n    outros: { devices: [], total: 0, perc: 0 }, // √¢‚Ä†¬ê RFC-0056: Outros equipamentos de AreaComum\r\n    areaComum: { devices: [], total: 0, perc: 0 }, // √¢‚Ä†¬ê Residual\r\n    totalGeral: 0,\r\n    percGeral: 100,\r\n  },\r\n  grandTotal: 0,\r\n};\r\n\r\n// Chart instance\r\nlet pieChartInstance = null;\r\n\r\n// RFC-0002: STATE for water domain (5 contexts with banheiros extracted from areaComum)\r\nconst STATE_WATER = {\r\n  domain: 'water',\r\n  entrada: {\r\n    context: 'entrada',\r\n    devices: [],\r\n    total: 0,\r\n    perc: 100,\r\n    source: 'widget-telemetry-entrada',\r\n  },\r\n  lojas: {\r\n    context: 'lojas',\r\n    devices: [],\r\n    total: 0,\r\n    perc: 0,\r\n    source: 'widget-telemetry-lojas',\r\n  },\r\n  banheiros: {\r\n    context: 'banheiros',\r\n    devices: [],\r\n    total: 0,\r\n    perc: 0,\r\n    source: 'widget-telemetry-area-comum (banheiros breakdown)', // Extracted from areaComum by label/identifier\r\n  },\r\n  areaComum: {\r\n    context: 'areaComum',\r\n    devices: [],\r\n    total: 0,\r\n    perc: 0,\r\n    source: 'widget-telemetry-area-comum (outros)',\r\n  },\r\n  pontosNaoMapeados: {\r\n    context: 'pontosNaoMapeados',\r\n    devices: [],\r\n    total: 0,\r\n    perc: 0,\r\n    isCalculated: true,\r\n    hasInconsistency: false,\r\n  },\r\n  grandTotal: 0,\r\n  periodKey: null,\r\n  lastUpdate: null,\r\n  includeBathrooms: false, // Setting from widget config\r\n};\r\n\r\n// Event handlers\r\nlet dateUpdateHandler = null;\r\nlet dataProvideHandler = null;\r\nlet waterProvideHandler = null; // RFC-0002: Handler for water events\r\nlet clearCacheHandler = null;\r\nlet lastProcessedPeriodKey = null;\r\n\r\n// RFC-0105: Store received orchestrator items for device status aggregation\r\nlet RECEIVED_ORCHESTRATOR_ITEMS = [];\r\n\r\n// ===================== CATEGORIES (RFC-0056) =====================\r\n\r\nconst CATEGORIES = {\r\n  ENTRADA: 'entrada',\r\n  CLIMATIZACAO: 'climatizacao',\r\n  ELEVADORES: 'elevadores',\r\n  ESCADAS_ROLANTES: 'escadas_rolantes',\r\n  LOJAS: 'lojas',\r\n  AREA_COMUM: 'area_comum', // √¢‚Ä†¬ê Residual (calculado)\r\n};\r\n\r\n// ===================== DOM HELPERS =====================\r\n\r\n// Preserve global jQuery and avoid shadowing `$`\r\nconst $J = window.jQuery || window.$;\r\n// Root jQuery object for this widget container\r\nconst $root = () => $J(self.ctx.$container);\r\n// Find elements within this widget container\r\nconst $$ = (selector) => $root().find(selector);\r\n\r\n// ===================== CLASSIFICATION LOGIC (RFC-0056) =====================\r\n\r\n/**\r\n * Normalize label (remove accents, lowercase, trim)\r\n */\r\nfunction normalizeLabel(str = '') {\r\n  return String(str)\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .toLowerCase()\r\n    .trim();\r\n}\r\n\r\n/**\r\n * RFC-0056: Classify device into 6 categories\r\n * @param {string} labelOrName - Device label or name\r\n * @param {string} datasourceAlias - Optional: ThingsBoard datasource alias\r\n * @returns {'entrada'|'climatizacao'|'elevadores'|'escadas_rolantes'|'lojas'|'area_comum'}\r\n */\r\nfunction classifyDevice(labelOrName = '', datasourceAlias = '') {\r\n  const s = normalizeLabel(labelOrName);\r\n\r\n  // ========== 1. ENTRADA ==========\r\n  // RFC-0098: Entrada is now handled via events (entrada_total) from TELEMETRY widget\r\n  // This classification is DEPRECATED - kept only for backwards compatibility\r\n  // The TELEMETRY widget detects entrada via alias and emits entrada_total event\r\n  if (/\\brelogio\\b/.test(s)) return CATEGORIES.ENTRADA;\r\n  if (/subesta/.test(s)) return CATEGORIES.ENTRADA;\r\n  if (/\\bentrada\\b/.test(s)) return CATEGORIES.ENTRADA;\r\n  if (/medicao/.test(s)) return CATEGORIES.ENTRADA;\r\n  if (/medidor principal/.test(s)) return CATEGORIES.ENTRADA;\r\n  if (/geracao/.test(s)) return CATEGORIES.ENTRADA;\r\n\r\n  // ========== 2. CLIMATIZA√É‚Ä°√É∆íO ==========\r\n  // RFC-0098: Climatiza√ß√£o classification now handled by TELEMETRY via deviceType\r\n  // This label-based classification is DEPRECATED\r\n  if (/chiller/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/\\bbomba\\b/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/bomba primaria/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/bomba secundaria/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/ar condicionado/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/climatizacao/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/hvac/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n  if (/casa de maquinas/.test(s)) return CATEGORIES.CLIMATIZACAO;\r\n\r\n  // ========== 3. ELEVADORES ==========\r\n  if (/elevador/.test(s)) return CATEGORIES.ELEVADORES;\r\n  if (/lift/.test(s)) return CATEGORIES.ELEVADORES; // EN\r\n\r\n  // ========== 4. ESCADAS ROLANTES ==========\r\n  if (/escada rolante/.test(s)) return CATEGORIES.ESCADAS_ROLANTES;\r\n  if (/esc\\. rolante/.test(s)) return CATEGORIES.ESCADAS_ROLANTES;\r\n  if (/esc rolante/.test(s)) return CATEGORIES.ESCADAS_ROLANTES;\r\n  if (/escalator/.test(s)) return CATEGORIES.ESCADAS_ROLANTES; // EN\r\n\r\n  // ========== 5. LOJAS ==========\r\n  // Check datasource alias first (more reliable)\r\n  if (datasourceAlias && /lojas/i.test(datasourceAlias)) {\r\n    return CATEGORIES.LOJAS;\r\n  }\r\n  // Fallback to label matching (DEPRECATED - lojas_total event preferred)\r\n  if (/\\bloja\\b/.test(s)) return CATEGORIES.LOJAS;\r\n  if (/\\bstore\\b/.test(s)) return CATEGORIES.LOJAS; // EN\r\n  if (/varejo/.test(s)) return CATEGORIES.LOJAS;\r\n\r\n  // ========== 6. √É¬ÅREA COMUM (Residual) ==========\r\n  // Nota: √É¬Årea Comum N√É∆íO √É¬© classificado aqui, √É¬© CALCULADO como residual!\r\n  // Apenas itens explicitamente rotulados como \"√É¬°rea comum\" v√É¬£o aqui\r\n  if (/area comum/.test(s)) return CATEGORIES.AREA_COMUM;\r\n  if (/iluminacao/.test(s)) return CATEGORIES.AREA_COMUM;\r\n  if (/corredor/.test(s)) return CATEGORIES.AREA_COMUM;\r\n  if (/hall/.test(s)) return CATEGORIES.AREA_COMUM;\r\n  if (/estacionamento/.test(s)) return CATEGORIES.AREA_COMUM;\r\n\r\n  // ========== DEFAULT ==========\r\n  // Items n√É¬£o classificados v√É¬£o para LOJAS (comportamento padr√É¬£o)\r\n  return CATEGORIES.LOJAS;\r\n}\r\n\r\n// ===================== DATA PROCESSING (RFC-0056) =====================\r\n\r\n/**\r\n * RFC-0056: Aggregate telemetry data with residual calculation for √É¬Årea Comum\r\n *\r\n * Formula:\r\n *   √É¬Årea Comum = Entrada - (Climatiza√É¬ß√É¬£o + Elevadores + Esc.Rolantes + Lojas)\r\n */\r\nfunction aggregateData(items) {\r\n  LogHelper.log('RFC-0056: Aggregating data with 6 categories:', items.length, 'items');\r\n\r\n  // ========== 1. CLASSIFY DEVICES ==========\r\n  const entrada = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.ENTRADA;\r\n  });\r\n\r\n  const climatizacao = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.CLIMATIZACAO;\r\n  });\r\n\r\n  const elevadores = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.ELEVADORES;\r\n  });\r\n\r\n  const escadasRolantes = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.ESCADAS_ROLANTES;\r\n  });\r\n\r\n  const lojas = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.LOJAS;\r\n  });\r\n\r\n  const areaComumExplicit = items.filter((i) => {\r\n    const cat = classifyDevice(i.label, i.datasourceAlias);\r\n    return cat === CATEGORIES.AREA_COMUM;\r\n  });\r\n\r\n  LogHelper.log('RFC-0056: Classification breakdown:', {\r\n    entrada: entrada.length,\r\n    climatizacao: climatizacao.length,\r\n    elevadores: elevadores.length,\r\n    escadasRolantes: escadasRolantes.length,\r\n    lojas: lojas.length,\r\n    areaComumExplicit: areaComumExplicit.length,\r\n  });\r\n\r\n  // ========== 2. CALCULATE TOTALS ==========\r\n  const entradaTotal = entrada.reduce((sum, i) => sum + (i.value || 0), 0);\r\n  const climatizacaoTotal = climatizacao.reduce((sum, i) => sum + (i.value || 0), 0);\r\n  const elevadoresTotal = elevadores.reduce((sum, i) => sum + (i.value || 0), 0);\r\n  const escadasRolantesTotal = escadasRolantes.reduce((sum, i) => sum + (i.value || 0), 0);\r\n  const lojasTotal = lojas.reduce((sum, i) => sum + (i.value || 0), 0);\r\n  const areaComumExplicitTotal = areaComumExplicit.reduce((sum, i) => sum + (i.value || 0), 0);\r\n\r\n  // ========== 3. RESIDUAL CALCULATION ==========\r\n  // √É¬Årea Comum = Entrada - (Todos os outros consumidores)\r\n  // Inclui tamb√É¬©m devices explicitamente rotulados como \"√É¬Årea Comum\"\r\n  const areaComumResidual =\r\n    entradaTotal - (climatizacaoTotal + elevadoresTotal + escadasRolantesTotal + lojasTotal);\r\n  const areaComumTotal = Math.max(0, areaComumResidual + areaComumExplicitTotal); // √¢‚Ä†¬ê Nunca negativo\r\n\r\n  // Total de consumidores = Entrada (sempre 100%)\r\n  const consumidoresTotal =\r\n    climatizacaoTotal + elevadoresTotal + escadasRolantesTotal + lojasTotal + areaComumTotal;\r\n  const grandTotal = entradaTotal; // Entrada = refer√É¬™ncia 100%\r\n\r\n  LogHelper.log('RFC-0056: Totals calculated:', {\r\n    entradaTotal: entradaTotal.toFixed(2),\r\n    climatizacaoTotal: climatizacaoTotal.toFixed(2),\r\n    elevadoresTotal: elevadoresTotal.toFixed(2),\r\n    escadasRolantesTotal: escadasRolantesTotal.toFixed(2),\r\n    lojasTotal: lojasTotal.toFixed(2),\r\n    areaComumResidual: areaComumResidual.toFixed(2),\r\n    areaComumExplicitTotal: areaComumExplicitTotal.toFixed(2),\r\n    areaComumTotal: areaComumTotal.toFixed(2),\r\n    consumidoresTotal: consumidoresTotal.toFixed(2),\r\n  });\r\n\r\n  // ========== 4. CALCULATE PERCENTAGES ==========\r\n  // RFC-0098: If we have entrada data from event (handleEntradaTotal), use it instead of label-classified data\r\n  // This prevents the old label-based classification from overwriting event-based data\r\n  if (RECEIVED_DATA.entrada_total !== null) {\r\n    // Keep existing STATE.entrada from handleEntradaTotal - don't overwrite!\r\n    LogHelper.log(\r\n      '[RFC-0098] Preserving entrada data from event (not overwriting with label-classified data)'\r\n    );\r\n  } else {\r\n    // Fallback to label-classified data (DEPRECATED)\r\n    STATE.entrada = {\r\n      devices: entrada,\r\n      total: entradaTotal,\r\n      perc: 100, // Entrada sempre 100%\r\n    };\r\n  }\r\n\r\n  // Use entrada total from event if available, otherwise use label-classified\r\n  const effectiveEntradaTotal = RECEIVED_DATA.entrada_total?.total_kWh ?? STATE.entrada.total;\r\n  const grandTotalEffective = effectiveEntradaTotal > 0 ? effectiveEntradaTotal : grandTotal;\r\n\r\n  STATE.consumidores = {\r\n    climatizacao: {\r\n      devices: climatizacao,\r\n      total: climatizacaoTotal,\r\n      perc: grandTotalEffective > 0 ? (climatizacaoTotal / grandTotalEffective) * 100 : 0,\r\n    },\r\n    elevadores: {\r\n      devices: elevadores,\r\n      total: elevadoresTotal,\r\n      perc: grandTotalEffective > 0 ? (elevadoresTotal / grandTotalEffective) * 100 : 0,\r\n    },\r\n    escadasRolantes: {\r\n      devices: escadasRolantes,\r\n      total: escadasRolantesTotal,\r\n      perc: grandTotalEffective > 0 ? (escadasRolantesTotal / grandTotalEffective) * 100 : 0,\r\n    },\r\n    lojas: {\r\n      devices: lojas,\r\n      total: lojasTotal,\r\n      perc: grandTotalEffective > 0 ? (lojasTotal / grandTotalEffective) * 100 : 0,\r\n    },\r\n    areaComum: {\r\n      devices: areaComumExplicit, // √¢‚Ä†¬ê Apenas devices expl√É¬≠citos (residual n√É¬£o tem devices)\r\n      total: areaComumTotal,\r\n      perc: grandTotalEffective > 0 ? (areaComumTotal / grandTotalEffective) * 100 : 0,\r\n    },\r\n    totalGeral: consumidoresTotal,\r\n    percGeral: 100, // √¢‚Ä†¬ê Total sempre 100% (= entrada)\r\n  };\r\n\r\n  STATE.grandTotal = grandTotalEffective;\r\n\r\n  LogHelper.log('RFC-0056: Percentages calculated:', {\r\n    climatizacao: STATE.consumidores.climatizacao.perc.toFixed(1) + '%',\r\n    elevadores: STATE.consumidores.elevadores.perc.toFixed(1) + '%',\r\n    escadasRolantes: STATE.consumidores.escadasRolantes.perc.toFixed(1) + '%',\r\n    lojas: STATE.consumidores.lojas.perc.toFixed(1) + '%',\r\n    areaComum: STATE.consumidores.areaComum.perc.toFixed(1) + '%',\r\n  });\r\n\r\n  // ========== 5. VALIDATE TOTALS ==========\r\n  validateTotals();\r\n}\r\n\r\n/**\r\n * RFC-0056: Validate that sum of consumers equals entrada total\r\n * Logs warning if mismatch > 10 Wh (0.01 kWh)\r\n */\r\nfunction validateTotals() {\r\n  const sum =\r\n    STATE.consumidores.climatizacao.total +\r\n    STATE.consumidores.elevadores.total +\r\n    STATE.consumidores.escadasRolantes.total +\r\n    STATE.consumidores.lojas.total +\r\n    STATE.consumidores.areaComum.total;\r\n\r\n  const entrada = STATE.entrada.total;\r\n  const diff = Math.abs(entrada - sum);\r\n  const tolerance = 0.01; // 10 Wh\r\n\r\n  if (diff > tolerance) {\r\n    LogHelper.warn('[WARNING] RFC-0056: Total validation FAILED!');\r\n    LogHelper.warn('  Entrada:  ', entrada.toFixed(2), 'kWh');\r\n    LogHelper.warn('  Sum:      ', sum.toFixed(2), 'kWh');\r\n    LogHelper.warn('  Diff:     ', diff.toFixed(2), 'kWh');\r\n    LogHelper.warn('  Breakdown:', {\r\n      climatizacao: STATE.consumidores.climatizacao.total.toFixed(2),\r\n      elevadores: STATE.consumidores.elevadores.total.toFixed(2),\r\n      escadasRolantes: STATE.consumidores.escadasRolantes.total.toFixed(2),\r\n      lojas: STATE.consumidores.lojas.total.toFixed(2),\r\n      areaComum: STATE.consumidores.areaComum.total.toFixed(2),\r\n    });\r\n  } else {\r\n    LogHelper.log('√¢≈ì‚Ä¶ RFC-0056: Totals validated successfully');\r\n    LogHelper.log('  Entrada = Sum =', entrada.toFixed(2), 'kWh (Diff:', diff.toFixed(4), 'kWh)');\r\n  }\r\n}\r\n\r\n// ===================== RENDERING (RFC-0056) =====================\r\n\r\n/**\r\n * Format energy value (kWh)\r\n */\r\nfunction formatEnergy(value) {\r\n  if (typeof value !== 'number' || isNaN(value)) return '0,00 kWh';\r\n\r\n  // Use MyIOLibrary if available, otherwise fallback\r\n  if (window.MyIOLibrary && typeof window.MyIOLibrary.formatEnergy === 'function') {\r\n    return window.MyIOLibrary.formatEnergy(value);\r\n  }\r\n\r\n  // Fallback formatting\r\n  return (\r\n    value.toLocaleString('pt-BR', {\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2,\r\n    }) + ' kWh'\r\n  );\r\n}\r\n\r\n/**\r\n * RFC-0056: Render statistics for 6 categories\r\n */\r\nfunction renderStats() {\r\n  LogHelper.log('RFC-0056: Rendering stats for 6 categories...');\r\n\r\n  // Hide water-only cards (banheiros is water domain specific)\r\n  $$('.banheiros-card').hide();\r\n  LogHelper.log('[RFC-0056] Hiding banheiros-card (energy domain)');\r\n\r\n  // ========== ENTRADA ==========\r\n  $$('#entradaTotal').text(formatEnergy(STATE.entrada.total));\r\n\r\n  // ========== CONSUMIDORES ==========\r\n\r\n  // Climatiza√É¬ß√É¬£o\r\n  $$('#climatizacaoTotal').text(formatEnergy(STATE.consumidores.climatizacao.total));\r\n  $$('#climatizacaoPerc').text(`(${STATE.consumidores.climatizacao.perc.toFixed(1)}%)`);\r\n\r\n  // Elevadores\r\n  $$('#elevadoresTotal').text(formatEnergy(STATE.consumidores.elevadores.total));\r\n  $$('#elevadoresPerc').text(`(${STATE.consumidores.elevadores.perc.toFixed(1)}%)`);\r\n\r\n  // Escadas Rolantes\r\n  $$('#escadasRolantesTotal').text(formatEnergy(STATE.consumidores.escadasRolantes.total));\r\n  $$('#escadasRolantesPerc').text(`(${STATE.consumidores.escadasRolantes.perc.toFixed(1)}%)`);\r\n\r\n  // Lojas\r\n  $$('#lojasTotal').text(formatEnergy(STATE.consumidores.lojas.total));\r\n  $$('#lojasPerc').text(`(${STATE.consumidores.lojas.perc.toFixed(1)}%)`);\r\n\r\n  // Outros Equipamentos (RFC-0056: Defensiva para compatibilidade)\r\n  if (STATE.consumidores.outros) {\r\n    $$('#outrosTotal').text(formatEnergy(STATE.consumidores.outros.total));\r\n    $$('#outrosPerc').text(`(${STATE.consumidores.outros.perc.toFixed(1)}%)`);\r\n  } else {\r\n    $$('#outrosTotal').text('0,00 kWh');\r\n    $$('#outrosPerc').text('(0%)');\r\n  }\r\n\r\n  // √É¬Årea Comum (residual)\r\n  $$('#areaComumTotal').text(formatEnergy(STATE.consumidores.areaComum.total));\r\n  $$('#areaComumPerc').text(`(${STATE.consumidores.areaComum.perc.toFixed(1)}%)`);\r\n\r\n  // RFC-0056: Hide √Årea Comum card when water domain has bathrooms enabled\r\n  // Consolidate √°rea comum into \"Pontos n√£o mapeados\" instead\r\n  if (getWidgetDomain() === 'water' && STATE_WATER.includeBathrooms) {\r\n    $$('.area-comum-card').hide();\r\n  } else {\r\n    $$('.area-comum-card').show();\r\n  }\r\n\r\n  // ========== TOTAL ==========\r\n  $$('#consumidoresTotal').text(formatEnergy(STATE.consumidores.totalGeral));\r\n  $$('#consumidoresPerc').text('(100%)');\r\n\r\n  // ========== DEVICES LIST (opcional) ==========\r\n  if (SHOW_DEVICES_LIST) {\r\n    const $list = $$('#entradaDevices').empty();\r\n    STATE.entrada.devices.forEach((device) => {\r\n      $list.append(`<div class=\"device-item\">${device.label || device.identifier || device.id}</div>`);\r\n    });\r\n  } else {\r\n    $$('#entradaDevices').empty();\r\n  }\r\n\r\n  LogHelper.log('RFC-0056: Stats rendered successfully');\r\n}\r\n\r\n/**\r\n * RFC-0056: Render pie chart with 6 slices (no Entrada)\r\n */\r\nfunction renderPieChart() {\r\n  LogHelper.log('RFC-0056: Rendering pie chart with 6 categories...');\r\n\r\n  const canvas = document.getElementById('consumptionPieChart');\r\n  if (!canvas) {\r\n    LogHelper.warn('Canvas element not found');\r\n    return;\r\n  }\r\n\r\n  // Destroy previous chart instance (robust: use Chart.getChart to find any existing chart)\r\n  if (pieChartInstance) {\r\n    pieChartInstance.destroy();\r\n    pieChartInstance = null;\r\n  }\r\n  // Also check Chart.js registry directly (handles cases where reference was lost)\r\n  if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {\r\n    const existingChart = Chart.getChart(canvas);\r\n    if (existingChart) {\r\n      LogHelper.log('Destroying orphaned chart instance from canvas');\r\n      existingChart.destroy();\r\n    }\r\n  }\r\n\r\n  // Check if Chart.js is available\r\n  if (typeof Chart === 'undefined') {\r\n    LogHelper.error('Chart.js library not loaded!');\r\n    $J(canvas).parent().html(`\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state-icon\">√∞≈∏‚Äú≈†</div>\r\n        <div class=\"empty-state-text\">Chart.js n√É¬£o carregado</div>\r\n        <div class=\"empty-state-hint\">\r\n          <small>Adicione Chart.js v4.4.0 nos External Resources</small>\r\n        </div>\r\n      </div>\r\n    `);\r\n    return;\r\n  }\r\n\r\n  const ctx = canvas.getContext('2d');\r\n\r\n  // ========== CHART DATA (6 slices or 5 if hiding √Årea Comum) ==========\r\n  // RFC-0056: Hide √Årea Comum when water domain has bathrooms enabled\r\n  const hideAreaComum = getWidgetDomain() === 'water' && STATE_WATER.includeBathrooms;\r\n\r\n  const labels = hideAreaComum\r\n    ? ['Climatiza√ß√£o', 'Elevadores', 'Esc. Rolantes', 'Lojas', 'Outros']\r\n    : ['Climatiza√ß√£o', 'Elevadores', 'Esc. Rolantes', 'Lojas', 'Outros', '√Årea Comum'];\r\n\r\n  const data = {\r\n    labels: labels,\r\n    datasets: [\r\n      {\r\n        data: hideAreaComum\r\n          ? [\r\n              STATE.consumidores.climatizacao.total,\r\n              STATE.consumidores.elevadores.total,\r\n              STATE.consumidores.escadasRolantes.total,\r\n              STATE.consumidores.lojas.total,\r\n              STATE.consumidores.outros ? STATE.consumidores.outros.total : 0,\r\n            ]\r\n          : [\r\n              STATE.consumidores.climatizacao.total,\r\n              STATE.consumidores.elevadores.total,\r\n              STATE.consumidores.escadasRolantes.total,\r\n              STATE.consumidores.lojas.total,\r\n              STATE.consumidores.outros ? STATE.consumidores.outros.total : 0,\r\n              STATE.consumidores.areaComum.total,\r\n            ],\r\n        backgroundColor: hideAreaComum\r\n          ? [\r\n              CHART_COLORS.climatizacao, // #00C896 (Teal)\r\n              CHART_COLORS.elevadores, // #5B2EBC (Purple)\r\n              CHART_COLORS.escadasRolantes, // #FF6B6B (Red)\r\n              CHART_COLORS.lojas, // #FFC107 (Yellow)\r\n              CHART_COLORS.outros, // #9C27B0 (Deep Purple)\r\n            ]\r\n          : [\r\n              CHART_COLORS.climatizacao, // #00C896 (Teal)\r\n              CHART_COLORS.elevadores, // #5B2EBC (Purple)\r\n              CHART_COLORS.escadasRolantes, // #FF6B6B (Red)\r\n              CHART_COLORS.lojas, // #FFC107 (Yellow)\r\n              CHART_COLORS.outros, // #9C27B0 (Deep Purple)\r\n              CHART_COLORS.areaComum, // #4CAF50 (Green)\r\n            ],\r\n        borderColor: '#FFFFFF', // √¢‚Ä†¬ê Light border\r\n        borderWidth: 2,\r\n        hoverBorderWidth: 3,\r\n        hoverBorderColor: '#222222',\r\n      },\r\n    ],\r\n  };\r\n\r\n  // ========== CHART CONFIG ==========\r\n  pieChartInstance = new Chart(ctx, {\r\n    type: 'pie',\r\n    data: data,\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: false,\r\n      plugins: {\r\n        legend: {\r\n          display: false, // Use custom legend below\r\n        },\r\n        tooltip: {\r\n          backgroundColor: '#FFFFFF',\r\n          borderColor: '#E0E0E0',\r\n          borderWidth: 1,\r\n          titleColor: '#222222',\r\n          bodyColor: '#666666',\r\n          padding: 12,\r\n          boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',\r\n          callbacks: {\r\n            label: function (context) {\r\n              const label = context.label || '';\r\n              const value = context.parsed || 0;\r\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\r\n              const perc = total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n              return `${label}: ${formatEnergy(value)} (${perc}%)`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n      animation: {\r\n        animateRotate: true,\r\n        animateScale: true,\r\n        duration: 800,\r\n        easing: 'easeOutQuart',\r\n      },\r\n    },\r\n  });\r\n\r\n  // Render custom legend\r\n  renderChartLegend();\r\n\r\n  LogHelper.log('RFC-0056: Pie chart rendered successfully');\r\n}\r\n\r\n/**\r\n * RFC-0056: Render custom chart legend with 5 or 6 categories (hide √Årea Comum when water + bathrooms)\r\n */\r\nfunction renderChartLegend() {\r\n  const $legend = $$('#chartLegend').empty();\r\n\r\n  const hideAreaComum = getWidgetDomain() === 'water' && STATE_WATER.includeBathrooms;\r\n\r\n  const items = [\r\n    {\r\n      label: 'Climatiza√ß√£o',\r\n      color: CHART_COLORS.climatizacao,\r\n      value: STATE.consumidores.climatizacao.total,\r\n      perc: STATE.consumidores.climatizacao.perc,\r\n    },\r\n    {\r\n      label: 'Elevadores',\r\n      color: CHART_COLORS.elevadores,\r\n      value: STATE.consumidores.elevadores.total,\r\n      perc: STATE.consumidores.elevadores.perc,\r\n    },\r\n    {\r\n      label: 'Esc. Rolantes',\r\n      color: CHART_COLORS.escadasRolantes,\r\n      value: STATE.consumidores.escadasRolantes.total,\r\n      perc: STATE.consumidores.escadasRolantes.perc,\r\n    },\r\n    {\r\n      label: 'Lojas',\r\n      color: CHART_COLORS.lojas,\r\n      value: STATE.consumidores.lojas.total,\r\n      perc: STATE.consumidores.lojas.perc,\r\n    },\r\n  ];\r\n\r\n  // Only add √Årea Comum if not hidden\r\n  if (!hideAreaComum) {\r\n    items.push({\r\n      label: '√Årea Comum',\r\n      color: CHART_COLORS.areaComum,\r\n      value: STATE.consumidores.areaComum.total,\r\n      perc: STATE.consumidores.areaComum.perc,\r\n    });\r\n  }\r\n\r\n  items.forEach((item) => {\r\n    const html = `\r\n      <div class=\"legend-item\">\r\n        <div class=\"legend-color\" style=\"background: ${item.color};\"></div>\r\n        <span class=\"legend-label\">${item.label}:</span>\r\n        <span class=\"legend-value\">${formatEnergy(item.value)} (${item.perc.toFixed(1)}%)</span>\r\n      </div>\r\n    `;\r\n    $legend.append(html);\r\n  });\r\n\r\n  LogHelper.log('RFC-0056: Chart legend rendered with 5 items');\r\n}\r\n\r\n// ===================== MODAL FUNCTIONS =====================\r\n\r\nlet modalPieChartInstance = null;\r\n\r\n/**\r\n * Open expanded modal view\r\n */\r\nfunction openModal() {\r\n  console.log('[TELEMETRY_INFO] √∞≈∏≈°‚Ç¨ openModal() called');\r\n  LogHelper.log('Opening expanded modal...');\r\n\r\n  const $modal = $J('#modalExpanded');\r\n\r\n  if (!$modal || $modal.length === 0) {\r\n    console.error('[TELEMETRY_INFO] √¢¬ù≈í Modal element #modalExpanded NOT FOUND!');\r\n    return;\r\n  }\r\n\r\n  console.log('[TELEMETRY_INFO] Modal found:', $modal.length, 'elements');\r\n  console.log('[TELEMETRY_INFO] Modal current parent:', $modal.parent()[0]?.tagName || 'NONE');\r\n\r\n  // CRITICAL: ALWAYS remove and re-add to body to ensure it's the LAST element (highest stacking)\r\n  console.log(\"[TELEMETRY_INFO] √∞≈∏‚Äú¬¶ Re-appending modal to body to ensure it's last element\");\r\n  $modal.detach().appendTo(document.body);\r\n  console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ Modal is now last element in body');\r\n\r\n  // RFC-0056 FIX: ULTRA-FORCE modal visibility with MAXIMUM z-index\r\n  console.log('[TELEMETRY_INFO] √∞≈∏≈Ω¬® Setting modal visibility with MAX z-index...');\r\n\r\n  const MAX_Z_INDEX = '2147483647'; // Maximum 32-bit signed integer\r\n\r\n  $modal.css({\r\n    display: 'flex',\r\n    visibility: 'visible',\r\n    opacity: '1',\r\n    'pointer-events': 'all',\r\n    'z-index': MAX_Z_INDEX,\r\n    position: 'fixed',\r\n    top: '0',\r\n    left: '0',\r\n    right: '0',\r\n    bottom: '0',\r\n    width: '100vw',\r\n    height: '100vh',\r\n    background: 'rgba(0, 0, 0, 0.75)',\r\n  });\r\n\r\n  // Force with !important for ABSOLUTE override\r\n  $modal[0].style.setProperty('display', 'flex', 'important');\r\n  $modal[0].style.setProperty('visibility', 'visible', 'important');\r\n  $modal[0].style.setProperty('opacity', '1', 'important');\r\n  $modal[0].style.setProperty('position', 'fixed', 'important');\r\n  $modal[0].style.setProperty('z-index', MAX_Z_INDEX, 'important');\r\n  $modal[0].style.setProperty('width', '100vw', 'important');\r\n  $modal[0].style.setProperty('height', '100vh', 'important');\r\n  $modal[0].style.setProperty('top', '0', 'important');\r\n  $modal[0].style.setProperty('left', '0', 'important');\r\n\r\n  console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ Modal visibility styles applied with z-index:', MAX_Z_INDEX);\r\n\r\n  // Add a class to body to prevent scrolling\r\n  $J('body').addClass('modal-open-telemetry-info');\r\n\r\n  // Update modal data with current STATE\r\n  updateModalData();\r\n\r\n  // Render modal chart\r\n  renderModalChart();\r\n\r\n  // Prevent body scroll\r\n  $J('body').css('overflow', 'hidden');\r\n\r\n  LogHelper.log('Modal opened successfully');\r\n}\r\n\r\n// RFC-0056 FIX: Expose openModal globally for onclick handler\r\nwindow.TELEMETRY_INFO_openModal = openModal;\r\n\r\n/**\r\n * Close expanded modal view\r\n */\r\nfunction closeModal() {\r\n  console.log('[TELEMETRY_INFO] √∞≈∏‚Äù‚Äô closeModal() called');\r\n  LogHelper.log('Closing expanded modal...');\r\n\r\n  const $modal = $J('#modalExpanded');\r\n  $modal.css('display', 'none');\r\n\r\n  // Destroy modal chart instance\r\n  if (modalPieChartInstance) {\r\n    modalPieChartInstance.destroy();\r\n    modalPieChartInstance = null;\r\n  }\r\n\r\n  // Remove body class\r\n  $J('body').removeClass('modal-open-telemetry-info');\r\n\r\n  // Restore body scroll\r\n  $J('body').css('overflow', '');\r\n\r\n  console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ Modal closed successfully');\r\n  LogHelper.log('Modal closed successfully');\r\n}\r\n\r\n/**\r\n * Update modal cards with current STATE values\r\n */\r\nfunction updateModalData() {\r\n  // REMOVED: Modal redesigned as chart-only (no cards to update)\r\n  LogHelper.log('Modal data update skipped (chart-only mode)');\r\n}\r\n\r\n/**\r\n * Render modal pie chart\r\n */\r\nfunction renderModalChart() {\r\n  LogHelper.log('Rendering modal chart...');\r\n\r\n  const ctx = document.getElementById('modalConsumptionPieChart');\r\n  if (!ctx) {\r\n    LogHelper.warn('Modal chart canvas not found');\r\n    return;\r\n  }\r\n\r\n  // Destroy existing instance (robust: use Chart.getChart to find any existing chart)\r\n  if (modalPieChartInstance) {\r\n    modalPieChartInstance.destroy();\r\n    modalPieChartInstance = null;\r\n  }\r\n  // Also check Chart.js registry directly (handles cases where reference was lost)\r\n  if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {\r\n    const existingChart = Chart.getChart(ctx);\r\n    if (existingChart) {\r\n      LogHelper.log('Destroying orphaned modal chart instance from canvas');\r\n      existingChart.destroy();\r\n    }\r\n  }\r\n\r\n  // RFC-0056: 5 or 6 categories for pie chart (hide √Årea Comum when water + bathrooms)\r\n  const hideAreaComum = getWidgetDomain() === 'water' && STATE_WATER.includeBathrooms;\r\n\r\n  const data = hideAreaComum\r\n    ? [\r\n        STATE.consumidores.climatizacao.total,\r\n        STATE.consumidores.elevadores.total,\r\n        STATE.consumidores.escadasRolantes.total,\r\n        STATE.consumidores.lojas.total,\r\n        STATE.consumidores.outros ? STATE.consumidores.outros.total : 0,\r\n      ]\r\n    : [\r\n        STATE.consumidores.climatizacao.total,\r\n        STATE.consumidores.elevadores.total,\r\n        STATE.consumidores.escadasRolantes.total,\r\n        STATE.consumidores.lojas.total,\r\n        STATE.consumidores.outros ? STATE.consumidores.outros.total : 0,\r\n        STATE.consumidores.areaComum.total,\r\n      ];\r\n\r\n  const colors = hideAreaComum\r\n    ? [\r\n        CHART_COLORS.climatizacao,\r\n        CHART_COLORS.elevadores,\r\n        CHART_COLORS.escadasRolantes,\r\n        CHART_COLORS.lojas,\r\n        CHART_COLORS.outros,\r\n      ]\r\n    : [\r\n        CHART_COLORS.climatizacao,\r\n        CHART_COLORS.elevadores,\r\n        CHART_COLORS.escadasRolantes,\r\n        CHART_COLORS.lojas,\r\n        CHART_COLORS.outros,\r\n        CHART_COLORS.areaComum,\r\n      ];\r\n\r\n  const labels = hideAreaComum\r\n    ? ['Climatiza√ß√£o', 'Elevadores', 'Esc. Rolantes', 'Lojas', 'Outros']\r\n    : ['Climatiza√ß√£o', 'Elevadores', 'Esc. Rolantes', 'Lojas', 'Outros', '√Årea Comum'];\r\n\r\n  modalPieChartInstance = new Chart(ctx, {\r\n    type: 'pie',\r\n    data: {\r\n      labels: labels,\r\n      datasets: [\r\n        {\r\n          data: data,\r\n          backgroundColor: colors,\r\n          borderColor: '#FFFFFF',\r\n          borderWidth: 3,\r\n          hoverOffset: 12,\r\n        },\r\n      ],\r\n    },\r\n    options: {\r\n      responsive: true,\r\n      maintainAspectRatio: true,\r\n      layout: {\r\n        padding: 0,\r\n      },\r\n      plugins: {\r\n        legend: {\r\n          display: false,\r\n        },\r\n        tooltip: {\r\n          backgroundColor: 'rgba(0, 0, 0, 0.8)',\r\n          titleColor: '#FFFFFF',\r\n          bodyColor: '#FFFFFF',\r\n          borderColor: '#00C896',\r\n          borderWidth: 1,\r\n          padding: 12,\r\n          displayColors: true,\r\n          callbacks: {\r\n            label: function (context) {\r\n              const label = context.label || '';\r\n              const value = context.parsed || 0;\r\n              const total = context.dataset.data.reduce((a, b) => a + b, 0);\r\n              const perc = total > 0 ? ((value / total) * 100).toFixed(1) : 0;\r\n              return `${label}: ${formatEnergy(value)} (${perc}%)`;\r\n            },\r\n          },\r\n        },\r\n      },\r\n      animation: {\r\n        animateRotate: true,\r\n        animateScale: true,\r\n        duration: 800,\r\n        easing: 'easeOutQuart',\r\n      },\r\n    },\r\n  });\r\n\r\n  // Render modal legend\r\n  renderModalChartLegend();\r\n\r\n  LogHelper.log('Modal chart rendered successfully');\r\n}\r\n\r\n/**\r\n * Render modal chart legend (hide √Årea Comum when water + bathrooms)\r\n */\r\nfunction renderModalChartLegend() {\r\n  const $legend = $J('#modalChartLegend').empty();\r\n\r\n  const hideAreaComum = getWidgetDomain() === 'water' && STATE_WATER.includeBathrooms;\r\n\r\n  const items = [\r\n    {\r\n      label: 'Climatiza√ß√£o',\r\n      color: CHART_COLORS.climatizacao,\r\n      value: STATE.consumidores.climatizacao.total,\r\n      perc: STATE.consumidores.climatizacao.perc,\r\n    },\r\n    {\r\n      label: 'Elevadores',\r\n      color: CHART_COLORS.elevadores,\r\n      value: STATE.consumidores.elevadores.total,\r\n      perc: STATE.consumidores.elevadores.perc,\r\n    },\r\n    {\r\n      label: 'Esc. Rolantes',\r\n      color: CHART_COLORS.escadasRolantes,\r\n      value: STATE.consumidores.escadasRolantes.total,\r\n      perc: STATE.consumidores.escadasRolantes.perc,\r\n    },\r\n    {\r\n      label: 'Lojas',\r\n      color: CHART_COLORS.lojas,\r\n      value: STATE.consumidores.lojas.total,\r\n      perc: STATE.consumidores.lojas.perc,\r\n    },\r\n    {\r\n      label: 'Outros',\r\n      color: CHART_COLORS.outros,\r\n      value: STATE.consumidores.outros ? STATE.consumidores.outros.total : 0,\r\n      perc: STATE.consumidores.outros ? STATE.consumidores.outros.perc : 0,\r\n    },\r\n  ];\r\n\r\n  // Only add √Årea Comum if not hidden\r\n  if (!hideAreaComum) {\r\n    items.push({\r\n      label: '√Årea Comum',\r\n      color: CHART_COLORS.areaComum,\r\n      value: STATE.consumidores.areaComum.total,\r\n      perc: STATE.consumidores.areaComum.perc,\r\n    });\r\n  }\r\n\r\n  items.forEach((item) => {\r\n    const html = `<div class=\"legend-item\"><div class=\"legend-color\" style=\"background: ${\r\n      item.color\r\n    }\"></div><span class=\"legend-label\">${item.label}:</span><span class=\"legend-value\">${formatEnergy(\r\n      item.value\r\n    )}</span></div>`;\r\n    $legend.append(html);\r\n  });\r\n\r\n  LogHelper.log('Modal chart legend rendered (6 categories)');\r\n}\r\n\r\n/**\r\n * Update entire display\r\n * RFC-0002: Supports both energy and water domains\r\n */\r\nfunction updateDisplay() {\r\n  LogHelper.log(`Updating display for domain: ${getWidgetDomain()}...`);\r\n\r\n  try {\r\n    // RFC-0002: Domain-specific rendering\r\n    if (getWidgetDomain() === 'water') {\r\n      renderWaterStats();\r\n      renderWaterPieChart();\r\n      LogHelper.log('[RFC-0002 Water] Display updated successfully');\r\n    } else {\r\n      // Default: energy domain\r\n      renderStats();\r\n      renderPieChart();\r\n      LogHelper.log('Display updated successfully');\r\n    }\r\n  } catch (error) {\r\n    LogHelper.error('Error updating display:', error);\r\n  }\r\n}\r\n\r\n// ===================== ORCHESTRATOR INTEGRATION =====================\r\n\r\n/**\r\n * Process orchestrator data\r\n */\r\nfunction processOrchestratorData(items) {\r\n  LogHelper.log('Processing orchestrator data:', items.length, 'items');\r\n\r\n  // RFC-0105: Store items for device status aggregation (used by summary tooltip)\r\n  RECEIVED_ORCHESTRATOR_ITEMS = items || [];\r\n\r\n  if (!items || items.length === 0) {\r\n    LogHelper.warn('No data to process');\r\n\r\n    // Reset to empty state\r\n    STATE.entrada.devices = [];\r\n    STATE.entrada.total = 0;\r\n    STATE.consumidores.climatizacao.devices = [];\r\n    STATE.consumidores.climatizacao.total = 0;\r\n    STATE.consumidores.elevadores.devices = [];\r\n    STATE.consumidores.elevadores.total = 0;\r\n    STATE.consumidores.escadasRolantes.devices = [];\r\n    STATE.consumidores.escadasRolantes.total = 0;\r\n    STATE.consumidores.lojas.devices = [];\r\n    STATE.consumidores.lojas.total = 0;\r\n    STATE.consumidores.outros.devices = [];\r\n    STATE.consumidores.outros.total = 0;\r\n    STATE.consumidores.areaComum.devices = [];\r\n    STATE.consumidores.areaComum.total = 0;\r\n    STATE.consumidores.totalGeral = 0;\r\n    STATE.grandTotal = 0;\r\n\r\n    updateDisplay();\r\n    return;\r\n  }\r\n\r\n  // Aggregate and classify\r\n  aggregateData(items);\r\n\r\n  // Update display\r\n  updateDisplay();\r\n}\r\n\r\n// ===================== RFC-0056 FIX v1.1: RECEPTOR =====================\r\n\r\nlet telemetryUpdateHandler = null;\r\nlet debounceTimer = null;\r\nlet fallbackTimer = null;\r\n\r\n// RFC-0056 FIX v1.1: Dados recebidos dos widgets TELEMETRY\r\nconst RECEIVED_DATA = {\r\n  entrada_total: null, // RFC-0098: Entrada (medidor principal)\r\n  lojas_total: null,\r\n  climatizacao: null,\r\n  elevadores: null,\r\n  escadas_rolantes: null,\r\n  outros: null,\r\n};\r\n\r\n/**\r\n * Configura listener consolidado para myio:telemetry:update\r\n * RFC-0056 FIX v1.1: Evento √É¬∫nico com detail.type discriminador\r\n */\r\nfunction setupTelemetryListener() {\r\n  telemetryUpdateHandler = function (ev) {\r\n    const { type, domain, periodKey, timestamp, source, data } = ev.detail || {};\r\n\r\n    LogHelper.log(\r\n      `[RFC-0056] Received telemetry update: type=${type}, source=${source}, periodKey=${periodKey}`\r\n    );\r\n\r\n    // Validar dom√É¬≠nio\r\n    if (domain !== getWidgetDomain()) {\r\n      LogHelper.log(`[RFC-0056] Ignoring domain: ${domain} (expecting: ${getWidgetDomain()})`);\r\n      return;\r\n    }\r\n\r\n    // Validar periodKey (previne cross-period mix-ups)\r\n    const currentPeriodKey = buildCurrentPeriodKey();\r\n    if (periodKey !== currentPeriodKey) {\r\n      LogHelper.warn(`[RFC-0056] Period mismatch: received ${periodKey}, current ${currentPeriodKey}`);\r\n      return;\r\n    }\r\n\r\n    // Dispatch por tipo\r\n    switch (type) {\r\n      case 'entrada_total':\r\n        // RFC-0098: Handle entrada total\r\n        handleEntradaTotal(data, timestamp, periodKey);\r\n        break;\r\n      case 'lojas_total':\r\n        handleLojasTotal(data, timestamp, periodKey);\r\n        break;\r\n      case 'areacomum_breakdown':\r\n        handleAreaComumBreakdown(data, timestamp, periodKey);\r\n        break;\r\n      case 'request_refresh':\r\n        handleRequestRefresh(periodKey);\r\n        break;\r\n      default:\r\n        LogHelper.warn(`[RFC-0056] Unknown event type: ${type}`);\r\n    }\r\n  };\r\n\r\n  window.addEventListener('myio:telemetry:update', telemetryUpdateHandler);\r\n\r\n  // Tentar carregar do cache\r\n  tryLoadFromCache();\r\n\r\n  // Fallback: se ap√É¬≥s 3s n√É¬£o temos dados completos, solicitar refresh\r\n  startFallbackTimeout();\r\n}\r\n\r\n/**\r\n * RFC-0098: Handler: entrada_total\r\n * Receives entrada (main meter) data from TELEMETRY widget\r\n */\r\nfunction handleEntradaTotal(data, timestamp, periodKey) {\r\n  RECEIVED_DATA.entrada_total = { ...data, timestamp, periodKey };\r\n  LogHelper.log(`[RFC-0098] ‚úÖ Entrada total updated: ${data.total_MWh} MWh (${data.device_count} devices)`);\r\n\r\n  // Update STATE.entrada directly\r\n  STATE.entrada.total = data.total_kWh || 0;\r\n  STATE.entrada.devices = []; // Devices list not sent, just totals\r\n  STATE.entrada.perc = 100; // Entrada is always 100% reference\r\n\r\n  // Agendar recalculo com debounce\r\n  scheduleRecalculation();\r\n}\r\n\r\n/**\r\n * Handler: lojas_total\r\n */\r\nfunction handleLojasTotal(data, timestamp, periodKey) {\r\n  RECEIVED_DATA.lojas_total = { ...data, timestamp, periodKey };\r\n  LogHelper.log(`[RFC-0056] ‚úÖ Lojas total updated: ${data.total_MWh} MWh`);\r\n\r\n  // Agendar recalculo com debounce\r\n  scheduleRecalculation();\r\n}\r\n\r\n/**\r\n * Handler: areacomum_breakdown\r\n * RFC-0096: Enhanced with device counts and climatiza√ß√£o subcategories\r\n */\r\nfunction handleAreaComumBreakdown(data, timestamp, periodKey) {\r\n  RECEIVED_DATA.climatizacao = {\r\n    total: data.climatizacao_kWh,\r\n    totalMWh: data.climatizacao_MWh,\r\n    count: data.climatizacao_count || 0,\r\n    subcategories: data.climatizacao_subcategories || null,\r\n    timestamp,\r\n    periodKey,\r\n  };\r\n  RECEIVED_DATA.elevadores = {\r\n    total: data.elevadores_kWh,\r\n    totalMWh: data.elevadores_MWh,\r\n    count: data.elevadores_count || 0,\r\n    timestamp,\r\n    periodKey,\r\n  };\r\n  RECEIVED_DATA.escadas_rolantes = {\r\n    total: data.escadas_rolantes_kWh,\r\n    totalMWh: data.escadas_rolantes_MWh,\r\n    count: data.escadas_rolantes_count || 0,\r\n    timestamp,\r\n    periodKey,\r\n  };\r\n  RECEIVED_DATA.outros = {\r\n    total: data.outros_kWh,\r\n    totalMWh: data.outros_MWh,\r\n    count: data.outros_count || 0,\r\n    // RFC-0097: Subcategorias de \"outros\" agrupadas por deviceType\r\n    subcategories: data.outros_subcategories || null,\r\n    timestamp,\r\n    periodKey,\r\n  };\r\n\r\n  LogHelper.log(`[RFC-0056] ‚úÖ AreaComum breakdown updated:`, {\r\n    climatizacao: `${data.climatizacao_MWh} MWh (${data.climatizacao_count || 0} devices)`,\r\n    elevadores: `${data.elevadores_MWh} MWh (${data.elevadores_count || 0} devices)`,\r\n    escadas_rolantes: `${data.escadas_rolantes_MWh} MWh (${data.escadas_rolantes_count || 0} devices)`,\r\n    outros: `${data.outros_MWh} MWh (${data.outros_count || 0} devices)`,\r\n  });\r\n\r\n  // Agendar recalculo com debounce\r\n  scheduleRecalculation();\r\n}\r\n\r\n/**\r\n * Handler: request_refresh\r\n * Outro widget solicita re-emiss√É¬£o dos dados (fallback)\r\n */\r\nfunction handleRequestRefresh(periodKey) {\r\n  LogHelper.log(`[RFC-0056] Received request_refresh for period: ${periodKey}`);\r\n\r\n  // Este widget √É¬© receptor, n√É¬£o emissor - ignora\r\n  // (apenas TELEMETRY responde a request_refresh)\r\n}\r\n\r\n/**\r\n * Agenda recalculo com debounce de 300ms\r\n * RFC-0056 FIX v1.1: Reduz recalculos redundantes quando ambos eventos chegam juntos\r\n */\r\nfunction scheduleRecalculation() {\r\n  if (debounceTimer) {\r\n    clearTimeout(debounceTimer);\r\n  }\r\n\r\n  debounceTimer = setTimeout(() => {\r\n    debounceTimer = null;\r\n\r\n    if (canRecalculate()) {\r\n      recalculateWithReceivedData();\r\n    } else {\r\n      LogHelper.warn('[RFC-0056] Cannot recalculate yet - waiting for more data');\r\n    }\r\n  }, 300);\r\n}\r\n\r\n/**\r\n * Verifica se temos dados suficientes para recalcular\r\n * RFC-0098: Added entrada check\r\n */\r\nfunction canRecalculate() {\r\n  const hasEntrada = RECEIVED_DATA.entrada_total !== null || STATE.entrada.total > 0;\r\n  const hasLojas = RECEIVED_DATA.lojas_total !== null;\r\n  const hasAreaComum =\r\n    RECEIVED_DATA.climatizacao !== null &&\r\n    RECEIVED_DATA.elevadores !== null &&\r\n    RECEIVED_DATA.escadas_rolantes !== null &&\r\n    RECEIVED_DATA.outros !== null;\r\n\r\n  return hasEntrada && hasLojas && hasAreaComum;\r\n}\r\n\r\n/**\r\n * Recalcula valores usando dados recebidos\r\n * RFC-0056 FIX v1.1: Substitui c√É¬°lculo local por valores recebidos\r\n */\r\nfunction recalculateWithReceivedData() {\r\n  LogHelper.log('[RFC-0056] √∞≈∏‚Äù‚Äû Recalculating with received data...');\r\n\r\n  // Cancelar fallback timer (dados completos recebidos)\r\n  if (fallbackTimer) {\r\n    clearTimeout(fallbackTimer);\r\n    fallbackTimer = null;\r\n  }\r\n\r\n  // Atualizar STATE.consumidores com dados recebidos (RFC-0056: Defensive)\r\n  // Ensure objects exist before setting properties\r\n  if (!STATE.consumidores.lojas) STATE.consumidores.lojas = { total: 0, perc: 0 };\r\n  if (!STATE.consumidores.climatizacao) STATE.consumidores.climatizacao = { total: 0, perc: 0 };\r\n  if (!STATE.consumidores.elevadores) STATE.consumidores.elevadores = { total: 0, perc: 0 };\r\n  if (!STATE.consumidores.escadasRolantes) STATE.consumidores.escadasRolantes = { total: 0, perc: 0 };\r\n  if (!STATE.consumidores.outros) STATE.consumidores.outros = { total: 0, perc: 0 };\r\n\r\n  STATE.consumidores.lojas.total = RECEIVED_DATA.lojas_total?.total_kWh || 0;\r\n  STATE.consumidores.climatizacao.total = RECEIVED_DATA.climatizacao?.total || 0;\r\n  STATE.consumidores.elevadores.total = RECEIVED_DATA.elevadores?.total || 0;\r\n  STATE.consumidores.escadasRolantes.total = RECEIVED_DATA.escadas_rolantes?.total || 0;\r\n  STATE.consumidores.outros.total = RECEIVED_DATA.outros?.total || 0;\r\n\r\n  // Recalcular √É¬Årea Comum como residual (RFC-0056: Defensive calculation)\r\n  const somaConsumidores =\r\n    (STATE.consumidores.lojas?.total || 0) +\r\n    (STATE.consumidores.climatizacao?.total || 0) +\r\n    (STATE.consumidores.elevadores?.total || 0) +\r\n    (STATE.consumidores.escadasRolantes?.total || 0) +\r\n    (STATE.consumidores.outros?.total || 0);\r\n\r\n  if (!STATE.consumidores.areaComum) STATE.consumidores.areaComum = { total: 0, perc: 0 };\r\n  STATE.consumidores.areaComum.total = Math.max(0, STATE.entrada.total - somaConsumidores);\r\n\r\n  // RFC-0056: When water domain has bathrooms, consolidate √°rea comum into \"outros\"\r\n  if (\r\n    getWidgetDomain() === 'water' &&\r\n    STATE_WATER.includeBathrooms &&\r\n    STATE.consumidores.areaComum.total > 0\r\n  ) {\r\n    LogHelper.log(\r\n      `[RFC-0056] Consolidating √°rea comum (${STATE.consumidores.areaComum.total.toFixed(2)}) into outros`\r\n    );\r\n    STATE.consumidores.outros.total += STATE.consumidores.areaComum.total;\r\n    LogHelper.log(`[RFC-0056] New outros total: ${STATE.consumidores.outros.total.toFixed(2)}`);\r\n    // Set areaComum to 0 since it's now consolidated into outros\r\n    STATE.consumidores.areaComum.total = 0;\r\n  }\r\n\r\n  // Recalcular total geral (SEM incluir entrada)\r\n  // Note: Must recalculate if we consolidated √°rea comum into outros\r\n  const finalSomaConsumidores =\r\n    (STATE.consumidores.lojas?.total || 0) +\r\n    (STATE.consumidores.climatizacao?.total || 0) +\r\n    (STATE.consumidores.elevadores?.total || 0) +\r\n    (STATE.consumidores.escadasRolantes?.total || 0) +\r\n    (STATE.consumidores.outros?.total || 0);\r\n\r\n  STATE.consumidores.totalGeral = finalSomaConsumidores + STATE.consumidores.areaComum.total;\r\n\r\n  // Recalcular percentuais (RFC-0056: Baseados em Total Consumidores, n√É¬£o em Entrada)\r\n  const totalConsumidores = STATE.consumidores.totalGeral;\r\n  STATE.consumidores.lojas.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.lojas.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.climatizacao.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.climatizacao.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.elevadores.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.elevadores.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.escadasRolantes.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.escadasRolantes.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.outros.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.outros.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.areaComum.perc =\r\n    totalConsumidores > 0 ? (STATE.consumidores.areaComum.total / totalConsumidores) * 100 : 0;\r\n  STATE.consumidores.percGeral = 100; // Total Consumidores √É¬© sempre 100% de si mesmo\r\n\r\n  // Valida√É¬ß√É¬£o: Total consumidores vs Entrada\r\n  const diff = Math.abs(STATE.entrada.total - STATE.consumidores.totalGeral);\r\n  const tolerance = STATE.entrada.total * 0.02; // 2%\r\n\r\n  if (diff > tolerance) {\r\n    LogHelper.warn(\r\n      `[RFC-0056] Validation warning: Entrada (${STATE.entrada.total.toFixed(\r\n        2\r\n      )} kWh) != Total Consumidores (${STATE.consumidores.totalGeral.toFixed(2)} kWh), diff: ${diff.toFixed(\r\n        2\r\n      )} kWh`\r\n    );\r\n    showValidationWarning(diff);\r\n  } else {\r\n    hideValidationWarning();\r\n  }\r\n\r\n  // Atualizar display\r\n  updateDisplay();\r\n\r\n  LogHelper.log('[RFC-0056] √¢≈ì‚Ä¶ Recalculation complete');\r\n}\r\n\r\n// ===================== RFC-0002: WATER DOMAIN FUNCTIONS =====================\r\n\r\n/**\r\n * RFC-0002: Process water telemetry data from TELEMETRY widgets\r\n * @param {Object} eventDetail - Event detail with context, total, devices, periodKey, banheirosBreakdown\r\n */\r\nfunction processWaterTelemetryData(eventDetail) {\r\n  const { context, total, devices, periodKey, banheirosBreakdown } = eventDetail;\r\n\r\n  LogHelper.log(\r\n    `[RFC-0002 Water] Received data: context=${context}, total=${total} m¬≥, devices=${devices?.length || 0}`\r\n  );\r\n\r\n  // Validate period key\r\n  if (periodKey && STATE_WATER.periodKey && periodKey !== STATE_WATER.periodKey) {\r\n    LogHelper.warn(\r\n      `[RFC-0002 Water] Period mismatch: received ${periodKey}, current ${STATE_WATER.periodKey}`\r\n    );\r\n    return;\r\n  }\r\n\r\n  // Set period key if first time\r\n  if (!STATE_WATER.periodKey) {\r\n    STATE_WATER.periodKey = periodKey;\r\n  }\r\n\r\n  // Update state based on context\r\n  switch (context) {\r\n    case 'entrada':\r\n      STATE_WATER.entrada.total = total || 0;\r\n      STATE_WATER.entrada.devices = devices || [];\r\n      STATE_WATER.entrada.perc = 100; // Always 100% of itself\r\n      break;\r\n\r\n    case 'lojas':\r\n      STATE_WATER.lojas.total = total || 0;\r\n      STATE_WATER.lojas.devices = devices || [];\r\n      break;\r\n\r\n    case 'areaComum':\r\n      // RFC-0002: Extract banheiros from areaComum breakdown (devices classified by label/identifier)\r\n      if (banheirosBreakdown && STATE_WATER.includeBathrooms) {\r\n        // Banheiros data from areaComum widget (devices with \"banheiro\" in label/identifier)\r\n        STATE_WATER.banheiros.total = banheirosBreakdown.banheiros?.total || 0;\r\n        STATE_WATER.banheiros.devices = banheirosBreakdown.banheiros?.devices || [];\r\n        LogHelper.log(\r\n          `[RFC-0002 Water] Banheiros extracted from areaComum: ${STATE_WATER.banheiros.total.toFixed(\r\n            2\r\n          )} m¬≥ (${STATE_WATER.banheiros.devices.length} devices)`\r\n        );\r\n\r\n        // √Årea Comum = only outros (non-bathroom devices)\r\n        STATE_WATER.areaComum.total = banheirosBreakdown.outros?.total || 0;\r\n        STATE_WATER.areaComum.devices = banheirosBreakdown.outros?.devices || [];\r\n        LogHelper.log(\r\n          `[RFC-0002 Water] √Årea Comum (outros): ${STATE_WATER.areaComum.total.toFixed(2)} m¬≥ (${\r\n            STATE_WATER.areaComum.devices.length\r\n          } devices)`\r\n        );\r\n      } else {\r\n        // No breakdown or banheiros disabled - use full areaComum\r\n        STATE_WATER.areaComum.total = total || 0;\r\n        STATE_WATER.areaComum.devices = devices || [];\r\n      }\r\n      break;\r\n\r\n    default:\r\n      LogHelper.warn(`[RFC-0002 Water] Unknown context: ${context}`);\r\n      return;\r\n  }\r\n\r\n  // Recalculate pontos n√£o mapeados and percentages\r\n  calculateWaterPontosNaoMapeados();\r\n  calculateWaterPercentages();\r\n\r\n  // Update last update timestamp\r\n  STATE_WATER.lastUpdate = new Date().toISOString();\r\n\r\n  // Update display\r\n  updateDisplay();\r\n\r\n  LogHelper.log(`[RFC-0002 Water] State updated:`, {\r\n    entrada: STATE_WATER.entrada.total,\r\n    lojas: STATE_WATER.lojas.total,\r\n    banheiros: STATE_WATER.banheiros.total,\r\n    areaComum: STATE_WATER.areaComum.total,\r\n    pontosNaoMapeados: STATE_WATER.pontosNaoMapeados.total,\r\n  });\r\n}\r\n\r\n/**\r\n * RFC-0002: Calculate \"Pontos N√£o Mapeados\" as residual\r\n * Formula: entrada - (lojas + banheiros + areaComum) when includeBathrooms is true\r\n * Formula: entrada - (lojas + areaComum) when includeBathrooms is false\r\n */\r\nfunction calculateWaterPontosNaoMapeados() {\r\n  const entrada = STATE_WATER.entrada.total;\r\n  const lojas = STATE_WATER.lojas.total;\r\n  const banheiros = STATE_WATER.includeBathrooms ? STATE_WATER.banheiros.total : 0;\r\n  const areaComum = STATE_WATER.areaComum.total;\r\n\r\n  // Sum of measured points (includes banheiros only if enabled)\r\n  const medidosTotal = lojas + banheiros + areaComum;\r\n\r\n  // Residual (difference)\r\n  const naoMapeados = entrada - medidosTotal;\r\n\r\n  // Check for inconsistency (negative indicates measurement error)\r\n  const hasInconsistency = naoMapeados < 0;\r\n\r\n  STATE_WATER.pontosNaoMapeados.total = hasInconsistency ? 0 : naoMapeados;\r\n  STATE_WATER.pontosNaoMapeados.hasInconsistency = hasInconsistency;\r\n\r\n  // Update grand total (sum of all measured, excluding entrada)\r\n  STATE_WATER.grandTotal = medidosTotal + (hasInconsistency ? 0 : naoMapeados);\r\n\r\n  if (hasInconsistency) {\r\n    LogHelper.warn(\r\n      `[RFC-0002 Water] [WARNING] Inconsistency detected: entrada (${entrada} m¬≥) < medidos (${medidosTotal} m¬≥)`\r\n    );\r\n  }\r\n\r\n  LogHelper.log(\r\n    `[RFC-0002 Water] Calculated pontos n√£o mapeados: ${STATE_WATER.pontosNaoMapeados.total.toFixed(2)} m¬≥`\r\n  );\r\n}\r\n\r\n/**\r\n * RFC-0002: Calculate percentages relative to entrada\r\n */\r\nfunction calculateWaterPercentages() {\r\n  const entrada = STATE_WATER.entrada.total;\r\n\r\n  if (entrada === 0) {\r\n    // No entrada, all percentages are 0\r\n    STATE_WATER.lojas.perc = 0;\r\n    STATE_WATER.banheiros.perc = 0;\r\n    STATE_WATER.areaComum.perc = 0;\r\n    STATE_WATER.pontosNaoMapeados.perc = 0;\r\n    return;\r\n  }\r\n\r\n  // Percentage relative to entrada\r\n  STATE_WATER.lojas.perc = (STATE_WATER.lojas.total / entrada) * 100;\r\n  STATE_WATER.banheiros.perc = (STATE_WATER.banheiros.total / entrada) * 100;\r\n  STATE_WATER.areaComum.perc = (STATE_WATER.areaComum.total / entrada) * 100;\r\n  STATE_WATER.pontosNaoMapeados.perc = (STATE_WATER.pontosNaoMapeados.total / entrada) * 100;\r\n\r\n  LogHelper.log(`[RFC-0002 Water] Percentages:`, {\r\n    lojas: STATE_WATER.lojas.perc.toFixed(1) + '%',\r\n    banheiros: STATE_WATER.banheiros.perc.toFixed(1) + '%',\r\n    areaComum: STATE_WATER.areaComum.perc.toFixed(1) + '%',\r\n    naoMapeados: STATE_WATER.pontosNaoMapeados.perc.toFixed(1) + '%',\r\n  });\r\n}\r\n\r\n/**\r\n * RFC-0002: Render water stats (5 cards with banheiros)\r\n * Reuses existing HTML structure but hides energy-only cards\r\n * Order: Entrada - Lojas - Banheiros - √Årea Comum - Pontos N√£o Mapeados\r\n */\r\nfunction renderWaterStats() {\r\n  LogHelper.log('[RFC-0002 Water] Rendering stats...');\r\n\r\n  // Hide energy-only cards\r\n  $$('.climatizacao-card').hide();\r\n  $$('.elevadores-card').hide();\r\n  $$('.escadas-card').hide();\r\n  $$('.outros-card').hide();\r\n\r\n  // Show/hide banheiros card based on setting\r\n  if (STATE_WATER.includeBathrooms) {\r\n    $$('.banheiros-card').show();\r\n  } else {\r\n    $$('.banheiros-card').hide();\r\n  }\r\n\r\n  // Update Entrada card\r\n  $$('#entradaTotal').text(formatValue(STATE_WATER.entrada.total, 'water'));\r\n\r\n  // Update Lojas card\r\n  $$('#lojasTotal').text(formatValue(STATE_WATER.lojas.total, 'water'));\r\n  $$('#lojasPerc').text(`(${STATE_WATER.lojas.perc.toFixed(1)}%)`);\r\n\r\n  // Update Banheiros card (only if enabled)\r\n  if (STATE_WATER.includeBathrooms) {\r\n    $$('#banheirosTotal').text(formatValue(STATE_WATER.banheiros.total, 'water'));\r\n    $$('#banheirosPerc').text(`(${STATE_WATER.banheiros.perc.toFixed(1)}%)`);\r\n  }\r\n\r\n  // Reuse \"√°rea comum\" card for water √°rea comum\r\n  $$('#areaComumTotal').text(formatValue(STATE_WATER.areaComum.total, 'water'));\r\n  $$('#areaComumPerc').text(`(${STATE_WATER.areaComum.perc.toFixed(1)}%)`);\r\n\r\n  // RFC-0056: Hide √Årea Comum card when bathrooms are included\r\n  // Consolidate √°rea comum into \"Pontos n√£o mapeados\" instead\r\n  if (STATE_WATER.includeBathrooms) {\r\n    $$('.area-comum-card').hide();\r\n    LogHelper.log('[RFC-0056] Hiding √Årea Comum card (water domain with bathrooms)');\r\n  } else {\r\n    $$('.area-comum-card').show();\r\n    LogHelper.log('[RFC-0056] Showing √Årea Comum card (water domain without bathrooms)');\r\n  }\r\n\r\n  // Reuse \"total consumidores\" card for \"pontos n√£o mapeados\"\r\n  const $totalCard = $$('.total-card .card-title');\r\n  if ($totalCard.length > 0) {\r\n    $totalCard.text('Pontos N√£o Mapeados');\r\n  }\r\n  $$('#consumidoresTotal').text(formatValue(STATE_WATER.pontosNaoMapeados.total, 'water'));\r\n  $$('#consumidoresPerc').text(`(${STATE_WATER.pontosNaoMapeados.perc.toFixed(1)}%)`);\r\n\r\n  // Show warning if inconsistency\r\n  if (STATE_WATER.pontosNaoMapeados.hasInconsistency) {\r\n    const $totalCardTitle = $$('.total-card .card-title');\r\n    if ($totalCardTitle.length && !$totalCardTitle.find('.validation-warning').length) {\r\n      $totalCardTitle.append(\r\n        ' <span class=\"validation-warning\" style=\"color: #FF6B6B; font-size: 0.9em;\" title=\"Inconsist√™ncia: soma dos medidos > entrada\">[WARNING]</span>'\r\n      );\r\n    }\r\n  } else {\r\n    $$('.total-card .validation-warning').remove();\r\n  }\r\n\r\n  LogHelper.log('[RFC-0002 Water] Stats rendered');\r\n}\r\n\r\n/**\r\n * RFC-0002: Render water pie chart (5 contexts with banheiros)\r\n */\r\nfunction renderWaterPieChart() {\r\n  LogHelper.log('[RFC-0002 Water] Rendering pie chart...');\r\n\r\n  // Get colors from settings or use defaults\r\n  const colors = {\r\n    lojas: self.ctx.settings?.waterChartColors?.lojas || '#FFC107',\r\n    banheiros: self.ctx.settings?.waterChartColors?.banheiros || '#2196F3',\r\n    areaComum: self.ctx.settings?.waterChartColors?.areaComum || '#4CAF50',\r\n    pontosNaoMapeados: self.ctx.settings?.waterChartColors?.pontosNaoMapeados || '#9E9E9E',\r\n  };\r\n\r\n  // Build chart data based on includeBathrooms setting\r\n  const chartData = [\r\n    { label: 'Lojas', color: colors.lojas, value: STATE_WATER.lojas.total, perc: STATE_WATER.lojas.perc },\r\n  ];\r\n\r\n  // Add banheiros if enabled\r\n  if (STATE_WATER.includeBathrooms) {\r\n    chartData.push({\r\n      label: 'Banheiros',\r\n      color: colors.banheiros,\r\n      value: STATE_WATER.banheiros.total,\r\n      perc: STATE_WATER.banheiros.perc,\r\n    });\r\n  }\r\n\r\n  // Add remaining contexts\r\n  chartData.push(\r\n    {\r\n      label: '√Årea Comum',\r\n      color: colors.areaComum,\r\n      value: STATE_WATER.areaComum.total,\r\n      perc: STATE_WATER.areaComum.perc,\r\n    },\r\n    {\r\n      label: 'Pontos N√£o Mapeados',\r\n      color: colors.pontosNaoMapeados,\r\n      value: STATE_WATER.pontosNaoMapeados.total,\r\n      perc: STATE_WATER.pontosNaoMapeados.perc,\r\n    }\r\n  );\r\n\r\n  // Filter out zero values\r\n  const validData = chartData.filter((item) => item.value > 0);\r\n\r\n  if (validData.length === 0) {\r\n    LogHelper.warn('[RFC-0002 Water] No data to render chart');\r\n    return;\r\n  }\r\n\r\n  // Render main widget chart\r\n  const chartCanvas = $$('#consumptionPieChart')[0];\r\n  if (chartCanvas) {\r\n    // Destroy existing instance (robust: use Chart.getChart to find any existing chart)\r\n    if (pieChartInstance) {\r\n      pieChartInstance.destroy();\r\n      pieChartInstance = null;\r\n    }\r\n    // Also check Chart.js registry directly (handles cases where reference was lost)\r\n    if (typeof Chart !== 'undefined' && typeof Chart.getChart === 'function') {\r\n      const existingChart = Chart.getChart(chartCanvas);\r\n      if (existingChart) {\r\n        LogHelper.log('[RFC-0002 Water] Destroying orphaned chart instance from canvas');\r\n        existingChart.destroy();\r\n      }\r\n    }\r\n\r\n    pieChartInstance = new Chart(chartCanvas.getContext('2d'), {\r\n      type: 'pie',\r\n      data: {\r\n        labels: validData.map((item) => item.label),\r\n        datasets: [\r\n          {\r\n            data: validData.map((item) => item.value),\r\n            backgroundColor: validData.map((item) => item.color),\r\n            borderWidth: 2,\r\n            borderColor: '#fff',\r\n          },\r\n        ],\r\n      },\r\n      options: {\r\n        responsive: true,\r\n        maintainAspectRatio: true,\r\n        plugins: {\r\n          legend: { display: false },\r\n          tooltip: {\r\n            callbacks: {\r\n              label: function (context) {\r\n                const label = context.label || '';\r\n                const value = formatValue(context.parsed, 'water');\r\n                const perc = validData[context.dataIndex].perc.toFixed(1);\r\n                return `${label}: ${value} (${perc}%)`;\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Render legend\r\n  const $legend = $$('#chartLegend');\r\n  if ($legend.length > 0) {\r\n    $legend.empty();\r\n    validData.forEach((item) => {\r\n      $legend.append(`\r\n        <div class=\"legend-item\">\r\n          <span class=\"legend-color\" style=\"background-color: ${item.color};\"></span>\r\n          <span class=\"legend-label\">${item.label}</span>\r\n          <span class=\"legend-value\">${formatValue(item.value, 'water')} (${item.perc.toFixed(1)}%)</span>\r\n        </div>\r\n      `);\r\n    });\r\n  }\r\n\r\n  LogHelper.log('[RFC-0002 Water] Pie chart rendered');\r\n}\r\n\r\n/**\r\n * Tenta carregar dados do cache sessionStorage\r\n * RFC-0056 FIX v1.1: Performance < 100ms reload\r\n */\r\nfunction tryLoadFromCache() {\r\n  try {\r\n    const periodKey = buildCurrentPeriodKey();\r\n\r\n    const cacheKeyLojas = `myio:telemetry:lojas_${periodKey}`;\r\n    const cacheKeyAreaComum = `myio:telemetry:areacomum_${periodKey}`;\r\n\r\n    const cachedLojas = sessionStorage.getItem(cacheKeyLojas);\r\n    const cachedAreaComum = sessionStorage.getItem(cacheKeyAreaComum);\r\n\r\n    if (cachedLojas) {\r\n      const payload = JSON.parse(cachedLojas);\r\n      handleLojasTotal(payload.data, payload.timestamp, payload.periodKey);\r\n      LogHelper.log('[RFC-0056] √∞≈∏‚Äú¬¶ Loaded lojas from cache');\r\n    }\r\n\r\n    if (cachedAreaComum) {\r\n      const payload = JSON.parse(cachedAreaComum);\r\n      handleAreaComumBreakdown(payload.data, payload.timestamp, payload.periodKey);\r\n      LogHelper.log('[RFC-0056] √∞≈∏‚Äú¬¶ Loaded areacomum from cache');\r\n    }\r\n  } catch (err) {\r\n    LogHelper.warn('[RFC-0056] Cache load failed:', err);\r\n  }\r\n}\r\n\r\n/**\r\n * Inicia timer de fallback (3s)\r\n * RFC-0056 FIX v1.1: Se ap√É¬≥s 3s n√É¬£o recebemos dados, emite request_refresh\r\n */\r\nfunction startFallbackTimeout() {\r\n  fallbackTimer = setTimeout(() => {\r\n    if (!canRecalculate()) {\r\n      LogHelper.warn('[RFC-0056] √¢¬è¬±√Ø¬∏¬è Fallback timeout - requesting refresh');\r\n\r\n      const periodKey = buildCurrentPeriodKey();\r\n      const event = new CustomEvent('myio:telemetry:update', {\r\n        detail: {\r\n          type: 'request_refresh',\r\n          domain: getWidgetDomain(),\r\n          periodKey: periodKey,\r\n          timestamp: Date.now(),\r\n          source: 'TELEMETRY_INFO',\r\n        },\r\n        bubbles: true,\r\n        cancelable: false,\r\n      });\r\n\r\n      window.dispatchEvent(event);\r\n    }\r\n  }, 3000);\r\n}\r\n\r\n/**\r\n * Constr√É¬≥i periodKey atual baseado no timewindow do widget\r\n */\r\nfunction buildCurrentPeriodKey() {\r\n  const timewindow = self.ctx?.defaultSubscription?.subscriptionTimewindow;\r\n\r\n  if (!timewindow || timewindow.realtimeWindowMs) {\r\n    return 'realtime';\r\n  }\r\n\r\n  const startMs = timewindow.fixedWindow?.startTimeMs || Date.now() - 86400000;\r\n  const endMs = timewindow.fixedWindow?.endTimeMs || Date.now();\r\n\r\n  const startDate = new Date(startMs).toISOString().split('T')[0];\r\n  const endDate = new Date(endMs).toISOString().split('T')[0];\r\n\r\n  return `${startDate}_${endDate}`;\r\n}\r\n\r\n/**\r\n * Exibe marker de warning de valida√É¬ß√É¬£o na UI\r\n * RFC-0056 FIX v1.1: Ajuda debugging sem console\r\n */\r\nfunction showValidationWarning(diff) {\r\n  // Adicionar warning icon no card Total Consumidores\r\n  const $totalCard = $$('.total-card .card-title');\r\n  if ($totalCard.length && !$totalCard.find('.validation-warning').length) {\r\n    $totalCard.append(\r\n      ' <span class=\"validation-warning\" style=\"color: #FF6B6B; font-size: 0.9em;\" title=\"Diferen√É¬ßa de ' +\r\n        diff.toFixed(2) +\r\n        ' kWh detectada\">!</span>'\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Remove marker de warning\r\n */\r\nfunction hideValidationWarning() {\r\n  $$('.validation-warning').remove();\r\n}\r\n\r\n// ===================== INFO TOOLTIP (RFC-0105: Using Library Component) =====================\r\n\r\n/**\r\n * Get InfoTooltip from library\r\n * @returns {object|null} InfoTooltip component or null if not available\r\n */\r\nfunction getInfoTooltip() {\r\n  return window.MyIOLibrary?.InfoTooltip || null;\r\n}\r\n\r\n/**\r\n * Build √Årea Comum tooltip content HTML (Energy domain)\r\n * @returns {string} HTML content\r\n */\r\nfunction buildAreaComumContentEnergy() {\r\n  const entrada = STATE.entrada.total || 0;\r\n  const lojas = STATE.consumidores.lojas?.total || 0;\r\n  const climatizacao = STATE.consumidores.climatizacao?.total || 0;\r\n  const elevadores = STATE.consumidores.elevadores?.total || 0;\r\n  const escadasRolantes = STATE.consumidores.escadasRolantes?.total || 0;\r\n  const outros = STATE.consumidores.outros?.total || 0;\r\n  const areaComum = STATE.consumidores.areaComum?.total || 0;\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Valores Atuais\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">üì• Entrada (Total):</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(entrada)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">‚ûñ Lojas:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(lojas)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">‚ûñ Climatiza√ß√£o:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(climatizacao)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">‚ûñ Elevadores:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(elevadores)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">‚ûñ Esc. Rolantes:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(escadasRolantes)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">‚ûñ Outros:</span>\r\n        <span class=\"myio-info-tooltip__value\">${formatEnergy(outros)}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\" style=\"border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 6px;\">\r\n        <span class=\"myio-info-tooltip__label\"><strong>= √Årea Comum:</strong></span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatEnergy(\r\n          areaComum\r\n        )}</span>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">üìê F√≥rmula</div>\r\n      <div style=\"font-size: 11px; color: #475569; line-height: 1.5;\">\r\n        √Årea Comum = Entrada ‚àí (Lojas + Climatiza√ß√£o + Elevadores + Esc. Rolantes + Outros)\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">üí°</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        <strong>√Årea Comum</strong> representa o consumo residual do shopping que n√£o est√° associado a nenhuma categoria espec√≠fica (ilumina√ß√£o geral, tomadas, etc).\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Build √Årea Comum tooltip content HTML (Water domain)\r\n * @returns {string} HTML content\r\n */\r\nfunction buildAreaComumContentWater() {\r\n  const entrada = STATE_WATER.entrada.total || 0;\r\n  const lojas = STATE_WATER.lojas?.total || 0;\r\n  const banheiros = STATE_WATER.banheiros?.total || 0;\r\n  const areaComum = STATE_WATER.areaComum?.total || 0;\r\n  const includeBathrooms = STATE_WATER.includeBathrooms;\r\n\r\n  let rows = `\r\n    <div class=\"myio-info-tooltip__row\">\r\n      <span class=\"myio-info-tooltip__label\">üì• Entrada (Total):</span>\r\n      <span class=\"myio-info-tooltip__value\">${formatValue(entrada, 'water')}</span>\r\n    </div>\r\n    <div class=\"myio-info-tooltip__row\">\r\n      <span class=\"myio-info-tooltip__label\">‚ûñ Lojas:</span>\r\n      <span class=\"myio-info-tooltip__value\">${formatValue(lojas, 'water')}</span>\r\n    </div>\r\n  `;\r\n\r\n  if (includeBathrooms) {\r\n    rows += `\r\n    <div class=\"myio-info-tooltip__row\">\r\n      <span class=\"myio-info-tooltip__label\">‚ûñ Banheiros:</span>\r\n      <span class=\"myio-info-tooltip__value\">${formatValue(banheiros, 'water')}</span>\r\n    </div>\r\n    `;\r\n  }\r\n\r\n  rows += `\r\n    <div class=\"myio-info-tooltip__row\" style=\"border-top: 1px solid #e2e8f0; padding-top: 8px; margin-top: 6px;\">\r\n      <span class=\"myio-info-tooltip__label\"><strong>= √Årea Comum:</strong></span>\r\n      <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatValue(areaComum, 'water')}</span>\r\n    </div>\r\n  `;\r\n\r\n  const formula = includeBathrooms\r\n    ? '√Årea Comum = Entrada ‚àí (Lojas + Banheiros)'\r\n    : '√Årea Comum = Entrada ‚àí Lojas';\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Valores Atuais\r\n      </div>\r\n      ${rows}\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">üìê F√≥rmula</div>\r\n      <div style=\"font-size: 11px; color: #475569; line-height: 1.5;\">\r\n        ${formula}\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">üí°</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        <strong>√Årea Comum</strong> representa o consumo de √°gua residual do shopping que n√£o est√° associado a lojas${includeBathrooms ? ' ou banheiros' : ''} (jardins, limpeza, etc).\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Build √Årea Comum tooltip content HTML (auto-detects domain)\r\n * @returns {string} HTML content\r\n */\r\nfunction buildAreaComumContent() {\r\n  const domain = getWidgetDomain();\r\n  return domain === 'water' ? buildAreaComumContentWater() : buildAreaComumContentEnergy();\r\n}\r\n\r\n/**\r\n * Build Climatiza√ß√£o tooltip content HTML\r\n * @returns {string} HTML content\r\n */\r\nfunction buildClimatizacaoContent() {\r\n  const climatizacao = STATE.consumidores.climatizacao?.total || 0;\r\n  const climatizacaoPerc = STATE.consumidores.climatizacao?.perc || 0;\r\n  const climatizacaoCount = RECEIVED_DATA.climatizacao?.count || 0;\r\n  const subcategoriesData = RECEIVED_DATA.climatizacao?.subcategories || null;\r\n\r\n  // Build subcategories HTML dynamically\r\n  let subcatHtml = '';\r\n  if (subcategoriesData && typeof subcategoriesData === 'object') {\r\n    const sortedKeys = Object.keys(subcategoriesData).sort((a, b) => {\r\n      const totalA = subcategoriesData[a]?.total || 0;\r\n      const totalB = subcategoriesData[b]?.total || 0;\r\n      return totalB - totalA;\r\n    });\r\n\r\n    sortedKeys.forEach((key) => {\r\n      const data = subcategoriesData[key];\r\n      if (data && (data.count > 0 || data.total > 0)) {\r\n        const label = data.label || key.toUpperCase();\r\n        subcatHtml += `\r\n          <div class=\"myio-info-tooltip__category myio-info-tooltip__category--climatizacao\">\r\n            <span class=\"myio-info-tooltip__category-icon\">‚ùÑÔ∏è</span>\r\n            <div class=\"myio-info-tooltip__category-info\">\r\n              <div class=\"myio-info-tooltip__category-name\">${label}</div>\r\n              <div class=\"myio-info-tooltip__category-desc\">${data.count} equipamento(s)</div>\r\n            </div>\r\n            <span class=\"myio-info-tooltip__category-value\">${formatEnergy(data.total)}</span>\r\n          </div>\r\n        `;\r\n      }\r\n    });\r\n  }\r\n\r\n  if (!subcatHtml) {\r\n    subcatHtml = `\r\n      <div class=\"myio-info-tooltip__category myio-info-tooltip__category--climatizacao\">\r\n        <span class=\"myio-info-tooltip__category-icon\">‚ÑπÔ∏è</span>\r\n        <div class=\"myio-info-tooltip__category-info\">\r\n          <div class=\"myio-info-tooltip__category-name\">Sem dados</div>\r\n          <div class=\"myio-info-tooltip__category-desc\">Aguardando dados de subcategorias</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Consumo Total\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Climatiza√ß√£o:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatEnergy(\r\n          climatizacao\r\n        )}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Equipamentos:</span>\r\n        <span class=\"myio-info-tooltip__value\">${climatizacaoCount}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Participa√ß√£o:</span>\r\n        <span class=\"myio-info-tooltip__value\">${climatizacaoPerc.toFixed(1)}%</span>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìã</span> Composi√ß√£o\r\n      </div>\r\n      ${subcatHtml}\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">üí°</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        O valor de <strong>Climatiza√ß√£o</strong> √© calculado pela soma do consumo de todos os equipamentos classificados nestas categorias.\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Build Outros Equipamentos tooltip content HTML\r\n * @returns {string} HTML content\r\n */\r\nfunction buildOutrosContent() {\r\n  const outros = STATE.consumidores.outros?.total || 0;\r\n  const outrosPerc = STATE.consumidores.outros?.perc || 0;\r\n  const outrosCount = RECEIVED_DATA.outros?.count || 0;\r\n  const subcategoriesData = RECEIVED_DATA.outros?.subcategories || null;\r\n\r\n  const deviceTypeIcons = {\r\n    motor: '‚öôÔ∏è',\r\n    '3f_medidor': 'üìä',\r\n    compressor: 'üîß',\r\n    ventilador: 'üåÄ',\r\n    bomba: 'üíß',\r\n    bomba_hidraulica: 'üíß',\r\n    desconhecido: '‚ùì',\r\n  };\r\n\r\n  let subcatHtml = '';\r\n  if (subcategoriesData && typeof subcategoriesData === 'object') {\r\n    const sortedKeys = Object.keys(subcategoriesData).sort((a, b) => {\r\n      const totalA = subcategoriesData[a]?.total || 0;\r\n      const totalB = subcategoriesData[b]?.total || 0;\r\n      return totalB - totalA;\r\n    });\r\n\r\n    sortedKeys.forEach((key) => {\r\n      const data = subcategoriesData[key];\r\n      if (data && (data.count > 0 || data.total > 0)) {\r\n        const label = data.label || key.toUpperCase();\r\n        const icon = deviceTypeIcons[key.toLowerCase()] || 'üîå';\r\n        subcatHtml += `\r\n          <div class=\"myio-info-tooltip__category myio-info-tooltip__category--outros\">\r\n            <span class=\"myio-info-tooltip__category-icon\">${icon}</span>\r\n            <div class=\"myio-info-tooltip__category-info\">\r\n              <div class=\"myio-info-tooltip__category-name\">${label}</div>\r\n              <div class=\"myio-info-tooltip__category-desc\">${data.count} equipamento(s)</div>\r\n            </div>\r\n            <span class=\"myio-info-tooltip__category-value\">${formatEnergy(data.total)}</span>\r\n          </div>\r\n        `;\r\n      }\r\n    });\r\n  }\r\n\r\n  if (!subcatHtml) {\r\n    subcatHtml = `\r\n      <div class=\"myio-info-tooltip__category myio-info-tooltip__category--outros\">\r\n        <span class=\"myio-info-tooltip__category-icon\">‚ÑπÔ∏è</span>\r\n        <div class=\"myio-info-tooltip__category-info\">\r\n          <div class=\"myio-info-tooltip__category-name\">Sem dados</div>\r\n          <div class=\"myio-info-tooltip__category-desc\">Aguardando dados de subcategorias</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  return `\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìä</span> Consumo Total\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Outros:</span>\r\n        <span class=\"myio-info-tooltip__value myio-info-tooltip__value--highlight\">${formatEnergy(\r\n          outros\r\n        )}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Equipamentos:</span>\r\n        <span class=\"myio-info-tooltip__value\">${outrosCount}</span>\r\n      </div>\r\n      <div class=\"myio-info-tooltip__row\">\r\n        <span class=\"myio-info-tooltip__label\">Participa√ß√£o:</span>\r\n        <span class=\"myio-info-tooltip__value\">${outrosPerc.toFixed(1)}%</span>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__section\">\r\n      <div class=\"myio-info-tooltip__section-title\">\r\n        <span>üìã</span> Composi√ß√£o por Tipo\r\n      </div>\r\n      ${subcatHtml}\r\n    </div>\r\n\r\n    <div class=\"myio-info-tooltip__notice\">\r\n      <span class=\"myio-info-tooltip__notice-icon\">üí°</span>\r\n      <div class=\"myio-info-tooltip__notice-text\">\r\n        O valor de <strong>Outros Equipamentos</strong> inclui todos os dispositivos que n√£o se enquadram nas categorias principais (Climatiza√ß√£o, Elevadores, Escadas Rolantes).\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Show √Årea Comum tooltip using library InfoTooltip\r\n * @param {HTMLElement} triggerElement - Element that triggered the tooltip\r\n */\r\nfunction showAreaComumTooltip(triggerElement) {\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    LogHelper.warn('[Tooltip] InfoTooltip not available in library');\r\n    return;\r\n  }\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: 'üè¢',\r\n    title: '√Årea Comum - Detalhes',\r\n    content: buildAreaComumContent(),\r\n  });\r\n}\r\n\r\n/**\r\n * Show Climatiza√ß√£o tooltip using library InfoTooltip\r\n * @param {HTMLElement} triggerElement - Element that triggered the tooltip\r\n */\r\nfunction showClimatizacaoTooltip(triggerElement) {\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    LogHelper.warn('[Tooltip] InfoTooltip not available in library');\r\n    return;\r\n  }\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: '‚ùÑÔ∏è',\r\n    title: 'Climatiza√ß√£o - Detalhes',\r\n    content: buildClimatizacaoContent(),\r\n  });\r\n}\r\n\r\n/**\r\n * Show Outros Equipamentos tooltip using library InfoTooltip\r\n * @param {HTMLElement} triggerElement - Element that triggered the tooltip\r\n */\r\nfunction showOutrosTooltip(triggerElement) {\r\n  const InfoTooltip = getInfoTooltip();\r\n  if (!InfoTooltip) {\r\n    LogHelper.warn('[Tooltip] InfoTooltip not available in library');\r\n    return;\r\n  }\r\n  InfoTooltip.show(triggerElement, {\r\n    icon: 'üîå',\r\n    title: 'Outros Equipamentos - Detalhes',\r\n    content: buildOutrosContent(),\r\n  });\r\n}\r\n\r\n/**\r\n * Setup tooltip triggers for all info icons\r\n * RFC-0105: Now using library InfoTooltip component\r\n */\r\nfunction setupInfoTooltips() {\r\n  const $container = $root();\r\n  const InfoTooltip = getInfoTooltip();\r\n\r\n  if (!InfoTooltip) {\r\n    LogHelper.warn('[Tooltip] InfoTooltip not available - tooltips disabled');\r\n    return;\r\n  }\r\n\r\n  // √Årea Comum tooltip trigger\r\n  const $areaComumTrigger = $container.find('.area-comum-card .info-tooltip');\r\n  if ($areaComumTrigger.length) {\r\n    $areaComumTrigger\r\n      .addClass('info-tooltip-trigger')\r\n      .removeAttr('title')\r\n      .off('mouseenter.infoTooltip mouseleave.infoTooltip')\r\n      .on('mouseenter.infoTooltip', function () {\r\n        showAreaComumTooltip(this);\r\n      })\r\n      .on('mouseleave.infoTooltip', function () {\r\n        InfoTooltip.startDelayedHide();\r\n      });\r\n    LogHelper.log('[Tooltip] √Årea Comum trigger bound');\r\n  }\r\n\r\n  // Climatiza√ß√£o tooltip trigger\r\n  const $climatizacaoTrigger = $container.find('.climatizacao-card .info-tooltip');\r\n  if ($climatizacaoTrigger.length) {\r\n    $climatizacaoTrigger\r\n      .addClass('info-tooltip-trigger')\r\n      .removeAttr('title')\r\n      .off('mouseenter.infoTooltip mouseleave.infoTooltip')\r\n      .on('mouseenter.infoTooltip', function () {\r\n        showClimatizacaoTooltip(this);\r\n      })\r\n      .on('mouseleave.infoTooltip', function () {\r\n        InfoTooltip.startDelayedHide();\r\n      });\r\n    LogHelper.log('[Tooltip] Climatiza√ß√£o trigger bound');\r\n  }\r\n\r\n  // RFC-0097: Outros Equipamentos tooltip trigger\r\n  const $outrosTrigger = $container.find('.outros-card .info-tooltip');\r\n  if ($outrosTrigger.length) {\r\n    $outrosTrigger\r\n      .addClass('info-tooltip-trigger')\r\n      .removeAttr('title')\r\n      .off('mouseenter.infoTooltip mouseleave.infoTooltip')\r\n      .on('mouseenter.infoTooltip', function () {\r\n        showOutrosTooltip(this);\r\n      })\r\n      .on('mouseleave.infoTooltip', function () {\r\n        InfoTooltip.startDelayedHide();\r\n      });\r\n    LogHelper.log('[Tooltip] Outros Equipamentos trigger bound');\r\n  }\r\n\r\n  // Banheiros tooltip trigger (water domain)\r\n  const $banheirosTrigger = $container.find('.banheiros-card .info-tooltip');\r\n  if ($banheirosTrigger.length) {\r\n    $banheirosTrigger.addClass('info-tooltip-trigger').removeAttr('title');\r\n    LogHelper.log('[Tooltip] Banheiros trigger found (native title kept)');\r\n  }\r\n\r\n  LogHelper.log('[Tooltip] All info tooltips configured');\r\n}\r\n\r\n// NOTE: Legacy tooltip CSS removed - now using InfoTooltip from library\r\n// See RFC-0105 for standardized tooltip implementation\r\n\r\n// ===================== RFC-0105: SUMMARY TOOLTIP (ENERGY/WATER) =====================\r\n\r\nlet summaryTooltipCleanup = null;\r\n\r\n/**\r\n * RFC-0105: Setup Summary Tooltip (Energy or Water based on domain)\r\n * Premium tooltip showing dashboard summary on header info button hover\r\n */\r\nfunction setupSummaryTooltip() {\r\n  const domain = getWidgetDomain();\r\n  const isWater = domain === 'water';\r\n  const tooltipType = isWater ? 'Water' : 'Energy';\r\n\r\n  LogHelper.log(`[RFC-0105] Setting up ${tooltipType} Summary Tooltip...`);\r\n\r\n  const $container = $root();\r\n  let $trigger = $container.find('#btnInfoSummary');\r\n\r\n  // Se o bot√£o n√£o existir, criar dinamicamente\r\n  if (!$trigger.length) {\r\n    LogHelper.log('[RFC-0105] Creating btnInfoSummary dynamically...');\r\n    const $title = $container.find('#infoTitleHeader');\r\n\r\n    if ($title.length) {\r\n      const $btn = $J(\r\n        '<span class=\"info-tooltip btn-info-summary\" id=\"btnInfoSummary\" title=\"Ver resumo do dashboard\" style=\"cursor: pointer; margin-left: 8px;\">‚ÑπÔ∏è</span>'\r\n      );\r\n      $title.append($btn);\r\n      $trigger = $btn;\r\n      LogHelper.log('[RFC-0105] btnInfoSummary created and appended to title');\r\n    } else {\r\n      LogHelper.warn('[RFC-0105] Info title header not found, cannot create button');\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Get appropriate tooltip from library based on domain\r\n  const SummaryTooltip = isWater\r\n    ? window.MyIOLibrary?.WaterSummaryTooltip\r\n    : window.MyIOLibrary?.EnergySummaryTooltip;\r\n\r\n  if (!SummaryTooltip) {\r\n    console.error(`[RFC-0105] ${tooltipType}SummaryTooltip not available in MyIOLibrary. Tooltip will not work.`);\r\n    return;\r\n  }\r\n\r\n  // Build summary data function based on domain\r\n  // RFC-0105: Now passing domain to enable device list aggregation from MyIOOrchestratorData\r\n  const getSummaryData = () => {\r\n    // RFC-0105: Aggregate device status from orchestrator data (runs in widget context)\r\n    const deviceStatusData = aggregateDeviceStatusFromOrchestrator(domain);\r\n\r\n    // Enrich RECEIVED_DATA with device status aggregation\r\n    const enrichedData = {\r\n      ...RECEIVED_DATA,\r\n      deviceStatusAggregation: deviceStatusData,\r\n    };\r\n\r\n    if (isWater) {\r\n      return SummaryTooltip.buildSummaryFromState(\r\n        STATE_WATER,\r\n        enrichedData,\r\n        STATE_WATER.includeBathrooms,\r\n        'water'\r\n      );\r\n    } else {\r\n      return SummaryTooltip.buildSummaryFromState(\r\n        { entrada: STATE.entrada, consumidores: STATE.consumidores, grandTotal: STATE.grandTotal },\r\n        enrichedData,\r\n        'energy'\r\n      );\r\n    }\r\n  };\r\n\r\n  // Attach tooltip\r\n  summaryTooltipCleanup = SummaryTooltip.attach($trigger[0], getSummaryData);\r\n\r\n  LogHelper.log(`[RFC-0105] ${tooltipType} Summary Tooltip attached successfully`);\r\n}\r\n\r\n// NOTE: Fallback tooltip removed - library component is required\r\n// If SummaryTooltip is not available, a console.error will be logged\r\n\r\n// ===================== WIDGET LIFECYCLE =====================\r\n\r\nself.onInit = async function () {\r\n  LogHelper.log('Widget initializing (RFC-0056)...');\r\n\r\n  // RFC-0056 FIX: Expose openModal globally IMMEDIATELY for onclick handler\r\n  window.TELEMETRY_INFO_openModal = openModal;\r\n  window.TELEMETRY_INFO_closeModal = closeModal;\r\n  LogHelper.log('√¢≈ì‚Ä¶ Modal functions exposed globally');\r\n\r\n  // RFC-0056 FIX: Move modal to body immediately (but keep it hidden) to escape widget constraints\r\n  setTimeout(() => {\r\n    const $modal = $J('#modalExpanded');\r\n    if ($modal.length > 0 && $modal.parent()[0] !== document.body) {\r\n      console.log('[TELEMETRY_INFO] √∞≈∏‚Äú¬¶ INIT: Moving modal to body (keeping it hidden)');\r\n      $modal.detach().appendTo(document.body);\r\n      // Ensure it stays hidden with ULTRA z-index\r\n      $modal.css({\r\n        display: 'none',\r\n        'z-index': '2147483647', // Maximum 32-bit integer\r\n      });\r\n      console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ INIT: Modal moved to body and hidden with max z-index');\r\n    }\r\n  }, 100);\r\n\r\n  // Setup container styles\r\n  $root().css({\r\n    height: '100%',\r\n    overflow: 'auto',\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    position: 'relative',\r\n  });\r\n\r\n  // Load settings (WIDGET_DOMAIN removed - use getWidgetDomain() instead)\r\n  SHOW_DEVICES_LIST = self.ctx.settings?.showDevicesList || false;\r\n\r\n  // RFC-0002: Water domain - load banheiros setting\r\n  STATE_WATER.includeBathrooms = self.ctx.settings?.waterIncludeBathrooms || false;\r\n  LogHelper.log(`[RFC-0002 Water] includeBathrooms setting: ${STATE_WATER.includeBathrooms}`);\r\n\r\n  // RFC-0056: Load chart colors (with defaults) - 6 categories\r\n  CHART_COLORS = {\r\n    climatizacao: self.ctx.settings?.chartColors?.climatizacao || '#00C896',\r\n    elevadores: self.ctx.settings?.chartColors?.elevadores || '#5B2EBC',\r\n    escadasRolantes: self.ctx.settings?.chartColors?.escadasRolantes || '#FF6B6B',\r\n    lojas: self.ctx.settings?.chartColors?.lojas || '#FFC107',\r\n    outros: self.ctx.settings?.chartColors?.outros || '#9C27B0',\r\n    areaComum: self.ctx.settings?.chartColors?.areaComum || '#4CAF50',\r\n  };\r\n\r\n  LogHelper.log('Settings loaded:', {\r\n    domain: getWidgetDomain(),\r\n    showDevicesList: SHOW_DEVICES_LIST,\r\n    chartColors: CHART_COLORS,\r\n  });\r\n\r\n  // RFC-0056: Migration - Ensure 'outros' exists in STATE (for backwards compatibility)\r\n  if (!STATE.consumidores.outros) {\r\n    LogHelper.warn(\"[RFC-0056] Migration: Adding 'outros' to STATE.consumidores\");\r\n    STATE.consumidores.outros = { devices: [], total: 0, perc: 0 };\r\n  }\r\n  if (!RECEIVED_DATA.outros) {\r\n    RECEIVED_DATA.outros = null;\r\n  }\r\n\r\n  // RFC-0002: Set widget label (dynamic based on domain)\r\n  const domainConfig = getDomainLabel(getWidgetDomain());\r\n\r\n  // Priority: 1) Manual config from settings, 2) Auto from domain\r\n  const widgetLabel =\r\n    self.ctx.settings?.labelWidget || `${domainConfig.icon} Informa√ß√µes de ${domainConfig.title}`;\r\n  const modalLabel = self.ctx.settings?.modalTitle || `Distribui√ß√£o de Consumo de ${domainConfig.title}`;\r\n\r\n  // Update header title\r\n  const $infoTitle = $root().find('.info-title');\r\n  if ($infoTitle.length > 0) {\r\n    $infoTitle.html(widgetLabel);\r\n  }\r\n\r\n  // Update modal title (using ID for safer targeting)\r\n  const $modalTitle = $J('#modalTitleHeader');\r\n  if ($modalTitle.length > 0) {\r\n    $modalTitle.text(modalLabel);\r\n  }\r\n\r\n  LogHelper.log(`[RFC-0002] T√≠tulos atualizados: domain=${getWidgetDomain()}, title=${domainConfig.title}`);\r\n\r\n  // Listen for orchestrator data\r\n  dataProvideHandler = function (ev) {\r\n    const { domain, periodKey, items } = ev.detail;\r\n\r\n    // Only process my domain\r\n    if (domain !== getWidgetDomain()) {\r\n      LogHelper.log(`Ignoring data for domain: ${domain} (expecting: ${getWidgetDomain()})`);\r\n      return;\r\n    }\r\n\r\n    // Prevent duplicate processing\r\n    if (lastProcessedPeriodKey === periodKey) {\r\n      LogHelper.log(`Skipping duplicate periodKey: ${periodKey}`);\r\n      return;\r\n    }\r\n    lastProcessedPeriodKey = periodKey;\r\n\r\n    LogHelper.log(`Received data: domain=${domain}, periodKey=${periodKey}, items=${items.length}`);\r\n\r\n    processOrchestratorData(items);\r\n  };\r\n\r\n  window.addEventListener('myio:telemetry:provide-data', dataProvideHandler);\r\n\r\n  // RFC-0002: Listen for water domain events\r\n  if (getWidgetDomain() === 'water') {\r\n    waterProvideHandler = function (ev) {\r\n      const { domain, context } = ev.detail;\r\n\r\n      // Only process water domain\r\n      if (domain !== 'water') {\r\n        LogHelper.log(`[RFC-0002 Water] Ignoring event for domain: ${domain}`);\r\n        return;\r\n      }\r\n\r\n      LogHelper.log(`[RFC-0002 Water] Received event: context=${context}, domain=${domain}`);\r\n\r\n      processWaterTelemetryData(ev.detail);\r\n    };\r\n\r\n    window.addEventListener('myio:telemetry:provide-water', waterProvideHandler);\r\n    LogHelper.log('[RFC-0002 Water] Listener configured for myio:telemetry:provide-water');\r\n  }\r\n\r\n  // Listen for clear cache event from HEADER\r\n  clearCacheHandler = function (ev) {\r\n    const { domain } = ev.detail || {};\r\n\r\n    // Only process if it's for my domain\r\n    if (domain !== getWidgetDomain()) {\r\n      LogHelper.log(`Ignoring clear event for domain: ${domain} (expecting: ${getWidgetDomain()})`);\r\n      return;\r\n    }\r\n\r\n    LogHelper.log(`[CLEAR] Received clear cache event for domain: ${domain}`);\r\n\r\n    // RFC-0002: Clear domain-specific STATE\r\n    if (domain === 'water') {\r\n      // Clear water state\r\n      STATE_WATER.entrada = {\r\n        context: 'entrada',\r\n        devices: [],\r\n        total: 0,\r\n        perc: 100,\r\n        source: 'widget-telemetry-entrada',\r\n      };\r\n      STATE_WATER.lojas = {\r\n        context: 'lojas',\r\n        devices: [],\r\n        total: 0,\r\n        perc: 0,\r\n        source: 'widget-telemetry-lojas',\r\n      };\r\n      STATE_WATER.banheiros = {\r\n        context: 'banheiros',\r\n        devices: [],\r\n        total: 0,\r\n        perc: 0,\r\n        source: 'widget-telemetry-area-comum (banheiros breakdown)',\r\n      };\r\n      STATE_WATER.areaComum = {\r\n        context: 'areaComum',\r\n        devices: [],\r\n        total: 0,\r\n        perc: 0,\r\n        source: 'widget-telemetry-area-comum (outros)',\r\n      };\r\n      STATE_WATER.pontosNaoMapeados = {\r\n        context: 'pontosNaoMapeados',\r\n        devices: [],\r\n        total: 0,\r\n        perc: 0,\r\n        isCalculated: true,\r\n        hasInconsistency: false,\r\n      };\r\n      STATE_WATER.grandTotal = 0;\r\n      STATE_WATER.periodKey = null;\r\n      STATE_WATER.lastUpdate = null;\r\n      // Note: includeBathrooms is preserved from settings, not cleared\r\n      LogHelper.log('[CLEAR] Water state cleared');\r\n    } else {\r\n      // Clear energy state (default)\r\n      STATE.entrada = { devices: [], total: 0, perc: 100 };\r\n      STATE.consumidores = {\r\n        climatizacao: { devices: [], total: 0, perc: 0 },\r\n        elevadores: { devices: [], total: 0, perc: 0 },\r\n        escadasRolantes: { devices: [], total: 0, perc: 0 },\r\n        lojas: { devices: [], total: 0, perc: 0 },\r\n        outros: { devices: [], total: 0, perc: 0 },\r\n        areaComum: { devices: [], total: 0, perc: 0 },\r\n        totalGeral: 0,\r\n        percGeral: 0,\r\n      };\r\n\r\n      // Clear RECEIVED_DATA\r\n      RECEIVED_DATA.entrada = null;\r\n      RECEIVED_DATA.climatizacao = null;\r\n      RECEIVED_DATA.elevadores = null;\r\n      RECEIVED_DATA.escadasRolantes = null;\r\n      RECEIVED_DATA.lojas = null;\r\n      RECEIVED_DATA.outros = null;\r\n\r\n      LogHelper.log('[CLEAR] Energy state cleared');\r\n    }\r\n\r\n    // Reset period key\r\n    lastProcessedPeriodKey = null;\r\n\r\n    // Update display with cleared data\r\n    updateDisplay();\r\n\r\n    LogHelper.log('[CLEAR] ‚úÖ Widget data cleared and display updated');\r\n  };\r\n\r\n  window.addEventListener('myio:telemetry:clear', clearCacheHandler);\r\n\r\n  // RFC-0056 FIX v1.1: Listen for consolidated telemetry updates\r\n  setupTelemetryListener();\r\n\r\n  // Listen for date updates\r\n  dateUpdateHandler = function (ev) {\r\n    LogHelper.log('Date updated:', ev.detail);\r\n\r\n    // Update widget scope\r\n    const { startISO, endISO } = ev.detail.period || {};\r\n    if (startISO && endISO) {\r\n      self.ctx.scope = self.ctx.scope || {};\r\n      self.ctx.scope.startDateISO = startISO;\r\n      self.ctx.scope.endDateISO = endISO;\r\n      lastProcessedPeriodKey = null; // Reset to allow reprocessing\r\n    }\r\n  };\r\n\r\n  window.addEventListener('myio:update-date', dateUpdateHandler);\r\n\r\n  // Check for stored orchestrator data (warm start)\r\n  setTimeout(() => {\r\n    const orchestratorData = window.MyIOOrchestratorData || window.parent?.MyIOOrchestratorData;\r\n\r\n    if (orchestratorData && orchestratorData[getWidgetDomain()]) {\r\n      const storedData = orchestratorData[getWidgetDomain()];\r\n      const age = Date.now() - storedData.timestamp;\r\n\r\n      // Use stored data if less than 30 seconds old\r\n      if (age < 30000 && storedData.items && storedData.items.length > 0) {\r\n        LogHelper.log('Using stored orchestrator data (age:', age, 'ms)');\r\n        processOrchestratorData(storedData.items);\r\n      } else {\r\n        LogHelper.log('Stored data is stale or empty (age:', age, 'ms)');\r\n      }\r\n    } else {\r\n      LogHelper.log('No stored orchestrator data found');\r\n    }\r\n  }, 500);\r\n\r\n  // Setup modal event listeners (RFC-0056: Using event delegation for robustness)\r\n  const $container = $root();\r\n\r\n  LogHelper.log('Setting up modal event listeners...');\r\n  LogHelper.log('Container:', $container.length > 0 ? 'found' : 'NOT FOUND');\r\n\r\n  // RFC-0056 FIX: Immediate button binding (no setTimeout)\r\n  // Use multiple selectors to ensure button is found\r\n  const bindExpandButton = () => {\r\n    // Try multiple selection strategies\r\n    const $btn1 = $container.find('#btnExpandModal');\r\n    const $btn2 = $container.find('.btn-expand');\r\n    const $btn3 = $root().find('#btnExpandModal');\r\n\r\n    const $btn = $btn1.length > 0 ? $btn1 : $btn2.length > 0 ? $btn2 : $btn3;\r\n\r\n    LogHelper.log('Expand button found:', $btn.length > 0 ? 'YES' : 'NO');\r\n\r\n    if ($btn.length > 0) {\r\n      LogHelper.log('Button HTML:', $btn[0].outerHTML);\r\n\r\n      // DIRECT binding (no delegation needed since button is in widget container)\r\n      $btn.off('click').on('click', function (e) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ DIRECT Expand button clicked!'); // Force log\r\n        openModal();\r\n      });\r\n      LogHelper.log('√¢≈ì‚Ä¶ Direct click handler attached to button');\r\n      return true;\r\n    } else {\r\n      // Silent: button may not be rendered yet, delegation fallbacks will handle clicks\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Try binding immediately\r\n  if (!bindExpandButton()) {\r\n    // If not found, retry after DOM settles\r\n    setTimeout(bindExpandButton, 100);\r\n    setTimeout(bindExpandButton, 500);\r\n    setTimeout(bindExpandButton, 1000);\r\n  }\r\n\r\n  // Expand button - use delegation on container (PRIMARY)\r\n  $container.on('click', '#btnExpandModal, .btn-expand', function (e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ DELEGATED Expand button clicked!'); // Force log even if DEBUG off\r\n    LogHelper.log('Expand button clicked (delegated)');\r\n    openModal();\r\n  });\r\n\r\n  // Fallback: native DOM listener directly on the element (in case jQuery delegation fails)\r\n  const nativeBtn = document.getElementById('btnExpandModal');\r\n  if (nativeBtn) {\r\n    nativeBtn.addEventListener(\r\n      'click',\r\n      function (e) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ NATIVE Expand button clicked!');\r\n        openModal();\r\n      },\r\n      { capture: false }\r\n    );\r\n  }\r\n  // Also bind by class, in case id changes or duplicates\r\n  const nativeBtnsByClass = document.getElementsByClassName('btn-expand');\r\n  if (nativeBtnsByClass && nativeBtnsByClass.length) {\r\n    Array.prototype.forEach.call(nativeBtnsByClass, function (el) {\r\n      el.addEventListener(\r\n        'click',\r\n        function (e) {\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n          console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ NATIVE(.btn-expand) Expand button clicked!');\r\n          openModal();\r\n        },\r\n        { capture: false }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Ultimate fallback: capture-phase on window to intercept the click\r\n  window.addEventListener(\r\n    'click',\r\n    function (e) {\r\n      const t = e.target;\r\n      if (!t) return;\r\n      // match self or svg/path inside the button\r\n      let btn = t.id === 'btnExpandModal' ? t : t.closest ? t.closest('#btnExpandModal') : null;\r\n      if (!btn && t.closest) {\r\n        btn = t.closest('.btn-expand');\r\n      }\r\n      if (btn) {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        console.log('[TELEMETRY_INFO] √¢≈ì‚Ä¶ CAPTURE Expand button clicked!');\r\n        openModal();\r\n      }\r\n    },\r\n    true\r\n  );\r\n\r\n  // Close button - delegate to body since modal moves there\r\n  $J('body').on('click', '#btnCloseModal', function (e) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    LogHelper.log('Close button clicked');\r\n    closeModal();\r\n  });\r\n\r\n  // Close modal on overlay click\r\n  $J('body').on('click', '#modalExpanded', function (e) {\r\n    if (e.target.id === 'modalExpanded') {\r\n      LogHelper.log('Modal overlay clicked');\r\n      closeModal();\r\n    }\r\n  });\r\n\r\n  // Close modal on ESC key\r\n  $J(document).on('keydown.telemetryInfoModal', function (e) {\r\n    if (e.key === 'Escape' && $J('#modalExpanded').css('display') === 'flex') {\r\n      LogHelper.log('ESC key pressed - closing modal');\r\n      closeModal();\r\n    }\r\n  });\r\n\r\n  // Setup info tooltips (premium style)\r\n  setTimeout(() => {\r\n    setupInfoTooltips();\r\n  }, 200);\r\n\r\n  // RFC-0105: Setup Summary Tooltip (Energy or Water based on domain)\r\n  setTimeout(() => {\r\n    setupSummaryTooltip();\r\n  }, 300);\r\n\r\n  LogHelper.log('Widget initialized successfully (RFC-0056)');\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  // No-op: We rely on orchestrator events, not ThingsBoard datasources\r\n  LogHelper.log('onDataUpdated called (no-op in orchestrator mode)');\r\n};\r\n\r\nself.onResize = function () {\r\n  LogHelper.log('Widget resized');\r\n\r\n  // Resize chart if it exists\r\n  if (pieChartInstance) {\r\n    try {\r\n      pieChartInstance.resize();\r\n      LogHelper.log('Chart resized');\r\n    } catch (error) {\r\n      LogHelper.warn('Error resizing chart:', error);\r\n    }\r\n  }\r\n};\r\n\r\nself.onDestroy = function () {\r\n  LogHelper.log('Widget destroying...');\r\n\r\n  // Remove event listeners\r\n  if (dateUpdateHandler) {\r\n    window.removeEventListener('myio:update-date', dateUpdateHandler);\r\n    dateUpdateHandler = null;\r\n  }\r\n\r\n  if (dataProvideHandler) {\r\n    window.removeEventListener('myio:telemetry:provide-data', dataProvideHandler);\r\n    dataProvideHandler = null;\r\n  }\r\n\r\n  if (clearCacheHandler) {\r\n    window.removeEventListener('myio:telemetry:clear', clearCacheHandler);\r\n    clearCacheHandler = null;\r\n  }\r\n\r\n  // RFC-0056 FIX v1.1: Remove telemetry listener\r\n  if (telemetryUpdateHandler) {\r\n    window.removeEventListener('myio:telemetry:update', telemetryUpdateHandler);\r\n    telemetryUpdateHandler = null;\r\n  }\r\n\r\n  // RFC-0056 FIX v1.1: Clear timers\r\n  if (debounceTimer) {\r\n    clearTimeout(debounceTimer);\r\n    debounceTimer = null;\r\n  }\r\n  if (fallbackTimer) {\r\n    clearTimeout(fallbackTimer);\r\n    fallbackTimer = null;\r\n  }\r\n\r\n  // RFC-0105: Cleanup Summary Tooltip\r\n  if (summaryTooltipCleanup) {\r\n    try {\r\n      summaryTooltipCleanup();\r\n      summaryTooltipCleanup = null;\r\n      LogHelper.log('[RFC-0105] Summary Tooltip cleaned up');\r\n    } catch (error) {\r\n      LogHelper.warn('[RFC-0105] Error cleaning up Summary Tooltip:', error);\r\n    }\r\n  }\r\n\r\n  // Destroy chart\r\n  if (pieChartInstance) {\r\n    try {\r\n      pieChartInstance.destroy();\r\n      pieChartInstance = null;\r\n      LogHelper.log('Chart destroyed');\r\n    } catch (error) {\r\n      LogHelper.warn('Error destroying chart:', error);\r\n    }\r\n  }\r\n\r\n  // Destroy modal chart\r\n  if (modalPieChartInstance) {\r\n    try {\r\n      modalPieChartInstance.destroy();\r\n      modalPieChartInstance = null;\r\n      LogHelper.log('Modal chart destroyed');\r\n    } catch (error) {\r\n      LogHelper.warn('Error destroying modal chart:', error);\r\n    }\r\n  }\r\n\r\n  // Remove modal event listeners (RFC-0056: Cleanup delegated events)\r\n  try {\r\n    const $container = $root();\r\n    $container.off('click', '#btnExpandModal');\r\n    $J('body').off('click', '#btnCloseModal');\r\n    $J('body').off('click', '#modalExpanded');\r\n    $J(document).off('keydown.telemetryInfoModal');\r\n    LogHelper.log('Modal event listeners removed');\r\n  } catch (error) {\r\n    LogHelper.warn('Error removing modal listeners:', error);\r\n  }\r\n\r\n  // Remove modal from body if it was moved there\r\n  try {\r\n    const $modal = $J('#modalExpanded');\r\n    if ($modal.parent()[0] === document.body) {\r\n      LogHelper.log('Removing modal from body');\r\n      $modal.remove();\r\n    }\r\n  } catch (error) {\r\n    LogHelper.warn('Error removing modal from body:', error);\r\n  }\r\n\r\n  // Clear jQuery event handlers\r\n  try {\r\n    $root().off();\r\n  } catch {\r\n    // jQuery cleanup may fail if element no longer exists\r\n  }\r\n\r\n  LogHelper.log('Widget destroyed successfully');\r\n};\r\n",
      "settingsSchema": "{\r\n  \"schema\": {\r\n    \"type\": \"object\",\r\n    \"title\": \"TELEMETRY_INFO Settings\",\r\n    \"properties\": {\r\n      \"labelWidget\": {\r\n        \"title\": \"Widget Label\",\r\n        \"type\": \"string\",\r\n        \"default\": \"Informa√ß√µes de Energia\"\r\n      },\r\n      \"DOMAIN\": {\r\n        \"title\": \"Domain\",\r\n        \"type\": \"string\",\r\n        \"default\": \"energy\",\r\n        \"enum\": [\"energy\", \"water\", \"temperature\"],\r\n        \"description\": \"Data domain to filter orchestrator data\"\r\n      },\r\n      \"showDevicesList\": {\r\n        \"title\": \"Show Devices List\",\r\n        \"type\": \"boolean\",\r\n        \"default\": false,\r\n        \"description\": \"Display list of entrada devices in the card\"\r\n      },\r\n      \"chartColors\": {\r\n        \"title\": \"Chart Colors (RFC-0056: 6 categories)\",\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"climatizacao\": {\r\n            \"title\": \"Climatiza√ß√£o Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#00C896\",\r\n            \"description\": \"Teal (MyIO accent)\"\r\n          },\r\n          \"elevadores\": {\r\n            \"title\": \"Elevadores Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#5B2EBC\",\r\n            \"description\": \"Purple (MyIO primary)\"\r\n          },\r\n          \"escadasRolantes\": {\r\n            \"title\": \"Escadas Rolantes Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#FF6B6B\",\r\n            \"description\": \"Red\"\r\n          },\r\n          \"lojas\": {\r\n            \"title\": \"Lojas Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#FFC107\",\r\n            \"description\": \"Yellow\"\r\n          },\r\n          \"outros\": {\r\n            \"title\": \"Outros Equipamentos Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#9C27B0\",\r\n            \"description\": \"Deep Purple\"\r\n          },\r\n          \"areaComum\": {\r\n            \"title\": \"√Årea Comum Color (Residual)\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#4CAF50\",\r\n            \"description\": \"Green\"\r\n          }\r\n        }\r\n      },\r\n      \"waterIncludeBathrooms\": {\r\n        \"title\": \"Water: Include Bathrooms Card\",\r\n        \"type\": \"boolean\",\r\n        \"default\": false,\r\n        \"description\": \"When enabled for water domain, shows a separate card for Banheiros (bathrooms) consumption\"\r\n      },\r\n      \"waterChartColors\": {\r\n        \"title\": \"Water Chart Colors\",\r\n        \"type\": \"object\",\r\n        \"properties\": {\r\n          \"lojas\": {\r\n            \"title\": \"Lojas Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#FFC107\"\r\n          },\r\n          \"banheiros\": {\r\n            \"title\": \"Banheiros Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#2196F3\"\r\n          },\r\n          \"areaComum\": {\r\n            \"title\": \"√Årea Comum Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#4CAF50\"\r\n          },\r\n          \"pontosNaoMapeados\": {\r\n            \"title\": \"Pontos N√£o Mapeados Color\",\r\n            \"type\": \"string\",\r\n            \"default\": \"#9E9E9E\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"form\": [\r\n    \"labelWidget\",\r\n    \"DOMAIN\",\r\n    \"showDevicesList\",\r\n    \"chartColors.climatizacao\",\r\n    \"chartColors.elevadores\",\r\n    \"chartColors.escadasRolantes\",\r\n    \"chartColors.lojas\",\r\n    \"chartColors.outros\",\r\n    \"chartColors.areaComum\",\r\n    \"waterIncludeBathrooms\",\r\n    \"waterChartColors.lojas\",\r\n    \"waterChartColors.banheiros\",\r\n    \"waterChartColors.areaComum\",\r\n    \"waterChartColors.pontosNaoMapeados\"\r\n  ]\r\n}\r\n",
      "dataKeySettingsSchema": "{}\n",
      "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Attributes card\",\"decimals\":null}"
    },
    "externalId": null,
    "resources": null,
    "id": {
      "entityType": "WIDGET_TYPE",
      "id": "3df716f0-b049-11f0-9722-210aa9448abc"
    },
    "scada": false,
    "tags": null
  },
  "relations": [],
  "attributes": {
    "SERVER_SCOPE": []
  }
}