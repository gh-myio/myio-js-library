var DEBUG_ACTIVE = !0,
  LogHelper = {
    log: function () {
      DEBUG_ACTIVE &&
        console.log.apply(console, ['[AlarmProfilesPanel]'].concat(Array.prototype.slice.call(arguments)));
    },
    warn: function () {
      DEBUG_ACTIVE &&
        console.warn.apply(console, ['[AlarmProfilesPanel]'].concat(Array.prototype.slice.call(arguments)));
    },
    error: function () {
      console.error.apply(console, ['[AlarmProfilesPanel]'].concat(Array.prototype.slice.call(arguments)));
    },
    table: function (e, t) {
      DEBUG_ACTIVE && (console.log('[AlarmProfilesPanel]', t || 'Table:'), console.table(e));
    },
  };
function extractCustomersFromDatasources(e) {
  LogHelper.log('extractCustomersFromDatasources() called');
  var t = [],
    l = e.datasources || [];
  LogHelper.log('ctx.datasources length:', l.length),
    l.forEach(function (e, l) {
      LogHelper.log('Processing datasource', l, ':', e);
      var s = e.entity || {};
      LogHelper.log('  entity:', s),
        s.id &&
          'CUSTOMER' === s.id.entityType &&
          (LogHelper.log('  Found CUSTOMER:', s.id.id),
          t.push({ id: s.id.id, entityId: s.id, name: s.name || 'Unknown Customer', label: s.label || '' }));
    });
  var s = {},
    r = t.filter(function (e) {
      return !s[e.id] && ((s[e.id] = !0), !0);
    });
  return LogHelper.log('Customers after dedup:', r.length), r;
}
function fetchAllData(e, t) {
  LogHelper.log('fetchAllData() started');
  var l = e.customers.map(function (e) {
    return e.id;
  });
  LogHelper.log('Customer IDs from datasource:', l),
    (e.devices = []),
    (e.deviceProfiles = {}),
    (e.profiles = []),
    (e.alarms = []),
    LogHelper.log('Fetching ALL devices with pagination...'),
    fetchAllDevicesWithPagination(t, e.settings.api.devicesPageSize)
      .then(function (s) {
        LogHelper.log('Total devices fetched from API:', s.length);
        var r = {};
        s.forEach(function (e) {
          e.ownerId && (r[e.ownerId] = (r[e.ownerId] || 0) + 1);
        }),
          LogHelper.log('Unique owner IDs in devices:', Object.keys(r).length),
          LogHelper.log('Looking for customer/owner IDs:', l),
          l.forEach(function (e) {
            var t = r[e] || 0;
            LogHelper.log('Owner', e, '- devices found:', t);
          }),
          (e.devices = s.filter(function (e) {
            return e.ownerId && -1 !== l.indexOf(e.ownerId);
          })),
          LogHelper.log('Devices after filtering by owner IDs:', e.devices.length),
          LogHelper.table(e.devices.slice(0, 10), 'Filtered Devices (first 10)');
        var o = extractUniqueProfileIds(e.devices);
        LogHelper.log('Unique device profile IDs:', o.length, o),
          LogHelper.log('Fetching', o.length, 'device profile(s)...');
        var a = o.map(function (e) {
          return fetchDeviceProfile(t, e);
        });
        return Promise.all(a);
      })
      .then(function (l) {
        var s = 0;
        l.forEach(function (t) {
          t && t.id && t.id.id && ((e.deviceProfiles[t.id.id] = t), s++);
        }),
          LogHelper.log('Device profiles stored:', s),
          LogHelper.log(
            'Profile names:',
            Object.keys(e.deviceProfiles).map(function (t) {
              return e.deviceProfiles[t].name;
            })
          );
        var r = getActiveStatusList(e.filters);
        return (
          LogHelper.log('Fetching alarms with status:', r), fetchAlarms(t, e.settings.api.alarmsPageSize, r)
        );
      })
      .then(function (l) {
        (e.alarms = l),
          LogHelper.log('Alarms fetched:', e.alarms.length),
          LogHelper.table(e.alarms.slice(0, 10), 'Alarms (first 10)'),
          (e.profiles = getProfilesList()),
          LogHelper.log('vm.profiles built:', e.profiles.length),
          LogHelper.table(e.profiles, 'Profiles list'),
          (e.loading = !1),
          LogHelper.log('fetchAllData() completed successfully'),
          LogHelper.log('vm.loading:', e.loading),
          LogHelper.log('vm.devices.length:', e.devices.length),
          LogHelper.log('vm.profiles.length:', e.profiles.length),
          updateView(t, 'Data loaded successfully');
      })
      .catch(function (l) {
        LogHelper.error('API fetch error:', l),
          (e.error = 'Error fetching data: ' + (l.message || l.statusText || 'Unknown error')),
          (e.loading = !1),
          updateView(t, 'Error occurred');
      });
}
function updateView(e, t) {
  LogHelper.log('updateView() called - reason:', t),
    LogHelper.log('self.loading:', self.loading, 'self.profiles.length:', self.profiles.length);
  var l = e.$scope;
  l &&
    ((l.self = self),
    (l.loading = self.loading),
    (l.error = self.error),
    (l.profiles = self.profiles),
    (l.devices = self.devices),
    (l.alarms = self.alarms),
    (l.selectedProfileIds = self.selectedProfileIds),
    (l.viewMode = self.viewMode),
    (l.filters = self.filters),
    (l.settings = self.settings),
    LogHelper.log('$scope synced - loading:', l.loading, 'profiles:', l.profiles ? l.profiles.length : 0)),
    e.detectChanges && (e.detectChanges(), LogHelper.log('detectChanges executed')),
    setTimeout(function () {
      if ((LogHelper.log('setTimeout callback executing...'), l))
        try {
          l.$$phase || (l.$root && l.$root.$$phase)
            ? LogHelper.log('$scope.$apply() skipped - digest already in progress')
            : (l.$apply(), LogHelper.log('$scope.$apply() executed successfully'));
        } catch (e) {
          LogHelper.warn('$scope.$apply() failed:', e.message);
        }
      e.detectChanges && (e.detectChanges(), LogHelper.log('detectChanges executed (setTimeout fallback)'));
    }, 50),
    setTimeout(function () {
      l && ((l.self = self), (l.loading = self.loading), (l.profiles = self.profiles)),
        e.detectChanges &&
          (e.detectChanges(), LogHelper.log('detectChanges executed (second fallback 200ms)'));
    }, 200);
}
function fetchAllDevicesWithPagination(e, t) {
  var l = [],
    s = t || 300;
  return (function t(r) {
    var o =
      '/api/deviceInfos/all?pageSize=' +
      s +
      '&page=' +
      r +
      '&includeCustomers=true&sortProperty=name&sortOrder=ASC';
    return (
      LogHelper.log('API GET:', o),
      e.http
        .get(o)
        .toPromise()
        .then(function (e) {
          var s = e.data || [];
          LogHelper.log('Page', r, '- devices received:', s.length, '- hasNext:', e.hasNext);
          var o = s.map(function (e) {
            return {
              id: e.id ? e.id.id : null,
              entityId: e.id,
              name: e.name || 'Unknown Device',
              label: e.label || '',
              type: e.type || '',
              ownerName: e.ownerName || 'N/A',
              ownerId: e.ownerId ? e.ownerId.id : null,
              ownerType: e.ownerId ? e.ownerId.entityType : null,
              customerId: e.customerId ? e.customerId.id : null,
              deviceProfileId: e.deviceProfileId ? e.deviceProfileId.id : null,
              createdTime: e.createdTime,
              active: e.active || !1,
              groups: e.groups || [],
            };
          });
          return (
            (l = l.concat(o)),
            e.hasNext ? t(r + 1) : (LogHelper.log('Pagination complete. Total devices:', l.length), l)
          );
        })
        .catch(function (e) {
          return LogHelper.error('Error fetching devices page', r, ':', e), l;
        })
    );
  })(0);
}
function fetchDeviceProfile(e, t) {
  var l = '/api/deviceProfile/' + t + '?inlineImages=false';
  return (
    LogHelper.log('API GET:', l),
    e.http
      .get(l)
      .toPromise()
      .then(function (e) {
        LogHelper.log('Profile', t, '- received:', e.name);
        var l = e.profileData && e.profileData.alarms ? e.profileData.alarms.length : 0;
        return LogHelper.log('Profile', t, '- alarm rules:', l), e;
      })
      .catch(function (e) {
        return LogHelper.error('Error fetching device profile', t, ':', e), null;
      })
  );
}
function fetchAlarms(e, t, l) {
  var s =
    '/api/v2/alarms?pageSize=' +
    (t || 500) +
    '&page=0&sortProperty=createdTime&sortOrder=DESC&statusList=' +
    l;
  return (
    LogHelper.log('API GET:', s),
    e.http
      .get(s)
      .toPromise()
      .then(function (e) {
        var t = e.data || [];
        return (
          LogHelper.log('Alarms received:', t.length, '- Total available:', e.totalElements),
          t.map(function (e) {
            return {
              alarmId: e.id ? e.id.id : null,
              entityId: e.id,
              type: e.type || e.name || 'Unknown Alarm',
              name: e.name || e.type || 'Unknown Alarm',
              severity: e.severity || 'INDETERMINATE',
              status: mapAlarmStatus(e),
              acknowledged: e.acknowledged || !1,
              cleared: e.cleared || !1,
              originatorId: e.originator ? e.originator.id : null,
              originatorType: e.originator ? e.originator.entityType : null,
              originatorName: e.originatorName || '',
              originatorLabel: e.originatorLabel || '',
              customerId: e.customerId ? e.customerId.id : null,
              startTs: e.startTs,
              endTs: e.endTs,
              ackTs: e.ackTs,
              clearTs: e.clearTs,
              details: e.details || {},
            };
          })
        );
      })
      .catch(function (e) {
        return LogHelper.error('Error fetching alarms:', e), [];
      })
  );
}
function extractUniqueProfileIds(e) {
  var t = {};
  return (
    e.forEach(function (e) {
      e.deviceProfileId && (t[e.deviceProfileId] = !0);
    }),
    Object.keys(t)
  );
}
function getActiveStatusList(e) {
  var t = [];
  return (
    e.statuses.ACTIVE && t.push('ACTIVE'),
    e.statuses.CLEARED && t.push('CLEARED'),
    e.statuses.ACKNOWLEDGED && t.push('ACK'),
    0 === t.length && t.push('ACTIVE'),
    t.join(',')
  );
}
function mapAlarmStatus(e) {
  return e.cleared
    ? e.acknowledged
      ? 'CLEARED_ACK'
      : 'CLEARED'
    : e.acknowledged
    ? 'ACKNOWLEDGED'
    : 'ACTIVE';
}
function normalizeSettings(e) {
  var t = (e = e || {}).api || {},
    l = e.appearance || {},
    s = e.severityStyle || {},
    r = e.statusStyle || {};
  return {
    api: {
      devicesPageSize: t.devicesPageSize || 1e3,
      alarmsPageSize: t.alarmsPageSize || 500,
      defaultAlarmStatuses: t.defaultAlarmStatuses || 'ACTIVE',
    },
    appearance: {
      showHeader: !1 !== l.showHeader,
      headerTitle: l.headerTitle || 'Alarm Profiles Panel',
      compactMode: !!l.compactMode,
    },
    severityStyle: {
      criticalClass: s.criticalClass || 'ap-badge-critical',
      majorClass: s.majorClass || 'ap-badge-major',
      minorClass: s.minorClass || 'ap-badge-minor',
      warningClass: s.warningClass || 'ap-badge-warning',
      infoClass: s.infoClass || 'ap-badge-info',
      noneClass: s.noneClass || 'ap-badge-none',
    },
    statusStyle: {
      activeClass: r.activeClass || 'ap-status-active',
      clearedClass: r.clearedClass || 'ap-status-cleared',
      acknowledgedClass: r.acknowledgedClass || 'ap-status-ack',
      normalClass: r.normalClass || 'ap-status-normal',
    },
  };
}
function toggleProfileSelection(e) {
  var t = self,
    l = t.ctx,
    s = t.selectedProfileIds.indexOf(e);
  -1 === s
    ? (t.selectedProfileIds.push(e),
      LogHelper.log('Profile selected:', e, '- Total selected:', t.selectedProfileIds.length))
    : (t.selectedProfileIds.splice(s, 1),
      LogHelper.log('Profile deselected:', e, '- Total selected:', t.selectedProfileIds.length)),
    l && l.detectChanges && l.detectChanges();
}
function isProfileSelected(e) {
  return -1 !== self.selectedProfileIds.indexOf(e);
}
function setViewMode(e) {
  var t = self,
    l = t.ctx;
  ('devices' !== e && 'alarms' !== e) ||
    ((t.viewMode = e), LogHelper.log('View mode changed to:', e), l && l.detectChanges && l.detectChanges());
}
function getProfilesList() {
  var e = self,
    t = [];
  return (
    Object.keys(e.deviceProfiles).forEach(function (l) {
      var s = e.deviceProfiles[l];
      s &&
        t.push({
          id: l,
          name: s.name || 'Unknown Profile',
          description: s.description || '',
          ruleChainId: s.defaultRuleChainId ? s.defaultRuleChainId.id : null,
          alarmRules: s.profileData && s.profileData.alarms ? s.profileData.alarms : [],
          deviceCount: countDevicesForProfile(e.devices, l),
        });
    }),
    t
  );
}
function countDevicesForProfile(e, t) {
  return e.filter(function (e) {
    return e.deviceProfileId === t;
  }).length;
}
function getDevicesForSelectedProfiles() {
  var e = self;
  return e.selectedProfileIds && 0 !== e.selectedProfileIds.length
    ? e.devices.filter(function (t) {
        return -1 !== e.selectedProfileIds.indexOf(t.deviceProfileId);
      })
    : e.devices;
}
function getFilteredAlarms() {
  var e = self,
    t = e.selectedProfileIds || [],
    l = e.filters || {},
    s = {};
  t.length > 0 &&
    e.devices.forEach(function (e) {
      -1 !== t.indexOf(e.deviceProfileId) && (s[e.id] = !0);
    });
  var r = null,
    o = null;
  if (l.dateFromStr) {
    var a = l.dateFromStr + 'T00:00:00',
      i = Date.parse(a);
    isNaN(i) || (r = i);
  }
  if (l.dateToStr) {
    var n = l.dateToStr + 'T23:59:59',
      c = Date.parse(n);
    isNaN(c) || (o = c);
  }
  var f = e.alarms.filter(function (e) {
    if (t.length > 0 && !s[e.originatorId]) return !1;
    var a = (e.status || '').toUpperCase(),
      i = !1;
    return (
      !l.statuses.ACTIVE || ('ACTIVE' !== a && 'ACTIVE_UNACK' !== a) || (i = !0),
      !l.statuses.CLEARED || ('CLEARED' !== a && 'CLEARED_ACK' !== a && 'CLEARED_UNACK' !== a) || (i = !0),
      !l.statuses.ACKNOWLEDGED ||
        ('ACKNOWLEDGED' !== a && 'ACTIVE_ACK' !== a && 'CLEARED_ACK' !== a) ||
        (i = !0),
      !(!i && (l.statuses.ACTIVE || l.statuses.CLEARED || l.statuses.ACKNOWLEDGED)) &&
        !(null !== r && e.startTs && e.startTs < r) &&
        !(null !== o && e.startTs && e.startTs > o)
    );
  });
  return (
    f.sort(function (e, t) {
      var l = e.startTs || 0;
      return (t.startTs || 0) - l;
    }),
    f
  );
}
function openProfileDetails(e) {
  var t = self,
    l = t.ctx;
  (t.activeProfileDetails = e), (t.showProfileDetailsModal = !0), l && l.detectChanges && l.detectChanges();
}
function closeProfileDetails() {
  var e = self,
    t = e.ctx;
  (e.showProfileDetailsModal = !1),
    (e.activeProfileDetails = null),
    t && t.detectChanges && t.detectChanges();
}
function toggleStatusFilter(e) {
  var t = self,
    l = t.ctx;
  t.filters.statuses || (t.filters.statuses = {});
  var s = !!t.filters.statuses[e];
  (t.filters.statuses[e] = !s), l && l.detectChanges && l.detectChanges();
}
function onDateFilterChange() {
  var e = self.ctx;
  e && e.detectChanges && e.detectChanges();
}
function getProfileDisplayName(e) {
  return (e && e.name) || '';
}
function getProfileRuleChainLabel(e) {
  return e && e.ruleChainId ? 'Rule Chain: ' + e.ruleChainId : '';
}
function getSeverityBadgeClass(e) {
  var t = self;
  if (!t.settings || !t.settings.severityStyle) return 'ap-badge-none';
  if (!e) return t.settings.severityStyle.noneClass;
  var l = ('' + e).toUpperCase();
  return 'CRITICAL' === l
    ? t.settings.severityStyle.criticalClass
    : 'MAJOR' === l
    ? t.settings.severityStyle.majorClass
    : 'MINOR' === l
    ? t.settings.severityStyle.minorClass
    : 'WARNING' === l
    ? t.settings.severityStyle.warningClass
    : 'INDETERMINATE' === l || 'INFO' === l
    ? t.settings.severityStyle.infoClass
    : t.settings.severityStyle.noneClass;
}
function getStatusBadgeClass(e) {
  var t = self;
  if (!t.settings || !t.settings.statusStyle) return 'ap-status-normal';
  if (!e) return t.settings.statusStyle.normalClass;
  var l = ('' + e).toUpperCase();
  return 'ACTIVE' === l || 'ACTIVE_UNACK' === l
    ? t.settings.statusStyle.activeClass
    : 'CLEARED' === l || 'CLEARED_ACK' === l || 'CLEARED_UNACK' === l
    ? t.settings.statusStyle.clearedClass
    : 'ACKNOWLEDGED' === l || 'ACTIVE_ACK' === l
    ? t.settings.statusStyle.acknowledgedClass
    : t.settings.statusStyle.normalClass;
}
function refresh() {
  LogHelper.log('refresh() called - Manual refresh triggered');
  var e = self,
    t = e.ctx;
  t
    ? ((e.loading = !0), (e.error = null), updateView(t, 'Refresh started'), fetchAllData(e, t))
    : LogHelper.warn('refresh: ctx is undefined, aborting');
}
'undefined' != typeof window &&
  ((window.AlarmProfilesPanel = window.AlarmProfilesPanel || {}),
  (window.AlarmProfilesPanel.setDebug = function (e) {
    (DEBUG_ACTIVE = !!e), console.log('[AlarmProfilesPanel] Debug mode:', DEBUG_ACTIVE ? 'ON' : 'OFF');
  }),
  (window.AlarmProfilesPanel.getDebug = function () {
    return DEBUG_ACTIVE;
  })),
  (self.settings = null),
  (self.customers = []),
  (self.devices = []),
  (self.deviceProfiles = {}),
  (self.profiles = []),
  (self.alarms = []),
  (self.selectedProfileIds = []),
  (self.viewMode = 'devices'),
  (self.loading = !0),
  (self.error = null),
  (self.showProfileDetailsModal = !1),
  (self.activeProfileDetails = null),
  (self.filters = {
    dateFromStr: null,
    dateToStr: null,
    statuses: { ACTIVE: !0, CLEARED: !1, ACKNOWLEDGED: !1 },
  }),
  (self.toggleProfileSelection = function () {}),
  (self.isProfileSelected = function () {
    return !1;
  }),
  (self.setViewMode = function () {}),
  (self.getDevicesForSelectedProfiles = function () {
    return [];
  }),
  (self.getFilteredAlarms = function () {
    return [];
  }),
  (self.openProfileDetails = function () {}),
  (self.closeProfileDetails = function () {}),
  (self.toggleStatusFilter = function () {}),
  (self.onDateFilterChange = function () {}),
  (self.getProfileDisplayName = function () {
    return '';
  }),
  (self.getProfileRuleChainLabel = function () {
    return '';
  }),
  (self.getSeverityBadgeClass = function () {
    return 'ap-badge-none';
  }),
  (self.getStatusBadgeClass = function () {
    return 'ap-status-normal';
  }),
  (self.refresh = function () {}),
  (self.getProfilesList = function () {
    return [];
  }),
  (self.onInit = function () {
    LogHelper.log('onInit() called');
    var e = self.ctx;
    if (e) {
      var t = e.$scope;
      if (t) {
        var l = self;
        if (
          ((t.self = self),
          (t.loading = !0),
          (t.error = null),
          (t.profiles = []),
          (t.devices = []),
          (t.alarms = []),
          (t.selectedProfileIds = []),
          (t.viewMode = 'devices'),
          (t.filters = l.filters),
          (t.settings = null),
          (l.ctx = e),
          (l.settings = normalizeSettings(e.settings || {})),
          (t.settings = l.settings),
          LogHelper.log('Settings normalized:', l.settings),
          (l.customers = []),
          (l.devices = []),
          (l.deviceProfiles = {}),
          (l.profiles = []),
          (l.alarms = []),
          (l.loading = !0),
          (l.error = null),
          (l.selectedProfileIds = []),
          (l.viewMode = 'devices'),
          (l.filters = {
            dateFromStr: null,
            dateToStr: null,
            statuses: { ACTIVE: !0, CLEARED: !1, ACKNOWLEDGED: !1 },
          }),
          (l.showProfileDetailsModal = !1),
          (l.activeProfileDetails = null),
          (l.toggleProfileSelection = toggleProfileSelection),
          (l.isProfileSelected = isProfileSelected),
          (l.setViewMode = setViewMode),
          (l.getDevicesForSelectedProfiles = getDevicesForSelectedProfiles),
          (l.getFilteredAlarms = getFilteredAlarms),
          (l.openProfileDetails = openProfileDetails),
          (l.closeProfileDetails = closeProfileDetails),
          (l.toggleStatusFilter = toggleStatusFilter),
          (l.onDateFilterChange = onDateFilterChange),
          (l.getProfileDisplayName = getProfileDisplayName),
          (l.getProfileRuleChainLabel = getProfileRuleChainLabel),
          (l.getSeverityBadgeClass = getSeverityBadgeClass),
          (l.getStatusBadgeClass = getStatusBadgeClass),
          (l.refresh = refresh),
          (l.getProfilesList = getProfilesList),
          LogHelper.log('Extracting customers from ctx.datasources...'),
          LogHelper.log('ctx.datasources:', e.datasources),
          (l.customers = extractCustomersFromDatasources(e)),
          LogHelper.log('Customers extracted:', l.customers.length, 'customer(s)'),
          LogHelper.table(l.customers, 'Customers'),
          0 === l.customers.length)
        )
          return (
            (l.loading = !1),
            (l.error = 'No customers found in datasource. Please configure a Customer entity datasource.'),
            LogHelper.warn('No customers found in datasource'),
            void (e.detectChanges && e.detectChanges())
          );
        LogHelper.log('Starting API fetch chain from onInit...'),
          fetchAllData(l, e),
          self.ctx.detectChanges();
      } else LogHelper.warn('onInit: $scope is undefined, aborting');
    } else LogHelper.warn('onInit: ctx is undefined, aborting');
  }),
  (self.onDataUpdated = function () {
    self.ctx.detectChanges(), LogHelper.log('onDataUpdated() called - ignored (using onInit approach)');
  }),
  (self.onDestroy = function () {}),
  (self.onResize = function () {});
